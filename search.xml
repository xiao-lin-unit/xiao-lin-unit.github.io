<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>K8sç³»åˆ—---ç•ªå¤–ç¯‡</title>
      <link href="/2025/09/06/k8s/K8s%E7%B3%BB%E5%88%97%E4%B9%8B%E7%95%AA%E5%A4%96%E7%AF%87/"/>
      <url>/2025/09/06/k8s/K8s%E7%B3%BB%E5%88%97%E4%B9%8B%E7%95%AA%E5%A4%96%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰é¢æˆ‘ä»¬åœ¨å®‰è£…<code>flannel-cni-plugin</code>æ’ä»¶æ—¶å‘ç”Ÿäº†ä¸€ä¸ªé—®é¢˜, è¯¥æ’ä»¶ä¸‹è½½ä¸ä¸‹æ¥. å¯èƒ½æ˜¯ç”±äºä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„åŸå› , å›½å†…çš„é•œåƒæºæ‰¾ä¸åˆ°è¯¥ç‰ˆæœ¬, å†åŠ ä¸Šå¾ˆå¤šé•œåƒæºå¤±æ•ˆäº†, è¿™ä¸ªé—®é¢˜æŠ˜ç£¨äº†æˆ‘ä¸¤å¤©ğŸ˜­. ç»ˆäºåœ¨æˆ‘è‰°è‹¦å¥‹æ–—, é”²è€Œä¸èˆ, æ°¸ä¸è¨€å¼ƒçš„ä¼˜ç§€å“è´¨ä¸‹, æ‰¾åˆ°äº†ä¸€ç§è§£å†³åŠæ³•.</p><p>å…ˆæå‰è¯´ä¸€ä¸‹, è¿™ç§æ–¹æ³•æ¯”è¾ƒç¹ç, ä¹Ÿæœ‰é™åˆ¶, ä¹Ÿæ˜¯æŸæ‰‹æ— ç­–çš„åŠæ³•ä¸‹çš„æ–¹æ³•(å°±è®¤ä¸ºæ˜¯ç«‹ä½“å‡ ä½•çš„å»ºåæ ‡ç³»)</p><p>å¦‚æœä½ ä¼šç½‘ç»œé­”æ³•, è¯·ç›´æ¥å¿½ç•¥, å¦‚æœä½ ä¸ä¼š, å¯ä»¥çœ‹ä¸€ä¸‹</p><h3 id="ç½‘ç»œåŠ é€Ÿ"><a class="markdownIt-Anchor" href="#ç½‘ç»œåŠ é€Ÿ"></a> ç½‘ç»œåŠ é€Ÿ</h3><p>å¦‚æœä½ æƒ³ä½¿ç”¨<code>docker hub</code>çš„å®˜æ–¹ä»“åº“, å¯ä»¥ä¸‹è½½ä¸€ä¸ª<code>Watt Tookit</code>(<code>Steam++</code>)ç½‘ç»œåŠ é€Ÿ. æ­¤è½¯ä»¶å¯ä»¥å¯¹<code>github</code>å’Œ<code>docker hub</code>è¿›è¡Œç½‘ç»œåŠ é€Ÿ</p><p>å¦‚æœä½ æƒ³ä½¿ç”¨<code>k8s</code>çš„ä»“åº“<code>registry.k8s.io</code>, åˆ™éœ€è¦åœ¨<code>docker hub</code>ä¸Šæœ‰è¯¥é•œåƒ</p><p>æè¿°åˆ°è¿™é‡Œ, æƒ³å¿…å¤§å®¶ä¹Ÿæ˜ç™½äº†, å…¶å®å°±æ˜¯ä»<code>docker hub</code>ä¸Šä¸‹è½½é•œåƒ</p><h3 id="æ–¹å¼"><a class="markdownIt-Anchor" href="#æ–¹å¼"></a> æ–¹å¼</h3><h4 id="ç§äººä»“åº“"><a class="markdownIt-Anchor" href="#ç§äººä»“åº“"></a> ç§äººä»“åº“</h4><p>å¦‚æœæ˜¯ä½¿ç”¨æœ¬åœ°ä¸»æœºç›´æ¥æ‹‰å–, åˆ™ä¸éœ€è¦æœ‰ç§äººä»“åº“</p><p>éœ€è¦æœ‰ä¸€ä¸ªç§äººçš„é•œåƒä»“åº“, æˆ‘ä¸ªäººä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘çš„ä¸ªäººé•œåƒä»“åº“. æ¨èä½¿ç”¨å¯å¤–éƒ¨è®¿é—®çš„é•œåƒä»“åº“</p><p>ä»¥é˜¿é‡Œäº‘ä¸ºä¾‹, åœ¨å®¹å™¨é•œåƒæœåŠ¡ä¸­å¼€é€šä¸ªäººçš„é•œåƒæœåŠ¡, ç„¶ååˆ›å»ºå‘½åç©ºé—´å°±å¯ä»¥ä½¿ç”¨äº†</p><p>åœ¨å®ä¾‹ä¸­åˆ›å»ºé•œåƒä»“åº“, å»ºè®®åç§°ä¸ä½ è¦è·å–çš„é•œåƒåä¸€è‡´, æ¯”è¾ƒæ–¹ä¾¿</p><p><img src="%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%AA%E4%BA%BA%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93.png" alt="é˜¿é‡Œäº‘ä¸ªäººé•œåƒä»“åº“" /></p><h4 id="æ‹‰å–"><a class="markdownIt-Anchor" href="#æ‹‰å–"></a> æ‹‰å–</h4><p>éœ€è¦ä½ æœ‰ä¸€ä¸ª<code>docker hub</code>çš„è´¦æˆ·, å¦‚æœæ²¡æœ‰å¯ä»¥ä½¿ç”¨<code>github</code>è´¦æˆ·ç™»å½•<code>docker hub</code></p><p>ä½¿ç”¨<code>Watt Tookit</code>åŠ é€Ÿçš„æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥ä»<code>docker hub</code>ä¸Šæ‹‰å–é•œåƒ</p><ol><li><p>æœ¬åœ°æ‹‰å–</p><p>åœ¨ä½ æœ¬åœ°ä¸»æœºä¸Šç›´æ¥æ‹‰å–å³å¯</p></li><li><p>ç½‘ç»œè®¿é—®æ‹‰å–</p><p>ç½‘ç»œè®¿é—®æ‹‰å–æ˜¯åœ¨åœ¨çº¿ç½‘ç«™<a href="https://labs.play-with-docker.com/">Play with Docker</a>ä¸Šç™»å½•ä¸ªäººçš„<code>docker hub</code>è´¦æˆ·æ‹‰å–, ç„¶åä½¿ç”¨å‘½ä»¤è¡Œç™»å½•ä½ çš„ä¸ªäººä»“åº“å¹¶å°†é•œåƒä¸Šä¼ ä½¿ç”¨, æ˜¯åœ¨ä½ æ— æ³•è®¿é—®å¤–éƒ¨ç½‘ç»œæ—¶ä½¿ç”¨</p></li></ol><h4 id="æ¡ˆä¾‹"><a class="markdownIt-Anchor" href="#æ¡ˆä¾‹"></a> æ¡ˆä¾‹</h4><p>ä»¥<code>flannel-cni-plugin</code>ä¸ºä¾‹, æˆ‘é€šè¿‡ç½‘ç»œè®¿é—®æ‹‰å–, å°†å…¶æ¨é€åˆ°äº†æˆ‘çš„é˜¿é‡Œäº‘ä¸ªäººä»“åº“, ç„¶ååœ¨é›†ç¾¤è™šæ‹Ÿæœºä¸Šä½¿ç”¨<code>containerd</code>æ‹‰å–å¹¶åš<code>tag</code>å¤„ç†, è¿™æ ·åœ¨<code>kubeadm init</code>æ—¶å°±ä¸ä¼šå†ç¼ºå°‘ç½‘ç»œæ’ä»¶äº†</p><p><code>containerd</code>æ‹‰å–é•œåƒæ—¶å‡ºç°äº†ä¸€ä¸ªé—®é¢˜, æ˜¯è™šæ‹Ÿæœºçš„<code>DNS</code>è§£æçš„é—®é¢˜, ä¹Ÿè®°å½•ä¸€ä¸‹, ä¸‹æ¬¡ä½¿ç”¨è™šæ‹Ÿæœºæ—¶å†å‡ºç°æœ‰è§£å†³çš„åŠæ³•è®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 233.5.5.5</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> containerd </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sç³»åˆ—(ä¸‰)---æ­å»º</title>
      <link href="/2025/08/14/k8s/K8s%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E6%90%AD%E5%BB%BA/"/>
      <url>/2025/08/14/k8s/K8s%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>åŸºäºå‰ç¯‡, æˆ‘ä»¬å·²ç»å®‰è£…å¹¶é…ç½®å¥½äº†<code>containerd</code>ç¯å¢ƒ, æœ¬ç¯‡å°†åœ¨æ­¤åŸºç¡€ä¸Šå¼€å§‹æ­å»º<code>K8s</code></p><h3 id="å®‰è£…k8såŠŸèƒ½åŒ…"><a class="markdownIt-Anchor" href="#å®‰è£…k8såŠŸèƒ½åŒ…"></a> å®‰è£…<code>K8s</code>åŠŸèƒ½åŒ…</h3><p>å®‰è£…<code>kubeadm</code>ã€<code>kubelet</code> å’Œ <code>kubectl</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° apt åŒ…ç´¢å¼•å¹¶å®‰è£…ä½¿ç”¨ Kubernetes apt ä»“åº“æ‰€éœ€è¦çš„åŒ…</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="comment"># apt-transport-https å¯èƒ½æ˜¯ä¸€ä¸ªè™šæ‹ŸåŒ…ï¼ˆdummy packageï¼‰ï¼›å¦‚æœæ˜¯çš„è¯ï¼Œä½ å¯ä»¥è·³è¿‡å®‰è£…è¿™ä¸ªåŒ…</span></span><br><span class="line"><span class="built_in">sudo</span> apt install -y apt-transport-https ca-certificates curl gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç”¨äº Kubernetes è½¯ä»¶åŒ…ä»“åº“çš„å…¬å…±ç­¾åå¯†é’¥</span></span><br><span class="line"><span class="comment"># å¦‚æœ `/etc/apt/keyrings` ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åº”åœ¨ curl å‘½ä»¤ä¹‹å‰åˆ›å»ºå®ƒï¼Œè¯·é˜…è¯»ä¸‹é¢çš„æ³¨é‡Šã€‚</span></span><br><span class="line"><span class="comment"># sudo mkdir -p -m 755 /etc/apt/keyrings</span></span><br><span class="line">curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  Kubernetes ä»“åº“, ä»…åŒ…å« 1.32çš„è½¯ä»¶åŒ…</span></span><br><span class="line"><span class="comment"># æ­¤æ“ä½œä¼šè¦†ç›– /etc/apt/sources.list.d/kubernetes.list ä¸­ç°å­˜çš„æ‰€æœ‰é…ç½®ã€‚</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·Ÿæ–°åŒ…ç´¢å¼•</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="comment"># å®‰è£…kubelet kubeadm kubectl</span></span><br><span class="line"><span class="built_in">sudo</span> apt install -y kubelet kubeadm kubectl</span><br><span class="line"><span class="comment"># é”å®škubelet kubeadm kubectlç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">sudo</span> apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure><h3 id="å‰æœŸé…ç½®"><a class="markdownIt-Anchor" href="#å‰æœŸé…ç½®"></a> å‰æœŸé…ç½®</h3><p>ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½éœ€è¦ä¿®æ”¹ä¸»æœºçš„ç½‘ç»œé…ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">sudo</span> sysctl -p</span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 644 /etc/sysctl.conf</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²kubernetes-master"><a class="markdownIt-Anchor" href="#éƒ¨ç½²kubernetes-master"></a> éƒ¨ç½²<code>Kubernetes Master</code></h3><p>åœ¨ä¸»èŠ‚ç‚¹ä¸Šåšåˆå§‹åŒ–æ“ä½œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm init --image-repository registry.aliyuncs.com/google_containers --apiserver-advertise-address=<span class="variable">$&#123;k8s_master_ip&#125;</span> --kubernetes-version v1.32.7 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="comment"># sudo kubeadm init --image-repository registry.aliyuncs.com/google_containers --apiserver-advertise-address=172.27.225.160  --kubernetes-version v1.32.7 --service-cidr=10.96.0.0/12 --pod-network-cidr=10.244.0.0/16</span></span><br></pre></td></tr></table></figure><blockquote><p>å›½å†…åœ¨åˆå§‹åŒ–æ—¶æŒ‡å®šä¸€ä¸‹é•œåƒæº, å¦åˆ™ä¼šæ— æ³•æ‹‰å–é•œåƒè€Œå¯¼è‡´å¤±è´¥</p></blockquote><p><img src="kubernetes%E4%BD%BF%E7%94%A8kubeadm%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F.png" alt="kubernetesä½¿ç”¨kubeadmåˆå§‹åŒ–æˆåŠŸ" /></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ™®é€šç”¨æˆ·</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ROOT ç”¨æˆ·</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure><p>æ¨èä½¿ç”¨æ™®é€šç”¨æˆ·</p><h3 id="åŠ å…¥é›†ç¾¤kubernets-node"><a class="markdownIt-Anchor" href="#åŠ å…¥é›†ç¾¤kubernets-node"></a> åŠ å…¥é›†ç¾¤<code>Kubernets Node</code></h3><ol><li><p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åŠ å…¥é›†ç¾¤</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm <span class="built_in">join</span> &#123;k8s_master_ip&#125;:6443 --token &#123;k8s_master_token&#125; --discovery-token-ca-cert-hash sha256:&#123;k8s_maste_hash&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¾‹å¦‚ sudo kubeadm join 172.27.225.160:6443 --token be3ggz.ecbzk587k6j295pj \</span></span><br><span class="line">        --discovery-token-ca-cert-hash sha256:69b9c214920723f8050fb64a24a84ad3dbbcd5d8a419f89e76323c2812c8833c</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆå§‹åŒ–æ—¶çš„<code>token</code>æ¸…ç©ºäº†, å¯ä»¥åœ¨<code>master</code>æœåŠ¡å™¨é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>token</code>å·²ç»è¿‡æœŸ, å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤é‡æ–°ç”³è¯·</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆå§‹åŒ–æ—¶çš„master_hashæ¸…ç©ºäº†, å¯ä»¥åœ¨masteræœåŠ¡å™¨é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œå‘½ä»¤æˆåŠŸåå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å·²ç»åŠ å…¥é›†ç¾¤</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubelet get nodes</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„:</p><ol><li>æŸ¥çœ‹èŠ‚ç‚¹çš„æ“ä½œè¦åœ¨<code>master</code>èŠ‚ç‚¹ä¸Šæ“ä½œ</li><li>å¦‚æœèŠ‚ç‚¹æ˜¯<code>NotReady</code>çŠ¶æ€, å¯èƒ½æ˜¯æ²¡æœ‰å®‰è£…è·¨æœåŠ¡å™¨çš„ç½‘ç»œæ’ä»¶</li></ol></blockquote></li><li><p>å°†<code>master</code>èŠ‚ç‚¹é…ç½®å¤åˆ¶åˆ°<code>node</code>èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æˆ–è€…æƒ³å…¶ä»–æ–¹å¼å°†æ–‡ä»¶å¤åˆ¶è¿‡å»</span></span><br><span class="line">scp root@&lt;master-ip&gt;:/etc/kubernetes/admin.conf ~/.kube/config</span><br><span class="line"><span class="comment"># scp root@k8s-master:/etc/kubernetes/admin.conf ~/.kube/config</span></span><br><span class="line"><span class="comment"># k8s-master æ˜¯ä¸»æœºå, éœ€è¦é…ç½®hosts, å¦‚æœæ²¡æœ‰é…ç½®åˆ™éœ€è¦æ”¹ä¸ºIP</span></span><br><span class="line"><span class="comment"># ~/.kube/configæ˜¯åŸºäºæ™®é€šç”¨æˆ·çš„, rootç”¨æˆ·æ–¹å¼ä¸masterèŠ‚ç‚¹ä¸€è‡´</span></span><br><span class="line"><span class="built_in">chmod</span> 600 ~/.kube/config</span><br></pre></td></tr></table></figure></li></ol><h3 id="éƒ¨ç½²è·¨æœåŠ¡å™¨çš„cniç½‘ç»œæ’ä»¶"><a class="markdownIt-Anchor" href="#éƒ¨ç½²è·¨æœåŠ¡å™¨çš„cniç½‘ç»œæ’ä»¶"></a> éƒ¨ç½²è·¨æœåŠ¡å™¨çš„<code>CNI</code>ç½‘ç»œæ’ä»¶</h3><p>æœ¬ç³»åˆ—çš„è·¨æœåŠ¡å™¨çš„<code>CNI</code>ç½‘ç»œæ’ä»¶ä½¿ç”¨<code>flannel</code></p><p>é¦–å…ˆéœ€è¦å®‰è£…<code>flannel</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨Flannel</span></span><br><span class="line"><span class="comment"># å®‰è£…Flannel</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> wget https://raw.githubusercontent.com/flannel-io/flannel/v0.27.1/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å®ŒFlannelåæ‰§è¡Œæ“ä½œ</span></span><br><span class="line"><span class="comment"># åˆ é™¤å†å²åº”ç”¨æ•°æ®(å¦‚æœæœ‰)</span></span><br><span class="line">kubectl delete -f /usr/local/src/kube-flannel.yml --ignore-not-found</span><br><span class="line">kubectl apply -f /usr/local/src/kube-flannel.yml</span><br><span class="line"><span class="comment"># å¦‚æœä»èŠ‚ç‚¹å‡ºç°äº†é”™è¯¯, è¿æ¥åˆ°æœ¬åœ°8080, åˆ™å¯èƒ½æ˜¯æ²¡æœ‰å°†masterèŠ‚ç‚¹é…ç½®å¤åˆ¶åˆ°nodeèŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><p><span style="color: red">éå¸¸æŠ±æ­‰, æˆ‘åˆ°è¿™é‡Œå¡ä½äº†. å› ä¸ºflannel-cni-plugin:v1.7.1-flannel1è¿™ä¸ªç ´ç©æ„å„¿æ— æ³•å®‰è£…, åŸå› æ˜¯é­”æ³•, å›½å†…çš„é­”æ³•åœ°å€è¦ä¹ˆä¸èƒ½ç”¨äº†, è¦ä¹ˆæ²¡æœ‰è¿™ä¸ªç ´ç©æ„å„¿. ä¸è¦æ…Œ, æˆ‘æ­£åœ¨ç§¯æå¯»æ‰¾</span>ğŸ˜</p><p><mark>æˆ‘èƒ¡æ±‰ä¸‰åˆå›æ¥äº†. æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ¡ˆ, å¾ˆè ¢, è¿™é‡Œä¸å¤šè¯´äº†, å†™ä¸€ä¸ª<a href="/2025/09/06/k8s/K8s%E7%B3%BB%E5%88%97%E4%B9%8B%E7%95%AA%E5%A4%96%E7%AF%87/">ç•ªå¤–ç¯‡</a>å§</mark></p><p>æ’ä»¶å®‰è£…æˆåŠŸå, å°±ä¼šå‘ç°å„ä¸ªèŠ‚ç‚¹éƒ½å·²ç»å‡†å¤‡å¥½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure><p><img src="k8s%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E5%87%86%E5%A4%87%E5%AE%8C%E6%88%90.png" alt="kubernetesé›†ç¾¤èŠ‚ç‚¹å‡†å¤‡å®Œæˆ" /></p><p>æŸ¥çœ‹<code>kube-system</code>å‘½åç©ºé—´ä¸‹å¯åŠ¨çš„å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><p><img src="kube-system%E4%B8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%AE%B9%E5%99%A8.png" alt="kube-systemä¸‹å¯åŠ¨çš„å®¹å™¨" /></p><p>æŸ¥çœ‹<code>kube-flannel</code>å‘½åç©ºé—´ä¸‹å¯åŠ¨çš„å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-flannel</span><br></pre></td></tr></table></figure><p><img src="kube-flannel%E4%B8%8B%E5%90%AF%E5%8A%A8%E7%9A%84%E5%AE%B9%E5%99%A8.png" alt="kube-flannelä¸‹å¯åŠ¨çš„å®¹å™¨" /></p><p>æˆåŠŸçš„æ ‡å¿—, ä¸ªäººçš„åˆ¤æ–­æ–¹å¼, ä¸ä»£è¡¨å®˜æ–¹</p><ul><li><code>kube-system</code>ä¸­å®¹å™¨æ­£å¸¸è¿è¡Œ, å¹¶ä¸”<code>proxy</code>å®¹å™¨æ•°é‡ä¸èŠ‚ç‚¹æ•°é‡ä¸€è‡´</li><li><code>kube-flannel</code>ä¸­å®¹å™¨æ­£å¸¸è¿è¡Œ, å¹¶ä¸”<code>ds</code>å®¹å™¨æ•°é‡ä¸èŠ‚ç‚¹æ•°é‡ä¸€è‡´</li></ul><p><a href="#%E9%97%AE%E9%A2%98%E4%B8%80">corednsä¸€ç›´å¤„äºContainerCreatingçŠ¶æ€</a></p><p>åˆ°æ­¤, <code>k8s</code>é›†ç¾¤çš„æ­å»ºå·²ç»å®Œæˆ, ä¹‹åå°±å¯ä»¥æ„‰å¿«(ä½†æ„¿å§)çš„ä½¿ç”¨äº†ğŸ˜†</p><h3 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p><code>coredns</code>å¤„äº<code>ContainerCreating</code>çŠ¶æ€</p><p>é—®é¢˜çš„åŸå› å¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs &#123;pod_name&#125; -n kube-flannel -c kube-flannel</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜å‡ºç°çš„åŸå› ä¸€èˆ¬æœ‰ä¸‰ç§:</p><ol><li><p><code>CNI</code>æ’ä»¶æœªåˆå§‹åŒ–, <code>Flannel</code>æœªæ­£å¸¸éƒ¨ç½². æœ¬äººå‰æ–‡ä¸­å·²ç»æ­£å¸¸éƒ¨ç½², æ‰€ä»¥æ­¤å¤„çš„è§£å†³æ–¹æ¡ˆå‚è€ƒ<code>Flannel</code>æ’ä»¶éƒ¨ç½²</p></li><li><p><code>CoreDNS</code>é•œåƒæ‹‰å–å¤±è´¥. è¿™ä¸ªè¯·è‡ªå·±çš„æ–¹å¼æ‹‰å–åˆé€‚çš„é•œåƒ</p></li><li><p>æ‰¾ä¸åˆ°<code>subnet.env</code>æ–‡ä»¶. è¿™ä¸ªå†·è—å®¤<code>Flannel</code>æœªç”Ÿæˆå­ç½‘é…ç½®æ–‡ä»¶, ç½‘ç»œæ’ä»¶æœªå°±ç»ªå¯¼è‡´çš„,å‚è€ƒ<a href="#%E9%97%AE%E9%A2%98%E4%BA%8C"><code>Flannel</code>éƒ¨ç½²èµ„æºå¤±è´¥</a></p><p>é€šè¿‡å‘½ä»¤æŸ¥çœ‹<code>flannel</code>éƒ¨ç½²èµ„æºæ˜¯å¦æ­£å¸¸è¿è¡Œ</p></li></ol><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><p><code>Flannel</code>éƒ¨ç½²èµ„æºå¤±è´¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥kube-flannelå‘½åç©ºé—´æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">kubectl get namespace kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ Flannel çš„ DaemonSet èµ„æºï¼ˆæ ¸å¿ƒéƒ¨ç½²èµ„æºï¼‰</span></span><br><span class="line">kubectl get daemonset -n kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ Flannel çš„æ‰€æœ‰ç›¸å…³èµ„æºï¼ˆåŒ…æ‹¬ ConfigMapã€ServiceAccount ç­‰ï¼‰</span></span><br><span class="line">kubectl get all -n kube-flannel</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜çš„åŸå› ä¸€èˆ¬æœ‰å››ç§:</p><ol><li><p>å‘½åç©ºé—´ä¸å­˜åœ¨, è¯´æ˜éƒ¨ç½²æ–‡ä»¶æœªæ­£ç¡®åˆ›å»ºå‘½åç©ºé—´, å¯ä»¥è¿è¡Œèµ„æºéƒ¨ç½²å‘½ä»¤å¹¶æŸ¥çœ‹é”™è¯¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‡è®¾éƒ¨ç½²æ–‡ä»¶ä¸º kube-flannel.ymlï¼Œé‡æ–°åº”ç”¨</span></span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li><p><code>error: unable to recognize &quot;kube-flannel.yml&quot;: no matches for kind &quot;DaemonSet&quot; in version &quot;apps/v1&quot;</code></p><p>éƒ¨ç½²æ–‡ä»¶ç‰ˆæœ¬ä¸<code>K8s</code>ç‰ˆæœ¬ä¸å…¼å®¹</p></li><li><p><code>error: failed to create namespace &quot;kube-flannel&quot;: ...</code></p><p>æƒé™ä¸è¶³æˆ–è€…å‘½åç©ºé—´è¢«é”å®š, æ‰‹åŠ¨åˆ›å»ºå‘½åç©ºé—´åå†éƒ¨ç½²å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace kube-flannel</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure></li><li><p>æ— é”™è¯¯è¾“å‡ºä½†èµ„æºä»æœªåˆ›å»º</p><p>éƒ¨ç½²æ–‡ä»¶å†…å®¹æŸåæˆ–æ ¼å¼é”™è¯¯, ä¸‹è½½æœ€æ–°éƒ¨ç½²æ–‡ä»¶, å¦‚æœåŸç½‘å€è¿æ¥è¶…æ—¶å¯ä»¥ç”¨ä¸€ä¸‹ç½‘å€å°è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://ghproxy.com/https://raw.githubusercontent.com/flannel-io/flannel/v0.22.2/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>kube-flannel-ds</code>å®¹å™¨å¯åŠ¨å¤±è´¥</p><p>æŸ¥çœ‹å®¹å™¨å´©æºƒæ—¥å¿—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰å´©æºƒçš„æ—¥å¿—ï¼ˆæ›¿æ¢ &lt;pod-name&gt; ä¸ºå®é™…åç§°ï¼Œå¦‚ kube-flannel-ds-wl42wï¼‰</span></span><br><span class="line">kubectl logs &#123;pod_name&#125; -n kube-flannel -c kube-flannel</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‹¥å½“å‰æ—¥å¿—æ— æœ‰æ•ˆä¿¡æ¯ï¼ŒæŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨çš„æ—¥å¿—</span></span><br><span class="line">kubectl logs &#123;pod_name&#125; -n kube-flannel -c kube-flannel --previous</span><br></pre></td></tr></table></figure><p>é”™è¯¯åŸå› :</p><ol><li><p>æƒé™ä¸è¶³</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ Flannel DaemonSet</span></span><br><span class="line">kubectl edit daemonset kube-flannel-ds -n kube-flannel</span><br></pre></td></tr></table></figure><p>åœ¨ <code>spec.template.spec.containers[0].securityContext</code> ä¸‹æ·»åŠ  / ç¡®è®¤ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">true</span>  <span class="comment"># å¿…é¡»å¼€å¯ï¼Œå…è®¸ä¿®æ”¹ä¸»æœºç½‘ç»œ</span></span><br><span class="line">  <span class="attr">capabilities:</span></span><br><span class="line">    <span class="attr">add:</span> [<span class="string">&quot;NET_ADMIN&quot;</span>, <span class="string">&quot;NET_RAW&quot;</span>]  <span class="comment"># å¿…è¦çš„ç½‘ç»œç®¡ç†æƒé™</span></span><br></pre></td></tr></table></figure></li><li><p><code>etcd</code>è¿æ¥å¤±è´¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘ Flannel ConfigMapï¼ˆå­˜å‚¨æ ¸å¿ƒé…ç½®ï¼‰</span></span><br><span class="line">kubectl edit configmap kube-flannel-cfg -n kube-flannel</span><br></pre></td></tr></table></figure><p>ç¡®ä¿ <code>net-conf.json</code> ä¸­ä½¿ç”¨ <code>kube-api</code> åç«¯ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;net-conf.json&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.244.0.0/16&quot;</span><span class="punctuation">,</span>  # ä¸ kubeadm init æ—¶çš„ --pod-network-cidr ä¸€è‡´</span><br><span class="line">    <span class="attr">&quot;Backend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vxlan&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;KubeAPIEndpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://172.29.160.142:6443&quot;</span><span class="punctuation">,</span>  # æ§åˆ¶å¹³é¢ API åœ°å€</span><br><span class="line">      <span class="attr">&quot;KubeAPIToken&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;ä½ çš„ kube-proxy token&gt;&quot;</span>  # å¯ç•™ç©ºï¼ŒFlannel ä¼šè‡ªåŠ¨è·å–</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>è‹¥ä¸æ¸…æ¥š API åœ°å€ï¼Œå¯é€šè¿‡ <code>kubectl cluster-info</code> æŸ¥çœ‹ã€‚</p></blockquote></li><li><p>ç½‘ç»œå†²çª</p><p>æ£€æŸ¥ç«¯å£å ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> netstat -tulpn | grep 8472  <span class="comment"># æ‰¾åˆ°å ç”¨ç«¯å£çš„è¿›ç¨‹å¹¶åœæ­¢</span></span><br></pre></td></tr></table></figure><p>è‹¥æ— æ³•æŒºå°¸å†²çªè¿›ç¨‹æˆ–è€…è¯¥ç«¯å£ç¡®å®éœ€è¦è¢«å ç”¨, åˆ™ä¿®æ”¹<code>Flannel</code>ç«¯å£, ç¼–è¾‘<code>ConfigMap</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap -n kube-flannel</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Backend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vxlan&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Port&quot;</span><span class="punctuation">:</span> <span class="number">8473</span>  # æ”¹ä¸ºæœªå ç”¨çš„ç«¯å£ï¼ˆå¦‚ <span class="number">8473</span>ï¼‰</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>èµ„æºä¸è¶³</p><p>å‚è€ƒ<code>DaemonSet</code>èµ„æºä¸è¶³çš„è§£å†³æ–¹æ¡ˆ</p></li><li><p>é•œåƒæŸåæˆ–ç‰ˆæœ¬ä¸å…¼å®¹</p><p>æ£€æŸ¥æˆ–è€…é‡æ–°å¯¼å…¥å…¼å®¹çš„é•œåƒ</p></li><li><p>æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–è€…ç›®å½•</p><p>æ ¹æ®æ‰¾ä¸åˆ°çš„æ–‡ä»¶æˆ–è€…ç›®å½•çš„ä¸åŒ, è§£å†³æ–¹æ¡ˆæœ‰å¯èƒ½ä¸åŒ, æœ¬äººå°±æ˜¯åœ¨æ­¤é‡åˆ°é—®é¢˜, è¿™é‡Œç»™å‡ºæ­¤æ–‡ä»¶çš„è§£å†³æ–¹æ¡ˆ</p><ul><li><p><code>Failed to check br_netfilter: stat /proc/sys/net/bridge/bridge-nf-call-iptables: no such file or directory</code>: ç¼ºå°‘ <code>br_netfilter</code> å†…æ ¸æ¨¡å—æˆ–å¯¹åº”çš„ç›¸å…³é…ç½®æ–‡ä»¶</p><p>è¿™ä¸ªé—®é¢˜å…¶å®åœ¨ä¸Šä¸€ç¯‡ä¸­çš„ç³»ç»Ÿé…ç½®å°±è§£å†³äº†, åªæ˜¯å½“æ—¶ä½¿ç”¨çš„æ˜¯ä¸´æ—¶ç”Ÿæ•ˆå†…æ ¸å‚æ•°, å¯¼è‡´è™šæ‹Ÿæœºé‡å¯åå¤±æ•ˆäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŠ è½½ br_netfilter æ¨¡å—</span></span><br><span class="line"><span class="built_in">sudo</span> modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"><span class="comment"># è‹¥è¾“å‡ºç±»ä¼¼ br_netfilter 24576 0ï¼Œè¯´æ˜æ¨¡å—åŠ è½½æˆåŠŸã€‚</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ä¸´æ—¶ç”Ÿæ•ˆå†…æ ¸å‚æ•°ï¼ˆç«‹å³åº”ç”¨ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> sysctl -w net.bridge.bridge-nf-call-iptables=1</span><br><span class="line"><span class="built_in">sudo</span> sysctl -w net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line"><span class="built_in">sudo</span> sysctl -w net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŒä¹…åŒ–é…ç½®ï¼ˆé‡å¯åè‡ªåŠ¨ç”Ÿæ•ˆï¼‰</span></span><br><span class="line"><span class="comment"># åˆ›å»º/ç¼–è¾‘å†…æ ¸å‚æ•°é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># ä¸Šé¢å‘½ä»¤å¯èƒ½ä¼šå‡ºç°æƒé™ä¸è¶³çš„æƒ…å†µ, å¯ä»¥é€šè¿‡viå‘½ä»¤ç›´æ¥ç¼–è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç”Ÿæ•ˆé…ç½®</span></span><br><span class="line"><span class="built_in">sudo</span> sysctl --system</span><br></pre></td></tr></table></figure><p>ç¡®è®¤é…ç½®æ–‡ä»¶å­˜åœ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="built_in">ls</span> -l /proc/sys/net/bridge/bridge-nf-call-iptables</span><br></pre></td></tr></table></figure><p>é‡å¯<code>Flannel</code>å’Œ<code>kubelet</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡å¯ Flannel Podï¼ˆä½¿å…¶æ£€æµ‹åˆ°æ–°é…ç½®ï¼‰</span></span><br><span class="line">kubectl delete pods -n kube-flannel --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ kubelet</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure><blockquote><p>ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦æ‰§è¡ŒåŠ è½½<code>br_netfilter</code>æ¨¡å—å‘½ä»¤, ç„¶ååˆ é™¤<code>kube-flannel</code>çš„<code>pod</code>, é‡å¯<code>kubelet</code>å³å¯, æˆ–è€…ç­‰å¾…å®¹å™¨è‡ªå·±é‡æ–°å¯åŠ¨</p></blockquote></li></ul></li></ol></li><li><p><code>DaemonSet</code>ä¸å­˜åœ¨</p><p>è¿™ç§æƒ…å†µé€šå¸¸æ˜¯éƒ¨ç½²æ–‡ä»¶æœªè¢«æ­£ç¡®åº”ç”¨, æˆ–åº”ç”¨æ—¶å‡ºé”™, è§£å†³æ–¹å¼å‚è€ƒç¬¬ä¸€ç§æƒ…å†µ, æŸ¥çœ‹éƒ¨ç½²æ–‡ä»¶éƒ¨ç½²å¤±è´¥çš„åŸå› </p></li><li><p><code>DaemonSet</code>å­˜åœ¨ä½†<code>DESIRED</code>å’Œ<code>CURRENT</code>ä¸º0</p><p>è¿™ç§æƒ…å†µé€šå¸¸æ˜¯å­˜åœ¨è°ƒåº¦é™åˆ¶æˆ–é…ç½®é”™è¯¯</p><ul><li><p><code>node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, but no tolerations</code>: <code>master</code>èŠ‚ç‚¹æœ‰æ±¡ç‚¹, è€Œ<code>Flannel DaemonSet</code>æœªé…ç½®å®¹å¿(<code>toleration</code>), å¯¼è‡´æ— æ³•è°ƒåº¦åˆ°<code>master</code>èŠ‚ç‚¹</p><p>è§£å†³: ç¼–è¾‘<code>DaemonSet</code>, æ·»åŠ å¯¹<code>master</code>æ±¡ç‚¹çš„å®¹å¿</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit daemonset kube-flannel-ds -n kube-flannel</span><br></pre></td></tr></table></figure><p>åœ¨ <code>spec.template.spec</code> ä¸‹æ·»åŠ ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/control-plane</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure></li><li><p><code>Insufficient cpu</code> æˆ– <code>Insufficient memory</code>: èŠ‚ç‚¹èµ„æºä¸è¶³</p><p>è§£å†³: æ¸…ç†èŠ‚ç‚¹èµ„æº, æˆ–é™ä½<code>Flannel</code>çš„èµ„æºè¯·æ±‚, ç¼–è¾‘<code>DaemonSet</code>, è°ƒæ•´<code>resources.requests</code>(æ“ä½œæ–¹å¼åŒä¸Š)</p></li><li><p><code>no nodes available</code>: èŠ‚ç‚¹äº²å’Œæ€§è§„åˆ™ä¸åŒ¹é…</p><p>è§£å†³: æ£€æŸ¥<code>DaemonSet</code>ä¸­çš„<code>nodeSelector</code>, ç¡®ä¿èŠ‚ç‚¹æœ‰å¯¹åº”æ ‡ç­¾, æˆ–åˆ é™¤ä¸å¿…è¦çš„<code>nodeSelector</code></p></li></ul></li><li><p>æ§åˆ¶å¹³é¢ç»„ä»¶å¼‚å¸¸</p><p>æŸ¥çœ‹æ§åˆ¶å¹³é¢ç»„ä»¶çŠ¶æ€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system | grep -E <span class="string">&quot;kube-apiserver|kube-controller-manager|kube-scheduler&quot;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå¼‚å¸¸éœ€å…ˆä¿®å¤æ§åˆ¶å¹³é¢</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sç³»åˆ—(äºŒ)---è½¯ä»¶å®‰è£…</title>
      <link href="/2025/08/13/k8s/K8s%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%AE%89%E8%A3%85/"/>
      <url>/2025/08/13/k8s/K8s%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>K8s</code>çš„æ­å»ºæ–¹æ¡ˆæ ¹æ®éœ€æ±‚æœ‰ä¸åŒçš„æ–¹å¼, å¦‚å•æœºå¯ä»¥ä½¿ç”¨<code>minikube</code>, ç®€æ˜“æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨<code>k3s</code>. æœ¬ç³»åˆ—é‡‡ç”¨<code>kubeadm</code>æ­å»ºå¤šå°æœºå™¨çš„å¤§å‹æ–¹æ¡ˆ</p><p>å› ä¸º<code>k8s</code>åœ¨<code>1.24.x</code>ç‰ˆæœ¬å¼€å§‹é»˜è®¤ä¸ä½¿ç”¨<code>docker</code>,æ‰€ä»¥æœ¬æ¬¡æ¼”ç¤ºæ­å»ºä½¿ç”¨<code>containerd</code>åšä¸ºå®¹å™¨</p><p>ä½¿ç”¨3å°<code>Ubuntu</code>(<code>multipass</code>)ç³»ç»Ÿçš„è™šæ‹Ÿæœº</p><h3 id="ç³»ç»Ÿé…ç½®"><a class="markdownIt-Anchor" href="#ç³»ç»Ÿé…ç½®"></a> ç³»ç»Ÿé…ç½®</h3><h4 id="ä¿®æ”¹æºé…ç½®"><a class="markdownIt-Anchor" href="#ä¿®æ”¹æºé…ç½®"></a> ä¿®æ”¹æºé…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/apt/sources.list</span><br></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deb https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"># deb https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"># deb-src https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade</span><br></pre></td></tr></table></figure><h4 id="å…³é—­é˜²ç«å¢™"><a class="markdownIt-Anchor" href="#å…³é—­é˜²ç«å¢™"></a> å…³é—­é˜²ç«å¢™</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­é˜²ç«å¢™å’Œselinux</span></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line">sed -i <span class="string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><h4 id="å…³é—­swapåˆ†åŒº"><a class="markdownIt-Anchor" href="#å…³é—­swapåˆ†åŒº"></a> å…³é—­<code>swap</code>åˆ†åŒº</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­swapåˆ†åŒº</span></span><br><span class="line"><span class="built_in">sudo</span> sed -ri <span class="string">&#x27;s/.&quot;swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line"><span class="comment"># é‡å¯</span></span><br></pre></td></tr></table></figure><h4 id="å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡ç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®"><a class="markdownIt-Anchor" href="#å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡ç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®"></a> å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡,ç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y chrony</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹hosts"><a class="markdownIt-Anchor" href="#ä¿®æ”¹hosts"></a> ä¿®æ”¹<code>hosts</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/hosts</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.27.225.160 k8s-master</span><br><span class="line">172.27.227.1  k8s-node-01</span><br><span class="line">172.27.236.102 k8s-node-02</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„: æ­¤å¤„ä¿®æ”¹æ˜¯ä¸ºäº†<code>K8s</code>é›†ç¾¤å‡†å¤‡, <code>containerd</code>æœ¬èº«ä¸éœ€è¦é…ç½®è¯¥å†…å®¹</p></blockquote><h4 id="è½¬å‘ipv4å¹¶è®©iptablesçœ‹åˆ°æ¡¥æ¥æµé‡"><a class="markdownIt-Anchor" href="#è½¬å‘ipv4å¹¶è®©iptablesçœ‹åˆ°æ¡¥æ¥æµé‡"></a> è½¬å‘<code>IPv4</code>å¹¶è®©<code>iptables</code>çœ‹åˆ°æ¡¥æ¥æµé‡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF </span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> modprobe overlay</span><br><span class="line"><span class="built_in">sudo</span> modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ‰€éœ€çš„ sysctl å‚æ•°</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”ç”¨ sysctl å‚æ•°</span></span><br><span class="line"><span class="built_in">sudo</span> sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€éªŒé…ç½®æ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line">lsmod | grep overlay</span><br><span class="line"></span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„: æ­¤å¤„ä¿®æ”¹æ˜¯ä¸ºäº†<code>K8s</code>é›†ç¾¤å‡†å¤‡</p></blockquote><h3 id="å®‰è£…è½¯ä»¶"><a class="markdownIt-Anchor" href="#å®‰è£…è½¯ä»¶"></a> å®‰è£…è½¯ä»¶</h3><h4 id="å®‰è£…containerd"><a class="markdownIt-Anchor" href="#å®‰è£…containerd"></a> å®‰è£…<code>containerd</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®˜æ–¹å®‰è£…æ•™ç¨‹ï¼šhttps://github.com/containerd/containerd/blob/main/docs/getting-started.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½å®‰è£…containerd</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/containerd/containerd/releases/download/v2.1.4/containerd-2.1.4-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar Cxzvf /usr/local containerd-2.1.4-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><h4 id="é…ç½®é€šè¿‡systemdå¯åŠ¨containd"><a class="markdownIt-Anchor" href="#é…ç½®é€šè¿‡systemdå¯åŠ¨containd"></a> é…ç½®é€šè¿‡<code>systemd</code>å¯åŠ¨<code>containd</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line"><span class="built_in">sudo</span> wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -o /usr/lib/systemd/system/containerd.service</span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> containerd</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…-runc"><a class="markdownIt-Anchor" href="#å®‰è£…-runc"></a> å®‰è£… <code>runc</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç‰ˆæœ¬è¯´æ˜ï¼šhttps://github.com/containerd/containerd/blob/release/1.6/script/setup/runc-version</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/opencontainers/runc/releases/download/v1.3.0/runc.amd64</span><br><span class="line"><span class="built_in">sudo</span> install -m 755 runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…-cni-plugins"><a class="markdownIt-Anchor" href="#å®‰è£…-cni-plugins"></a> å®‰è£… <code>CNI plugins</code></h4><p>è¿™æ˜¯å®¹å™¨ç½‘ç»œæ¥å£çš„åŸºç¡€æ’ä»¶, ä¸ºå®¹å™¨æä¾›åŸºç¡€çš„ç½‘ç»œåŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæœ¬è¯´æ˜ï¼šhttps://github.com/containerd/containerd/blob/release/1.6/go.mod</span></span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/containernetworking/plugins/releases/download/v1.7.1/cni-plugins-linux-amd64-v1.7.1.tgz</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/cni/bin</span><br><span class="line"><span class="built_in">sudo</span> tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.7.1.tgz</span><br></pre></td></tr></table></figure><h4 id="ç”Ÿæˆcontainerdé»˜è®¤é…ç½®æ–‡ä»¶"><a class="markdownIt-Anchor" href="#ç”Ÿæˆcontainerdé»˜è®¤é…ç½®æ–‡ä»¶"></a> ç”Ÿæˆ<code>containerd</code>é»˜è®¤é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆ containerd é»˜è®¤é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /etc/containerd</span><br><span class="line"><span class="comment"># è¿™ä¸€æ­¥å¦‚æœå‡ºç°æƒé™æ‹’ç»å¯ä»¥ç›´æ¥åˆ°rootç”¨æˆ·ä¸‹æ‰§è¡Œ</span></span><br><span class="line"><span class="built_in">sudo</span> containerd config default &gt; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹containerdé…ç½®æ–‡ä»¶"><a class="markdownIt-Anchor" href="#ä¿®æ”¹containerdé…ç½®æ–‡ä»¶"></a> ä¿®æ”¹<code>containerd</code>é…ç½®æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># æ³¨æ„é…ç½®æ–‡ä»¶ä¸­æ ‡è®°çš„versionå·, æ ¹æ®versionå·æ‰¾å¯¹åº”çš„é…ç½®å†…å®¹</span></span><br><span class="line"><span class="comment"># æ–‡æ¡£ï¼šhttps://github.com/containerd/containerd/blob/main/docs/hosts.md</span></span><br><span class="line"><span class="built_in">sudo</span> vi /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ä¸€ä¸‹é…ç½®, æ³¨æ„æ ¼å¼</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.cri.v1.images&quot;</span>.registry]</span><br><span class="line">   config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.cri.v1.images&quot;</span>.pinned_images]</span><br><span class="line">  sandbox = <span class="string">&#x27;registry.aliyuncs.com/google_containers/pause:3.10&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">root</span> = <span class="string">&#x27;/var/lib/containerd&#x27;</span></span><br><span class="line"><span class="attr">state</span> = <span class="string">&#x27;/run/containerd&#x27;</span></span><br><span class="line"><span class="attr">temp</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="attr">disabled_plugins</span> = []</span><br><span class="line"><span class="attr">required_plugins</span> = []</span><br><span class="line"><span class="attr">oom_score</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">imports</span> = []</span><br><span class="line"></span><br><span class="line"><span class="section">[grpc]</span></span><br><span class="line">  <span class="attr">address</span> = <span class="string">&#x27;/run/containerd/containerd.sock&#x27;</span></span><br><span class="line">  <span class="attr">tcp_address</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">tcp_tls_ca</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">tcp_tls_cert</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">tcp_tls_key</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">uid</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">gid</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">max_recv_message_size</span> = <span class="number">16777216</span></span><br><span class="line">  <span class="attr">max_send_message_size</span> = <span class="number">16777216</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ttrpc]</span></span><br><span class="line">  <span class="attr">address</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">uid</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">gid</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="section">[debug]</span></span><br><span class="line">  <span class="attr">address</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">uid</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">gid</span> = <span class="number">0</span></span><br><span class="line">  <span class="attr">level</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">format</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[metrics]</span></span><br><span class="line">  <span class="attr">address</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">grpc_histogram</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[plugins]</span></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.cri.v1.images&#x27;]</span></span><br><span class="line">    <span class="attr">snapshotter</span> = <span class="string">&#x27;overlayfs&#x27;</span></span><br><span class="line">    <span class="attr">disable_snapshot_annotations</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">discard_unpacked_layers</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">max_concurrent_downloads</span> = <span class="number">3</span></span><br><span class="line">    <span class="attr">concurrent_layer_fetch_buffer</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">image_pull_progress_timeout</span> = <span class="string">&#x27;5m0s&#x27;</span></span><br><span class="line">    <span class="attr">image_pull_with_sync_fs</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">stats_collect_period</span> = <span class="number">10</span></span><br><span class="line">    <span class="attr">use_local_image_pull</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.cri.v1.images&#x27;.pinned_images]</span></span><br><span class="line">      <span class="attr">sandbox</span> = <span class="string">&#x27;registry.aliyuncs.com/google_containers/pause:3.10&#x27;</span></span><br><span class="line">      <span class="comment"># sandbox = &#x27;registry.k8s.io/pause:3.10&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.cri.v1.images&#x27;.registry]</span></span><br><span class="line">      <span class="attr">config_path</span> = <span class="string">&#x27;/etc/containerd/certs.d&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.cri.v1.images&#x27;.image_decryption]</span></span><br><span class="line">      <span class="attr">key_model</span> = <span class="string">&#x27;node&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;]</span></span><br><span class="line">    <span class="attr">enable_selinux</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">selinux_category_range</span> = <span class="number">1024</span></span><br><span class="line">    <span class="attr">max_container_log_line_size</span> = <span class="number">16384</span></span><br><span class="line">    <span class="attr">disable_apparmor</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">restrict_oom_score_adj</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">disable_proc_mount</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">unset_seccomp_profile</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">tolerate_missing_hugetlb_controller</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">disable_hugetlb_controller</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">device_ownership_from_security_context</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">ignore_image_defined_volumes</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">netns_mounts_under_state_dir</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">enable_unprivileged_ports</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">enable_unprivileged_icmp</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">enable_cdi</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">cdi_spec_dirs</span> = [<span class="string">&#x27;/etc/cdi&#x27;</span>, <span class="string">&#x27;/var/run/cdi&#x27;</span>]</span><br><span class="line">    <span class="attr">drain_exec_sync_io_timeout</span> = <span class="string">&#x27;0s&#x27;</span></span><br><span class="line">    <span class="attr">ignore_deprecation_warnings</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;.containerd]</span></span><br><span class="line">      <span class="attr">default_runtime_name</span> = <span class="string">&#x27;runc&#x27;</span></span><br><span class="line">      <span class="attr">ignore_blockio_not_enabled_errors</span> = <span class="literal">false</span></span><br><span class="line">      <span class="attr">ignore_rdt_not_enabled_errors</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;.containerd.runtimes]</span></span><br><span class="line">        <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;.containerd.runtimes.runc]</span></span><br><span class="line">          <span class="attr">runtime_type</span> = <span class="string">&#x27;io.containerd.runc.v2&#x27;</span></span><br><span class="line">          <span class="attr">runtime_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">          <span class="attr">pod_annotations</span> = []</span><br><span class="line">          <span class="attr">container_annotations</span> = []</span><br><span class="line">          <span class="attr">privileged_without_host_devices</span> = <span class="literal">false</span></span><br><span class="line">          <span class="attr">privileged_without_host_devices_all_devices_allowed</span> = <span class="literal">false</span></span><br><span class="line">          <span class="attr">cgroup_writable</span> = <span class="literal">false</span></span><br><span class="line">          <span class="attr">base_runtime_spec</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">          <span class="attr">cni_conf_dir</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">          <span class="attr">cni_max_conf_num</span> = <span class="number">0</span></span><br><span class="line">          <span class="attr">snapshotter</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">          <span class="attr">sandboxer</span> = <span class="string">&#x27;podsandbox&#x27;</span></span><br><span class="line">          <span class="attr">io_type</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">          <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;.containerd.runtimes.runc.options]</span></span><br><span class="line">            <span class="attr">BinaryName</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="attr">CriuImagePath</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="attr">CriuWorkPath</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="attr">IoGid</span> = <span class="number">0</span></span><br><span class="line">            <span class="attr">IoUid</span> = <span class="number">0</span></span><br><span class="line">            <span class="attr">NoNewKeyring</span> = <span class="literal">false</span></span><br><span class="line">            <span class="attr">Root</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="attr">ShimCgroup</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="attr">SystemdCgroup</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.cri.v1.runtime&#x27;.cni]</span></span><br><span class="line">      <span class="attr">bin_dir</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">bin_dirs</span> = [<span class="string">&#x27;/opt/cni/bin&#x27;</span>]</span><br><span class="line">      <span class="attr">conf_dir</span> = <span class="string">&#x27;/etc/cni/net.d&#x27;</span></span><br><span class="line">      <span class="attr">max_conf_num</span> = <span class="number">1</span></span><br><span class="line">      <span class="attr">setup_serially</span> = <span class="literal">false</span></span><br><span class="line">      <span class="attr">conf_template</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">ip_pref</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">use_internal_loopback</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.differ.v1.erofs&#x27;]</span></span><br><span class="line">    <span class="attr">mkfs_options</span> = []</span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.gc.v1.scheduler&#x27;]</span></span><br><span class="line">    <span class="attr">pause_threshold</span> = <span class="number">0.02</span></span><br><span class="line">    <span class="attr">deletion_threshold</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">mutation_threshold</span> = <span class="number">100</span></span><br><span class="line">    <span class="attr">schedule_delay</span> = <span class="string">&#x27;0s&#x27;</span></span><br><span class="line">    <span class="attr">startup_delay</span> = <span class="string">&#x27;100ms&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.grpc.v1.cri&#x27;]</span></span><br><span class="line">    <span class="attr">disable_tcp_service</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">stream_server_address</span> = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">    <span class="attr">stream_server_port</span> = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    <span class="attr">stream_idle_timeout</span> = <span class="string">&#x27;4h0m0s&#x27;</span></span><br><span class="line">    <span class="attr">enable_tls_streaming</span> = <span class="literal">false</span></span><br><span class="line">    <span class="section">[plugins.&#x27;io.containerd.grpc.v1.cri&#x27;.x509_key_pair_streaming]</span></span><br><span class="line">      <span class="attr">tls_cert_file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      <span class="attr">tls_key_file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.image-verifier.v1.bindir&#x27;]</span></span><br><span class="line">    <span class="attr">bin_dir</span> = <span class="string">&#x27;/opt/containerd/image-verifier/bin&#x27;</span></span><br><span class="line">    <span class="attr">max_verifiers</span> = <span class="number">10</span></span><br><span class="line">    <span class="attr">per_verifier_timeout</span> = <span class="string">&#x27;10s&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.internal.v1.opt&#x27;]</span></span><br><span class="line">    <span class="attr">path</span> = <span class="string">&#x27;/opt/containerd&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.internal.v1.tracing&#x27;]</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.metadata.v1.bolt&#x27;]</span></span><br><span class="line">    <span class="attr">content_sharing_policy</span> = <span class="string">&#x27;shared&#x27;</span></span><br><span class="line">    <span class="attr">no_sync</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.monitor.container.v1.restart&#x27;]</span></span><br><span class="line">    <span class="attr">interval</span> = <span class="string">&#x27;10s&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.monitor.task.v1.cgroups&#x27;]</span></span><br><span class="line">    <span class="attr">no_prometheus</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.nri.v1.nri&#x27;]</span></span><br><span class="line">    <span class="attr">disable</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">socket_path</span> = <span class="string">&#x27;/var/run/nri/nri.sock&#x27;</span></span><br><span class="line">    <span class="attr">plugin_path</span> = <span class="string">&#x27;/opt/nri/plugins&#x27;</span></span><br><span class="line">    <span class="attr">plugin_config_path</span> = <span class="string">&#x27;/etc/nri/conf.d&#x27;</span></span><br><span class="line">    <span class="attr">plugin_registration_timeout</span> = <span class="string">&#x27;5s&#x27;</span></span><br><span class="line">    <span class="attr">plugin_request_timeout</span> = <span class="string">&#x27;2s&#x27;</span></span><br><span class="line">    <span class="attr">disable_connections</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.runtime.v2.task&#x27;]</span></span><br><span class="line">    <span class="attr">platforms</span> = [<span class="string">&#x27;linux/amd64&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.service.v1.diff-service&#x27;]</span></span><br><span class="line">    <span class="attr">default</span> = [<span class="string">&#x27;walking&#x27;</span>]</span><br><span class="line">    <span class="attr">sync_fs</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.service.v1.tasks-service&#x27;]</span></span><br><span class="line">    <span class="attr">blockio_config_file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">rdt_config_file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.shim.v1.manager&#x27;]</span></span><br><span class="line">    <span class="attr">env</span> = []</span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.blockfile&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">scratch_file</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">fs_type</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">mount_options</span> = []</span><br><span class="line">    <span class="attr">recreate_scratch</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.btrfs&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.devmapper&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">pool_name</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">base_image_size</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">async_remove</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">discard_blocks</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">fs_type</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">fs_options</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.erofs&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">ovl_mount_options</span> = []</span><br><span class="line">    <span class="attr">enable_fsverity</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">set_immutable</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.native&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.overlayfs&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">upperdir_label</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">sync_remove</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">slow_chown</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">mount_options</span> = []</span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.snapshotter.v1.zfs&#x27;]</span></span><br><span class="line">    <span class="attr">root_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.tracing.processor.v1.otlp&#x27;]</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[plugins.&#x27;io.containerd.transfer.v1.local&#x27;]</span></span><br><span class="line">    <span class="attr">max_concurrent_downloads</span> = <span class="number">3</span></span><br><span class="line">    <span class="attr">concurrent_layer_fetch_buffer</span> = <span class="number">0</span></span><br><span class="line">    <span class="attr">max_concurrent_uploaded_layers</span> = <span class="number">3</span></span><br><span class="line">    <span class="attr">check_platform_supported</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">config_path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[cgroup]</span></span><br><span class="line">  <span class="attr">path</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[timeouts]</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.bolt.open&#x27;</span> = <span class="string">&#x27;0s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.cri.defercleanup&#x27;</span> = <span class="string">&#x27;1m0s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.metrics.shimstats&#x27;</span> = <span class="string">&#x27;2s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.shim.cleanup&#x27;</span> = <span class="string">&#x27;5s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.shim.load&#x27;</span> = <span class="string">&#x27;5s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.shim.shutdown&#x27;</span> = <span class="string">&#x27;3s&#x27;</span></span><br><span class="line">  <span class="attr">&#x27;io.containerd.timeout.task.state&#x27;</span> = <span class="string">&#x27;2s&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[stream_processors]</span></span><br><span class="line">  <span class="section">[stream_processors.&#x27;io.containerd.ocicrypt.decoder.v1.tar&#x27;]</span></span><br><span class="line">    <span class="attr">accepts</span> = [<span class="string">&#x27;application/vnd.oci.image.layer.v1.tar+encrypted&#x27;</span>]</span><br><span class="line">    <span class="attr">returns</span> = <span class="string">&#x27;application/vnd.oci.image.layer.v1.tar&#x27;</span></span><br><span class="line">    <span class="attr">path</span> = <span class="string">&#x27;ctd-decoder&#x27;</span></span><br><span class="line">    <span class="attr">args</span> = [<span class="string">&#x27;--decryption-keys-path&#x27;</span>, <span class="string">&#x27;/etc/containerd/ocicrypt/keys&#x27;</span>]</span><br><span class="line">    <span class="attr">env</span> = [<span class="string">&#x27;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="section">[stream_processors.&#x27;io.containerd.ocicrypt.decoder.v1.tar.gzip&#x27;]</span></span><br><span class="line">    <span class="attr">accepts</span> = [<span class="string">&#x27;application/vnd.oci.image.layer.v1.tar+gzip+encrypted&#x27;</span>]</span><br><span class="line">    <span class="attr">returns</span> = <span class="string">&#x27;application/vnd.oci.image.layer.v1.tar+gzip&#x27;</span></span><br><span class="line">    <span class="attr">path</span> = <span class="string">&#x27;ctd-decoder&#x27;</span></span><br><span class="line">    <span class="attr">args</span> = [<span class="string">&#x27;--decryption-keys-path&#x27;</span>, <span class="string">&#x27;/etc/containerd/ocicrypt/keys&#x27;</span>]</span><br><span class="line">    <span class="attr">env</span> = [<span class="string">&#x27;OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&#x27;</span>]</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ host-registry"><a class="markdownIt-Anchor" href="#æ·»åŠ host-registry"></a> æ·»åŠ <code>host registry</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/containerd/certs.d</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/containerd/certs.d/docker.io</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/containerd/certs.d/_default</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">touch</span> /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">touch</span> /etc/containerd/certs.d/_default/hosts.toml</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class="line">server = <span class="string">&quot;https://registry-1.docker.io&quot;</span></span><br><span class="line"></span><br><span class="line">[host.<span class="string">&quot;https://m.daocloud.io/docker.io&quot;</span>]</span><br><span class="line">  capabilities = [<span class="string">&quot;pull&quot;</span>, <span class="string">&quot;resolve&quot;</span>]</span><br></pre></td></tr></table></figure><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/containerd/certs.d/_default/host.toml</span><br><span class="line"></span><br><span class="line"><span class="attr">server</span> = <span class="string">&quot;https://registry-1.docker.io&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[host.&quot;http://192.168.31.250:5000&quot;]</span></span><br><span class="line">  <span class="attr">capabilities</span> = [<span class="string">&quot;pull&quot;</span>, <span class="string">&quot;resolve&quot;</span>, <span class="string">&quot;push&quot;</span>]</span><br><span class="line">  <span class="attr">skip_verify</span> = <span class="literal">true</span></span><br><span class="line"><span class="section">[host.&quot;https://docker.m.daocloud.io&quot;]</span></span><br><span class="line">  <span class="attr">capabilities</span> = [<span class="string">&quot;pull&quot;</span>, <span class="string">&quot;resolve&quot;</span>]</span><br></pre></td></tr></table></figure><p><img src="containerd%E9%85%8D%E7%BD%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt="containerdé…ç½®ç›®å½•ç»“æ„" /></p><blockquote><p>é…ç½®æ–¹å¼å¯ä»¥æŸ¥çœ‹</p><p><code>https://github.com/containerd/containerd/blob/v2.1.4/docs/hosts.md</code></p></blockquote><h4 id="å¯åŠ¨containerd"><a class="markdownIt-Anchor" href="#å¯åŠ¨containerd"></a> å¯åŠ¨<code>containerd</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ containerd</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æˆåŠŸåå¯ä»¥æŸ¥çœ‹åˆ°ç›‘å¬çš„ç«¯å£</span></span><br><span class="line"><span class="built_in">sudo</span> netstat -nlput | grep containerd</span><br></pre></td></tr></table></figure><h4 id="å®‰è£…cliå·¥å…·å¯é€‰"><a class="markdownIt-Anchor" href="#å®‰è£…cliå·¥å…·å¯é€‰"></a> å®‰è£…<code>cli</code>å·¥å…·(å¯é€‰)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…cliå·¥å…·</span></span><br><span class="line"><span class="comment"># å®‰è£… containerd çš„ cli ç®¡ç†å·¥å…·ï¼ˆæ­¤æ­¥éª¤æ˜¯éå¿…é€‰é¡¹ï¼‰</span></span><br><span class="line"><span class="comment"># å®˜æ–¹æ–‡æ¡£https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1ã€ä¸‹è½½å®‰è£…</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.26.0/crictl-v1.26.0-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar Czxvf crictl-v1.26.0-linux-amd64.tar.gz /usr/local/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2ã€åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œè¿è¡Œ crictl config å‘½ä»¤å¯è·å–å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/crictl.yaml</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 2</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">pull-image-on-create: false</span></span><br><span class="line"><span class="string">disable-pull-on-run: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3ã€æµ‹è¯•</span></span><br><span class="line"><span class="built_in">sudo</span> crictl pods</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ä½¿ç”¨ crictl config --set debug=true æ¥å¼€å¯è°ƒè¯•æ¨¡å¼</span></span><br><span class="line"><span class="comment"># é€šè¿‡å‘½ä»¤ crictl config --get debug æŸ¥çœ‹å½“å‰æ˜¯å¦å¤„äºdebugæ¨¡å¼</span></span><br></pre></td></tr></table></figure><p>åˆ°æ­¤, æˆ‘ä»¬å®‰è£…å¹¶é…ç½®äº†<code>containerd</code>å®¹å™¨, <code>runc</code>è¿è¡Œæ—¶, <code>CNI</code>åŸºç¡€æ’ä»¶.</p><p>ç±»ä¼¼äº<code>docker</code>, æ­¤æ—¶å³å¯æ ¹æ®é•œåƒå¯åŠ¨å®¹å™¨</p><p>æœ¬ç³»åˆ—ä¸»è¦ç›®çš„æ˜¯æ­å»ºä¸€ä¸ª<code>K8s</code>ç¯å¢ƒ, æ‰€ä»¥å¯¹<code>containerd</code>çš„ä½¿ç”¨ä¸åšæè¿°</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> containerd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sç³»åˆ—(ä¸€)---åŸºæœ¬æ¦‚å¿µ</title>
      <link href="/2025/08/12/k8s/K8s%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"/>
      <url>/2025/08/12/k8s/K8s%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>Kubernetes</code>æ˜¯ä¸€ä¸ªå¼€æºçš„, ç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºçš„å®¹å™¨åŒ–çš„åº”ç”¨, ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆ.</p><h3 id="é›†ç¾¤æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶"><a class="markdownIt-Anchor" href="#é›†ç¾¤æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶"></a> é›†ç¾¤æ¶æ„ä¸æ ¸å¿ƒç»„ä»¶</h3><h4 id="ç›¸å…³ç»„ä»¶"><a class="markdownIt-Anchor" href="#ç›¸å…³ç»„ä»¶"></a> ç›¸å…³ç»„ä»¶</h4><h5 id="æ§åˆ¶é¢æ¿ç»„ä»¶masterèŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#æ§åˆ¶é¢æ¿ç»„ä»¶masterèŠ‚ç‚¹"></a> æ§åˆ¶é¢æ¿ç»„ä»¶(<code>master</code>èŠ‚ç‚¹)</h5><p><code>kube-apiserver</code>: æ¥å£æœåŠ¡,åŸºäº<code>REST</code>é£æ ¼å¼€æ”¾<code>k8s</code>æ¥å£çš„æœåŠ¡</p><p><code>kube-controller-manager</code>: æ§åˆ¶å™¨ç®¡ç†å™¨, è´Ÿè´£è¿è¡Œæ§åˆ¶å™¨, ç®¡ç†å„ä¸ªç±»å‹çš„æ§åˆ¶å™¨. åŒ…æ‹¬: èŠ‚ç‚¹æ§åˆ¶å™¨,ä»»åŠ¡æ§åˆ¶å™¨,ç«¯ç‚¹åˆ†ç‰‡æ§åˆ¶å™¨,æœåŠ¡è´¦å·æ§åˆ¶å™¨</p><p><code>cloud-controller-manager</code>: äº‘æ§åˆ¶å™¨ç®¡ç†å™¨, ç¬¬ä¸‰æ–¹äº‘å¹³å°æä¾›çš„æ§åˆ¶å™¨<code>API</code>å¯¹æ¥ç®¡ç†åŠŸèƒ½</p><p><code>kube-scheduler</code>: è°ƒåº¦å™¨, è´Ÿè´£å°†<code>Pod</code>åŸºäºä¸€å®šç®—æ³•, å°†å…¶è°ƒç”¨åˆ°æ›´åˆé€‚çš„èŠ‚ç‚¹ä¸Š</p><p><code>etcd</code>: <code>k8s</code>çš„æ•°æ®åº“, ä½¿ç”¨é”®å€¼ç±»å‹å­˜å‚¨çš„åˆ†å¸ƒå¼æ•°æ®åº“, æä¾›äº†åŸºäº<code>Raft</code>ç®—æ³•å®ç°è‡ªä¸»çš„é›†ç¾¤é«˜å¯ç”¨</p><h5 id="èŠ‚ç‚¹ç»„ä»¶nodeèŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#èŠ‚ç‚¹ç»„ä»¶nodeèŠ‚ç‚¹"></a> èŠ‚ç‚¹ç»„ä»¶(<code>Node</code>èŠ‚ç‚¹)</h5><p><code>kubelet</code>: è´Ÿè´£<code>Pod</code>çš„ç”Ÿå‘½å‘¨æœŸ, å­˜å‚¨, ç½‘ç»œç­‰ç®¡ç†</p><p><code>kube-proxy</code>: ç½‘ç»œä»£ç†, è´Ÿè´£<code>service</code>çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</p><p><code>container runtime</code>: å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒ. <code>docker</code>, <code>containerd</code>, <code>CRI-O</code></p><h5 id="é™„åŠ ç»„ä»¶"><a class="markdownIt-Anchor" href="#é™„åŠ ç»„ä»¶"></a> é™„åŠ ç»„ä»¶</h5><p><code>kube-dns</code>: <code>DNS</code>æœåŠ¡</p><p><code>ingress controller</code>: å¤–éƒ¨ç½‘ç»œè®¿é—®</p><p><code>Heapster</code>: èµ„æºç›‘æ§</p><p><code>PrometheUS</code>: èµ„æºç›‘æ§</p><p><code>Dashboard</code>: æ§åˆ¶å°<code>UI</code></p><p><code>Federation</code>: é›†ç¾¤é—´çš„è°ƒåº¦, å¤¸å¯ç”¨åŒºçš„é›†ç¾¤</p><p><code>Fluentd-elasticsearch</code>: æ—¥å¿—é‡‡é›†, å­˜å‚¨, æŸ¥è¯¢</p><h4 id="åˆ†å±‚æ¶æ„"><a class="markdownIt-Anchor" href="#åˆ†å±‚æ¶æ„"></a> åˆ†å±‚æ¶æ„</h4><p>ç”Ÿæ€ç³»ç»Ÿ -&gt; æ¥å£å±‚ -&gt; ç®¡ç†å±‚ -&gt; åº”ç”¨å±‚ -&gt; æ ¸å¿ƒå±‚</p><h3 id="k8sçš„ä¸“ä¸šæœ¯è¯­"><a class="markdownIt-Anchor" href="#k8sçš„ä¸“ä¸šæœ¯è¯­"></a> <code>k8s</code>çš„ä¸“ä¸šæœ¯è¯­</h3><h4 id="å…ƒç©ºé—´å‹"><a class="markdownIt-Anchor" href="#å…ƒç©ºé—´å‹"></a> å…ƒç©ºé—´å‹</h4><p>å¯¹äºèµ„æºçš„å…ƒæ•°æ®æè¿°, æ‰€æœ‰èµ„æºéƒ½å¯ä»¥å…±äº«</p><p><code>Horizontal Pod Autoscaler(HPA)</code>: <code>Pod</code>è‡ªåŠ¨æ‰©/ç¼©å®¹</p><p><code>PodTemplate</code>: <code>Pod</code>æ¨¡æ¿</p><p><code>LimitRange</code>: èµ„æºé™åˆ¶</p><h4 id="é›†ç¾¤å‹"><a class="markdownIt-Anchor" href="#é›†ç¾¤å‹"></a> é›†ç¾¤å‹</h4><p>ä½œç”¨äºé›†ç¾¤, é›†ç¾¤ä¸‹çš„æ‰€æœ‰èµ„æºéƒ½å¯ä»¥å…±äº«</p><p><code>Namespace</code>: å‘½åç©ºé—´, èµ„æºçš„é€»è¾‘éš”ç¦»</p><p><code>Node</code>: èŠ‚ç‚¹, åªæ˜¯ç®¡ç†èŠ‚ç‚¹èµ„æº</p><p><code>ClusterRole</code>: é›†ç¾¤è§’è‰²</p><p><code>ClusterRoleBinding</code>: é›†ç¾¤è§’è‰²ç»‘å®š</p><h4 id="å‘½åç©ºé—´å‹"><a class="markdownIt-Anchor" href="#å‘½åç©ºé—´å‹"></a> å‘½åç©ºé—´å‹</h4><p>ä½œç”¨äºå‘½åç©ºé—´, åŒä¸€å‘½åç©ºé—´å†…çš„æ‰€æœ‰èµ„æºéƒ½å¯ä»¥å…±äº«</p><h5 id="å·¥ä½œè´Ÿè½½"><a class="markdownIt-Anchor" href="#å·¥ä½œè´Ÿè½½"></a> å·¥ä½œè´Ÿè½½</h5><p><code>Pod</code>: <code>k8s</code>ä¸­æœ€å°çš„å¯éƒ¨ç½²å•å…ƒ, å†…éƒ¨æ˜¯å®¹å™¨, è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨. <code>Pod</code>å†…çš„å®¹å™¨é€šè¿‡<code>pause</code>å…±äº«ç½‘ç»œå†…å­˜ç­‰ä¿¡æ¯.</p><ol><li><code>replicas</code>: å‰¯æœ¬æ•°</li><li>æ§åˆ¶å™¨(<code>Pod</code>æè¿°å™¨):<ul><li><p>æ— çŠ¶æ€:</p><ul><li><code>ReplicationController</code>: åŠ¨æ€<code>Pod</code>å‰¯æœ¬</li><li><code>ReplicaSet</code>: åŠ¨æ€<code>Pod</code>å‰¯æœ¬ + é€‰æ‹©å™¨</li><li><code>Deployment</code>: åˆ›å»º<code>RS</code>/<code>Pod</code>å‰¯æœ¬ + æ»šåŠ¨å‡çº§/å›æ»š + å¹³æ»‘æ‰©/ç¼©å®¹ + æš‚åœä¸æ¢å¤<code>Deployment</code></li></ul></li><li><p>æœ‰çŠ¶æ€:</p><p><code>StatefulSet</code>: è§£å†³ç¨³å®šç½‘ç»œå’ŒæŒä¹…åŒ–å­˜å‚¨é—®é¢˜</p><ul><li><code>Headless Service</code>: <code>DNS</code>, <code>StatefulSet</code>ä¸­æ¯ä¸ª<code>Pod</code>çš„<code>DNS</code>æ ¼å¼ä¸º<code>statefulSetName-&#123;0,n-1&#125;.serviceName.namespace.svc.cluster.local</code>,å…¶ä¸­<code>serviceName</code>å°±æ˜¯<code>Headless Service</code>çš„åå­—</li><li><code>volumeClaimTemplate</code>: ç”¨äºåˆ›å»ºæŒä¹…åŒ–å·çš„æ¨¡æ¿</li></ul></li><li><p>å®ˆæŠ¤è¿›ç¨‹: <code>DaemonSet</code></p></li><li><p>ä»»åŠ¡/å®šæ—¶ä»»åŠ¡: <code>Job</code>(ä¸€æ¬¡æ€§ä»»åŠ¡), <code>CronJob</code></p></li></ul></li></ol><h5 id="æœåŠ¡å‘ç°"><a class="markdownIt-Anchor" href="#æœåŠ¡å‘ç°"></a> æœåŠ¡å‘ç°</h5><ol><li><code>Service</code>: é›†ç¾¤å†…éƒ¨çš„ç½‘ç»œé€šè®¯</li><li><code>Ingress</code>: é›†ç¾¤ä¸å¤–éƒ¨çš„ç½‘ç»œé€šè®¯</li></ol><h5 id="å­˜å‚¨"><a class="markdownIt-Anchor" href="#å­˜å‚¨"></a> å­˜å‚¨</h5><ol><li><code>Volume</code>: æ•°æ®å·</li><li><code>CSI</code>: æ ‡å‡†æ¥å£</li></ol><h5 id="ç‰¹æ®Šç±»å‹é…ç½®"><a class="markdownIt-Anchor" href="#ç‰¹æ®Šç±»å‹é…ç½®"></a> ç‰¹æ®Šç±»å‹é…ç½®</h5><ol><li><code>ConfigMap</code>: <code>k-v</code>å½¢å¼çš„é…ç½®</li><li><code>Secret</code>: ä¿å¯†å½¢å¼çš„<code>ConfigMap</code></li><li><code>DownwardAPI</code>: å°†<code>Pod</code>ä¿¡æ¯å…±äº«åˆ°å®¹å™¨ä¸­, è®©å®¹å™¨å¯ä»¥è¯»å–<code>Pod</code>ä¿¡æ¯</li></ol><h5 id="å…¶ä»–"><a class="markdownIt-Anchor" href="#å…¶ä»–"></a> å…¶ä»–</h5><ol><li><code>Role</code>: å‘½åç©ºé—´çš„è§’è‰²</li><li><code>RoleBinding</code>: ç»‘å®šåˆ°å‘½åç©ºé—´</li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerç³»åˆ—(ä¸‰)---é¡¹ç›®éƒ¨ç½²</title>
      <link href="/2025/08/11/docker/Docker%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/"/>
      <url>/2025/08/11/docker/Docker%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p>é‡å¤´æˆæ¥äº†ï¼Œå­¦ä¹ çš„æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†åº”ç”¨ï¼Œæ‰€ä»¥é¡¹ç›®éƒ¨ç½²å°±æ˜¯æˆ‘ä»¬çš„æœ€ç»ˆé˜¶æ®µã€‚æœ¬é˜¶æ®µæ˜¯åœ¨<code>windows</code>ç³»ç»Ÿä¸Šå®Œæˆçš„ï¼Œéœ€è¦åœ¨<code>windows</code>ä¸Šå®‰è£…<code>Docker Desktop</code></p><h3 id="å®‰è£…docker-desktop"><a class="markdownIt-Anchor" href="#å®‰è£…docker-desktop"></a> å®‰è£…<code>Docker Desktop</code></h3><ol><li><p>å¼€å¯åŠŸèƒ½</p><ul><li><code>Hyper-V</code></li><li>é€‚ç”¨äº<code>Linux</code>çš„<code>Windows</code>å­ç³»ç»Ÿ</li><li>è™šæ‹Ÿæœºå¹³å°</li></ul></li><li><p><code>wsl</code>å®‰è£…<code>Ubuntu</code></p><ul><li><p>å°†<code>wsl</code>è®¾ç½®ä¸ºç‰ˆæœ¬2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨powershell</span></span><br><span class="line">wsl --set-default-version 2</span><br></pre></td></tr></table></figure></li><li><p>ç”¨<code>wsl</code>å®‰è£…<code>Ubuntu</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --install ubuntu</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>Microsoft Store</code>å®‰è£…</p><p>å®‰è£…åå»ºè®®ä¿®æ”¹æºæ–‡ä»¶</p></li></ul></li><li><p>å®‰è£…<code>Docker Desktop</code></p><p>å¦‚æœä¸€ç›´å¡åœ¨<code>Docker engine starting</code>ï¼Œå¯ä»¥åˆ°<code>C:\Program Files\Docker\Docker</code>ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./DockerCli.exe --SwitchDaemon</span><br></pre></td></tr></table></figure></li><li><p>å®¢æˆ·ç«¯è®¾ç½®</p><p><code>Settings</code> -&gt; <code>Docker Engine</code>æ·»åŠ æº</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;gc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;defaultKeepStorage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š</p><p>ç”±äºå›½å†…é™åˆ¶é—®é¢˜ï¼Œä¼šå‡ºç°æŸ¥è¯¢é•œåƒæŸ¥è¯¢ä¸åˆ°çš„é—®é¢˜ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨<code>docker</code>å‘½ä»¤ç›´æ¥æ‹‰å–ç›®æ ‡é•œåƒï¼Œæ‹‰å–å®Œåå¯ä»¥åœ¨<code>Docker Desktop</code>ä¸­æŸ¥çœ‹ä½¿ç”¨</p></blockquote></li></ol><h3 id="springbooté¡¹ç›®éƒ¨ç½²"><a class="markdownIt-Anchor" href="#springbooté¡¹ç›®éƒ¨ç½²"></a> <code>SpringBoot</code>é¡¹ç›®éƒ¨ç½²</h3><h4 id="mavenæ’ä»¶"><a class="markdownIt-Anchor" href="#mavenæ’ä»¶"></a> <code>maven</code>æ’ä»¶</h4><h5 id="å¸¸è§æ’ä»¶"><a class="markdownIt-Anchor" href="#å¸¸è§æ’ä»¶"></a> å¸¸è§æ’ä»¶</h5><ol><li><p><code>Spring Boot Maven</code>æ‰“åŒ…å†…ç½®çš„<code>build-image</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring-boot-maven-plugin</span></span><br><span class="line">mvn spring-boot:build-image</span><br><span class="line"><span class="comment"># ä¸éœ€è¦å†™dockerfileï¼Œè€Œæ˜¯åŸºäºpluginé…ç½®æ„å»º</span></span><br><span class="line"><span class="comment"># é…ç½®å®˜æ–¹æ–‡æ¡£ï¼š https://docs.spring.io/spring-boot/maven-plugin/build-image.html#build-image.build-image-goal</span></span><br><span class="line"><span class="comment"># å®˜æ–¹æ–‡æ¡£çš„åœ°å€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå»ºè®®ç›´æ¥åˆ°spring-bootå®˜ç½‘æ‰¾maven-pluginï¼Œç„¶åä»goalsä¸­æ‰¾åˆ°build-imageå³å¯</span></span><br></pre></td></tr></table></figure></li><li><p><code>Google</code>çš„<code>jib-maven-plugin</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸éœ€è¦dockerfileï¼Œç”šè‡³æœ¬åœ°å¯ä»¥æ²¡æœ‰docker</span></span><br><span class="line">mvn comple com.google.cloud.tools:jib-maven-plugin:2.3.0:dockerBuild</span><br></pre></td></tr></table></figure></li><li><p><code>Spotify</code>çš„<code>dockerfile-maven-plugin</code></p><p><code>pom.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ‰“åŒ…springbootåŒ… --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- é•œåƒæ„å»ºæ’ä»¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span>192.168.0.1:5000/xiao-lin-unit/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- å¼€å¯éªŒè¯ --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">useMavenSettingsForAuth</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useMavenSettingsForAuth</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- è®¾ç½®dockerfileä¸­çš„JAR_FILEå‚æ•°å®šä¹‰çš„å€¼ --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>target/$&#123;project.artifactId&#125;-$&#123;project.version&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>settings.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>192.168.0.1:5000<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">21</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> xiao-lin &lt;xiao_lin_unit@<span class="number">163</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /spring-boot-demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /spring-boot-demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$JAR_FILE</span> application.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai JAVA_OPTS=<span class="string">&quot;-Xms256m -Xmx256m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> java <span class="variable">$JAVA_OPTS</span> -Djava.security.edg=file:/dev/./urandom -jar application.jar</span></span><br></pre></td></tr></table></figure><blockquote><p>æ‰“åŒ…æ—¶éœ€è¦å°†dockerçš„2375ç«¯å£æš´éœ²å‡ºæ¥</p><p><code>Docker Desktop</code> -&gt; <code>Settings</code> -&gt; <code>General</code> -&gt; <code>Expose daemon on tcp://localhost:2375 without TLS</code></p></blockquote><p>åˆ›å»ºä¸€ä¸ª<code>docker</code>å¯åŠ¨å®¹å™¨çš„è„šæœ¬<code>docker-deploy.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">COMMAND=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">APP_NAME=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shellcheck disable=SC1069</span></span><br><span class="line"><span class="keyword">if</span>[ -z <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  APP_NAME=<span class="string">&quot;spring-boot-demo&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">EXPOSE_PORT=8080</span><br><span class="line"></span><br><span class="line">NAMESPACE=xiao-lin-unit</span><br><span class="line"></span><br><span class="line">TAG=1.0.0</span><br><span class="line"></span><br><span class="line">REGISTRY_SERVER=192.168.0.1:5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># shellcheck disable=SC2209</span></span><br><span class="line">USERNAME=admin</span><br><span class="line"></span><br><span class="line">PASSWORD=123456</span><br><span class="line"></span><br><span class="line">IMAGE_NAME=<span class="string">&quot;<span class="variable">$REGISTRY_SERVER</span>/<span class="variable">$NAMESPACE</span>/<span class="variable">$APP_NAME</span>:<span class="variable">$TAG</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: sh docker-deploy.sh [up|start|stop|restart|rm]&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">login</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;docker login -u <span class="variable">$USERNAME</span> --password-stdin <span class="variable">$REGISTRY_SERVER</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PASSWORD</span>&quot;</span> | docker login -u <span class="variable">$USERNAME</span> --password-stdin <span class="variable">$REGISTRY_SERVER</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># shellcheck disable=SC2120</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    CONTAINER_NAME=$(docker ps | grep <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;container <span class="variable">$CONTAINER_NAME</span> already started...&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    IMAGE=$(docker images | grep <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> | awk <span class="string">&quot;&#123;print <span class="variable">$3</span>&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$IMAGE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        login</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;starting container <span class="variable">$APP_NAME</span>...&quot;</span></span><br><span class="line">    docker run -d --restart=already --name <span class="variable">$APP_NAME</span> -p <span class="variable">$EXPOSE_PORT</span>:8080 <span class="variable">$IMAGE_NAME</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;container <span class="variable">$APP_NAME</span> started...&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">    CONTAINER_NAME=$(docker ps | grep <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;container <span class="variable">$CONTAINER_NAME</span> not running...&quot;</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;stopping container <span class="variable">$APP_NAME</span>...&quot;</span></span><br><span class="line">    docker stop <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;container <span class="variable">$APP_NAME</span> stopped...&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">    stop</span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rm</span></span>() &#123;</span><br><span class="line">    CONTAINER_NAME=$(docker ps | grep <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      stop</span><br><span class="line"></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;removing container <span class="variable">$APP_NAME</span>...&quot;</span></span><br><span class="line">      docker <span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$CONTAINER_NAME</span>&quot;</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;container <span class="variable">$APP_NAME</span> removed...&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    IMAGE=$(docker images | grepj <span class="string">&quot;<span class="variable">$APP_NAME</span>&quot;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$IMAGE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;removing image <span class="variable">$IMAGE</span>...&quot;</span></span><br><span class="line">        docker rmi <span class="string">&quot;<span class="variable">$IMAGE</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;image <span class="variable">$IMAGE</span> removed...&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">up</span></span>() &#123;</span><br><span class="line">    <span class="built_in">rm</span></span><br><span class="line">    start</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$COMMAND</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;up&quot;</span>)</span><br><span class="line">  up</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;start&quot;</span>)</span><br><span class="line">  start</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)</span><br><span class="line">  stop</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;restart&quot;</span>)</span><br><span class="line">  restart</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;rm&quot;</span>)</span><br><span class="line">  <span class="built_in">rm</span></span><br><span class="line">  ;;</span><br><span class="line">*)</span><br><span class="line">  usage</span><br><span class="line">  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><blockquote><p>åŸºäºä»¥ä¸Šå†…å®¹åï¼Œéƒ¨ç½²é¡¹ç›®åªéœ€è¦ä¸‰ä¸ªæ­¥éª¤</p><ol><li>é¡¹ç›®æ‰“åŒ…</li><li>æ¨é€åˆ°é•œåƒä»“åº“</li><li>ä½¿ç”¨éƒ¨ç½²è„šæœ¬é‡æ–°éƒ¨ç½²é¡¹ç›®</li></ol></blockquote></li></ol><p>æ¨è<code>IDEA</code>æ’ä»¶ï¼Œ<code>Alibaba Cloud Toolkit</code>ï¼Œæ­¤å·¥å…·åŒ…æ˜¯ä¸€ä¸ªè¿œç¨‹è¿æ¥çš„æ’ä»¶ï¼Œå¯ä»¥æ—¶é—´åœ¨<code>IDEA</code>ä¸­è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼Œä¸ä¿®æ”¹å’Œå½±å“å‰é¢çš„é¡¹ç›®éƒ¨ç½²é…ç½®å’Œè¿‡ç¨‹</p><ol><li><p>å®‰è£…</p><p>åœ¨<code>IDEA</code>ä¸­æ·»åŠ <code>Alibaba Cloud Toolkit</code>æ’ä»¶</p></li><li><p>æ·»åŠ <code>Host</code></p><blockquote><p>å¦‚æœè¿æ¥çš„æ˜¯<code>Windows</code>ç³»ç»Ÿï¼Œéœ€è¦ç¡®è®¤ç³»ç»Ÿæ˜¯å¦å®‰è£…äº†<code>OpenSSH</code></p><p>å®‰è£…æ–¹å¼ï¼Œä½¿ç”¨ç®¡ç†å‘˜è¿è¡Œ<code>PowerShell</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ç›¸å…³ç»„ä»¶</span></span><br><span class="line">Get-WindowsCapability -Online | Where-Object Name -like <span class="string">&#x27;OpenSSH*&#x27;</span></span><br><span class="line"><span class="comment"># å®‰è£…æœåŠ¡</span></span><br><span class="line">Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0</span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">Start-Service sshd</span><br><span class="line"><span class="comment"># è®¾ç½®å¯åŠ¨ç±»å‹</span></span><br><span class="line">Set-Service -Name sshd -StartupType Automatic</span><br></pre></td></tr></table></figure></blockquote></li></ol><h3 id="å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²"><a class="markdownIt-Anchor" href="#å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²"></a> å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²</h3><h4 id="å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"><a class="markdownIt-Anchor" href="#å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ"></a> å¾®æœåŠ¡é¡¹ç›®éƒ¨ç½²é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</h4><ol><li><p>æœåŠ¡+ä¸­é—´ä»¶çš„å¤æ‚åº¦é—®é¢˜</p><p>ä½¿ç”¨<code>docker-compose</code>çš„æœåŠ¡ç¼–æ’èƒ½åŠ›ï¼Œå®ç°å¤šæœåŠ¡çš„æ‰¹é‡åŒ–å¤„ç†</p></li><li><p>æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»</p><p>ä½¿ç”¨<code>docker-compose</code>çš„<code>depends_on</code>å±æ€§æ¥è®¾ç½®æœåŠ¡ä¾èµ–</p></li><li><p>æœåŠ¡ä¹‹é—´çš„ç½‘ç»œå…±äº«é—®é¢˜</p><p>åˆ©ç”¨è‡ªå®šä¹‰ç½‘ç»œæˆ–è€…<code>links</code>æ¥å®ç°ç½‘ç»œå…±äº«</p></li><li><p>æœ‰çŠ¶æ€æœåŠ¡çš„æ•°æ®æŒä¹…åŒ–é—®é¢˜</p><p>ä½¿ç”¨æ•°æ®å·è¿›è¡ŒæŒä¹…åŒ–çš„æ•°æ®ç®¡ç†</p></li></ol><h4 id="å¾®æœåŠ¡é¡¹ç›®dockeré•œåƒç»“æ„åŠé…ç½®"><a class="markdownIt-Anchor" href="#å¾®æœåŠ¡é¡¹ç›®dockeré•œåƒç»“æ„åŠé…ç½®"></a> å¾®æœåŠ¡é¡¹ç›®<code>docker</code>é•œåƒç»“æ„åŠé…ç½®</h4><p><img src="Docker%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.png" alt="Dockeré¡¹ç›®é…ç½®" /></p><p><code>docker-compose.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">starry-sky-mysql:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-mysql&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;mysql:8.5&quot;</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/logs:/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">command:</span> [</span><br><span class="line">      <span class="string">&#x27;mysqld&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--innodb-buffer-pool-size=80M&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--character-set-server=utf8mb4&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--collation-server=utf8mb4_unicode_ci&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;--default-time-zone=+8:00&#x27;</span></span><br><span class="line">      <span class="string">&#x27;--lower-case-table-names=1&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">&#x27;starry-sky&#x27;</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">  <span class="attr">starry-sky-redis:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-redis&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis/conf/redis.conf:/home/starry-sky/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis/data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/home/starry-sky/redis/redis.conf</span></span><br><span class="line">  <span class="attr">starry-sky-zookeeper:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-zookeeper&quot;</span></span><br><span class="line">  <span class="attr">starry-sky-web:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-web&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./web</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./web/html/dist:/home/projects/starry-sky/web</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./web/conf/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./web/logs:/var/log/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./web/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-gateway</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-gateway</span></span><br><span class="line">  <span class="attr">starry-sky-gateway:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-gateway&quot;</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./service/gateway</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-redis</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-redis</span></span><br><span class="line">  <span class="attr">starry-sky-core:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-core&quot;</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./service/core</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8081:8081&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-gateway</span></span><br><span class="line">  <span class="attr">starry-sky-life:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-life&quot;</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./service/life</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8082:8082&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-gateway</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-core</span></span><br><span class="line">  <span class="attr">starry-sky-ai:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">&quot;starry-sky-ai&quot;</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./service/ai</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">dockerfile</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8083:8083&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-gateway</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">starry-sky-core</span></span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š</p><ol><li>æ¯ä¸ªé¡¹ç›®çš„é…ç½®ä¸ä¸€æ ·ï¼Œ<code>docker-compose.yml</code>åº”è¯¥æ ¹æ®è‡ªå·±çš„é¡¹ç›®è¿›è¡Œè‡ªå®šä¹‰é…ç½®,å…·ä½“å¦‚ä½•é…ç½®å¯ä»¥æ ¹æ®<a href="https://docs.docker.com/reference/compose-file">å®˜æ–¹æ–‡æ¡£</a>æŸ¥çœ‹</li><li>æ¯ä¸ª<code>dockerfile</code>æ–‡ä»¶çš„å†…å®¹åº”åŸºäºé•œåƒæœ¬èº«å’Œé¡¹ç›®ç‰¹ç‚¹æ¥ä¿®æ”¹é…ç½®ï¼Œå¦‚<code>mysql</code>ã€<code>redis</code>å¯èƒ½éœ€è¦æŒä¹…åŒ–ç­–ç•¥ï¼Œéœ€è¦ç”¨åˆ°æ•°æ®å·ï¼›<code>zookeeper</code>åˆ™æ ¹æ®éœ€è¦ï¼Œå¦‚æœåªæ˜¯æœåŠ¡æ³¨å†Œè€Œä¸ä½œä¸ºé…ç½®ä¸­å¿ƒåˆ™ä¸éœ€è¦æ•°æ®å·</li></ol></blockquote><p><code>deploy.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Usage: sh deploy.sh [base|services|stop|rm]&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">base</span></span>() &#123;</span><br><span class="line">  docker-compose up -d starry-sky-mysql starry-sky-redis starry-sky-zookeeper</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">services</span></span>() &#123;</span><br><span class="line">  docker-compose up -d starry-sky-gateway starry-sky-core starry-sky-life starry-sky-ai</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">all</span></span>() &#123;</span><br><span class="line">  base</span><br><span class="line">  services</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">  docker-compose stop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rm</span></span>() &#123;</span><br><span class="line">  docker-compose <span class="built_in">rm</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;base&quot;</span>)</span><br><span class="line">  base</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;services&quot;</span>)</span><br><span class="line">  services</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;all&quot;</span>)</span><br><span class="line">  all</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)</span><br><span class="line">  stop</span><br><span class="line">  ;;</span><br><span class="line"><span class="string">&quot;rm&quot;</span>)</span><br><span class="line">  <span class="built_in">rm</span></span><br><span class="line">  ;;</span><br><span class="line">*)</span><br><span class="line">  usage</span><br><span class="line">  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p>åŸºäºä»¥ä¸Šï¼Œå¾®æœåŠ¡é¡¹ç›®çš„éƒ¨ç½²æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>é¡¹ç›®æ‰“åŒ…</li><li>å†…å®¹å¤åˆ¶ï¼Œåˆ©ç”¨<code>copy.sh</code>ï¼ˆæˆ–è€…åŸºäºé…ç½®æ‰‹åŠ¨å¤åˆ¶ï¼‰å°†ç›¸å…³å†…å®¹å¤åˆ¶åˆ°å¯¹åº”çš„ç›®å½•ä¸‹</li><li>ç›®å½•ä¸Šä¼ ï¼Œå°†æ•´ä¸ª<code>docker</code>ç›®å½•åŠå…¶å†…å®¹å¤åˆ¶åˆ°éƒ¨ç½²æœåŠ¡å™¨</li><li>é¡¹ç›®éƒ¨ç½²ï¼Œä½¿ç”¨<code>deploy.sh</code>ï¼ˆæˆ–è€…æ‰‹åŠ¨ï¼‰è¿›è¡Œå®¹å™¨ç¼–æ’æ–¹å¼çš„é¡¹ç›®éƒ¨ç½²</li></ol><blockquote><p><code>docker-compose</code>æ˜¯å•æœºçš„é¡¹ç›®éƒ¨ç½²æ–¹å¼</p><p>åˆ†å¸ƒå¼éƒ¨ç½²å¯ä»¥ä½¿ç”¨<code>swarm</code></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerç³»åˆ—(äºŒ)---è¿›é˜¶ä½¿ç”¨</title>
      <link href="/2025/08/07/docker/Docker%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/08/07/docker/Docker%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="æ•°æ®å·"><a class="markdownIt-Anchor" href="#æ•°æ®å·"></a> æ•°æ®å·</h3><p><code>Volume</code></p><h4 id="åŸºæœ¬æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#åŸºæœ¬æ¦‚å¿µ"></a> åŸºæœ¬æ¦‚å¿µ</h4><p>ç”±äºå®¹å™¨ä¼šå°†æ•°æ®è¿›è¡Œéš”ç¦»ï¼Œæ‰€ä»¥å®¹å™¨æ— æ³•è®¿é—®å¤–éƒ¨å†…å®¹ï¼Œå®¹å™¨å†…éƒ¨çš„å†…å®¹ä¹Ÿä¸æ˜“æ”¹å˜ï¼Œå¯¼è‡´å®¹å™¨å®é™…ç”¨é€”ä¸å¤§ã€‚æ¯”å¦‚ï¼Œé€šè¿‡<code>nginx</code>é•œåƒåˆ›å»ºçš„å®¹å™¨åªèƒ½è®¿é—®åˆ°<code>nginx</code>çš„<code>index.html</code>é¡µé¢ï¼Œå¦‚æœæƒ³è¦å°†è‡ªå·±çš„ç½‘ç«™éƒ¨ç½²åˆ°è¯¥å®¹å™¨ä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼</p><ol><li>å°†è‡ªå·±çš„ç½‘ç«™å†…å®¹æ·»åŠ åˆ°å®¹å™¨ä¸­</li><li>é‡‡ç”¨æ•°æ®å·çš„æ–¹å¼ï¼Œå°†å®¹å™¨ä¸å†…å®¹ç»‘å®š</li></ol><p>æ•°æ®å·å°±æ˜¯å®¹å™¨è®¿é—®å¤–éƒ¨æ•°æ®çš„é€šé“ï¼Œå®ç°æ•°æ®çš„éƒ¨åˆ†å…±äº«</p><h4 id="ç»‘å®šæ–¹å¼"><a class="markdownIt-Anchor" href="#ç»‘å®šæ–¹å¼"></a> ç»‘å®šæ–¹å¼</h4><ol><li><p>åŒ¿åç»‘å®š</p><ul><li>å¯åŠ¨å®¹å™¨æ—¶ç›´æ¥ä½¿ç”¨<code>-v container_dir</code>ç»‘å®š</li><li>åœ¨<code>Docker</code>çš„<code>volumes</code>ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªéšæœºç›®å½•ï¼ŒæŒ‡å®šçš„<code>/container_dir</code>ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å°†ä¿å­˜åœ¨è¯¥éšæœºç›®å½•ä¸­</li><li>åŒ¿åç»‘å®šçš„<code>volumes</code>åœ¨å®¹å™¨è¢«åˆ é™¤æ—¶ä¹Ÿä¼šè¢«åˆ é™¤</li><li>ä½¿ç”¨<code>docker inspect container_id</code>æŸ¥çœ‹<code>Mounts.Source</code>å†…å®¹æŸ¥æ‰¾æ•°æ®å·åœ¨ä¸»æœºä¸­çš„å“ªä¸ªä½ç½®</li></ul><blockquote><p><code>container_dir</code>æŒ‡çš„æ˜¯å®¹å™¨å†…çš„ç›®å½•</p></blockquote><p><img src="Docker%E6%B7%BB%E5%8A%A0%E5%8C%BF%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7.png" alt="Dockeræ·»åŠ åŒ¿åæ•°æ®å·" /></p><p><img src="Docker%E5%8C%BF%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7%E4%BF%A1%E6%81%AF.png" alt="DockeråŒ¿åæ•°æ®å·ä¿¡æ¯" /></p></li><li><p>å…·åç»‘å®š</p><ul><li>å¯åŠ¨å®¹å™¨æ—¶ç›´æ¥ä½¿ç”¨<code>-v host_dir_name:container_dir</code>ç»‘å®š</li><li>åœ¨<code>Docker</code>çš„<code>volumes</code>ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>host_dir_name</code>ç›®å½•ï¼ŒæŒ‡å®šçš„<code>/container_dir</code>ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å°†ä¿å­˜åœ¨è¯¥<code>host_dir_name</code>ç›®å½•ä¸­</li><li>å…·åç»‘å®šçš„<code>volumes</code>åœ¨å®¹å™¨è¢«åˆ é™¤æ—¶ä¸ä¼šè¢«åˆ é™¤</li><li>ä½¿ç”¨<code>docker inspect container_id</code>æŸ¥çœ‹<code>Mounts.Source</code>å†…å®¹æŸ¥æ‰¾æ•°æ®å·åœ¨ä¸»æœºä¸­çš„å“ªä¸ªä½ç½®</li></ul><p><img src="Docker%E6%B7%BB%E5%8A%A0%E5%85%B7%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7.png" alt="Dockeræ·»åŠ å…·åæ•°æ®å·" /></p><p><img src="Docker%E5%85%B7%E5%90%8D%E6%95%B0%E6%8D%AE%E5%8D%B7%E4%BF%A1%E6%81%AF.png" alt="Dockerå…·åæ•°æ®å·ä¿¡æ¯" /></p></li><li><p><code>Bind Mounts</code></p><ul><li><code>Bind Mounts</code>æ–¹å¼æ˜¯ç»‘å®šå¹¶åŠ è½½ä¸»æœºçš„æŸä¸ªæ–‡ä»¶ç›®å½•åˆ°å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯åƒå‰ä¸¤ç§æ–¹å¼å…±äº«å®¹å™¨ä¸­çš„ç›®å½•å†…å®¹</li><li><code>Bind Mounts</code>ç»‘å®šæ–¹å¼ä¸å…·åç»‘å®šç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å…·åç»‘å®šä½¿ç”¨çš„æ˜¯ç›®å½•åç§°(è‡ªå®šä¹‰çš„)ï¼Œ<code>Bind Mounts</code>ä½¿ç”¨çš„æ˜¯ç›®å½•çš„ç»å¯¹è·¯å¾„<code>-v /host_dir:container_dir</code></li></ul><p><img src="Docker%E6%B7%BB%E5%8A%A0Bind-Mounts%E6%95%B0%E6%8D%AE%E5%8D%B7.png" alt="Dockeræ·»åŠ Bind-Mountsæ•°æ®å·" /></p><p><img src="Docker-Bind-Mounts%E6%95%B0%E6%8D%AE%E5%8D%B7%E4%BF%A1%E6%81%AF.png" alt="Docker-Bind-Mountsæ•°æ®å·ä¿¡æ¯" /></p></li></ol><h4 id="æ•°æ®å·ç®¡ç†"><a class="markdownIt-Anchor" href="#æ•°æ®å·ç®¡ç†"></a> æ•°æ®å·ç®¡ç†</h4><p><code>docker volume</code>å‘½ä»¤ç®¡ç†æ•°æ®å·</p><h5 id="åˆ›å»º"><a class="markdownIt-Anchor" href="#åˆ›å»º"></a> åˆ›å»º</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹"></a> æŸ¥çœ‹</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume <span class="built_in">ls</span><span class="comment"># åˆ—è¡¨æŸ¥çœ‹</span></span><br><span class="line">docker volume inspect xxx <span class="comment"># æŸ¥çœ‹æŸä¸ªæ•°æ®å·çš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤"><a class="markdownIt-Anchor" href="#åˆ é™¤"></a> åˆ é™¤</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker volume <span class="built_in">rm</span> xxx <span class="comment"># åˆ é™¤æŒ‡å®šçš„æ•°æ®å·</span></span><br><span class="line">docker volume prune <span class="comment"># åˆ é™¤æœ¬åœ°æœªä½¿ç”¨çš„æ•°æ®å·</span></span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œ"><a class="markdownIt-Anchor" href="#ç½‘ç»œ"></a> ç½‘ç»œ</h3><p><code>Network</code></p><p>å®ç°éƒ¨åˆ†å®¹å™¨é—´çš„ç½‘ç»œå…±äº«ï¼Œç®¡ç†å¤šä¸ªå­ç½‘ä¸‹çš„å®¹å™¨<code>IP</code></p><h4 id="ç½‘ç»œæ¨¡å¼"><a class="markdownIt-Anchor" href="#ç½‘ç»œæ¨¡å¼"></a> ç½‘ç»œæ¨¡å¼</h4><h5 id="æ¡¥æ¥æ¨¡å¼"><a class="markdownIt-Anchor" href="#æ¡¥æ¥æ¨¡å¼"></a> æ¡¥æ¥æ¨¡å¼</h5><p><code>bridge</code>ï¼Œåœ¨ä¸»æœºä¸­åˆ›å»ºä¸€ä¸ª<code>Docker</code>ç½‘æ¡¥(<code>Docker0</code>)ï¼Œåœ¨<code>Docker0</code>ä¸Šåˆ›å»ºä¸€å¯¹è™šæ‹Ÿç½‘å¡ä¸€åŠåœ¨ä¸»æœº(<code>veth n</code>)ï¼Œä¸€åŠåœ¨å®¹å™¨å†…(<code>eth 0</code>)ï¼Œæ˜¯å®¹å™¨çš„é»˜è®¤ç½‘ç»œæ¨¡å¼</p><p><img src="Docker%E7%BD%91%E7%BB%9C%E6%A1%A5%E6%8E%A5%E6%A8%A1%E5%BC%8F.png" alt="Dockerç½‘ç»œæ¡¥æ¥æ¨¡å¼" /></p><h5 id="ä¸»æœºæ¨¡å¼"><a class="markdownIt-Anchor" href="#ä¸»æœºæ¨¡å¼"></a> ä¸»æœºæ¨¡å¼</h5><p><code>host</code>ï¼Œå®¹å™¨ä¸å†æœ‰è‡ªå·±çš„ç½‘ç»œç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥ä¸ä¸»æœºå…±äº«ç½‘ç»œç©ºé—´ï¼ŒåŸºäºæ­¤æ¨¡å¼åˆ›å»ºçš„å®¹å™¨çš„<code>IP</code>å®é™…å°±æ˜¯ä¸ä¸»æœºåŒä¸€ä¸ªå­ç½‘</p><h5 id="none"><a class="markdownIt-Anchor" href="#none"></a> <code>none</code></h5><p><code>Docker</code>ä¼šæœ‰è‡ªå·±çš„ç½‘ç»œç©ºé—´ï¼Œä¸ä¸ä¸»æœºå…±äº«ï¼Œåœ¨è¿™ä¸ªç½‘ç»œæ¨¡å¼ä¸‹çš„å®¹å™¨ä¸ä¼šè¢«åˆ†é…ç½‘å¡ï¼Œ<code>IP</code>ï¼Œè·¯ç”±ç­‰ç›¸å…³ä¿¡æ¯</p><h5 id="container"><a class="markdownIt-Anchor" href="#container"></a> <code>container</code></h5><p><code>container</code>æ˜¯åŸºäºå·²æœ‰å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ï¼Œä¸æŸä¸ªå·²æœ‰å®¹å™¨å…±äº«ç½‘ç»œ</p><h5 id="è‡ªå®šä¹‰"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰"></a> è‡ªå®šä¹‰</h5><p>ä½¿ç”¨<code>docker network</code>å‘½ä»¤ï¼ŒåŸºäºå‰ä¸‰ç§ç½‘ç»œæ¨¡å¼è‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼</p><ol><li><p>åˆ›å»º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create [opetion] &#123;name&#125;</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F.png" alt="Dockeråˆ›å»ºç½‘ç»œæ¨¡å¼" /></p><p>ä½¿ç”¨è‡ªå®šä¹‰çš„ç½‘ç»œåˆ›å»ºå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --<span class="built_in">rm</span> -p &#123;host_port&#125;:&#123;container_port&#125; --name &#123;contrainer_name&#125; --net &#123;custom_network_name&#125; &#123;image_name&#125;</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F%E8%BF%90%E8%A1%8C.png" alt="DockeråŸºäºè‡ªå®šä¹‰ç½‘ç»œæ¨¡å¼è¿è¡Œ" /></p><p>ç½‘ç»œå†…éƒ¨çš„å®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åç§°äº’é€š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping &#123;contrainer_name&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network <span class="built_in">rm</span> xxx <span class="comment">#åˆ é™¤æŒ‡å®šç½‘ç»œ</span></span><br><span class="line">docker network prune <span class="comment">#åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œ</span></span><br></pre></td></tr></table></figure></li><li><p>è¿æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æŸä¸ªå®¹å™¨è¿æ¥åˆ°æŸä¸ªç½‘è·¯æ¬§ä¸­</span></span><br><span class="line">docker network connect &#123;network&#125; &#123;container&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ–­å¼€è¿æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect &#123;network&#125; &#123;container&#125;</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker network <span class="built_in">ls</span> <span class="comment"># åˆ—è¡¨æŸ¥çœ‹</span></span><br><span class="line">docker network inspect xxx <span class="comment"># æŸ¥çœ‹æŸä¸ªç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="dockerfile"><a class="markdownIt-Anchor" href="#dockerfile"></a> <code>Dockerfile</code></h3><p>è‡ªå®šä¹‰æ„å»ºé•œåƒçš„é…ç½®æ–‡ä»¶ï¼Œæè¿°å¦‚ä½•æ„å»ºä¸€ä¸ªé•œåƒï¼Œåˆ©ç”¨<code>Docker</code>çš„<code>build</code>å‘½ä»¤ï¼ŒæŒ‡å®š<code>Dockerfile</code>ï¼Œå°±å¯ä»¥æŒ‰ç…§é…ç½®å°†é•œåƒæ„å»ºå‡ºæ¥</p><h4 id="å¸¸ç”¨æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#å¸¸ç”¨æŒ‡ä»¤"></a> å¸¸ç”¨æŒ‡ä»¤</h4><h5 id="from"><a class="markdownIt-Anchor" href="#from"></a> <code>FROM</code></h5><p>æŒ‡å®šå½“å‰é•œåƒçš„åŸºç¡€é•œåƒ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> &#123;image_name&#125;</span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">21</span></span><br></pre></td></tr></table></figure><h5 id="maintainer"><a class="markdownIt-Anchor" href="#maintainer"></a> <code>MAINTAINER</code></h5><p>æè¿°é•œåƒçš„ä½œè€…å’Œè”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MAINTAINER</span> &#123;author_name&#125;&lt;&#123;author_address&#125;&gt;</span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> xiaolin&lt;xiao_lin_unit@<span class="number">163</span>.com&gt;</span><br></pre></td></tr></table></figure><h5 id="label"><a class="markdownIt-Anchor" href="#label"></a> <code>LABEL</code></h5><p>ä¸ºé•œåƒè®¾ç½®æ ‡ç­¾ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªï¼ˆå¯é€‰ï¼‰</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> &#123;key&#125;=&#123;value&#125;</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&#x27;1.0.0&#x27;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&#x27;image description&#x27;</span></span></span><br></pre></td></tr></table></figure><h5 id="env"><a class="markdownIt-Anchor" href="#env"></a> <code>ENV</code></h5><p>ç¯å¢ƒå˜é‡é…ç½®ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ª</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENV</span> &#123;key&#125; &#123;value&#125; <span class="comment"># è®¾ç½®ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">ENV</span> &#123;key&#125;=&#123;value&#125; &#123;key&#125;=&#123;value&#125;... <span class="comment">#è®¾ç½®å¤šä¸ª</span></span><br></pre></td></tr></table></figure><h5 id="run"><a class="markdownIt-Anchor" href="#run"></a> <code>RUN</code></h5><p>åœ¨æ„å»ºé•œåƒæ—¶ï¼Œéœ€è¦æ‰§è¡Œçš„<code>shell</code>å‘½ä»¤ï¼Œé•¿é…åˆ<code>ADD</code>ä½¿ç”¨</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &#123;cmd&#125; <span class="comment"># åŸºäºshellå‘½ä»¤ï¼Œæ‰§è¡ŒæŸä¸ªå‘½ä»¤</span></span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ls</span> -al</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /example</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;&#123;path&#125;/&#123;name&#125;.sh&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>...] <span class="comment"># åŸºäºå¯æ‰§è¡Œæ–‡ä»¶</span></span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/var/lib/rancher/k3s/etc/containerd/k3s-agent-uninstall.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><h5 id="addæˆ–è€…copy"><a class="markdownIt-Anchor" href="#addæˆ–è€…copy"></a> <code>ADD</code>æˆ–è€…<code>COPY</code></h5><p>å°†ä¸»æœºä¸­çš„æŒ‡å®šæ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­çš„ç›®æ ‡ä½ç½®</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> &#123;host_file&#125; &#123;container_dir&#125;</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> [<span class="string">&quot;&#123;host_file&#125;&quot;</span>, <span class="string">&quot;&#123;container_dir&#125;&quot;</span>]</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> /etc/hosts /etc</span></span><br></pre></td></tr></table></figure><blockquote><p>ADDå’ŒCOPYçš„ä½¿ç”¨æ–¹å¼åŸºæœ¬ä¸€è‡´ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥æ›¿æ¢</p><p>åœ¨æ·»åŠ å‹ç¼©åŒ…æ—¶ä¸èƒ½æ›¿æ¢ï¼ŒADDä¼šå°†å‹ç¼©åŒ…è§£å‹ï¼Œä½†æ˜¯COPYåªæ˜¯åŸæ ·å¤åˆ¶</p></blockquote><h5 id="workdir"><a class="markdownIt-Anchor" href="#workdir"></a> <code>WORKDIR</code></h5><p>è®¾ç½®å®¹å™¨ä¸­çš„å·¥ä½œç›®å½•ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> &#123;list_path&#125;</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œå®Œåï¼Œåç»­æ“ä½œå°†åœ¨è¯¥ç›®å½•ä¸‹æ‰§è¡Œï¼ˆç±»ä¼¼äºcdåˆ°è¯¥ç›®å½•ä¸‹ï¼‰</span></span><br></pre></td></tr></table></figure><h5 id="volume"><a class="markdownIt-Anchor" href="#volume"></a> <code>VOLUME</code></h5><p>é•œåƒæ•°æ®å·ç»‘å®šï¼Œå°†ä¸»æœºä¸­çš„æŒ‡å®šç›®å½•æŒ‚åœ¨åˆ°å®¹å™¨ä¸­</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;&#123;host_dir_path&#125;&quot;</span>]</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> &#123;host_dir_path&#125;</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> &#123;host_dir_path&#125; &#123;host_dir_path&#125;</span></span><br><span class="line"><span class="comment"># é€šè¿‡è¿™ç§æ–¹å¼ç»‘å®šçš„ç›®å½•ï¼Œåœ¨ä¸»æœºç›®å½•å’Œç”±è¯¥é•œåƒåˆ›å»ºçš„å®¹å™¨ä¸­çš„ç›®å½•æ˜¯ä¸€ä¸€å¯¹åº”çš„</span></span><br><span class="line"><span class="comment"># å¦‚ ä¸»æœºä¸­æœ‰ä¸€ä¸ª /www/xiaolin ç›®å½•ï¼Œç»è¿‡ VOLUME [&quot;/www/xiaolin&quot;] ç»‘å®šåï¼Œåˆ›å»ºçš„å®¹å™¨ç”¨ä¹Ÿæœ‰ä¸€ä¸ª /www/xiaolin ç›®å½•ï¼Œè€Œä¸”ä¸ä¸»æœºç›®å½•æ˜¯Bind Mountsçš„ç»‘å®šæ–¹å¼</span></span><br></pre></td></tr></table></figure><h5 id="expose"><a class="markdownIt-Anchor" href="#expose"></a> <code>EXPOSE</code></h5><p>è®¾ç½®å®¹å™¨å¯åŠ¨åè¦å¯¹å®¹å™¨å¤–æš´éœ²çš„ç«¯å£</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> port</span><br><span class="line"><span class="comment"># ä»…ä»…æ˜¯æŒ‡å°†å®¹å™¨çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œå¹¶ä¸ä¸ä¸»æœºå»ºç«‹ç»‘å®šå…³ç³»</span></span><br></pre></td></tr></table></figure><h5 id="cmdæˆ–è€…entrypoint"><a class="markdownIt-Anchor" href="#cmdæˆ–è€…entrypoint"></a> <code>CMD</code>æˆ–è€…<code>ENTRYPOINT</code></h5><p>é€‰æ‹©å…¶ä¸­ä¸€ä¸ªå³å¯ï¼Œä½œç”¨æ˜¯æè¿°é•œåƒæ„å»ºå®Œæˆåï¼Œå¯åŠ¨å®¹å™¨æ—¶é»˜è®¤æ‰§è¡Œçš„è„šæœ¬æˆ–å‚æ•°ã€‚åªè®¾ç½®ä¸€æ¬¡ï¼Œå¦‚æœå†™äº†å¤šæ¬¡åˆ™åªæœ‰æœ€åä¸€æ¬¡ç”Ÿæ•ˆ</p><ol><li><p><code>CMD</code>:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;&#123;path&#125;/&#123;bash&#125;.sh&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> &#123;cmd&#125; &#123;param1&#125; &#123;param2&#125;</span></span><br><span class="line"><span class="comment"># ä¼šè¢«å®¹å™¨è¿è¡Œæ—¶æŒ‡å®šçš„å‘½ä»¤è¦†ç›–</span></span><br><span class="line"><span class="comment"># docker run xxx /bin/bash -&gt; å…¶ä¸­/bin/bashä¼šè¦†ç›–æ‰CMDæ‰§è¡Œçš„å†…å®¹ </span></span><br></pre></td></tr></table></figure></li><li><p><code>ENTRYPOINT</code>:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;&#123;path&#125;/&#123;bash&#125;.sh&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>]</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> &#123;cmd&#125; &#123;param1&#125; &#123;param2&#125;</span></span><br><span class="line"><span class="comment"># ä¸ä¼šè¢«å®¹å™¨è¿è¡Œæ—¶æŒ‡å®šçš„å‘½ä»¤è¦†ç›–</span></span><br><span class="line"><span class="comment"># docker run xxx /bin/bash -&gt; /bin/bashä¸ä¼šè¦†ç›–æ‰ENTRYPOINTæ‰§è¡Œçš„å†…å®¹ </span></span><br></pre></td></tr></table></figure></li></ol><blockquote><p>CMDçš„æ‰©å±•æ€§æ¯”ENTRYPOINTæ›´é«˜</p></blockquote><h5 id="æ‰©å±•æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#æ‰©å±•æŒ‡ä»¤"></a> æ‰©å±•æŒ‡ä»¤</h5><ol><li><p><code>ARG</code>: è®¾ç½®å˜é‡ï¼Œåœ¨é•œåƒä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œå½“ä½¿ç”¨<code>docker build</code>å‘½ä»¤æ„å»ºé•œåƒæ—¶ï¼Œå¸¦ä¸Š<code>--build-arg key=value</code>æ¥æŒ‡å®šå‚æ•°å€¼</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> &#123;var&#125;[=<span class="string">&quot;&#123;default_value&#125;&quot;</span>]</span><br><span class="line"><span class="comment"># ä½¿ç”¨æ—¶ç”¨ $&#123;var&#125; ä½¿ç”¨</span></span><br><span class="line"><span class="comment"># å¦‚</span></span><br><span class="line"><span class="keyword">ARG</span> centos=latest</span><br><span class="line"><span class="keyword">FROM</span> centos:$contos</span><br></pre></td></tr></table></figure></li><li><p><code>USER</code>: è®¾ç½®å®¹å™¨çš„ç”¨æˆ·ï¼Œå¯ä»¥æ˜¯ç”¨æˆ·åæˆ–<code>PID</code>ï¼Œå¦‚æœå®¹å™¨è®¾ç½®äº†ä»¥<code>daemon</code>ç”¨æˆ·å»è¿è¡Œï¼Œé‚£ä¹ˆ<code>RUN</code>ã€<code>CMD</code>å’Œ<code>ENTRYPOINT</code>éƒ½ä¼šä»¥è¿™ä¸ªç”¨æˆ·å»è¿è¡Œï¼Œä¸€å®šè¦å…ˆç¡®å®šå®¹å™¨ä¸­æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”æœ‰å¯¹åº”çš„æ“ä½œæƒé™</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USER</span> &#123;username&#125;</span><br><span class="line"><span class="keyword">USER</span> &#123;PID&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>ONBUILD</code>: å¯¹æ„å»ºå½“å‰é•œåƒæ²¡æœ‰å½±å“ï¼Œåœ¨å…¶ä»–é•œåƒçš„åŸºç¡€é•œåƒä¸ºå½“å‰é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œ<code>ONBUILD</code>æŒ‡å®šçš„æ“ä½œ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ls</span> -al <span class="comment"># å¦‚æ­¤é•œåƒä¸º image01</span></span></span><br><span class="line"><span class="comment"># ä¸Šè¿°å†…å®¹åœ¨æ„å»ºå½“å‰é•œåƒæ—¶æ²¡æœ‰å½±å“</span></span><br><span class="line"><span class="comment"># å½“æ„å»ºå…¶ä»–é•œåƒï¼Œå…¶åŸºç¡€é•œåƒä¸ºå½“å‰é•œåƒæ—¶ï¼ˆFROM image01ï¼‰ï¼Œä¼šæ‰§è¡ŒRUN ls -alæ“ä½œ</span></span><br></pre></td></tr></table></figure></li><li><p><code>STOPSIGNAL</code>: å®¹å™¨åœæ­¢æ—¶å‘é€çš„ä¿¡å·</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">STOPSIGNAL</span> &#123;signal&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>HEALTHCHECK</code>: åœ¨å®¹å™¨å†…éƒ¨æŒ‰ç…§æŒ‡å®šå‘¨æœŸè¿è¡ŒæŒ‡å®šå‘½ä»¤æ¥æ£€æµ‹å®¹å™¨å¥åº·çŠ¶å†µï¼›å–æ¶ˆåœ¨åŸºç¡€é•œåƒ</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> [opetion] CMD &#123;cmd&#125;</span></span><br><span class="line"><span class="comment"># option</span></span><br><span class="line"><span class="comment"># interval</span></span><br><span class="line"><span class="comment"># timeout</span></span><br><span class="line"><span class="comment"># retries</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="æ„å»ºé•œåƒ"><a class="markdownIt-Anchor" href="#æ„å»ºé•œåƒ"></a> æ„å»ºé•œåƒ</h4><h5 id="commit"><a class="markdownIt-Anchor" href="#commit"></a> <code>commit</code></h5><p>åŸºäºä¸€ä¸ªç°æœ‰çš„å®¹å™¨ï¼Œæ„å»ºä¸€ä¸ªæ–°çš„é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker commit [option] &#123;container&#125; [repository[:tag]</span><br><span class="line">docker commit -a <span class="string">&quot;xiao-lin&quot;</span> -m <span class="string">&quot;build a image with a container&quot;</span> &#123;container_name&#125; &#123;image_name:version&#125;</span><br></pre></td></tr></table></figure><h5 id="build"><a class="markdownIt-Anchor" href="#build"></a> <code>build</code></h5><ol><li><p><code>spring-boot</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build å‘½ä»¤</span></span><br><span class="line">docker build [option] &#123;path&#125;</span><br><span class="line"><span class="comment"># pathæŒ‡å‘å«æœ‰Dockerfileæ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line"><span class="comment"># option</span></span><br><span class="line"><span class="comment"># -t æŒ‡å®štag</span></span><br><span class="line">docker build -t spring-boot-docker:1.0.0 .</span><br><span class="line"><span class="comment"># -t æŒ‡å®šé•œåƒåç§°å’Œç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># pathä¸º . ,å³å½“å‰ç›®å½•</span></span><br></pre></td></tr></table></figure><p><img src="Docker%E4%BD%BF%E7%94%A8Dockerfile%E6%9E%84%E5%BB%BASpringBoot%E9%95%9C%E5%83%8F.png" alt="Dockerä½¿ç”¨Dockerfileæ„å»ºSpringBooté•œåƒ" /></p></li><li><p><code>nginx</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> CENTOS_VERSION=<span class="string">&quot;7&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> centos:$CENTOS_VERSION</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»´æŠ¤è€…ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> xiaolin&lt;xiao_lin_unit@<span class="number">163</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å·¥å…·</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum clean all</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum makecache</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y gcc</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y gcc-c++</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y make</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y openssl-devel</span></span><br><span class="line"><span class="comment"># åˆ›å»º wwwç”¨æˆ·ä½œä¸ºnginxå¯åŠ¨ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># RUN useradd -s /sbin/nologin -M www</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local/src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget http://nginx.org/download/nginx-1.22.1.tar.gz</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar -zxvf nginx-1.22.1.tar.gz</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local/src/nginx-1.22.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginxç¼–è¯‘å®‰è£…</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­nginxåå°è¿è¡Œ</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;daemon off;&#x27;</span> &gt;&gt; /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º nginx å‘½ä»¤å¿«é€Ÿè®¿é—®çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=/usr/local/nginx/sbin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>]</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="ä»“åº“"><a class="markdownIt-Anchor" href="#ä»“åº“"></a> ä»“åº“</h3><p><code>regitry</code></p><h4 id="é˜¿é‡Œäº‘"><a class="markdownIt-Anchor" href="#é˜¿é‡Œäº‘"></a> é˜¿é‡Œäº‘</h4><ol><li><p>åˆ›å»ºä»“åº“ï¼šå®¹å™¨é•œåƒæœåŠ¡ -&gt; å®ä¾‹åˆ—è¡¨ -&gt; ä¸ªäºº/ä¼ä¸š -&gt; å‘½åç©ºé—´ï¼ˆåˆ›å»ºå‘½åç©ºé—´ï¼‰-&gt; é•œåƒä»“åº“ï¼ˆåˆ›å»ºé•œåƒä»“åº“ï¼Œè‡ªå·±ä½¿ç”¨çš„ä»“åº“é€‰æ‹©æœ¬åœ°ä»“åº“å³å¯ï¼‰</p><blockquote><p>åˆ›å»ºçš„æ¯ä¸€ä¸ªä»“åº“éƒ½æ˜¯ä¸€ä¸ªé•œåƒçš„ç‰ˆæœ¬åº“ï¼Œä¸åŒåç§°çš„é•œåƒåˆ›å»ºä¸åŒåç§°çš„ä»“åº“</p><p>å¦‚ï¼Œä½ çš„<code>nginx</code>é•œåƒå°±åˆ›å»º<code>nginx</code>ä»“åº“ï¼Œä½ çš„<code>redis</code>é•œåƒå°±åˆ›å»º<code>redis</code>ä»“åº“</p></blockquote></li><li><p>ç™»å½•ä»“åº“ï¼šæ ¹æ®ä»“åº“çš„åŸºæœ¬ä¿¡æ¯ä¸­çš„ä»“åº“ç™»å½•æ–¹å¼ï¼Œç™»å½•ä»“åº“å¹¶è¾“å…¥å¯†ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login --username=&#123;usernmae&#125; &#123;registy_sign&#125;.cn-qingdao.personal.cr.aliyuncs.com</span><br></pre></td></tr></table></figure></li><li><p>æ¨é€ä»“åº“ï¼šåˆ†ä¸ºæ‰“æ ‡ç­¾å’Œæ¨é€ä¸¤æ­¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“æ ‡ç­¾</span></span><br><span class="line">docker tag &#123;image_id&#125; &#123;registy_sign&#125;.cn-qingdao.personal.cr.aliyuncs.com/xiao_lin_unit/nginx:&#123;version&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¨é€ï¼Œpushçš„å†…å®¹ä¸å‰é¢æ‰“æ ‡ç­¾çš„å†…å®¹è¦ä¸€è‡´</span></span><br><span class="line">docker push &#123;registy_sign&#125;.cn-qingdao.personal.cr.aliyuncs.com/xiao_lin_unit/nginx:&#123;version&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="nexus"><a class="markdownIt-Anchor" href="#nexus"></a> <code>Nexus</code></h4><ol><li><p>ä¸»æœºåšä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®‰è£…jdk8</span></span><br><span class="line"><span class="built_in">sudo</span> apt install openjdk-8-jdk</span><br><span class="line"><span class="comment"># 2. ä¸Šä¼ nexusåŒ…</span></span><br><span class="line"><span class="comment"># 3. è§£å‹ç¼©nexusåŒ…</span></span><br><span class="line">tar -zxvf nexus.tar.gz</span><br><span class="line"><span class="comment"># ä¿®æ”¹ç›¸å…³é…ç½®åå¯åŠ¨</span></span><br><span class="line">java -jar nexus.jar</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨<code>docker</code>é•œåƒåˆ›å»ºå®¹å™¨ï¼Œç»‘å®šç›¸å…³ç«¯å£å’Œæ•°æ®å·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /opt/nexus</span><br><span class="line"><span class="built_in">chmod</span> 755 /opt/nexus</span><br><span class="line">docker run -d --restart=always -p 8868:8081 -p 5000:5000 -p 5001:5001 --name nexus -v /opt/nexus:/nexus-data sonatype/nexus3</span><br><span class="line"><span class="comment"># æˆ‘ä½¿ç”¨æ—¶é•œåƒåˆ›å»ºçš„å®¹å™¨å†…å¯åŠ¨jaråŒ…æ—¶æŠ¥é”™ï¼Œæ— å¦¨è®¿é—®</span></span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">3. ç™»å½•`nexus manager`ï¼Œæ³¨æ„è®¿é—®åœ°å€å’Œç«¯å£</span><br><span class="line"></span><br><span class="line">4. åˆ›å»ºä¸€ä¸ªå­˜å‚¨å™¨`Blob Stores`</span><br><span class="line"></span><br><span class="line">5. åˆ›å»ºä»“åº“`Repositories`é€‰æ‹©`docker`ç±»å‹çš„ä»“åº“ï¼Œæ·»åŠ ä¿¡æ¯å¹¶åˆ›å»º</span><br><span class="line"></span><br><span class="line">6. å°†ç§æœä»“åº“æ·»åŠ åˆ°`docker`çš„é•œåƒæº</span><br><span class="line"></span><br><span class="line">   ```bash</span><br><span class="line">   vi /etc/docker/daemon.json</span><br><span class="line">   </span><br><span class="line">   # ä¿®æ”¹å†…å®¹</span><br><span class="line">   &#123;</span><br><span class="line">     &quot;insecure-registries&quot;: [&quot;ip:5000&quot;, &quot;ip:5001&quot;]</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   systemctl daemon-reload</span><br><span class="line">   systemctl restart docker</span><br><span class="line">   # ä½¿ç”¨dockeræ–¹å¼éƒ¨ç½²nexusåˆ™éœ€è¦é‡æ–°å¯åŠ¨å®¹å™¨</span><br></pre></td></tr></table></figure><h4 id="harbor"><a class="markdownIt-Anchor" href="#harbor"></a> <code>Harbor</code></h4><p><code>docker</code>ä¸“ç”¨ï¼Œå¿…é¡»å®‰è£…<code>docker</code>å’Œ<code>docker-compose</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y docker-compose</span><br></pre></td></tr></table></figure><p>ä¸‹è½½<code>Harbor</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.11.1/harbor-offline-installer-v2.11.1.tgz</span><br><span class="line">tar -zxvf harbor-offline-installer-v2.11.1.tgz</span><br><span class="line"><span class="built_in">cd</span> harbor</span><br><span class="line"><span class="built_in">cp</span> harbor.yml.tmpl harbor.yml</span><br><span class="line">vi harbor.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">hostname: IP <span class="comment"># ä¸è¦ç”¨localhostå’Œ127.0.0.1</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†ç </span></span><br><span class="line">harbor_admin_password: 123456</span><br><span class="line"><span class="comment"># æ³¨é‡Šæ‰ssléƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å®Œåå®‰è£…</span></span><br><span class="line">bash prepare</span><br><span class="line">bash install.sh --with-trivy</span><br></pre></td></tr></table></figure><p>ç™»å½•ç³»ç»Ÿ -&gt; åˆ›å»ºé¡¹ç›®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å†…å®¹</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;ip:port&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># ä½¿ç”¨dockeræ–¹å¼éƒ¨ç½²nexusåˆ™éœ€è¦é‡æ–°å¯åŠ¨å®¹å™¨</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç™»å½•</span></span><br><span class="line">docker login -u&#123;username&#125; ip:port</span><br><span class="line"></span><br><span class="line">docker tag &#123;image_id&#125; ip:port/&#123;project_name&#125;/&#123;image_name&#125;[:&#123;version&#125;]</span><br><span class="line"></span><br><span class="line">docker push ip:port/&#123;project_name&#125;/&#123;image_name&#125;[:&#123;version&#125;]</span><br></pre></td></tr></table></figure><h3 id="å®¹å™¨ç¼–æ’"><a class="markdownIt-Anchor" href="#å®¹å™¨ç¼–æ’"></a> å®¹å™¨ç¼–æ’</h3><p>é’ˆå¯¹å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</p><p>ä¾èµ–ç®¡ç†ï¼Œå‰¯æœ¬æ•°æ§åˆ¶ï¼Œé…ç½®å…±äº«</p><h4 id="docker-compose"><a class="markdownIt-Anchor" href="#docker-compose"></a> <code>Docker Compose</code></h4><p>å•æœºç¯å¢ƒçš„å®¹å™¨ç¼–æ’</p><p>å…³é”®ï¼š<code>docker-compose.yml</code>é…ç½®æ–‡ä»¶</p><h5 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç‰ˆæœ¬è¦è·Ÿdockerå¯¹åº”</span></span><br><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;http://mirrors.aliyun.com/docker-toolbox/linux/1.21.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># èµ‹äºˆå¯æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è½¯é“¾æ¥</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h5><p>åˆ›å»ºä¸€ä¸ªç›®å½•ä½œä¸ºä¸€ä¸ªé¡¹ç›®çš„<code>docker-compose</code>å·¥ä½œç©ºé—´ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»º<code>docker-compose.yml</code>æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -r /opt/docker/nginx</span><br><span class="line"><span class="built_in">cd</span> /opt/docker/nginx</span><br><span class="line"><span class="built_in">touch</span> docker-compose.yml</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ™®é€šé•œåƒè€Œè¨€ï¼Œæœ€é‡è¦çš„ä¸‰ä¸ªé…ç½®æ˜¯ servicesï¼Œnetworksï¼Œvolumes</span></span><br><span class="line">vi docker-compose.yml</span><br></pre></td></tr></table></figure><blockquote><p><code>docker-compose.yml</code>çš„é…ç½®å¯ä»¥é€šè¿‡<a href="https://docs.docker.com/reference/compose-file">å®˜æ–¹æ–‡æ¡£</a>æŸ¥çœ‹</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.1&quot;</span> <span class="comment"># éµå¾ªçš„docker-composeçš„apiç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="comment"># mynginxé…ç½®</span></span><br><span class="line">  <span class="attr">mynginx:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># æŒ‡å®šé•œåƒ</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;always&quot;</span> <span class="comment"># é‡å¯ç­–ç•¥</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">xiao_lin_n</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">xiao_lin_v:/var/lib/data</span></span><br><span class="line">    <span class="attr">envrionment:</span> </span><br><span class="line">      <span class="attr">APP_ENV:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">dns:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">centos</span> <span class="comment"># ä¾èµ–äºcentosæœåŠ¡ï¼Œç­‰centosæœåŠ¡å¯åŠ¨æ‰èƒ½è¿è¡Œ</span></span><br><span class="line">  <span class="attr">centos:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">  <span class="attr">myservice:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;java&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">xiao_lin_n</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">xiao_lin_v:/etc/data</span></span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span> <span class="comment"># è¡¨ç¤ºå®¹å™¨æš´éœ²çš„ç«¯å£ï¼Œä¸ä¸»æœºä¸è¿›è¡Œå›ºå®šç»‘å®š</span></span><br><span class="line">  <span class="attr">redis:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">db:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;mysql:8.1&quot;</span></span><br><span class="line">      </span><br><span class="line"><span class="attr">networks:</span> </span><br><span class="line">  <span class="attr">xiao_lin_n:</span> </span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span> </span><br><span class="line">      <span class="attr">driver:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">config:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet0:</span> <span class="number">192.173</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">          <span class="attr">gateway:</span> <span class="number">192.173</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet1:</span> <span class="number">192.174</span><span class="number">.00</span><span class="string">/24</span></span><br><span class="line">          <span class="attr">gateway:</span> <span class="number">192.174</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> </span><br><span class="line">  <span class="attr">xiao_lin_v:</span> <span class="comment"># é€šè¿‡æ•°æ®å·å®šä¹‰ï¼Œå°†ä¸Šè¿°ä¸¤ä¸ªæœåŠ¡çš„ /var/lib/data å’Œ /etc/data ç›®å½•æŒ‚è½½</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker-compose config <span class="comment"># æŸ¥çœ‹é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é”™è¯¯</span></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡</span></span><br><span class="line">docker-compose create [&#123;service_name&#125;]</span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡</span></span><br><span class="line">docker-compose up [-d &#123;service_name&#125;]</span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">docker-compose start [&#123;service_name&#125;]</span><br><span class="line"><span class="comment"># åœæ­¢æœåŠ¡</span></span><br><span class="line">docker-compose stop</span><br><span class="line"><span class="comment"># åœæ­¢å¹¶åˆ é™¤æœåŠ¡</span></span><br><span class="line">docker-compose <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼¹æ€§æ‰©å®¹ç¼©å®¹</span></span><br><span class="line">docker-compose scale &#123;service_name&#125;=num</span><br></pre></td></tr></table></figure><h4 id="swarm"><a class="markdownIt-Anchor" href="#swarm"></a> <code>Swarm</code></h4><p>åˆ†å¸ƒå¼ç¯å¢ƒçš„å®¹å™¨ç¼–æ’</p><p>å¤šå°ç‰©ç†æœºï¼Œåœ¨<code>master</code>ç‰©ç†æœºä¸Šæ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br></pre></td></tr></table></figure><p><img src="Docker%E4%BD%BF%E7%94%A8Swarm%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt="" /></p><p>åœ¨<code>node</code>ç‰©ç†æœºä¸Šæ‰§è¡Œä¸Šè¿°çº¢è‰²æ ‡è®°çš„å‘½ä»¤ï¼Œå°†è¯¥ç‰©ç†æœºä½œä¸ºä¸€ä¸ª<code>node</code></p><p>ä¹‹åçš„ç›¸å…³å†…å®¹åœ¨<code>master</code>èŠ‚ç‚¹ä¸Šæ‰§è¡Œå³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å®¹å™¨</span></span><br><span class="line"><span class="comment"># option</span></span><br><span class="line"><span class="comment"># replicas: åˆ›å»ºæ•°é‡</span></span><br><span class="line">docker service create [option] &#123;image&#125;</span><br><span class="line">docker service create --replicas 1 -p 8080:80 --name nginx_swarm nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡ä¿¡æ¯</span></span><br><span class="line">docker service inspect --pretty &#123;service_name&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ•°é‡</span></span><br><span class="line">docker service update --replicas &#123;num&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nodeèŠ‚ç‚¹é€€å‡ºé›†ç¾¤</span></span><br><span class="line">docker swarm leave</span><br></pre></td></tr></table></figure><h3 id="å¯è§†åŒ–"><a class="markdownIt-Anchor" href="#å¯è§†åŒ–"></a> å¯è§†åŒ–</h3><p><code>portainer</code></p><p>ä½¿ç”¨<code>portainer</code>é•œåƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºäºswarm</span></span><br><span class="line">docker service create --replicas 1 -p 9000:9000 --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/var/run/docker.sock,dst=/var/run/docker.sock --mount <span class="built_in">type</span>=volume,src=portainer_data,dst=/data portainer/portainer</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼Œåˆæ¬¡è®¿é—®æ—¶é»˜è®¤ä¸º<code>admin</code>ç”¨æˆ·ï¼Œä¸ºå…¶è®¾ç½®å¯†ç </p><ol><li><p>åˆ›å»ºç¯å¢ƒ</p></li><li><p>åŸºäºç¯å¢ƒè¿›è¡Œ<code>docker</code>ç®¡ç†</p><p><img src="Docker%E7%8E%AF%E5%A2%83%E5%8F%AF%E8%A7%86%E5%8C%96%E7%AE%A1%E7%90%86.png" alt="Dockerç¯å¢ƒå¯è§†åŒ–ç®¡ç†" /></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerç³»åˆ—(ä¸€)---å®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨</title>
      <link href="/2025/08/05/docker/Docker%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/08/05/docker/Docker%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>Docker</code>ä½œä¸ºå®¹å™¨çš„å…ˆè¡Œè€…ï¼Œå½“å‰çƒ­åº¦è™½ç„¶ä¸‹é™ï¼Œä½†æ˜¯ä¾ç„¶æ˜¯å­¦ä¹ å’Œä½¿ç”¨çš„å¥½é€‰æ‹©ã€‚</p><p>æœ¬ç³»åˆ—å¸Œæœ›è¾¾æˆçš„ç›®æ ‡æœ‰ä¸‰ä¸ªï¼š1. å­¦ä¼šå®‰è£…å’ŒåŸºæœ¬ä½¿ç”¨ï¼›2. å­¦ä¼šè¿›é˜¶å†…å®¹ï¼›3. èƒ½è‡ªå·±é€šè¿‡<code>Docker</code>è¿›è¡Œé¡¹ç›®éƒ¨ç½²</p><h3 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h3><h4 id="ubuntu"><a class="markdownIt-Anchor" href="#ubuntu"></a> <code>Ubuntu</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€äº›æ“ä½œéœ€è¦rootæƒé™ï¼Œå¦‚æœè§‰å¾—éº»çƒ¦å¯ä»¥åˆ°rootç”¨æˆ·ä¸‹æ“ä½œ</span></span><br><span class="line"><span class="comment"># å¦‚æœæºä¸­æ²¡æœ‰è¯¥åº”ç”¨æˆ–è€…ä¸‹è½½è¿‡æ…¢ï¼Œéœ€è¦æ›´æ¢æº</span></span><br><span class="line"><span class="comment"># å»ºè®®å…ˆæ›´æ–°è½¯ä»¶åº“</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt upgrade</span><br><span class="line"><span class="comment"># å®‰è£…è¿‡ç¨‹ä¸­å¦‚æœç¼ºå°‘ç³»ç»Ÿå·¥å…·éœ€å…ˆå®‰è£…ç³»ç»Ÿå·¥å…·</span></span><br><span class="line"><span class="built_in">sudo</span> apt -y install docker-ce</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼šæœ¬æ¬¡å†…å®¹åŸºäº<code>multipass</code>è™šæ‹Ÿæœºçš„<code>Ubuntu</code>ç³»ç»Ÿ</p></blockquote><h4 id="centos"><a class="markdownIt-Anchor" href="#centos"></a> <code>CentOS</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€äº›æ“ä½œéœ€è¦rootæƒé™ï¼Œå¦‚æœè§‰å¾—éº»çƒ¦å¯ä»¥åˆ°rootç”¨æˆ·ä¸‹æ“ä½œ</span></span><br><span class="line"><span class="comment"># å¦‚æœæºä¸­æ²¡æœ‰è¯¥åº”ç”¨æˆ–è€…ä¸‹è½½è¿‡æ…¢ï¼Œéœ€è¦æ›´æ¢æº</span></span><br><span class="line"><span class="comment"># å»ºè®®å…ˆæ›´æ–°è½¯ä»¶åº“</span></span><br><span class="line"><span class="comment"># å®‰è£…è¿‡ç¨‹ä¸­å¦‚æœç¼ºå°‘ç³»ç»Ÿå·¥å…·éœ€å…ˆå®‰è£…ç³»ç»Ÿå·¥å…·</span></span><br><span class="line"><span class="built_in">sudo</span> yum -y install docker-ce</span><br></pre></td></tr></table></figure><h4 id="éªŒè¯"><a class="markdownIt-Anchor" href="#éªŒè¯"></a> éªŒè¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%AE%89%E8%A3%85%E9%AA%8C%E8%AF%81.png" alt="Dockerå®‰è£…éªŒè¯" /></p><h4 id="ä¿®æ”¹æº"><a class="markdownIt-Anchor" href="#ä¿®æ”¹æº"></a> ä¿®æ”¹æº</h4><p>åˆ›å»ºå¹¶ç¼–è¾‘ <code>/etc/docker/daemon.json</code>æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://hub.rat.dev&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockerhub.icu&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://mirror.azure.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockerpull.org&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockerproxy.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dhub.kubesre.xyz&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.chenby.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.nju.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.unsee.tech&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.1panel.live&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.rainbond.cc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.awsl9527.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.iscas.ac.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.jsdelivr.fyi&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.anyhub.us.kg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.baidubce.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.hpcloud.cloud&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.registry.cyou&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockercf.jsdelivr.fyi&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker-cf.registry.cyou&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://dockertest.jsdelivr.fyi&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://zermyrir.mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="Docker%E4%BF%AE%E6%94%B9%E4%BB%93%E5%BA%93%E6%BA%90.png" alt="Dockerä¿®æ”¹ä»“åº“æº" /></p><blockquote><ol><li>å›½å†…çš„ä»“åº“æºå¤§éƒ¨åˆ†(é˜¿é‡Œï¼Œè…¾è®¯ï¼Œç½‘æ˜“ï¼Œæ ¡å›­é•œåƒ)éƒ½å¤±æ•ˆäº†ï¼Œæˆ‘å°†æ‰¾åˆ°çš„ä¸€ä¸ªå¯ç”¨çš„è—åˆ°äº†é‡Œé¢ğŸ˜</li><li>ä½¿ç”¨<code>docker search</code>å‘½ä»¤ç»“æœå¯èƒ½å‡ºç°<code>ERROR</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>docker pull hello-world</code>å‘½ä»¤æ‹‰å–ä¸€ä¸ªç®€å•é•œåƒå°è¯•ï¼Œå¯ä»¥æ‹‰å–æˆåŠŸå³å¯</li></ol></blockquote><h4 id="é‡æ–°è¿è¡Œ"><a class="markdownIt-Anchor" href="#é‡æ–°è¿è¡Œ"></a> é‡æ–°è¿è¡Œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">service docker restart</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntuç³»ç»Ÿä¸‹è½½å®Œæˆåä¼šé»˜è®¤å¯åŠ¨ï¼Œå¦‚æœè¦é‡æ–°å¯åŠ¨å¯ä»¥ä½¿ç”¨ service å‘½ä»¤</span></span><br><span class="line"><span class="comment"># å¯åŠ¨</span></span><br><span class="line"><span class="built_in">sudo</span> service docker start</span><br><span class="line"><span class="comment"># å…³é—­</span></span><br><span class="line"><span class="built_in">sudo</span> service docker stop</span><br><span class="line"><span class="comment"># é‡å¯</span></span><br><span class="line"><span class="built_in">sudo</span> service docker restart</span><br><span class="line"><span class="comment"># çŠ¶æ€</span></span><br><span class="line"><span class="built_in">sudo</span> service docker status</span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬ä½¿ç”¨"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä½¿ç”¨"></a> åŸºæœ¬ä½¿ç”¨</h3><h4 id="é•œåƒ"><a class="markdownIt-Anchor" href="#é•œåƒ"></a> é•œåƒ</h4><h5 id="æŸ¥æ‰¾é•œåƒ"><a class="markdownIt-Anchor" href="#æŸ¥æ‰¾é•œåƒ"></a> æŸ¥æ‰¾é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search xxx</span><br></pre></td></tr></table></figure><p>ä»<code>Docker Hub</code>æŸ¥æ‰¾</p><h5 id="æ‹‰å–é•œåƒ"><a class="markdownIt-Anchor" href="#æ‹‰å–é•œåƒ"></a> æ‹‰å–é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull xxx[:version]</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤é•œåƒ"><a class="markdownIt-Anchor" href="#åˆ é™¤é•œåƒ"></a> åˆ é™¤é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi IMAGE_ID<span class="comment"># æ³¨æ„æ˜¯rmiï¼Œrmæ˜¯åˆ é™¤å®¹å™¨</span></span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹æœ¬åœ°é•œåƒ"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹æœ¬åœ°é•œåƒ"></a> æŸ¥çœ‹æœ¬åœ°é•œåƒ</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><h4 id="å®¹å™¨"><a class="markdownIt-Anchor" href="#å®¹å™¨"></a> å®¹å™¨</h4><h5 id="åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨"><a class="markdownIt-Anchor" href="#åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨"></a> åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run [option] xxx</span><br><span class="line"><span class="comment"># oprion</span></span><br><span class="line"><span class="comment"># -p machine_prot:container_portï¼šå¦‚ -p 8080:80 è¡¨ç¤ºå°†ä¸»æœºçš„8080ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„80ç«¯å£</span></span><br><span class="line"><span class="comment"># -dï¼šåå°è¿è¡Œï¼Œä¸æ·»åŠ æ—¶ä¸ºå‰ç«¯è¿è¡Œï¼Œä¼šå ç”¨å½“å‰çš„å‘½ä»¤è¡Œçª—å£</span></span><br><span class="line"><span class="comment"># --nameï¼šæŒ‡å®šåç§°ï¼Œå¦‚ --name nginx01 </span></span><br><span class="line"><span class="comment"># --rmï¼šé€€å‡ºæ—¶åˆ é™¤ï¼Œæ— å‚ï¼Œå¦‚ --rm</span></span><br><span class="line"><span class="comment"># --restartï¼šnoé»˜è®¤ï¼Œä¸é‡å¯ï¼›on-failure:nå¤±è´¥æ—¶é‡å¯ï¼Œå°è¯•næ¬¡ï¼›alwaysæ€»æ˜¯é‡å¯ï¼Œå¦‚ --restart on-failure:3</span></span><br><span class="line"><span class="comment"># --env/-eï¼šå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡ï¼Œé‡‡ç”¨key=valueå½¢å¼ï¼Œå¦‚ï¼Œ -e JAVA_ENV=dev --env JAVA_HOME=/xxx/xxx</span></span><br><span class="line"><span class="comment"># --cpusï¼šæŒ‡å®šcpuæ ¸å¿ƒæ•°</span></span><br><span class="line"><span class="comment"># --memoryï¼šæŒ‡å®šå†…å­˜</span></span><br><span class="line"><span class="comment"># å…¶ä»–å‚æ•°å¯ä»¥é€šè¿‡docker run --helpæŸ¥çœ‹</span></span><br></pre></td></tr></table></figure><p><img src="Docker%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C%E5%AE%B9%E5%99%A8.png" alt="Dockeråˆ›å»ºå¹¶è¿è¡Œå®¹å™¨" /></p><p><img src="Docker%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84.png" alt="Dockerç«¯å£æ˜ å°„" /></p><h5 id="æŸ¥çœ‹å®¹å™¨"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹å®¹å™¨"></a> æŸ¥çœ‹å®¹å™¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker ps [option]</span><br><span class="line"><span class="comment"># option </span></span><br><span class="line"><span class="comment"># ä¸æ·»åŠ ï¼š å½“å‰è¿è¡Œçš„å®¹å™¨</span></span><br><span class="line"><span class="comment"># -aï¼š æ‰€æœ‰å®¹å™¨</span></span><br></pre></td></tr></table></figure><p><img src="Docker%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8.png" alt="DockeræŸ¥çœ‹å®¹å™¨" /></p><h5 id="åˆ é™¤å®¹å™¨"><a class="markdownIt-Anchor" href="#åˆ é™¤å®¹å™¨"></a> åˆ é™¤å®¹å™¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> xxx</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8.png" alt="Dockeråˆ é™¤å®¹å™¨" /></p><h5 id="åœæ­¢å®¹å™¨"><a class="markdownIt-Anchor" href="#åœæ­¢å®¹å™¨"></a> åœæ­¢å®¹å™¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop xxx</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%81%9C%E6%AD%A2%E5%AE%B9%E5%99%A8.png" alt="Dockeråœæ­¢å®¹å™¨" /></p><h5 id="å¯åŠ¨å®¹å™¨"><a class="markdownIt-Anchor" href="#å¯åŠ¨å®¹å™¨"></a> å¯åŠ¨å®¹å™¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start xxx</span><br></pre></td></tr></table></figure><p><img src="Docker%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8.png" alt="Dockerå¯åŠ¨å®¹å™¨" /></p><h5 id="æŸ¥çœ‹å®¹å™¨ä¿¡æ¯"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹å®¹å™¨ä¿¡æ¯"></a> æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect xxx</span><br></pre></td></tr></table></figure><p><img src="Docker%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8%E4%BF%A1%E6%81%AF.png" alt="" /></p><h5 id="å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤"><a class="markdownIt-Anchor" href="#å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤"></a> å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it xxx cmd</span><br><span class="line"><span class="comment"># -itï¼šä½¿ç”¨ç»ˆç«¯æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># cmdï¼šå…·ä½“å‘½ä»¤ï¼Œå¦‚lsï¼Œviï¼Œechoç­‰</span></span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®¹å™¨çŠ¶æ€"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹å®¹å™¨çŠ¶æ€"></a> æŸ¥çœ‹å®¹å™¨çŠ¶æ€</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stats xxx</span><br></pre></td></tr></table></figure><h5 id="è¿›å…¥å®¹å™¨å†…éƒ¨"><a class="markdownIt-Anchor" href="#è¿›å…¥å®¹å™¨å†…éƒ¨"></a> è¿›å…¥å®¹å™¨å†…éƒ¨</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å®¹å™¨ä¸­å¼€å¯ä¸€ä¸ªç»ˆç«¯ï¼Œæ‰§è¡Œ /bin/bash</span></span><br><span class="line">docker <span class="built_in">exec</span> -it xxx /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º</span></span><br><span class="line"><span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹å®¹å™¨æ—¥å¿—"><a class="markdownIt-Anchor" href="#æŸ¥çœ‹å®¹å™¨æ—¥å¿—"></a> æŸ¥çœ‹å®¹å™¨æ—¥å¿—</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker logs [option] xxx</span><br><span class="line"><span class="comment"># -fï¼šå®æ—¶æ›´æ–°</span></span><br><span class="line"><span class="comment"># -nï¼šå±•ç¤ºnè¡Œï¼Œå¦‚ -n 20</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueç³»åˆ—(ä¸€)---é¡¹ç›®åˆ›å»ºå’Œé…ç½®</title>
      <link href="/2025/06/19/web/Vue%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE/"/>
      <url>/2025/06/19/web/Vue%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>ç°åœ¨å¼€å§‹æ­å»ºå‰ç«¯é¡¹ç›®, å…¶ä¸­ä¼šä½¿ç”¨<code>node</code>, <code>pnpm</code>, <code>vite</code>, <code>typescript</code>, <code>vue</code>ç­‰</p><p>æœ¬ç¯‡é»˜è®¤å·²ç»å®‰è£…<code>node</code>, å¹¶é…ç½®å¥½äº†<code>pnpm</code></p><h3 id="åˆ›å»ºé¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºé¡¹ç›®"></a> åˆ›å»ºé¡¹ç›®</h3><p>ä½¿ç”¨<code>pnpm</code>å‘½ä»¤åˆ›å»ºé¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create vite</span><br></pre></td></tr></table></figure><p>å¡«å†™é¡¹ç›®åç§°, æ¡†æ¶é€‰æ‹©<code>Vue</code>, æ”¯æŒé€‰æ‹©<code>TypeScript</code></p><p><img src="%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt="åˆ›å»ºé¡¹ç›®" /></p><p>æ‰§è¡Œç›¸å…³å‘½ä»¤, ä¸‹è½½ä¾èµ–</p><p><img src="%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" alt="ç›®å½•ç»“æ„" /></p><h3 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h3><h4 id="ä¾èµ–é…ç½®"><a class="markdownIt-Anchor" href="#ä¾èµ–é…ç½®"></a> ä¾èµ–é…ç½®</h4><p>æ·»åŠ <code>@type/node</code>ä¾èµ–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @type/node --save-dev</span><br></pre></td></tr></table></figure><h4 id="é¡¹ç›®é…ç½®"><a class="markdownIt-Anchor" href="#é¡¹ç›®é…ç½®"></a> é¡¹ç›®é…ç½®</h4><ol><li><p><code>tsconfig.json</code></p><p>æ·»åŠ <code>complierOptions.types</code>é…ç½®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;complierOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    ...<span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;vite/client&quot;</span><span class="punctuation">,</span> <span class="string">&quot;node&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p><code>vite.config.ts</code></p><p>æ·»åŠ é¡¹ç›®é…ç½®</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>()],</span><br><span class="line">  <span class="attr">base</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">  <span class="comment">// æœåŠ¡é…ç½®</span></span><br><span class="line">  <span class="attr">server</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">// æ‰©å±•åå¿½ç•¥</span></span><br><span class="line">    <span class="attr">extensions</span>: [<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.vue&#x27;</span>],</span><br><span class="line">    <span class="comment">// åˆ«åé…ç½®</span></span><br><span class="line">    <span class="attr">alias</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">find</span>: <span class="string">&#x27;@&#x27;</span>,</span><br><span class="line">        <span class="attr">replacement</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">find</span>: <span class="string">&#x27;@views&#x27;</span>,</span><br><span class="line">        <span class="attr">replacement</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src/views&#x27;</span>)</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">find</span>: <span class="string">&#x27;@components&#x27;</span>,</span><br><span class="line">        <span class="attr">replacement</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src/components&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">outDir</span>: <span class="string">&#x27;./dist&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>ç¯å¢ƒé…ç½®</p><ul><li><p>é…ç½®ç¯å¢ƒå¯¼å…¥</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="comment">// ... å…¶ä»–é…ç½®</span></span><br><span class="line">  <span class="attr">envDir</span>: <span class="string">&#x27;config/env&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»º<code>config/env</code>ç›®å½•, åœ¨è¯¥ç›®å½•ä¸­åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶</p></li><li><p>ç¯å¢ƒæ–‡ä»¶é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NODE_ENV = development</span><br><span class="line">VITE_HELLO = hello</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨ç¯å¢ƒé…ç½®ä¸­åˆ†ä¸ºä¸¤éƒ¨åˆ†, ä¸€éƒ¨åˆ†æ˜¯é»˜è®¤çš„ä¸å¯ä¿®æ”¹çš„é…ç½®, å¦ä¸€éƒ¨åˆ†æ˜¯è‡ªå®šä¹‰é…ç½®</p><ol><li>é»˜è®¤é…ç½®: <code>BASE_URL</code>, <code>MODE</code>, <code>DEV</code>, <code>PROD</code>, <code>SSR</code>. æ­¤éƒ¨åˆ†æ˜¯ä¸å¯ä¿®æ”¹çš„é»˜è®¤é…ç½®, è·Ÿé¡¹ç›®å¯åŠ¨æˆ–è€…æ„å»ºçš„ç¯å¢ƒæ¨¡å¼æœ‰å…³</li><li>è‡ªå®šä¹‰é…ç½®: åœ¨<code>vite</code>ä¸­, è‡ªå®šä¹‰é…ç½®å¿…é¡»ä»¥<code>VITE_</code>å¼€å¤´, å¦åˆ™æ— æ³•æ·»åŠ åˆ°ç¯å¢ƒé…ç½®ä¸­. å…¶ä¸­<code>NODE_ENV</code>æ¯”è¾ƒç‰¹æ®Š, å¯ä»¥ç›´æ¥å®šä¹‰, ä½†æ˜¯åœ¨ç¯å¢ƒå˜é‡ä¸­ä¼šè¢«é‡å‘½åä¸º<code>VITE_USER_NODE_ENV</code>, è¿™æœ¬è´¨ä¸Šä¸ä¼šå½±å“<code>node</code>çš„<code>NODE_ENV</code>, å¦‚æœæƒ³è¦ä¿®æ”¹<code>NODE_ENV</code>, åˆ™éœ€è¦åœ¨å¯åŠ¨å‘½ä»¤è¡Œä¸­å®šä¹‰(å‚è€ƒ: <a href="https://cn.vitejs.dev/guide/env-and-mode/#node-env-and-modes">https://cn.vitejs.dev/guide/env-and-mode/#node-env-and-modes</a>)</li></ol></blockquote></li><li><p>ç¯å¢ƒé…ç½®ä¿¡æ¯ä½¿ç”¨</p><ol><li><p>åœ¨é¡¹ç›®çš„<code>vite.config.ts</code>é…ç½®æ–‡ä»¶ä¸­, ä¸<code>webpack</code>ä¸€æ ·, ç›´æ¥é€šè¿‡<code>process.env.</code>ä½¿ç”¨å³å¯</p></li><li><p>åœ¨é¡¹ç›®çš„èµ„æºæ–‡ä»¶ä¸­, é€šè¿‡<code>import.meta.env.</code>ä½¿ç”¨</p><p>å‚è€ƒæ–‡æ¡£: <a href="https://cn.vitejs.dev/guide/env-and-mode.html">https://cn.vitejs.dev/guide/env-and-mode.html</a></p></li></ol></li></ul></li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>é—®é¢˜: ä¸‹è½½<code>@type/node</code>ä¾èµ–æ—¶å‡ºç°<code>404</code></p><p>é—®é¢˜åŸå› : 1. å¯èƒ½æ˜¯é•œåƒæºå¯¼è‡´çš„; 2. å¯èƒ½æ˜¯ä½¿ç”¨<code>ssl</code>å¯¼è‡´çš„</p><p>è§£å†³æ–¹æ¡ˆ: 1. å¯ä»¥åˆ‡æ¢åˆ°å®˜æ–¹çš„é•œåƒæºå°è¯•; 2. å¯ä»¥å…³é—­<code>ssl</code>æ–¹å¼ <code>npm config set strict-ssl false</code></p><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><p>é—®é¢˜: è§£æä¸åˆ°<code>resolver</code>å‡½æ•°å’Œ<code>__dirname</code>å˜é‡</p><p>é—®é¢˜åŸå› : æ²¡æœ‰æ·»åŠ <code>node</code>ä¾èµ–</p><p>è§£å†³æ–¹æ¡ˆ: æ·»åŠ <code>@type/node</code>ä¾èµ–, å¹¶å¼•å…¥<code>import &#123;resolve&#125; from 'path'</code></p><p><i id="é—®é¢˜ä¸‰">é—®é¢˜ä¸‰</i></p><p>é—®é¢˜: åœ¨ä½¿ç”¨<code>@</code>åˆ«ååå¼•å…¥<code>vue</code>ç»„ä»¶æ—¶, ä¼šæŠ¥é”™æç¤ºæ‰¾ä¸åˆ°ç»„ä»¶</p><p>é—®é¢˜åŸå› : å› ä¸º<code>ts</code>åªèƒ½è§£æ<code>.ts</code>æ–‡ä»¶ï¼Œæ— æ³•è§£æ<code>.vue</code>æ–‡ä»¶</p><p>è§£å†³æ–¹æ¡ˆ: åœ¨<code>vite-env.d.ts</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ¡ˆä¸€: æ·»åŠ ä¸»ä½“</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;*.vue&#x27;</span> &#123;</span><br><span class="line">    <span class="keyword">import</span> &#123; <span class="title class_">DefineComponent</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">component</span>: <span class="title class_">DefineComponent</span>&lt;&#123;&#125;, &#123;&#125;, <span class="built_in">any</span>&gt;</span><br><span class="line">    <span class="keyword">export</span> <span class="keyword">default</span> component</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ–¹æ¡ˆäºŒ: ä¸æ·»åŠ ä¸»ä½“</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;*.vue&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å¯¼å…¥æ—¶, æ·»åŠ <code>.vue</code>åç¼€</p><p>å…¶å®å³ä½¿ä¸æ·»åŠ ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œ, åªæ˜¯æŠ¥é”™æç¤ºæœ‰äº›çƒ¦äºº</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pnpm </tag>
            
            <tag> vue </tag>
            
            <tag> vite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeperç³»åˆ—(äºŒ)---å®‰è£…å’Œä½¿ç”¨</title>
      <link href="/2025/01/10/zookeeper/Zookeeper%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/01/10/zookeeper/Zookeeper%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="zookeeperæ¦‚å¿µ"><a class="markdownIt-Anchor" href="#zookeeperæ¦‚å¿µ"></a> <code>Zookeeper</code>æ¦‚å¿µ</h3><p><code>Zookeeper</code>æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„åè°ƒæœåŠ¡,å…¶é‡ç‚¹å°±æ˜¯åœ¨<mark>åè°ƒ</mark>è¿™ä¸¤ä¸ªå­—ä¸Š,å®ƒæœ€é‡è¦çš„èƒ½åŠ›å°±æ˜¯æœåŠ¡åè°ƒå·¥ä½œ,æŸä¸€é¡¹ä»»åŠ¡ç”±å“ªä¸ªèŠ‚ç‚¹å»å¤„ç†</p><p><code>Zookeeper</code>å¸¸ç”¨çš„åŠŸèƒ½æœ‰: é…ç½®ç®¡ç†, åˆ†å¸ƒå¼é”, é›†ç¾¤ç®¡ç†</p><h3 id="zookeeperå®‰è£…"><a class="markdownIt-Anchor" href="#zookeeperå®‰è£…"></a> <code>Zookeeper</code>å®‰è£…</h3><p>ä»<a href="[Apache ZooKeeper](https://zookeeper.apache.org/)"><code>Zookeeper</code></a>å®˜ç½‘é€‰æ‹©æƒ³è¦çš„ç‰ˆæœ¬, ç›´æ¥é€šè¿‡<code>http</code>ä¸‹è½½å‹ç¼©åŒ…å³å¯.</p><p>å°†å‹ç¼©åŒ…è§£å‹ä¹‹åå³å¯ä½¿ç”¨</p><p><img src="Zookeeper%E5%8E%8B%E7%BC%A9%E5%8C%85%E5%86%85%E5%AE%B9.png" alt="Zookeeperå‹ç¼©åŒ…å†…å®¹" /></p><ul><li><code>bin</code>ç›®å½•ä¸­æœ‰å¯åŠ¨<code>Zookeeper</code>æœåŠ¡å’Œå®¢æˆ·ç«¯çš„è„šæœ¬</li><li><code>conf</code>ç›®å½•ä¸­å¯ä»¥ä¿®æ”¹<code>zoo.cfg</code>æ¥ä¿®æ”¹<code>Zookeeper</code>çš„é…ç½®</li><li><code>data</code>ç›®å½•æ˜¯<code>Zookeeper</code>æœåŠ¡çš„æ•°æ®ç›®å½•</li><li><code>lib</code>ç›®å½•ä¸­æ˜¯<code>Zookeeper</code>æœåŠ¡åŠå…¶ä½¿ç”¨çš„ç›¸å…³åŒ…</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zoo.cfg é…ç½®</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># å¿ƒè·³é—´éš”</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># The number of ticks that the initial </span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># The number of ticks that can pass between </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just </span></span><br><span class="line"><span class="comment"># example sakes.</span></span><br><span class="line"><span class="comment"># æ•°æ®è·¯å¾„</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">D:\\software\\zookeeper\\apache-zookeeper-3.9.3-bin\\data</span></span><br><span class="line"><span class="comment"># æ—¥å¿—è·¯å¾„</span></span><br><span class="line"><span class="attr">dataLogDir</span>=<span class="string">D:\\software\\zookeeper\\apache-zookeeper-3.9.3-bin\\logs</span></span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ç«¯å£å·</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹å ç”¨çš„8080ç«¯å£å·</span></span><br><span class="line"><span class="attr">admin.serverPort</span>=<span class="string">8079</span></span><br><span class="line"><span class="comment"># the maximum number of client connections.</span></span><br><span class="line"><span class="comment"># increase this if you need to handle more clients</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># Purge task interval in hours</span></span><br><span class="line"><span class="comment"># Set to &quot;0&quot; to disable auto purge feature</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">## Metrics Providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://prometheus.io Metrics Exporter</span></span><br><span class="line"><span class="comment">#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span></span><br><span class="line"><span class="comment">#metricsProvider.httpHost=0.0.0.0</span></span><br><span class="line"><span class="comment">#metricsProvider.httpPort=7000</span></span><br><span class="line"><span class="comment">#metricsProvider.exportJvmInfo=true</span></span><br></pre></td></tr></table></figure><p>ä»<code>bin</code>ç›®å½•ä¸­çš„<code>zkServer.cmd</code>(<code>Windows</code>)æˆ–è€…<code>zkServer.sh</code>(<code>Linux</code>)å¯åŠ¨æœåŠ¡</p><p>è‡ªæ­¤, <code>Zookeeper</code>å°±å®‰è£…å¯åŠ¨å®Œæˆ</p><p>å¦‚æœæƒ³åœ¨é¡¹ç›®ä¸­ä½¿ç”¨<code>Zookeeper</code>, å¯ä»¥æŸ¥çœ‹<a href="https://xiao-lin-unit.github.io/2023/11/30/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"><code>SpringCloudç³»åˆ—(äºŒ)</code></a></p><h3 id="zookeeperæ•°æ®æ¨¡å‹"><a class="markdownIt-Anchor" href="#zookeeperæ•°æ®æ¨¡å‹"></a> <code>Zookeeper</code>æ•°æ®æ¨¡å‹</h3><p><code>Zookeeper</code>æ˜¯ä¸€ä¸ªæ ‘å½¢ç›®å½•æœåŠ¡, å…¶æ•°æ®æ¨¡å‹å’Œ<code>Unix</code>çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•æ ‘ç±»ä¼¼, æ‹¥æœ‰ä¸€ä¸ªå±‚æ¬¡åŒ–ç»“æ„</p><p><img src="Zookeeper%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.png" alt="Zookeeperçš„æ•°æ®æ¨¡å‹" /></p><p><code>Zookeeper</code>çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å­˜å‚¨æ•°æ®å’ŒèŠ‚ç‚¹ä¿¡æ¯</p><p><code>Zookeeper</code>çš„èŠ‚ç‚¹åˆ†ç±»:</p><ol><li><code>PERSISTENT</code>æŒä¹…åŒ–èŠ‚ç‚¹</li><li><code>EPHEMERAL</code>ä¸´æ—¶èŠ‚ç‚¹, å®¢æˆ·ç«¯å…³é—­å³åˆ é™¤: <code>-e</code></li><li><code>PERSISTENT_SEQUENTIAL</code>æŒä¹…åŒ–é¡ºåºèŠ‚ç‚¹: <code>-s</code></li><li><code>EPHEMERAL_SEQUENTIAL</code>ä¸´æ—¶é¡ºåºèŠ‚ç‚¹: <code>-es</code></li></ol><h3 id="zookeeperå®¢æˆ·ç«¯å‘½ä»¤"><a class="markdownIt-Anchor" href="#zookeeperå®¢æˆ·ç«¯å‘½ä»¤"></a> <code>Zookeeper</code>å®¢æˆ·ç«¯å‘½ä»¤</h3><p><code>ls</code>: æŸ¥çœ‹èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> [-s] /zookeeper</span><br></pre></td></tr></table></figure><p><code>create</code>: åˆ›å»ºèŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create [option(-e/-s/-es)] /mynode [data]</span><br></pre></td></tr></table></figure><p><code>get</code>: è·å–èŠ‚ç‚¹æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get /mynode</span><br></pre></td></tr></table></figure><p><code>set</code>: è®¾ç½®èŠ‚ç‚¹æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /mynode data</span><br></pre></td></tr></table></figure><p><code>delete</code>: åˆ é™¤èŠ‚ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete /mynode</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„:</p><p><code>Zookeeper</code>å®¢æˆ·ç«¯å‘½ä»¤çš„æŒ‡å‘èŠ‚ç‚¹å¿…é¡»ä»æ ¹å¼€å§‹</p></blockquote><h3 id="zookeeperçš„java-api"><a class="markdownIt-Anchor" href="#zookeeperçš„java-api"></a> <code>Zookeeper</code>çš„<code>JAVA API</code></h3><p>ä½¿ç”¨<code>Curator API</code>æ“ä½œ<code>Zookeeper</code></p><h4 id="å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#å¼•å…¥ä¾èµ–"></a> å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å»ºç«‹è¿æ¥"><a class="markdownIt-Anchor" href="#å»ºç«‹è¿æ¥"></a> å»ºç«‹è¿æ¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CuratorFramework connect &#123;</span><br><span class="line">    <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.builder()</span><br><span class="line">        .connectString(<span class="string">&quot;192.168.0.1:2181,192.168.0.2:2181&quot;</span>)</span><br><span class="line">        .connectionTimeoutMs(<span class="number">3000</span>)</span><br><span class="line">        .sessionTimeoutMs(<span class="number">3000</span>)</span><br><span class="line">        .retryPolicy(<span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">3000</span>, <span class="number">5</span>))</span><br><span class="line">        .build();</span><br><span class="line">    client.start();</span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºèŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#åˆ›å»ºèŠ‚ç‚¹"></a> åˆ›å»ºèŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰æ·»åŠ æ•°æ®, ä¼šé»˜è®¤å°†æœ¬æœºçš„ipåœ°å€æ·»åŠ åˆ°èŠ‚ç‚¹æ•°æ®ä¸­</span></span><br><span class="line">    client.create().forPath(<span class="string">&quot;/mynode&quot;</span>, <span class="string">&quot;data&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    <span class="comment">// ä¸åŒç±»å‹çš„èŠ‚ç‚¹ç”¨ withMode è¡¨ç¤º</span></span><br><span class="line">    client.create().withMode(CreateMode.PERSISTENT).forPath(<span class="string">&quot;/mynode&quot;</span>, <span class="string">&quot;data&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    <span class="comment">// åˆ›å»ºå¤šçº§èŠ‚ç‚¹ä½¿ç”¨ creatingParentsIfNeeded</span></span><br><span class="line">    client.create().creatingParentsIfNeeded().forPath(<span class="string">&quot;/mynode/node1&quot;</span>, <span class="string">&quot;data&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#æŸ¥è¯¢èŠ‚ç‚¹"></a> æŸ¥è¯¢èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„æ•°æ®å’ŒçŠ¶æ€éƒ½æ˜¯ç”¨getDataè·å–,ä¸åŒçš„æ˜¯æ•°æ®æ˜¯ç›´æ¥è¿”å›,ä½†æ˜¯çŠ¶æ€ä¿¡æ¯éœ€è¦ä½¿ç”¨çŠ¶æ€ç±»ç”¨storingStatInè·å–</span></span><br><span class="line">    <span class="comment">// ç”¨äºæŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">    <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stat</span>();</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line">    <span class="type">byte</span>[] bytes = client.getData().storingStatIn(stat).forPath(<span class="string">&quot;/mynode&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes, StandardCharsets.UTF_8);</span><br><span class="line"><span class="comment">// èŠ‚ç‚¹çš„å­èŠ‚ç‚¹</span></span><br><span class="line">    List&lt;String&gt; strings = client.getChildren().forPath(<span class="string">&quot;/mynode&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#ä¿®æ”¹èŠ‚ç‚¹"></a> ä¿®æ”¹èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stat</span>();</span><br><span class="line">    client.getData().storingStatIn(stat).forPath(<span class="string">&quot;/mynode&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ¹æ®ç‰ˆæœ¬ä¿®æ”¹, é¿å…æ•°æ®ä¸ä¸€è‡´</span></span><br><span class="line">    client.setData().withVersion(stat.getVersion()).forPath(<span class="string">&quot;/mynode&quot;</span>, <span class="string">&quot;data&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤èŠ‚ç‚¹"><a class="markdownIt-Anchor" href="#åˆ é™¤èŠ‚ç‚¹"></a> åˆ é™¤èŠ‚ç‚¹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Stat</span>();</span><br><span class="line">    client.getData().storingStatIn(stat).forPath(<span class="string">&quot;/mynode&quot;</span>);</span><br><span class="line">    <span class="comment">// æ ¹æ®ç‰ˆæœ¬åˆ é™¤</span></span><br><span class="line">    client.delete().withVersion(stat.getVersion()).forPath(<span class="string">&quot;/mynode&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ é™¤èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹</span></span><br><span class="line">    client.delete().deletingChildrenIfNeeded().withVersion(stat.getVersion()).forPath(<span class="string">&quot;/mynode/node1&quot;</span>);</span><br><span class="line">    <span class="comment">// å¿…é¡»åˆ é™¤</span></span><br><span class="line">    client.delete().guaranteed().deletingChildrenIfNeeded().withVersion(stat.getVersion()).forPath(<span class="string">&quot;/mynode/node1&quot;</span>);</span><br><span class="line">    <span class="comment">// å¸¦æœ‰å›è°ƒçš„åˆ é™¤</span></span><br><span class="line">    client.delete().deletingChildrenIfNeeded().withVersion(stat.getVersion()).inBackground((client, event) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ é™¤æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;).forPath(<span class="string">&quot;/mynode/node1&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="watchç›‘å¬"><a class="markdownIt-Anchor" href="#watchç›‘å¬"></a> <code>Watch</code>ç›‘å¬</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cache</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">CuratorCache</span> <span class="variable">cache</span> <span class="operator">=</span> CuratorCache.builder(client, <span class="string">&quot;/mynode&quot;</span>).build();</span><br><span class="line">    cache.listenable().addListener((type, oldData, data) -&gt; &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> NODE_CREATED -&gt; System.out.println(<span class="string">&quot;create node &quot;</span> + data.getPath());</span><br><span class="line">            <span class="keyword">case</span> NODE_CHANGED -&gt; System.out.println(<span class="string">&quot;change &quot;</span> + oldData.getPath() + <span class="string">&quot; to &quot;</span> + data.getPath());</span><br><span class="line">            <span class="keyword">case</span> NODE_DELETED -&gt; System.out.println(<span class="string">&quot;delete node &quot;</span> + oldData.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    cache.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ†å¸ƒå¼é”"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼é”"></a> åˆ†å¸ƒå¼é”</h4><p>æ ¸å¿ƒæ€æƒ³: å½“å®¢æˆ·ç«¯è¦è·å–é”, åˆ™åˆ›å»ºèŠ‚ç‚¹, ä½¿ç”¨å®Œé”, åˆ™åˆ é™¤è¯¥èŠ‚ç‚¹</p><ol><li>å®¢æˆ·ç«¯è·å–é”æ—¶, åœ¨<code>lock</code>èŠ‚ç‚¹ä¸‹åˆ›å»º<mark>ä¸´æ—¶é¡ºåº</mark>èŠ‚ç‚¹</li><li>æ‰€æœ‰å®¢æˆ·ç«¯è·å–<code>lock</code>èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹</li><li>å¦‚æœå½“å‰å®¢æˆ·ç«¯å‘ç°è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹åºå·åœ¨<code>lock</code>èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ä¸­æœ€å°, é‚£ä¹ˆå°±è®¤ä¸ºè¯¥å®¢æˆ·ç«¯è·å–åˆ°äº†é”, ä½¿ç”¨å®Œé”å, å°†è¯¥èŠ‚ç‚¹åˆ é™¤</li><li>å¦‚æœå½“å‰å®¢æˆ·ç«¯å‘ç°è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹åºå·åœ¨<code>lock</code>èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ä¸­å¹¶éæœ€å°, è¯´æ˜è¯¥å®¢æˆ·ç«¯è¿˜æ²¡æœ‰è·å–åˆ°é”, æ­¤æ—¶è¯¥å®¢æˆ·ç«¯éœ€è¦æ‰¾åˆ°æ¯”è‡ªå·±å°çš„é‚£ä¸ªèŠ‚ç‚¹, åŒäº‹å¯¹å…¶ç¥–å†Œäº‹ä»¶ç›‘å¬å™¨, ç›‘å¬åˆ é™¤äº‹ä»¶</li><li>å¦‚æœå½“å‰å®¢æˆ·ç«¯å‘ç°æ¯”è‡ªå·±å°çš„èŠ‚ç‚¹è¢«åˆ é™¤, åˆ™å®¢æˆ·ç«¯çš„ç›‘å¬å™¨ä¼šæ”¶åˆ°ç›¸åº”é€šçŸ¥, æ­¤æ—¶å†æ¬¡åˆ¤æ–­è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦æ˜¯<code>lock</code>å­èŠ‚ç‚¹ä¸­åºå·æœ€å°çš„, å¦‚æœæ˜¯åˆ™è·å–åˆ°é”, å¦‚æœä¸æ˜¯åˆ™é‡å¤ä¸Šè¿°æ­¥éª¤</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">InterProcessLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(client, <span class="string">&quot;/mynode/lock&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.acquire(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// do some synchronized things</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.release();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="zookeeperé›†ç¾¤"><a class="markdownIt-Anchor" href="#zookeeperé›†ç¾¤"></a> <code>Zookeeper</code>é›†ç¾¤</h3><h4 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h4><p>å®‰è£…å³åœ¨ä¸åŒçš„æœºå™¨ä¸Šå®‰è£…<code>Zookeeper</code></p><h4 id="é…ç½®é›†ç¾¤"><a class="markdownIt-Anchor" href="#é…ç½®é›†ç¾¤"></a> é…ç½®é›†ç¾¤</h4><ol><li><p>åœ¨æ¯ä¸ª<code>Zookeeper</code>çš„<code>data</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>myid</code>æ–‡ä»¶, è¿™ä¸ªæ–‡ä»¶å°±æ˜¯è®°å½•æ¯ä¸ªæœåŠ¡å™¨çš„<code>ID</code>, æ–‡ä»¶å†…å®¹å°±æ˜¯<code>Zookeeper</code>åœ¨é›†ç¾¤ä¸­çš„æ•°å­—, å¦‚<code>1, 2, 3</code></p></li><li><p>ä¿®æ”¹æ¯ä¸ª<code>Zookeeper</code>æœåŠ¡çš„<code>zoo.cfg</code>é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡.myid=å¯¹åº”zkæœåŠ¡ip:å¯¹åº”zkæœåŠ¡é€šä¿¡ç«¯å£(2881):å¯¹åº”zkæœåŠ¡é€‰ä¸¾ç«¯å£(3881)</span></span><br><span class="line"><span class="attr">server.1</span>=<span class="string">&#123;zk1.ip&#125;:&#123;zk1.connect_port&#125;:&#123;zk1.port&#125;</span></span><br><span class="line"><span class="attr">server.2</span>=<span class="string">&#123;zk2.ip&#125;:&#123;zk2.connect_port&#125;:&#123;zk2.port&#125;</span></span><br><span class="line"><span class="attr">server.3</span>=<span class="string">&#123;zk3.ip&#125;:&#123;zk3.connect_port&#125;:&#123;zk3.port&#125;</span></span><br></pre></td></tr></table></figure></li><li><p>å°†æ‰€æœ‰<code>Zookeeper</code>æœåŠ¡å¯åŠ¨</p></li></ol><h4 id="é›†ç¾¤è§’è‰²"><a class="markdownIt-Anchor" href="#é›†ç¾¤è§’è‰²"></a> é›†ç¾¤è§’è‰²</h4><p>é›†ç¾¤ä¸­çš„ä¸‰ç§è§’è‰²:</p><ul><li><code>Leader</code>é¢†å¯¼è€…: å¤„ç†äº‹åŠ¡è¯·æ±‚; é›†ç¾¤å†…éƒ¨ä¸ªæœåŠ¡å™¨çš„è°ƒåº¦è€…</li><li><code>Follower</code>è·Ÿéšè€…: å¤„ç†éäº‹åŠ¡è¯·æ±‚, å¹¶è½¬å‘äº‹åŠ¡è¯·æ±‚ç»™<code>Leader</code>; å‚ä¸<code>Leader</code>é€‰ä¸¾æŠ•ç¥¨</li><li><code>Observer</code>è§‚å¯Ÿè€…: å¤„ç†éäº‹åŠ¡è¯·æ±‚, å¹¶è½¬å‘äº‹åŠ¡è¯·æ±‚ç»™<code>Leader</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeperç³»åˆ—(ä¸€)---åŸç†</title>
      <link href="/2024/11/28/zookeeper/Zookeeper%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%8E%9F%E7%90%86/"/>
      <url>/2024/11/28/zookeeper/Zookeeper%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>zookeeper</code>å¼€ç¯‡åŸæœ¬æ˜¯æƒ³ç›´æ¥è®²è¿°å®‰è£…å’Œä½¿ç”¨çš„, ä½†åœ¨ä»‹ç»ä¸ºå•¥è¦ä½¿ç”¨<code>zookeeper</code>æ—¶, æ€»æ˜¯ç»•ä¸è¿‡å®ƒçš„èµ·æº. è‡ªæ­¤ä¹Ÿå°±éœ€è¦è¿™æ ·ä¸€ç¯‡åšæ–‡æ¥è®²è¿°ä¸€ä¸‹<code>zookeeper</code>çš„å‰ä¸–.</p><p><mark>å¦‚æœä¸æƒ³äº†è§£åŸç†, åªæ˜¯å­¦ä¹ ä½¿ç”¨, å¤§å¯è·³è¿‡æœ¬ç¯‡æ–‡ç« </mark></p><h3 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h3><p>éšç€ä¸šåŠ¡éœ€æ±‚é‡çš„é€æ­¥å¢é•¿, å•ä½“æœåŠ¡å·²ç»æ— æ³•æ”¯æ’‘æ•´ä¸ªç³»ç»Ÿ, æ­¤æ—¶å°±ä»<strong>å•èŠ‚ç‚¹çš„é›†ä¸­å¼æ¶æ„</strong>å‘<strong>å¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼æ¶æ„</strong>è½¬å‹. åˆ†å¸ƒå¼æœºæ„èƒ½è§£å†³é›†ä¸­å¼æ¶æ„ä¸­å¿ƒåŒ–å¸¦æ¥å•ç‚¹æ•…éšœçš„é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸€è‡´æ€§çš„é—®é¢˜. é€šå¸¸è¯´çš„ä¸€è‡´æ€§é—®é¢˜å¤§å¤šæ•°äººçš„ç¬¬ä¸€å°è±¡æ˜¯æ•°æ®ä¸€è‡´æ€§, ä½†æ­¤å¤„çš„ä¸€è‡´æ€§ç”¨çŠ¶æ€çš„ä¸€è‡´æ€§æ¥æè¿°æ›´ä¸ºåˆç†, åªä¸è¿‡çŠ¶æ€é€šå¸¸é€šè¿‡æ•°æ®æ¥ä½“ç°. <code>Paxos</code>ç®—æ³•æ˜¯ä¸€ç§<strong>é€šç”¨æ€§åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®</strong></p><p>å…¶ä¸­çš„<strong>æ‹œå åº­é—®é¢˜</strong>å¯ä»¥å‚è€ƒæ–‡ç« : <a href="https://juejin.cn/post/7065309063432634382">åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼šä½ çœŸçš„è¯»æ‡‚äº†Paxoså°å²›çš„æ•…äº‹å˜›ï¼Ÿ</a></p><h3 id="paxosç®—æ³•"><a class="markdownIt-Anchor" href="#paxosç®—æ³•"></a> <code>Paxos</code>ç®—æ³•</h3><p><code>Lamport</code>è€çˆ·å­æå‡ºäº†å®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ, å¹¶ä½¿ç”¨<code>paxos</code>å°å²›çš„æ–¹å¼è¿›è¡Œäº†å…·è±¡åŒ–æè¿°, å½“æˆ‘å»é˜…è¯»ç½‘ä¸Šçš„æ–‡ç« çš„è§£ææ–‡ç« çš„æ—¶å€™, æˆ‘ç–¯äº†, å¥½ä¼¼ä¸åŒçš„äººç†è§£å‡ºäº†ä¸ä¸€æ ·çš„ç‰ˆæœ¬. æˆ‘åªå¾—å»å¯»æ‰¾åŸæ–‡: <a href="The Part-Time Parliament en.pdf">The Part-Time Parliament en.pdf</a></p><p>ç›¸ä¿¡å¯¹å„ä½å¤§ä½¬æ¥è¯´ç®€ç›´å°èœ, æˆ‘ä¸ªäººè‹±è¯­æ°´å¹³ä¸è¡Œ, æˆ‘çœ‹ä¸­æ–‡è¯‘æ–‡ç‰ˆ: <a href="The Part-Time Parliament CN.pdf">The Part-Time Parliament CN.pdf</a></p><h5 id="é˜¶æ®µä¸€-å•ä¸€æ³•ä»¤åœ£ä¼šthe-single-decree-synod"><a class="markdownIt-Anchor" href="#é˜¶æ®µä¸€-å•ä¸€æ³•ä»¤åœ£ä¼šthe-single-decree-synod"></a> é˜¶æ®µä¸€: å•ä¸€æ³•ä»¤åœ£ä¼š(The Single-Decree Synod)</h5><p>é˜¶æ®µä¸€ä¸­æœ‰ä»¥ä¸‹è¦ç‚¹:</p><ol><li>é€šè¿‡ä¸€ç³»åˆ—æœ‰ç¼–å·çš„é€‰ç¥¨æ¥è¡¨å†³, ä¸€å¼ é€‰ç¥¨æ˜¯å¯¹å•ä¸€çš„ä¸€ä¸ªæ³•ä»¤çš„è¡¨å†³</li><li>åœ¨ä¸€è½®è¡¨å†³ä¸­, ç‰§å¸ˆåªèƒ½é€‰æ‹©æŠ•ç¥¨æˆ–ä¸æŠ•ç¥¨</li><li>å’Œè¡¨å†³ç›¸å…³çš„æ˜¯ä¸€ç¾¤ç‰§å¸ˆçš„é›†åˆ, ç§°æ³•å®šäººæ•°(å‚ä¸äººæ•°)</li><li>ä¸€è½®è¡¨å†³æ˜¯å¦æˆåŠŸåªå–å†³äºæ³•å®šäººæ•°çš„ç‰§å¸ˆç»™è¯¥æ³•ä»¤æŠ•ç¥¨(æŠ•ç¥¨äººæ•°)</li></ol><p>ä¸€è½®è¡¨å†³åŒ…å«å››ä¸ªéƒ¨åˆ†(ä¸€è½®è¡¨å†³ä»¥<code>B</code>è¡¨ç¤º):</p><ol><li>B<sub>dec</sub> : è¢«è¡¨å†³çš„ä¸€æ¡æ³•ä»¤</li><li>B<sub>qrm</sub> : éç©ºçš„ç‰§å¸ˆé›†åˆ, è¡¨å†³çš„æ³•å®šäººæ•°é›†, ä¸€èˆ¬æŒ‡å¤šæ•°æ´¾</li><li>B<sub>vot</sub> : æŠ•ç¥¨ç»™è¯¥æ³•ä»¤çš„ç‰§å¸ˆé›†åˆ</li><li>B<sub>bal</sub> : é€‰ç¥¨åºå·</li></ol><p>ä¸€è½®è¡¨å†³æˆåŠŸæ¡ä»¶:</p><p>â€‹1. å½“ä¸”ä»…å½“B<sub>qrm</sub> âŠ† B<sub>vot</sub></p>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(ä¹)---é˜¶æ®µæ€»ç»“</title>
      <link href="/2024/05/11/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B9%9D%E4%B9%8B%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/"/>
      <url>/2024/05/11/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B9%9D%E4%B9%8B%E9%98%B6%E6%AE%B5%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>æœ¬ç¯‡æ˜¯å†™åœ¨å…¨å±€äº‹åŠ¡ç¯‡ä¹‹å‰, å‰é¢è®²è¿°äº†<code>SpringCloud</code>çš„ä¸€äº›æ­å»ºå†…å®¹, ç°åœ¨è¦å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿåšä¸€äº›æè¿°æˆ–è€…è¯´å‰é¢å†…å®¹çš„è¡¥å……, æŒ‰ç…§é€»è¾‘æ¥è¯´, æœ¬ç¯‡è®²è¿°åœ¨åˆ†ç±»å¼€å§‹ä¹‹å‰æ¯”è¾ƒåˆé€‚, ä½†æ˜¯â€¦åæ­£â€¦(ç»ä¸æ‰¿è®¤æˆ‘å¿½ç•¥äº†)</p><h3 id="åŸå› "><a class="markdownIt-Anchor" href="#åŸå› "></a> åŸå› </h3><p>é¦–å…ˆä¸ºä»€ä¹ˆä½¿ç”¨åˆ†å¸ƒå¼ ? ä¸€å¥è¯æ¦‚è¿°å°±æ˜¯å•ä¸ªå•ä½“æœåŠ¡çš„ååé‡ä¸è¶³ä»¥æ”¯æ’‘ç³»ç»Ÿçš„æ­£å¸¸ä½¿ç”¨</p><p>å®é™…ä¸Šæ¯ä¸ªé¡¹ç›®çš„èµ·æ­¥é˜¶æ®µç»å¤§å¤šæ•°éƒ½æ˜¯å•ä½“é¡¹ç›®, åœ¨é¡¹ç›®ä¹‹åˆå°±ä»¥åˆ†å¸ƒå¼çš„æ–¹å¼è®¾è®¡çš„é¡¹ç›®å°‘ä¹‹åˆå°‘, å› ä¸ºé¡¹ç›®åˆå§‹é˜¶æ®µçš„ä¸šåŠ¡å†…å®¹æ¯”è¾ƒå°‘, å¤„ç†é‡å°‘, å•ä½“åº”ç”¨å³å¯è§£å†³, ä¸éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼çš„æ–¹å¼</p><p><img src="%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8.png" alt="å•ä½“åº”ç”¨" /></p><p>éšç€é¡¹ç›®çš„é€æ¸æˆç†Ÿ, å®¢æˆ·é‡å’Œä¸šåŠ¡é‡å¢åŠ , é¡¹ç›®çš„å‹åŠ›å¢åŠ , å•ä½“åº”ç”¨éš¾ä»¥æ”¯æ’‘åºå¤§çš„è¯·æ±‚é‡, ç³»ç»Ÿå°±ä¼šå‡ºç°é—®é¢˜, æ­¤æ—¶å°±å¼€å§‹å¼•å…¥åˆ†å¸ƒå¼</p><p>é˜¶æ®µä¸€: åˆ†å¸ƒå¼çš„åˆå§‹é˜¶æ®µå¹¶ä¸æ˜¯æŒ‰ç…§æœåŠ¡æ¥åˆ’åˆ†çš„, è¿™é€šå¸¸æˆä¸ºç¬¬ä¸€é˜¶æ®µ, è¿™ä¸€é˜¶æ®µé€šå¸¸æ˜¯é€šè¿‡å¢åŠ å•ä½“æœåŠ¡çš„æ•°é‡æ¥è§£å†³çš„, å³åŸæœ¬ä¸€ä¸ªå•ä½“åº”ç”¨éš¾ä»¥ç»´æŒçš„å‹åŠ›, ç°åœ¨å¢åŠ ä¸¤å°åº”ç”¨, å°†åŸæœ¬çš„å‹åŠ›åˆ†æˆä¸‰ä»½, é€šè¿‡è¿™ç§æ–¹å¼ç»´æŒè¿è¡Œ</p><p><img src="%E5%A4%9A%E4%B8%AA%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8.png" alt="å•ä½“åº”ç”¨" /></p><blockquote><p>å…¶å®å¸‚é¢ä¸Šé™¤äº†å°‘æ•°åºç„¶å¤§ç‰©å¤–, å¤§å¤šæ•°éœ€è¦èµ°åˆ†å¸ƒå¼çš„ä¼ä¸šæ­£å¤„åœ¨ä¸Šè¿°é˜¶æ®µ, ç‰¹åˆ«æ˜¯ä¸€äº›å›½ä¼</p><p><font style="color: red">ä¸Šå›¾ä¸­çš„æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€å°å®Œæ•´çš„å•ä½“åº”ç”¨</font></p></blockquote><p>é˜¶æ®µäºŒ: åˆ†å¸ƒå¼çš„å‘å±•é˜¶æ®µæ˜¯å¼€å§‹æŒ‰ç…§æœåŠ¡æ¥æ‹†åˆ†, å³å¼€å§‹èµ°å¾®æœåŠ¡è·¯çº¿, æ­¤æ—¶æ‹†åˆ†çš„åˆ’åˆ†ä¼šæ¯”è¾ƒç²—ç•¥, æ¯”å¦‚ä¼šå°†ä¸€æ•´ä¸ªå…³è”æ€§æ¯”è¾ƒå¼ºçš„åŠŸèƒ½å…¨éƒ¨æ‹†åˆ†æˆä¸€ä¸ªæœåŠ¡, æ¯ä¸ªæœåŠ¡éƒ½æ·»åŠ å¤šä¸ª, æ„æˆä¸€ä¸ªå•ä¸€æœåŠ¡çš„æœåŠ¡ç»„, é€šè¿‡æœåŠ¡é—´çš„è°ƒç”¨å®ç°æ•´ä¸ªä¸šåŠ¡é€»è¾‘. æ¯ä¸ªè¯·æ±‚çš„æµç¨‹å®è´¨ä¸Šæ˜¯æœåŠ¡é—´çš„è°ƒç”¨æµç¨‹</p><p><img src="%E5%BE%AE%E6%9C%8D%E5%8A%A1.png" alt="å•ä½“åº”ç”¨" /></p><p>é˜¶æ®µä¸‰: åˆ†å¸ƒå¼çš„æœ€ç»ˆé˜¶æ®µåœ¨è®¾è®¡ä¸Šä¸é˜¶æ®µäºŒæ²¡æœ‰åˆ†åˆ«, åªæ˜¯æœåŠ¡çš„æ‹†åˆ†æ›´åŠ åˆç†, æœåŠ¡çš„æ•°é‡å’Œåˆ†å¸ƒæŒ‰ç…§å®é™…çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œåˆç†æ‹†åˆ†, æ¯”å¦‚åœ¨å¤šä¸ªè¯·æ±‚æµç¨‹ä¸­éƒ½ç”¨åˆ°äº†æŸä¸ªæœåŠ¡, åˆ™è¯¥æœåŠ¡çš„æ•°é‡åº”è¯¥å¤šäºå…¶ä»–ç›¸å…³çš„æœåŠ¡, è¿™ä¸ªæ•°é‡åº”è¯¥æ˜¯åœ¨ç³»ç»Ÿçš„å®é™…åº”ç”¨ä¸­è¿›è¡Œç»Ÿè®¡, å¾—åˆ°çš„åˆç†æ•°å€¼</p><blockquote><p>å¦‚:</p><p>è¯·æ±‚ä¸€: æœåŠ¡ä¸€ â€”&gt; æœåŠ¡äºŒ â€”&gt; æœåŠ¡ä¸‰</p><p>è¯·æ±‚äºŒ: æœåŠ¡å›› â€”&gt; æœåŠ¡äºŒ â€”&gt; æœåŠ¡äº”</p><p>å‡è®¾ä¸¤ä¸ªè¯·æ±‚çš„è¯·æ±‚æ•°ä¸€è‡´, åˆ™åœ¨ç³»ç»Ÿä¸­, æœåŠ¡äºŒçš„æ•°é‡ä¸å…¶ä»–æœåŠ¡çš„æ•°é‡å¯èƒ½ä¸ä¸€è‡´(è¿™ä¸ªæ•°é‡ä¸è¿™ä¸ªæœåŠ¡å·¥ä½œçš„ååé‡æœ‰å…³)</p></blockquote><h3 id="éœ€è¦è§£å†³çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#éœ€è¦è§£å†³çš„é—®é¢˜"></a> éœ€è¦è§£å†³çš„é—®é¢˜</h3><h4 id="ä¸€è‡´æ€§é—®é¢˜"><a class="markdownIt-Anchor" href="#ä¸€è‡´æ€§é—®é¢˜"></a> ä¸€è‡´æ€§é—®é¢˜</h4><h4 id="sessionå…±äº«é—®é¢˜"><a class="markdownIt-Anchor" href="#sessionå…±äº«é—®é¢˜"></a> <code>Session</code>å…±äº«é—®é¢˜</h4>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLç³»åˆ—(ä¸‰)---ç´¢å¼•</title>
      <link href="/2024/04/29/mysql/MySQL%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E7%B4%A2%E5%BC%95/"/>
      <url>/2024/04/29/mysql/MySQL%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E7%B4%A2%E5%BC%95/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰é¢æˆ‘ä»¬å¤§è‡´äº†è§£äº†<code>DML</code>å’Œ<code>DQL</code>, ä¸è¿™ä¸¤ç§ç±»å‹çš„è¯­è¨€å…³ç³»æ¯”è¾ƒå¤§çš„å†…å®¹æœ‰ä¸€ä¸ªç´¢å¼•, ç´¢å¼•çš„ç›®çš„æ˜¯åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶, æé«˜æŸ¥è¯¢çš„æ•ˆç‡. ç´¢å¼•çš„æœ‰å¤šç§ç±»å‹, å¦‚ä¸»é”®ç´¢å¼•, å¤–é”®ç´¢å¼•, å”¯ä¸€ç´¢å¼•, é<code>NULL</code>ç´¢å¼•, æ™®é€šç´¢å¼•</p><p><code>MySQL</code>ä¸­çš„ç´¢å¼•ä½¿ç”¨çš„æ˜¯<code>B+</code>æ ‘ç»“æ„, <code>B+</code>æ ‘çš„ç»“æ„ä¸­, åªæœ‰å¶å­ç»“ç‚¹æ‰ä¼šå­˜å‚¨æ•°æ®, è¿™æ ·åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­, åœ¨æ‰¾åˆ°å…·ä½“æ•°æ®ä¹‹å‰, æ˜¯ä¸éœ€è¦åŠ è½½æ•°æ®çš„å…¨éƒ¨å†…å®¹åˆ°å†…å­˜çš„, åªéœ€è¦å°†ç´¢å¼•å†…å®¹åŠ è½½åˆ°å†…å­˜å³å¯, æé«˜æ•ˆç‡</p><p>ç´¢å¼•åº”å»ºç«‹åœ¨åŒºåˆ†åº¦æ¯”è¾ƒå¤§çš„åˆ—ä¸Š</p><p>è¿‡æ»¤å› å­æè¿°äº†è°“è¯(ONæˆ–è€…WHERE)çš„é€‰æ‹©æ€§, å³è¡¨ä¸­æ»¡è¶³è°“è¯æ¡ä»¶çš„è®°å½•è¡Œæ•°æ‰€å çš„æ¯”ä¾‹, å®ƒä¸»è¦ä¾èµ–äºåˆ—å€¼çš„åˆ†å¸ƒæƒ…å†µ</p><h3 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜</h3><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL, SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLç³»åˆ—(äºŒ)---SQL</title>
      <link href="/2024/02/26/mysql/MySQL%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8BSQL/"/>
      <url>/2024/02/26/mysql/MySQL%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8BSQL/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>MySQL</code>æ˜¯å¸¸ç”¨çš„æ•°æ®åº“, å¸‚åœºå æœ‰ç‡å¾ˆé«˜, æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>MySQL</code>æ¥å­¦ä¹ <code>SQL</code>çš„é€šä¿—æ ‡å‡†, å½“é‡åˆ°å…¶ä»–æ•°æ®åº“æ—¶, åªéœ€è¦çŸ¥é“æ•°æ®åº“ä¹‹é—´çš„å·®å¼‚æ€§å³å¯.</p><p>å‰ç¯‡å·²ç»è®²è§£äº†å¦‚ä½•å®‰è£…<code>MySQL</code>, æœ¬ç¯‡æ¥ä»‹ç»<code>SQL</code>åŸºç¡€, æœ¬ç¯‡æ˜¯åŸºäºç”¨æˆ·å¯¹<code>MySQL</code>æœ‰ä¸€å®šçš„è®¤è¯†, æ¯”å¦‚<code>MySQL</code>çš„æ•°æ®ç±»å‹.<code>SQL</code>åˆ†ä¸º<code>DDL</code>,<code>DML</code>,<code>DQL</code>,<code>DCL</code>, æœ¬ç¯‡ä¸»è¦æ˜¯ä»‹ç»<code>DML</code>å’Œ<code>DQL</code>.</p><p>æœ¬ç¯‡å­¦ä¹ æ¯”è¾ƒå¥½çš„è§†é¢‘æ•™ç¨‹å¯å‚è€ƒ(ä¸ªäººè®¤ä¸ºæ˜¯æ„Ÿå®˜æœ€å¥½çš„, è¯¦ç»†(å•°å—¦)æœ‰å¹²è´§):</p><p><a href="https://edu.csdn.net/course/detail/24472">https://edu.csdn.net/course/detail/24472</a></p><p>å…¶ä»–çš„å†…å®¹ä¸åšä»‹ç», è‹¥å­¦ä¹ å¯å‚è€ƒ:</p><p><a href="https://www.w3schools.cn/mysql/default.html">https://www.w3schools.cn/mysql/default.html</a></p><p><a href="https://zhuanlan.zhihu.com/p/391552199">https://zhuanlan.zhihu.com/p/391552199</a></p><p>è¡¨ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- ç”¨æˆ·è¡¨</span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(64) COLLATE utf8mb4_general_ci DEFAULT NULL,</span><br><span class="line">  `sex` char(1) COLLATE utf8mb4_general_ci DEFAULT NULL,</span><br><span class="line">  `age` int DEFAULT NULL,</span><br><span class="line">  `role_ids` varchar(32) COLLATE utf8mb4_general_ci DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-- è§’è‰²è¡¨</span><br><span class="line">CREATE TABLE `role` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(64) COLLATE utf8mb4_general_ci DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;</span><br></pre></td></tr></table></figure><h3 id="å¢"><a class="markdownIt-Anchor" href="#å¢"></a> å¢</h3><p>æ–°å¢æ“ä½œ(<code>INSERT</code>)æ˜¯ä¸€ç§<code>DML</code>æ“ä½œ, ç”¨æ¥æ–°å¢ä¸€æ¡æˆ–è€…å¤šæ¡è®°å½•</p><p>æ–°å¢æ“ä½œçš„è¯­æ³•ç»“æ„:</p><h4 id="å¸¸ç”¨ç»“æ„"><a class="markdownIt-Anchor" href="#å¸¸ç”¨ç»“æ„"></a> å¸¸ç”¨ç»“æ„</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT INTO</span></span><br><span class="line">table_name(column1, column2,...)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">(c1_value1, c2_value1,...),</span><br><span class="line">(c1_value2, c2_value2,...),</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨ç»“æ„å¯ä»¥ç”¨äºæ–°å¢ä¸€æ¡è®°å½•æˆ–è€…å¤šæ¡è®°å½•, æ–°å¢å¤šæ¡è®°å½•æ—¶, é€šå¸¸æ‰¹é‡æ–°å¢æ¯”å•æ¡å¾ªç¯æ–°å¢æ•ˆç‡è¦é«˜, ä½†ä¹Ÿä¸å®œæ•°é‡è¿‡å¤§, è¿™åè€Œä¼šå½±å“æ•ˆç‡, åº”ä½¿ç”¨åˆé€‚çš„æ•°é‡è¿›è¡Œå¾ªç¯çš„æ‰¹é‡æ–°å¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `user` (`id`, `name`, `sex`, `age`, `role_ids`) VALUES (1, &#x27;xiao-lin&#x27;, &#x27;1&#x27;, 18, &#x27;1,3&#x27;), (2, &#x27;xiao_lin&#x27;, &#x27;2&#x27;, 18, &#x27;1,3&#x27;);</span><br><span class="line"></span><br><span class="line">INSERT INTO `role` (`id`, `name`) VALUES (1, &#x27;first&#x27;), (2, &#x27;second&#x27;), (3, &#x27;third&#x27;);</span><br></pre></td></tr></table></figure><h4 id="æ›¿æ¢ç»“æ„"><a class="markdownIt-Anchor" href="#æ›¿æ¢ç»“æ„"></a> æ›¿æ¢ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REPLACE INTO</span><br><span class="line">table_name(id, column2,...)</span><br><span class="line">VALUES</span><br><span class="line">(id_value1, c2_value1,...),</span><br><span class="line">(id_value2, c2_value2,...),</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å½“æ’å…¥çš„æ•°æ®å·²ç»å­˜åœ¨æ—¶(<mark>é€šè¿‡ä¸»é”®åˆ¤æ–­</mark>), åˆ™åˆ é™¤åŸè®°å½•å¹¶æ·»åŠ æ–°è®°å½•, å¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥æ·»åŠ æ–°è®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REPLACE INTO `role` (`id`, `name`) VALUES (1, &#x27;first&#x27;), (2, &#x27;second&#x27;), (3, &#x27;third&#x27;), (4, &#x27;fourth&#x27;);</span><br></pre></td></tr></table></figure><p><img src="REPLACE_INTO%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C.png" alt="REPLACE_INTOæ‰§è¡Œç»“æœ" /></p><h4 id="å¿½ç•¥ç»“æ„"><a class="markdownIt-Anchor" href="#å¿½ç•¥ç»“æ„"></a> å¿½ç•¥ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT IGNORE INTO</span><br><span class="line">table_name(column1, column2,...)</span><br><span class="line">VALUES</span><br><span class="line">(id_value1, c2_value1,...),</span><br><span class="line">(id_value2, c2_value2,...),</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å½“æ’å…¥çš„æ•°æ®å·²ç»å­˜åœ¨æ—¶(<mark>é€šè¿‡ä¸»é”®åˆ¤æ–­</mark>), åˆ™å¿½ç•¥è¯¥è®°å½•, å¦‚æœä¸å­˜åœ¨åˆ™æ·»åŠ æ–°è®°å½•</p><p><img src="INSERT_INGORE%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C.png" alt="INSERT_INGOREæ‰§è¡Œç»“æœ" /></p><h4 id="è¿ç§»ç»“æ„"><a class="markdownIt-Anchor" href="#è¿ç§»ç»“æ„"></a> è¿ç§»ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO</span><br><span class="line">table_name(column1, column2,...)</span><br><span class="line">SELECT</span><br><span class="line">c1_value1, c2_value1,...</span><br><span class="line">FROM </span><br><span class="line">source_table_name</span><br></pre></td></tr></table></figure><p>æ–°å¢çš„æ•°æ®å¯ç›´æ¥é€šè¿‡æŸ¥è¯¢å¾—åˆ°, æ­¤å¤„çš„æŸ¥è¯¢æ˜¯ç®€å•è¡¨ç¤º, è¯¦ç»†çš„æŸ¥è¯¢å¯åœ¨æŸ¥è¯¢æ¨¡å—ä¸­å­¦ä¹ .</p><p>åœ¨ä½¿ç”¨æ­¤ç»“æ„æ—¶éœ€è¦æ³¨æ„, <mark>æ­¤ç»“æ„ä¸­çš„<code>SELECT</code>æ˜¯æ”¯æŒ<code>UNION</code>æ“ä½œç»“æœçš„, ä¹Ÿå¯ä»¥å°†<code>UNION</code>ç»“æœä½œä¸ºä¸€ä¸ªä¸´æ—¶è¡¨, å¤–å¥—ä¸€ä¸ª<code>SELECT</code>ä½¿ç”¨</mark></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO user_union_copy( name, role_ids)</span><br><span class="line">SELECT name, role_ids</span><br><span class="line">FROM user</span><br></pre></td></tr></table></figure><p><img src="%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB.png" alt="æ•°æ®è¿ç§»" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO user_union_copy( name, role_ids)</span><br><span class="line">SELECT name, role_ids</span><br><span class="line">FROM user</span><br><span class="line">UNION ALL </span><br><span class="line">SELECT name, role_ids</span><br><span class="line">FROM user_copy;</span><br></pre></td></tr></table></figure><p><img src="%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB-UNION.png" alt="æ•°æ®è¿ç§»-UNION" /></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO user_union_copy( name, role_ids)</span><br><span class="line">SELECT name, role_ids </span><br><span class="line">FROM (</span><br><span class="line">SELECT name, role_ids</span><br><span class="line">FROM user</span><br><span class="line">UNION ALL </span><br><span class="line">SELECT name, role_ids</span><br><span class="line">FROM user_copy</span><br><span class="line">) AS temp;</span><br></pre></td></tr></table></figure><p><img src="%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB-UNION_SELECT.png" alt="æ•°æ®è¿ç§»-UNION_SELECT" /></p><h3 id="åˆ "><a class="markdownIt-Anchor" href="#åˆ "></a> åˆ </h3><p>åˆ é™¤æ“ä½œ(<code>DELETE</code>)æ˜¯ä¸€ç§<code>DML</code>æ“ä½œ, ä¹Ÿæ˜¯å…¶ä¸­æœ€ç®€å•çš„æ“ä½œ, ç”¨æ¥åˆ é™¤ç¬¦åˆæ¡ä»¶çš„è®°å½•</p><p>åˆ é™¤æ“ä½œçš„è¯­æ³•ç»“æ„:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">table_name</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line"><span class="keyword">condition</span></span><br></pre></td></tr></table></figure><p>åˆ é™¤æ“ä½œæ˜¯å°†ç¬¦åˆæ¡ä»¶çš„è®°å½•å…¨éƒ¨åˆ é™¤, æ‰€ä»¥ä¸€å®šè¦è®°å¾—æ·»åŠ æ­£ç¡®çš„<code>condition</code>æ¡ä»¶, <code>condition</code>æ¡ä»¶å…·ä½“ä¼šåœ¨æŸ¥è¯¢æ“ä½œä¸­è®²è§£, éœ€è¦æ³¨æ„çš„æ˜¯, <mark><code>DELETE</code>çš„æ¡ä»¶åªèƒ½æ˜¯<code>WHERE</code>è·Ÿéšçš„æ¡ä»¶, æ— æ³•ä½¿ç”¨èšåˆå‡½æ•°æ¡ä»¶</mark></p><p>è¿˜æœ‰ä¸€ç§æ˜¯æ¸…ç©ºæ•°æ®åº“è®°å½•çš„æ“ä½œ(<code>TRUNCATE</code>), <code>TRUNCATE</code>çš„æ–¹å¼æ¸…é™¤æ•°æ®å, è¯¥è¡¨è¿›å…¥åˆå§‹çŠ¶æ€, è‡ªå¢å­—æ®µå€¼ä¹Ÿä¼šå›åˆ°åˆå§‹å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE table_name;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE user_union_copy;</span><br></pre></td></tr></table></figure><h3 id="æ”¹"><a class="markdownIt-Anchor" href="#æ”¹"></a> æ”¹</h3><p>ä¿®æ”¹æ“ä½œ(<code>UPDATE</code>)æ˜¯ä¸€ç§<code>DML</code>æ“ä½œ, ç”¨æ¥ä¿®æ”¹ç¬¦åˆæ¡ä»¶çš„è®°å½•</p><h4 id="åŸºç¡€ç»“æ„"><a class="markdownIt-Anchor" href="#åŸºç¡€ç»“æ„"></a> åŸºç¡€ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">UPDATE</span><br><span class="line">table_name</span><br><span class="line">SET</span><br><span class="line">column1 = value1,</span><br><span class="line">column2 = value2,</span><br><span class="line">...</span><br><span class="line">WHERE</span><br><span class="line">condition</span><br></pre></td></tr></table></figure><p>åŸºç¡€ç»“æ„æ˜¯å°†ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰è®°å½•çš„å¯¹åº”åˆ—å…¨éƒ¨ä¿®æ”¹ä¸ºå¯¹åº”å€¼, æ‰€ä»¥æ‰§è¡Œä¿®æ”¹æ“ä½œæ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„<code>condition</code>æ¡ä»¶,  <code>condition</code>æ¡ä»¶å…·ä½“ä¼šåœ¨æŸ¥è¯¢æ“ä½œä¸­è®²è§£, éœ€è¦æ³¨æ„çš„æ˜¯, <mark><code>UPDATE</code>çš„æ¡ä»¶åªèƒ½æ˜¯<code>WHERE</code>è·Ÿéšçš„æ¡ä»¶, æ— æ³•ä½¿ç”¨èšåˆå‡½æ•°æ¡ä»¶</mark></p><h4 id="å…³è”ç»“æ„"><a class="markdownIt-Anchor" href="#å…³è”ç»“æ„"></a> å…³è”ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UPDATE</span><br><span class="line">table_name1 t1</span><br><span class="line">[FULL/INNER/LEFT/RIGHT] JOIN</span><br><span class="line">table_name2 t2</span><br><span class="line">SET</span><br><span class="line">t1.column1 = t2.column1_value</span><br><span class="line">t2.column2 = 0</span><br></pre></td></tr></table></figure><p><code>UPDATE</code>çš„å…³è”ç»“æ„ä¸­, <mark>å€¼æ˜¯æ— æ³•ä½¿ç”¨èšåˆå‡½æ•°æ¥è®¡ç®—è·å¾—çš„</mark>, ä½†æ˜¯å¯ä»¥é€šè¿‡å­æŸ¥è¯¢çš„æ–¹å¼æ¥åšä¸€ä¸ªä¸´æ—¶è¡¨å®ç°</p><h3 id="æŸ¥"><a class="markdownIt-Anchor" href="#æŸ¥"></a> æŸ¥</h3><p>æŸ¥è¯¢æ“ä½œ(<code>SELECT</code>)æ˜¯<code>DQL</code>æ“ä½œ, ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­ä¿å­˜çš„è®°å½•</p><h4 id="æŸ¥è¯¢ç»“æ„"><a class="markdownIt-Anchor" href="#æŸ¥è¯¢ç»“æ„"></a> æŸ¥è¯¢ç»“æ„</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">column1, column2, ...</span><br><span class="line">FROM</span><br><span class="line">table_name_1 AS t1</span><br><span class="line">[INNER/LEFT/RIGHT] JOIN </span><br><span class="line">table_name_2 t2</span><br><span class="line">ON </span><br><span class="line">condition0</span><br><span class="line">WHERE</span><br><span class="line">condition1</span><br><span class="line">GROUP BY</span><br><span class="line">column3, column4,...</span><br><span class="line">HAVING</span><br><span class="line">condition2</span><br><span class="line">ORDER BY</span><br><span class="line">column5, column5</span><br><span class="line">LIMIT </span><br><span class="line">offset, length</span><br></pre></td></tr></table></figure><p>æœ€ç®€å•çš„<code>SQL</code>ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">column1, column2, ...</span><br><span class="line">FROM</span><br><span class="line">table_name_1 AS t1</span><br></pre></td></tr></table></figure><p>åœ¨æŸ¥è¯¢è¡¨æˆ–è€…è§†å›¾æ•°æ®æ—¶, ä¸Šè¿°ç»“æ„å°±æ˜¯ä¸å¯å†ç®€åŒ–çš„ç»“æ„, å…¶ä»–å…³é”®å­—åŠå…¶å†…å®¹æ˜¯å¯ä»¥çœç•¥çš„, åœ¨éœ€è¦æ—¶æ·»åŠ </p><h4 id="å…³é”®å­—æè¿°"><a class="markdownIt-Anchor" href="#å…³é”®å­—æè¿°"></a> å…³é”®å­—æè¿°</h4><p><code>SELECT</code></p><p>è¾“å‡º, æŸ¥è¯¢çš„åˆ—, å¯ä»¥ä½¿ç”¨<code>*</code>è¡¨ç¤ºæ‰€æœ‰åˆ—, é€šå¸¸æƒ…å†µä¸‹ä¸å»ºè®®</p><p><code>FROM</code></p><p>æŸ¥è¯¢çš„æº, è·å–æ•°æ®çš„æ¥æº, é€šå¸¸æ˜¯è¡¨æˆ–è€…è§†å›¾</p><p>å¯ä»¥é€šè¿‡<code>JOIN</code>å®¶æ—è¿›è¡Œè¡¨ä¸è¡¨, è¡¨ä¸è§†å›¾, è§†å›¾ä¸è§†å›¾ä¹‹é—´çš„å…³è”, å…¶<mark>æœ€ç»ˆç»“æœæ˜¯ä¸€ä¸ªä¸´æ—¶è¡¨</mark>, è¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹**<mark>è¡¨å…³è”</mark>ç« èŠ‚**</p><p><code>WHERE</code></p><p>è¿‡æ»¤, ä¸å¯ä½¿ç”¨èšåˆå‡½æ•°è¿‡æ»¤</p><p><code>WHERE</code>çš„è¿‡æ»¤åªèƒ½åŸºäºæ¥è‡ª<code>FROM</code>çš„ç»“æœé›†çš„<code>COLUMN</code>, è¿™æ˜¯ç”±äº<code>WHERE</code>æ‰§è¡Œåœ¨<code>SELECT</code>ä¹‹å‰, æ²¡æœ‰ä»»ä½•è®¡ç®—ç›¸å…³æ“ä½œ, ä½†æ˜¯å¯ä»¥åœ¨<code>WHERE</code>ä¸­æ‰§è¡Œéèšåˆå‡½æ•°çš„è®¡ç®—(å¦‚åŠ å‡ä¹˜é™¤, å–ä½™å–æ¨¡ç­‰)å¹¶è¿›è¡Œç»“æœåˆ¤æ–­</p><p><code>WHERE</code>ä¸­ä¸èƒ½ä½¿ç”¨åˆ—åˆ«å</p><p><code>GROUP BY</code></p><p>åˆ†ç»„, æ ¹æ®æŒ‡å®šåˆ—åˆ†ç»„, å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—, ä¸å¯ä»¥æ˜¯èšåˆæ“ä½œåˆ—</p><p><mark>æ­¤å¤„åœ¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°<code>GROUP BY</code>çš„æŠ¥é”™, è¯´<code>SELECT</code>æŸ¥è¯¢çš„<code>COLUMN</code>æ²¡æœ‰åœ¨<code>GROUP BY</code>ä¸­å‡ºç°, è¿™ä¸ªæ˜¯å¼€å¯äº†<code>ONLY_FULL_GROUP_BY</code>æ¨¡å¼çš„åŸå› </mark></p><p>ä»<code>GROUP BY</code>å¼€å§‹, å¯ä»¥ä½¿ç”¨åˆ—åˆ«å</p><p><code>HAVING</code></p><p>è¿‡æ»¤, å¯ä½¿ç”¨èšåˆå‡½æ•°çš„è¿‡æ»¤</p><p><code>HAVING</code>çš„è¿‡æ»¤çš„æ¡ä»¶æ¥è‡ªäº<code>FROM</code>çš„ç»“æœé›†+<code>SELECT</code>çš„ç»“æœé›†</p><p><code>ORDER BY</code></p><p>æ’åº, æ ¹æ®æŒ‡å®šåˆ—æ’åº, å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—, ä¹Ÿå¯ä»¥æŒ‡å®šæ¯ä¸ªåˆ—çš„å‡åºå’Œé™åº</p><p><code>ORDER BY</code>çš„æ’åºåˆ—å¯ä»¥æ¥è‡ª<code>FROM</code>çš„ç»“æœé›†, ä¹Ÿå¯ä»¥æ¥è‡ª<code>SELECT</code>çš„ç»“æœé›†</p><p><code>LIMIT</code></p><p>é™å®šä¸ªæ•°</p><p><code>offset</code>è·³è¿‡çš„è®°å½•æ•°</p><p><code>size</code>å–çš„è®°å½•æ•°</p><h4 id="æ‰§è¡Œé¡ºåº"><a class="markdownIt-Anchor" href="#æ‰§è¡Œé¡ºåº"></a> æ‰§è¡Œé¡ºåº</h4><p><code>FROM</code> -&gt; <code>WHERE</code> -&gt; <code>GROUP BY</code> -&gt; <code>HAVING</code> -&gt; <code>SELECT</code> -&gt; <code>ORDER BY</code> -&gt; <code>LIMIT</code></p><p>å…³äºæ‰§è¡Œé¡ºåºçš„é—®é¢˜å­˜åœ¨å¾ˆå¤§çš„äº‰è®®, å…¶ä¸­çš„äº‰è®®ç‚¹ä¸»è¦æ˜¯<code>SELECT</code>çš„æ‰§è¡Œä½ç½®, è¿™ä¸ªæ‰§è¡Œé¡ºåºå³ä½¿æ˜¯å®˜æ–¹ä¹Ÿæ²¡æœ‰è¯´æ˜, ä¸Šè¿°é¡ºåºæ˜¯ç½‘ä¸Šè®¤å¯åº¦æ¯”è¾ƒé«˜çš„é¡ºåº.</p><p>ä¸ªäººæƒ³æ³•:</p><p><code>SELECT</code>çš„æ‰§è¡Œä½ç½®ä¸å¯¹<code>SELECT</code>çš„è®¤è¯†æœ‰å…³, æ•´ä¸ªæŸ¥è¯¢ç»“æ„ä¸­, å°†å…³é”®å­—æŒ‰ç­‰çº§åˆ’åˆ†çš„è¯, <code>GROUP BY</code>å’Œ<code>HAVING</code>æ˜¯é™„å±æµç¨‹çš„å…³é”®å­—, å®ƒä»¬ä¸º<code>SELECT</code>å…³é”®å­—å·¥ä½œ.</p><p><code>FROM</code> -&gt; <code>WHERE</code> -&gt; <code>SELECT_PARSE</code> -&gt; <code>GROUP BY</code> -&gt; <code>SELECT_PROCESS</code> -&gt; <code>HAVING</code> -&gt; <code>SELECT_RESULT</code> -&gt; <code>ORDER BY</code> -&gt; <code>LIMIT</code></p><p><code>SELECT_PARSE</code>ä¸º<code>SELECT</code>çš„å¼€å§‹, æ­¤æ—¶åªè§£æ<code>SELECT</code>ä¸­å®šä¹‰çš„å†…å®¹, ä¸åšä»»ä½•å¤„ç†</p><p><code>GROUP BY</code>ä¸º<code>SELECT</code>è¿‡ç¨‹ä¸­çš„åˆ†ç»„è¿‡ç¨‹, æ­¤æ—¶åªæ˜¯æŒ‰å†…å®¹åšåˆ†ç»„å¤„ç†, ä¸åšè®¡ç®—</p><p><code>SELECT_PROCESS</code>ä¸º<code>SELECT</code>çš„å¤„ç†è¿‡ç¨‹, è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šåšå†…å®¹è®¡ç®—</p><p><code>HAVING</code>ä¸º<code>SELECT</code>è¿‡ç¨‹ä¸­çš„ç­›é€‰è¿‡ç¨‹, è¿™ä¸ªè¿‡ç¨‹å¯¹ä¹‹å‰çš„å¤„ç†ç»“æœè¿›è¡Œç­›é€‰å·¥ä½œ</p><p><code>SELECT_RESULT</code>ä¸º<code>SELECT</code>çš„è¾“å‡ºè¿‡ç¨‹, è¿™ä¸ªè¿‡ç¨‹æ˜¯å°†æœ€ç»ˆçš„ç»“æœè¿”å›</p><p><mark>ä»¥ä¸Šä¸ºä¸ªäººçŒœæµ‹, è¯·ç†æ€§çœ‹å¾…</mark></p><p>çŒœæµ‹çš„ä¾æ®:</p><ol><li><code>SELECT</code>ä¸­å®šä¹‰çš„åˆ«ååœ¨<code>GROUP BY</code>ä¸­å°±å¯ä»¥ä½¿ç”¨, è¿™è¯´æ˜<code>SELECT</code>ä¸­å®šä¹‰çš„å†…å®¹, åœ¨<code>GROUP BY</code>ä¹‹å‰å°±å·²ç»è§£æäº†, ä½†åº”è¯¥åªæ˜¯è§£æäº†åˆ—å, æ²¡æœ‰åšæ•°æ®å¤„ç†, å› ä¸ºèšåˆæ“ä½œçš„åˆ—éœ€è¦åœ¨åˆ†ç»„ä¹‹åå¤„ç†, åœ¨<code>GROUP BY</code>ä¸­ä½¿ç”¨èšåˆæ“ä½œåˆ—åˆ†ç»„æ—¶ä¼šæŠ¥é”™ <code>=&gt;</code>  <code>SELECT_PARSE</code> -&gt; <code>GROUP BY</code> -&gt; <code>SELECT_PROCESS</code></li><li><code>SELECT</code>åœ¨è§£ææ—¶, ä¸ä»…ä»…è§£æäº†<code>SELECT</code>ä¸­å®šä¹‰çš„åˆ—, è¿˜åŒ…æ‹¬æºæ•°æ®(æ¥è‡ªäº<code>FROM</code>çš„æ•°æ®)ä¸­çš„åˆ—, å¹¶è¿›è¡Œäº†åˆå¹¶, å¯ä»¥é€šè¿‡<code>GROUP BY</code>å’Œ<code>HAVING</code>éªŒè¯</li><li><code>HAVING</code>å’Œ<code>SELECT_RESULT</code>è¿™ä¸¤ä¸ªè¿‡ç¨‹å…¶å®ä¸å¤ªæ˜ç¡®äº†, å³ä½¿è°ƒæ¢ç†è®ºä¸Šä¹Ÿæ²¡æœ‰é”™è¯¯, å‚è€ƒ<code>WHERE</code>çš„ç­›é€‰, åº”è¯¥æ˜¯åœ¨è¾“å‡ºç»“æœä¹‹å‰</li></ol><p>å¯å‚è€ƒ:</p><p><a href="https://builtin.com/data-science/sql-order-of-execution">https://builtin.com/data-science/sql-order-of-execution</a></p><p><a href="https://stackoverflow.com/questions/24127932/mysql-query-clause-execution-order">https://stackoverflow.com/questions/24127932/mysql-query-clause-execution-order</a></p><h3 id="èšåˆå‡½æ•°"><a class="markdownIt-Anchor" href="#èšåˆå‡½æ•°"></a> èšåˆå‡½æ•°</h3><h4 id="count"><a class="markdownIt-Anchor" href="#count"></a> COUNT</h4><p>è®¡æ•°</p><p>ä¸è®°å½•<code>NULL</code>å€¼, å¦‚æœåœ¨æŸ¥è¯¢ä¹‹åè¿›è¡Œäº†åˆ†ç»„ç„¶åè®¡ç®—<code>COUNT</code>, <code>COUNT</code>çš„åˆ—ä¸­å¦‚æœæœ‰ä¸º<code>NULL</code>çš„è®°å½•, åˆ™è¯¥è®°å½•ä¸è®¡ç®—åœ¨å†…, ç»“æœæ¯”<code>COUNT(1), COUNT(*)</code>å°</p><p><code>COUNT</code>ä¸­çš„åˆ—å¦‚æœä½¿ç”¨<code>DISTINCT</code>, åˆ™ä¼šå»é‡</p><h4 id="sum"><a class="markdownIt-Anchor" href="#sum"></a> SUM</h4><p>æ±‚å’Œ</p><p>ä¸è®°å½•<code>NULL</code>å€¼</p><p>è®¡ç®—å­—ç¬¦ä¸²æ—¶, ä¼šè½¬ä¸º0</p><h4 id="max"><a class="markdownIt-Anchor" href="#max"></a> MAX</h4><p>æœ€å¤§å€¼</p><p>ä¸è®°å½•<code>NULL</code>å€¼</p><h4 id="min"><a class="markdownIt-Anchor" href="#min"></a> MIN</h4><p>æœ€å°å€¼</p><p>ä¸è®°å½•<code>NULL</code>å€¼</p><h4 id="avg"><a class="markdownIt-Anchor" href="#avg"></a> AVG</h4><p>å¹³å‡å€¼</p><p>ä¸è®°å½•<code>NULL</code>å€¼</p><h4 id="group_concat"><a class="markdownIt-Anchor" href="#group_concat"></a> GROUP_CONCAT</h4><p>å­—ç¬¦ä¸²åˆ†ç»„æ‹¼æ¥, ä½¿ç”¨<code>,</code>ä½œä¸ºåˆ†éš”ç¬¦</p><h3 id="ç»“æ„å…³é”®å­—"><a class="markdownIt-Anchor" href="#ç»“æ„å…³é”®å­—"></a> ç»“æ„å…³é”®å­—</h3><h4 id="case-when"><a class="markdownIt-Anchor" href="#case-when"></a> CASE WHEN</h4><p>ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- 1. å˜é‡å½¢å¼</span><br><span class="line">CASE å˜é‡</span><br><span class="line">WHEN å€¼ THEN ...</span><br><span class="line">WHEN å€¼ THEN ...</span><br><span class="line">ELSE ...</span><br><span class="line">END</span><br><span class="line">-- 2. è¡¨è¾¾å¼å½¢å¼</span><br><span class="line">CASE</span><br><span class="line">WHEN condition THEN ...</span><br><span class="line">WHEN condition THEN ...</span><br><span class="line">ELSE ...</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>ç‰¹æ®Šçš„ä½¿ç”¨<code>CASE WEHN</code>+èšåˆå‡½æ•°å¯ä»¥å°†çºµå‘è®°å½•æ¨ªå‘åŒ–</p><table><thead><tr><th>name</th><th>subject</th><th>score</th></tr></thead><tbody><tr><td>èµµ</td><td>è¯­</td><td>1</td></tr><tr><td>é’±</td><td>è¯­</td><td>2</td></tr><tr><td>å­™</td><td>è¯­</td><td>1</td></tr><tr><td>æ</td><td>è¯­</td><td>2</td></tr><tr><td>èµµ</td><td>æ•°</td><td>3</td></tr><tr><td>é’±</td><td>æ•°</td><td>3</td></tr><tr><td>å­™</td><td>æ•°</td><td>2</td></tr><tr><td>æ</td><td>æ•°</td><td>2</td></tr><tr><td>èµµ</td><td>å¤–</td><td>2</td></tr><tr><td>é’±</td><td>å¤–</td><td>3</td></tr><tr><td>å­™</td><td>å¤–</td><td>3</td></tr><tr><td>æ</td><td>å¤–</td><td>2</td></tr></tbody></table><p>è½¬ä¸º</p><table><thead><tr><th>name</th><th>è¯­</th><th>æ•°</th><th>å¤–</th></tr></thead><tbody><tr><td>èµµ</td><td>1</td><td>3</td><td>2</td></tr><tr><td>é’±</td><td>2</td><td>3</td><td>3</td></tr><tr><td>å­™</td><td>1</td><td>2</td><td>3</td></tr><tr><td>æ</td><td>2</td><td>2</td><td>2</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">MAX(</span><br><span class="line">    CASE subject</span><br><span class="line">        WHEN &#x27;è¯­&#x27; THEN score</span><br><span class="line">        ELSE NULL</span><br><span class="line">        END</span><br><span class="line">    ) AS &#x27;è¯­&#x27;,</span><br><span class="line">MAX(</span><br><span class="line">    CASE subject</span><br><span class="line">        WHEN &#x27;æ•°&#x27; THEN score</span><br><span class="line">        ELSE NULL</span><br><span class="line">        END</span><br><span class="line">    ) AS &#x27;æ•°&#x27;,</span><br><span class="line">MAX(</span><br><span class="line">    CASE subject</span><br><span class="line">        WHEN &#x27;å¤–&#x27; THEN score</span><br><span class="line">        ELSE NULL</span><br><span class="line">        END</span><br><span class="line">    ) AS &#x27;å¤–&#x27;</span><br><span class="line">FROM score</span><br><span class="line">GROUP BY name;</span><br></pre></td></tr></table></figure><p>æ¯ä¸€åˆ—ç”¨<code>CASE WHEN</code>å°†é™¤äº†ç¬¦åˆç§‘ç›®æ¡ä»¶çš„è®°å½•çš„æˆç»©è¾“å‡º, å¦åˆ™ä¸º<code>NULL</code></p><p>å¾—åˆ°</p><table><thead><tr><th>name</th><th>è¯­</th><th>æ•°</th><th>å¤–</th></tr></thead><tbody><tr><td>èµµ</td><td>1</td><td>NULL</td><td>NULL</td></tr><tr><td>é’±</td><td>2</td><td>NULL</td><td>NULL</td></tr><tr><td>å­™</td><td>1</td><td>NULL</td><td>NULL</td></tr><tr><td>æ</td><td>2</td><td>NULL</td><td>NULL</td></tr><tr><td>èµµ</td><td>NULL</td><td>3</td><td>NULL</td></tr><tr><td>é’±</td><td>NULL</td><td>3</td><td>NULL</td></tr><tr><td>å­™</td><td>NULL</td><td>2</td><td>NULL</td></tr><tr><td>æ</td><td>NULL</td><td>2</td><td>NULL</td></tr><tr><td>èµµ</td><td>NULL</td><td>NULL</td><td>2</td></tr><tr><td>é’±</td><td>NULL</td><td>NULL</td><td>3</td></tr><tr><td>å­™</td><td>NULL</td><td>NULL</td><td>3</td></tr><tr><td>æ</td><td>NULL</td><td>NULL</td><td>2</td></tr></tbody></table><p>ä½¿ç”¨åˆ†ç»„<code>MAX</code>, å¾—åˆ°æ¯ä¸ªäººæ¯ä¸€ç§‘ç›®çš„<code>MAX</code>, ç”±äº<code>NULL</code>ä¸çº³å…¥è®¡ç®—, æ‰€ä»¥å¾—åˆ°æœ€å¤§å€¼å°±æ˜¯å”¯ä¸€å€¼</p><h3 id="è¡¨å…³è”"><a class="markdownIt-Anchor" href="#è¡¨å…³è”"></a> è¡¨å…³è”</h3><h4 id="å…³è”ç»“æ„-2"><a class="markdownIt-Anchor" href="#å…³è”ç»“æ„-2"></a> å…³è”ç»“æ„</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span></span><br><span class="line">table_1</span><br><span class="line">[<span class="keyword">INNER</span><span class="operator">/</span><span class="keyword">LEFT</span><span class="operator">/</span><span class="keyword">RIGHT</span>] <span class="keyword">JOIN</span></span><br><span class="line">table_2</span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">condition</span></span><br></pre></td></tr></table></figure><h4 id="å…³é”®å­—"><a class="markdownIt-Anchor" href="#å…³é”®å­—"></a> å…³é”®å­—</h4><p>è¿æ¥åˆ†ä¸ºå†…è¿æ¥å’Œå¤–è¿æ¥</p><p><code>[INNER] JOIN</code>: å†…è¿æ¥, é€šè¿‡<code>ON</code>æ¥è¿›è¡Œæ¡ä»¶åŒ¹é…, å…¶è¿”å›ç»“æœæ˜¯ä¸¤ä¸ªå…³è”çš„è¡¨ä¸­å­˜åœ¨äº’ç›¸å…³è”çš„æ•°æ®, å³ä¸¤ä¸ªè¡¨çš„äº¤é›†.<mark>å†…è¿æ¥ä¹Ÿå¯ä»¥æ²¡æœ‰<code>ON</code>æ¡ä»¶, é€šè¿‡<code>WHERE</code>æ¡ä»¶è¯­å¥å®ç°</mark>, å½“æ—¶ç”¨å†…è¿æ¥å…³è”æ—¶, ä½¿ç”¨<code>ON</code>å…³è”ä¸ä½¿ç”¨<code>WHERE</code>å…³è”æ˜¯ä¸€è‡´çš„, æ‰§è¡Œæ—¶ä¼šå°†<code>ON</code>å…³è”ä¼˜åŒ–ä¸º<code>WHERE</code>å…³è”</p><p><code>LEFT/RIGHT JOIN</code>: å¤–è¿æ¥ é€šè¿‡<code>ON</code>æ¥è¿›è¡Œæ¡ä»¶åŒ¹é…, å…¶è¿”å›ç»“æœæ˜¯ä¸¤ä¸ªå…³è”çš„è¡¨ä¸­ä»¥å…¶ä¸­ä¸€å¼ è¡¨ä¸ºåŸºç¡€, é€šè¿‡å¦ä¸€å¼ è¡¨æ·»åŠ é™„å±æ•°æ®, å¯ä»¥ä¸å­˜åœ¨é™„å±æ•°æ®, <mark>å¤–è¿æ¥å¿…é¡»åŒ…å«<code>ON</code>æ¡ä»¶</mark></p><p><img src="JOIN%E9%9B%86%E5%90%88.jpg" alt="JOINé›†åˆ" /></p><blockquote><p>ä¸Šé¢æ˜¯ç½‘ä¸Šçš„å¸¸ç”¨çš„<code>JOIN</code>é›†åˆå›¾, å…±æœ‰å…¶ä¸­æƒ…å†µ, å…¶ä¸­<code>1, 2, 3</code>è¿™ä¸‰ç§æƒ…å†µæ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„åœºæ™¯</p><p>æƒ…å†µ<code>4, 5</code>æ˜¯å•è¡¨å»é™¤äº†å…¬å…±éƒ¨åˆ†, éœ€è¦æ³¨æ„, è¿™ä¸¤ç§æƒ…å†µå¦‚æœéœ€è¦çš„åˆ°, å…³è”æ˜¯å¿…é¡»çš„, è¿™éœ€è¦åŒºåˆ†ä¸€ä¸‹ä¸¤æ¡è¯­å¥(ä»¥<code>LEFT JOIN</code>ä¸ºä¾‹):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- å•è¡¨</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableA A</span><br><span class="line">WHERE A.key IS NULL;</span><br><span class="line">-- å…³è”è¡¨</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableA A</span><br><span class="line">LEFT JOIN tableB B</span><br><span class="line">ON A.key = B.key</span><br><span class="line">WHERE B.key IS NULL;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤æ¡è¯­å¥çš„ç»“æœé›†æ˜¯ä¸ä¸€æ ·çš„, åœ¨å…³è”çš„æŸ¥è¯¢æ–¹å¼ä¸­, å¦‚æœ<code>tableA</code>çš„<code>key</code>æ˜¯å­˜åœ¨çš„, ä½†æ˜¯<code>tableB</code>ä¸­ä¸å­˜åœ¨å¯¹åº”çš„è®°å½•, åˆ™è¯¥è®°å½•ä¸ä¼šè®°å½•åœ¨å†…, å…¶æ•°æ®é‡æ˜¯å¤§äºç­‰äºå•è¡¨æŸ¥è¯¢æ–¹å¼çš„</p><p><img src="%E5%8D%95%E4%BE%A7%E5%8D%95%E8%A1%A8%E6%9F%A5%E8%AF%A2.jpg" alt="å•ä¾§å•è¡¨æŸ¥è¯¢" /></p><p>å‡è®¾çº¢è‰²åŒºåŸŸæ˜¯<code>tableA</code>ä¸­å­˜åœ¨<code>key</code>, ä½†æ˜¯<code>tableB</code>ä¸­ä¸å­˜åœ¨å¯¹åº”<code>key</code>çš„è®°å½•, é‚£ä¹ˆ, å•è¡¨çš„æŸ¥è¯¢ç»“æœ=è“è‰²åŒºåŸŸ - çº¢è‰²åŒºåŸŸ</p><p>æƒ…å†µ<code>6, 7</code>åœ¨<code>mysql</code>ä¸­æ˜¯ä¸æ”¯æŒè¿™ç§å†™æ³•çš„, ä½†æ˜¯å¯ä»¥é€šè¿‡<code>UNION</code>å®ç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- æƒ…å†µ6 = æƒ…å†µ2 + æƒ…å†µ3 - æƒ…å†µ1(-æƒ…å†µ1æ˜¯å»é‡)</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableA A </span><br><span class="line">LEFT JOIN tableB B</span><br><span class="line">ON A.key = B.key</span><br><span class="line">UNION -- å»é‡</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableB A</span><br><span class="line">RIGHT JOIN tableB B</span><br><span class="line">ON A.key = B.key;</span><br><span class="line">-- æƒ…å†µ7 = æƒ…å†µ4 + æƒ…å†µ5</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableA A </span><br><span class="line">LEFT JOIN tableB B</span><br><span class="line">ON A.key = B.key</span><br><span class="line">WHERE B.key IS NULL</span><br><span class="line">UNION -- å»é‡</span><br><span class="line">SELECT &lt;auswahl&gt;</span><br><span class="line">FROM tableB A</span><br><span class="line">RIGHT JOIN tableB B</span><br><span class="line">ON A.key = B.key</span><br><span class="line">WHERE A.key IS NULL;</span><br></pre></td></tr></table></figure></blockquote><p>ä¸‹é¢çš„æ–¹å¼å¯ä»¥å®ç°ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥å…³è”å­—æ®µçš„å…³è”, ä½†å—é™äº<code>help_topic</code>æ•°å€¼, æ‹¼æ¥å­—æ®µçš„ä¸ªæ•°åªèƒ½åœ¨600ä¸ªå·¦å³</p><p>å¦‚<code>user</code>è¡¨ä¸­æŸä¸ªç”¨æˆ·çš„<code>role_ids</code>çš„å€¼ä¸º<code>1,3,5</code>, åˆ™è¯¥ç”¨æˆ·ä½¿ç”¨ä¸€ä¸‹æ–¹å¼æ—¶, å¯ä»¥å®ç°</p><table><thead><tr><th>user</th><th>role</th></tr></thead><tbody><tr><td>user</td><td>role_first</td></tr><tr><td>user</td><td>role_third</td></tr><tr><td>user</td><td>role_fifth</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">u.id as uid, u.name as username, r.id as rid, r.name as role_name</span><br><span class="line">FROM </span><br><span class="line">user u </span><br><span class="line">LEFT JOIN</span><br><span class="line">role r</span><br><span class="line">ON r.id = ANY(</span><br><span class="line">SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(u.role_ids,&#x27;,&#x27;,help_topic_id+1),&#x27;,&#x27;,-1)</span><br><span class="line">FROM mysql.help_topic h</span><br><span class="line">WHERE h.help_topic_id &lt; LENGTH(u.role_ids) - LENGTH(REPLACE(u.role_ids,&#x27;,&#x27;,&#x27;&#x27;)) + 1</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨é€‰æ‹©"><a class="markdownIt-Anchor" href="#ä½¿ç”¨é€‰æ‹©"></a> ä½¿ç”¨é€‰æ‹©</h4><p>å†…è¿æ¥å’Œå¤–è¿æ¥çš„æ•°æ®é›†æ˜¯ä¸åŒçš„, åœ¨ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®éœ€æ±‚è¿›è¡Œé€‰æ‹©</p><p>å¯ä»¥é€šè¿‡æŸ¥è¯¢æ•°æ®çš„è¦æ±‚, å¯»æ±‚è¡¨ä¹‹é—´æ˜¯å¦éœ€è¦æœ‰ä¸»æ¬¡å…³ç³», è¿™ç§ä¸»æ¬¡å…³ç³»å¹¶ä¸æ˜¯è¡¨çš„ä¸»æ¬¡å…³ç³», è€Œæ˜¯éœ€æ±‚ä¸Šéœ€ä¸éœ€è¦è¡¨å­˜åœ¨ä¸»æ¬¡å…³ç³»</p><p>æ¯”å¦‚ä»¥ä¸Šé¢çš„è¡¨ç»“æ„ä¸ºä¾‹</p><blockquote><p>éœ€æ±‚ä¸€: æŸ¥è¯¢ç”¨æˆ·è§’è‰², æºå¸¦ç”¨æˆ·ä¿¡æ¯</p><p>éœ€æ±‚äºŒ: æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨, æºå¸¦è§’è‰²ä¿¡æ¯</p><p>éœ€æ±‚ä¸‰: æŸ¥è¯¢è§’è‰²åˆ—è¡¨, æºå¸¦ç›¸å…³ç”¨æˆ·</p></blockquote><p>éœ€æ±‚ä¸€: ä¸¤ä¸ªè¡¨åœ¨éœ€æ±‚ä¸Šæ˜¯ä¸å­˜åœ¨ä¸»æ¬¡å…³ç³»çš„, æŸ¥è¯¢çš„å†…å®¹æ˜¯æ¥è‡ªäºè§’è‰²è¡¨, è¢«åŠ¨ä¸»ä½“æ˜¯ç”¨æˆ·è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">u.name, r.name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line"><span class="keyword">user</span> u</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">role r</span><br><span class="line"><span class="keyword">ON</span> r.id <span class="operator">=</span> <span class="keyword">ANY</span>(</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(SUBSTRING_INDEX(u.role_ids,<span class="string">&#x27;,&#x27;</span>,help_topic_id<span class="operator">+</span><span class="number">1</span>),<span class="string">&#x27;,&#x27;</span>,<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">FROM</span> mysql.help_topic h</span><br><span class="line"><span class="keyword">WHERE</span> h.help_topic_id <span class="operator">&lt;</span> LENGTH(u.role_ids) <span class="operator">-</span> LENGTH(REPLACE(u.role_ids,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>)) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">u.id <span class="operator">=</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨ä¸­é—´è¡¨åšå…³è”æ—¶</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">u.name, r.name</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line"><span class="keyword">user</span> u</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">user_role ur</span><br><span class="line"><span class="keyword">ON</span> u.id <span class="operator">=</span> ur.user_id</span><br><span class="line"><span class="keyword">JOIN</span></span><br><span class="line">role r</span><br><span class="line"><span class="keyword">ON</span> r.id <span class="operator">=</span> ur.role_id</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">u.id <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢çš„ç»“æœå®é™…æ˜¯è¡¨å…³è”ä¸­ç¬¦åˆè¦æ±‚çš„äº¤é›†éƒ¨åˆ†, å½“æ²¡æœ‰ç¬¦åˆå…³è”æ¡ä»¶çš„è®°å½•æ—¶, è¿”å›ç©º</p><p>éœ€æ±‚äºŒ: ä¸¤ä¸ªè¡¨åœ¨éœ€æ±‚ä¸Šæ˜¯é™„å±å…³ç³»çš„, æŸ¥è¯¢çš„å†…å®¹å®é™…æ˜¯ç”¨æˆ·å†…å®¹, è€Œè§’è‰²ä¿¡æ¯æ˜¯é™„å±å†…å®¹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">u.name, GROUP_CONCAT(r.name)</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line"><span class="keyword">user</span> u</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line">role r</span><br><span class="line"><span class="keyword">ON</span> r.id <span class="operator">=</span> <span class="keyword">ANY</span>(</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(SUBSTRING_INDEX(u.role_ids,<span class="string">&#x27;,&#x27;</span>,help_topic_id<span class="operator">+</span><span class="number">1</span>),<span class="string">&#x27;,&#x27;</span>,<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">FROM</span> mysql.help_topic h</span><br><span class="line"><span class="keyword">WHERE</span> h.help_topic_id <span class="operator">&lt;</span> LENGTH(u.role_ids) <span class="operator">-</span> LENGTH(REPLACE(u.role_ids,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>)) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> u.id</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢çš„ç»“æœå®é™…ä¸Šæ˜¯ç”¨æˆ·çš„å†…å®¹, éœ€è¦å°†æœ‰è§’è‰²ä¿¡æ¯çš„ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ä¸€èµ·æŸ¥è¯¢å‡ºæ¥, ç”¨æˆ·æ²¡æœ‰è§’è‰²ä¿¡æ¯ä¹ŸæŸ¥è¯¢å‡ºæ¥, ä½†è§’è‰²ä¿¡æ¯å±•ç¤ºä¸ºç©º</p><p>éœ€æ±‚ä¸‰: ä¸¤ä¸ªè¡¨åœ¨éœ€æ±‚ä¸Šæ˜¯è´Ÿæ•°å…³ç³»çš„, æŸ¥è¯¢çš„å†…å®¹å®é™…æ˜¯è§’è‰²ä¿¡æ¯, ç”¨æˆ·ä¿¡æ¯æ˜¯é™„å±å†…å®¹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">r.name, GROUP_CONCAT(u.name)</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">role r</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span></span><br><span class="line"><span class="keyword">user</span> u</span><br><span class="line"><span class="keyword">ON</span> r.id <span class="operator">=</span> <span class="keyword">ANY</span>(</span><br><span class="line"><span class="keyword">SELECT</span> SUBSTRING_INDEX(SUBSTRING_INDEX(u.role_ids,<span class="string">&#x27;,&#x27;</span>,help_topic_id<span class="operator">+</span><span class="number">1</span>),<span class="string">&#x27;,&#x27;</span>,<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">FROM</span> mysql.help_topic h</span><br><span class="line"><span class="keyword">WHERE</span> h.help_topic_id <span class="operator">&lt;</span> LENGTH(u.role_ids) <span class="operator">-</span> LENGTH(REPLACE(u.role_ids,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>)) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> r.id</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢çš„ç»“æœå®é™…ä¸Šæ˜¯è§’è‰²çš„å†…å®¹, å°†æœ‰å…³è”ç”¨æˆ·çš„è§’è‰², å°†å…³è”çš„ç”¨æˆ·ä¸€èµ·æŸ¥è¯¢å‡ºæ¥, è§’è‰²æ²¡æœ‰å…³è”ç”¨æˆ·ä¹ŸæŸ¥è¯¢å‡ºæ¥, ä½†ç”¨æˆ·ä¿¡æ¯å±•ç¤ºä¸ºç©º</p><h3 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜ğŸ˜­</h3><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL, SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¡¹ç›®å¯¹æ¥æ‹›å•†é“¶è¡ŒCBS</title>
      <link href="/2024/02/21/other/%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%8E%A5%E6%8B%9B%E5%95%86%E9%93%B6%E8%A1%8CCBS/"/>
      <url>/2024/02/21/other/%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%8E%A5%E6%8B%9B%E5%95%86%E9%93%B6%E8%A1%8CCBS/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å¹´å‰ç»™å…¬å¸ç³»ç»Ÿå¯¹æ¥äº†ä¸€ä¸‹æ‹›å•†é“¶è¡Œçš„<code>CBS</code>ç³»ç»Ÿ, å¯¹æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„, åªæ˜¯æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ä¸œè¥¿, æ•´ç†ä¸€ç¯‡æ–‡ç« ç®€å•è®°å½•ä¸€ä¸‹</p><p>å¯¹æ¥çš„å†…å®¹ä¸Šç›®å‰æ˜¯åªå¯¹æ¥äº†<mark>æ”¯ä»˜</mark>, <mark>æ”¯ä»˜ç»“æœ</mark>, <mark>ç”µå­å›å•</mark>, <mark>äº¤æ˜“æ˜ç»†</mark>. åä¸‰è€…è¿‡ç¨‹å¤§è‡´ç±»ä¼¼, å°±ä»¥æ”¯ä»˜ç»“æœä¸ºä¾‹, ç‰¹åˆ«ç‚¹ä¼šè¿›è¡Œé¢å¤–æè¿°</p><p>ç›¸å…³æ–‡ä»¶</p><p><a href="cbs.7z" download="Demo.7z">å®˜æ–¹Demo</a></p><p><a href="CBS8è´¢èµ„äº‘ä¸šåŠ¡å¯¹æ¥æŒ‡å—.docx" download="CBS8è´¢èµ„äº‘ä¸šåŠ¡å¯¹æ¥æŒ‡å—.docx">CBS8è´¢èµ„äº‘ä¸šåŠ¡å¯¹æ¥æŒ‡å—.docx</a></p><p><a href="æµ‹è¯•èµ„æº.docx" download="æµ‹è¯•èµ„æº.docx">æµ‹è¯•èµ„æº.docx</a></p><h3 id="å‰æ"><a class="markdownIt-Anchor" href="#å‰æ"></a> å‰æ</h3><ol><li>å·²ç»åœ¨æ‹›å•†é“¶è¡Œçš„<code>CBS</code>ä¸­æ³¨å†Œä¼ä¸šç”¨æˆ·, è·å–åˆ°<code>app-id</code>å’Œå¯†é’¥ç­‰ä¿¡æ¯</li><li>ä½¿ç”¨çš„è´¦æˆ·å·²ç»æ³¨å†Œåˆ°æ‹›å•†é“¶è¡Œ<code>CBS</code>çš„æ³¨å†Œä¼ä¸šç”¨æˆ·ä¸­</li></ol><p>è¿™ä¸¤ä¸ªæ¡ä»¶ä¿è¯äº†ä¼ä¸šåœ¨æ‹›å•†é“¶è¡Œ<code>CBS</code>ç³»ç»Ÿä¸­çš„ä½¿ç”¨æƒé™å’Œå¯æ“ä½œè´¦æˆ·</p><p>å¦‚æœä¼ä¸šä½¿ç”¨äº†å…¶ä»–é“¶è¡Œçš„é“¶è¡Œå¡è´¦æˆ·, åº”è”ç³»æ‹›å•†é“¶è¡Œ, è®©å…¶è¿›è¡Œç›®æ ‡é“¶è¡Œçš„å¯¹æ¥å·¥ä½œ, è¿™æ ·æ­¤å¤„å°±åªéœ€è¦å¯¹æ¥æ‹›å•†é“¶è¡Œçš„<code>CBS</code>ç³»ç»Ÿå³å¯</p><h3 id="åŸºç¡€é…ç½®"><a class="markdownIt-Anchor" href="#åŸºç¡€é…ç½®"></a> åŸºç¡€é…ç½®</h3><p>å‰é¢è®²åˆ°å°†ä¼ä¸šæ³¨å†Œä¸ºä¼ä¸šç”¨æˆ·, è·å–åˆ°<code>app-id</code>å’Œå¯†é’¥ç­‰ä¿¡æ¯, è¿™äº›ä¿¡æ¯æˆ‘ä»¬éœ€è¦é…ç½®åˆ°ç³»ç»Ÿä¸­, ç”¨æ¥è¿›è¡Œå¯¹æ¥</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cbs:</span></span><br><span class="line">  <span class="attr">app-id:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="attr">app-secret:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="comment">#å¹³å°å…¬é’¥</span></span><br><span class="line">  <span class="attr">platform-public-key:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="comment">#å…¬å¸å…¬é’¥</span></span><br><span class="line">  <span class="attr">firm-public-key:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="comment">#å…¬å¸ç§é’¥</span></span><br><span class="line">  <span class="attr">firm-private-key:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="comment">#CBSè¯·æ±‚åŸŸå</span></span><br><span class="line">  <span class="attr">open-api-url:</span> <span class="string">https://tmcapi.cmbchina.com</span></span><br><span class="line">  <span class="comment">#æ”¯ä»˜æ¥å£è·¯å¾„</span></span><br><span class="line">  <span class="attr">payment-url:</span> <span class="string">/openapi/payment/openapi/v1/payment-apply-common</span></span><br><span class="line">  <span class="comment"># æŸ¥è¯¢æ”¯ä»˜çš„å®é™…æ”¯ä»˜ç»“æœ</span></span><br><span class="line">  <span class="attr">payment-query-url:</span> <span class="string">/openapi/payment/openapi/v1/query</span></span><br><span class="line">  <span class="comment">#ç”µå­å›å•</span></span><br><span class="line">  <span class="attr">payment-receipt-url:</span> <span class="string">/openapi/account/openapi/v1/electronic-bill/query</span></span><br><span class="line">  <span class="comment">#äº¤æ˜“è¯¦æƒ…</span></span><br><span class="line">  <span class="attr">transaction-detail-url:</span> <span class="string">/openapi/account/openapi/v1/transaction-detail/query</span></span><br><span class="line">  <span class="attr">get-token-url:</span> <span class="string">/openapi/app/v1/app/token</span></span><br><span class="line">  <span class="attr">refresh-token-url:</span> <span class="string">/openapi/app/v1/app/refresh-token</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;cbs8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CBSConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String appSecret;</span><br><span class="line">    <span class="comment">// å¹³å°å…¬é’¥</span></span><br><span class="line">    <span class="keyword">private</span> String platformPublicKey;</span><br><span class="line">    <span class="comment">// å…¬å¸å…¬é’¥</span></span><br><span class="line">    <span class="keyword">private</span> String firmPublicKey;</span><br><span class="line">    <span class="comment">// å…¬å¸ç§é’¥</span></span><br><span class="line">    <span class="keyword">private</span> String firmPrivateKey;</span><br><span class="line">    <span class="comment">// CBSè¯·æ±‚åŸŸå</span></span><br><span class="line">    <span class="keyword">private</span> String openApiUrl;</span><br><span class="line">    <span class="comment">// æ”¯ä»˜æ¥å£è·¯å¾„</span></span><br><span class="line">    <span class="keyword">private</span> String paymentUrl;</span><br><span class="line">    <span class="comment">// ç”µå­å›å•</span></span><br><span class="line">    <span class="keyword">private</span> String paymentReceiptUrl;</span><br><span class="line">    <span class="comment">// äº¤æ˜“è¯¦æƒ…</span></span><br><span class="line">    <span class="keyword">private</span> String transactionDetailUrl;</span><br><span class="line">    <span class="comment">// è·å–TOKEN</span></span><br><span class="line">    <span class="keyword">private</span> String getTokenUrl;</span><br><span class="line">    <span class="comment">// åˆ·æ–°TOKEN</span></span><br><span class="line">    <span class="keyword">private</span> String refreshTokenUrl;</span><br><span class="line"><span class="comment">// æ”¯ä»˜ç»“æœæŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">private</span> String paymentQueryUrl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¬å…±å†…å®¹"><a class="markdownIt-Anchor" href="#å…¬å…±å†…å®¹"></a> å…¬å…±å†…å®¹</h3><h4 id="token"><a class="markdownIt-Anchor" href="#token"></a> <code>TOKEN</code></h4><p>è·å–<code>token</code>å’Œåˆ·æ–°<code>token</code>, æ­¤å¤„ä½¿ç”¨<code>Redis</code>å­˜å‚¨<code>token</code>ä¿¡æ¯, <code>CBS</code>ç³»ç»Ÿçš„<code>token</code>æœ‰æ•ˆæ—¶é•¿ä¸º30åˆ†é’Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CBSTokenUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tokenä¿å­˜mapçš„key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN_INFO_KEY</span> <span class="operator">=</span> <span class="string">&quot;cbs_docking_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tokenåœ¨mapä¸­çš„key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN_KEY</span> <span class="operator">=</span> <span class="string">&quot;token&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXPIRES</span> <span class="operator">=</span> <span class="string">&quot;expires&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SAVE_TIME</span> <span class="operator">=</span> <span class="string">&quot;save_time&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é¢„ç•™è¿‡æœŸæ—¶é—´, 5åˆ†é’Ÿ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESERVE_TIME</span> <span class="operator">=</span> <span class="number">5</span> * <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REFRESH_TIME</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token çš„æœ‰æ•ˆæ—¶é•¿, 30åˆ†é’Ÿ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EFFECTIVE_TIME</span> <span class="operator">=</span> <span class="number">10</span> * <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CBSConfig cbsConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">token</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> (String) redisUtil.hget(TOKEN_INFO_KEY, TOKEN_KEY);</span><br><span class="line">        <span class="comment">// å½“å‰ç³»ç»Ÿæ—¶é—´, ç§’</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœtokenä¸ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!expires(l)) &#123;</span><br><span class="line">                <span class="keyword">return</span> token;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> getTokenInfo();</span><br><span class="line">        token = tokenInfo.getString(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">expires</span> <span class="operator">=</span> tokenInfo.getInteger(<span class="string">&quot;expires&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ·æ–°token</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != expires) &#123;</span><br><span class="line">            <span class="comment">// è¿‡æœŸæ—¶é—´å°äº4ç§’, åˆ™ç­‰å¾…é‡æ–°è·å–</span></span><br><span class="line">            <span class="keyword">if</span> (expires &lt; REFRESH_TIME) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;expires: &#123;&#125;; ç­‰å¾…: &#123;&#125;&quot;</span>, expires, REFRESH_TIME + <span class="number">1</span>);</span><br><span class="line">                    Thread.sleep((REFRESH_TIME + <span class="number">1</span>) * <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;ç­‰å¾…å¼‚å¸¸: &quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                tokenInfo = getTokenInfo();</span><br><span class="line">                token = tokenInfo.getString(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">                expires = tokenInfo.getInteger(<span class="string">&quot;expires&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿‡æœŸæ—¶é—´å°äºäº”åˆ†é’Ÿåˆ·æ–°token</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (expires &lt; RESERVE_TIME) &#123;</span><br><span class="line">                <span class="type">JSONObject</span> <span class="variable">refreshTokenInfo</span> <span class="operator">=</span> refreshTokenInfo(token);</span><br><span class="line">                token = refreshTokenInfo.getString(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">                expires = refreshTokenInfo.getInteger(<span class="string">&quot;expires&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setToken(expires, token, l);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">expires</span><span class="params">(<span class="type">long</span> current)</span> &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰æ—¶é—´ - tokençš„è·å–æ—¶é—´</span></span><br><span class="line">        <span class="comment">// è¿‡æœŸæ—¶é—´ ç§’</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">redisExpires</span> <span class="operator">=</span> (Integer) redisUtil.hget(TOKEN_INFO_KEY, EXPIRES);</span><br><span class="line">        <span class="type">long</span> <span class="variable">exp</span> <span class="operator">=</span> redisExpires == <span class="literal">null</span> ? <span class="number">0L</span> : redisExpires;</span><br><span class="line">        <span class="comment">// ä¸Šæ¬¡ä¿å­˜æ—¶é—´ ç§’</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">saveTime</span> <span class="operator">=</span> (Integer) redisUtil.hget(TOKEN_INFO_KEY, SAVE_TIME);</span><br><span class="line">        <span class="comment">// è®¡ç®—ç»“æœ ç§’ ä¸Šæ¬¡ä¿å­˜æ—¶é—´ä¸ºnullåˆ™ç”¨0</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> saveTime == <span class="literal">null</span> ? <span class="number">0L</span> : current - saveTime;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¡ç®—ç»“æœ &gt;= è¿‡æœŸæ—¶é—´, åˆ™è¿‡æœŸ</span></span><br><span class="line">        <span class="comment">// å½“å‰æ—¶é—´ - ä¸Šæ¬¡ä¿å­˜æ—¶é—´ &gt;= æœ‰æ•ˆæ—¶é•¿ åˆ™è¿‡æœŸ</span></span><br><span class="line">        log.info(<span class="string">&quot;cbs expires: &#123;&#125;, save time: &#123;&#125;, current time: &#123;&#125;&quot;</span>, exp, saveTime, current);</span><br><span class="line">        <span class="keyword">return</span> result &gt;= exp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setToken</span><span class="params">(Integer expires, String token, <span class="type">long</span> current)</span> &#123;</span><br><span class="line">        <span class="comment">// é¢„ç•™5åˆ†é’Ÿ</span></span><br><span class="line">        expires = <span class="literal">null</span> == expires ? EFFECTIVE_TIME - RESERVE_TIME : expires - RESERVE_TIME;</span><br><span class="line">        <span class="comment">// è®¾ç½®token</span></span><br><span class="line">        redisUtil.hset(TOKEN_INFO_KEY, TOKEN_KEY, token);</span><br><span class="line">        <span class="comment">// è®¾ç½®æœ‰æ•ˆæ—¶é•¿</span></span><br><span class="line">        redisUtil.hset(TOKEN_INFO_KEY, EXPIRES, expires);</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¿å­˜æ—¶é—´</span></span><br><span class="line">        redisUtil.hset(TOKEN_INFO_KEY, SAVE_TIME, current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JSONObject <span class="title function_">getTokenInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(org.springframework.http.MediaType.APPLICATION_JSON);</span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">&quot;app_id&quot;</span>, cbsConfig.getAppId());</span><br><span class="line">        params.put(<span class="string">&quot;app_secret&quot;</span>, cbsConfig.getAppSecret());</span><br><span class="line">        params.put(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;client_credentials&quot;</span>);</span><br><span class="line">        HttpEntity&lt;Map&lt;String, String&gt;&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(params, headers);</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.exchange(cbsConfig.getOpenApiUrl() + cbsConfig.getGetTokenUrl(), HttpMethod.POST, request, JSONObject.class);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> response.getBody();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(data)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯·æ±‚TOKENå¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> data.getString(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0&quot;</span>.equals(code)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;è·å–tokenå¤±è´¥,è¿”å›æŠ¥æ–‡: &#123;&#125; , é”™è¯¯æç¤ºä¿¡æ¯: &#123;&#125;&quot;</span>, data, getErrorMessage(code));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JSONObject <span class="title function_">refreshTokenInfo</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setBearerAuth(token);</span><br><span class="line">        HttpEntity&lt;String&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(headers);</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.exchange(cbsConfig.getOpenApiUrl() + cbsConfig.getRefreshTokenUrl(), HttpMethod.GET, request, JSONObject.class);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(data)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è·å–TOKENå¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> data.getString(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;0&quot;</span>.equals(code)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åˆ·æ–°tokenå¤±è´¥,è¿”å›æŠ¥æ–‡: &#123;&#125; , é”™è¯¯æç¤ºä¿¡æ¯: &#123;&#125;&quot;</span>, data, getErrorMessage(code));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data.getJSONObject(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getErrorMessage</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;10010001&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;å‚æ•°æ ¡éªŒå¤±è´¥&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2006&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;æˆæƒæ¨¡å¼ä¸æ”¯æŒ&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;2009&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;å®¢æˆ·ç«¯å¯†é’¥é”™è¯¯&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;AE0004&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;å…¶ä»–é”™è¯¯&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¯·æ±‚å°è£…"><a class="markdownIt-Anchor" href="#è¯·æ±‚å°è£…"></a> è¯·æ±‚å°è£…</h4><p>æ­¤å¤„çš„è¯·æ±‚å°è£…æ˜¯ä¸šåŠ¡è¯·æ±‚ä¸­å…¬å…±å†…å®¹çš„å°è£…å’Œç»“æœçš„è§£æ, å‚è€ƒå®˜æ–¹<code>Demo</code>ä¸­çš„å†…å®¹è¿›è¡Œå°è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CBSHttpUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CBSConfig cbsConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CBSTokenUtils cbsTokenUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doHttp</span><span class="params">(String url, String data)</span> &#123;</span><br><span class="line">        <span class="comment">// ç¦æ­¢HttpClientè‡ªåŠ¨è§£å‹ç¼©</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">CloseableHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClients.custom()</span><br><span class="line">                <span class="comment">// ç¦æ­¢HttpClientè‡ªåŠ¨è§£å‹ç¼©</span></span><br><span class="line">                .disableContentCompression()</span><br><span class="line">                .build()) &#123;</span><br><span class="line">            <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> setupRequest(url, data);</span><br><span class="line">            <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.execute(httpPost);</span><br><span class="line">            <span class="keyword">return</span> handleResponse(response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç½‘ç»œè¿æ¥å¤±è´¥æˆ–è¶…æ—¶ï¼&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;&#123;&#125;:è¯·æ±‚å¼‚å¸¸: &#123;&#125;&quot;</span>, LocalDateTime.now(), e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯·æ±‚å¼‚å¸¸&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> HttpPost <span class="title function_">setupRequest</span><span class="params">(String url, String requestData)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> setupRequest(url, cbsTokenUtils.token(), cbsConfig.getFirmPrivateKey(), cbsConfig.getPlatformPublicKey(), requestData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆè¯·æ±‚æŠ¥æ–‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> HttpPost <span class="title function_">setupRequest</span><span class="params">(String url, String token, String signEncryptionPrivateKey, String bodyEncryptionKey, String requestData)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯·æ±‚æ•°æ®æ‹¼æ¥ï¼š  æŠ¥æ–‡ä½“+æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">byte</span>[] requestDataBytes = requestData.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">byte</span>[] timestampBytes = (<span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">byte</span>[] newBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[requestDataBytes.length + timestampBytes.length];</span><br><span class="line">        System.arraycopy(requestDataBytes, <span class="number">0</span>, newBytes, <span class="number">0</span>, requestDataBytes.length);</span><br><span class="line">        System.arraycopy(timestampBytes, <span class="number">0</span>, newBytes, requestDataBytes.length, timestampBytes.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿæˆç­¾å</span></span><br><span class="line">        <span class="type">byte</span>[] signature = CBSSM2Util.sign(signEncryptionPrivateKey, newBytes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> Base64.encodeBase64String(CBSSM2Util.encodeDERSignature(signature));</span><br><span class="line">        log.info(<span class="string">&quot;ç­¾å:&#123;&#125;&quot;</span>, sign);</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚URL</span></span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤´è®¾ç½®ç­¾å</span></span><br><span class="line">        httpPost.setHeader(CBSConstant.SIGN_HEADER_NAME, sign);</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤´è®¾ç½®æ—¶é—´æˆ³</span></span><br><span class="line">        httpPost.setHeader(CBSConstant.TIMESTAMP_HEADER, Long.toString(timestamp));</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤´è®¾ç½®è¯·æ±‚å‚æ•°æ ¼å¼ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µæ”¹å†™</span></span><br><span class="line">        httpPost.setHeader(HTTP.CONTENT_TYPE, CBSConstant.TARGET_CONTENT_TYPE);</span><br><span class="line">        <span class="comment">// è¯·æ±‚å¤´è®¾ç½®TOKEN</span></span><br><span class="line">        httpPost.setHeader(CBSConstant.AUTHORIZATION, CBSConstant.BEARER + token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠ¥æ–‡ä½“åŠ å¯†</span></span><br><span class="line">        <span class="type">byte</span>[] encryptedData = CBSSM2Util.encrypt(bodyEncryptionKey, requestDataBytes);</span><br><span class="line">        <span class="comment">// è®¾ç½®è¯·æ±‚ä½“</span></span><br><span class="line"></span><br><span class="line">        httpPost.setEntity(<span class="keyword">new</span> <span class="title class_">ByteArrayEntity</span>(encryptedData));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> httpPost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleResponse</span><span class="params">(HttpResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = handleResponse(response, cbsConfig.getFirmPrivateKey());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å“åº”æŠ¥æ–‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] handleResponse(HttpResponse response, String bodyDecryptionKey) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">content</span> <span class="operator">=</span> response.getEntity().getContent();</span><br><span class="line">        <span class="type">byte</span>[] responseData = IOUtils.toByteArray(content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (responseData == <span class="literal">null</span> || responseData.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> responseData == <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>] : responseData;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ­¥éª¤1 åŸå§‹å“åº”æŠ¥æ–‡è§£å¯† å¦‚æœæœåŠ¡ç½‘å…³è·å–åŠ è§£å¯†å¯†é’¥å¤±è´¥ï¼Œåˆ™æ— æ³•è§£å¯†è¯·æ±‚æŠ¥æ–‡ï¼Œä¸”æ— æ³•åŠ å¯†å“åº”æŠ¥æ–‡ã€‚ è¿™æ—¶å€™ï¼Œç½‘å…³ä¼šç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå“åº”æŠ¥æ–‡æ˜¯æœªåŠ å¯†çŠ¶æ€ã€‚</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">encryptionEnable</span> <span class="operator">=</span> getHeader(response, CBSConstant.ENCRYPTION_ENABLED_HEADER_NAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(encryptionEnable)) &#123;</span><br><span class="line">            responseData = CBSSM2Util.decrypt(bodyDecryptionKey, responseData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">xMbcloudCompress</span> <span class="operator">=</span> getHeader(response, CBSConstant.X_MBCLOUD_COMPRESS);</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(xMbcloudCompress)) &#123;</span><br><span class="line">            responseData = decompress(responseData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> responseData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title function_">getHeader</span><span class="params">(HttpMessage message, String name)</span> &#123;</span><br><span class="line">        <span class="type">Header</span> <span class="variable">header</span> <span class="operator">=</span> message.getFirstHeader(name);</span><br><span class="line">        <span class="keyword">return</span> header != <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] decompress(<span class="type">byte</span>[] data) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">        <span class="type">GZIPInputStream</span> <span class="variable">gzipInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPInputStream</span>(input);</span><br><span class="line">        <span class="keyword">return</span> IOUtils.toByteArray(gzipInput);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸šåŠ¡å¯¹æ¥"><a class="markdownIt-Anchor" href="#ä¸šåŠ¡å¯¹æ¥"></a> ä¸šåŠ¡å¯¹æ¥</h3><h4 id="æ”¯ä»˜"><a class="markdownIt-Anchor" href="#æ”¯ä»˜"></a> æ”¯ä»˜</h4><p><img src="%E6%94%AF%E4%BB%98%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="æ”¯ä»˜æ—¶åºå›¾" /></p><p>æ”¯ä»˜æ¥å£æ˜¯ä¸€ä¸ªæ‰¹é‡æ“ä½œæ¥å£, ä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>list</code>, å…·ä½“çš„å‚æ•°å’Œè¿”å›å€¼å‚è€ƒå¯¹æ¥æŒ‡å—.</p><p>æ³¨æ„äº‹é¡¹</p><ol><li>è°ƒç”¨æ”¯ä»˜æ¥å£æ˜¯å‘é€<code>CBS</code>çš„æ”¯ä»˜æŒ‡ä»¤(ä¸Šå›¾ä¸­çš„æ­¥éª¤1-5), å®é™…çš„æ”¯ä»˜éœ€è¦<code>CBS</code>ç«¯å®¡æ ¸, æ­¤å®¡æ ¸å¯ä»¥å…³é—­(è¯¢é—®æ‹›è¡Œå¦‚ä½•æ“ä½œ)</li><li>è°ƒç”¨æ”¯ä»˜æ¥å£æ—¶ä¼šè¿›è¡Œä¸€ç³»åˆ—çš„æ ¡éªŒ, è¿™äº›æ ¡éªŒæ˜¯å¯ä»¥å…³é—­çš„(è¯¢é—®æ‹›å•†é“¶è¡Œ), å»ºè®®æ·»åŠ ä¸šåŠ¡å‚è€ƒå·çš„æ ¡éªŒ, å¦‚æœæœ‰è¦æ±‚å¯ä»¥å…¨éƒ¨å…³é—­(ä¸ªäººéœ€è¦å®ç°è®°å½•çš„é‡å¤è¯·æ±‚é—®é¢˜, ç¡®ä¿æ”¯ä»˜æŒ‡ä»¤çš„å”¯ä¸€)</li><li>è°ƒç”¨æ”¯ä»˜æ¥å£å, ä¸ä¼šç«‹å³æ‰§è¡Œä»˜æ¬¾æ“ä½œ, å®é™…çš„æ”¯ä»˜æ“ä½œä¼šæ»åä¸€æ®µæ—¶é—´, å¹¶ä¸”å³ä½¿åœ¨<code>CBS</code>æ ¡éªŒé€šè¿‡, ä¹Ÿä¸ä¸€å®šä¼šæ”¯ä»˜æˆåŠŸ. å¦‚æœ<code>CBS</code>æ ¡éªŒé€šè¿‡, ä½†æ˜¯å®é™…æ”¯ä»˜å´å¤±è´¥äº†, åˆ™è¯¥ä¸šåŠ¡å‚è€ƒå·(å¼€å¯ä¸šåŠ¡å‚è€ƒå·æ ¡éªŒçš„æƒ…å†µä¸‹)åœ¨<code>CBS</code>ä¸­å°±ä¸å¯ç”¨äº†</li><li>ä»˜æ¬¾çš„è´¦æˆ·å¿…é¡»æ˜¯åœ¨<code>CBS</code>æ³¨å†Œçš„ä¼ä¸šç”¨æˆ·ä¸­å¤‡æ¡ˆçš„è´¦æˆ·</li></ol><p>å¦‚æœä¸æ˜¯æœ‰å¤§é‡çš„æ‰¹é‡æ”¯ä»˜çš„æƒ…å†µ, å»ºè®®ä½¿ç”¨å•æ¡è®°å½•è°ƒç”¨æ”¯ä»˜æ¥å£, è¿™æ ·åœ¨è¿›è¡Œæœ¬åœ°çš„å‚æ•°é¢„æ ¡éªŒå’Œè¯·æ±‚å‚æ•°ä¸è¿”å›ç»“æœè¿›è¡Œæ“ä½œæ—¶æ¯”è¾ƒæ–¹ä¾¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CBSPaymentApplyEntity <span class="title function_">paymentApply</span><span class="params">(CBSPaymentApplyEntity payment)</span> &#123;</span><br><span class="line">    <span class="type">SysPaymentConfig</span> <span class="variable">config</span> <span class="operator">=</span> sysPaymentConfigMapper.selectConfigById(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == config.getEnablePayment()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ”¯ä»˜æ¥å£è¢«ç¦ç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Objectss.isNull(payment)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯·æ·»åŠ æ”¯ä»˜è®°å½•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;æ”¯ä»˜ç”³è¯·: &#123;&#125;&quot;</span>, payment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ•°æ®åˆæ­¥æ ¡éªŒ, åˆ¤æ–­æ•°æ®æ˜¯å¦ç¬¦åˆè¦æ±‚, ä¸ç¬¦åˆå¯ç›´æ¥ä¸è¿›è¡Œåç»­å¤„ç†</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›è¡Œå›ºå®šçš„æ•°æ®å¡«å……</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ”¯ä»˜æ¥å£, åªéœ€è¦å°†æœ‰ä¸šåŠ¡å‚è€ƒå·çš„å¤„ç†å³å¯</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> JSONArray.toJSONString(Collections.singletonList(payment), SerializerFeature.PrettyFormat);</span><br><span class="line">    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> cbsHttpUtil.doHttp(cbsConfig.getOpenApiUrl() + cbsConfig.getPaymentUrl(), data);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(response);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;0&quot;</span>.equals(jsonObject.get(<span class="string">&quot;code&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(jsonObject.getString(<span class="string">&quot;msg&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">CBSPaymentApplyEntity</span> <span class="variable">json</span> <span class="operator">=</span> jsonObject.getJSONArray(<span class="string">&quot;data&quot;</span>).toJavaList(CBSPaymentApplyEntity.class).get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// å¤„ç†æ”¯ä»˜ç»“æœ</span></span><br><span class="line">    payment.setReferenceNum(referenceNum)</span><br><span class="line">        .setSuccessed(json.getSuccessed())</span><br><span class="line">        .setBusNum(json.getBusNum())</span><br><span class="line">        .setErrorCode(json.getErrorCode())</span><br><span class="line">        .setErrorMsg(json.getErrorMsg())</span><br><span class="line">        .setRecordNum(json.getRecordNum())</span><br><span class="line">        .setFreezeFlowNum(json.getFreezeFlowNum())</span><br><span class="line">        .setPayStatus(Boolean.parseBoolean(json.getSuccessed()) ? <span class="string">&quot;a&quot;</span> : <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .setStatus(Boolean.parseBoolean(json.getSuccessed()) ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;&quot;</span>)</span><br><span class="line">        .setSync(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">    <span class="comment">// å°†å®é™…è°ƒç”¨æ”¯ä»˜æ¥å£çš„è®°å½•ä¿å­˜æ—¥å¿—</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">saved</span> <span class="operator">=</span> cbsPaymentApplyService.save(payment);</span><br><span class="line">    <span class="keyword">return</span> payment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢„å¤„ç†å¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰, æœ¬äººåœ¨æ­¤å¤„çš„å®šä¹‰çš„å®ä½“ä¸­æœ‰æ”¯ä»˜å‚æ•°ä¿¡æ¯, æ¥å£è¿”å›ç»“æœä¿¡æ¯å’Œæ”¯ä»˜ç»“æœä¿¡æ¯ä¸‰éƒ¨åˆ†å†…å®¹, æ‰€ä»¥é¢„æ ¡éªŒæ—¶å‚è€ƒçš„å¯¹æ¥æŒ‡å—ä¸­çš„é”™è¯¯ç , æ·»åŠ åˆ°æ•°æ®å¹¶ä¸­, è®°å½•ä¸å¿…è¿›è¡Œè°ƒç”¨è¯·æ±‚</p><p>æ”¯ä»˜ç»“æœä¸­çš„æ”¯ä»˜çŠ¶æ€å’ŒçŠ¶æ€ä¿¡æ¯å¯ä»¥å‚è€ƒå¯¹æ¥æŒ‡å—ä¸­çš„æ”¯ä»˜çŠ¶æ€å’ŒçŠ¶æ€å¯¹åº”çš„ä¿¡æ¯, è¿™ä¸ªåœ¨æ”¯ä»˜ç»“æœæŸ¥è¯¢å¤„ç†ä¸­ä¼šç”¨åˆ°</p><p>è¿™ä¸ªå†…å®¹åœ¨åšçš„æ—¶å€™, æ€»ç›‘è®¾æƒ³çš„æ˜¯ä½¿ç”¨<code>RabbitMQ</code>å¤„ç†æ¥è‡ªå…¬å¸ç³»ç»Ÿä¸­çš„æ”¯ä»˜è¯·æ±‚, ä½†æ˜¯æ²¡æ˜è¯´, ç»ç†å°±è¯´ç›´æ¥ç”¨<code>Dubbo</code>è°ƒç”¨å³å¯, å°±æ²¡ç”¨<code>RabbitMQ</code>, è®¾è®¡æ—¶æ˜¯åº”å½“è€ƒè™‘æ˜¯å¦éœ€è¦ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„</p><h4 id="æ”¯ä»˜ç»“æœ"><a class="markdownIt-Anchor" href="#æ”¯ä»˜ç»“æœ"></a> æ”¯ä»˜ç»“æœ</h4><p>æ”¯ä»˜ç»“æœæŸ¥è¯¢æ¥å£æ˜¯è·å–ä¸€å®šæ—¶é—´æ®µå†…å¤„ç†çš„æ”¯ä»˜è®°å½•, è¿™äº›æ”¯ä»˜è®°å½•çš„æˆåŠŸä¸å¦å¯ä»¥é€šè¿‡æµç¨‹çŠ¶æ€å’Œæ”¯ä»˜çŠ¶æ€å­—æ®µè¿›è¡Œåˆ¤æ–­, å…·ä½“çš„çŠ¶æ€ä¿¡æ¯å¯å‚è€ƒå¯¹æ¥æŒ‡å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paymentDetail</span><span class="params">()</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;==è·å–æ”¯ä»˜ç»“æœå¼€å§‹==&quot;</span>);</span><br><span class="line">    <span class="type">SysPaymentConfig</span> <span class="variable">config</span> <span class="operator">=</span> sysPaymentConfigMapper.selectConfigById(<span class="number">1</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æœ€è¿‘nå°æ—¶çš„è®°å½•, é€šè¿‡æ•°æ®åº“é…ç½®æ—¶é•¿</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> now.plusHours(-<span class="number">1L</span> * config.getPaymentPullOffset()).format(DATE_TIME_FORMATTER);</span><br><span class="line">    <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> now.format(DATE_TIME_FORMATTER);</span><br><span class="line">    param.put(<span class="string">&quot;queryDateStart&quot;</span>, startTime);</span><br><span class="line">    param.put(<span class="string">&quot;queryDateEnd&quot;</span>, endTime);</span><br><span class="line">    param.put(<span class="string">&quot;currentPage&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    param.put(<span class="string">&quot;pageSize&quot;</span>, <span class="number">1000</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> cbsHttpUtil.doHttp(cbsConfig.getOpenApiUrl() + cbsConfig.getPaymentQueryUrl(), JSONObject.toJSONString(param));</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(response, JSONObject.class);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;0&quot;</span>.equals(jsonObject.getString(<span class="string">&quot;code&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯·æ±‚å¤±è´¥: &quot;</span> + jsonObject.getString(<span class="string">&quot;msg&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;data&quot;</span>).getJSONArray(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">    List&lt;CBSPaymentApplyEntity&gt; res = jsonArray.toJavaList(CBSPaymentApplyEntity.class);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢ç»“æœå¤„ç†, ä¸€èˆ¬æ¥è¯´, åªéœ€è¦å¤„ç†æ”¯ä»˜çŠ¶æ€ä¸æ˜¯æœ€ç»ˆçŠ¶æ€çš„è®°å½•å³å¯</span></span><br><span class="line">    <span class="comment">// æ”¯ä»˜çŠ¶æ€&quot;pay_status&quot;çš„æœ€ç»ˆçŠ¶æ€æœ‰&quot;j&quot;, &quot;g&quot;, &quot;i&quot;, &quot;h&quot;, &quot;k&quot;, &quot;d&quot;, åªéœ€è¦æ‰¾åˆ°ç³»ç»Ÿä¿å­˜çš„è®°å½•ä¸­ä¸æ˜¯è¿™äº›çŠ¶æ€çš„è®°å½•è¿›è¡Œå¤„ç†å³å¯</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    log.info(<span class="string">&quot;==è·å–æ”¯ä»˜ç»“æœç»“æŸ==&quot;</span>);</span><br><span class="line">    <span class="comment">// å‘å¸ƒç›‘å¬äº‹ä»¶</span></span><br><span class="line">    applicationContext.publishEvent(<span class="keyword">new</span> <span class="title class_">PaymentResultEvent</span>(update));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ¬äººæ­¤å¤„åœ¨æ”¯ä»˜ç»“æœæŸ¥è¯¢åè¿›è¡Œäº†æ”¯ä»˜è®°å½•çš„ç»“æœä¿®æ”¹, ä¸ºäº†é¿å…é‡å¤å¤„ç†, æ¯æ¬¡æŸ¥è¯¢ååªå¤„ç†ç³»ç»Ÿæ•°æ®åº“ä¿å­˜çš„è®°å½•ä¸­æ”¯ä»˜çŠ¶æ€ä¸æ˜¯æœ€ç»ˆçŠ¶æ€çš„è®°å½•</p><p>æ­¤å¤„ä½¿ç”¨äº†äº‹ä»¶ç›‘å¬æ¥å¤„ç†åç»­ä»»åŠ¡, è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„:</p><ol><li>åˆ†ç¦»ç»“æœè·å–å’Œä¸šåŠ¡é€»è¾‘</li><li>æ”¯ä»˜ç»“æœçš„è·å–å¤„ç†é€šå¸¸æ˜¯éå¸¸é¢‘ç¹çš„(å…¬å¸è´¢åŠ¡è¦æ±‚å¤ªé«˜), è¿™æ ·åœ¨ç³»ç»Ÿä¹‹é—´çš„è°ƒç”¨æˆ–è€…åœ¨å¤„ç†ä¸šåŠ¡æ—¶ä¼šå‡ºç°ç»“æœç­‰å¾…æˆ–è€…å¼‚æ­¥é—®é¢˜, ä½¿ç”¨äº‹ä»¶ç›‘å¬æ–¹ä¾¿å¤„ç†, ä¸ä¼šé˜»å¡è¯·æ±‚æ”¯ä»˜ç»“æœçš„ä»»åŠ¡(ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯ä»¥, å¥½åƒæ²¡æœ‰å¤šå¤§å¿…è¦)</li></ol><p>åé¢çš„ç”µå­å›å•å’Œäº¤æ˜“æ˜ç»†ä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„å¤„ç†</p><p>ç”µå­å›å•: <code>bucketFileUrl</code>å­—æ®µå°±æ˜¯æ–‡ä»¶çš„ä¸‹è½½åœ°å€, ä»æµè§ˆå™¨ä¸­å³å¯ç›´æ¥è®¿é—®, å¯¹æ¥æŒ‡å—ä¸­æè¿°æœ‰æ•ˆæ—¶é—´ä¸º7æ—¥</p><h3 id="ç»“å°¾"><a class="markdownIt-Anchor" href="#ç»“å°¾"></a> ç»“å°¾</h3><p>å…¶å®ä»å¯¹æ¥ä¸Šè€Œè¨€å¹¶æ²¡æœ‰éš¾åº¦, åªæ˜¯ä¸€äº›é—®é¢˜éœ€è¦å¤šæ²Ÿé€šè§£å†³. è¿˜æœ‰å°±æ˜¯åœ¨å¤„ç†æ•°æ®ä¸Šç¡®ä¿æ•°æ®çš„å‡†ç¡®, ä¸ä¼šé‡å¤ç­‰é—®é¢˜, æ¯•ç«Ÿæ¶‰åŠåˆ°é’ç¥¨.</p>]]></content>
      
      
      <categories>
          
          <category> å…¶ä»– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ‹›å•†é“¶è¡ŒCBS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¡¹ç›®å¯¹æ¥æµ·åº·SDK</title>
      <link href="/2024/02/21/other/%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%8E%A5%E6%B5%B7%E5%BA%B7SDK/"/>
      <url>/2024/02/21/other/%E9%A1%B9%E7%9B%AE%E5%AF%B9%E6%8E%A5%E6%B5%B7%E5%BA%B7SDK/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å¹´å‰ç»™å…¬å¸å¯¹æ¥äº†ä¸€ä¸‹æ‹›å•†é“¶è¡Œçš„<code>CBS</code>, ç°åœ¨æƒ³æ•´ç†ä¸€ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹. æƒ³èµ·æ¥ä¹‹å‰å¯¹æ¥è¿‡æµ·åº·çš„<code>SDK</code>, é‚£çœŸæ˜¯æŠ˜ç£¨, å…ˆæŠŠæ–‡ç« ä»<code>CSDN</code>ä¸Šæ¬åˆ°è‡ªå·±çš„åšå®¢é‡Œå§.</p><p>åŸæ–‡è¿æ¥: <a href="https://blog.csdn.net/weixin_43728193/article/details/125385433">https://blog.csdn.net/weixin_43728193/article/details/125385433</a></p><p>ä»¥ä¸‹æ˜¯æ­£æ–‡å†…å®¹:</p><p>æœ€è¿‘å…¬å¸ä¸€ä¸ªé¡¹ç›®è¦å¯¹æ¥æµ·åº·çš„<code>SDK</code>, è½åˆ°äº†æˆ‘æ‰‹é‡Œ, æŠ˜ç£¨äº†æˆ‘ä¸€ä¸ªæœˆ, å†™ä¸ªåšå®¢æ¥åæ§½, æœ¬ç¯‡åªé€šè¿‡æŠ¥è­¦å¸ƒé˜²ä»‹ç»å¯¹æ¥æµ·åº·<code>SDK</code>, å®æ—¶é¢„è§ˆå’Œè§†é¢‘å›æ”¾ä¸‹æ¬¡ä¸€å®šã€‚</p><h3 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h3><p>è®¾å¤‡ç½‘ç»œ<code>SDK</code>æ˜¯åŸºäºè®¾å¤‡ç§æœ‰ç½‘ç»œé€šä¿¡åè®®å¼€å‘çš„ï¼Œä¸ºæµ·åº·å¨è§†å„ç±»ç¡¬ä»¶äº§å“æœåŠ¡çš„é…å¥—æ¨¡å—ï¼Œç”¨äºè¿œç¨‹è®¿é—®å’Œæ§åˆ¶è®¾å¤‡çš„è½¯ä»¶äºŒæ¬¡å¼€å‘ã€‚</p><h3 id="ä¸‹è½½"><a class="markdownIt-Anchor" href="#ä¸‹è½½"></a> ä¸‹è½½</h3><p>ä¸‹è½½åœ°å€: <code>https://open.hikvision.com/download</code><br />ä»åœ°å€ä¸­é€‰æ‹©ç¡¬ä»¶äº§å“, é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ä¸‹è½½å³å¯ã€‚å†…å«<code>SDK</code>åŠ¨æ€åº“, å¼€å‘æ–‡æ¡£, <code>Demo</code>ç¤ºä¾‹</p><h3 id="ä½¿ç”¨æµç¨‹"><a class="markdownIt-Anchor" href="#ä½¿ç”¨æµç¨‹"></a> ä½¿ç”¨æµç¨‹</h3><p><img src="%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B.png" alt="æ¥å£è°ƒç”¨ä¸»è¦æµç¨‹" /></p><blockquote><ol><li>è™šçº¿æŒ‡å‘ä¸ºéå¿…è¦æ“ä½œ;</li><li>åŠŸèƒ½æ¨¡å—å¯ä»¥å•é€‰å¤šé€‰ä¸é€‰;</li><li><code>SDK</code>èµ„æºå’Œè®¾å¤‡æ“ä½œä¸ºå¿…è¦æ“ä½œ, å¦åˆ™ä¼šæ— æ³•æ“ä½œæˆ–è€…æ²¡æœ‰æ•ˆæœ.</li></ol></blockquote><h3 id="å¯¹æ¥demo"><a class="markdownIt-Anchor" href="#å¯¹æ¥demo"></a> å¯¹æ¥<code>Demo</code></h3><p>æœ¬äººä½¿ç”¨<code>Java</code>å¼€å‘æŠ¥è­¦é¢„é˜²ç›¸å…³, åˆ™ä»¥æ­¤ä¸ºä¾‹, åœ¨<code>Spring Boot</code>é¡¹ç›®ä¸­å¯¹æ¥æµ·åº·<code>SDK</code>.</p><h4 id="å®˜æ–¹demo"><a class="markdownIt-Anchor" href="#å®˜æ–¹demo"></a> å®˜æ–¹<code>Demo</code></h4><p>ä¸ºæ–¹ä¾¿ç†æ¸…æ€è·¯, å°†å®˜æ–¹<code>Demo</code>çš„ä¸»è¦æµç¨‹ä»£ç æ”¾ç½®åœ¨æ­¤<br />å®˜æ–¹<code>Dmeo</code>:<br />åœ¨ä½¿ç”¨ä¹‹å‰è¯·ç¡®ä¿æŒ‰ç…§è¯´æ˜æ–‡æ¡£ä¸­çš„æ–¹æ³•, å°†ç›¸å…³æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ”¾ç½®å¦¥å½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"><span class="comment">// åŠ è½½SDKèµ„æº, è·å–èµ„æºå®ä¾‹</span></span><br><span class="line"><span class="keyword">if</span> (hCNetSDK == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!CreateSDKInstance()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Load SDK fail&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">hCNetSDK.NET_DVR_Init();</span><br><span class="line"><span class="comment">// åŠ è½½æ—¥å¿—</span></span><br><span class="line">hCNetSDK.NET_DVR_SetLogToFile(<span class="number">3</span>, <span class="string">&quot;../sdklog&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">//è®¾ç½®æŠ¥è­¦å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> (fMSFCallBack_V31 == <span class="literal">null</span>) &#123;</span><br><span class="line">    fMSFCallBack_V31 = <span class="keyword">new</span> <span class="title class_">FMSGCallBack_V31</span>();</span><br><span class="line">    <span class="type">Pointer</span> <span class="variable">pUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!hCNetSDK.NET_DVR_SetDVRMessageCallBack_V31(fMSFCallBack_V31, pUser)) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¾ç½®å›è°ƒå‡½æ•°å¤±è´¥!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è®¾ç½®å›è°ƒå‡½æ•°æˆåŠŸ!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* è®¾å¤‡ä¸Šä¼ çš„æŠ¥è­¦ä¿¡æ¯æ˜¯COMM_VCA_ALARM(0x4993)ç±»å‹ï¼Œ</span></span><br><span class="line"><span class="comment"> åœ¨SDKåˆå§‹åŒ–ä¹‹åå¢åŠ è°ƒç”¨NET_DVR_SetSDKLocalCfg(enumTypeä¸ºNET_DVR_LOCAL_CFG_TYPE_GENERAL)è®¾ç½®é€šç”¨å‚æ•°NET_DVR_LOCAL_GENERAL_CFGçš„byAlarmJsonPictureSeparateä¸º1ï¼Œ</span></span><br><span class="line"><span class="comment"> å°†Jsonæ•°æ®å’Œå›¾ç‰‡æ•°æ®åˆ†ç¦»ä¸Šä¼ ï¼Œè¿™æ ·è®¾ç½®ä¹‹åï¼ŒæŠ¥è­¦å¸ƒé˜²å›è°ƒå‡½æ•°é‡Œé¢æ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯ç±»å‹ä¸ºCOMM_ISAPI_ALARM(0x6009)ï¼Œ</span></span><br><span class="line"><span class="comment"> æŠ¥è­¦ä¿¡æ¯ç»“æ„ä½“ä¸ºNET_DVR_ALARM_ISAPI_INFOï¼ˆä¸è®¾å¤‡æ— å…³ï¼ŒSDKå°è£…çš„æ•°æ®ç»“æ„ï¼‰ï¼Œæ›´ä¾¿äºè§£æã€‚*/</span></span><br><span class="line">HCNetSDK.<span class="type">NET_DVR_LOCAL_GENERAL_CFG</span> <span class="variable">struNET_DVR_LOCAL_GENERAL_CFG</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HCNetSDK</span>.NET_DVR_LOCAL_GENERAL_CFG();</span><br><span class="line">struNET_DVR_LOCAL_GENERAL_CFG.byAlarmJsonPictureSeparate = <span class="number">1</span>;   <span class="comment">//è®¾ç½®JSONé€ä¼ æŠ¥è­¦æ•°æ®å’Œå›¾ç‰‡åˆ†ç¦»</span></span><br><span class="line">struNET_DVR_LOCAL_GENERAL_CFG.write();</span><br><span class="line"><span class="type">Pointer</span> <span class="variable">pStrNET_DVR_LOCAL_GENERAL_CFG</span> <span class="operator">=</span> struNET_DVR_LOCAL_GENERAL_CFG.getPointer();</span><br><span class="line">hCNetSDK.NET_DVR_SetSDKLocalCfg(<span class="number">17</span>, pStrNET_DVR_LOCAL_GENERAL_CFG);</span><br><span class="line"><span class="comment">// è®¾å¤‡ç™»å½•</span></span><br><span class="line">Alarm.Login_V40(<span class="number">0</span>, <span class="string">&quot;10.17.35.41&quot;</span>, (<span class="type">short</span>) <span class="number">8000</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;abcd1234&quot;</span>);</span><br><span class="line"><span class="comment">// è®¾å¤‡å¸ƒé˜²</span></span><br><span class="line">Alarm.SetAlarm(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡ŒåŠ å…¥æ§åˆ¶å°è¾“å…¥æ§åˆ¶ï¼Œæ˜¯ä¸ºäº†ä¿æŒè¿æ¥çŠ¶æ€ï¼Œå½“è¾“å…¥Yè¡¨ç¤ºå¸ƒé˜²ç»“æŸ</span></span><br><span class="line">    System.out.print(<span class="string">&quot;è¯·é€‰æ‹©æ˜¯å¦æ’¤å‡ºå¸ƒé˜²(Y/N)ï¼š&quot;</span>);</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> input.next();</span><br><span class="line">    <span class="keyword">if</span> (str.equals(<span class="string">&quot;Y&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Alarm.Logout(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ­¤å¤„æ³¨æ„å®˜æ–¹<code>Demo</code>ä¸­çš„<code>while(true)</code>, ä¸‹é¢ä¼šæœ‰ä½¿ç”¨å’Œç›¸å…³è¯´æ˜</p></blockquote><h4 id="åº”ç”¨äºspringbooté¡¹ç›®ä¸­"><a class="markdownIt-Anchor" href="#åº”ç”¨äºspringbooté¡¹ç›®ä¸­"></a> åº”ç”¨äº<code>SpringBoot</code>é¡¹ç›®ä¸­</h4><h5 id="é…ç½®"><a class="markdownIt-Anchor" href="#é…ç½®"></a> é…ç½®</h5><p>ä»¥ä¸‹é…ç½®æ˜¯æœ¬äººé¡¹ç›®ä¸­è¿›è¡Œç›¸å…³é…ç½®<br />é…ç½®ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hik&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HCNetSDKConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HCNetSDKConfig HC_NET_SDK_CONFIG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç™»å½•çš„è®¾å¤‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;DeviceApp&gt; devices = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SDKèµ„æºè·¯å¾„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sdkPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦è‡ªåŠ¨ç™»å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> deviceAutoLogin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡å¯†ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¶…è„‘ip</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String superBrainIp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postConstruct</span><span class="params">()</span> &#123;</span><br><span class="line">        HC_NET_SDK_CONFIG = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li>é¡¹ç›®çš„è®¾å¤‡è¾ƒå°‘, åœ¨é…ç½®ç±»ä¸­ç”¨ä¸€ä¸ª<code>List</code>ä½œä¸ºè®¾å¤‡å­˜æ¡£, å…·ä½“å­˜æ¡£æ–¹å¼åº”ä»¥å…·ä½“é¡¹ç›®å…·ä½“é€‰æ‹©.</li><li>é¡¹ç›®ä¸­çš„æ‰€æœ‰è®¾å¤‡ç”¨æˆ·åå’Œå¯†ç ä¸€è‡´, æ‰€ä»¥æ­¤å¤„ä½¿ç”¨é…ç½®ä½œä¸ºæ•°æ®é¡¹, å…·ä½“æ•°æ®æ¥æºåº”ä»¥å…·ä½“é¡¹ç›®ä¸ºå‡†</li></ol></blockquote><p>é…ç½®æ–‡ä»¶:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hik:</span></span><br><span class="line">  <span class="attr">sdk-path:</span> <span class="string">D:\\workspace\\idea\\hazard-chemical-web\\sdk</span></span><br><span class="line">  <span class="attr">device-auto-login:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">super-brain-ip:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.45</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><h5 id="åº”ç”¨"><a class="markdownIt-Anchor" href="#åº”ç”¨"></a> åº”ç”¨</h5><p>æ­¤å¤„å¯¡äººæ˜¯å°†æ­¤èµ„æºæ¯”ä½œäº†ä¸€ä¸ªåº”ç”¨, æ‰€ä»¥ä»£ç ä¸­ä¼šæœ‰<code>App</code>å­—æ ·<br />è®¾å¤‡ç›¸å…³:<br />è®¾å¤‡ä¿¡æ¯ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Device</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">short</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> userAsync;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String deviceName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è®¾å¤‡åº”ç”¨ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeviceApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(DeviceApp.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HCNetSDK hCNetSDK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Device device;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">lUserID</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">//ç”¨æˆ·å¥æŸ„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">lDChannel</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">//IPé€šé“å·</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">lAlarmHandle</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// æŠ¥è­¦å¸ƒé˜²å¥æŸ„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨é”€æ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> logout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DeviceApp</span><span class="params">(HCNetSDK hcNetSDK, Device device)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.hCNetSDK = hcNetSDK;</span><br><span class="line">        <span class="built_in">this</span>.device = device;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡ç™»å½•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deviceLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.logout) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(device.getIp() + <span class="string">&quot;: è®¾å¤‡ç™»å½•!&quot;</span>);</span><br><span class="line">        <span class="comment">//ç™»å½•è®¾å¤‡ï¼Œæ¯ä¸€å°è®¾å¤‡åˆ†åˆ«ç™»å½•; ç™»å½•å¥æŸ„æ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥åŒºåˆ†è®¾å¤‡</span></span><br><span class="line">        HCNetSDK.<span class="type">NET_DVR_USER_LOGIN_INFO</span> <span class="variable">m_strLoginInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HCNetSDK</span>.NET_DVR_USER_LOGIN_INFO();<span class="comment">//è®¾å¤‡ç™»å½•ä¿¡æ¯</span></span><br><span class="line">        HCNetSDK.<span class="type">NET_DVR_DEVICEINFO_V40</span> <span class="variable">m_strDeviceInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HCNetSDK</span>.NET_DVR_DEVICEINFO_V40();<span class="comment">//è®¾å¤‡ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">m_sDeviceIP</span> <span class="operator">=</span> device.getIp();<span class="comment">//è®¾å¤‡ipåœ°å€</span></span><br><span class="line">        m_strLoginInfo.sDeviceAddress = <span class="keyword">new</span> <span class="title class_">byte</span>[HCNetSDK.NET_DVR_DEV_ADDRESS_MAX_LEN];</span><br><span class="line">        System.arraycopy(m_sDeviceIP.getBytes(StandardCharsets.UTF_8), <span class="number">0</span>, m_strLoginInfo.sDeviceAddress, <span class="number">0</span>, m_sDeviceIP.length());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">m_sUsername</span> <span class="operator">=</span> device.getUsername();<span class="comment">//è®¾å¤‡ç”¨æˆ·å</span></span><br><span class="line">        m_strLoginInfo.sUserName = <span class="keyword">new</span> <span class="title class_">byte</span>[HCNetSDK.NET_DVR_LOGIN_USERNAME_MAX_LEN];</span><br><span class="line">        System.arraycopy(m_sUsername.getBytes(StandardCharsets.UTF_8), <span class="number">0</span>, m_strLoginInfo.sUserName, <span class="number">0</span>, m_sUsername.length());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">m_sPassword</span> <span class="operator">=</span> device.getPassword();<span class="comment">//è®¾å¤‡å¯†ç </span></span><br><span class="line">        m_strLoginInfo.sPassword = <span class="keyword">new</span> <span class="title class_">byte</span>[HCNetSDK.NET_DVR_LOGIN_PASSWD_MAX_LEN];</span><br><span class="line">        System.arraycopy(m_sPassword.getBytes(StandardCharsets.UTF_8), <span class="number">0</span>, m_strLoginInfo.sPassword, <span class="number">0</span>, m_sPassword.length());</span><br><span class="line"></span><br><span class="line">        m_strLoginInfo.wPort = device.getPort(); <span class="comment">//SDKç«¯å£</span></span><br><span class="line">        m_strLoginInfo.bUseAsynLogin = device.isUserAsync(); <span class="comment">//æ˜¯å¦å¼‚æ­¥ç™»å½•ï¼š0- å¦ï¼Œ1- æ˜¯</span></span><br><span class="line">        m_strLoginInfo.write();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.lUserID = <span class="built_in">this</span>.hCNetSDK.NET_DVR_Login_V40(m_strLoginInfo, m_strDeviceInfo);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lUserID == -<span class="number">1</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ç™»å½•å¤±è´¥ï¼Œé”™è¯¯ç ä¸º&quot;</span> + <span class="built_in">this</span>.hCNetSDK.NET_DVR_GetLastError());</span><br><span class="line">            <span class="built_in">this</span>.logout = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(m_sDeviceIP + <span class="string">&quot;:è®¾å¤‡ç™»å½•æˆåŠŸ! &quot;</span> + <span class="string">&quot;è®¾å¤‡åºåˆ—å·:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(m_strDeviceInfo.struDeviceV30.sSerialNumber).trim());</span><br><span class="line">            <span class="built_in">this</span>.logout = <span class="literal">false</span>;</span><br><span class="line">            m_strDeviceInfo.read();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//byStartDChanä¸ºIPé€šé“èµ·å§‹é€šé“å·, é¢„è§ˆå›æ”¾NVRçš„IPé€šé“æ—¶éœ€è¦æ ¹æ®èµ·å§‹é€šé“å·è¿›è¡Œå–å€¼</span></span><br><span class="line">        <span class="built_in">this</span>.lDChannel = m_strDeviceInfo.struDeviceV30.byStartDChan;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡æ³¨é”€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deviceLogout</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è®¾å¤‡æ³¨é”€!&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.logout = hCNetSDK.NET_DVR_Logout(lUserID);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.logout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¸ƒé˜²</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setAlarm</span><span class="params">(DeviceApp device)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;å¸ƒæ”¾!&quot;</span>);</span><br><span class="line">        <span class="comment">//å°šæœªå¸ƒé˜²,éœ€è¦å¸ƒé˜²</span></span><br><span class="line">        <span class="keyword">if</span> (device.getLAlarmHandle() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//æŠ¥è­¦å¸ƒé˜²å‚æ•°è®¾ç½®</span></span><br><span class="line">            HCNetSDK.<span class="type">NET_DVR_SETUPALARM_PARAM_V50</span> <span class="variable">m_strAlarmInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HCNetSDK</span>.NET_DVR_SETUPALARM_PARAM_V50();</span><br><span class="line">            m_strAlarmInfo.dwSize = m_strAlarmInfo.size();</span><br><span class="line">            m_strAlarmInfo.byLevel = <span class="number">1</span>;  <span class="comment">//å¸ƒé˜²ç­‰çº§</span></span><br><span class="line">            m_strAlarmInfo.byAlarmInfoType = <span class="number">1</span>;   <span class="comment">// æ™ºèƒ½äº¤é€šæŠ¥è­¦ä¿¡æ¯ä¸Šä¼ ç±»å‹ï¼š0- è€æŠ¥è­¦ä¿¡æ¯ï¼ˆNET_DVR_PLATE_RESULTï¼‰ï¼Œ1- æ–°æŠ¥è­¦ä¿¡æ¯(NET_ITS_PLATE_RESULT)</span></span><br><span class="line">            m_strAlarmInfo.byDeployType = <span class="number">1</span>;   <span class="comment">//å¸ƒé˜²ç±»å‹ï¼š0-å®¢æˆ·ç«¯å¸ƒé˜²ï¼Œ1-å®æ—¶å¸ƒé˜²</span></span><br><span class="line">            m_strAlarmInfo.write();</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> xmlData();</span><br><span class="line">            log.info(<span class="string">&quot;xml å‚æ•°: &#123;&#125;&quot;</span>, s);</span><br><span class="line">            <span class="type">Pointer</span> <span class="variable">mode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Memory</span>(s.length() + <span class="number">1</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = s.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            mode.write(<span class="number">0</span>, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            <span class="type">int</span> <span class="variable">lAlarmHandle</span> <span class="operator">=</span> device.getHCNetSDK().NET_DVR_SetupAlarmChan_V50(device.getLUserID(), m_strAlarmInfo, mode, s.length() + <span class="number">1</span>);</span><br><span class="line"><span class="comment">//            int lAlarmHandle = device.getHCNetSDK().NET_DVR_SetupAlarmChan_V41(device.getLUserID(), m_strAlarmInfo);</span></span><br><span class="line">            device.setLAlarmHandle(lAlarmHandle);</span><br><span class="line">            log.info(<span class="string">&quot;lAlarmHandle: &quot;</span> + lAlarmHandle);</span><br><span class="line">            <span class="keyword">if</span> (lAlarmHandle == -<span class="number">1</span>) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¸ƒé˜²å¤±è´¥ï¼Œé”™è¯¯ç ä¸º&quot;</span> + device.getHCNetSDK().NET_DVR_GetLastError());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;å¸ƒé˜²æˆåŠŸ&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;è®¾å¤‡å·²ç»å¸ƒé˜²ï¼Œè¯·å…ˆæ’¤é˜²ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è®¾å¤‡é”€æ¯!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.logout) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;!<span class="built_in">this</span>.logout &amp;&amp; i &lt; <span class="number">3</span> ; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logout = deviceLogout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡xmlé…ç½®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">xmlData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;SubscribeEvent version=\&quot;2.0\&quot; xmlns=\&quot;http://www.isapi.org/ver20/XMLSchema\&quot;&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;eventMode&gt;list&lt;/eventMode&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;EventList&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;type&gt;fielddetection,&lt;/type&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;pictureURLType&gt;binary&lt;/pictureURLType&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;type&gt;linedetection&lt;/type&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;pictureURLType&gt;binary&lt;/pictureURLType&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;type&gt;group&lt;/type&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;pictureURLType&gt;binary&lt;/pictureURLType&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/Event&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/EventList&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;channels&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/channels&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;identityKey&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/identityKey&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/SubscribeEvent&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ„æºåº”ç”¨:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HCNetSDKApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(HCNetSDKApp.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HCNetSDKConfig hcNetSDKConfig;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IVideoService videoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾èµ„æºæ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">cleanup</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HCNetSDK hCNetSDK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FExceptionCallBack_Imp fExceptionCallBack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–SDKèµ„æº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CreateSDKException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">initSDKInstance</span><span class="params">()</span> <span class="keyword">throws</span> CreateSDKException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.cleanup) &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;SDKåˆå§‹åŒ–!&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºSDKå®ä¾‹</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">createSDK</span> <span class="operator">=</span> CreateSDKInstance();</span><br><span class="line">        <span class="keyword">if</span> (!createSDK) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;åˆ›å»ºSDKå®ä¾‹å¤±è´¥!&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CreateSDKException</span>(<span class="string">&quot;åˆ›å»ºSDKå®ä¾‹å¤±è´¥!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åˆ›å»ºSDKå®ä¾‹æˆåŠŸ!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// SDKèµ„æºåˆå§‹åŒ–</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">initSDK</span> <span class="operator">=</span> hCNetSDK.NET_DVR_Init();</span><br><span class="line">        <span class="keyword">if</span> (!initSDK) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;åˆå§‹åŒ–SDKèµ„æºå¤±è´¥!&quot;</span>);</span><br><span class="line">            hCNetSDK.NET_DVR_Cleanup();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CreateSDKException</span>(<span class="string">&quot;åˆå§‹åŒ–SDKèµ„æºå¤±è´¥!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cleanup = <span class="literal">false</span>;</span><br><span class="line">            log.info(<span class="string">&quot;åˆå§‹åŒ–SDKèµ„æºæˆåŠŸ!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fExceptionCallBack = <span class="keyword">new</span> <span class="title class_">FExceptionCallBack_Imp</span>();</span><br><span class="line">        <span class="type">Pointer</span> <span class="variable">pUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hCNetSDK.NET_DVR_SetExceptionCallBack_V30(<span class="number">0</span>, <span class="number">0</span>, fExceptionCallBack, pUser)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åˆå§‹åŒ–å¼‚å¸¸æ¶ˆæ¯å›è°ƒå¤±è´¥!&quot;</span>);</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–å¼‚å¸¸æ¶ˆæ¯å›è°ƒå¤±è´¥, é‡Šæ”¾SDKèµ„æº</span></span><br><span class="line">            hCNetSDK.NET_DVR_Cleanup();</span><br><span class="line">            <span class="built_in">this</span>.cleanup = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CreateSDKException</span>(<span class="string">&quot;åˆå§‹åŒ–å¼‚å¸¸æ¶ˆæ¯å›è°ƒå¤±è´¥!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åˆå§‹åŒ–å¼‚å¸¸æ¶ˆæ¯å›è°ƒæˆåŠŸ!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¯åŠ¨SDKå†™æ—¥å¿—</span></span><br><span class="line">        hCNetSDK.NET_DVR_SetLogToFile(<span class="number">3</span>, hcNetSDKConfig.getLogPath(), <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªåŠ¨ç™»å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoDevicesLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">AtomicBoolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line">        QueryWrapper&lt;VideoShowModel&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.isNotNull(<span class="string">&quot;IP&quot;</span>);</span><br><span class="line">        wrapper.ne(<span class="string">&quot;IP&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        List&lt;Video&gt; videos = videoService.getBaseMapper().selectList(wrapper);</span><br><span class="line">        List&lt;Device&gt; devices = videos.stream().map(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (hcNetSDKConfig.getSuperBrainIp().equals(item.getIp())) &#123;</span><br><span class="line">                flag.set(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Device</span>();</span><br><span class="line">            device.setIp(item.getIp());</span><br><span class="line">            device.setId(item.getSheetId());</span><br><span class="line">            <span class="keyword">return</span> device;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (!flag.get()) &#123;</span><br><span class="line">            <span class="type">Device</span> <span class="variable">device</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Device</span>();</span><br><span class="line">            device.setIp(hcNetSDKConfig.getSuperBrainIp());</span><br><span class="line">            devices.add(device);</span><br><span class="line">        &#125;</span><br><span class="line">        devicesLogin(devices);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡ç™»å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">devicesLogin</span><span class="params">(List&lt;Device&gt; devices)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Device device : devices) &#123;</span><br><span class="line">            deviceLogin(device);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾å¤‡ç™»å½•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> device</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> DeviceApp <span class="title function_">deviceLogin</span><span class="params">(Device device)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DeviceApp</span> <span class="variable">deviceApp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeviceApp</span>(<span class="built_in">this</span>.hCNetSDK, device);</span><br><span class="line">            <span class="comment">// è®¾å¤‡ç™»å½•æ³¨å†Œ</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">deviceLogin</span> <span class="operator">=</span> deviceApp.deviceLogin();</span><br><span class="line">            <span class="keyword">if</span> (!deviceLogin) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;æ³¨å†Œè®¾å¤‡å¤±è´¥!&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CreateSDKException</span>(<span class="string">&quot;æ³¨å†Œè®¾å¤‡å¤±è´¥!&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ³¨å†Œè®¾å¤‡æˆåŠŸ!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            HCNetSDKConfig.devices.add(deviceApp);</span><br><span class="line">            log.info(<span class="string">&quot;å·²ç™»å½•è®¾å¤‡æ•°é‡: &#123;&#125;&quot;</span>, HCNetSDKConfig.devices.size());</span><br><span class="line">            <span class="keyword">return</span> deviceApp;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CreateSDKException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾SDKèµ„æº</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;é‡Šæ”¾SDKèµ„æº!&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.cleanup = hCNetSDK.NET_DVR_Cleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;SDKå®ä¾‹é”€æ¯!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.cleanup) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; !<span class="built_in">this</span>.cleanup &amp;&amp; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!HCNetSDKConfig.devices.isEmpty()) &#123;</span><br><span class="line">                HCNetSDKConfig.devices.forEach(item -&gt; &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> item.deviceLogout();</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        HCNetSDKConfig.devices.clear();</span><br><span class="line">        cleanup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FExceptionCallBack_Imp</span> <span class="keyword">implements</span> <span class="title class_">HCNetSDK</span>.FExceptionCallBack &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(<span class="type">int</span> dwType, <span class="type">int</span> lUserID, <span class="type">int</span> lHandle, Pointer pUser)</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å¼‚å¸¸äº‹ä»¶ç±»å‹: &#123;&#125;&quot;</span>, dwType);</span><br><span class="line">            log.error(<span class="string">&quot;å¼‚å¸¸ç”¨æˆ·ä¸»é”®: &#123;&#125;&quot;</span>, lUserID);</span><br><span class="line">            log.error(<span class="string">&quot;å¼‚å¸¸å¤„ç†: &#123;&#125;&quot;</span>, lHandle);</span><br><span class="line">            log.error(<span class="string">&quot;å¼‚å¸¸Pointer: &#123;&#125;&quot;</span>, pUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ¨æ€åº“åŠ è½½</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">CreateSDKInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;åˆ›å»ºSDKå®ä¾‹!&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">strDllPath</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        log.info(<span class="string">&quot;hc net sdk config: &#123;&#125;&quot;</span>, hcNetSDKConfig);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (OSSelectUtil.isWindows())</span><br><span class="line">                <span class="comment">//winç³»ç»ŸåŠ è½½åº“è·¯å¾„</span></span><br><span class="line">                strDllPath = hcNetSDKConfig.getSdkPath() + <span class="string">&quot;\\windows\\HCNetSDK.dll&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (OSSelectUtil.isLinux())</span><br><span class="line">                <span class="comment">//Linuxç³»ç»ŸåŠ è½½åº“è·¯å¾„</span></span><br><span class="line">                strDllPath = hcNetSDKConfig.getSdkPath() + <span class="string">&quot;/linux/libhcnetsdk.so&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.hCNetSDK = (HCNetSDK) Native.loadLibrary(strDllPath, HCNetSDK.class);</span><br><span class="line">            <span class="built_in">this</span>.cleanup = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;loadLibrary: &quot;</span> + strDllPath + <span class="string">&quot; Error: &quot;</span> + ex.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜:</p><ol><li>èµ„æºåº”ç”¨ä½¿ç”¨äº†<code>Spring</code>çš„ç»„ä»¶æ³¨è§£<code>@Component</code>, å› ä¸ºè¯¥èµ„æºåªéœ€è¦åŠ è½½ä¸€æ¬¡å³å¯, å¯ä»¥å¼•ç”¨<code>Spring</code>çš„å•ä¾‹æ¨¡å¼</li><li><font color = red>æ³¨æ„: </font> åœ¨ä¹‹å‰çš„é…ç½®é¡¹ä¸­, <code>sdk-path</code>ä½¿ç”¨äº†<code>\\</code>ä½œä¸ºç›®å½•åˆ†éš”ç¬¦, æœ¬é¡¹ç›®æ˜¯åœ¨<code>windows</code>æœåŠ¡å™¨ä¸Šè¿è¡Œ, æ‰€ä»¥ä½¿ç”¨<code>windows</code>ç›®å½•æ ¼å¼, å°è¯•è¿‡ä½¿ç”¨<code>/</code>å’Œ<code>\</code>ä¸¤ç§æ–¹å¼,éƒ½å¤±è´¥äº†,å…·ä½“åŸå› ,çŒœæƒ³æ˜¯<code>windows</code>ä½¿ç”¨<code>\</code>ä½œä¸ºåˆ†éš”ç¬¦,å­—ç¬¦ä¸²ä¸­<code>\</code>åˆä¸ºè½¬ç§»å­—ç¬¦å¯¼è‡´çš„;è‡³äºä¸ºä»€ä¹ˆä¸èƒ½ç”¨<code>/</code>æˆ–è€…å…¶ä»–åŸå› ,æˆ‘çŸ¥é“ä¸çŸ¥é“,ä½ è‡ªå·±ä½“ä¼šå§.</li><li>æ­¤å¤„çš„è®¾å¤‡ç™»å½•ç›¸å…³å†…å®¹æ˜¯æœ¬äººé¡¹ç›®ä¸­æŸ¥è¯¢ç›¸å…³è®¾å¤‡,ç„¶åè°ƒç”¨è®¾å¤‡ä¸­çš„ç™»å½•æ–¹æ³•,ä¸ä¸€å®šéè¦åœ¨æ­¤å¤„,å¯å°†å…¶ä½œä¸ºç›¸å…³æ¡ˆä¾‹ä½¿ç”¨, éœ€æ ¹æ®é¡¹ç›®è¦æ±‚è¿›è¡Œåˆç†å¤„ç†.</li></ol></blockquote><h5 id="æµç¨‹"><a class="markdownIt-Anchor" href="#æµç¨‹"></a> æµç¨‹</h5><p>æµç¨‹å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlarmListenerServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">IAlarmListenerService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HCNetSDKApp hcNetSDKApp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startListener</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">AlarmListenerTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlarmListenerTask</span>(hcNetSDKApp);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task);</span><br><span class="line">thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li>å¯åŠ¨æ–¹å¼æœ‰å¾ˆå¤š, å¯ä»¥é€‰æ‹©æ‰‹åŠ¨å¯åŠ¨, ä¹Ÿå¯ä»¥é€‰æ‹©é¡¹ç›®è¿è¡Œæ—¶å¯åŠ¨, æ­¤å¤„é¡¹ç›®ä¸­é‡‡ç”¨é¡¹ç›®å¯åŠ¨æ—¶å¯åŠ¨</li><li>é¡¹ç›®å¯åŠ¨æ—¶æ‰§è¡ŒæŸäº›æ–¹æ³•çš„æ–¹å¼æœ‰å¤šç§, å¯å‚ç…§åšæ–‡: <a href='https://juejin.cn/post/7025858036002455589'>Springbootå¯åŠ¨åæ‰§è¡Œæ–¹æ³•çš„å››ç§æ–¹å¼</a></li><li>æ­¤å¤„ä½¿ç”¨æ–°å»ºå®ˆæŠ¤çº¿ç¨‹çš„æ–¹å¼å¯åŠ¨æŠ¥è­¦å¸ƒé˜²åŠŸèƒ½, ä¸‹æ–¹ä»£ç å±•ç¤ºåä¾¿ä¼šçŸ¥æ™“.</li></ol></blockquote><p>æµç¨‹ä»»åŠ¡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlarmListenerTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(AlarmListenerTask.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HCNetSDKApp hcNetSDKApp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AlarmListenerTask</span><span class="params">(HCNetSDKApp hcNetSDKApp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hcNetSDKApp = hcNetSDKApp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (hcNetSDKApp.getHCNetSDK() == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> hcNetSDKApp.initSDKInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CreateSDKException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;SDKå®ä¾‹åˆ›å»ºå¤±è´¥!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">FMSGCallBack_V31</span> <span class="variable">fMSFCallBack_V31</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FMSGCallBack_V31</span>();</span><br><span class="line">        <span class="type">Pointer</span> <span class="variable">pUser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hcNetSDKApp.getHCNetSDK().NET_DVR_SetDVRMessageCallBack_V50(<span class="number">0</span>, fMSFCallBack_V31, pUser)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è®¾ç½®å›è°ƒå‡½æ•°å¤±è´¥!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;è®¾ç½®å›è°ƒå‡½æ•°æˆåŠŸ!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* è®¾å¤‡ä¸Šä¼ çš„æŠ¥è­¦ä¿¡æ¯æ˜¯COMM_VCA_ALARM(0x4993)ç±»å‹ï¼Œ</span></span><br><span class="line"><span class="comment">         åœ¨SDKåˆå§‹åŒ–ä¹‹åå¢åŠ è°ƒç”¨NET_DVR_SetSDKLocalCfg(enumTypeä¸ºNET_DVR_LOCAL_CFG_TYPE_GENERAL)è®¾ç½®é€šç”¨å‚æ•°NET_DVR_LOCAL_GENERAL_CFGçš„byAlarmJsonPictureSeparateä¸º1ï¼Œ</span></span><br><span class="line"><span class="comment">         å°†Jsonæ•°æ®å’Œå›¾ç‰‡æ•°æ®åˆ†ç¦»ä¸Šä¼ ï¼Œè¿™æ ·è®¾ç½®ä¹‹åï¼ŒæŠ¥è­¦å¸ƒé˜²å›è°ƒå‡½æ•°é‡Œé¢æ¥æ”¶åˆ°çš„æŠ¥è­¦ä¿¡æ¯ç±»å‹ä¸ºCOMM_ISAPI_ALARM(0x6009)ï¼Œ</span></span><br><span class="line"><span class="comment">         æŠ¥è­¦ä¿¡æ¯ç»“æ„ä½“ä¸ºNET_DVR_ALARM_ISAPI_INFOï¼ˆä¸è®¾å¤‡æ— å…³ï¼ŒSDKå°è£…çš„æ•°æ®ç»“æ„ï¼‰ï¼Œæ›´ä¾¿äºè§£æã€‚*/</span></span><br><span class="line">        HCNetSDK.<span class="type">NET_DVR_LOCAL_GENERAL_CFG</span> <span class="variable">struNET_DVR_LOCAL_GENERAL_CFG</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HCNetSDK</span>.NET_DVR_LOCAL_GENERAL_CFG();</span><br><span class="line">        struNET_DVR_LOCAL_GENERAL_CFG.byAlarmJsonPictureSeparate = <span class="number">1</span>;   <span class="comment">//è®¾ç½®JSONé€ä¼ æŠ¥è­¦æ•°æ®å’Œå›¾ç‰‡åˆ†ç¦»</span></span><br><span class="line">        struNET_DVR_LOCAL_GENERAL_CFG.write();</span><br><span class="line">        <span class="type">Pointer</span> <span class="variable">pStrNET_DVR_LOCAL_GENERAL_CFG</span> <span class="operator">=</span> struNET_DVR_LOCAL_GENERAL_CFG.getPointer();</span><br><span class="line">        hcNetSDKApp.getHCNetSDK().NET_DVR_SetSDKLocalCfg(<span class="number">17</span>, pStrNET_DVR_LOCAL_GENERAL_CFG);</span><br><span class="line">        <span class="comment">// è®¾å¤‡ç™»å½•</span></span><br><span class="line">        hcNetSDKApp.autoDevicesLogin();</span><br><span class="line">        log.info(<span class="string">&quot;å¸ƒé˜²è®¾å¤‡æ•°é‡: &#123;&#125;&quot;</span>, HCNetSDKConfig.devices.size());</span><br><span class="line">        <span class="comment">// è®¾å¤‡å¸ƒé˜²</span></span><br><span class="line">        HCNetSDKConfig.devices.forEach(DeviceApp::setAlarm);</span><br><span class="line">        <span class="comment">// ç»´æŒçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ol><li>æ­¤ä»»åŠ¡ç±»ä¸­çš„<code>run</code>æ–¹æ³•ä¸­ä¾¿æ˜¯æ•´ä¸ªå¸ƒé˜²æµç¨‹</li><li><code>while(true)&#123;&#125;</code>è¿™ä¸ªä½ç½®çš„ä»£ç å³æ˜¯å‰é¢å®˜æ–¹<code>Demo</code>ä¸­çš„<code>while</code>ä»£ç çš„ä¿®æ”¹</li></ol></blockquote><blockquote><p>å…³äºä¸ºä»€ä¹ˆæ–°å»ºä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹å¤„ç†æµç¨‹:</p><ol><li><code>SDK</code>çš„æ¨¡å—åŠŸèƒ½éœ€è¦ç»´æŒä¸€æ¡çº¿ç¨‹ä¿æŒè¿è½¬,å®˜æ–¹<code>Demo</code>ä¸­çš„<code>while</code>å°±æ˜¯ä¸ºäº†ç»´æŒçº¿ç¨‹, å³ä½¿å®ƒè¢«å¡åœ¨<code>while</code>å¤„æ— æ³•ç»§ç»­å‘ä¸‹è¿›è¡Œ,<br />çŒœæµ‹:<code>SDK</code>ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºäº†å®ˆæŠ¤çº¿ç¨‹è¿›è¡Œå¸ƒé˜²ç›‘å¬, å½“å‰çº¿ç¨‹ä¸­æ–­äº†,å¸ƒé˜²çš„å®ˆæŠ¤çº¿ç¨‹å°±æŒ‚æ‰äº†.</li><li><code>main</code>çº¿ç¨‹åœ¨åŠ è½½èµ„æºåå°±ä¼šç»“æŸ, æœ¬äººåœ¨åˆæ¬¡å°è¯•æ—¶å³ä½¿ç”¨<code>main</code>æ‰§è¡Œæµç¨‹,ç»“æœæ˜¯æŠ¥è­¦å›è°ƒåç»­ä¾¿ä¸å†è§¦å‘,æ‰€ä»¥é€‰æ‹©æ–°å»ºä¸€æ¡çº¿ç¨‹æ¥è¿›è¡Œæµç¨‹æ“ä½œ.</li><li>ä½¿ç”¨å®ˆæŠ¤çº¿ç¨‹æ˜¯å› ä¸ºä»£ç ä¸­æœ‰æ­»å¾ªç¯ä»£ç , å®ˆæŠ¤çº¿ç¨‹åœ¨ä¸»çº¿ç¨‹ç»“æŸåä¾¿ä¼šè¢«æ€æ­».ä½†å‰ä¸¤å¤©çœ‹åšæ–‡,å¥½åƒ<code>spring</code>é¡¹ç›®åœ¨ç»“æŸç¨‹åºæ—¶ä¼šæ€æ­»æ‰€æœ‰çº¿ç¨‹,å…·ä½“æˆ‘ä¸å¤ªäº†è§£,å¸Œæœ›æœ‰å¤§ä½¬è§£ç­”.</li></ol></blockquote><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p>å®æ—¶é¢„è§ˆ</p><p>è§†é¢‘å›æ”¾</p><h3 id="åæ§½"><a class="markdownIt-Anchor" href="#åæ§½"></a> åæ§½</h3><p>ä¹‹å‰åšå®Œåä¸»ç®¡è¦æˆ‘å†™ä¸€ç¯‡å¯¹æ¥æ–‡æ¡£ç»™ä¹‹åçš„å¼€å‘äººå‘˜ä½œæŒ‡å¯¼, ç„¶åå°±è¢«æ‹¿å»æ‰¹å¤äº†,æˆ‘çœ‹äº†æ‰¹æ³¨ä¹‹åæˆ‘è¡¨ç¤ºæƒ³ä¹°ä¸ªè¢‹å­æŠŠä»–è£…èµ·æ¥åŠç€æ‰“.<br />é—®é¢˜1: è®¾å¤‡æ³¨å†Œéœ€è¦å°†æ‰€æœ‰çš„è®¾å¤‡éƒ½æ³¨å†Œå—?<br />æˆ‘ä¸¢,ä½ çˆ±æ³¨å†Œå¤šå°‘æ³¨å†Œå¤šå°‘,è¦ä¸å»æœç½—ä¸€ä¸‹å…¨çƒæœ‰å¤šå°‘æµ·åº·çš„æ‘„åƒå¤´,éƒ½æ³¨å†Œè¿›å»å§!<br />é—®é¢˜2: è®¾å¤‡åœ¨æ³¨å†Œç™»å½•ä¹‹åå°±è¦æ³¨é”€å—?<br />æˆ‘å»,å¾®ä¿¡ç™»å½•äº†å°±è¦é€€å‡ºå—?äººå‡ºç”Ÿäº†å°±è¦ä¸‹è‘¬å—?</p><p><em><strong><font color=#00FF00>å¦‚æœæœ‰å¹¸æœ‰äººèƒ½çœ‹åˆ°è¿™ç¯‡åšæ–‡, è¯·è½¬å‘Šèº«è¾¹çš„äºº, ä¸è¦ä¸ºéš¾å¼€å‘äººå‘˜äº†, ä»–ä»¬ä¸æ˜¯ä¸‡èƒ½çš„, åŠå¤§å®¶å–„è‰¯</font></strong></em></p>]]></content>
      
      
      <categories>
          
          <category> å…¶ä»– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯¹æ¥æµ·åº·SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(å…«)---æœåŠ¡åˆ’åˆ†</title>
      <link href="/2024/02/19/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%85%AB%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%88%92%E5%88%86/"/>
      <url>/2024/02/19/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%85%AB%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%88%92%E5%88%86/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰é¢æˆ‘ä»¬å°†å®‰å…¨è®¤è¯æ¡†æ¶<code>SpringSecurity</code>æ·»åŠ ä¸ºä¸€ä¸ªæœåŠ¡, å½“æˆ‘ä»¬æ·»åŠ è®¤è¯æœåŠ¡å, ä¾¿å®ç°çš„ç™»å½•æ•ˆæœ, ä½†æ˜¯åœ¨èµ„æºæœåŠ¡ä¸­ä¼šæœ‰ä¸€ä¸‹é—®é¢˜:</p><ol><li>èµ„æºæœåŠ¡æ— æ³•è·å–åˆ°ç”¨æˆ·ä¿¡æ¯, å› ä¸ºæ˜¯åœ¨ä¸åŒçš„æœåŠ¡åº”ç”¨ä¸­, ç”¨æˆ·ä¿¡æ¯ä¸èƒ½è·¨åº”ç”¨ä¼ é€’</li><li>å½“ç”¨æˆ·å·²ç»é€€å‡ºç™»å½•, æˆ–è€…ç™»å½•å¤±æ•ˆå, è®¿é—®èµ„æºæœåŠ¡ä¾ç„¶å¯ä»¥æ­£å¸¸è¿”å›</li></ol><p>ä¸Šè¿°é—®é¢˜æ˜¯å› ä¸ºåœ¨èµ„æºæœåŠ¡ä¸­æ²¡æœ‰è·å–ç”¨æˆ·ä¿¡æ¯, æ›´æ²¡æœ‰è¿›è¡Œç”¨æˆ·ä¿¡æ¯çš„éªŒè¯, æ‰€ä»¥è®¤è¯æƒé™ç­‰çš„å†…å®¹å…¨æ˜¯çº¸è€è™, æ²¡æœ‰èµ·åˆ°ä»»ä½•ä½œç”¨</p><p>åŸºäºä»¥ä¸Šé—®é¢˜, éœ€è¦å°†<code>SpringSecurity</code>æ·»åŠ åˆ°èµ„æºæœåŠ¡ä¸­, <code>SpringSecurity</code>æ¡†æ¶åœ¨èµ„æºæœåŠ¡ä¸­éœ€è¦çš„å†…å®¹ä¸»è¦æœ‰ä¸‰ä¸ª: ä¸€. è·å–ç”¨æˆ·ä¿¡æ¯; äºŒ. éªŒè¯æ˜¯å¦ç™»å½•; ä¸‰. éªŒè¯ç”¨æˆ·æƒé™</p><h3 id="å¤„ç†"><a class="markdownIt-Anchor" href="#å¤„ç†"></a> å¤„ç†</h3><p>ä¸Šè¿°çš„ä¸‰é¡¹å†…å®¹æˆ‘ä»¬åœ¨å‰æ–‡ä¸­å·²ç»è¿›è¡Œäº†å¤„ç†, åªè¦å°†éœ€è¦çš„å†…å®¹æ‹¿æ¥å³å¯.</p><ol><li>ç”¨æˆ·ä¿¡æ¯: <code>securityContextRepository</code>é…ç½®ä¼šè¯ä¸Šä¸‹æ–‡å­˜å‚¨, <mark>ä¸€å®šè¦å®ç°ç”¨æˆ·ä¿¡æ¯åœ¨ä¸åŒåº”ç”¨æœåŠ¡ä¹‹é—´çš„å¯è®¿é—®æ€§, å³<code>session</code>å…±äº«</mark></li><li>éªŒè¯æ˜¯å¦ç™»å½•ç»“æœå¤„ç†: <code>exceptionHandling</code>é…ç½®æœªç™»å½•æˆ–è€…ç™»å½•å¤±æ•ˆçš„å¤„ç†</li><li>éªŒè¯ç”¨æˆ·æƒé™: <code>AuthorizationFilter</code>å¤„ç†</li></ol><p>æˆ‘ä»¬æœ‰å¤šä¸ªèµ„æºæœåŠ¡, æ¯ä¸ªèµ„æºæœåŠ¡éƒ½éœ€è¦æ·»åŠ è¿™ä¸ªéªŒè¯è§„åˆ™, å¦‚æœä¸ºæ¯ä¸€ä¸ªèµ„æºæœåŠ¡éƒ½æ·»åŠ ä¸€å¥—éªŒè¯ä½¿ç”¨çš„ä»£ç æ˜¾ç„¶æ˜¯ä¸åˆç†çš„, æ‰€ä»¥æˆ‘ä»¬å°†éªŒè¯çš„ä»£ç æ·»åŠ åˆ°å…¬å…±æ¨¡å—ä¸­, ç„¶ååŒºåˆ†è®¤è¯æœåŠ¡å’Œèµ„æºæœåŠ¡è¿›è¡Œä¸åŒçš„é…ç½®å³å¯</p><p>ç¬¬ä¸€ä¸ªç›®æ ‡è¦æ˜ç¡®èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡å„éœ€è¦å“ªäº›å†…å®¹</p><p>ä¸€: èµ„æºæœåŠ¡:</p><ol><li>è·å–ç”¨æˆ·ä¿¡æ¯: é…ç½®ä¼šè¯ä¸Šä¸‹æ–‡å­˜å‚¨</li><li>æ˜¯å¦ç™»å½•çš„ç»“æœå¤„ç†: é…ç½®æœªç™»å½•æˆ–ç™»å½•å¤±æ•ˆçš„å¤„ç†</li><li>éªŒè¯ç”¨æˆ·æƒé™: å¼€å¯æƒé™éªŒè¯è¿‡æ»¤å™¨</li><li>è·¯å¾„åŒ¹é…: æ·»åŠ è·¯å¾„åŒ¹é…è§„åˆ™, æ¯ä¸ªèµ„æºæœåŠ¡éƒ½åªå¤„ç†è‡ªå·±åŒ¹é…çš„è·¯å¾„, å…¶ä»–è·¯å¾„ä¸å¤„ç†</li></ol><p>äºŒ: è®¤è¯æœåŠ¡:</p><ol><li>ç™»å½•: é…ç½®ç™»å½•æˆåŠŸå’Œå¤±è´¥å¤„ç†</li><li>æ³¨é”€: é…ç½®æ³¨é”€å¤„ç†å’Œæ³¨é”€æˆåŠŸå¤„ç†</li><li>ä¿å­˜ç”¨æˆ·ä¿¡æ¯: é…ç½®ä¼šè¯ä¸Šä¸‹æ–‡å­˜å‚¨</li><li>æ˜¯å¦ç™»å½•çš„ç»“æœå¤„ç†: é…ç½®æœªç™»å½•å’Œç™»å½•å¤±æ•ˆçš„å¤„ç†</li><li>è·¯å¾„åŒ¹é…: æ·»åŠ è·¯å¾„åŒ¹é…è§„åˆ™, åªåŒ¹é…ç™»å½•è·¯å¾„å’Œæ³¨é”€è·¯å¾„, å…¶ä»–è·¯å¾„ä¸å¤„ç†</li></ol><p>ç¬¬äºŒä¸ªç›®æ ‡æˆ‘ä»¬éœ€è¦æ˜ç¡®ä½•æ—¶å¼€å¯<code>SpringSecurity</code></p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ—¶, æˆ‘ä»¬æ˜¯åœ¨è¯¥é¡¹ç›®ä¸­æ·»åŠ <code>SpringSecurity</code>çš„, åªæœ‰å°†å…¶æ ‡è®°ä¸ºèµ„æºæœåŠ¡æˆ–è€…è®¤è¯æœåŠ¡æ—¶, æˆ‘ä»¬æ‰éœ€è¦å¼€å¯<code>SpringSecurity</code>, æ¯”å¦‚æˆ‘ä»¬è¦æ‹†åˆ†å‡ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„æœåŠ¡, è¯¥æœåŠ¡æ˜¯ä¸éœ€è¦å¼€å¯<code>SpringSecurity</code>çš„</p><h3 id="å®ç°"><a class="markdownIt-Anchor" href="#å®ç°"></a> å®ç°</h3><h4 id="securityçš„å¼€å¯ä¸å…³é—­"><a class="markdownIt-Anchor" href="#securityçš„å¼€å¯ä¸å…³é—­"></a> <code>Security</code>çš„å¼€å¯ä¸å…³é—­</h4><p>æˆ‘ä»¬ä¸ºäº†å®ç°ç¬¬äºŒä¸ªç›®æ ‡, æˆ‘ä»¬éœ€è¦é»˜è®¤å°†<code>SpringSecurity</code>çš„è‡ªåŠ¨é…ç½®å…³é—­, ç„¶ååœ¨è®¤è¯æœåŠ¡å’Œèµ„æºæœåŠ¡ä¸¤ç§ç±»å‹çš„æœåŠ¡ä¸­å¼€å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤å…³é—­SpringSecurityæœåŠ¡</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration(exclude = &#123;SecurityAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¤è¯æœåŠ¡å’Œèµ„æºæœåŠ¡å¼€å¯SpringSecurity</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ApplicationSecurityConfig</span> &#123; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†é…ç½®"><a class="markdownIt-Anchor" href="#èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†é…ç½®"></a> èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†é…ç½®</h4><p>ä¸ºäº†å®ç°ç¬¬äºŒä¸ªç›®æ ‡, æˆ‘ä»¬éœ€è¦å¼€å¯<code>SpringSecurity</code>, å¹¶ä¸”éœ€è¦è¿›è¡Œä¸åŒçš„é…ç½®, èµ„æºæœåŠ¡ä¹‹é—´çš„é…ç½®ç›¸ä¼¼</p><p>é¦–å…ˆ, æ‰€æœ‰æœåŠ¡çš„ç›¸ä¼¼é…ç½®å¯ä»¥åŒæ—¶æ·»åŠ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ApplicationSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApplicationSecurityConfig</span><span class="params">(</span></span><br><span class="line"><span class="params">            ServerProperties serverProperties, AuthenticationSaveHandler authenticationSaveHandler,</span></span><br><span class="line"><span class="params">            CustomerAuthenticationHandler customerAuthenticationHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serverProperties = serverProperties;</span><br><span class="line">        <span class="built_in">this</span>.authenticationSaveHandler = authenticationSaveHandler;</span><br><span class="line">        <span class="built_in">this</span>.customerAuthenticationHandler = customerAuthenticationHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECURITY_FILTER_CHAIN_BEAN</span> <span class="operator">=</span> <span class="string">&quot;securityFilterChain&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ServerProperties serverProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationSaveHandler authenticationSaveHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> CustomerAuthenticationHandler customerAuthenticationHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = SECURITY_FILTER_CHAIN_BEAN)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»åšäº†ä»¥ä¸‹å‡ ä»¶äº‹:</p><ol><li>å¼€å¯<code>SpringSecurity</code></li><li>å®šä¹‰äº†ä¸€ä¸ªç±»å‹ä¸º<code>SecurityFilterChain</code>, åä¸º<code>securityFilterChain</code>çš„<code>bean</code>, ä½†æ˜¯æ²¡æœ‰å®ç°</li><li>å®šä¹‰å¹¶è¦æ±‚æ·»åŠ æœåŠ¡æºé…ç½®, ä¼šè¯ä¸Šä¸‹æ–‡å¤„ç†å™¨, æœªç™»å½•æˆ–ç™»å½•å¤±æ•ˆåçš„å¤„ç†å™¨</li></ol><p>å…¶æ¬¡æˆ‘ä»¬è¦å®ç°èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„ä¸åŒé…ç½®</p><p>æˆ‘ä»¬åˆ†åˆ«å®ç°ä¸Šé¢çš„é…ç½®ç±», åˆ†åˆ«æ·»åŠ ä¸åŒçš„é…ç½®</p><p>è®¤è¯æœåŠ¡é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthenticationApplicationSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">ApplicationSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLogoutHandler userLogoutHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserLogoutSuccessHandler userLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoginSuccessHandler loginSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoginFailureHandler loginFailureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthenticationApplicationSecurityConfig</span><span class="params">(ServerProperties serverProperties,</span></span><br><span class="line"><span class="params">                                                   AuthenticationSaveHandler authenticationSaveHandler,</span></span><br><span class="line"><span class="params">                                                   UserLogoutHandler userLogoutHandler,</span></span><br><span class="line"><span class="params">                                                   UserLogoutSuccessHandler userLogoutSuccessHandler,</span></span><br><span class="line"><span class="params">                                                   LoginSuccessHandler loginSuccessHandler,</span></span><br><span class="line"><span class="params">                                                   LoginFailureHandler loginFailureHandler,</span></span><br><span class="line"><span class="params">                                                   CustomerAuthenticationHandler customerAuthenticationHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serverProperties, authenticationSaveHandler, customerAuthenticationHandler);</span><br><span class="line">        <span class="built_in">this</span>.loginSuccessHandler = loginSuccessHandler;</span><br><span class="line">        <span class="built_in">this</span>.loginFailureHandler = loginFailureHandler;</span><br><span class="line">        <span class="built_in">this</span>.userLogoutHandler = userLogoutHandler;</span><br><span class="line">        <span class="built_in">this</span>.userLogoutSuccessHandler = userLogoutSuccessHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line">        http.securityMatcher(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/logout&quot;</span>);</span><br><span class="line">        http.formLogin((config) -&gt;</span><br><span class="line">                        config</span><br><span class="line">                                .usernameParameter(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">                                .passwordParameter(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">                                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                                .failureHandler(loginFailureHandler)</span><br><span class="line">                                .successHandler(loginSuccessHandler)</span><br><span class="line">        );</span><br><span class="line">        http.logout(</span><br><span class="line">                (config) -&gt; config</span><br><span class="line">                        .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                        .addLogoutHandler(userLogoutHandler)</span><br><span class="line">                        .logoutSuccessHandler(userLogoutSuccessHandler)</span><br><span class="line">        );</span><br><span class="line">        http.exceptionHandling(config -&gt;</span><br><span class="line">                config.authenticationEntryPoint(customerAuthenticationHandler)</span><br><span class="line">        );</span><br><span class="line">        http.securityContext(config -&gt;</span><br><span class="line">             config.securityContextRepository(authenticationSaveHandler)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¤è¯æœåŠ¡é…ç½®ä¸­æˆ‘ä»¬åšäº†<code>SecurityFilterChain</code>çš„å®ç°, é…ç½®äº†å…¬å…±é…ç½®ä¹‹å¤–ç™»å½•å’Œæ³¨é”€æ“ä½œ, ä»¥åŠè·¯å¾„åŒ¹é…è§„åˆ™</p><p>èµ„æºæœåŠ¡é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceApplicationSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">ApplicationSecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResourceApplicationSecurityConfig</span><span class="params">(ServerProperties serverProperties, AuthenticationSaveHandler authenticationSaveHandler, CustomerAuthenticationHandler customerAuthenticationHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(serverProperties, authenticationSaveHandler, customerAuthenticationHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">contextPath</span> <span class="operator">=</span> serverProperties.getServlet().getContextPath();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(contextPath)) &#123;</span><br><span class="line">            contextPath = <span class="string">&quot;/**&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            contextPath = (!contextPath.startsWith(<span class="string">&quot;/&quot;</span>) ? <span class="string">&quot;/&quot;</span> : <span class="string">&quot;&quot;</span>) + contextPath + <span class="string">&quot;/**&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> contextPath;</span><br><span class="line">        http.csrf(AbstractHttpConfigurer::disable);</span><br><span class="line"></span><br><span class="line">        http.securityMatcher(path);</span><br><span class="line">        http.authorizeHttpRequests(</span><br><span class="line">                (auth) -&gt; auth</span><br><span class="line">                        .requestMatchers(HttpMethod.OPTIONS)</span><br><span class="line">                        .permitAll()</span><br><span class="line">                        .anyRequest()</span><br><span class="line">                        .authenticated()</span><br><span class="line">        );</span><br><span class="line">        http.exceptionHandling(config -&gt;</span><br><span class="line">                config.authenticationEntryPoint(customerAuthenticationHandler)</span><br><span class="line">        );</span><br><span class="line">        http.securityContext(config -&gt;</span><br><span class="line">                config.securityContextRepository(authenticationSaveHandler)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ„æºæœåŠ¡é…ç½®ä¸­æˆ‘ä»¬æ·»åŠ äº†é™¤äº†å…¬å…±é…ç½®å¤–çš„è·¯å¾„åŒ¹é…è§„åˆ™, æƒé™éªŒè¯è§„åˆ™</p><p><mark>åœ¨å…¬å…±é…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰è¿›è¡Œ<code>SecurityFilterChain</code>çš„<code>bean</code>é…ç½®, åªæ˜¯åœ¨è¯¥ç±»ä¸­è¦æ±‚å¿…é¡»æ·»åŠ å…¬å…±é…ç½®éœ€è¦çš„å†…å®¹, å…·ä½“é…ç½®åº”å½“åœ¨å…·ä½“é…ç½®ä¸­æ·»åŠ </mark></p><h4 id="èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†å¯¼å…¥"><a class="markdownIt-Anchor" href="#èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†å¯¼å…¥"></a> èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†å¯¼å…¥</h4><p>ä¸Šé¢æˆ‘ä»¬å®Œæˆäº†èµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡çš„åŒºåˆ†é…ç½®, ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰æ·»åŠ <code>@Configuration</code>æ³¨è§£ä½¿ç”¨</p><p>ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸åŒçš„æ³¨è§£, å°†æœåŠ¡åˆ’åˆ†ä¸ºèµ„æºæœåŠ¡å’Œè®¤è¯æœåŠ¡, ç„¶ååŒºåˆ«å¼•å…¥é…ç½®</p><p>è®¤è¯æœåŠ¡æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;AuthenticationApplicationSecurityConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AuthenticationApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¤è¯æœåŠ¡æ³¨è§£çš„ä½œç”¨æ˜¯é€šè¿‡<code>Import</code>çš„æ–¹å¼å¯¼å…¥è®¤è¯æœåŠ¡é…ç½®</p><p>èµ„æºæœåŠ¡æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;ResourceApplicationSecurityConfig.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ResourceApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ„æºæœåŠ¡æ³¨è§£çš„ä½œç”¨æ˜¯é€šè¿‡<code>Import</code>çš„æ–¹å¼å¯¼å…¥èµ„æºæœåŠ¡é…ç½®</p><p>è®¤è¯æœåŠ¡çš„å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AuthenticationApplication</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">SpringApplication.run(SecurityApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ„æºæœåŠ¡çš„å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResourceApplication</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictServiceApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">SpringApplication.run(DictServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ç°æè¿°"><a class="markdownIt-Anchor" href="#å®ç°æè¿°"></a> å®ç°æè¿°</h4><p>æˆ‘ä»¬é€šè¿‡<code>@ResourceApplication</code>å’Œ<code>@AuthenticationApplication</code>åˆ†åˆ«å¯¼å…¥èµ„æºé…ç½®ç±»<code>ResourceApplicationSecurityConfig</code>å’Œè®¤è¯é…ç½®ç±»<code>AuthenticationApplicationSecurityConfig</code>, åœ¨èµ„æºé…ç½®ç±»å’Œè®¤è¯é…ç½®ç±»ä¸­è¿›è¡Œä¸åŒçš„é…ç½®, å®ç°æœåŠ¡çš„ä¸åŒåº”ç”¨</p><p>å¦‚æœä¸å¤ªç†è§£, å¯ä»¥äº†è§£ä¸€ä¸‹<code>@Import</code>æ³¨è§£çš„ä½œç”¨å’Œä½¿ç”¨: <a href="https://juejin.cn/post/7217994625343635514">https://juejin.cn/post/7217994625343635514</a></p><h4 id="beanæ³¨å†Œä¼˜åŒ–"><a class="markdownIt-Anchor" href="#beanæ³¨å†Œä¼˜åŒ–"></a> <code>Bean</code>æ³¨å†Œä¼˜åŒ–</h4><p>åˆ°ä¸Šè¿°é˜¶æ®µ, æˆ‘ä»¬åªéœ€è¦å°†é…ç½®è¿‡ç¨‹ä¸­éœ€è¦çš„<code>bean</code>æ³¨å†Œåˆ°å®¹å™¨ä¸­å³å¯å®ç°æ­£å¸¸è¿è¡Œ, ä½†æ˜¯æ™®é€šçš„<code>bean</code>æ³¨å†Œä¸ä¼šåŒºåˆ†æœåŠ¡ç±»å‹, ç›´æ¥å°†å…¶æ³¨å†Œä¸º<code>bean</code>, ä¸ºäº†ä¼˜é›…äº›, æˆ‘ä»¬ç²—ç•¥å®ç°ä¸‹åªæœ‰è®¤è¯æœåŠ¡å’Œèµ„æºæœåŠ¡æ—¶æ‰æ³¨å†Œæ‰€éœ€çš„<code>bean</code>çš„åŠŸèƒ½</p><p>æ–¹æ¡ˆä¸€: ç†è§£æ¯”è¾ƒå¤æ‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Conditional(SecurityBeans.SecurityBeansCondition.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityBeans</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationSaveHandler <span class="title function_">authenticationSaveHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisAuthenticationSaveHandler</span>(redisUtil);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserLogoutHandler <span class="title function_">userLogoutHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserLogoutHandler</span>(authenticationSaveHandler());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserLogoutSuccessHandler <span class="title function_">userLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginSuccessHandler <span class="title function_">loginSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFailureHandler <span class="title function_">loginFailureHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginFailureHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomerAuthenticationHandler <span class="title function_">customerAuthenticationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomerAuthenticationHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityBeansCondition</span> <span class="keyword">extends</span> <span class="title class_">AnyNestedCondition</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SecurityBeansCondition</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@ConditionalOnBean(annotation = ResourceApplication.class)</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OnResourceApplication</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@ConditionalOnBean(annotation = AuthenticationApplication.class)</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OnAuthenticationApplication</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±», åœ¨å…¶ä¸­è¿›è¡Œ<code>bean</code>æ³¨å†Œ, å¹¶å°†è¯¥ç±»ä½¿ç”¨<code>@Configuration</code>å’Œ<br /><code>@Conditional</code>ä¿®é¥°, è¡¨ç¤ºæ»¡è¶³æ¡ä»¶æ—¶, æ³¨å†Œè¯¥é…ç½®ç±», è¿™æ ·ç±»ä¸­é…ç½®çš„<code>bean</code>ä¹Ÿä¼šæ³¨å†Œåˆ°å®¹å™¨ä¸­, ä¸æ»¡è¶³æ—¶åˆ™ä¸ä¼šæ³¨å†Œè¯¥é…ç½®ç±», ç±»ä¸­çš„<code>bean</code>ä¹Ÿä¸ä¼šæ³¨å†Œ</p><p>åˆ›å»ºä¸€ä¸ª&quot;æˆ–&quot;æ¡ä»¶åŠ è½½ç±», æ¡ä»¶æ˜¯å®¹å™¨ä¸­æœ‰<code>bean</code>è¢«<code>@ResourceApplication</code>æˆ–è€…è¢«<code>@AuthenticationApplication</code>ä¿®é¥°æ—¶, æ‰§è¡Œ<code>bean</code>æ³¨å†Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SecurityBeansCondition</span> <span class="keyword">extends</span> <span class="title class_">AnyNestedCondition</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityBeansCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnBean(annotation = ResourceApplication.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OnResourceApplication</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConditionalOnBean(annotation = AuthenticationApplication.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OnAuthenticationApplication</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„ä½¿ç”¨çš„æ˜¯é™æ€å†…éƒ¨ç±»çš„æ–¹å¼, è¿™æ ·åœ¨ä¸€ä¸ªç±»ä¸­æ¯”è¾ƒæ–¹ä¾¿</p><p>ç®€è¿°:</p><p>åœ¨<code>SecurityBeansCondition</code>ä¸­å®ç°ä¸¤ç§æ³¨è§£çš„&quot;æˆ–&quot;æ“ä½œ, è¿™æ ·åœ¨<code>SecurityBeans</code>åŠ è½½æ—¶, å¦‚æœæ»¡è¶³åˆ™è¿›è¡Œæ³¨å†Œå¤„ç†</p><p><a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/condition/AnyNestedCondition.html">https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/condition/AnyNestedCondition.html</a></p><p><a href="https://www.cnblogs.com/hellxz/p/16253857.html">https://www.cnblogs.com/hellxz/p/16253857.html</a></p><p>æ–¹æ¡ˆäºŒ:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityBeans</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationSaveHandler <span class="title function_">authenticationSaveHandler</span><span class="params">(RedisUtil redisUtil)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisAuthenticationSaveHandler</span>(redisUtil);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserLogoutHandler <span class="title function_">userLogoutHandler</span><span class="params">(AuthenticationSaveHandler authenticationSaveHandler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserLogoutHandler</span>(authenticationSaveHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserLogoutSuccessHandler <span class="title function_">userLogoutSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserLogoutSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginSuccessHandler <span class="title function_">loginSuccessHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginSuccessHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFailureHandler <span class="title function_">loginFailureHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginFailureHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomerAuthenticationHandler <span class="title function_">customerAuthenticationHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomerAuthenticationHandler</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;AuthenticationApplicationSecurityConfig.class, SecurityBeans.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AuthenticationApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123;ResourceApplicationSecurityConfig.class, SecurityBeans.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ResourceApplication &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åº”ç”¨<code>@Import</code>çš„å¯¼å…¥åŸç†</p><h3 id="å¤„ç†æœåŠ¡é—´è°ƒç”¨å½±å“"><a class="markdownIt-Anchor" href="#å¤„ç†æœåŠ¡é—´è°ƒç”¨å½±å“"></a> å¤„ç†æœåŠ¡é—´è°ƒç”¨å½±å“</h3><p>åœ¨æ·»åŠ è®¤è¯ä¹‹åä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå‰é¢åšçš„<code>OpenFeign</code>æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¼šå¼‚å¸¸ï¼Œè¿™æ˜¯ç”±äºæœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¹Ÿæ·»åŠ äº†éªŒè¯ä½†æ˜¯æœåŠ¡ä¹‹é—´è°ƒç”¨æ²¡æœ‰æ·»åŠ å¯¹åº”çš„éªŒè¯ä¿¡æ¯ã€‚</p><p>å¤„ç†ä¸Šè¿°é—®é¢˜å¯ä»¥åœ¨<code>OpenFeign</code>æœåŠ¡è°ƒç”¨æ—¶å°†åŸè¯·æ±‚çš„æ‰€æœ‰è¯·æ±‚å¤´ä¿¡æ¯æ·»åŠ åˆ°æœåŠ¡é—´è°ƒç”¨è¯·æ±‚ä¸­</p><p>å®ç°æ–¹æ³•æ—¶æ·»åŠ ä¸€ä¸ª<code>OpenFeign</code>çš„è¯·æ±‚æ‹¦æˆªå™¨ï¼Œè·å–åˆ°åŸè¯·æ±‚çš„è¯·æ±‚å¤´ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æœåŠ¡è°ƒç”¨è¯·æ±‚å¤´ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.xiaolin.*.clients&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenFeignConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">requestInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> template -&gt; &#123;</span><br><span class="line">                <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">                <span class="keyword">if</span> (Objects.nonNull(requestAttributes)) &#123;</span><br><span class="line">                    <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">                    Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line">                    <span class="keyword">if</span> (Objects.nonNull(headerNames)) &#123;</span><br><span class="line">                        <span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">headerName</span> <span class="operator">=</span> headerNames.nextElement();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">headerValue</span> <span class="operator">=</span> request.getHeader(headerName);</span><br><span class="line">                            template.header(headerName, headerValue);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å…¶ä»– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(ä¸ƒ)---è®¤è¯å’Œæˆæƒ</title>
      <link href="/2024/02/03/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%83%E4%B9%8B%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/"/>
      <url>/2024/02/03/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%83%E4%B9%8B%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>é¡¹ç›®çš„å‰ç«¯æ¡†æ¶åŸºæœ¬æ­å»ºå®Œæˆå, æ¥åˆ°é¡¹ç›®æ¯”è¾ƒæŠ½è±¡çš„åœ°æ–¹, ç™»å½•å’Œæˆæƒ. è¯´å…¶æŠ½è±¡ä¸»è¦æ˜¯å› ä¸ºä½¿ç”¨<code>SpringSecurity</code>æ¡†æ¶çš„åŸå› , <code>SpringSecurity</code>æ¡†æ¶æœºåˆ¶å¥å…¨åˆ‡å¼ºå¤§, ä½†ç”±äºå…¶å°è£…çš„éå¸¸å¥½, æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶å¼€å‘äººå‘˜ä¼šè§‰å¾—éå¸¸æŠ½è±¡, åŠ¨ä¸åŠ¨çš„å°±è®¤è¯å¼‚å¸¸, ä¸€ä¸å°å¿ƒå°±å¼¹å‡ºé»˜è®¤çš„ç™»å½•é¡µé¢, ä¹Ÿä¼šå‡ºç°å„ç§ä¸ç†è§£çš„æƒ…å†µ, æ‰€ä»¥æ¥è¸©å‘å§</p><p>ç”±äºå¼€å§‹é¡¹ç›®æ—¶<code>springboot</code>ä½¿ç”¨çš„æ˜¯<code>3.1.5</code>ç‰ˆæœ¬, æ‰€ä»¥æ­¤å¤„ä¹Ÿä½¿ç”¨åŒç‰ˆæœ¬çš„<code>SpringSecurity</code></p><p>å½“å‰ç½‘ä¸Šä»‹ç»<code>SpringSecurity</code>çš„æ–‡ç« å¤§è‡´åˆ†ä¸ºä¸¤ç±», ä¸€ç±»æ˜¯è®²æºç , ä¸€ç±»æ˜¯è®²ä½¿ç”¨çš„. æœ¬ç¯‡æ˜¯è®²<code>SpringSecurity</code>çš„ä½¿ç”¨çš„æ–‡ç« , æ‰€ä»¥æš‚ä¸è¯„è®ºå°†æºç çš„æ–‡ç« å¦‚ä½•, ä½†å¯¹äºå°†ä½¿ç”¨çš„æ–‡ç« , æˆ‘åªèƒ½è¯´é™¤äº†éƒ¨åˆ†å¤§ä½¬çš„æ–‡ç« å¤–, å…¶ä»–éƒ½æ˜¯ğŸ‘</p><p>ä¸ªäººè®¤ä¸ºè®²ä½¿ç”¨çš„æ–‡ç« è¦åšåˆ°ä¸¤ç‚¹: 1.æ€æ ·ç”¨;2. æ¯ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯ä»€ä¹ˆ.ä½†ç»å¤§å¤šæ•°çš„æ–‡ç« å°±æ˜¯å‘Šè¯‰å±äºè€…ä½ è¦è¿™æ ·åš, ç„¶åå°±æˆåŠŸäº†, è¯»è€…çœ‹äº†ä¹‹åæˆåŠŸäº†, ä½†æ ¹æœ¬ä¸çŸ¥é“è‡ªå·±åšäº†ä»€ä¹ˆ,ç‰¹åˆ«æ˜¯åƒæˆ‘è¿™ç§ä¹‹å‰æ²¡æœ‰åšè¿‡è®¤è¯æˆæƒ(ç™»å½•)å†…å®¹çš„<code>loser</code>, æœ¬èº«å°±ä¸äº†è§£, æ–‡ç« ä¹Ÿè®²ä¸æ¸…æ¥š, ä¸ªäººå¾ˆè¿·èŒ«å•Š</p><p>ç”±äº<code>SpringSecurity</code>å†…å®¹å¾ˆå¤š, ä½†æœ€é‡è¦çš„æ˜¯é…ç½®å†…å®¹, æœ¬ç¯‡ä¼šä»‹ç»<code>SpringSecurity</code>ä¸­é‡è¦çš„å†…å®¹è®²è§£, å…¶ä»–å†…å®¹æˆ–è®¸ä¸€å¥è¯å¸¦è¿‡</p><p><mark>å¦‚æœæƒ³å¿«é€Ÿæ˜ç™½è¯¥å¦‚ä½•é…ç½®, å¯ä»¥ç›´æ¥çœ‹<a href="#è®¤è¯æµç¨‹" style="font-weight: blod">è®¤è¯æµç¨‹</a>éƒ¨åˆ†</mark></p><h3 id="å¼•å…¥springsecurity"><a class="markdownIt-Anchor" href="#å¼•å…¥springsecurity"></a> å¼•å…¥<code>SpringSecurity</code></h3><h4 id="æ·»åŠ ä¾èµ–"><a class="markdownIt-Anchor" href="#æ·»åŠ ä¾èµ–"></a> æ·»åŠ ä¾èµ–</h4><ol><li><p>çˆ¶çº§é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äº<code>SpringSecurity</code>çš„ä¾èµ–åœ¨<code>SpringBoot</code>çš„<code>spring-boot-dependencies</code>ä¸­å¼•å…¥, æ‰€ä»¥åœ¨çˆ¶é¡¹ç›®ä¸­ä¸å¿…è¦æ˜¾å¼çš„å£°æ˜å¼•å…¥</p><p>æ‰ç”¨<code>starter</code>çš„æ–¹å¼æ—¶, é»˜è®¤å°±ä¼šæœ‰<code>@EnableWebSecurity</code>æ³¨è§£, æ‰€ä»¥ä¼šå‘ç°, å½“å¼•å…¥ä¾èµ–å, å°±éœ€è¦è¿›è¡Œç™»å½•æ“ä½œäº†. å¦‚æœåªæ˜¯å•çº¯çš„è¿›å…¥<code>security</code>çš„ä¾èµ–, éœ€è¦æ·»åŠ è¯¥æ³¨è§£å¼€å¯ç›¸å…³å†…å®¹</p></li><li><p>å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>è¯´æ˜</p><ul><li>ç™»å½•æ“ä½œå…ˆåœ¨ä¸€ä¸ªå­é¡¹ç›®ä¸­å®ç°, ç„¶åæ·»åŠ åˆ°æ•´ä¸ªé¡¹ç›®ä¸­, åœ¨åˆ†å¸ƒå¼ä¸­å®ç°ä¸€å¤„ç™»å½•</li><li>åç»­åœ¨åˆ†å¸ƒåˆ°æ•´ä¸ªé¡¹ç›®ä¸­æ—¶, å¯èƒ½ä¼šå°†ç™»å½•æ“ä½œæ”¾ç½®åœ¨ç½‘å…³å­é¡¹ç›®ä¸­, æ‰€ä»¥ä¼šæœ‰æ™®é€šé¡¹ç›®åˆ°ç½‘å…³é¡¹ç›®çš„ç™»å½•æ”¹é€ </li></ul></li></ol><h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4><p>åœ¨ä½¿ç”¨<code>starter</code>æ—¶, ä¸éœ€è¦ä»»ä½•é…ç½®, æ—¢å¯ä»¥æ­£å¸¸ä½¿ç”¨<code>Security</code>, å¦‚æœå¼•å…¥çš„æ˜¯å•çº¯çš„<code>Security</code>, åˆ™éœ€è¦å†é…ç½®ç±»ä¸Šæ·»åŠ <code>@EnableWebSecurity</code>æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Security</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜"></a> è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜</h3><p>å½“éœ€è¦è‡ªå®šä¹‰é…ç½®æ—¶, ä¸»è¦æ˜¯è‡ªå®šä¹‰é…ç½®ä¸¤ä¸ªå†…å®¹:1. <code>HttpSecurity</code>; 2. <code>WebSecurity</code>. è¿™ä¸¤ä¸ªä¸œè¥¿è®²èµ·æ¥å°±å•°å—¦äº†</p><ol><li><p>é¦–å…ˆåŒºåˆ†è¯·æ±‚ä¸­çš„å®¹å™¨: <code>servlet</code>å®¹å™¨å’Œ<code>spring</code>å®¹å™¨, <code>servlet</code>å®¹å™¨ä¸»è¦æ˜¯ä¸ºè¯·æ±‚æœåŠ¡çš„, ä¸»è¦æœ‰ä¸¤ç±»: <code>Filter</code>å’Œ<code>Servlet</code>, <code>Servlet</code>æ˜¯å¯¹è¯·æ±‚è¿›è¡Œå…·æœ‰å®é™…æ„ä¹‰çš„å†…å®¹å¤„ç†, å¯ä»¥å‚ç…§<code>spring mvc</code>ä¸­çš„<code>controller+service+dao</code>, <code>Filter</code>æ˜¯å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†æˆ–è€…åç½®å¤„ç†; <code>spring</code>å®¹å™¨å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<code>spring</code>çš„<code>bean</code></p></li><li><p>å…¶æ¬¡åŒºåˆ†<code>Filter</code>: <code>Filter</code>æ ¹æ®å®¹å™¨ä¸åŒ, æœ‰<code>servlet</code>çš„<code>Filter</code>å’Œ<code>spring</code>çš„<code>Filter</code>, é€šå¸¸æˆ‘ä»¬ä½¿ç”¨<code>spring</code>çš„æ–¹å¼æ³¨å†Œçš„<code>Filter</code>éƒ½æ˜¯<code>spring</code>çš„<code>Filter</code>; <code>servlet</code>å¿…é¡»æ˜¯ç»§æ‰¿è‡ª<code>javax.serlvet.Filter</code>(<code>tomcat-embed-core</code>ä¾èµ–åŒ…åº”è¯¥æ˜¯<code>jakarta.servlet.Filter</code>)æ¥å£, å¹¶é€šè¿‡<code>web.xml</code>(<code>SpirngBoot</code>æ˜¯é€šè¿‡<code>@WebFilter</code>æ³¨è§£)æ³¨å†Œåˆ°<code>servlet</code>å®¹å™¨ä¸­(ä¸æ˜ç™½çš„å¯ä»¥å…ˆå­¦ä¹ ä¸€ä¸‹<code>servlet</code>å¼€å‘)</p></li><li><p>åœ¨äº†è§£ä¸Šè¿°ä¸¤ä¸ªå†…å®¹ä¹‹å, å°±å†è®¤è¯†ä¸‰ä¸ªåè¯:</p><ul><li><code>DelegatingFilterProxy</code>(å§”æ´¾è¿‡æ»¤å™¨ä»£ç†, <code>servlet</code>ä¸­çš„<code>Filter</code>ä¸<code>spring</code>ä¸­çš„<code>Filter</code>çš„æ¡¥æ¥å™¨, <code>spring web</code>ä¸­å®šä¹‰çš„, ä»»ä½•æ¡†æ¶éƒ½å¯ä»¥é€šè¿‡æ­¤æ–¹å¼æ·»åŠ <code>Filter</code>åˆ°<code>servlet</code>æ‰§è¡Œé“¾ä¸­);</li><li><code>FilterChainProxy</code> (<code>spring</code>å®¹å™¨ä¸­çš„è¿‡æ»¤å™¨é“¾ä»£ç†, å†…éƒ¨ç»´æŠ¤å¤šä¸ª<code>spring</code>è¿‡æ»¤å™¨é“¾, åœ¨<code>SpringSecurity</code>ä¸­å®šä¹‰çš„, å³ä¸“é—¨ä¸º<code>SpringSecurity</code>ä½¿ç”¨);</li><li><code>SecurityFilterChain</code>(å®‰å…¨æ¡†æ¶çš„è¿‡æ»¤å™¨é“¾, åœ¨<code>SpringSecurity</code>ä¸­å®šä¹‰çš„, è®¤è¯æµç¨‹çš„å¤„ç†è¿‡ç¨‹)</li></ul></li><li><p>ç›´æ¥ä¸Šå›¾</p><p><img src="Security%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E6%9E%B6%E6%9E%84.png" alt="Securityçš„è¿‡æ»¤å™¨é“¾æ¶æ„" /></p></li><li><p>ç°åœ¨è®²<code>WebSecurity</code>å’Œ<code>HttpSecurity</code>. <code>Security</code>çš„åŸç†å°±æ˜¯æ ¹æ®ä¸åŒçš„è·¯å¾„, åŒ¹é…ä¸åŒçš„<code>SecurityFilterChain</code></p><ul><li><code>HttpSecurity</code>æ˜¯ç”¨æ¥æ„å»º<code>SecurityFilterChain</code>çš„, <code>HttpSecurity</code>æ¯<code>build</code>ä¸€æ¬¡, å°±æ„å»ºå‡ºä¸€æ¡å®Œæ•´çš„<code>SecurityFilterChain</code>, æ¯ä¸ª<code>SecurityFilterChain</code>æ ¹æ®é…ç½®ä¸åŒ, æœ‰ä¸åŒæ•°é‡çš„è¿‡æ»¤å™¨, å½“é¡¹ç›®ä¸­æ²¡æœ‰æ„å»º<code>SecurityFilterChain</code>æ—¶, æ¡†æ¶ä¼šæ·»åŠ ä¸€æ¡é»˜è®¤çš„<code>SecurityFilterChain</code> ;</li><li><code>WebSecurity</code>æ˜¯ç”¨æ¥æ„å»º<code>FilterChainProxy</code>çš„æ„å»ºç±», å®ƒä¼šç»´æŠ¤é¡¹ç›®ä¸­æ·»åŠ çš„<code>SecurityFilterChain</code>, æ ¹æ®<code>SecurityFilterChain</code>ä¸­çš„è·¯å¾„åŒ¹é…è§„åˆ™, è°ƒç”¨ä¸åŒçš„<code>SecurityFilterChain</code></li><li><img src="Security%E4%B8%AD%E7%9A%84%E6%9E%84%E5%BB%BA%E5%85%B3%E7%B3%BB.png" alt="Securityä¸­çš„æ„å»ºå…³ç³»" /></li></ul></li><li><p>æ¼”ç¤º</p><p><img src="Security%E7%9A%84WebSecurity%E5%92%8CHttpSecurity%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F.png" alt="Securityçš„WebSecurityå’ŒHttpSecurityé…ç½®æ–¹å¼" /></p><p><img src="Security%E4%B8%ADWebSecurity%E5%92%8CHttpSecurity%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%9C%E6%BC%94%E7%A4%BA.png" alt="Securityä¸­WebSecurityå’ŒHttpSecurityé…ç½®ç»“æœæ¼”ç¤º" /></p></li><li><p>è¯´æ˜</p><ul><li><p>ä¸ªäººä¸å¤ªæ¨èä½¿ç”¨<code>addSecurityFilterChainBuilder</code>çš„æ–¹å¼æ·»åŠ <code>SecurityFilterChain</code>, è¿™ç§æ–¹å¼å®šä¹‰æ¯”è¾ƒéº»çƒ¦. ä¸åŒçš„<code>SecurityFilterChain</code>å¯ä»¥é€šè¿‡å®šä¹‰ä¸åŒçš„<code>SecurityFilterChain</code>çš„<code>Bean</code>å®ä¾‹, é€šè¿‡<code>SecurityFilterChain</code>çš„<code>securityMatcher</code>æ¥å®ç°ä¸åŒè¯·æ±‚çš„å¤„ç†</p></li><li><p>é¡¹ç›®ä¸­çš„é™æ€èµ„æºæ¨èä½¿ç”¨<code>ignoring</code>çš„æ–¹å¼å®ç°, å› ä¸ºå¤§å¤šæ•°é™æ€èµ„æºéƒ½æ˜¯å…è®¸ç›´æ¥è®¿é—®çš„</p></li><li><p>åŒä¸€ä¸ª<code>HttpSecurity</code>æ˜¯ä¸å…è®¸é‡å¤æ„å»ºçš„, é‡å¤æ„å»ºæ—¶ä¼šå‡ºç°å·²æ„å»ºçš„é”™è¯¯, æ‰€ä»¥è¯´ç¬¬ä¸€ç‚¹ä¸­çš„<code>addSecurityFilterChainBuilder</code>æ·»åŠ æ¯”è¾ƒéº»çƒ¦, åŒæ—¶ä¹Ÿæ‹’ç»äº†ç›´æ¥æ„å»º<code>List&lt;SecurityFilterChain&gt;</code>çš„é“è·¯. ä½†æ˜¯æ¯æ¬¡åˆ›å»ºæ–°çš„<code>SecurityFilterChain</code>æ—¶æ³¨å…¥çš„<code>HttpSecurity</code>éƒ½æ˜¯ä¸åŒçš„, æ‰€ä»¥æ¨èæ­¤æ–¹å¼æ·»åŠ <code>SecurityFilterChain</code>.</p><p><img src="Security%E4%B8%8D%E5%90%8C%E7%9A%84HttpSecurity.png" alt="Securityä¸åŒçš„HttpSecurity" /></p></li></ul></li></ol><h3 id="é…ç½®websecurity"><a class="markdownIt-Anchor" href="#é…ç½®websecurity"></a> é…ç½®<code>WebSecurity</code></h3><p><img src="Security%E7%9A%84WebSecurity%E7%9A%84%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9.png" alt="Securityçš„WebSecurityçš„é…ç½®å†…å®¹" /></p><p>ä¸Šè¿°æ˜¯<code>WebSecurity</code>ä¸­çš„å¯é…ç½®å†…å®¹</p><ul><li><code>ignoring</code>: å¿½ç•¥è·¯å¾„</li><li><code>httpFirewall</code>: é˜²ç«å¢™</li><li><code>debug</code>: æ˜¯å¦å¼€å¯<code>debug</code></li><li><code>addSecurityFilterChainBuilder</code>: æ·»åŠ ä¸€ä¸ª<code>SecurityFilterChain</code></li><li><code>privilegeEvaluator</code>: ç‰¹æƒ, è¿™ä¸ªæˆ‘ä¹Ÿæ²¡æœ‰æ˜ç™½å…·ä½“è¦æ€ä¹ˆåš, å¤§è‡´æ˜¯è¯´åˆ¤æ–­æŸä¸ªè¯·æ±‚æ˜¯å¦æœ‰æŸç§ç‰¹æƒ, è‡³äºæ˜¯ä»€ä¹ˆæ ·çš„ç‰¹æƒ, æ€æ ·å®šä¹‰, ä¸ç”šäº†è§£</li><li><code>expressionHandler</code>: è¡¨è¾¾å¼å¤„ç†å™¨. ä¸æ˜ç™½ä¸è¦ç´§, å»æŸ¥çœ‹å‚æ•°, å¯ä»¥æ‰¾åˆ°<code>SecurityExpressionHandler</code>æ¥å£, æœ‰ä¸‰ä¸ªæ–¹æ³•, æŸ¥çœ‹å…¶æŠ½è±¡å®ç°ç±»<code>AbstractSecurityExpressionHandler</code>, å…¶ä¸­æœ‰ä¸€ä¸ªè§£æå™¨<code>SpelExpressionParser</code>, è¿™æ˜¯<code>spring</code>çš„<code>spel</code>è¡¨è¾¾å¼è§£æå™¨, è¯¥ç±»ä¸­è¿˜èƒ½æ‰¾åˆ°<code>SecurityExpressionOperations</code>è¿™ä¸ªç±», çœ‹åˆ°å…¶ä¸­çš„æ–¹æ³•åå°±æ˜ç™½äº†, è§£ææ§åˆ¶å™¨ä¸­æ–¹æ³•çš„<code>@PreAuthorize</code>ç­‰æƒé™æ³¨è§£ä¸­å®šä¹‰çš„è¡¨è¾¾å¼å†…å®¹. è¯¥æ–¹æ³•æ˜¯ä¸ºäº†æ·»åŠ è‡ªå·±çš„è¡¨è¾¾å¼è§£æç±»</li><li><code>postBuildAction</code>: æ„å»ºåçš„å¤„ç†, å‚æ•°æ˜¯ä¸€ä¸ª<code>Runnable</code>ä»»åŠ¡</li><li><code>requestRejectedHandler</code>: è¯·æ±‚æ‹’ç»å¤„ç†å™¨, ç”¨æ¥å¤„ç†é˜²ç«å¢™çš„æ‹’ç»å¼‚å¸¸çš„å¤„ç†å™¨</li></ul><p>é…ç½®<code>WebSecurity</code>ä¸»è¦æ˜¯ä¸ºäº†å°†è·¯å¾„æ”¾è¡Œ, é¿å…æŸäº›èµ„æºå³ä½¿æ”¾è¡Œè¿˜è¦èµ°ä¸€ä¸ªå®Œæ•´çš„<code>SecurityFilterChain</code>, æ­¤æ–¹å¼æ·»åŠ çš„<code>SecurityFilterChain</code>ä¸­æ²¡æœ‰ä»»ä½•<code>Filter</code>, ç›´æ¥å‘ä¸‹è¿è¡Œ; <code>WebSecurity</code>ä¸­çš„å…¶ä»–é…ç½®å¯æŒ‰éœ€è‡ªè¡Œæ·»åŠ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebSecurityCustomizer <span class="title function_">webSecurityCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> web -&gt; web</span><br><span class="line">        .ignoring().requestMatchers(<span class="string">&quot;/static/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å³æ˜¯æ”¾è¡Œ<code>/static</code>è·¯å¾„ä¸‹çš„æ‰€æœ‰è¯·æ±‚</p><h3 id="é…ç½®httpsecurity"><a class="markdownIt-Anchor" href="#é…ç½®httpsecurity"></a> é…ç½®<code>HttpSecurity</code></h3><p><code>HttpSecurity</code>æ˜¯<code>security</code>é…ç½®çš„é‡ç‚¹</p><ol><li><p>å¯ä»¥é€šè¿‡<code>HttpSecurity</code>é…ç½®å¤šä¸ª<code>SecurityFilterChain</code>, è¿™äº›<code>SecurityFilterChain</code>ä¹‹é—´éœ€è¦æ³¨æ„ä¸€äº›å†…å®¹</p><ul><li>ç”±äºæ¯ä¸ªè¯·æ±‚åªèƒ½èµ°ä¸€ä¸ª<code>SecurityFilterChain</code>, æ‰€ä»¥åœ¨é…ç½®æ—¶, å°½å¯èƒ½ä¸è¦å‡ºç°è·¯å¾„é…ç½®é‡å çš„æƒ…å†µ, é¿å…å‡ºç°èµ°é”™äº†<code>SecurityFilterChain</code>è€Œå¯¼è‡´çš„é—®é¢˜</li><li>å¦‚æœæ¥æ”¶çš„è¯·æ±‚æ²¡æœ‰è¢«è¦†ç›–åœ¨é…ç½®çš„<code>SecurityFilterChain</code>çš„æ˜ å°„è·¯å¾„ä¸­, åˆ™è¯¥è¯·æ±‚ä¼šè¢«ç›´æ¥é€šè¿‡, æ‰€ä»¥åœ¨è¿›è¡Œé…ç½®æ—¶éœ€è¦ç¡®ä¿æœ‰ä¸€ä¸ª<code>SecurityFilterChain</code>æ˜¯è¦†ç›–å…¨éƒ¨è¯·æ±‚çš„, å³ä¸Šé¢çš„å›¾ç‰‡ä¸­çš„<code>anyRequest</code>çš„<code>SecurityFilterChain</code></li><li>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬åªä¼šé…ç½®ä¸€ä¸ª<code>SecurityFilterChain</code>, è¿™ä¸ª<code>SecurityFilterChain</code>ä¸è¦é…ç½®<code>securityMatcher</code>è¿™ä¸€é¡¹, é¿å…è¦†ç›–<code>anyRequest</code>çš„<code>SecurityFilterChain</code>å¯¼è‡´çš„æ˜ å°„è·¯å¾„æ²¡æœ‰å…¨è¦†ç›–çš„æƒ…å†µ</li></ul></li><li><p><code>HttpSecurity</code>å¯ä»¥é…ç½®çš„å†…å®¹</p><p><code>HttpSecurity</code>å¯ä»¥é…ç½®çš„å†…å®¹éå¸¸å¤š, ç›®å‰<code>3.1.5</code>ç‰ˆæœ¬ä¸­, ä¿å®ˆä¼°è®¡æœ‰ä¸€åŠå·²ç»æ ‡è®°ä¸ºè¿‡æ—¶çš„æ–¹æ³•äº†, æ‰€ä»¥å°±ä¸æˆªå›¾äº†, è¿™é‡Œåˆ†ç±»ä»‹ç»ä¸€ä¸‹å§</p><ul><li>é…ç½®å½“å‰<code>SecurityFilterChain</code> å¤„ç†çš„æ˜ å°„è·¯å¾„: <code>securityMatchers</code></li><li>åœ¨å½“å‰<code>SecurityFilterChain</code>ä¸­æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤å™¨: <code>addFilter</code></li><li><code>csrf</code>é…ç½®: é»˜è®¤æ˜¯å¼€å¯çš„, å½“è®¾ç½®ä¸º<code>disable</code>æ—¶ä¼šå°†<code>SecurityFilterChain</code>ä¸­çš„è¯¥è¿‡æ»¤å™¨åˆ é™¤</li><li><code>cors</code>é…ç½®: é»˜è®¤æ˜¯æ²¡æœ‰çš„, å½“æ·»åŠ é…ç½®å, ä¼šæ·»åŠ ä¸€ä¸ª<code>CorsFilter</code></li><li>è®¤è¯é…ç½®: é»˜è®¤æ˜¯ä½¿ç”¨ç”¨æˆ·å¯†ç çš„è®¤è¯æ–¹å¼; è®¤è¯çš„å®ç°æ˜¯é€šè¿‡æ·»åŠ æ¯ä¸€ç§çš„è®¤è¯è¿‡æ»¤å™¨æ¥é…ç½®çš„, å®˜æ–¹å®šä¹‰æ”¯æŒçš„è®¤è¯æ–¹å¼:<ul><li><code>Basic</code>: <code>Basic</code>è¯·æ±‚å¤´çš„è®¤è¯æ–¹å¼, é€šè¿‡<code>httpBasic</code>é…ç½®, å¯ä»¥å‚è€ƒ<code>https://blog.csdn.net/ShiJunzhiCome/article/details/126064450</code></li><li>ç”¨æˆ·å¯†ç è®¤è¯: ç”¨æˆ·å, å¯†ç è®¤è¯, <code>username</code>, <code>password</code>, é€šè¿‡<code>formLogin</code>å¯é…ç½®</li><li><code>JAAS</code>: <code>jaas</code>è®¤è¯æ–¹å¼, å®˜æ–¹å¯èƒ½æ²¡æœ‰æä¾›è¯¥è®¤è¯æ–¹å¼çš„è¿‡æ»¤å™¨å®ç°. æœ‰ä¸€ä¸ªå¾ˆç›¸ä¼¼çš„<code>jee</code>æ–¹æ³•æ˜¯ç”¨æ¥é…ç½®<code>Java EE security</code>è¿‡æ»¤å™¨çš„</li><li><code>X509</code>: <code>X509</code>è®¤è¯å¯ä»¥é€šè¿‡<code>x509</code>é…ç½®</li><li><code>rememberMe</code>: è®°ä½ä¸€ä¸ªè¿‡äº†<code>session</code>æœ‰æ•ˆæœŸçš„ç”¨æˆ·, å¯ä»¥é€šè¿‡<code>rememberMe</code>é…ç½®</li><li><code>SAML 2.0 Login</code>: <code>SAML2.0</code>è®¤è¯å¯ä»¥é€šè¿‡<code>saml2Login</code>é…ç½®</li><li><code>OAuth 2.0 Login</code>: <code>OpenId Connect</code>å’Œéæ ‡å‡†çš„<code>OAuth 2.0</code>è®¤è¯, é€šè¿‡<code>oauth2Login</code>é…ç½®</li><li><code>CAS</code>: æ”¯æŒ, ä½†æ²¡æœ‰å®ç°è¿‡æ»¤å™¨</li><li><code>Pre-Authentication Scenatios</code>: ä½¿ç”¨å¤–éƒ¨æœºåˆ¶(å¦‚<code>SiteMinder</code>æˆ–<code>Java EE security</code>)è¿›è¡Œè®¤è¯, ä½†ä»ä½¿ç”¨<code>spring security</code>è¿›è¡Œæˆæƒä¿æŠ¤. é€šè¿‡<code>jee</code>å¯ä»¥é…ç½®<code>Java EE security</code></li><li>åŒ¿åè®¤è¯: é€šè¿‡<code>anonymous</code>å¯ä»¥é…ç½®åŒ¿åè®¤è¯</li></ul></li><li>è®¤è¯æ—¶å¯å…±ç”¨çš„é…ç½®:<ul><li><code>authenticationManager</code>: è®¤è¯ç®¡ç†å™¨, ç»´æŠ¤ä¸€ç»„è®¤è¯å¤„ç†å™¨, é»˜è®¤çš„æ˜¯<code>ProviderManager</code></li><li><code>AuthenticationProvider</code>: è®¤è¯å¤„ç†å™¨, æ­¤æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªè®¤è¯å¤„ç†å™¨, è¿™äº›è®¤è¯å¤„ç†å™¨é€šè¿‡<code>AuthenticationManager</code>è¿›è¡Œç»´æŠ¤ç®¡ç†, è¿›è¡Œè®¤è¯æ“ä½œæ—¶, ä¼šéå†<code>AuthenticationManager</code>ä¸­ç»´æŠ¤çš„<code>AuthenticationProvider</code>, é€šè¿‡<code>AuthenticationProvider</code>çš„<code>supports</code>åˆ¤æ–­æ˜¯å¦ç¬¦åˆéªŒè¯è¦æ±‚, ç¬¦åˆåˆ™é€šè¿‡<code>authenticate</code>æ–¹æ³•éªŒè¯, ç„¶åè·³è¿‡åç»­è¿˜æœªæ‰§è¡Œçš„éªŒè¯å¤„ç†å™¨</li><li><code>userDetailsService</code>: ç”¨æˆ·è¯¦æƒ…æœåŠ¡, ç”¨äºåŠ è½½ç”¨æˆ·çš„è¯¦æƒ…ä¿¡æ¯, é€šå¸¸ä¼šé‡å†™è¯¥å†…å®¹(æ³¨å†Œä¸€ä¸ªè¯¥æ¥å£çš„<code>@Bean</code>å®ä¾‹å³å¯æ›¿æ¢é»˜è®¤<code>SecurityFilterChain</code>ä¸­çš„ç”¨æˆ·è¯¦æƒ…æœåŠ¡), ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</li><li><code>exceptionHandling</code>: å¼‚å¸¸å¤„ç†, æ­¤æ–¹æ³•æ˜¯æ·»åŠ å¯å…±ç”¨çš„è®¤è¯å¼‚å¸¸å¤„ç†æœºåˆ¶</li><li><code>sessionManagement</code>: <code>session</code>ç®¡ç†</li><li><code>passwordManagement</code>: åŠ å¯†ç®¡ç†</li><li><code>authorizeHttpRequests</code>: è®¤è¯è¯·æ±‚é…ç½®</li><li><code>securityContext</code>: å®‰å…¨ä¸Šä¸‹æ–‡</li><li><code>setSharedObject</code>: å…±äº«å¯¹è±¡</li></ul></li><li>æ³¨é”€è®¤è¯é…ç½®: <code>logout</code></li><li>å…¶å®ƒé…ç½®æˆ‘ä¸å¤ªæ˜ç™½, å°±ä¸è¯¯äººå­å¼Ÿäº†</li></ul></li></ol><h3 id="è¯·æ±‚æµç¨‹"><a class="markdownIt-Anchor" href="#è¯·æ±‚æµç¨‹"></a> è¯·æ±‚æµç¨‹</h3><p><img src="Security%E9%AA%8C%E8%AF%81%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B5%81%E7%A8%8B.png" alt="SecurityéªŒè¯è¯·æ±‚çš„æµç¨‹" /></p><p>åœ¨ä¸Šé¢æè¿°äº†åŸºæœ¬æ¦‚å¿µå’Œé…ç½®å†…å®¹ä¹‹å, å¯ä»¥ç®€å•çš„æè¿°è¯·æ±‚çš„æµç¨‹</p><ol><li>æ¥æ”¶è¯·æ±‚, æ‰§è¡Œåˆ°<code>security</code>æ·»åŠ çš„<code>DelegatingFilterProxy</code>, é€šè¿‡è¿™ä¸ªæ¡¥æ¥å™¨æ¥å…¥è®¤è¯æµç¨‹</li><li><code>FilterChainProxy</code>æ ¹æ®è¯·æ±‚æŸ¥è¯¢å¹¶è°ƒç”¨<code>SecurityFilterChain</code>, æ‰§è¡Œè®¤è¯æµç¨‹</li><li>è®¤è¯æµç¨‹æ‰§è¡Œç»“æŸå, æ‰§è¡Œåç»­çš„æ“ä½œ</li><li>è¿”å›è¯·æ±‚çš„å¤„ç†ç»“æœ</li></ol><p>å…¶ä¸­æˆ‘ä»¬åœ¨è®¤è¯ä¸­æœ€å…³å¿ƒçš„å°±æ˜¯è®¤è¯æµç¨‹, å³ä½¿ç”¨çš„<code>SecurityFilterChain</code></p><h3 id="è®¤è¯æµç¨‹"><a class="markdownIt-Anchor" href="#è®¤è¯æµç¨‹"></a> è®¤è¯æµç¨‹</h3><p>æ­¤å¤„å°±ä»¥ç”¨æˆ·åå’Œå¯†ç çš„ç™»å½•æ–¹å¼ä¸ºä¾‹, æ¼”ç¤ºè®¤è¯æµç¨‹, æ­¤æ¬¡æ¼”ç¤ºä¼šåå‘äºå‰åç«¯åˆ†ç¦»çš„é…ç½®, ä¸ä¼šæœ‰é¡µé¢å†…å®¹</p><p>åœ¨å¼€å§‹ä¹‹å‰å…ˆå¼€å¯æ—¥å¿—, æ–¹ä¾¿æŸ¥çœ‹å’Œå®šä½</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org:</span></span><br><span class="line">      <span class="attr">springframework:</span></span><br><span class="line">        <span class="attr">security:</span> <span class="string">trace</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬ä¸åšé…ç½®, æŸ¥çœ‹ä¸€ä¸‹é»˜è®¤çš„<code>SecurityFilterChain</code></p><p><img src="Security%E7%9A%84%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E8%BF%87%E6%BB%A4%E5%99%A8.png" alt="Securityçš„è®¤è¯æµç¨‹è¿‡æ»¤å™¨" /></p><p>æˆ‘ä»¬è¿›è¡Œé…ç½®æ—¶, å¤šæ•°æ˜¯è¿›è¡Œæ­¥éª¤ä¸‰çš„é…ç½®å’Œæ­¥éª¤ä¸ƒçš„é…ç½®, å…¶ä»–çš„é…ç½®å†…å®¹æˆ–ç¦ç”¨,æˆ–ç”¨é»˜è®¤, æˆ–é…ç½®æ¯”è¾ƒç®€å•. æˆ‘ä»¬å…ˆå°†è¿™éƒ¨åˆ†ç®€å•é…ç½®ä¸€ä¸‹</p><ol><li><p>å…ˆç¦ç”¨<code>csrf</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.csrf(AbstractHttpConfigurer::disable);</span><br></pre></td></tr></table></figure></li><li><p>å¼‚å¸¸å¤„ç†è®¾ç½®ä¸ºè¿”å›<code>json</code>å†…å®¹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.exceptionHandling(config -&gt;</span><br><span class="line">                       config</span><br><span class="line">                       .authenticationEntryPoint(customerAuthenticationHandler())</span><br><span class="line">                      );</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerAuthenticationHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomerAuthenticationHandler</span><span class="params">(AuthenticationSaveHandler authenticationSaveHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationSaveHandler = authenticationSaveHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSaveHandler authenticationSaveHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        authenticationSaveHandler.remove(request.getHeader(<span class="string">&quot;TOKEN&quot;</span>));</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, authException);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><mark><code>AuthenticationSaveHandler</code>æ˜¯æˆ‘ä¸ªäººå°è£…çš„ä¸€ä¸ªéªŒè¯ä¿¡æ¯çš„ä¿å­˜å¤„ç†å™¨,  <code>TOKEN</code>æ˜¯æˆ‘ä¸ªäººåœ¨è¯·æ±‚å¤´ä¸­å®šä¹‰çš„å†…å®¹, ä½œä¸ºä¿å­˜å¤„ç†å™¨çš„<code>KEY</code>, è‡³äºå…·ä½“å®ç°å¯ä»¥ä¸ªäººè‡ªå®šä¹‰, <code>JWT</code>, <code>Redis</code>ä¿å­˜éƒ½å¯ä»¥, å¦‚æœæ¼”ç¤ºæƒ³è¦ç®€å•ç‚¹å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ª<code>Map</code>ä¿å­˜, é€šè¿‡<code>KEY</code>æ¥<code>get</code>å’Œ<code>put</code>å³å¯</mark></p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å½“é…ç½®å®Œè¿™äº›å, è®¿é—®æœåŠ¡èµ„æºæ—¶ä¼šå‘ç°å¯ä»¥ç›´æ¥è®¿é—®, è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ·»åŠ é‰´æƒçš„é…ç½®, è¿™æ ·ç”Ÿæˆçš„<code>SecurityFilterChain</code>æ˜¯æ²¡æœ‰é‰´æƒè¿‡æ»¤å™¨çš„, å¦‚æœæƒ³è¦éªŒè¯ä¸€ä¸‹<code>exceptionHandling</code>æ•ˆæœå¯ä»¥å…ˆæ·»åŠ ç®€å•çš„é‰´æƒé…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeHttpRequests(</span><br><span class="line">    (auth) -&gt; auth</span><br><span class="line">    .requestMatchers(<span class="string">&quot;test/unauth&quot;</span>, <span class="string">&quot;login&quot;</span>)</span><br><span class="line">    .permitAll()</span><br><span class="line">    .anyRequest()</span><br><span class="line">    .authenticated()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è®¿é—®é™¤äº†<code>/test/unauth</code>è·¯å¾„ä¹‹å¤–çš„èµ„æºæ—¶, å°±ä¼šå¼‚å¸¸, å¼‚å¸¸ä¿¡æ¯æ˜¯: <code>Full authentication is required to access this resource</code></p></li><li><p>æ³¨é”€è®¤è¯åçš„å¤„ç†å’ŒæˆåŠŸçš„å¤„ç†:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http.logout(</span><br><span class="line">    (config) -&gt; config</span><br><span class="line">    .addLogoutHandler(userLogoutHandler())</span><br><span class="line">    .logoutSuccessHandler(userLogoutSuccessHandler())</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLogoutHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserLogoutHandler</span><span class="params">(AuthenticationSaveHandler authenticationSaveHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationSaveHandler = authenticationSaveHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSaveHandler authenticationSaveHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">        authenticationSaveHandler.remove(request.getHeader(<span class="string">&quot;TOKEN&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="comment">/*public UserLogoutSuccessHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            response.getWriter().println(s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥å»è¯·æ±‚<code>logout</code>æ³¨é”€è®¤è¯, è¯·æ±‚æˆåŠŸæ—¶å°±ä¼šè¿”å›<code>UserLogoutSuccessHandler</code>ä¸­<code>onLogoutSuccess</code>è¿”å›çš„å†…å®¹</p><p><mark>é¡¹ç›®é»˜è®¤çš„æ³¨é”€ç™»å½•çš„åœ°å€æ˜¯<code>logout</code>, å¯ä»¥é€šè¿‡<code>logoutUrl</code>ä¿®æ”¹æ³¨é”€è¯·æ±‚çš„è·¯å¾„</mark></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http.logout(</span><br><span class="line">    (config) -&gt; config</span><br><span class="line">    .logoutUrl(<span class="string">&quot;/api/logout&quot;</span>)</span><br><span class="line">    .addLogoutHandler(userLogoutHandler())</span><br><span class="line">    .logoutSuccessHandler(userLogoutSuccessHandler())</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>è®¤è¯ä¹‹åçš„æ“ä½œå’Œæ¸¸å®¢æ¨¡å¼æš‚ä¸æ“ä½œ</p></li><li><p>é‰´æƒé…ç½®, é€šè¿‡<code>authorizeHttpRequests</code>é…ç½®èµ„æºçš„æƒé™ä¿¡æ¯</p><p>é€šè¿‡å‰é¢å›¾ç‰‡çš„è¿‡æ»¤å™¨ä»‹ç»åº”è¯¥æ¸…æ™°çš„äº†è§£åˆ°, é‰´æƒæ“ä½œå®é™…æ˜¯åœ¨è®¤è¯ç­‰è¿‡æ»¤å™¨æ‰§è¡Œå®Œä¹‹åæ“ä½œçš„, æ‰€ä»¥åœ¨æ­¤è¿‡æ»¤å™¨æ‰§è¡Œä¹‹å‰å°±è¢«æ‹¦æˆªå¤„ç†çš„è¯·æ±‚æ˜¯ä¸ä¼šèµ°åˆ°è¯¥è¿‡æ»¤å™¨çš„, æ¯”å¦‚ç™»å½•é…ç½®ä¸­é…ç½®çš„ç™»å½•è¯·æ±‚è·¯å¾„(é»˜è®¤<code>/login</code>)å’Œæ³¨é”€è¯·æ±‚è·¯å¾„(<code>logout</code>); éƒ¨åˆ†è¿‡æ»¤å™¨æ˜¯æœ‰æ‰§è¡Œé“¾ç»“æŸçš„åç½®å¤„ç†çš„, æ¯”å¦‚å¼‚å¸¸å¤„ç†å™¨æ˜¯éœ€è¦<code>catch</code>é‰´æƒå¼‚å¸¸(å³é‰´æƒè¿‡æ»¤å™¨ä¸­æŠ›å‡ºçš„å¼‚å¸¸)çš„, æ‰€ä»¥ä¼šå‡ºç°é‰´æƒè¿‡æ»¤å™¨æ‰§è¡Œå®ŒåæŠ›å‡ºäº†å¼‚å¸¸è¿”å›åˆ°å¼‚å¸¸è¿‡æ»¤å™¨ä¸­æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºåŒ¹é…å½“å‰çš„SecurityFilterChainé€‚ç”¨çš„è¯·æ±‚è·¯å¾„, ä¸é…ç½®é»˜è®¤ä¸ºanyRequest</span></span><br><span class="line">http.securityMatcher(<span class="string">&quot;/**&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„é…ç½®ä¸æ˜¯é‰´æƒé…ç½®, è€Œæ˜¯<code>SecurityFilterChain</code>å¤„ç†çš„è¯·æ±‚è·¯å¾„, ä¸ç¬¦åˆè¦æ±‚çš„ä¸ä¼šåŒ¹é…åˆ°è¯¥<code>SecurityFilterChain</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯·æ±‚é‰´æƒé…ç½®</span></span><br><span class="line">http.authorizeHttpRequests(</span><br><span class="line">    (auth) -&gt; auth</span><br><span class="line">    .requestMatchers(<span class="string">&quot;test/unauth&quot;</span>) <span class="comment">// ç”¨äºåŒ¹é…è·¯å¾„</span></span><br><span class="line">    .permitAll()</span><br><span class="line">    .requestMatchers(<span class="string">&quot;/test/auth&quot;</span>)</span><br><span class="line">    .hasRole(<span class="string">&quot;USER_TEST&quot;</span>)   <span class="comment">// å…·æœ‰æŸç§è§’è‰²</span></span><br><span class="line">    .requestMatchers(<span class="string">&quot;/test/auth&quot;</span>)</span><br><span class="line">    .hasAuthority(<span class="string">&quot;AUTH&quot;</span>)   <span class="comment">// å…·æœ‰æŸç§æƒé™</span></span><br><span class="line">    .requestMatchers(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">    .access((authentication, object) -&gt; <span class="keyword">new</span> <span class="title class_">AuthorizationDecision</span>(<span class="literal">true</span>))    <span class="comment">// è‡ªå®šä¹‰ç¬¦åˆæŸç§è¦æ±‚</span></span><br><span class="line">    .anyRequest()   <span class="comment">// ç”¨äºåŒ¹é…ä»»ä½•è·¯å¾„</span></span><br><span class="line">    .authenticated()    <span class="comment">// è¡¨ç¤ºéœ€è¦è®¤è¯</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°é‰´æƒé…ç½®åªæ˜¯æ¼”ç¤ºäº†å‡ ä¸ªé…ç½®çš„ä¾‹å­, <code>requestMatchers</code>è¡¨ç¤ºåŒ¹é…è·¯å¾„, é‰´æƒå¤„ç†æ•´ä½“åˆ†ä¸º5ä¸ªç±»åˆ«: <code>permitAll</code>(æ”¾è¡Œ), <code>hasRole</code>(å…·æœ‰æŸç§è§’è‰²), <code>hasAuthority</code>(å…·æœ‰æŸç§æƒé™), <code>access</code>(è‡ªå®šä¹‰çš„è®¿é—®è¦æ±‚), <code>authenticated</code>(éœ€è®¤è¯)</p><p>é‰´æƒé…ç½®çš„æ¯ä¸€ä¸ªéƒ½ä¼šåœ¨é‰´æƒé…ç½®ç±»<code>AuthorizeHttpRequestsConfigurer</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>AuthorizationManager</code>(æ³¨æ„åˆ«è·Ÿ<code>AuthenticationManager</code>æ··äº†), åœ¨<code>AuthorizationFilter</code>ä¸­å®ç°å…¶ä½œç”¨</p></li><li><p>è®¤è¯é…ç½®</p><p>è¿™æ˜¯ç™»å½•æ“ä½œæœ€é‡è¦çš„é…ç½®äº†, æˆ‘ä»¬ä»¥ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯æ–¹å¼ä¸ºä¾‹è¿›è¡Œæ¼”ç¤º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin((config) -&gt;</span><br><span class="line">               config</span><br><span class="line">               .usernameParameter(<span class="string">&quot;username&quot;</span>)<span class="comment">// ç”¨æˆ·åå‚æ•°key</span></span><br><span class="line">               .passwordParameter(<span class="string">&quot;password&quot;</span>)<span class="comment">// å¯†ç å‚æ•°key</span></span><br><span class="line">               .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)<span class="comment">// ç™»å½•å¤„ç†çš„åŒ¹é…è·¯å¾„</span></span><br><span class="line">               .failureHandler(loginFailureHandler())<span class="comment">// ç™»å½•å¤±è´¥å¤„ç†å™¨</span></span><br><span class="line">               .successHandler(loginSuccessHandler())<span class="comment">// ç™»å½•æˆåŠŸå¤„ç†</span></span><br><span class="line">              );</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°é…ç½®æ˜¯å¸¸åšçš„é…ç½®, å½“å®¢æˆ·ç«¯å‘é€<code>/login</code>è¯·æ±‚æ—¶ä¼šè¢«è¯¥è¿‡æ»¤å™¨æ‹¦æˆªå¤„ç†, ä»è¯·æ±‚ä¸­è·å–<code>key</code>ä¸º<code>username</code>å’Œ<code>password</code>çš„å‚æ•°è·å–å…¶å€¼è¿›è¡Œè®¤è¯;  <code>failureHandler</code>é…ç½®ä¸€ä¸ªè®¤è¯å¤±è´¥çš„å¤„ç†å™¨; <code>successHandler</code>é…ç½®ä¸€ä¸ªè®¤è¯æˆåŠŸçš„å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public LoginFailureHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•å¤±è´¥: &quot;</span>+exception.getMessage());</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public LoginSuccessHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">/*String token = StringUtils.isBlank(request.getHeader(&quot;TOKEN&quot;)) ? UUID.randomUUID().toString() : request.getHeader(&quot;TOKEN&quot;);</span></span><br><span class="line"><span class="comment">        authenticationSaveHandler.add(token, authentication);*/</span></span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        data.put(<span class="string">&quot;userInfo&quot;</span>, authentication);</span><br><span class="line">        result.put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å½“é…ç½®åˆ°æ­¤å¤„æ—¶, ä¼šå‘ç°ç™»å½•åŠŸèƒ½éƒ½å·²ç»æˆåŠŸäº†, ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³, è¯·æ±‚çš„è®¤è¯å­˜å‚¨é—®é¢˜</p><p>å½“æˆ‘è¯´å‡ºè¿™ä¸ªé—®é¢˜æ—¶å¯èƒ½ä¼šæœ‰ç–‘é—®: è®¤è¯ä¿¡æ¯åœ¨ç™»å½•æˆåŠŸåå·²ç»ä¿å­˜, <code>token</code>ä¹Ÿå·²ç»è¿”å›, åªéœ€è¦åœ¨è¯·æ±‚æ—¶æ·»åŠ <code>token</code>åˆ°è¯·æ±‚å¤´é‡Œä¸å°±å¯ä»¥æˆåŠŸäº†. ç­”æ¡ˆæ˜¯å¦</p><p>å…ˆè®¤è¯†ä¸¤ä¸ªæ¦‚å¿µ: 1. è¯·æ±‚æ˜¯æ— çŠ¶æ€çš„, è¯·æ±‚ä¸è¯·æ±‚ä¹‹é—´æ˜¯ä¸å­˜åœ¨å…³è”çš„; 2. åœ¨è®¤è¯æ¡†æ¶ä¸­, è¯·æ±‚æ˜¯åˆ†ä¸ºä¸¤ç±»çš„: è®¤è¯ç±»(ç™»å½•å’Œæ³¨é”€); æ™®é€šç±»(èµ„æºè¯·æ±‚)</p><p>å½“æˆ‘ä»¬åœ¨ä¸Šè¿°é…ç½®çš„åŸºç¡€ä¸Šç™»å½•è¯·æ±‚ç™»å½•æˆåŠŸäº†, ä¼šå°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°è‡ªå®šä¹‰çš„å­˜å‚¨ä¸­å¹¶è¿”å›<code>token</code>, ä½†æ˜¯å½“èµ„æºè¯·æ±‚è¿›æ¥æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰è·å–å¯¹åº”çš„è®¤è¯ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­æ¥è¡¨ç¤ºå·²ç»é€šè¿‡éªŒè¯</p><p>å½“ç™»å½•åå¦‚æœè®¿é—®èµ„æºè¯·æ±‚æ—¶æˆåŠŸè¿™ä¸æ˜¯æˆ‘ä»¬çš„é€»è¾‘çš„æˆåŠŸ, è€Œæ˜¯æ¡†æ¶çš„ä¸€äº›é»˜è®¤é…ç½®å¸¦æ¥çš„æ•ˆæœ, é»˜è®¤é…ç½®ä¸­ä¼šå°†<code>sessionId</code>è¿”å›å¹¶å†™åˆ°<code>Cookie</code>ä¸­, æ‰€ä»¥è®¿é—®èµ„æºæ—¶å¯èƒ½å¸¦æœ‰äº†å·²é€šè¿‡è®¤è¯çš„<code>sessionId</code>å¯¼è‡´çš„</p><p>è§£å†³æ–¹æ¡ˆ:</p><ul><li><p>ç¬¬ä¸€ç§æ˜¯ç½‘ä¸Šå¤§å¤šçš„è§£å†³æ–¹æ¡ˆ: åœ¨èµ°åˆ°è®¤è¯æµç¨‹è¿‡æ»¤å™¨å‰æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨, åœ¨è¿™ä¸ªè¿‡æ»¤å™¨ä¸­æ·»åŠ éªŒè¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡ä¸­, è¿˜æœ‰çš„æœ‰ä¼šå†è·å–<code>AuthenticationManager</code>ç„¶åå†æ‰‹åŠ¨è°ƒç”¨è®¤è¯æ–¹æ³•</p></li><li><p>ç¬¬äºŒç§æ˜¯ä¿®æ”¹<code>session</code>çš„ä¿å­˜ç­–ç•¥: æˆ‘ä¸ªäººæ¯”è¾ƒæ‡’, æ‰€ä»¥æƒ³ç›´æ¥æ›¿æ¢<code>spring</code>ä¸­éªŒè¯ä¿¡æ¯çš„è·å–å’Œä¿å­˜æ–¹å¼. <code>spring</code>ä¸­æ— è®ºæ˜¯<code>mvc</code>è¿˜æ˜¯<code>security</code>éƒ½æ˜¯å°†è¯·æ±‚åŸºäº<code>ThreadLocal</code>çš„, æ‰€ä»¥æ­¤å¤„çš„<code>session</code>ç­–ç•¥ä¸è¦ä¿®æ”¹, ä¾ç„¶ä½¿ç”¨<code>ThreadLocalSecurityContextHolderStrategy</code>, æˆ‘ä»¬è¦ä¿®æ”¹çš„æ˜¯å…¶å­˜å‚¨åº“<code>SecurityContextRepository</code></p><p><code>SecurityContextHolderFilter</code>: è·å–éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨</p><p><code>AuthorizationFilter</code>: è·å–å¹¶ä½¿ç”¨éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨</p><p><code>AbstractAuthenticationProcessingFilter</code>: ä¿å­˜éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨(ä»…ä»…æ˜¯ç”¨æˆ·åå¯†ç æ¨¡å¼ä¸‹çš„ä¿å­˜è¿‡æ»¤å™¨)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationSaveHandler</span> <span class="keyword">extends</span> <span class="title class_">SecurityContextRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object account, SecurityContext authentication)</span>;</span><br><span class="line"></span><br><span class="line">    SecurityContext <span class="title function_">get</span><span class="params">(Object account)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object account)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryAuthenticationSaveHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSaveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Object, SecurityContext&gt; USER = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object account, SecurityContext authentication)</span> &#123;</span><br><span class="line">        USER.put(account, authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SecurityContext <span class="title function_">get</span><span class="params">(Object account)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> USER.get(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object account)</span> &#123;</span><br><span class="line">        USER.remove(account);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SecurityContext <span class="title function_">loadContext</span><span class="params">(HttpRequestResponseHolder requestResponseHolder)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestResponseHolder.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> get(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveContext</span><span class="params">(SecurityContext context, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        response.addHeader(<span class="string">&quot;TOKEN&quot;</span>, token);</span><br><span class="line"><span class="comment">//        Authentication authentication = context.getAuthentication();</span></span><br><span class="line">        add(token, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsContext</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> USER.containsKey(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.setSharedObject(SecurityContextRepository.class, authenticationSaveHandler());</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="è‡ªå®šä¹‰ç™»å½•"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰ç™»å½•"></a> è‡ªå®šä¹‰ç™»å½•</h3><p>é€šè¿‡å‰é¢çš„é…ç½®, æˆ‘ä»¬å¯ä»¥å®ç°é…ç½®å®˜æ–¹çš„ç™»å½•å¤„ç†, æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›ä½¿ç”¨å®˜æ–¹çš„ç™»å½•æµç¨‹, è€Œæ˜¯å¸Œæœ›è‡ªå®šä¹‰ç™»å½•æµç¨‹å’Œé€»è¾‘, æ­¤å¤„æœ‰ä¸¤ç§æ–¹å¼:</p><ol><li><p>è¯·æ±‚å¤„ç†å™¨çš„æ–¹å¼</p><p>è¿™ç§æ–¹å¼å°±æ˜¯å‰é¢æåˆ°çš„, å°†ç™»å½•è¯·æ±‚æ”¾è¡Œ, ç„¶ååœ¨<code>controller</code>ä¸­å®ç°è‡ªå®šä¹‰çš„ç™»å½•é€»è¾‘, å¹¶è¿›è¡Œç›¸å…³å¤„ç†</p></li><li><p>ç™»å½•è¿‡æ»¤å™¨æ–¹å¼</p><p>è¿™ç§æ–¹å¼ä¸ä¸Šè¿°æ–¹å¼ç±»ä¼¼, åªæ˜¯é€»è¾‘å¤„ç†é€šè¿‡è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å®ç°</p><p>é¦–å…ˆæ ¹æ®è‡ªå·±çš„éœ€æ±‚, å°†å®˜æ–¹å®ç°çš„ç™»å½•è¿‡æ»¤å™¨é…ç½®å¥½, ç„¶ååˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨, å¹¶æ·»åŠ åˆ°<code>SecurityFilterChain</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(<span class="keyword">new</span> <span class="title class_">MyLoginFilter</span>(passwordEncoder, userDetailsService, authenticationSaveHandler), RequestCacheAwareFilter.class);</span><br></pre></td></tr></table></figure><p>ç„¶åè‡ªå®šä¹‰å®ç°ä¸€ä¸ªè¿‡æ»¤å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RequestMatcher</span> <span class="variable">requiresAuthenticationRequestMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/login&quot;</span>,</span><br><span class="line">            <span class="string">&quot;POST&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SecurityContextRepository securityContextRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyLoginFilter</span><span class="params">(PasswordEncoder passwordEncoder, UserDetailsService userDetailsService, SecurityContextRepository securityContextRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.securityContextRepository = securityContextRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (passwordEncoder.matches(password, user.getPassword())) &#123;</span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> UsernamePasswordAuthenticationToken.authenticated(user, user, Collections.emptyList());</span><br><span class="line">            <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">            context.setAuthentication(authentication);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                securityContextRepository.saveContext(context, request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">requiresAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.requiresAuthenticationRequestMatcher.matches(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨<code>OncePerRequestFilter</code>è¿™ä¸ªè¿‡æ»¤å™¨ç±»çš„åŸºç¡€ä¸Šè¿›è¡Œæ„å»º, æ­¤å¤„åªæ˜¯ç®€å•çš„åšäº†ä¸€ä¸ªç®€å•çš„é€»è¾‘å¤„ç†å’Œä¸Šä¸‹æ–‡ä¿å­˜æ ·ä¾‹, å…·ä½“å®ç°å¯æ ¹æ®ä¸ªäººéœ€è¦è¿›è¡Œå…·ä½“ä¿®æ”¹</p></li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p>é—®é¢˜ä¸€</p><p>å‡ºç°é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Not injecting HSTS header since it did not match request to [Is Secure]</span><br></pre></td></tr></table></figure><p>é—®é¢˜æè¿°: è¿™ä¸ªé—®é¢˜åœ¨è‡ªå®šä¹‰ç™»å½•å, åœ¨è¯·æ±‚ç™»å½•æ—¶å¯èƒ½ä¼šå‡ºç°, å…·ä½“å†…å®¹ä¸Šä¸ä¼šæŠ¥é”™, ä½†æ˜¯åœ¨æ‰“å¼€æ—¥å¿—æ‰“å°æ—¶ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰çš„ç™»å½•è¿‡æ»¤å™¨å‡ºç°äº†è¯¥æè¿°</p><p>è§£å†³æ–¹æ¡ˆ: é…ç½®è¯·æ±‚å¤´<code>https</code>é…ç½®, å…·ä½“å¯å‚è€ƒ: <a href="https://blog.csdn.net/w_monster/article/details/119936215">https://blog.csdn.net/w_monster/article/details/119936215</a></p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>SpringSecurity</code>æºç </p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueç³»åˆ—(å››)---è¯·æ±‚</title>
      <link href="/2024/02/01/web/Vue%E7%B3%BB%E5%88%97%E5%9B%9B%E4%B9%8B%E8%AF%B7%E6%B1%82/"/>
      <url>/2024/02/01/web/Vue%E7%B3%BB%E5%88%97%E5%9B%9B%E4%B9%8B%E8%AF%B7%E6%B1%82/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>ä¸ºäº†å®ç°å‰åç«¯äº¤äº’, éœ€è¦å¼•å…¥è¯·æ±‚æ¡†æ¶. å½“å‰å½¢åŠ¿ä¸‹, <code>Vue</code>é¡¹ç›®é€šå¸¸ä½¿ç”¨<code>axios</code>ä½œä¸ºé¡¹ç›®çš„è¯·æ±‚æ¡†æ¶</p><h3 id="å¼•å…¥"><a class="markdownIt-Anchor" href="#å¼•å…¥"></a> å¼•å…¥</h3><h4 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h4><p>ä½¿ç”¨<code>pnmp</code>å‘½ä»¤å®‰è£…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add axios</span><br></pre></td></tr></table></figure><h4 id="å¼•å…¥-2"><a class="markdownIt-Anchor" href="#å¼•å…¥-2"></a> å¼•å…¥</h4><p><code>axios</code>çš„å¼•å…¥ä¸éœ€è¦åƒå…¶å®ƒæ¡†æ¶é‚£æ ·, ä½¿ç”¨<code>app.use</code>å¼•å…¥, åªéœ€è¦åˆ›å»ºåœ¨ä½¿ç”¨çš„ä½ç½®åˆ›å»ºè¯·æ±‚å®ä¾‹å³å¯</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">create</span>(config);</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h3><h4 id="åŸºæœ¬ä½¿ç”¨"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä½¿ç”¨"></a> åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">create</span>(config).<span class="title function_">request</span>(config);</span><br><span class="line">axios.<span class="title function_">create</span>(config).<span class="title function_">get</span>(url);</span><br><span class="line">axios.<span class="title function_">create</span>(config).<span class="title function_">post</span>(url, data);</span><br></pre></td></tr></table></figure><h4 id="å°è£…ä½¿ç”¨"><a class="markdownIt-Anchor" href="#å°è£…ä½¿ç”¨"></a> å°è£…ä½¿ç”¨</h4><p>åŸºæœ¬ä½¿ç”¨æ–¹å¼æ¯æ¬¡è¯·æ±‚æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª<code>axios</code>å®ä¾‹, å¹¶ä¸”æ¯æ¬¡éƒ½è¦æ·»åŠ åˆ›å»ºé…ç½®, å¯ä»¥åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œå°è£…, åˆ›å»ºå’Œä½¿ç”¨ä¸€ä¸ª<code>axios</code>å®ä¾‹å³å¯, å¹¶ä¸”å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„è¯·æ±‚æ‹¦æˆªå’Œå“åº”æ‹¦æˆª</p><p>ä¸€. è¯·æ±‚æ‹¦æˆª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">create</span>(config).<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function">(<span class="params"><span class="attr">req</span>: <span class="title class_">InternalAxiosRequestConfig</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;è¯·æ±‚æ‹¦æˆª&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> req;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¯·æ±‚æ‹¦æˆªå°±æ˜¯è¯·æ±‚åœ¨å‘é€ä¹‹å‰çš„å‰ç½®å¤„ç†</p><p>äºŒ. å“åº”æ‹¦æˆª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">create</span>(config).<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="title function_">async</span> (<span class="attr">res</span>: <span class="title class_">AxiosResponse</span>) =&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;å“åº”æ‹¦æˆª&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">status</span> === <span class="title class_">HttpStatusCode</span>.<span class="property">Ok</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="property">data</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;è¯·æ±‚å¼‚å¸¸&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å“åº”æ‹¦æˆªæ˜¯å¯¹è¯·æ±‚çš„ç»“æœè¿›è¡Œæ‹¦æˆªé¢„å¤„ç†, è¯·æ±‚çš„ç»“æœæ˜¯<code>AxiosResponse</code>ç±»å‹, å…¶ä¸­æœ‰<code>status</code>, <code>headers</code>, <code>config</code>, <code>data</code>ç­‰, æœåŠ¡ç«¯è¿”å›çš„æ•°æ®å®é™…æ˜¯<code>data</code>ä¸­çš„å†…å®¹</p><p>ä¸‰. è¯·æ±‚å®ä¾‹å°è£…</p><ol><li><p>å°è£…æ‹¦æˆªå™¨é…ç½®</p><p>å°è£…æ‹¦æˆªå™¨é…ç½®æ˜¯å°†è¯·æ±‚æ‹¦æˆªå’Œå“åº”æ‹¦æˆªæŒ‰ç»„å°è£…, æ–¹ä¾¿æŒ‰ç»„æ·»åŠ </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‹¦æˆªå™¨é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RequestInterceptorsConfig</span> &#123;</span><br><span class="line">    <span class="comment">// è¯·æ±‚æ‹¦æˆª</span></span><br><span class="line">    <span class="attr">requestInterceptor</span>?: <span class="function">(<span class="params"><span class="attr">req</span>: <span class="title class_">InternalAxiosRequestConfig</span></span>) =&gt;</span> <span class="title class_">InternalAxiosRequestConfig</span>;</span><br><span class="line">    <span class="attr">requestInterceptorCatch</span>?: <span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="comment">// å“åº”æ‹¦æˆª</span></span><br><span class="line">    <span class="attr">responseInterceptor</span>?: &lt;R = <span class="title class_">AxiosResponse</span>&gt;<span class="function">(<span class="params"><span class="attr">config</span>: R</span>) =&gt;</span> R;</span><br><span class="line">    <span class="attr">responseInterceptorCatch</span>?: <span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å°è£…è¯·æ±‚å®ä¾‹</p><p>å°è£…è¯·æ±‚ç±», å¹¶åˆ›å»ºä¸€ä¸ªå…¬ç”¨çš„è¯·æ±‚å®ä¾‹ç”¨äºé¡¹ç›®ä½¿ç”¨. æä¾›è¯·æ±‚æ„é€ , æ”¯æŒè¯·æ±‚çš„å®šåˆ¶é…ç½®</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚å®ä½“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Request</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>;</span><br><span class="line">    <span class="attr">instance</span>: <span class="title class_">AxiosInstance</span>;</span><br><span class="line">    <span class="attr">interceptors</span>?: <span class="title class_">RequestInterceptorsConfig</span>[]</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>, <span class="attr">interceptors</span>?: <span class="title class_">RequestInterceptorsConfig</span>[]</span>) &#123;</span><br><span class="line">        config.<span class="property">baseURL</span> = <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">VITE_BASE_URL</span>;</span><br><span class="line">        config.<span class="property">headers</span> = config.<span class="property">headers</span> || <span class="keyword">new</span> <span class="title class_">AxiosHeaders</span>();</span><br><span class="line">        config.<span class="property">withCredentials</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">config</span> = config;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">instance</span> = axios.<span class="title function_">create</span>(config);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interceptors</span> = interceptors;</span><br><span class="line">        <span class="comment">// å…¨å±€è¯·æ±‚æ‹¦æˆª</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initGlobalRequestInterceptors</span>();</span><br><span class="line">        <span class="keyword">if</span> (interceptors) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> interceptor <span class="keyword">of</span> interceptors) &#123;</span><br><span class="line">                <span class="comment">// å®ä¾‹è¯·æ±‚æ‹¦æˆª</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">instance</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">                    interceptor.<span class="property">requestInterceptor</span>,</span><br><span class="line">                    interceptor.<span class="property">requestInterceptorCatch</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> reverseInterceptors = interceptors.<span class="title function_">reverse</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> interceptor <span class="keyword">of</span> reverseInterceptors) &#123;</span><br><span class="line">                <span class="comment">// å®ä¾‹å“åº”æ‹¦æˆª</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">instance</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">                    interceptor.<span class="property">responseInterceptor</span>,</span><br><span class="line">                    interceptor.<span class="property">responseInterceptorCatch</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…¨å±€å“åº”æ‹¦æˆª</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">initGlobalResponseInterceptors</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¯·æ±‚çš„å…¨å±€è¯·æ±‚æ‹¦æˆª</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">initGlobalRequestInterceptors</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">instance</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">            <span class="function">(<span class="params"><span class="attr">req</span>: <span class="title class_">InternalAxiosRequestConfig</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> userStore = <span class="title function_">useUserStore</span>();</span><br><span class="line">                req.<span class="property">headers</span>.<span class="title function_">set</span>(<span class="string">&quot;TOKEN&quot;</span>, userStore.<span class="property">getToken</span>, <span class="literal">true</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;è¯·æ±‚å…¨å±€è¯·æ±‚æ‹¦æˆª&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> req;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¯·æ±‚çš„å…¨å±€å“åº”æ‹¦æˆª</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">initGlobalResponseInterceptors</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">instance</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">            <span class="title function_">async</span> (<span class="attr">res</span>: <span class="title class_">AxiosResponse</span>) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (res.<span class="property">status</span> === <span class="title class_">HttpStatusCode</span>.<span class="property">Unauthorized</span> || res.<span class="property">data</span>.<span class="property">state</span> === <span class="title class_">ApiStateEnum</span>.<span class="property">NOT_LOGIN</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> current = <span class="title function_">currentRoute</span>();</span><br><span class="line">                    <span class="keyword">await</span> <span class="title function_">toLogin</span>(current)</span><br><span class="line">                    <span class="keyword">return</span> res.<span class="property">data</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.<span class="property">status</span> &gt;= <span class="title class_">HttpStatusCode</span>.<span class="property">BadRequest</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="string">&quot;è¯·æ±‚å¼‚å¸¸&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="property">data</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚åˆ›å»ºæ—¶è·å–ä¸€ä¸ªè¯·æ±‚é…ç½®é¡¹å’Œä¸€ä¸ªæ‹¦æˆªé…ç½®æ•°ç»„</p><p>è¯·æ±‚é…ç½®ä¸­è®¾ç½®åŸºç¡€è·¯å¾„</p><p>åˆ›å»ºæ—¶æœ€å…ˆåˆå§‹åŒ–å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨, æœ€ååˆå§‹åŒ–å…¨å±€å“åº”æ‹¦æˆªå™¨</p><p>æ‹¦æˆªé…ç½®æ•°æ®ä¸­çš„è¯·æ±‚æ‹¦æˆªé¡ºåºæ·»åŠ , å“åº”æ‹¦æˆªå€’åºæ·»åŠ </p></li><li><p>å°è£…è¯·æ±‚æ“ä½œ</p><p>åœ¨å°è£…çš„è¯·æ±‚å®ä¾‹ä¸­æ·»åŠ è¯·æ±‚æ“ä½œ, ç›´æ¥ä½¿ç”¨è¯·æ±‚å®ä¾‹ä¸­çš„<code>AxiosInstance</code>å®ä¾‹æ“ä½œ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ‰é…ç½®è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">config</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">interceptors</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">request</span>(<span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>, <span class="attr">interceptors</span>?: <span class="title class_">RequestInterceptorsConfig</span>[]): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">instance</span>: <span class="title class_">AxiosInstance</span> = interceptors &amp;&amp; interceptors.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="keyword">new</span> <span class="title class_">Request</span>(config, interceptors).<span class="property">instance</span> : <span class="variable language_">this</span>.<span class="property">instance</span>;</span><br><span class="line">    <span class="comment">// let instance: AxiosInstance = this.instance;</span></span><br><span class="line">    <span class="keyword">return</span> instance</span><br><span class="line">        .<span class="property">request</span>&lt;<span class="built_in">any</span>, <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt;(config)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">            &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * get è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params    è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">get</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">params</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">method</span> = <span class="string">&quot;GET&quot;</span>;</span><br><span class="line">    config.<span class="property">url</span> = url;</span><br><span class="line">    config.<span class="property">params</span> = params;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delete è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params    è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">delete</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">params</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">method</span> = <span class="string">&quot;DELETE&quot;</span>;</span><br><span class="line">    config.<span class="property">url</span> = url;</span><br><span class="line">    config.<span class="property">params</span> = params;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * download è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * è¯·æ±‚ç±»å‹ä¸ºget</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params    è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name      æ–‡ä»¶å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">download</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">params</span>?: &#123;[<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="built_in">string</span>&#125;): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (params) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">pre</span>: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">let</span> [uri, param]: <span class="built_in">string</span>[] = url.<span class="title function_">split</span>(<span class="string">&quot;?&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> params) &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">item</span>: <span class="built_in">string</span> = key + <span class="string">&quot;=&quot;</span> + params[key];</span><br><span class="line">            pre += item + <span class="string">&#x27;&amp;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pre += param;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">open</span>(uri + <span class="string">&#x27;?&#x27;</span> + pre, name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">open</span>(url, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * post è¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data      è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">post</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">method</span> = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">    config.<span class="property">url</span> = url;</span><br><span class="line">    config.<span class="property">data</span> = data;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * formè¡¨å•æ ¼å¼çš„postè¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data      è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">postForm</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">headers</span> = config.<span class="property">headers</span> || <span class="keyword">new</span> <span class="title class_">AxiosHeaders</span>();</span><br><span class="line">    config.<span class="property">headers</span>[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">post</span>(url, data, config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jsonæ ¼å¼çš„postè¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data      è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">postJson</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">headers</span> = config.<span class="property">headers</span> || <span class="keyword">new</span> <span class="title class_">AxiosHeaders</span>();</span><br><span class="line">    config.<span class="property">headers</span>[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&quot;application/json;charset=UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">post</span>(url, data, config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–‡ä»¶æ ¼å¼çš„postè¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data      è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">postFile</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt;  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">headers</span> = config.<span class="property">headers</span> || <span class="keyword">new</span> <span class="title class_">AxiosHeaders</span>();</span><br><span class="line">    config.<span class="property">headers</span>[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&quot;multipart/form-data;charset=UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">post</span>(url, data, config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–‡ä»¶æ ¼å¼çš„postè¯·æ±‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url       è¯·æ±‚è·¯å¾„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data      è¯·æ±‚å‚æ•°æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config    è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">put</span>(<span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">data</span>?: <span class="built_in">any</span>, <span class="attr">config</span>?: <span class="title class_">AxiosRequestConfig</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span> | <span class="title class_">ApiResult</span>&lt;<span class="built_in">any</span>&gt;&gt;  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        config = <span class="title function_">defaultRequestConfig</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    config.<span class="property">method</span> = <span class="string">&quot;put&quot;</span>;</span><br><span class="line">    config.<span class="property">url</span> = url;</span><br><span class="line">    config.<span class="property">data</span> = data;</span><br><span class="line">    config.<span class="property">headers</span> = config.<span class="property">headers</span> || <span class="keyword">new</span> <span class="title class_">AxiosHeaders</span>();</span><br><span class="line">    config.<span class="property">headers</span>[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&quot;multipart/form-data;charset=UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è£…æ“ä½œä¸­æœ€ç»ˆè¦çš„å°è£…å°±æ˜¯<code>request</code>çš„å°è£…, å½“æŸä¸ªè¯·æ±‚éœ€è¦é¢å¤–çš„è¯·æ±‚æ‹¦æˆªæ—¶, å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹å®Œæˆ, ä¿æŒåŸè¯·æ±‚å®ä¾‹ä¸å˜</p><p>è¿”å›ç»“æœä¸­çš„<code>ApiResult</code>æ˜¯ä¸ªäººå°è£…çš„è¯·æ±‚ç»“æœ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ApiResult</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="attr">state</span>: <span class="title class_">ApiStateEnum</span> | <span class="built_in">number</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">data</span>: T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é»˜è®¤çš„è¯·æ±‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤è¯·æ±‚é…ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defaultRequestConfig</span>(<span class="params"></span>): <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ä¾‹åŒ–ä¸€ä¸ªè¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">request</span>: <span class="title class_">Request</span> = <span class="keyword">new</span> <span class="title class_">Request</span>(</span><br><span class="line">    <span class="title function_">defaultRequestConfig</span>()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›ä¸€ä¸ªå®ä¾‹åŒ–è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> request;</span><br></pre></td></tr></table></figure></li></ol><p>åˆ°ç›®å‰, é¡¹ç›®çš„å‰ç«¯ä½¿ç”¨ç»„ä»¶æ·»åŠ çš„å·®ä¸å¤šäº†, åœ¨æ•´ç†äº†é¡¹ç›®çš„æ¶å­å’Œå¸ƒå±€ä¹‹å, å‰ç«¯æš‚åœä¸€æ®µ, å¼€å§‹åšæœåŠ¡ç«¯çš„ç™»å½•è®¤è¯ç­‰å†…å®¹</p><p><a href="pure-project-web.7z">å‰ç«¯é¡¹ç›®</a></p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> axios </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueç³»åˆ—(ä¸‰)---çŠ¶æ€ç®¡ç†åº“</title>
      <link href="/2024/01/18/web/Vue%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E5%BA%93/"/>
      <url>/2024/01/18/web/Vue%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>Vue</code>é¡¹ç›®ä¸­çš„çŠ¶æ€ç®¡ç†åº“æ˜¯å¦ä¸€ç§å½¢å¼çš„ä¼šè¯å­˜å‚¨, å¸¸ç”¨äº†æœ‰<code>vuex</code>, <code>pinia</code>, ç›®å‰å®˜ç½‘æ¨èä½¿ç”¨<code>pinia</code>, æ‰€ä»¥â€¦</p><h3 id="å¼•å…¥"><a class="markdownIt-Anchor" href="#å¼•å…¥"></a> å¼•å…¥</h3><h4 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h4><p>ä½¿ç”¨<code>pnpm</code>å‘½ä»¤å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add pinia;</span><br></pre></td></tr></table></figure><h4 id="å¼•å…¥-2"><a class="markdownIt-Anchor" href="#å¼•å…¥-2"></a> å¼•å…¥</h4><p>åœ¨<code>main.ts</code>ä¸­ä½¿ç”¨<code>pinia</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªçŠ¶æ€ç®¡ç†åº“, å¹¶ä½¿ç”¨<code>use</code>å‡½æ•°å¼•å…¥</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@/assets/css/global.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&quot;@/router/router.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createPinia&#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line">app.<span class="title function_">use</span>(router);</span><br><span class="line">app.<span class="title function_">use</span>(pinia);</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h3><p>æ­¤å¤„ä½¿ç”¨ç±»ç»„åˆå¼<code>API</code>çš„æ–¹å¼ä½¿ç”¨</p><p>é¦–å…ˆåœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª<code>store</code>ç›®å½•ç”¨äºå­˜æ”¾çŠ¶æ€, åˆ›å»ºä¸€ä¸ª<code>user.ts</code>ä½œä¸ºç”¨æˆ·çš„çŠ¶æ€ç®¡ç†åº“, å¹¶ä»¥æ­¤ä¸ºä¾‹</p><h4 id="å®šä¹‰çŠ¶æ€åº“"><a class="markdownIt-Anchor" href="#å®šä¹‰çŠ¶æ€åº“"></a> å®šä¹‰çŠ¶æ€åº“</h4><p>æ‰€è°“å®šä¹‰çŠ¶æ€å°±æ˜¯å®šä¹‰ä¸€ä¸ªå…¨å±€çš„å†…å®¹, ç»„åˆå¼<code>API</code>çš„æ–¹å¼éœ€è¦ä½¿ç”¨<code>defineStore</code>å‡½æ•°, æœ‰ä¸¤ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªæ˜¯åç§°, å¿…é¡»ä¿è¯åœ¨<code>store</code>ä¸­å…¨å±€å”¯ä¸€, ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª<code>setup</code>å‡½æ•°, å†<code>setup</code>å‡½æ•°ä¸­å®šä¹‰å†…å®¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±å®šä¹‰å¥½äº†åä¸º<code>user</code>çš„çŠ¶æ€, ä½†æ˜¯åœ¨è¿™ä¸ªçŠ¶æ€ä¸­å¹¶æ²¡æœ‰å®šä¹‰å…¶ä»–å†…å®¹</p><blockquote><p>åœ¨<code>setup store</code>ä¸­</p><ul><li><code>ref</code>å°±æ˜¯<code>state</code>å±æ€§</li><li><code>computed()</code>å°±æ˜¯<code>getters</code></li><li><code>function()</code>å°±æ˜¯<code>actions</code></li></ul></blockquote><h4 id="å®šä¹‰state"><a class="markdownIt-Anchor" href="#å®šä¹‰state"></a> å®šä¹‰<code>state</code></h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> info = ref&lt;<span class="title class_">UserInfo</span> | <span class="literal">null</span>&gt;(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xiaolin&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;info&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">UserInfo</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">account</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">sex</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">permissions</span>: <span class="built_in">string</span>[];</span><br><span class="line">    <span class="attr">roles</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;user name: &quot;</span>, user.<span class="property">info</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç½®</p><p>ä½¿ç”¨ç»„åˆå¼<code>API</code>æ—¶, éœ€è¦è‡ªå·±åˆ›å»º<code>$reset</code>å‡½æ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/user.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> info = ref&lt;<span class="title class_">UserInfo</span> | <span class="literal">null</span>&gt;(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xiaolin&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">$reset</span>(<span class="params"></span>) &#123;</span><br><span class="line">        info.<span class="property">value</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;info, $reset&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶ä¸­æˆ–ç»„ä»¶å¤–</span></span><br><span class="line"><span class="keyword">import</span> &#123;userUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line"><span class="comment">// é‡ç½®</span></span><br><span class="line">user.$reset();</span><br></pre></td></tr></table></figure><p>æ³¨æ„:</p><ol><li>ä½¿ç”¨<code>setup store</code>æ—¶, <code>setup</code>å‡½æ•°è¦åƒ<code>vue</code>ä¸­çš„<code>setup</code>å‡½æ•°ä¸€æ ·, éœ€è¦è¿”å›ä¸€ä¸ªå¯¹è±¡, è¿™æ ·æ‰èƒ½åœ¨ç»„ä»¶ä¸­æˆ–è€…ç»„ä»¶å¤–è®¿é—®åˆ°</li><li>é€‰é¡¹å¼<code>API</code>æ–¹å¼å®šä¹‰çš„<code>state</code>ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º<code>$reset</code>å‡½æ•°</li></ol><p><img src="Pinia%E4%B8%ADStore%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AE%BF%E9%97%AE.png" alt="Piniaä¸­Storeçš„å®šä¹‰å’Œè®¿é—®" /></p><p><a href="#é—®é¢˜ä¸€">é‡ç½®æ—¶å‡ºé”™</a></p><h4 id="å®šä¹‰getters"><a class="markdownIt-Anchor" href="#å®šä¹‰getters"></a> å®šä¹‰<code>getters</code></h4><p><code>setup store</code>ä¸­çš„<code>getter</code>æ˜¯é€šè¿‡<code>computed</code>å®šä¹‰çš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore</span><br><span class="line">    = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = ref&lt;<span class="title class_">UserInfo</span> | <span class="literal">null</span>&gt;(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xiaolin&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getInfo = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;info, getInfo&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è®¿é—®</p><p>ä¸è®¿é—®<code>state</code>çš„å±æ€§ä¸€è‡´, ç›´æ¥è°ƒç”¨å³å¯, éœ€è¦æ³¨æ„çš„æ˜¯, <code>getter</code>æˆ–è€…è¯´è®¡ç®—å±æ€§çš„å®šä¹‰æ–¹å¼æ˜¯å‡½æ•°å¼, ä½†æ˜¯è®¿é—®æ—¶æ˜¯ä¸éœ€è¦ä½¿ç”¨&quot;()&quot;çš„; <code>computed</code>åœ¨å®šä¹‰æ—¶å°±å·²ç»ç¡®å®šäº†è¿”å›çš„å†…å®¹, å®ƒæ˜¯é€šè¿‡å®šä¹‰çš„å›è°ƒå‡½æ•°ç¡®å®šçš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;user: &quot;</span>, user.<span class="property">getInfo</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="Pinia%E4%B8%ADStore%E7%9A%84getter%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AE%BF%E9%97%AE.png" alt="Piniaä¸­Storeçš„getterå®šä¹‰å’Œè®¿é—®" /></p><p>éœ€è¦æ³¨æ„çš„æ˜¯, <code>getter</code>æœ¬èº«æ˜¯ä¸æ¥æ”¶å‚æ•°çš„, ä½†æ˜¯ç”±äº<code>getter</code>æ˜¯è‡ªå®šä¹‰çš„, æ‰€ä»¥å¯ä»¥é€šè¿‡<code>getter</code>è¿”å›ä¸€ä¸ªå‡½æ•°, é€šè¿‡å‡½æ•°æ¥æ”¶å‚æ•°, æ‰§è¡Œæ“ä½œ, å…¶è°ƒç”¨æ–¹å¼å³å¯ç±»ä¼¼å‡½æ•°è°ƒç”¨</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/user.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore</span><br><span class="line">    = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = ref&lt;<span class="title class_">UserInfo</span> | <span class="literal">null</span>&gt;(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;xiaolin&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getInfo = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">(<span class="params">key</span>) =&gt;</span> info.<span class="property">value</span>[key];</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;info, getInfo&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶ä¸­æˆ–ç»„ä»¶å¤–</span></span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> name = user.<span class="title function_">getInfo</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰action"><a class="markdownIt-Anchor" href="#å®šä¹‰action"></a> å®šä¹‰<code>action</code></h4><p><code>setup store</code>ä¸­çš„<code>action</code>æ˜¯é€šè¿‡<code>function</code>å®šä¹‰çš„</p><p>å®šä¹‰</p><p>å®šä¹‰æ–¹å¼ä¸å‡½æ•°å®šä¹‰æ–¹å¼ä¸€è‡´</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/user.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore</span><br><span class="line">    = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> info = ref&lt;<span class="title class_">UserInfo</span> | <span class="literal">null</span>&gt;(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setUser</span>(<span class="params"><span class="attr">user</span>: <span class="title class_">UserInfo</span></span>) &#123;</span><br><span class="line">        info.<span class="property">value</span> = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;info, setUser&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è®¿é—®</p><p>è®¿é—®æ—¶ä¸è°ƒç”¨å‡½æ•°ä¸€è‡´, æœ‰å‚æ•°æ—¶æ·»åŠ å‚æ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„ä»¶ä¸­æˆ–ç»„ä»¶å¤–</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">  user.<span class="title function_">setUser</span>(&#123;&#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="Pinia%E4%B8%ADStore%E7%9A%84action%E5%AE%9A%E4%B9%89%E5%92%8C%E8%AE%BF%E9%97%AE.png" alt="Piniaä¸­Storeçš„actionå®šä¹‰å’Œè®¿é—®" /></p><p>è®¢é˜…<code>action</code></p><p>å¯ä»¥é€šè¿‡<code>store.$onAction()</code>æ¥ç›‘å¬<code>action</code>å’Œå®ƒä»¬çš„ç»“æœ, ä¼ é€’ç»™å®ƒä»¬çš„å›è°ƒå‡½æ•°ä¼šåœ¨<code>action</code>æœ¬èº«ä¹‹å‰æ‰§è¡Œ. <code>after</code>è¡¨ç¤ºåœ¨<code>promise</code>è§£å†³ä¹‹å,å…è®¸åœ¨<code>action</code>è§£å†³ä¹‹åæ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°. <code>onError</code>å…è®¸åœ¨<code>action</code>æŠ›å‡ºé”™è¯¯æˆ–è€…<code>reject</code>æ—¶æ‰§è¡Œä¸€ä¸ªå›è°ƒ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actionListener = userStore.$onAction(</span><br><span class="line"><span class="function">(<span class="params">&#123;name, store, arges, after, onError&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> time = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`start action [<span class="subst">$&#123;name&#125;</span>] with params [<span class="subst">$&#123;args.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>].`</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">after</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`finish action [<span class="subst">$&#123;name&#125;</span>] after <span class="subst">$&#123;<span class="built_in">Date</span>.now() - time&#125;</span>ms.\nresult: <span class="subst">$&#123;result&#125;</span>`</span>)</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">onError</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> [</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`failed action [<span class="subst">$&#123;name&#125;</span>] after <span class="subst">$&#123;<span class="built_in">Date</span>.now() - time&#125;</span>ms.\nerror: <span class="subst">$&#123;err&#125;</span>`</span>)</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç›‘å¬å™¨çš„ä¸­</p><ul><li><code>name</code>: ç›‘å¬çš„<code>action</code>åç§°</li><li><code>store</code>: ç›‘å¬çš„<code>action</code>æ‰€åœ¨çš„çŠ¶æ€åº“</li><li><code>agres</code>: ç›‘å¬çš„<code>action</code>è°ƒç”¨æ—¶çš„å‚æ•°</li><li><code>after</code>: ç›‘å¬çš„<code>action</code>æˆåŠŸè°ƒç”¨åçš„åç½®å¤„ç†</li><li><code>onError</code>: ç›‘å¬çš„<code>action</code>å¼‚å¸¸æˆ–è€…æ‹’ç»æƒ…å†µçš„åç½®å¤„ç†</li></ul><p>é»˜è®¤æƒ…å†µä¸‹, <code>action</code>è®¢é˜…å™¨ä¼šè¢«ç»‘å®šåˆ°æ·»åŠ çš„ç»„ä»¶ä¸Š, å½“ç»„ä»¶è¢«å¸è½½æ—¶, å°†è¢«è‡ªåŠ¨åˆ é™¤. å¦‚æœæƒ³åœ¨ç»„ä»¶å¸è½½åä¾æ—§ä¿ç•™, å¯ä»¥åœ¨å®šä¹‰æ—¶æ·»åŠ ç¬¬äºŒä¸ªå‚æ•°, å€¼ä¸º<code>true</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listener = store.$onAction(callback, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h3 id="é¡¹ç›®ä½¿ç”¨"><a class="markdownIt-Anchor" href="#é¡¹ç›®ä½¿ç”¨"></a> é¡¹ç›®ä½¿ç”¨</h3><p>åˆ°æ­¤å¤„, å¯ä»¥å…ˆæ·»åŠ ä¸¤å¤„<code>store</code>çš„ä½¿ç”¨, ä¿¡æ¯ä»æœ€åˆå§‹ä¿¡æ¯å¼€å§‹, é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ä¸æ–­å®Œå–„ä¿¡æ¯</p><h4 id="çŠ¶æ€åº“"><a class="markdownIt-Anchor" href="#çŠ¶æ€åº“"></a> çŠ¶æ€åº“</h4><p>ä¸€å¤„æ˜¯<code>menu</code>, ç”¨äºå­˜å‚¨èœå•å’Œè·¯ç”±ä¿¡æ¯</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">xiaolin</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/1/23 18:58</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;defineStore&#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">RouteModel</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/router/model.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;addRouters, currentRoute, to&#125; <span class="keyword">from</span> <span class="string">&quot;@/router/router.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">RouteNameEnum</span>, <span class="title class_">RoutePathEnum</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/assets/ts/enums/RouteEnum.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">UserInfo</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/assets/ts/model/system/UserInfo.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useMenuStore = <span class="title function_">defineStore</span>(<span class="string">&quot;menu&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> menus = ref&lt;<span class="title class_">RouteModel</span>[]&gt;([] <span class="keyword">as</span> <span class="title class_">RouteModel</span>[]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> menuList = ref&lt;<span class="title class_">RouteModel</span>[]&gt;([] <span class="keyword">as</span> <span class="title class_">RouteModel</span>[]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> activeMenu = ref&lt;<span class="title class_">RouteModel</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> includeMenu = ref&lt;<span class="title class_">RouteModel</span>[]&gt;([]);</span><br><span class="line">    <span class="comment">// è·å–èœå•</span></span><br><span class="line">    <span class="keyword">const</span> getMenus = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> menus.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–èœå•è·¯ç”±</span></span><br><span class="line">    <span class="keyword">const</span> getRoutes = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> menuList.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–æŸä¸ªèœå•è·¯ç”±</span></span><br><span class="line">    <span class="keyword">const</span> getRoute = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">(<span class="params"><span class="attr">path</span>: <span class="built_in">string</span></span>) =&gt;</span> menuList.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> path === item.<span class="property">path</span>) || <span class="title class_">RouteModel</span>.<span class="title function_">generateModel</span>(&#123;&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ´»è·ƒèœå•</span></span><br><span class="line">    <span class="keyword">const</span> getActive = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> activeMenu.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–æ‰“å¼€çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">const</span> getIncludeMenu = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> includeMenu.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è®¾ç½®èœå•</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setMenu</span> = (<span class="params"><span class="attr">menu</span>: <span class="title class_">RouteModel</span>[]</span>) =&gt; &#123;</span><br><span class="line">        menus.<span class="property">value</span> = menu;</span><br><span class="line">        menuList.<span class="property">value</span> = <span class="title class_">RouteModel</span>.<span class="title function_">getRoutes</span>(menu);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰æ´»è·ƒèœå•</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setActive</span> = (<span class="params"><span class="attr">menu</span>: <span class="title class_">RouteModel</span> | <span class="literal">undefined</span></span>) =&gt; &#123;</span><br><span class="line">        activeMenu.<span class="property">value</span> = menu;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ·»åŠ æ‰“å¼€çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">addIncludeMenu</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">menu</span>: <span class="title class_">RouteModel</span></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (includeMenu.<span class="property">value</span>.<span class="property">length</span> &lt; <span class="number">1</span> &amp;&amp; menu.<span class="property">path</span> !== <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> first = getRoute.<span class="title function_">value</span>(<span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span>);</span><br><span class="line">            includeMenu.<span class="property">value</span>.<span class="title function_">push</span>(first);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> tag = includeMenu.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="title function_">same</span>(menu));</span><br><span class="line">        <span class="keyword">if</span> (!tag) &#123;</span><br><span class="line">            includeMenu.<span class="property">value</span>.<span class="title function_">push</span>(menu);</span><br><span class="line">            <span class="title function_">setActive</span>(menu);</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">to</span>(menu);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç§»é™¤å·²æ‰“å¼€çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">removeIncludeMenu</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">menu</span>: <span class="title class_">RouteModel</span></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> menus = includeMenu.<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (menus.<span class="property">length</span> &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> index = menus.<span class="title function_">indexOf</span>(menu);</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            includeMenu.<span class="property">value</span> = includeMenu.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> !item.<span class="title function_">same</span>(menu));</span><br><span class="line">            <span class="keyword">let</span> next = includeMenu.<span class="property">value</span>[--index];</span><br><span class="line">            <span class="title function_">setActive</span>(next);</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">to</span>(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ˜¯å¦éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">needInit</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> menus.<span class="property">value</span>.<span class="property">length</span> &lt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–èœå•</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">initMenu</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">path</span>?: <span class="built_in">string</span>, <span class="attr">isLogin</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isLogin &amp;&amp; !<span class="title function_">needInit</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> userStore = <span class="title function_">useUserStore</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">user</span>: <span class="title class_">UserInfo</span> = userStore.<span class="property">getUser</span>;</span><br><span class="line">        <span class="comment">// TODO è¯·æ±‚èœå•</span></span><br><span class="line">        <span class="keyword">let</span> result = &#123;<span class="attr">account</span>: user.<span class="property">account</span>, <span class="attr">code</span>: <span class="literal">true</span>, <span class="attr">data</span>: []&#125;;</span><br><span class="line">        <span class="keyword">if</span> (!result.<span class="property">code</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> ms = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">id</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;è¯¦æƒ…&#x27;</span>,</span><br><span class="line">                <span class="attr">children</span>: [],</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="string">&#x27;@/components/HelloWorld.vue&#x27;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">menu</span>: <span class="title class_">RouteModel</span>[] = ms.<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">RouteModel</span>.<span class="title function_">generateModel</span>(item);</span><br><span class="line">        &#125;);</span><br><span class="line">        menu.<span class="title function_">unshift</span>(<span class="title class_">RouteModel</span>.<span class="property">HOME</span>)</span><br><span class="line">        <span class="title function_">addRouters</span>(menu, <span class="title class_">RouteNameEnum</span>.<span class="property">INDEX</span>);</span><br><span class="line">        <span class="title function_">setMenu</span>(menu);</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">next</span>: <span class="built_in">string</span> = path || <span class="title function_">currentRoute</span>().<span class="property">path</span> <span class="keyword">as</span> <span class="built_in">string</span> || <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span></span><br><span class="line">        next = <span class="string">&#x27;/&#x27;</span> === next ? <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span> : next;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">route</span>: <span class="title class_">RouteModel</span> = getRoute.<span class="title function_">value</span>(next);</span><br><span class="line">        <span class="comment">// setActive(route);</span></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">addIncludeMenu</span>(route);</span><br><span class="line">        <span class="comment">// await to(route).then(() =&gt; &#123;</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºèœå•</span></span><br><span class="line">    <span class="keyword">const</span> clearMenu = <span class="keyword">function</span> (<span class="params"></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">        <span class="title function_">setMenu</span>([])</span><br><span class="line">        includeMenu.<span class="property">value</span> = [];</span><br><span class="line">        <span class="title function_">setActive</span>(<span class="literal">undefined</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;getRoutes, getRoute, getMenus, getActive, getIncludeMenu,</span><br><span class="line">        setMenu, setActive, addIncludeMenu, removeIncludeMenu, needInit, initMenu, clearMenu&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸€å¤„æ˜¯<code>user</code>, ç”¨äºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;defineStore&#125; <span class="keyword">from</span> <span class="string">&quot;pinia&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useMenuStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/menu.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;currentRoute&#125; <span class="keyword">from</span> <span class="string">&quot;@/router/router.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">UserInfo</span>, selectUser, saveUser, <span class="title class_">UserKey</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/assets/ts/model/system/UserInfo.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">RoutePathEnum</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/assets/ts/enums/RouteEnum.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">xiaolin</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/1/18 19:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&quot;user&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> user = ref&lt;<span class="title class_">UserInfo</span>&gt;(<span class="title function_">selectUser</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦ç™»å½•</span></span><br><span class="line">    <span class="keyword">const</span> isLogin = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !!(getToken.<span class="property">value</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·å˜»å˜»</span></span><br><span class="line">    <span class="keyword">const</span> getUser = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user.<span class="property">value</span> || !user.<span class="property">value</span>.<span class="property">token</span>) &#123;</span><br><span class="line">            user.<span class="property">value</span> = <span class="title function_">selectUser</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user.<span class="property">value</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–ç”¨äºtoken</span></span><br><span class="line">    <span class="keyword">const</span> getToken = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getUser.<span class="property">value</span>.<span class="property">token</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">const</span> getUserInfo = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">(<span class="params"><span class="attr">key</span>: <span class="title class_">UserKey</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">info</span>: <span class="title class_">UserInfo</span> = getUser.<span class="property">value</span> ? getUser.<span class="property">value</span> <span class="keyword">as</span> <span class="title class_">UserInfo</span> : &#123;&#125; <span class="keyword">as</span> <span class="title class_">UserInfo</span>;</span><br><span class="line">            <span class="keyword">return</span> info[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// é‡ç½®ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">$reset</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="title function_">setUser</span>(<span class="keyword">new</span> <span class="title class_">UserInfo</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setUser</span>(<span class="params"><span class="attr">userInfo</span>: <span class="title class_">UserInfo</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        user.<span class="property">value</span> = userInfo;</span><br><span class="line">        <span class="title function_">saveUser</span>(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½®token</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setToken</span>(<span class="params"><span class="attr">tokenInfo</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">userInfo</span>: <span class="title class_">UserInfo</span> = getUser.<span class="property">value</span></span><br><span class="line">        userInfo.<span class="property">token</span> = tokenInfo;</span><br><span class="line">        <span class="title function_">saveUser</span>(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ç™»å½•</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">        <span class="comment">// ç™»å½•</span></span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">user</span>: <span class="title class_">UserInfo</span> = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">        user.<span class="property">name</span> = <span class="string">&quot;xiao lin&quot;</span></span><br><span class="line">        user.<span class="property">sex</span> = <span class="number">1</span>;</span><br><span class="line">        user.<span class="property">age</span> = <span class="number">18</span>;</span><br><span class="line">        user.<span class="property">account</span> = <span class="string">&#x27;xiao-lin&#x27;</span></span><br><span class="line">        user.<span class="property">token</span> = <span class="string">&#x27;xiao-lin&#x27;</span></span><br><span class="line">        <span class="title function_">setUser</span>(user);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">const</span> menuStore = <span class="title function_">useMenuStore</span>();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–èœå•</span></span><br><span class="line">        <span class="keyword">let</span> <span class="attr">next</span>: <span class="built_in">string</span> = <span class="title function_">currentRoute</span>().<span class="property">query</span>.<span class="property">toNext</span> <span class="keyword">as</span> <span class="built_in">string</span> || <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span></span><br><span class="line">        next = <span class="string">&#x27;/&#x27;</span> === next ? <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span> : next;</span><br><span class="line">        <span class="keyword">await</span> menuStore.<span class="title function_">initMenu</span>(next, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// const route: RouteModel = menuStore.getRoute(next);</span></span><br><span class="line">        <span class="comment">// menuStore.setActive(route);</span></span><br><span class="line">        <span class="comment">// menuStore.addIncludeMenu(route);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// é€€å‡º</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">logout</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;logout&quot;</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="attr">user</span>: <span class="title class_">UserInfo</span> = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">        <span class="title function_">setUser</span>(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;getUser, isLogin, getUserInfo, getToken, $reset, setUser, setToken, login, logout&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="è·¯ç”±"><a class="markdownIt-Anchor" href="#è·¯ç”±"></a> è·¯ç”±</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">xiaolin</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2024/1/7 16:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;createRouter, createWebHashHistory, <span class="title class_">Router</span>, <span class="title class_">RouteRecordRaw</span>&#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">RouteModel</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/router/model.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useUserStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/user.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;useMenuStore&#125; <span class="keyword">from</span> <span class="string">&quot;@/store/menu.ts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">RouteNameEnum</span>, <span class="title class_">RoutePathEnum</span>&#125; <span class="keyword">from</span> <span class="string">&quot;@/assets/ts/enums/RouteEnum.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Readonly</span>&lt;<span class="title class_">RouteRecordRaw</span>[]&gt; = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="title class_">RoutePathEnum</span>.<span class="property">INDEX</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">RouteNameEnum</span>.<span class="property">INDEX</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/system/container/Container.vue&#x27;</span>),</span><br><span class="line">        <span class="attr">children</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">redirect</span>: <span class="title class_">RoutePathEnum</span>.<span class="property">HOME</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="title class_">RoutePathEnum</span>.<span class="property">LOGIN</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="title class_">RouteNameEnum</span>.<span class="property">LOGIN</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/system/login/Login.vue&#x27;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè·¯ç”±</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">router</span>: <span class="title class_">Router</span> = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">    routes</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±å‰ç½®å®ˆå«</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="title function_">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">&quot;router before guide: &quot;</span>, <span class="keyword">from</span>, to);</span><br><span class="line">    <span class="keyword">const</span> userStore = <span class="title function_">useUserStore</span>();</span><br><span class="line">    <span class="keyword">const</span> menuStore = <span class="title function_">useMenuStore</span>();</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç™»å½•é¡µ, åˆ™ç›´æ¥è·³è½¬</span></span><br><span class="line">    <span class="keyword">if</span> (to.<span class="property">path</span> === <span class="title class_">RoutePathEnum</span>.<span class="property">LOGIN</span>) &#123;</span><br><span class="line">        <span class="title function_">next</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!userStore.<span class="property">isLogin</span>) &#123;    <span class="comment">// æœªç™»å½•åˆ™ç›´æ¥åˆ°ç™»å½•é¡µ</span></span><br><span class="line">        <span class="title function_">next</span>(&#123;<span class="attr">path</span>: <span class="title class_">RoutePathEnum</span>.<span class="property">LOGIN</span>, <span class="attr">name</span>: <span class="title class_">RouteNameEnum</span>.<span class="property">LOGIN</span>, <span class="attr">query</span>: &#123;<span class="attr">toNext</span>: to.<span class="property">path</span>&#125;&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦åˆå§‹åŒ–èœå•</span></span><br><span class="line">        <span class="keyword">if</span> (menuStore.<span class="title function_">needInit</span>()) &#123;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–èœå•, åˆå§‹å®Œä¹‹å</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> menuStore.<span class="title function_">initMenu</span>(to.<span class="property">path</span>)) &#123;</span><br><span class="line">                <span class="title function_">next</span>(&#123;...to, <span class="attr">replace</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>(&#123;<span class="attr">path</span>: <span class="title class_">RoutePathEnum</span>.<span class="property">LOGIN</span>, <span class="attr">name</span>: <span class="title class_">RouteNameEnum</span>.<span class="property">LOGIN</span>, <span class="attr">query</span>: &#123;<span class="attr">toNext</span>: to.<span class="property">path</span>&#125;&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">next</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ è·¯ç”±</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addRouters</span>(<span class="params"><span class="attr">routes</span>: <span class="title class_">RouteModel</span>[], <span class="attr">parentName</span>?: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">&quot;router add routers: &quot;</span>, parentName, routes);</span><br><span class="line">    <span class="keyword">if</span> (!routes || routes.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    routes.<span class="title function_">forEach</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (parentName) &#123;</span><br><span class="line">            router.<span class="title function_">addRoute</span>(parentName, route);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            router.<span class="title function_">addRoute</span>(route)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (route.<span class="property">children</span> &amp;&amp; route.<span class="property">children</span>.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="title function_">addRouters</span>(route.<span class="property">children</span>, route.<span class="property">name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·¯ç”±è·³è½¬</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">to</span>(<span class="params"><span class="attr">to</span>: <span class="title class_">RouteModel</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">&quot;router to: &quot;</span>, to);</span><br><span class="line">    <span class="keyword">return</span> router.<span class="title function_">push</span>(to).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰è·¯ç”±</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">currentRoute</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> route = router.<span class="property">currentRoute</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">&quot;router current route: &quot;</span>, route);</span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç™»å½•ç»„ä»¶"><a class="markdownIt-Anchor" href="#ç™»å½•ç»„ä»¶"></a> ç™»å½•ç»„ä»¶</h4><p>ç™»å½•ç»„ä»¶ä¸­æ·»åŠ ç™»å½•æ“ä½œ, è°ƒç”¨ç”¨æˆ·çŠ¶æ€åº“ä¸­çš„ç™»å½•å‡½æ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">operation</span>(<span class="params"><span class="attr">type</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(!userInfo.<span class="property">value</span>.<span class="property">username</span>) &#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">warning</span>(<span class="string">&quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!userInfo.<span class="property">value</span>.<span class="property">password</span>) &#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">warning</span>(<span class="string">&quot;å¯†ç ä¸èƒ½ä¸ºç©º!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="number">1</span> === <span class="keyword">type</span>.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">login</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">2</span> === <span class="keyword">type</span>.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="title function_">register</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> info = &#123;</span><br><span class="line">    <span class="attr">username</span>: userInfo.<span class="property">value</span>.<span class="property">username</span>,</span><br><span class="line">    <span class="attr">password</span>: userInfo.<span class="property">value</span>.<span class="property">password</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> userStore.<span class="title function_">login</span>();</span><br><span class="line">  <span class="comment">// store.dispatch(&#x27;Login&#x27;, info).then(res =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   console.log(res)</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸ºæ¼”ç¤ºä»£ç , å…·ä½“éœ€è¦æ“ä½œå¯æ ¹æ®è‡ªå·±çš„éœ€è¦å¤„ç†</p><h4 id="èœå•ç»„ä»¶"><a class="markdownIt-Anchor" href="#èœå•ç»„ä»¶"></a> èœå•ç»„ä»¶</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> menuStore = <span class="title function_">useMenuStore</span>();</span><br><span class="line"><span class="keyword">const</span> menus = ref&lt;<span class="title class_">RouteModel</span>[]&gt;([]);</span><br><span class="line"><span class="keyword">const</span> active = ref&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;(<span class="literal">undefined</span>);</span><br><span class="line"><span class="comment">// è·å–èœå•å’Œå½“å‰è·¯ç”±è·¯å¾„</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  menus.<span class="property">value</span> = menuStore.<span class="property">getMenus</span></span><br><span class="line">  active.<span class="property">value</span> = router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">path</span>;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ç›‘å¬è·¯ç”±è·¯å¾„, ä¿®æ”¹æ´»è·ƒèœå•</span></span><br><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">path</span>,</span><br><span class="line">    <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">      active.<span class="property">value</span> = newVal;</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">// èœå•ç‚¹å‡»äº‹ä»¶, æ·»åŠ åˆ°æ‰“å¼€èœå•, å¹¶è®¾ç½®æ–°çš„æ´»è·ƒèœå•</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">menuClick</span>(<span class="params"><span class="attr">menu</span>: <span class="title class_">RouteModel</span></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> menuStore.<span class="title function_">addIncludeMenu</span>(menu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èœå•ç»„ä»¶ä¸­åšä¸‰ä»¶äº‹: 1. è·å–åˆå§‹åŒ–åçš„èœå•å’Œæ´»è·ƒèœå•; 2. ç›‘å¬è·¯ç”±; 3, èœå•ç‚¹å‡»äº‹ä»¶. å‰ä¸¤ä»¶äº‹æ˜¯ä¸ºäº†è·å–æ´»è·ƒèœå•, å›æ˜¾èœå•çš„æ ·å¼; èœå•ç‚¹å‡»æ˜¯ä¸ºäº†åˆ‡æ¢è·¯ç”±</p><h4 id="æ ‡ç­¾ç»„ä»¶"><a class="markdownIt-Anchor" href="#æ ‡ç­¾ç»„ä»¶"></a> æ ‡ç­¾ç»„ä»¶</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> menuStore = <span class="title function_">useMenuStore</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line"><span class="comment">// å½“å‰æ´»è·ƒæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">let</span> checkedName = ref&lt;<span class="built_in">string</span> | <span class="literal">undefined</span>&gt;();</span><br><span class="line"><span class="comment">// æ‰“å¼€çš„èœå•æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">let</span> dynamicTags = ref&lt;<span class="title class_">RouteModel</span>[]&gt;([]);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ‰“å¼€çš„èœå•æ ‡ç­¾å’Œæ´»è·ƒæ ‡ç­¾</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  dynamicTags.<span class="property">value</span> = menuStore.<span class="property">getIncludeMenu</span>;</span><br><span class="line">  checkedName.<span class="property">value</span> = menuStore.<span class="property">getActive</span>?.<span class="property">name</span>;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ç›‘å¬è·¯ç”±, æ·»åŠ æ–°æ ‡ç­¾</span></span><br><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">path</span>,</span><br><span class="line">    <span class="title function_">async</span> (newVal, oldVal) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;route change&quot;</span>, newVal)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">addTag</span>(newVal)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="comment">// æ ‡ç­¾å…³é—­æ“ä½œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleClose</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> remove = dynamicTags.<span class="property">value</span>.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">name</span> === name);</span><br><span class="line">  <span class="keyword">await</span> menuStore.<span class="title function_">removeIncludeMenu</span>(remove <span class="keyword">as</span> <span class="title class_">RouteModel</span>);</span><br><span class="line">  dynamicTags.<span class="property">value</span> = menuStore.<span class="property">getIncludeMenu</span>;</span><br><span class="line">  checkedName.<span class="property">value</span> = menuStore.<span class="property">getActive</span>?.<span class="property">name</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ ‡ç­¾ç‚¹å‡»æ“ä½œ</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onClick</span>(<span class="params"><span class="attr">tag</span>: <span class="built_in">any</span>, <span class="attr">ev</span>?: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;tag: &quot;</span>, tag.<span class="property">index</span>);</span><br><span class="line">  checkedName.<span class="property">value</span> = tag.<span class="property">paneName</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">to</span>(dynamicTags.<span class="property">value</span>[tag.<span class="property">index</span>] <span class="keyword">as</span> <span class="title class_">RouteModel</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ·»åŠ æ–°æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">addTag</span>(<span class="params"><span class="attr">newValue</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> route = menuStore.<span class="title function_">getRoute</span>(newValue);</span><br><span class="line">  <span class="keyword">if</span> (!route) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> menuStore.<span class="title function_">addIncludeMenu</span>(route);</span><br><span class="line">  menuStore.<span class="title function_">setActive</span>(route);</span><br><span class="line">  checkedName.<span class="property">value</span> = menuStore.<span class="property">getActive</span>?.<span class="property">name</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ‡ç­¾ç»„ä»¶ä¸»è¦åšå››ä»¶äº‹: 1. æ‰“å¼€æ ‡ç­¾å’Œæ´»è·ƒæ ‡ç­¾çš„åˆå§‹åŒ–; 2. ç›‘å¬è·¯ç”±; 3. æ ‡ç­¾å…³é—­æ“ä½œ; 4. æ ‡ç­¾ç‚¹å‡»æ“ä½œ. å‰ä¸¤ä»¶æ˜¯ä¸ºäº†æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨å’Œæ´»è·ƒæ ‡ç­¾æ ·å¼; ç¬¬3ä»¶æ˜¯ä¸ºäº†å…³é—­æ ‡ç­¾, å¹¶è·å–è·³è½¬åˆ°æœ€æ–°æ ‡ç­¾å’Œè·¯ç”±; ç¬¬4ä»¶äº‹ä¸ºäº†åˆ‡æ¢æ ‡ç­¾å’Œè·¯ç”±</p><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>å‡ºç°é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Store &quot;user&quot; is built using the setup syntax and does not implement $reset()</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› :</p><p>åŸå› ä¸€: åœ¨ä½¿ç”¨ç»„åˆå¼<code>API</code>æ—¶, éœ€è¦è‡ªå®šä¹‰<code>$reset</code>å‡½æ•°, å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰, åˆ™è°ƒç”¨æ—¶ä¼šå‡ºç°æ­¤é—®é¢˜</p><p>åŸå› äºŒ: å¦‚æœå®šä¹‰äº†<code>$reset</code>å‡½æ•°åä¾ç„¶å‡ºç°æ­¤é—®é¢˜, å¯èƒ½æ˜¯ç¼“å­˜å¯¼è‡´çš„</p><p>è§£å†³æ–¹æ¡ˆ:</p><p>æ–¹æ¡ˆä¸€: åœ¨ç›®æ ‡<code>store</code>ä¸­å®šä¹‰<code>$reset</code>å‡½æ•°</p><p>æ–¹æ¡ˆäºŒ: æ¸…ç©ºç¼“å­˜å¹¶åˆ·æ–°æµè§ˆå™¨</p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pinia </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vueç³»åˆ—(äºŒ)---è·¯ç”±</title>
      <link href="/2024/01/07/web/Vue%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E8%B7%AF%E7%94%B1/"/>
      <url>/2024/01/07/web/Vue%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E8%B7%AF%E7%94%B1/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>vue-router</code>æ˜¯<code>vue</code>å®˜æ–¹æ¨èçš„å‰ç«¯è·¯ç”±. ç”±äºæœ¬ç¯‡çš„è·¯ç”±ä¼šå®é™…å¼•å…¥é¡¹ç›®ä¸­ä½¿ç”¨, æ‰€ä»¥æœ¬ç¯‡ä¸­çš„è·¯ç”±ä¸ä»…ä»…æ˜¯è·¯ç”±, è¿˜æ˜¯èœå•å’Œé¡µé¢æ ‡ç­¾. åœ¨ä½¿ç”¨æ—¶ä¼šé‡æ–°å®šä¹‰è·¯ç”±çš„ä½¿ç”¨</p><h3 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h3><p>æœ¬ç¯‡åŸºäºå‰ç¯‡, ä½¿ç”¨<code>pnpm</code>æ–¹å¼å®‰è£…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add vue-router@4</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º"><a class="markdownIt-Anchor" href="#åˆ›å»º"></a> åˆ›å»º</h3><p>åœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª<code>router</code>ç›®å½•, åœ¨<code>router</code>ç›®å½•ä¸‹åˆ›å»º<code>index.ts</code></p><p>åœ¨<code>index.ts</code>ä¸­åˆ›å»ºä¸€ä¸ªè·¯ç”±</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createRouter, createWebHashHistory, <span class="title class_">Router</span>, <span class="title class_">RouteRecordRaw</span>&#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Readonly</span>&lt;<span class="title class_">RouteRecordRaw</span>[]&gt; = [</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> <span class="attr">router</span>: <span class="title class_">Router</span> = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHashHistory</span>(),</span><br><span class="line">    routes</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure><h3 id="å¼•å…¥"><a class="markdownIt-Anchor" href="#å¼•å…¥"></a> å¼•å…¥</h3><p>åœ¨<code>main.ts</code>ä¸­å¯¼å…¥åˆ›å»ºçš„è·¯ç”±, å¹¶é€šè¿‡<code>use</code>å‡½æ•°å¼•å…¥</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&quot;@/router&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line">app.<span class="title function_">use</span>(router);</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="ç®€å•ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ç®€å•ä½¿ç”¨"></a> ç®€å•ä½¿ç”¨</h3><ol><li><p>ä½¿ç”¨<code>router-view</code>æ¥å±•ç¤ºå†…å®¹</p><p>åœ¨<code>App.vue</code>ä¸­æ·»åŠ <code>router-view</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;router-view /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p><code>App.vue</code>ä¸­å®é™…ä¸Šå…¶ä»–äº‹æƒ…éƒ½å¯ä»¥ä¸åš, ä½†ä¹Ÿå¯ä»¥å¤„ç†éƒ¨åˆ†å†…å®¹, å¦‚å®šä¹‰éƒ¨åˆ†æ ¹æ ·å¼</p></li><li><p>ä½¿ç”¨<code>router-link</code>æ¥åˆ‡æ¢è·¯ç”±</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;router-link to=&quot;/hello&quot;&gt;to hello&lt;/router-link&gt;</span><br></pre></td></tr></table></figure><p>é€šå¸¸ä½¿ç”¨ç¼–ç¨‹å¼å¯¼èˆªä»£æ›¿</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">push</span>(&#123;<span class="attr">path</span>: <span class="string">`/hello`</span>&#125;);</span><br><span class="line">router.<span class="title function_">replace</span>(&#123;<span class="attr">path</span>: <span class="string">`hello`</span>&#125;);</span><br><span class="line">router.<span class="title function_">go</span>(<span class="number">1</span>/-<span class="number">1</span>/<span class="number">1000</span>)</span><br></pre></td></tr></table></figure></li><li><p>åœ¨<code>routes</code>ä¸­æ·»åŠ è·¯ç”±</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Readonly</span>&lt;<span class="title class_">RouteRecordRaw</span>[]&gt; = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/hello&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/components/HelloWorld.vue&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>å±•ç¤º</p><p><img src="Router%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8.png" alt="RouteråŸºç¡€ä½¿ç”¨" /></p></li><li><p>å…¶ä»–</p><p>åœ¨å®é™…ä½¿ç”¨ä¸­, è·¯ç”±è·¯å¾„çš„å®šä¹‰ä½ç½®é€šå¸¸ä¸æ˜¯ä½¿ç”¨<code>router-link</code>, è€Œæ˜¯ä½¿ç”¨ç»„ä»¶æ¥å®ç°, è·¯ç”±è·¯å¾„çš„å®šä¹‰ä½ç½®å’Œæ–¹å¼ä¸é‡è¦, é‡è¦çš„æ˜¯å®šä¹‰è·¯ç”±è·¯å¾„å’Œç»„ä»¶æ˜ å°„, ä»¥åŠå¦‚ä½•è·³è½¬åˆ°è¯¥è·¯ç”±è·¯å¾„ä¸Š</p></li></ol><h3 id="èœå•å’Œè·¯ç”±"><a class="markdownIt-Anchor" href="#èœå•å’Œè·¯ç”±"></a> èœå•å’Œè·¯ç”±</h3><p>æœ¬ç¯‡ä¸­ä½¿ç”¨<code>element</code>ä½œä¸ºé¡¹ç›®çš„å¼€å‘ç»„ä»¶åº“, æ‰€ä»¥æ­¤å¤„éœ€è¦æ·»åŠ <code>element</code>, ç„¶åä½¿ç”¨<code>element</code>ä¸­çš„<code>menu</code>ç»„ä»¶å®ç°èœå•å’Œè·¯ç”±çš„æ§åˆ¶</p><p>é‡‡ç”¨å®˜æ–¹æ¨èçš„æŒ‰éœ€å¯¼å…¥çš„æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pnpm add element-plus --save</span><br><span class="line">pnpm add unplugin-vue-components unplugin-auto-import --save-dev</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>vite.config.ts</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ElementPlusResolver</span>&#125; <span class="keyword">from</span> <span class="string">&quot;unplugin-vue-components/resolvers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AutoImport</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-auto-import/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Components</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/vite&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">vue</span>(),</span><br><span class="line">        <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">            <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()]</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="title class_">Components</span>(&#123;</span><br><span class="line">            <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">        &#125;),</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>AutoImport</code>å’Œ<code>Components</code>å¯èƒ½æ— æ³•è§£æåˆ°, éœ€è¦æ‰‹åŠ¨æ·»åŠ å¯¼å…¥</p><ol><li><p>æ·»åŠ ä¸€ä¸ª<code>login</code>è·¯ç”±</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/system/login/Index.vue&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>/src/views/system/login</code>ä¸‹åˆ›å»º<code>Index.vue</code>æ–‡ä»¶</p><p>ç½‘ä¸Šéšä¾¿æ‰’æ‹‰ä¸€ä¸ªç™»å½•é¡µé¢æ·»åŠ åˆ°<code>Index.vue</code>ä¸­</p><p>å¯åŠ¨é¡¹ç›®å, è¾“å…¥<code>#/login</code>è·³è½¬è·¯ç”±</p><p><img src="%E7%99%BB%E5%BD%95%E9%A1%B5%E8%B7%AF%E7%94%B1.png" alt="ç™»å½•é¡µè·¯ç”±" /></p></li><li><p>é¡¹ç›®å¸ƒå±€å’Œé¦–é¡µ</p><p>æ·»åŠ ä¸€ä¸ªé¦–é¡µè·¯ç”±</p><p>æ‰’æ‹‰ä¸€ä¸ªé¡¹ç›®å¸ƒå±€</p><p>å·¦ä¾§æ·»åŠ èœå•</p><p><img src="%E7%B3%BB%E7%BB%9F%E9%A6%96%E9%A1%B5.png" alt="ç³»ç»Ÿé¦–é¡µ" /></p><p>è·¯ç”±è®¾ç½®:</p><ol><li><code>App.vue</code>ä¸­æœ‰ä¸€ä¸ª<code>router-view</code>æ ‡ç­¾, ç”¨æ¥è·¯ç”±ç½‘ç«™é¦–é¡µå’Œç™»å½•é¡µ</li><li><code>Show.vue</code>ä¸­æœ‰ä¸€ä¸ª<code>router-view</code>ç”¨æ¥è·¯ç”±ç½‘ç«™å†…å®¹é¡µ</li><li>è·¯ç”±é…ç½®<ul><li>é¡¶çº§è·¯ç”±æœ‰ä¸¤ä¸ª: å†…å®¹æ ¹è·¯ç”±å’Œç™»å½•é¡µè·¯ç”±</li><li>å†…å®¹è·¯ç”±: å†…å®¹è·¯ç”±ä½œä¸ºå†…å®¹æ ¹è·¯ç”±çš„å­è·¯ç”±</li><li>é¡¹ç›®åˆå§‹æ—¶çš„è·¯ç”±: ä¸‰ä¸ª, åˆ†åˆ«æ˜¯ä¸¤ä¸ªé¡¶çº§è·¯ç”±å’Œä¸€ä¸ªå†…å®¹æ ¹è·¯ç”±ä¸‹çš„é¦–é¡µè·¯ç”±</li><li>èœå•å’Œå†…å®¹: èœå•æ‰€å¯¹åº”çš„è·¯ç”±ä»æœåŠ¡ç«¯è·å–, ä¾æ¬¡æ·»åŠ åˆ°æ ¹è·¯ç”±ä¸­</li></ul></li></ol></li></ol><h3 id="é«˜çº§ä½¿ç”¨"><a class="markdownIt-Anchor" href="#é«˜çº§ä½¿ç”¨"></a> é«˜çº§ä½¿ç”¨</h3><h4 id="å¤šä¸ªrouter-view"><a class="markdownIt-Anchor" href="#å¤šä¸ªrouter-view"></a> å¤šä¸ª<code>router-view</code></h4><p>é€šå¸¸ä¸€ä¸ªé¡¹ç›®ä¸­ä¼šå­˜åœ¨å¤šä¸ª<code>router-view</code>æ ‡ç­¾, ä¸åŒçš„æ–¹å¼ä¼šæœ‰ä¸åŒçš„å±•ç¤ºç»“æœ</p><ol><li><p>åŒä¸€ä¸ªç»„ä»¶ä¸­æœ‰å¤šä¸ª<code>router-view</code></p><p>å³å¤šè§†å›¾</p><p>è¦æ±‚:</p><ul><li>ä¸åŒçš„<code>router-view</code>éœ€è¦æ·»åŠ ä¸åŒçš„<code>name</code>å±æ€§</li><li>éœ€è¦ä½¿ç”¨è¯¥ç»„ä»¶å±•ç¤ºçš„è·¯ç”±, å¯¹åº”çš„<code>components</code>ä¸­çš„æ¯ä¸ª<code>component</code>çš„<code>key</code>å¿…é¡»ä¸<code>router-view</code>ä¸­çš„<code>name</code>å¯¹åº”</li></ul><p>è¿™ç§æ˜¯é€šè¿‡è·¯ç”±çš„å¤šç»„ä»¶è¡¨è¾¾çš„, ç»„ä»¶çš„<code>key</code>éœ€è¦ä¸å¯¹åº”çš„<code>router-view</code>çš„<code>name</code>ä¸€è‡´</p><p>å¤š<code>router-view</code>ç»„ä»¶å®šä¹‰:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;router-view name=&quot;left&quot; /&gt;</span><br><span class="line">&lt;router-view name=&quot;right&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>å¤š<code>router-view</code>çš„è·¯ç”±å®šä¹‰:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">components</span>: &#123;</span><br><span class="line">            <span class="attr">left</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/**/Left.vue&#x27;</span>),</span><br><span class="line">            <span class="attr">right</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/**/Right.vue&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å±•ç¤ºæè¿°:</p><p>å½“è·¯ç”±åˆ°<code>path</code>ä¸º<code>/</code>çš„åœ°å€æ—¶, <code>Left.vue</code>å’Œ<code>Right.vue</code>å°†åˆ†åˆ«åœ¨<code>left</code>å’Œ<code>right</code>ä¸­æ˜¾ç¤º</p></li><li><p>åœ¨æœ‰çˆ¶å­çº§å…³ç³»çš„ç»„ä»¶ä¸­æœ‰å¤šä¸ª<code>router-view</code></p><p>å³<strong>åµŒå¥—è·¯ç”±</strong></p><p>è¿™ç§æ˜¯é€šè¿‡è·¯ç”±çš„çˆ¶å­çº§å…³ç³»è¡¨è¾¾çš„, æ¯æ›´æ·±ä¸€å±‚çš„<code>router-view</code>éƒ½å¯¹åº”è·¯ç”±å®šä¹‰ä¸­æ›´æ·±ä¸€å±‚çš„<code>children</code></p><p>å±‚çº§<code>router-view</code>ç»„ä»¶å®šä¹‰:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;h3&gt;</span><br><span class="line">        HOME</span><br><span class="line">    &lt;/h3&gt;</span><br><span class="line">&lt;router-view /&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;h3&gt;</span><br><span class="line">        CONTENT</span><br><span class="line">    &lt;/h3&gt;</span><br><span class="line">&lt;router-view /&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;h3&gt;</span><br><span class="line">        SO COOL</span><br><span class="line">    &lt;/h3&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸¤ä¸ªç»„ä»¶ä¸­åˆ†åˆ«æœ‰ä¸€ä¸ª<code>router-view</code>, ç°åœ¨æƒ³è¦åœ¨<code>HOME</code>çš„<code>router-view</code>ä¸­å±•ç¤º<code>CONTENT</code>, <code>CONTENT</code>çš„<code>router-view</code>ä¸­å±•ç¤º<code>SO COOL</code></p><p>å±‚çº§è·¯ç”±å®šä¹‰:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/content&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/**/Content.vue&#x27;</span>)</span><br><span class="line">        <span class="attr">children</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">path</span>: <span class="string">&#x27;/so-cool&#x27;</span>,</span><br><span class="line">                <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/**/SoCool.vue&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å±•ç¤ºæè¿°:</p><p>å½“è·¯ç”±åˆ°<code>path</code>ä¸º<code>/content</code>çš„åœ°å€æ—¶, å°†å±•ç¤º<code>Content.vue</code>ç»„ä»¶, å½“è·¯ç”±åˆ°<code>path</code>ä¸º<code>/content/so-cool</code>çš„åœ°å€æ—¶, å°†å±•ç¤º<code>SoCool.vue</code>ç»„ä»¶</p></li></ol><h4 id="åŠ¨æ€è·¯ç”±åŒ¹é…ä¸åŠ¨æ€è·¯ç”±"><a class="markdownIt-Anchor" href="#åŠ¨æ€è·¯ç”±åŒ¹é…ä¸åŠ¨æ€è·¯ç”±"></a> åŠ¨æ€è·¯ç”±åŒ¹é…ä¸åŠ¨æ€è·¯ç”±</h4><p>é¦–å…ˆåŠ¨æ€è·¯ç”±åŒ¹é…å’ŒåŠ¨æ€è·¯ç”±ä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ, åŠ¨æ€è·¯ç”±åŒ¹é…æ˜¯ä¸€ç§è·¯ç”±çš„åŒ¹é…è§„åˆ™, åŠ¨æ€è·¯ç”±æ˜¯æŒ‡å¯ä»¥åŠ¨æ€çš„æ·»åŠ åˆ é™¤è·¯ç”±</p><p>åŠ¨æ€è·¯ç”±åŒ¹é…:</p><p>æŒ‡å°†è·¯ç”±ä¸­çš„å‚æ•°å®šä¹‰åœ¨è·¯ç”±è·¯å¾„ä¸­, è·¯ç”±åœ¨è§£ææ—¶ä¼šå°†è¯¥å‚æ•°ä»¥<code>name:value</code>çš„å½¢å¼æ”¾åˆ°<code>parmas</code>ä¸­, æ ¼å¼é€šè¿‡<code>:name</code>çš„æ–¹å¼ä½“ç°, å¦‚ä¸‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/user/:id&#x27;</span>,</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè·¯ç”±ä¼šåŒ¹é…å…·æœ‰ä¸¤çº§, å¹¶ä¸”ä»¥<code>user</code>å¼€å§‹çš„è·¯å¾„, å¦‚:``/user/1<code>,</code>/user/xiaolin<code>, å®ƒä¸ä¼šåŒºåˆ†å‚æ•°çš„ç±»å‹ç­‰ä¿¡æ¯, è§£æå®Œæˆåä¼šåœ¨</code>params<code>ä¸­æœ‰</code>id:1<code>æˆ–è€…</code>id:xiaolin`çš„å†…å®¹:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/user/1&#x27;</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„:</p><p>å½“ä½¿ç”¨è·¯ç”±åŒ¹é…, å…¶ä¸­å‚æ•°å‘ç”Ÿå˜åŒ–æ—¶, ç›¸åŒçš„ç»„ä»¶å®ä¾‹ä¼šè¢«å¤ç”¨, å³ä¸ä¼šç”±äºå‚æ•°å€¼çš„å˜åŒ–è€Œé‡æ–°é”€æ¯å†åˆ›å»º, è¿™è¡¨ç¤ºç»„ä»¶çš„å£°æ˜å‘¨æœŸé’©å­å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨</p><p>è§£å†³æ–¹å¼:</p><ol><li><p>åœ¨ç»„ä»¶ä¸­ä½¿ç”¨<code>watch</code>ç›‘å¬è·¯ç”±å‚æ•°å˜åŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(</span><br><span class="line"><span class="function">() =&gt;</span> router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">params</span>,</span><br><span class="line">    <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ç»„ä»¶ä¸­ä½¿ç”¨å¯¼èˆªå®ˆå«ç›‘å¬è·¯ç”±å‚æ•°å˜åŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="comment">// to.params</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">    import &#123; useRouter,onBeforeRouteUpdate &#125; from &#x27;vue-router&#x27;;</span><br><span class="line">    const router = useRouter();</span><br><span class="line">    watch(</span><br><span class="line">        () =&gt; router.currentRoute.value.params,</span><br><span class="line">        (newVal, oldVal) =&gt; &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">    onBeforeRouteUpdate(to, from, next) &#123;</span><br><span class="line">        // to.params</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">&lt;!-- ... --&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></blockquote><ol><li><p>å‚æ•°å½¢å¼åŒ¹é…æ­£åˆ™</p><p>åœ¨å‚æ•°åç´§è·Ÿ<code>()</code>, åœ¨<code>()</code>å†…å®šä¹‰å‚æ•°æ­£åˆ™</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>id&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>name&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç”±äºè·¯ç”±åŒ¹é…æ—¶, å®é™…æ˜¯ä¸çŸ¥é“å‚æ•°çš„, æ‰€ä»¥ä¸Šè¿°ä¸¤ä¸ªè·¯ç”±åŒ¹é…æ—¶åªæ˜¯å‚æ•°çš„<code>key</code>ä¸ä¸€è‡´, ä½†å†…å®¹æ— é™åˆ¶, æ‰€ä»¥ä¼šå†²çª</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>id(\\d+)&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>name&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨å°†ç¬¬ä¸€ä¸ªè·¯ç”±æ·»åŠ æ­£åˆ™åŒ¹é…, åˆ™è¯¥è·¯ç”±ä»…åŒ¹é…å‚æ•°å€¼ä¸ºæ•°å­—çš„è·¯å¾„, è€Œå…¶ä»–ç±»å‹çš„å‚æ•°å°†è¢«ç¬¬äºŒä¸ªè·¯ç”±åŒ¹é…</p></li><li><p>å¯é‡å¤å‚æ•°åŒ¹é…</p><p>å¯ä»¥è®¤ä¸ºæ˜¯å‚æ•°ä¸ªæ•°æ­£åˆ™åŒ¹é…</p><p>åœ¨å‚æ•°åé¢ç´§è·Ÿ<code>*</code>(&gt;=0ä¸ªå‚æ•°)æˆ–è€…<code>+</code>(&gt;=1ä¸ªå‚æ•°), æœ‰å‚æ•°å½¢å¼æ­£åˆ™åŒ¹é…æ—¶, è·Ÿåœ¨å‚æ•°å½¢å¼æ­£åˆ™åŒ¹é…ä¹‹å</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>name+&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>name*&#x27;<span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è·¯ç”±è§£ææ—¶ä¼šå°†å¯é‡å¤çš„å‚æ•°åœ¨<code>params</code>ä¸­è§£æä¸ºä¸€ä¸ªæ•°ç»„, <code>key</code>ä¸ºå®šä¹‰çš„å‚æ•°å</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>name&#x27;<span class="punctuation">,</span></span><br><span class="line">    params<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        name<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¯¥è·¯ç”±å³å¯åŒ¹é…<code>/user/1/2/3/...</code>, éœ€è¦æ³¨æ„çš„æ˜¯<code>*</code>æ˜¯å¯ä»¥åŒ¹é…0ä¸ªå‚æ•°çš„, ä½†<code>+</code>ä¸å¯ä»¥, è¿™æ˜¯æ­£åˆ™åŒ¹é…</p></li><li><p>å¯é€‰å‚æ•°åŒ¹é…</p><p>å¯ä»¥ä½¿ç”¨<code>?</code>æ ‡è®°ä¸€ä¸ªå‚æ•°ä¸ºå¯é€‰</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user/<span class="punctuation">:</span>id?&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>è¿™è¡¨ç¤ºå‚æ•°çš„ä¸ªæ•°åªèƒ½æ˜¯0æˆ–1, é…åˆå‚æ•°æ­£åˆ™åŒ¹é…</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    path<span class="punctuation">:</span> &#x27;/user<span class="punctuation">:</span>id(\\d+)?&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="å¯¼èˆªå®ˆå«"><a class="markdownIt-Anchor" href="#å¯¼èˆªå®ˆå«"></a> å¯¼èˆªå®ˆå«</h4><p>ç”¨æ¥é€šè¿‡è·³è½¬æˆ–å–æ¶ˆçš„æ–¹å¼å®ˆå«å¯¼èˆª, ç»‡å…¥æ–¹å¼: å…¨å±€çš„, å•ä¸ªè·¯ç”±ç‹¬äº«çš„, ç»„ä»¶çº§åˆ«çš„</p><ol><li><p>å…¨å±€</p><ul><li><p>å‰ç½®å®ˆå«</p><p><code>beforeEach</code></p><p>ä¸¤ä¸ªå‚æ•°<code>(to, from)</code>: è¿”å›<code>boolean</code>, <code>true</code>æ—¶é€šè¿‡, <code>false</code>ä¸é€šè¿‡</p><p>ä¸‰ä¸ªå‚æ•°<code>(to, from, next)</code>: è¿”å›<code>void</code>, è°ƒç”¨<code>next</code>å›è°ƒæ‰ä¼šè·³è½¬åˆ°<code>to</code>è·¯ç”±, å¦‚æœ<code>next</code>å›è°ƒå‡½æ•°åœ¨è°ƒç”¨æ—¶æ·»åŠ äº†æ–°è·¯ç”±ä½œä¸ºå‚æ•°, åˆ™ä¼šè·³è½¬åˆ°æ–°è·¯ç”±</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">beforeEach</span>(<span class="title function_">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_">isAuthenticated</span>() &amp;&amp; to.<span class="property">name</span> !== <span class="string">&#x27;Login&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">next</span>(&#123;<span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;Login&#x27;</span>, <span class="attr">query</span>: &#123;</span><br><span class="line">            to</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>è§£æå®ˆå«</p><p><code>beforeResolve</code></p><p>è§£æå®ˆå«åˆšå¥½ä¼šåœ¨å¯¼èˆªè¢«ç¡®è®¤ä¹‹å‰, æ‰€æœ‰ç»„ä»¶å†…å®ˆå«å’Œå¼‚æ­¥è·¯ç”±ç»„ä»¶è¢«è§£æä¹‹åè°ƒç”¨</p><p>ä¸€ä¸ªå‚æ•°<code>(to)</code>: è¿”å›<code>boolean | void</code>, <code>false</code>æ—¶å–æ¶ˆå¯¼èˆª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">beforeResole</span>(<span class="keyword">async</span> to =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(to.<span class="property">meta</span>.<span class="property">requiresCamera</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">if</span>(err <span class="keyword">instanceof</span> <span class="title class_">NotAllowedError</span>) &#123;</span><br><span class="line">               returen <span class="literal">false</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ˜¯ä¸€ä¸ªç¡®ä¿ç”¨æˆ·å¯ä»¥è®¿é—®è‡ªå®šä¹‰çš„<code>meta</code>å±æ€§<code>requiresCamera</code>çš„ä¾‹å­</p></li><li><p>åç½®é’©å­</p><p><code>afterEach</code></p><p>åç½®ç§°ä¸ºé’©å­, å’Œå®ˆå«ä¸åŒ, è¿™äº›é’©å­ä¸ä¼šæ¥å—<code>next</code>å‡½æ•°, ä¹Ÿä¸ä¼šæ”¹å˜å¯¼èˆªæœ¬èº«. å¯ä»¥ç”¨æ¥å¤„ç†å¯¼èˆªæ•…éšœ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">afterEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, failure</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>å®ˆå«å†…çš„å…¨å±€æ³¨å†Œ</p><p>åœ¨å¯¼èˆªå®ˆå«å†…ä½¿ç”¨<code>inject</code>æ–¹æ³•è·å–å…¨å±€å†…å®¹. åœ¨<code>app.provede</code>ä¸­æä¾›çš„æ‰€æœ‰å†…å®¹éƒ½å¯ä»¥åœ¨<code>beforeEach</code>, <code>beforeResolve</code>, <code>afterEach</code>å†…è·å–åˆ°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.ts</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line">app.<span class="title function_">provide</span>(<span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;Hello Injections&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.ts</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">global</span> = <span class="title function_">inject</span>(<span class="string">&#x27;global&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> userStore = <span class="title function_">userAuthStore</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul></li><li><p>è·¯ç”±ç‹¬äº«å®ˆå«</p><p><code>beforeEnter</code></p><p>è·¯ç”±ç‹¬äº«å®ˆå«åªåœ¨è¿›å…¥è·¯ç”±æ—¶è§¦å‘, ä¸ä¼šå†<code>params</code>, <code>query</code>æˆ–<code>hash</code>æ”¹å˜æ—¶è§¦å‘</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/user/:id&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">User</span>,</span><br><span class="line">        <span class="attr">beforeEnter</span>: <span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>beforeEnter</code>ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°æ•°ç»„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo1</span>(<span class="params">to</span>) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo2</span>(<span class="params">to</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/user/:id&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">User</span>,</span><br><span class="line">        <span class="attr">beforeEnter</span>: [foo1, foo2]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>ç»„ä»¶å†…çš„å®ˆå«</p><ul><li><p>è¿›å…¥</p><p><code>beforeRouteEnter</code> =&gt; <code>onBeforeRouteEnter</code></p><p>æ”¯æŒ<code>next</code>å›è°ƒ, ä¸å…¨å±€çš„å‰ç½®å®ˆå«ç›¸ä¼¼, å´åˆ«æ—¶ç»„ä»¶å†…çš„å®ˆå«æ˜¯åœ¨ç»„ä»¶çš„å£°æ˜å‘¨æœŸä¸­è°ƒç”¨çš„,åªé’ˆå¯¹è¯¥ç»„ä»¶æœ‰æ•ˆ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeRouteEnter</span>(to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="title function_">next</span>(<span class="function"><span class="params">vm</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡vmè®¿é—®ç»„ä»¶å®ä¾‹, å¯ä»¥è®¿é—®ç»„ä»¶ä¸­å®šä¹‰çš„å†…å®¹</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹</p><p><code>beforeRouteUpdate</code> =&gt; <code>onBeforeRouteUpdate</code></p><p>ä¸æ”¯æŒ<code>next</code></p></li><li><p>ç¦»å¼€</p><p><code>beforeRouteLeave</code> =&gt; <code>onBeforeRouteLeave</code></p><p>ä¸æ”¯æŒ<code>next</code>, é€šå¸¸ç”¨æ¥é¢„é˜²ç”¨æˆ·åœ¨è¿˜æœªä¿å­˜ä¿®æ”¹å‰çªç„¶ç¦»å¼€, å¯ä»¥é€šè¿‡è¿”å›<code>false</code>æ¥å–æ¶ˆç¦»å¼€</p></li></ul></li><li><p>å®Œæ•´çš„å¯¼èˆªè§£ææµç¨‹</p><ul><li>å¯¼èˆªè¢«è§¦å‘</li><li>å¤±æ´»ç»„ä»¶é‡Œè°ƒç”¨<code>beforeRouteLeave</code></li><li>è°ƒç”¨å…¨å±€<code>beforeEach</code></li><li>åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨<code>beforeRouteUpdate</code></li><li>åœ¨è·¯ç”±é…ç½®é‡Œè°ƒç”¨<code>BeforeEnter</code></li><li>è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶</li><li>åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨<code>beforeRouteEnter</code></li><li>è°ƒç”¨å…¨å±€çš„<code>beforeResolve</code></li><li>å¯¼èˆªè¢«ç¡®è®¤</li><li>è°ƒç”¨å…¨å±€çš„<code>afterEach</code></li><li>è§¦å‘<code>DOM</code>æ›´æ–°</li><li>è°ƒç”¨<code>beforeRouteEnter</code>, åˆ›å»ºå¥½çš„ç»„ä»¶å®ä¾‹ä¼šä¸ºä½œä¸ºå›è°ƒå‡½æ•°<code>next</code>çš„å‚æ•°ä¼ å…¥</li></ul></li></ol><h4 id="æ•°æ®è·å–"><a class="markdownIt-Anchor" href="#æ•°æ®è·å–"></a> æ•°æ®è·å–</h4><p>æŸäº›æƒ…å†µä¸‹éœ€è¦æ ¹æ®è·¯ç”±çš„å‚æ•°æ¥ä»æœåŠ¡ä¸­è·å–ç›¸å…³æ•°æ®, å®ç°æ–¹å¼æœ‰ä¸¤ç§:</p><ol><li><p>å¯¼èˆªå®Œæˆä¹‹åè·å–</p><p>é€šå¸¸æ˜¯åœ¨ç»„ä»¶çš„å£°æ˜å‘¨æœŸé’©å­å‡½æ•°ä¸­å®Œæˆçš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line"><span class="keyword">const</span> id = route.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getData</span>(id);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> route.<span class="property">params</span>,</span><br><span class="line">    <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> id = router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getData</span>();</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p>å¯¼èˆªå®Œæˆä¹‹å‰è·å–</p><p>é€šå¸¸æ˜¯ç»„ä»¶å†…å®ˆå«ä¸­å®Œæˆçš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onBeforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = to.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="title function_">getData</span>(id).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>(<span class="function"><span class="params">vm</span> =&gt;</span> vm.<span class="title function_">setData</span>(res));</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> comData = <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    comData.<span class="property">value</span> = data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="ç»„åˆå¼api"><a class="markdownIt-Anchor" href="#ç»„åˆå¼api"></a> ç»„åˆå¼<code>API</code></h4><p>åœ¨<code>setup</code>ä¸­ä½¿ç”¨è·¯ç”±çš„ç»„åˆå¼<code>API</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useRoute, useRouter, onBeforeRouteUpdate &#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>();</span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">onBeforeRouteUpdate</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« : <a href="https://router.vuejs.org/zh/guide/advanced/composition-api.html">https://router.vuejs.org/zh/guide/advanced/composition-api.html</a></p><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>æ·»åŠ <code>element-plus</code>çš„<code>icon</code>ä¸ç”Ÿæ•ˆ</p><p>æ­¤å¤„æŒ‡çš„ä¸ç”Ÿæ•ˆæ˜¯æŒ‡: 1. ä½¿ç”¨è‡ªåŠ¨å¯¼å…¥çš„æ–¹å¼; 2. æ·»åŠ <code>element-plus</code>ç»„ä»¶å, ç»„ä»¶ç”Ÿæ•ˆ; 3. æ·»åŠ <code>icon</code>åº“å, å¹¶è¿›è¡Œçš„è‡ªåŠ¨å¯¼å…¥é…ç½®. å¦‚ä¸‹</p><blockquote><ol><li><p><code>element-plus</code>ç»„ä»¶åº“è‡ªåŠ¨å¯¼å…¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pnpm add element-plus</span><br><span class="line">$ pnpm add --save-dev unplugin-vue-components unplugin-auto-import</span><br></pre></td></tr></table></figure></li><li><p><code>element-plus</code>ç»„ä»¶åº“é…ç½®</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AutoImport</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-auto-import/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Components</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ElementPlusResolver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/resolvers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">      <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title class_">Components</span>(&#123;</span><br><span class="line">      <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ <code>element-plus</code>çš„<code>icon</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pnpm add @element-plus/icons-vue</span><br><span class="line">$ pnpm add --save-dev unplugin-icons unplugin-auto-import</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ <code>element-plus</code>çš„<code>icon</code>é…ç½®</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;resolve&#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Icons</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-icons/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IconsResolver</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-icons/resolver&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AutoImport</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-auto-import/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Components</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ElementPlusResolver</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/resolvers&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Inspect</span> <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-inspect&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pathSrc = <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: pathSrc,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title class_">Vue</span>(),</span><br><span class="line">    <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">      <span class="comment">// Auto import functions from Vue, e.g. ref, reactive, toRef...</span></span><br><span class="line">      <span class="comment">// è‡ªåŠ¨å¯¼å…¥ Vue ç›¸å…³å‡½æ•°ï¼Œå¦‚ï¼šref, reactive, toRef ç­‰</span></span><br><span class="line">      <span class="attr">imports</span>: [<span class="string">&#x27;vue&#x27;</span>],</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Auto import functions from Element Plus, e.g. ElMessage, ElMessageBox... (with style)</span></span><br><span class="line">      <span class="comment">// è‡ªåŠ¨å¯¼å…¥ Element Plus ç›¸å…³å‡½æ•°ï¼Œå¦‚ï¼šElMessage, ElMessageBox... (å¸¦æ ·å¼)</span></span><br><span class="line">      <span class="attr">resolvers</span>: [</span><br><span class="line">        <span class="title class_">ElementPlusResolver</span>(),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Auto import icon components</span></span><br><span class="line">        <span class="comment">// è‡ªåŠ¨å¯¼å…¥å›¾æ ‡ç»„ä»¶</span></span><br><span class="line">        <span class="title class_">IconsResolver</span>(&#123;</span><br><span class="line">          <span class="attr">prefix</span>: <span class="string">&#x27;Icon&#x27;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="attr">dts</span>: <span class="title function_">resolve</span>(pathSrc, <span class="string">&#x27;auto-imports.d.ts&#x27;</span>),</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Components</span>(&#123;</span><br><span class="line">      <span class="attr">resolvers</span>: [</span><br><span class="line">        <span class="comment">// Auto register icon components</span></span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æ³¨å†Œå›¾æ ‡ç»„ä»¶</span></span><br><span class="line">        <span class="title class_">IconsResolver</span>(&#123;</span><br><span class="line">          <span class="attr">enabledCollections</span>: [<span class="string">&#x27;ep&#x27;</span>],</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="comment">// Auto register Element Plus components</span></span><br><span class="line">        <span class="comment">// è‡ªåŠ¨å¯¼å…¥ Element Plus ç»„ä»¶</span></span><br><span class="line">        <span class="title class_">ElementPlusResolver</span>(),</span><br><span class="line">      ],</span><br><span class="line"></span><br><span class="line">      <span class="attr">dts</span>: <span class="title function_">resolve</span>(pathSrc, <span class="string">&#x27;components.d.ts&#x27;</span>),</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Icons</span>(&#123;</span><br><span class="line">      <span class="attr">autoInstall</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;),</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Inspect</span>(),</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ol></blockquote><p>é—®é¢˜åŸå› : è¿›è¡Œå¦‚ä¸Šé…ç½®å, ä»ç„¶ä¸ç”Ÿæ•ˆ, å¤§æ¦‚ç‡æ˜¯æ ‡ç­¾ä½¿ç”¨æ–¹å¼é—®é¢˜. è¿™ä¸ªåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ²¡æœ‰å†™, å¾ˆ***CD***</p><p>è§£å†³æ–¹æ¡ˆ: ä¿®æ”¹<code>icon</code>æ ‡ç­¾çš„å‘½å, æ¯”å¦‚å®˜æ–¹æ–‡æ¡£ä¸­å¤åˆ¶å‡ºçš„<code>icon</code>æ ‡ç­¾ä¸º<code>&lt;Edit/&gt;</code>, åˆ™åœ¨ä½¿ç”¨æ—¶ä¿®æ”¹ä¸º<code>&lt;i-ep-edit/&gt;</code>æˆ–è€…<IconEpEdit/>, è¿™ä¸ªå¯ä»¥åœ¨å®˜æ–¹ç½‘ç«™çš„å‚è€ƒæ¨¡æ¿ä¸­çœ‹åˆ°</p><p><img src="element-plus-icon%E5%8F%82%E8%80%83%E6%A8%A1%E6%9D%BF%E5%85%A5%E5%8F%A3.png" alt="element-plus-iconå‚è€ƒæ¨¡æ¿å…¥å£" /></p><p><img src="element-plus-icon%E5%8F%82%E8%80%83%E9%85%8D%E7%BD%AE.png" alt="element-plus-iconå‚è€ƒé…ç½®" /></p><p><img src="element-plus-icon%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF.png" alt="element-plus-iconä½¿ç”¨æ¨¡æ¿" /></p>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue-router </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Typescriptç³»åˆ—(äºŒ)---é«˜çº§</title>
      <link href="/2024/01/04/ts/TypeScript%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E9%AB%98%E7%BA%A7/"/>
      <url>/2024/01/04/ts/TypeScript%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E9%AB%98%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰é¢ä»‹ç»äº†<code>typescript</code>åŸºæœ¬çš„æ•°æ®ç±»å‹å’Œä½¿ç”¨, æœ¬ç¯‡ä»‹ç»å…¶é«˜çº§ç±»å‹å’Œä½¿ç”¨, æœ¬ç¯‡ç»“æŸå, ç”±äºå­¦ä¹ å†…å®¹åŸºæœ¬æ»¡è¶³é¡¹ç›®ä½¿ç”¨, æ‰€ä»¥æœ¬ç³»åˆ—å°†æš‚åœä¸€æ®µæ—¶é—´, ç€æ‰‹å»æå‰ç«¯é¡¹ç›®</p><h3 id="äº¤å‰ç±»å‹"><a class="markdownIt-Anchor" href="#äº¤å‰ç±»å‹"></a> äº¤å‰ç±»å‹</h3><p>äº¤å‰ç±»å‹æ˜¯å°†å¤šä¸ªç±»å‹åˆå¹¶ä¸ºä¸€ä¸ªç±»å‹</p><p>ä½¿ç”¨<code>&amp;</code>ç¬¦å·å°†å¤šä¸ªç±»å‹åˆå¹¶, åˆå¹¶ä¹‹åè¡¨ç¤ºè¿™ä¸ªç±»å‹çš„å¯¹è±¡åŒæ—¶æ‹¥æœ‰å¤šç§ç±»å‹çš„æˆå‘˜</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> extend&lt;T, U&gt;(<span class="attr">first</span>: T, <span class="attr">second</span>: U): T &amp; U &#123;</span><br><span class="line">    <span class="keyword">let</span> result = &lt;T &amp; U&gt;&#123;&#125;;</span><br><span class="line">    for (let id in first) &#123;</span><br><span class="line">        (&lt;any&gt;result)[id] = (&lt;any&gt;first)[id];</span><br><span class="line">    &#125;</span><br><span class="line">    for (let id in second) &#123;</span><br><span class="line">        if (!result.hasOwnProperty(id)) &#123;</span><br><span class="line">            (&lt;any&gt;result)[id] = (&lt;any&gt;second)[id];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Person &#123;</span><br><span class="line">    constructor(public name: string) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line">interface Loggable &#123;</span><br><span class="line">    log(): void;</span><br><span class="line">&#125;</span><br><span class="line">class ConsoleLogger implements Loggable &#123;</span><br><span class="line">    log() &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var jim = extend(new Person(&quot;Jim&quot;), new ConsoleLogger());</span><br><span class="line">var n = jim.name;</span><br><span class="line">jim.log();</span><br></pre></td></tr></table></figure><h3 id="è”åˆç±»å‹"><a class="markdownIt-Anchor" href="#è”åˆç±»å‹"></a> è”åˆç±»å‹</h3><p>è”åˆç±»å‹æ˜¯å°†å¤šä¸ªç±»å‹è”åˆèµ·æ¥, è¡¨ç¤ºä¸€ä¸ªå€¼å¯ä»¥æ˜¯è”åˆçš„å¤šç§ç±»å‹ä¸­çš„ä¸€ç§ç±»å‹çš„å®ä¾‹</p><p>ä½¿ç”¨<code>|</code>ç¬¦å·å°†å¤šä¸ªç±»å‹è”åˆ, å¦‚æœä¸€ä¸ªå€¼æ—¶è”åˆç±»å‹, åˆ™åªèƒ½è®¿é—®æ­¤è”åˆç±»å‹çš„å¤šæœ‰ç±»å‹é‡Œçš„å…±æœ‰æˆå‘˜</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Bird</span> &#123;</span><br><span class="line">    <span class="title function_">fly</span>();</span><br><span class="line">    <span class="title function_">layEggs</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Fish</span> &#123;</span><br><span class="line">    <span class="title function_">swim</span>();</span><br><span class="line">    <span class="title function_">layEggs</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getSmallPet</span>(<span class="params"></span>): <span class="title class_">Fish</span> | <span class="title class_">Bird</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pet = <span class="title function_">getSmallPet</span>();</span><br><span class="line">pet.<span class="title function_">layEggs</span>(); <span class="comment">// okay</span></span><br><span class="line">pet.<span class="title function_">swim</span>();    <span class="comment">// errors</span></span><br></pre></td></tr></table></figure><h3 id="ç±»å‹ä¿æŠ¤ä¸åŒºåˆ†ç±»å‹"><a class="markdownIt-Anchor" href="#ç±»å‹ä¿æŠ¤ä¸åŒºåˆ†ç±»å‹"></a> ç±»å‹ä¿æŠ¤ä¸åŒºåˆ†ç±»å‹</h3><h4 id="ç±»å‹ä¿æŠ¤"><a class="markdownIt-Anchor" href="#ç±»å‹ä¿æŠ¤"></a> ç±»å‹ä¿æŠ¤</h4><p>å½“æƒ³è¦ç¡®åˆ‡çš„çŸ¥é“æŸä¸ªå®ä¾‹æ—¶ä½•ç§ç±»å‹æ—¶, é€šå¸¸æ˜¯é€šè¿‡æ£€æŸ¥æˆå‘˜æ˜¯å¦å­˜åœ¨è¿›è¡ŒåŒºåˆ†</p><p>åŸºäºä»¥ä¸Š, å¯ä»¥ä½¿ç”¨ç±»å‹æ–­è¨€æ¥å®ç°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pet = <span class="title function_">getSmallPet</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((&lt;<span class="title class_">Fish</span>&gt;pet).<span class="property">swim</span>) &#123;</span><br><span class="line">    (&lt;<span class="title class_">Fish</span>&gt;pet).<span class="title function_">swim</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    (&lt;<span class="title class_">Bird</span>&gt;pet).<span class="title function_">fly</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰ç±»å‹ä¿æŠ¤"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰ç±»å‹ä¿æŠ¤"></a> è‡ªå®šä¹‰ç±»å‹ä¿æŠ¤</h4><p>è¦å®šä¹‰ä¸€ä¸ªç±»å‹ä¿æŠ¤, åªè¦å®šä¹‰ä¸€ä¸ªå‡½æ•°, å®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ª<em>ç±»å‹è°“è¯</em></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isFish</span>(<span class="params"><span class="attr">pet</span>: <span class="title class_">Fish</span> | <span class="title class_">Bird</span></span>): pet is <span class="title class_">Fish</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (&lt;<span class="title class_">Fish</span>&gt;pet).<span class="property">swim</span> !== <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Š, <code>pet is Fish</code>å°±æ˜¯ç±»å‹è°“è¯, å½¢å¼ä¸º: <code>paramName is Type</code>, <code>paramName</code>å¿…é¡»æ˜¯æ¥è‡ªäºå½“å‰å‡½æ•°ç­¾åçš„ä¸€ä¸ªå‚æ•°å, <code>Type</code>æ˜¯æŸä¸ªè”åˆç±»å‹çš„ä¸€ç§ç±»å‹</p><p>æ¯å½“ä½¿ç”¨ä¸€äº›å˜é‡è°ƒç”¨ç±»å‹è°“è¯çš„å‡½æ•°æ—¶, å°±ä¼šå°†å˜é‡ç¼©å‡ä¸ºé‚£ä¸ªå…·ä½“çš„ç±»å‹, åªè¦è¿™ä¸ªç±»å‹ä¸å˜é‡çš„åŸå§‹ç±»å‹å…¼å®¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x27;swim&#x27; å’Œ &#x27;fly&#x27; è°ƒç”¨éƒ½æ²¡æœ‰é—®é¢˜äº†</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isFish</span>(pet)) &#123;</span><br><span class="line">    pet.<span class="title function_">swim</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    pet.<span class="title function_">fly</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­, <code>typescript</code>ä¸ä»…çŸ¥é“<code>if</code>åˆ†æ”¯é‡Œ<code>pet</code>æ˜¯<code>Fish</code>ç±»å‹, è¿˜çŸ¥é“åœ¨<code>else</code>é‡Œä¸€å®šä¸æ˜¯<code>Fish</code>ç±»å‹</p><h4 id="typeofç±»å‹ä¿æŠ¤"><a class="markdownIt-Anchor" href="#typeofç±»å‹ä¿æŠ¤"></a> <code>typeof</code>ç±»å‹ä¿æŠ¤</h4><p><code>typescript</code>å¯ä»¥å°†<code>typeof x === 'number'</code>è¿™æ ·çš„è¡¨è¾¾å¼è¯†åˆ«ä¸ºä¸€ä¸ªç±»å‹ä¿æŠ¤, å³æ˜¯è¯´å¯ä»¥ç›´æ¥åœ¨ä»£ç é‡Œæ£€æŸ¥ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">padLeft</span>(<span class="params"><span class="attr">value</span>: <span class="built_in">string</span>, <span class="attr">padding</span>: <span class="built_in">string</span> | <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> padding === <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Array</span>(padding + <span class="number">1</span>).<span class="title function_">join</span>(<span class="string">&quot; &quot;</span>) + value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> padding === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> padding + value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Expected string or number, got &#x27;<span class="subst">$&#123;padding&#125;</span>&#x27;.`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯, è¿™äº›<code>typeof</code>ç±»å‹ä¿æŠ¤åªæœ‰ä¸¤ç§å½¢å¼èƒ½åˆ«è¯†åˆ«:</p><p><code>typeof v === 'typename'</code>å’Œ<code>typeof v !=== 'typename'</code>; <code>typename</code>å¿…é¡»æ˜¯<code>number</code>, <code>string</code>, <code>boolean</code>, <code>symbol</code>; å½“<code>typename</code>ä¸ºå…¶å®ƒç±»å‹æ—¶, <code>typescript</code>ä¸ä¼šé˜»æ­¢ä¸å…¶æ¯”è¾ƒ, ä½†ä¸ä¼šå°†å…¶è¯†åˆ«ä¸ºç±»å‹ä¿æŠ¤</p><h4 id="instanceofç±»å‹ä¿æŠ¤"><a class="markdownIt-Anchor" href="#instanceofç±»å‹ä¿æŠ¤"></a> <code>instanceof</code>ç±»å‹ä¿æŠ¤</h4><p><code>instanceof</code>ç±»å‹ä¿æŠ¤æ˜¯é€šè¿‡æ„é€ å‡½æ•°æ¥ç»†åŒ–ç±»å‹çš„ä¸€ç§æ–¹å¼</p><p><code>instanceof</code>çš„å·¦ä¾§è¦æ±‚æ˜¯ä¸€ä¸ªå®ä¾‹, å³ä¾§è¦æ±‚æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°, æ³¨æ„å³ä¾§è¦æ±‚æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°, æ‰€ä»¥<code>instanceof</code>åªèƒ½åˆ¤æ–­æ˜¯å¦æ˜¯æŸä¸ªç±»çš„ç±»å‹, ä¸èƒ½åˆ¤æ–­æ˜¯å¦æ˜¯æŸä¸ªæ¥å£ç±»å‹, å› ä¸ºæ¥å£æ²¡æœ‰æ„é€ å‡½æ•°</p><blockquote><p><code>typescript</code>åœ¨è¿›è¡Œ<code>instanceof</code>åˆ¤æ–­æ—¶ä¼šç»†åŒ–æ„é€ å‡½æ•°ä¸º:</p><ul><li>æ­¤æ„é€ å‡½æ•°çš„<code>prototype</code>å±æ€§çš„ç±»å‹, å¦‚æœå®ƒçš„ç±»å‹ä¸ä¸º<code>any</code>çš„è¯</li><li>æ„é€ ç­¾åæ‰€è¿”å›çš„ç±»å‹çš„è”åˆ</li></ul></blockquote><h4 id="nullå’Œundefined"><a class="markdownIt-Anchor" href="#nullå’Œundefined"></a> <code>null</code>å’Œ<code>undefined</code></h4><p>ç”±äº<code>null</code>å’Œ<code>undefined</code>æ˜¯æ‰€æœ‰ç±»å‹çš„æœ‰æ•ˆå€¼, æ‰€ä»¥æ— æ³•é˜»æ­¢å…¶èµ‹å€¼ç»™å…¶ä»–ç±»å‹çš„å˜é‡</p><p><code>--strictNullChecks</code>æ ‡è®°å¯ä»¥è§£å†³: å½“å£°æ˜ä¸€ä¸ªå˜é‡æ—¶, ä¸ä¼šè‡ªåŠ¨åŒ…å«<code>null</code>å’Œ<code>undefined</code>, ä½†å¯ä»¥ä½¿ç”¨è”åˆç±»å‹åŒ…å«å®ƒä»¬, ä»¥æ­¤æ¥è®²<code>null</code>å’Œ<code>undefined</code>åŒºåˆ«å¯¹å¾…</p><blockquote><p><code>null</code>å’Œ<code>undefined</code>çš„ç±»å‹ä¿æŠ¤:</p><ol><li>å¯ä»¥ç›´æ¥ä½¿ç”¨<code>==</code>åˆ¤æ–­, æˆ–è€…ä½¿ç”¨é€»è¾‘è¿ç®—åˆ¤æ–­</li><li>å¯ä»¥ä½¿ç”¨ç±»å‹æ–­è¨€æ‰‹åŠ¨å»é™¤, è¯­æ³•æ˜¯å˜é‡åæ·»åŠ <code>!</code>åç¼€</li></ol></blockquote><h3 id="ç±»å‹åˆ«å"><a class="markdownIt-Anchor" href="#ç±»å‹åˆ«å"></a> ç±»å‹åˆ«å</h3><h4 id="åŸºæœ¬ä½¿ç”¨"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä½¿ç”¨"></a> åŸºæœ¬ä½¿ç”¨</h4><p>ç±»å‹åˆ«åä¼šç»™ä¸€ä¸ªç±»å‹èµ·ä¸€ä¸ªæ–°åå­—, æ­¤ç±»å‹å¯ä»¥æ˜¯åŸå§‹å€¼, è”åˆç±»å‹, å…ƒç»„ä»¥åŠè‡ªå®šä¹‰ç±»å‹ç­‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Name</span> = <span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">NameResolver</span> = <span class="function">() =&gt;</span> <span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">NameOrResolver</span> = <span class="title class_">Name</span> | <span class="title class_">NameResolver</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getName</span>(<span class="params"><span class="attr">n</span>: <span class="title class_">NameOrResolver</span></span>): <span class="title class_">Name</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">n</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»å‹åˆ«åä¸ä¼šæ–°å»ºä¸€ä¸ªç±»å‹, åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°åå­—æ¥å¼•ç”¨é‚£ä¸ªç±»å‹</p><p>ç±»å‹åˆ«åä¹Ÿå¯ä»¥ä½¿ç”¨æ³›å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Tree</span>&lt;T&gt; = &#123;</span><br><span class="line">    <span class="attr">value</span>: T;</span><br><span class="line">    <span class="attr">left</span>: <span class="title class_">Tree</span>&lt;T&gt;;</span><br><span class="line">    <span class="attr">right</span>: <span class="title class_">Tree</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»å‹åˆ«åä¸èƒ½å‡ºç°åœ¨å£°æ˜å³ä¾§çš„ä»»ä½•åœ°æ–¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Yikes</span> = <span class="title class_">Array</span>&lt;<span class="title class_">Yikes</span>&gt;; <span class="comment">// error</span></span><br></pre></td></tr></table></figure><blockquote><p>æ¥å£ä¸ç±»å‹åˆ«åçš„åŒºåˆ«:</p><ol><li>æ¥å£åˆ›å»ºä¸€ä¸ªæ–°åå­—, ç±»å‹åˆ«åå¹¶ä¸åˆ›å»ºæ–°åå­—</li><li>æ¥å£å¯ä»¥è¢«ç»§æ‰¿å®ç°, ç±»å‹åˆ«åä¸å¯ä»¥</li><li>å¦‚æœæ— æ³•é€šè¿‡æ¥å£æ¥æè¿°ä¸€ä¸ªç±»å‹, å¹¶ä¸”éœ€è¦ä½¿ç”¨è”åˆç±»å‹æˆ–å…ƒç»„ç±»å‹, é€šå¸¸ä¼šä½¿ç”¨ç±»å‹åˆ«å</li></ol></blockquote><h4 id="ç‰¹æ®Šä½¿ç”¨"><a class="markdownIt-Anchor" href="#ç‰¹æ®Šä½¿ç”¨"></a> ç‰¹æ®Šä½¿ç”¨</h4><p>å­—ç¬¦ä¸²å­—é¢é‡ç±»å‹å…è®¸æŒ‡å®šå­—ç¬¦ä¸²å¿…é¡»å¾—å›ºå®šå€¼. å­—ç¬¦ä¸²å­—é¢é‡ç±»å‹å¯ä»¥ä¸è”åˆç±»å‹, ç±»å‹ä¿æŠ¤å’Œç±»å‹åˆ«åé…åˆ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Easing</span> = <span class="string">&quot;ease-in&quot;</span> | <span class="string">&quot;ease-out&quot;</span> | <span class="string">&quot;ease-in-out&quot;</span>;</span><br></pre></td></tr></table></figure><p>å½“ä½¿ç”¨ä¸Šè¿°ç±»å‹åˆ«åä½œä¸ºå‚æ•°æˆ–å±æ€§çš„ç±»å‹æ—¶, åˆ™å€¼å¿…é¡»æ˜¯å…è®¸çš„ä¸‰ä¸ªå­—ç¬¦ä¸²ä¹‹ä¸€, å¦åˆ™ä¼šäº§ç”Ÿé”™è¯¯</p><p>åŒå­—ç¬¦ä¸²å­—é¢é‡ç±»å‹ä¸€æ ·, æ•°å­—å­—é¢é‡ç±»å‹å’Œæšä¸¾æˆå‘˜ç±»å‹ä¹Ÿå¯ä»¥å¦‚æ­¤ä½¿ç”¨. è¿™æ˜¯å› ä¸ºç±»å‹åˆ«åæœ¬èº«å¯ä»¥ç”¨ä½œç±»å‹å®šä¹‰, è€Œå­—é¢é‡ç±»å‹æ–¹å¼ä¸è¿‡æ˜¯å°†å­—é¢é‡å€¼æœ¬èº«å®šä¹‰ä¸ºäº†ä¸€ç§è‡ªå®šä¹‰ç±»å‹</p><h3 id="å¯è¾¨è¯†è”åˆ"><a class="markdownIt-Anchor" href="#å¯è¾¨è¯†è”åˆ"></a> å¯è¾¨è¯†è”åˆ</h3><h4 id="åŸºæœ¬ä½¿ç”¨-2"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä½¿ç”¨-2"></a> åŸºæœ¬ä½¿ç”¨</h4><p>åˆå¹¶å•ä¾‹ç±»å‹, è”åˆç±»å‹, ç±»å‹ä¿æŠ¤å’Œç±»å‹åˆ«åæ¥åˆ›å»ºå¯è¾¨è¯†è”åˆçš„é«˜çº§æ¨¡å¼, ä¹Ÿç§°ä½œæ ‡ç­¾è”åˆæˆ–ä»£æ•°æ•°æ®ç±»å‹</p><blockquote><p>ä¸‰è¦ç´ :</p><ol><li>å…·æœ‰æ™®é€šçš„å•ä¾‹ç±»å‹å±æ€§-å¯è¾¨è¯†çš„ç‰¹å¾</li><li>ä¸€ä¸ªç±»å‹åˆ«ååŒ…å«äº†é‚£äº›ç±»å‹çš„è”åˆ-è”åˆ</li><li>æ­¤å±æ€§ä¸Šçš„ç±»å‹ä¿æŠ¤</li></ol></blockquote><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¦è”åˆçš„æ¥å£, kindä½œä¸ºå¯è¾¨è¯†ç‰¹å¾</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Square</span> &#123;</span><br><span class="line">    <span class="attr">kind</span>: <span class="string">&quot;square&quot;</span>;</span><br><span class="line">    <span class="attr">size</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="attr">kind</span>: <span class="string">&quot;rectangle&quot;</span>;</span><br><span class="line">    <span class="attr">width</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="attr">height</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Circle</span> &#123;</span><br><span class="line">    <span class="attr">kind</span>: <span class="string">&quot;circle&quot;</span>;</span><br><span class="line">    <span class="attr">radius</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è”åˆ</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Shape</span> = <span class="title class_">Square</span> | <span class="title class_">Rectangle</span> | <span class="title class_">Circle</span>;</span><br><span class="line"><span class="comment">// å¯è¾¨è¯†è”åˆ</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">area</span>(<span class="params"><span class="attr">s</span>: <span class="title class_">Shape</span></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (s.<span class="property">kind</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;square&quot;</span>: <span class="keyword">return</span> s.<span class="property">size</span> * s.<span class="property">size</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;rectangle&quot;</span>: <span class="keyword">return</span> s.<span class="property">height</span> * s.<span class="property">width</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;circle&quot;</span>: <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span> * s.<span class="property">radius</span> ** <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸­é¦–å…ˆå£°æ˜äº†è¦è”åˆçš„æ¥å£, æ¯ä¸ªæ¥å£éƒ½æœ‰<code>kind</code>å±æ€§ä½†æœ‰ä¸åŒçš„å­—ç¬¦ä¸²å­—é¢é‡ç±»å‹. <code>kind</code>å±æ€§ç§°ä½œ<em>å¯è¾¨è¯†çš„ç‰¹å¾</em>æˆ–æ ‡ç­¾. å…¶ä»–å±æ€§åˆ™ç‰¹å®šäºå„ä¸ªæ¥å£</p><h4 id="å®Œæ•´æ€§æ£€æŸ¥"><a class="markdownIt-Anchor" href="#å®Œæ•´æ€§æ£€æŸ¥"></a> å®Œæ•´æ€§æ£€æŸ¥</h4><p>å½“æ²¡æœ‰æ¶µç›–æ‰€æœ‰å¯è¾¨è¯†è”åˆçš„å˜åŒ–æ—¶, å¸Œæœ›ç¼–è¯‘å™¨å¯ä»¥é€šçŸ¥</p><ol><li><p>å¯ç”¨<code>--strictNullChecks</code>å¹¶æŒ‡å®šä¸€ä¸ªè¿”å›å€¼ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">area</span>(<span class="params"><span class="attr">s</span>: <span class="title class_">Shape</span></span>): <span class="built_in">number</span> &#123; <span class="comment">// error: returns number | undefined</span></span><br><span class="line">    <span class="keyword">switch</span> (s.<span class="property">kind</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;square&quot;</span>: <span class="keyword">return</span> s.<span class="property">size</span> * s.<span class="property">size</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;rectangle&quot;</span>: <span class="keyword">return</span> s.<span class="property">height</span> * s.<span class="property">width</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;circle&quot;</span>: <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span> * s.<span class="property">radius</span> ** <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨<code>never</code>ç±»å‹, ç¼–è¯‘å™¨ç”¨å®ƒè¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">assertNever</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">never</span></span>): <span class="built_in">never</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Unexpected object: &quot;</span> + x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">area</span>(<span class="params"><span class="attr">s</span>: <span class="title class_">Shape</span></span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (s.<span class="property">kind</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;square&quot;</span>: <span class="keyword">return</span> s.<span class="property">size</span> * s.<span class="property">size</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;rectangle&quot;</span>: <span class="keyword">return</span> s.<span class="property">height</span> * s.<span class="property">width</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;circle&quot;</span>: <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="property">PI</span> * s.<span class="property">radius</span> ** <span class="number">2</span>;</span><br><span class="line">        <span class="attr">default</span>: <span class="keyword">return</span> <span class="title function_">assertNever</span>(s); <span class="comment">// error here if there are missing cases</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="å¤šæ€çš„thisç±»å‹"><a class="markdownIt-Anchor" href="#å¤šæ€çš„thisç±»å‹"></a> å¤šæ€çš„<code>this</code>ç±»å‹</h3><p>å¤šæ€çš„<code>this</code>ç±»å‹è¡¨ç¤ºçš„æ˜¯æŸä¸ªåŒ…å«ç±»æˆ–æ¥å£çš„å­ç±»å‹, è¿™æ¯ç§°ä½œ<code>F-bounded</code>å¤šæ€æ€§. å®ƒå¾ˆå®¹æ˜“çš„è¡¨ç°è¿è´¯æ¥å£é—´çš„ç»§æ‰¿</p><p>åœ¨ä½¿ç”¨è¡¨ç°ä¸Šå³æ˜¯åœ¨å‡½æ•°å®šä¹‰ä¸­, æœ€ç»ˆå°†å½“å‰å®ä¾‹(<code>this</code>)è¿”å›, å¹¶å°†å‡½æ•°çš„è¿”å›å€¼ç±»å‹å®šä¹‰ä¸º<code>this</code>(ç§°ä¸º<code>this</code>ç±»å‹)</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BasicCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params"><span class="keyword">protected</span> <span class="attr">value</span>: <span class="built_in">number</span> = <span class="number">0</span></span>) &#123; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">currentValue</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">add</span>(<span class="attr">operand</span>: <span class="built_in">number</span>): <span class="variable language_">this</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> += operand;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">multiply</span>(<span class="attr">operand</span>: <span class="built_in">number</span>): <span class="variable language_">this</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> *= operand;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... other operations go here ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> v = <span class="keyword">new</span> <span class="title class_">BasicCalculator</span>(<span class="number">2</span>)</span><br><span class="line">            .<span class="title function_">multiply</span>(<span class="number">5</span>)</span><br><span class="line">            .<span class="title function_">add</span>(<span class="number">1</span>)</span><br><span class="line">            .<span class="title function_">currentValue</span>();</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªç±»ä½¿ç”¨äº†<code>this</code>ç±»å‹ï¼Œä½ å¯ä»¥ç»§æ‰¿å®ƒï¼Œæ–°çš„ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•ï¼Œä¸éœ€è¦åšä»»ä½•çš„æ”¹å˜ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ScientificCalculator</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BasicCalculator</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">constructor</span>(<span class="params">value = <span class="number">0</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">sin</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = <span class="title class_">Math</span>.<span class="title function_">sin</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... other operations go here ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> v = <span class="keyword">new</span> <span class="title class_">ScientificCalculator</span>(<span class="number">2</span>)</span><br><span class="line">        .<span class="title function_">multiply</span>(<span class="number">5</span>)</span><br><span class="line">        .<span class="title function_">sin</span>()</span><br><span class="line">        .<span class="title function_">add</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_">currentValue</span>();</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯, ä¸<code>java</code>ä¸åŒ, åœ¨å®ä¾‹è°ƒç”¨è¿”å›<code>this</code>ç±»å‹çš„å‡½æ•°æ—¶, å…¶ç»“æœæ˜¯<code>this</code>è¡¨ç¤ºçš„å®ä¾‹ç±»å‹, å³å®ä¾‹ä¸ºå“ªç§ç±»å‹, åˆ™<code>this</code>ç±»å‹å³ä¸ºå“ªç§ç±»å‹</p><h3 id="ç´¢å¼•ç±»å‹"><a class="markdownIt-Anchor" href="#ç´¢å¼•ç±»å‹"></a> ç´¢å¼•ç±»å‹</h3><p>ä½¿ç”¨ç´¢å¼•ç±»å‹, ç¼–è¯‘å™¨å°±èƒ½å¤Ÿæ£€æŸ¥ä½¿ç”¨äº†åŠ¨æ€å±æ€§åçš„ä»£ç </p><p>é€šè¿‡<em>ç´¢å¼•ç±»å‹æŸ¥è¯¢æ“ä½œç¬¦</em>å’Œ<em>ç´¢å¼•è®¿é—®æ“ä½œç¬¦</em>:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> pluck&lt;T, K <span class="keyword">extends</span> keyof T&gt;(<span class="attr">o</span>: T, <span class="attr">names</span>: K[]): T[K][] &#123;</span><br><span class="line">  <span class="keyword">return</span> names.<span class="title function_">map</span>(<span class="function"><span class="params">n</span> =&gt;</span> o[n]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">person</span>: <span class="title class_">Person</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jarid&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">35</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">strings</span>: <span class="built_in">string</span>[] = <span class="title function_">pluck</span>(person, [<span class="string">&#x27;name&#x27;</span>]); <span class="comment">// ok, string[]</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šæ£€æŸ¥<code>name</code>æ˜¯å¦çœŸçš„æ˜¯<code>Person</code>çš„ä¸€ä¸ªå±æ€§</p><p><code>keyof T</code>ï¼Œ<strong>ç´¢å¼•ç±»å‹æŸ¥è¯¢æ“ä½œç¬¦</strong>. å¯¹äºä»»ä½•ç±»å‹<code>T</code>ï¼Œ<code>keyof T</code>çš„ç»“æœä¸º<code>T</code>ä¸Šå·²çŸ¥çš„å…¬å…±å±æ€§åçš„è”åˆ</p><p><code>T[K]</code>ï¼Œ<strong>ç´¢å¼•è®¿é—®æ“ä½œç¬¦</strong>. ç±»å‹è¯­æ³•ååº”è¡¨è¾¾å¼è¯­æ³•, ç±»ä¼¼ä¸ä¸€ç§æ³›å‹, ä½†åœ¨è·å–åˆ°å®é™…å€¼æ—¶, è¿”å›å®é™…å€¼çš„çœŸå®ç±»å‹</p><h3 id="æ˜ å°„ç±»å‹"><a class="markdownIt-Anchor" href="#æ˜ å°„ç±»å‹"></a> æ˜ å°„ç±»å‹</h3><p>ä»æ—§ç±»å‹ä¸­åˆ›å»ºæ–°ç±»å‹çš„ä¸€ç§æ–¹å¼-æ˜ å°„ç±»å‹. æ–°ç±»å‹ä»¥ç›¸åŒçš„å½¢å¼å»è½¬æ¢æ—§ç±»å‹é‡Œçš„æ¯ä¸ªå±æ€§</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Readonly</span>&lt;T&gt; = &#123;</span><br><span class="line">    <span class="keyword">readonly</span> [P <span class="keyword">in</span> keyof T]: T[P];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Partial</span>&lt;T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">PersonPartial</span> = <span class="title class_">Partial</span>&lt;<span class="title class_">Person</span>&gt;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ReadonlyPerson</span> = <span class="title class_">Readonly</span>&lt;<span class="title class_">Person</span>&gt;;</span><br></pre></td></tr></table></figure><p>é€šç”¨ç‰ˆæœ¬</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Nullable</span>&lt;T&gt; = &#123; [P <span class="keyword">in</span> keyof T]: T[P] | <span class="literal">null</span> &#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Partial</span>&lt;T&gt; = &#123; [P <span class="keyword">in</span> keyof T]?: T[P] &#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä»£ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Proxy</span>&lt;T&gt; = &#123;</span><br><span class="line">    <span class="title function_">get</span>(): T;</span><br><span class="line">    <span class="title function_">set</span>(<span class="attr">value</span>: T): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Proxify</span>&lt;T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> keyof T]: <span class="title class_">Proxy</span>&lt;T[P]&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> proxify&lt;T&gt;(<span class="attr">o</span>: T): <span class="title class_">Proxify</span>&lt;T&gt; &#123;</span><br><span class="line">   <span class="comment">// ... wrap proxies ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> proxyProps = <span class="title function_">proxify</span>(props);</span><br></pre></td></tr></table></figure><p><code>ts</code>æ ‡å‡†åº“</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Pick</span>&lt;T, K <span class="keyword">extends</span> keyof T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Record</span>&lt;K <span class="keyword">extends</span> <span class="built_in">string</span>, T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> K]: T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ˜ å°„ç±»å‹è¿›è¡Œæ¨æ–­</p><p>æ‹†åŒ…</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> unproxify&lt;T&gt;(<span class="attr">t</span>: <span class="title class_">Proxify</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">let</span> result = &#123;&#125; <span class="keyword">as</span> T;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> k <span class="keyword">in</span> t) &#123;</span><br><span class="line">        result[k] = t[k].<span class="title function_">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Typescript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typescript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NPMå’ŒPNPMçš„å®‰è£…åŠé…ç½®</title>
      <link href="/2023/12/26/node/npm%E5%92%8Cpnpm%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE/"/>
      <url>/2023/12/26/node/npm%E5%92%8Cpnpm%E5%AE%89%E8%A3%85%E5%8F%8A%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="npmé…ç½®"><a class="markdownIt-Anchor" href="#npmé…ç½®"></a> <code>NPM</code>é…ç½®</h3><h4 id="ä¿®æ”¹é…ç½®"><a class="markdownIt-Anchor" href="#ä¿®æ”¹é…ç½®"></a> ä¿®æ”¹é…ç½®</h4><p><code>npm</code>ä¼šä¼´éšç€<code>node</code>å®‰è£…, æ‰€ä»¥æ­¤å¤„ä»…ä»…è¡¨è¿°<code>npm</code>å¦‚ä½•é…ç½®</p><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config ls</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>npm</code>æœ‰å“ªäº›å¸¸ç”¨é…ç½®, å¯ä»¥è‡ªå·±å»ä¿®æ”¹é…ç½®</p><p>ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config get xxx</span><br></pre></td></tr></table></figure><p><code>xxx</code>ä¸ºé…ç½®å, å¯ä»¥æŸ¥çœ‹æŸä¸ªé…ç½®çš„ä¿¡æ¯</p><p>ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config set xxx yyy</span><br></pre></td></tr></table></figure><p><code>xxx</code>ä¸ºé…ç½®å,<code>yyy</code>ä¸ºé…ç½®å€¼</p><p>å»ºè®®è‡ªé…ç½®çš„æ–¹å¼:</p><p>æ­¥éª¤ä¸€:</p><p>ä½¿ç”¨å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config set globalconfig &quot;D:\software\nodejs\config\.npmrc&quot;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å…¨å±€é…ç½®çš„æŒ‡å‘æ–‡ä»¶</p><p>æˆ–è€…ç›´æ¥ä¿®æ”¹<code>C:\Users\&lt;user&gt;\.npmrc</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">globalconfig=D:\software\nodejs\config\.npmrc</span><br></pre></td></tr></table></figure><p>æ¥ä¿®æ”¹å…¨å±€é…ç½®çš„æŒ‡å‘æ–‡ä»¶</p><p>æ­¥éª¤äºŒ:</p><p>åˆ›å»ºå…¨å±€é…ç½®çš„æŒ‡å‘æ–‡ä»¶</p><p><img src="NPM%E4%BF%AE%E6%94%B9%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%8C%87%E5%90%91%E6%96%87%E4%BB%B6.png" alt="NPMä¿®æ”¹å…¨å±€é…ç½®æŒ‡å‘æ–‡ä»¶" /></p><p>æ­¥éª¤ä¸‰:</p><p>åœ¨è‡ªå·±åˆ›å»ºçš„å…¨å±€é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ä¿®æ”¹</p><p><img src="NPM%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9.png" alt="NPMå…¨å±€é…ç½®ä¿®æ”¹" /></p><h4 id="ç¯å¢ƒå˜é‡é…ç½®"><a class="markdownIt-Anchor" href="#ç¯å¢ƒå˜é‡é…ç½®"></a> ç¯å¢ƒå˜é‡é…ç½®</h4><ol><li><p><code>npm</code>çš„ç¯å¢ƒå˜é‡åœ¨<code>node</code>å®‰è£…æ—¶å³å¯é…ç½®</p></li><li><p><code>npm</code>å®‰è£…çš„ä¾èµ–ç¯å¢ƒå˜é‡</p><p><img src="NPM%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png" alt="NPMç¯å¢ƒå˜é‡é…ç½®" /></p></li><li><p>æ£€éªŒ</p><p>ä½¿ç”¨<code>npm</code>å‘½ä»¤å®‰è£…<code>typescript</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install typescript -g</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹<code>typescript</code>çš„å®‰è£…ä½ç½®</li><li>ä½¿ç”¨<code>tsc -v</code>æŸ¥çœ‹<code>tsc</code>å‘½ä»¤æ˜¯å¦å¯ç”¨</li></ul></li></ol><h3 id="pnpmå®‰è£…"><a class="markdownIt-Anchor" href="#pnpmå®‰è£…"></a> <code>PNPM</code>å®‰è£…</h3><p>ä½¿ç”¨<code>npm</code>å®‰è£…<code>pnpm</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pnpm</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>pnpm</code>å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p><p>æ³¨æ„: ç”±äºä½¿ç”¨<code>npm</code>å®‰è£…<code>pnpm</code>, <code>pnpm</code>ç›¸å…³çš„å‘½ä»¤æ˜¯åœ¨<code>npm</code>çš„å…¨å±€å®‰è£…ä½ç½®ä¸‹</p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>pnpm.exe</code>å®‰è£…<code>pnpm</code>, è¿™ä¸ªè‡ªè¡Œ<code>Bing</code>å§</p><h3 id="pnpmé…ç½®"><a class="markdownIt-Anchor" href="#pnpmé…ç½®"></a> <code>PNPM</code>é…ç½®</h3><h4 id="ä¿®æ”¹é…ç½®-2"><a class="markdownIt-Anchor" href="#ä¿®æ”¹é…ç½®-2"></a> ä¿®æ”¹é…ç½®</h4><p>ä¸Šé¢é…ç½®<code>npm</code>æ—¶ä½¿ç”¨äº†è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶, <code>pnpm</code>ä¹Ÿä¼šå…±ç”¨<code>npm</code>çš„é…ç½®, æ‰€ä»¥å¯¹<code>pnpm</code>è¿›è¡Œé…ç½®å¯ä»¥ç›´æ¥åœ¨è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®, ç›´æ¥æŒ‰ç…§<code>npm</code>é…ç½®ä¸­çš„æ­¥éª¤ä¸‰é…ç½®ä¸€ä¸‹ä¿¡æ¯</p><ul><li><strong><code>store-dir</code></strong></li><li><strong><code>cache-dir</code></strong></li><li><strong><code>global-bin-dir</code></strong></li><li><strong><code>state-dir</code></strong></li><li><strong><code>global-dir</code></strong></li></ul><p>å¦‚æœä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œé…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm config set xxx yyy</span><br></pre></td></tr></table></figure><p>ä¼šå°†é…ç½®ä¿¡æ¯é…ç½®åˆ°<code>C:\Users\&lt;User&gt;\AppData\Local\pnpm\config</code>ç›®å½•ä¸‹çš„<code>rc</code>æ–‡ä»¶ä¸­</p><p><img src="PNPM%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9.png" alt="PNPMå…¨å±€é…ç½®ä¿®æ”¹" /></p><p>æ­¤æ—¶å¯å°†<code>C:\Users\&lt;User&gt;\AppData\Local</code>ç›®å½•ä¸‹çš„<code>pnpm-state</code>å’Œ<code>pnpm-cache</code>ä»¥åŠ<code>C:\Users\&lt;User&gt;\AppData\Local\pnpm</code>ç›®å½•ä¸‹çš„<code>pnpm-store</code>å†…å®¹åˆ é™¤</p><h4 id="ç¯å¢ƒå˜é‡é…ç½®-2"><a class="markdownIt-Anchor" href="#ç¯å¢ƒå˜é‡é…ç½®-2"></a> ç¯å¢ƒå˜é‡é…ç½®</h4><p>ä¸<code>npm</code>çš„ç¯å¢ƒå˜é‡é…ç½®ä¸€æ ·</p><ol><li><p>ç”±äº<code>pnpm</code>ä½¿ç”¨<code>npm</code>å®‰è£…, æ‰€ä»¥<code>npm</code>å®‰è£…çš„ä¾èµ–çš„ç¯å¢ƒå˜é‡é…ç½®å¥½ä¹‹å, <code>pnpm</code>çš„ç¯å¢ƒå˜é‡å°±é…ç½®å¥½äº†</p></li><li><p><code>npm</code>å®‰è£…çš„ä¾èµ–ç¯å¢ƒå˜é‡</p><p><img src="PNPM%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png" alt="PNPMç¯å¢ƒå˜é‡é…ç½®" /></p></li><li><p>æ£€éªŒ</p><p>ä½¿ç”¨<code>pnpm</code>å‘½ä»¤å®‰è£…<code>@vue/cli</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @vue/cli</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹<code>@vue/cli</code>çš„å®‰è£…ä½ç½®</li><li>ä½¿ç”¨<code>vue -v</code>å‘½ä»¤æ˜¯å¦å¯ç”¨</li></ul></li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i>é—®é¢˜ä¸€</i></p><p>å‡ºç°é—®é¢˜:</p><p>åœ¨ä½¿ç”¨<code>pnpm</code>å®‰è£…<code>typescript</code>çš„è¿‡ç¨‹ä¸­, ä¿®æ”¹é…ç½®å, å®‰è£…åŒ…å§‹ç»ˆå®‰è£…åœ¨<code>C:\Users\&lt;User&gt;\node_modules</code>ä¸‹</p><p>é—®é¢˜åŸå› :</p><p><code>pnpm</code>æ²¡æœ‰æ·»åŠ <code>-g</code>å’Œ<code>-s</code>å‚æ•°æ—¶, ä¸ä¼šè‡ªåŠ¨è¯†åˆ«ä¸ºå…¨å±€å®‰è£…, æ‰€ä»¥å¦‚æœåœ¨ä»»æ„ä½ç½®ä½¿ç”¨<code>cmd</code>å‘½ä»¤å¼€å¯ç»ˆç«¯è¿›è¡Œå®‰è£…ä¾èµ–çš„æ“ä½œ, <code>pnpm</code>ä¼šè®¤ä¸ºåœ¨å½“å‰ç›®å½•ä¸‹å®‰è£…ä¾èµ–(å³ç»ˆç«¯ä¸­æ˜¾ç¤ºçš„ç›®å½•åœ°å€), æ‰€ä»¥å®‰è£…åœ¨äº†ç”¨æˆ·ç›®å½•ä¸‹</p><p>è§£å†³æ–¹æ¡ˆ: å…¨å±€å®‰è£…æ—¶æ·»åŠ <code>-g</code>å‘½ä»¤</p>]]></content>
      
      
      <categories>
          
          <category> node </category>
          
      </categories>
      
      
        <tags>
            
            <tag> node </tag>
            
            <tag> npm </tag>
            
            <tag> pnpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Typescriptç³»åˆ—(ä¸€)---åŸºç¡€</title>
      <link href="/2023/12/26/ts/TypeScript%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E7%A1%80/"/>
      <url>/2023/12/26/ts/TypeScript%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>æœ¬ç³»åˆ—æ˜¯<code>Vue</code>å‰ç«¯é¡¹ç›®çš„å‰ä¼ , ç”±äºæœ¬äººæ²¡æœ‰ç³»ç»Ÿå­¦ä¹ è¿‡<code>Typescript</code>, æ‰€ä»¥ä»æ­¤å¤„ä¸‹æ‰‹</p><p>æœ¬ç³»åˆ—æ˜¯ä¸€ä¸ªè¯­è¨€å­¦ä¹ ç³»åˆ—, æ‰€ä»¥è´¨é‡ä¸é«˜, åƒæ˜¯æµæ°´è´¦</p><p>æœ¬ç¯‡éœ€è¦ä½¿ç”¨<code>node</code>ç¯å¢ƒè¿è¡Œ<code>ts</code>è„šæœ¬, æœ¬äººä½¿ç”¨<code>pnpm</code>å®‰è£…äº†<code>ts</code></p><h3 id="åŸºç¡€ç±»å‹"><a class="markdownIt-Anchor" href="#åŸºç¡€ç±»å‹"></a> åŸºç¡€ç±»å‹</h3><h4 id="å¸ƒå°”"><a class="markdownIt-Anchor" href="#å¸ƒå°”"></a> å¸ƒå°”</h4><p>ç±»å‹ä¸º<code>boolean</code>, å€¼ä¸º<code>true/false</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">flag</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><h4 id="æ•°å­—"><a class="markdownIt-Anchor" href="#æ•°å­—"></a> æ•°å­—</h4><p>ç±»å‹ä¸º<code>number</code>, ä¸åŒºåˆ†æ•´æ•°å’Œæµ®ç‚¹æ•°, æ‰€æœ‰çš„æ•°éƒ½æ˜¯æµ®ç‚¹æ•°; æ”¯æŒäºŒè¿›åˆ¶, å…«è¿›åˆ¶, åè¿›åˆ¶, åå…­è¿›åˆ¶çš„å­—é¢é‡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">num1</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">num2</span>: <span class="built_in">number</span> = <span class="number">1.1</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">num3</span>: <span class="built_in">number</span> = <span class="number">0x6666</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">num4</span>: <span class="built_in">number</span> = <span class="number">0b1010</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">num5</span>: <span class="built_in">number</span> = <span class="number">0o333</span>;</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²"><a class="markdownIt-Anchor" href="#å­—ç¬¦ä¸²"></a> å­—ç¬¦ä¸²</h4><p>ç±»å‹ä¸º<code>string</code>, å¯ä»¥ä½¿ç”¨åŒå¼•å·(<strong>&quot;</strong>)å’Œå•å¼•å·(<strong>â€™</strong>)è¡¨ç¤º; ä¹Ÿå¯ä»¥é€šè¿‡åå¼•å·æ¥ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸², å¹¶ä»¥<code>$&#123;expr&#125;</code>çš„å½¢å¼åµŒå…¥è¡¨è¾¾å¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">hello</span>: <span class="built_in">string</span> = <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">world</span>: <span class="built_in">string</span> = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">all</span>: <span class="built_in">string</span> = <span class="string">`<span class="subst">$&#123;hello&#125;</span> <span class="subst">$&#123;world&#125;</span>`</span>; <span class="comment">// `$&#123;hello + &#x27; &#x27; + world&#125;`</span></span><br></pre></td></tr></table></figure><h4 id="æ•°ç»„"><a class="markdownIt-Anchor" href="#æ•°ç»„"></a> æ•°ç»„</h4><p>å®šä¹‰æ•°ç»„æœ‰ä¸¤ç§æ–¹å¼, ä¸€ç§ç›´æ¥åœ¨å…ƒç´ ç±»å‹åæ¥ä¸Š<code>[]</code>, å¦ä¸€ç§æ˜¯ä½¿ç”¨æ•°ç»„æ³›å‹<code>Array&lt;å…ƒç´ ç±»å‹&gt;</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>: <span class="built_in">string</span>[] = [<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="attr">ar</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = [<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;World&#x27;</span>];</span><br></pre></td></tr></table></figure><h4 id="å…ƒç»„tuple"><a class="markdownIt-Anchor" href="#å…ƒç»„tuple"></a> å…ƒç»„(<code>Tuple</code>)</h4><p>å…è®¸è¡¨ç¤ºä¸€ç»„å…ƒç´ æ•°é‡å’Œå¯¹åº”ç±»å‹å·²ç»ç¡®å®šçš„æ•°ç»„, å„ä¸ªå…ƒç´ çš„ç±»å‹ä¸å¿…ç›¸åŒ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">x</span>: [<span class="built_in">string</span>, <span class="built_in">number</span>] = [<span class="string">&#x27;hello&#x27;</span>, <span class="number">10</span>];</span><br></pre></td></tr></table></figure><p>å½“è®¿é—®ä¸€ä¸ªå·²çŸ¥ç´¢å¼•çš„å…ƒç´ , ä¼šå¾—åˆ°æ­£ç¡®çš„ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x[<span class="number">0</span>].<span class="title function_">substr</span>(<span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>å½“è®¿é—®ä¸€ä¸ªè¶Šç•Œçš„å…ƒç´ , ä¼šä½¿ç”¨è”åˆç±»å‹æ›¿ä»£</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x[<span class="number">3</span>] = <span class="string">&#x27;world&#x27;</span>; <span class="comment">// OK x[3]çš„å®šä¹‰ç±»å‹ä¸ºè”åˆç±»å‹ string | number</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x[<span class="number">4</span>] = <span class="literal">true</span>; <span class="comment">// ERROR x[4]çš„å®šä¹‰ç±»å‹ä¸ºè”åˆç±»å‹ string | number, booleanç±»å‹æ— æ³•èµ‹å€¼</span></span><br></pre></td></tr></table></figure><h4 id="æšä¸¾"><a class="markdownIt-Anchor" href="#æšä¸¾"></a> æšä¸¾</h4><p>å¯¹<code>js</code>çš„è¡¥å……, é»˜è®¤ä»<code>0</code>å¼€å§‹ä¸ºå…ƒç´ ç¼–å·</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;<span class="title class_">Red</span>, <span class="title class_">Green</span>, <span class="title class_">Blue</span>&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">c</span>: <span class="title class_">Color</span> = <span class="title class_">Color</span>.<span class="property">Red</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸­ä»é¦–ä¸ªå¼€å§‹, ä¸€æ¬¡ç¼–å·ä¸º<code>0,1,2</code></p><p>å¯ä»¥ä¹Ÿå¯ä»¥é€šè¿‡ç¼–å·è·å–åå­—</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">name</span>: <span class="built_in">string</span> = <span class="title class_">Color</span>[<span class="number">0</span>] <span class="comment">// Red</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæˆå‘˜çš„å€¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;<span class="title class_">Black</span>, <span class="title class_">Red</span> = <span class="number">1</span>, <span class="title class_">Green</span>, <span class="title class_">Blue</span> = <span class="number">4</span>, <span class="title class_">Yellow</span>&#125;</span><br></pre></td></tr></table></figure><p>æˆå‘˜ç¼–å·ä»<code>0</code>å¼€å§‹, æ¯é‡åˆ°ä¸€ä¸ªæ‰‹åŠ¨æŒ‡å®šç¼–å·çš„æˆå‘˜, ä¼šä»è¯¥ç¼–å·å¼€å§‹å‘åç»§ç»­, ä¸èƒ½å‡ºç°é‡å¤ç¼–å·</p><p><img src="%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B.png" alt="æšä¸¾ç±»å‹" /></p><p>å‘ç”Ÿç¼–å·é‡å¤æ—¶</p><p><img src="%E6%9E%9A%E4%B8%BE%E7%BC%96%E5%8F%B7%E9%87%8D%E5%A4%8D.png" alt="æšä¸¾ç¼–å·é‡å¤" /></p><h4 id="any"><a class="markdownIt-Anchor" href="#any"></a> <code>Any</code></h4><p>ä»»æ„å€¼, ä¸ºä¸æ¸…æ¥šç±»å‹çš„å˜é‡æŒ‡å®šä¸€ä¸ªç±»å‹, æ­¤ç±»å‹çš„å˜é‡ä¸ä¼šè¿›è¡Œç±»å‹æ£€æŸ¥, è€Œæ˜¯ç›´æ¥é€šè¿‡ç¼–è¯‘é˜¶æ®µ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">anyArr</span>: <span class="built_in">any</span>[] = [<span class="string">&#x27;xiaolin&#x27;</span>, <span class="number">18</span>, <span class="literal">true</span>];</span><br></pre></td></tr></table></figure><p>ä¸<code>Object</code>ç±»å‹å˜é‡çš„åŒºåˆ«æ˜¯, <code>Object</code>å˜é‡ä¸èƒ½è°ƒç”¨ä»»æ„æ–¹æ³•, å³ä½¿å®ƒçœŸçš„æœ‰è¿™äº›æ–¹æ³•</p><p><img src="any%E7%B1%BB%E5%9E%8B%E4%B8%8EObject%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8C%BA%E5%88%AB.png" alt="anyç±»å‹ä¸Objectç±»å‹çš„åŒºåˆ«" /></p><p>ä»æ„Ÿå®˜ä¸Šæ¥è®², <code>Object</code>æ˜¯å¯¹è±¡ç±»å‹çš„è¶…ç±», è€Œæ‰€æœ‰ç±»å‹éƒ½æ˜¯<code>Object</code>ç±»å‹çš„å­ç±»æˆ–è€…åŒ…è£…ç±», <code>Object</code>åªåŒ…å«è‡ªå®šä¹‰çš„æ–¹æ³•å’Œå‡½æ•°, å­ç±»å®šä¹‰çš„æ–¹æ³•å’Œå‡½æ•°æ— æ³•æ„ŸçŸ¥åˆ°; è€Œ<code>any</code>å¯ä»¥è®¤ä¸ºæ˜¯æ— æ ¡éªŒçš„<code>Object</code>ç±»å‹, å®ƒæ˜¯å¯¹è±¡ç±»å‹çš„è¶…ç±», ä½†ä¸åšä»»ä½•ç±»å‹ç›¸å…³æ ¡éªŒ</p><h4 id="void"><a class="markdownIt-Anchor" href="#void"></a> <code>Void</code></h4><p>ç©ºå€¼, è¡¨ç¤ºæ²¡æœ‰ä»»ä½•ç±»å‹, å‡½æ•°æ²¡æœ‰è¿”å›å€¼æ—¶, å…¶è¿”å›å€¼å°±æ˜¯<code>void</code></p><p><code>void</code>ç±»å‹çš„å˜é‡åªèƒ½èµ‹å€¼<code>null</code>å’Œ<code>undefined</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">v</span>: <span class="built_in">void</span> = <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">v</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="nullå’Œundefined"><a class="markdownIt-Anchor" href="#nullå’Œundefined"></a> <code>Null</code>å’Œ<code>Undefined</code></h4><p><code>null</code>å’Œ<code>undefined</code>éƒ½æœ‰è‡ªå·±çš„ç±»å‹, åªèƒ½èµ‹å€¼è‡ªèº«</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">u</span>: <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">n</span>: <span class="literal">null</span> = <span class="literal">null</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹, <code>null</code>å’Œ<code>undefined</code>æ˜¯æ‰€æœ‰ç±»å‹çš„å­ç±»</p><p>å½“æŒ‡å®šäº†<code>--strictNullChecks</code>æ ‡è®°, <code>null</code>å’Œ<code>undefined</code>åªèƒ½æ˜¾å¼çš„èµ‹å€¼ç»™å„è‡ªå’Œ<code>void</code>, å¦‚æœéœ€è¦æ˜¾å¼çš„å°†<code>null</code>å’Œ<code>undefined</code>èµ‹å€¼ç»™ä¸€ä¸ªç±»å‹å˜é‡, åˆ™è¯¥å˜é‡ç±»å‹å¯ä»¥ä½¿ç”¨è”åˆç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">nil</span>: <span class="built_in">string</span> = <span class="literal">null</span>; <span class="comment">// ç¼–è¯‘é”™è¯¯</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">str</span>: <span class="built_in">string</span> | <span class="literal">null</span> | <span class="literal">undefined</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><h4 id="never"><a class="markdownIt-Anchor" href="#never"></a> <code>Never</code></h4><p>è¡¨ç¤ºç”¨ä¸å­˜åœ¨çš„å€¼çš„ç±»å‹</p><p>å¦‚å¼‚å¸¸æˆ–ä¸ä¼šæœ‰è¿”å›å€¼çš„å‡½æ•°è¡¨è¾¾å¼æˆ–ç®­å¤´å‡½æ•°è¡¨è¾¾å¼çš„è¿”å›å€¼ç±»å‹</p><p>å˜é‡ä¹Ÿå¯ä»¥ä¸º<code>never</code>ç±»å‹, è¢«æ°¸ä¸ä¸ºçœŸçš„ç±»å‹ä¿æŠ¤æ‰€çº¦æŸæ—¶</p><p><code>never</code>ç±»å‹æ˜¯ä»»ä½•ç±»å‹çš„å­ç±»å‹, ä¹Ÿå¯ä»¥èµ‹å€¼ç»™ä»»ä½•ç±»å‹; ä½†æ²¡æœ‰ç±»å‹æ˜¯<code>never</code>çš„å­ç±»å‹, é™¤äº†<code>never</code>æœ¬èº«æ²¡æœ‰å€¼å¯ä»¥èµ‹å€¼ç»™<code>never</code>ç±»å‹, <code>any</code>ä¹Ÿä¸è¡Œ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›neverçš„å‡½æ•°å¿…é¡»å­˜åœ¨æ— æ³•è¾¾åˆ°çš„ç»ˆç‚¹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">error</span>(<span class="params"></span>): <span class="built_in">never</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¨æ–­çš„è¿”å›å€¼ç±»å‹ä¸ºnever</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params"></span>): <span class="built_in">never</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">error</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿”å›neverçš„å‡½æ•°å¿…é¡»å­˜åœ¨æ— æ³•è¾¾åˆ°çš„ç»ˆç‚¹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">infiniteLoop</span>(<span class="params"></span>): <span class="built_in">never</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="object"><a class="markdownIt-Anchor" href="#object"></a> <code>Object</code></h4><p>å¯¹è±¡ç±»å‹, æ‰€æœ‰ç±»å‹çš„çˆ¶ç±»å‹</p><h3 id="ç±»å‹æ–­è¨€"><a class="markdownIt-Anchor" href="#ç±»å‹æ–­è¨€"></a> ç±»å‹æ–­è¨€</h3><p>å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–è€…å‘ä¸‹è½¬å‹</p><p>æœ‰ä¸¤ç§æ–¹å¼:</p><p>æ–¹å¼ä¸€: ä½¿ç”¨å°–æ‹¬å·</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">value</span>: <span class="built_in">any</span> = <span class="string">&quot;this is a string&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = (&lt;<span class="built_in">string</span>&gt;value).<span class="property">length</span></span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒ: ä½¿ç”¨<code>as</code>è¯­æ³•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">value</span>: <span class="built_in">any</span> = <span class="string">&quot;this is a string&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">length</span>: <span class="built_in">number</span> = (value <span class="keyword">as</span> <span class="built_in">string</span>).<span class="property">length</span>;</span><br></pre></td></tr></table></figure><h3 id="è§£æ„"><a class="markdownIt-Anchor" href="#è§£æ„"></a> è§£æ„</h3><p>è§£æ„æ˜¯<code>ES6</code>ä¸­çš„æ–°ç‰¹æ€§, å¹¶ä¸æ˜¯<code>typescript</code>å®šä¹‰çš„, æ­¤å¤„å°†æ­¤ç‰¹æ€§ä»‹ç»æ˜¯å› ä¸ºæ­¤ç‰¹æ€§ä¸<code>typescript</code>é…åˆä¼šæœ‰ä¸ä¸€æ ·çš„ç«èŠ±</p><h4 id="æ•°ç»„è§£æ„"><a class="markdownIt-Anchor" href="#æ•°ç»„è§£æ„"></a> æ•°ç»„è§£æ„</h4><p>è¿›è¡Œæ•°ç»„å˜é‡èµ‹å€¼æ—¶, ä¸ºæ•°ç»„ä¸­çš„å…ƒç´ åˆ›å»ºå˜é‡å</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> input = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> [first, second] = input; <span class="comment">// == let first = input[0]; let second = input[1];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [first, , third] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]; <span class="comment">// ä¸å…³å¿ƒå…¶ä»–å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [first, ...rest] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] <span class="comment">// ä½¿ç”¨...åˆ›å»ºå‰©ä½™å˜é‡</span></span><br><span class="line"><span class="comment">// first = 1, rest = [2, 3, 4]</span></span><br></pre></td></tr></table></figure><p>ä½œä¸ºå‡½æ•°å‚æ•°æ—¶</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">[first, second]: <span class="built_in">number</span>[]</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br></pre></td></tr></table></figure><h4 id="å¯¹è±¡è§£æ„"><a class="markdownIt-Anchor" href="#å¯¹è±¡è§£æ„"></a> å¯¹è±¡è§£æ„</h4><p>å¦‚æœå°†å¯¹è±¡è§†ä½œç‰¹æ®Šçš„(å„ä¸ªå…ƒç´ æœ‰åç§°çš„)æ•°ç»„, åˆ™å®¹æ˜“ç†è§£å¯¹è±¡è§£æ„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123;nam, age&#125; = obj;</span><br></pre></td></tr></table></figure><p>åŒæ•°ç»„ä¸€æ ·, ä¸éœ€è¦çš„å…ƒç´ å¯ä»¥ä¸å£°æ˜èµ‹å€¼</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹è±¡è§£æ„æ—¶, å®šä¹‰çš„å˜é‡åéœ€è¦ä¸å¯¹è±¡ä¸­å¯¹åº”çš„å±æ€§(å…ƒç´ )åç§°ä¸€è‡´; å¯ä»¥é€šè¿‡å±æ€§é‡å‘½åçš„æ–¹å¼æ¥æ¥ç»™å±æ€§ä¸åŒçš„åå­—</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123;<span class="attr">nam</span>: personName, age&#125;: &#123;<span class="attr">nam</span>: <span class="built_in">string</span>, <span class="attr">age</span>: <span class="built_in">number</span>&#125; = obj;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸­ä¸º<code>nam</code>é‡å‘½åä¸º<code>personName</code>, å…¶ä¸­<code>&#123;nam: personName, age&#125;</code>ä¸­çš„<code>:</code>è¡¨ç¤ºå°†<code>nam</code>é‡å‘½åä¸º<code>personName</code>, å…¶ç±»å‹æ˜¯é€šè¿‡å®šä¹‰<code>&#123;nam: personName, age&#125;</code>å¯¹è±¡çš„æ•´ä½“ç±»å‹æ¥æè¿°çš„, åœ¨å®šä¹‰<code>&#123;nam: personName, age&#125;</code>å¯¹è±¡çš„æ•´ä½“ç±»å‹æ—¶, é‡å‘½åçš„å˜é‡è¿›è¡Œç±»å‹å®šä¹‰æ—¶ä½¿ç”¨çš„åç§°æ˜¯é‡å‘½åä¹‹å‰çš„åå­—</p><p>å¯¹è±¡è§£æ„ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨<code>...</code>åˆ›å»ºå‰©ä½™å˜é‡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123;nam, ...person&#125; = obj;</span><br><span class="line"><span class="comment">// nam = &quot;xiaolin&quot;, person = &#123;age: 18, sex: &quot;ç”·&quot;&#125;</span></span><br></pre></td></tr></table></figure><p>å½“å¯¹è±¡çš„æŸä¸ªå±æ€§ä¸º<code>undefined</code>æ—¶, å¯ä»¥ä¸ºè¯¥å±æ€§æ·»åŠ é»˜è®¤å€¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span>,</span><br><span class="line">    <span class="attr">des</span>: <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123;nam, <span class="attr">des</span>: desc = <span class="string">&quot;å¤ªå¸…äº†&quot;</span>&#125;: &#123;<span class="attr">nam</span>: <span class="built_in">string</span>, <span class="attr">des</span>: <span class="built_in">string</span>&#125; = obj;</span><br></pre></td></tr></table></figure><p>å½“<code>obj</code>çš„<code>des</code>æœ‰å€¼æ—¶, <code>desc</code>ä¸ºè¯¥å€¼, æ²¡æœ‰å€¼æ—¶ä¸ºé»˜è®¤çš„èµ‹å€¼</p><p>å¯¹è±¡è§£æ„é…åˆå‡½æ•°, å®ç°å‡½æ•°å‚æ•°çš„å¤šæ ·åŒ–å£°æ˜</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">&#123;a, b&#125;: &#123;a: <span class="built_in">string</span>, b?: <span class="built_in">number</span>&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•´ä½“é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fooFirst</span>(<span class="params">&#123;a, b&#125; = &#123;a: <span class="string">&#x27;&#x27;</span>, b: <span class="number">0</span>&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fooSecond</span>(<span class="params">&#123;a, b = <span class="number">0</span>&#125; = &#123;a: <span class="string">&#x27;&#x27;</span>, b: <span class="literal">undefined</span>&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éƒ¨åˆ†é»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fooThird</span>(<span class="params">&#123;a, b = <span class="number">0</span>&#125;: &#123;a: <span class="built_in">string</span>, b: <span class="built_in">number</span>&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç»“æ„, åœ¨ä¾¿äºç†è§£æ—¶ä½¿ç”¨å¯ä»¥æé«˜å¼€å‘æ•ˆç‡, ä½†æ˜¯å½“å‡ºç°ç±»å‹æ³¨è§£å’Œé»˜è®¤å€¼æ—¶åº”å°å¿ƒä½¿ç”¨, è¯­æ³•å’Œä½¿ç”¨ä¸Šéƒ½éš¾ä»¥ç†è§£</p><h3 id="å±•å¼€"><a class="markdownIt-Anchor" href="#å±•å¼€"></a> å±•å¼€</h3><h4 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h4><p>å±•å¼€ä¹Ÿæ˜¯<code>ES6</code>ä¸­æ·»åŠ çš„æ–°ç‰¹æ€§, å±•å¼€æ“ä½œä¸è§£æ„ç›¸å, å®ƒå°†ä¸€ä¸ªæ•°ç»„å±•å¼€ä¸ºå¦ä¸€ä¸ªæ•°ç»„, æˆ–å°†ä¸€ä¸ªå¯¹è±¡å±•å¼€ä¸ºå¦ä¸€ä¸ªå¯¹è±¡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> first = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">let</span> second = [<span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"><span class="keyword">let</span> all = [<span class="number">0</span>, ...first, ...second, <span class="number">5</span>]; <span class="comment">// å±•å¼€æ“ä½œæ—¶æµ…æ‹·è´, å…¶å†…å®¹ä¸ä¼šè¢«å±•å¼€æ“ä½œæ”¹å˜</span></span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> food = <span class="string">&quot;rich&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> person = &#123;</span><br><span class="line">    ...obj,</span><br><span class="line">    food,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹è±¡çš„å±•å¼€æ¯”æ•°ç»„çš„å±•å¼€è¦å¤æ‚. å®ƒåƒæ•°ç»„å±•å¼€ä¸€æ ·, ä½¿ç”¨å¼€å§‹å…ƒç´ ä¾æ¬¡å¤„ç†, ç»“æœä»ç„¶ä¸ºå¯¹è±¡, ç”±äºå¯¹è±¡çš„å±æ€§å”¯ä¸€, æ‰€ä»¥å±•å¼€å¯¹è±¡åé¢çš„å±æ€§ä¼šè¦†ç›–å‰é¢çš„å±æ€§</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    <span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">food</span>: <span class="string">&quot;cake&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> food = <span class="string">&quot;rich&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> person = &#123;</span><br><span class="line">    ...obj,</span><br><span class="line">    food,</span><br><span class="line">    <span class="attr">sex</span>: <span class="string">&quot;ç”·&quot;</span></span><br><span class="line">&#125; <span class="comment">// &#123;nam: &quot;xiaolin&quot;, age: 18, food: &quot;rich&quot;, sex: &quot;ç”·&quot;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="%E5%AF%B9%E8%B1%A1%E5%B1%95%E5%BC%80.png" alt="å¯¹è±¡å±•å¼€" /></p><p>åŒç†åœ¨å±•å¼€çš„å¯¹è±¡ä¸­å¦‚æœæœ‰åŒåçš„å±æ€§, åˆ™åå±•å¼€çš„å¯¹è±¡çš„è¯¥å±æ€§ä¼šè¦†ç›–å…ˆå±•å¼€çš„å¯¹è±¡çš„è¯¥å±æ€§</p><h4 id="é™åˆ¶"><a class="markdownIt-Anchor" href="#é™åˆ¶"></a> é™åˆ¶</h4><p>å¯¹è±¡çš„å±•å¼€å­˜åœ¨é™åˆ¶:</p><p>ä¸€. ä»…åŒ…å«å¯¹è±¡è‡ªèº«çš„å¯æšä¸¾å±æ€§</p><ol><li>å½“å±•å¼€å¯¹è±¡å®ä¾‹æ—¶, æ— æ³•è·å–å…¶ç±»å‹çš„æ‰€æœ‰å±æ€§, è€Œæ˜¯è·å–å…¶å®é™…å­˜åœ¨çš„å±æ€§</li><li>å½“å±•å¼€ä¸€ä¸ªå¯¹è±¡å®ä¾‹æ—¶, ä¼šä¸¢å¤±å…¶æ–¹æ³•, å³å±•å¼€åªä¼šæ‹·è´å±æ€§, ä¸ä¼šæ‹·è´æ–¹æ³•</li></ol><p>äºŒ. <code>typescript</code>ç¼–è¯‘å™¨ä¸å…è®¸å±•å¼€æ³›å‹å‡½æ•°ä¸Šçš„ç±»å‹å‚æ•°</p><ol><li><p>è¿™ä¸ªæè¿°æ˜¯<code>typescript</code>æ‰‹å†Œä¸Šçš„æè¿°, å½“å‰ä¸çŸ¥é“æ˜¯å·²ç»å®ç°è¿˜æ˜¯æˆ‘ç†è§£æœ‰è¯¯, ä¸€ä¸‹æ–¹å¼ç¼–è¯‘è¿è¡Œæ—¶æ˜¯æ­£å¸¸çš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> fo&lt;T&gt;(<span class="attr">arg</span>: T): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> o = &#123;...arg&#125;;</span><br><span class="line">&#125;</span><br><span class="line">fo&lt;&#123;<span class="attr">nam</span>: <span class="built_in">string</span>, <span class="attr">age</span>: <span class="built_in">number</span>&#125;&gt;(&#123;<span class="attr">nam</span>: <span class="string">&quot;xiaolin&quot;</span>, <span class="attr">age</span>: <span class="number">18</span>&#125;);</span><br></pre></td></tr></table></figure></li></ol><h3 id="å‡½æ•°"><a class="markdownIt-Anchor" href="#å‡½æ•°"></a> å‡½æ•°</h3><p><code>typescript</code>ä¸­å‡½æ•°ä¹Ÿæ˜¯ä½œä¸ºä¸€ç§ç±»å‹çš„, ä½†æ˜¯å‡½æ•°ç±»å‹å¿…é¡»æ˜¯æœ‰å®šä¹‰çš„å‡½æ•°ç±»å‹, è¿™ç§å®šä¹‰æ˜¯é€šè¿‡æ¥å£å®ç°çš„, åç»­è®²æ¥å£æ—¶è¯¦ç»†è®²è¿°</p><p>æ‰€è°“å¿…é¡»æ˜¯æœ‰å®šä¹‰çš„å‡½æ•°ç±»å‹æŒ‡çš„æ˜¯, æ‰€å®šä¹‰çš„å‡½æ•°åœ¨æŒ‡æ˜ç±»å‹æ—¶, å¿…é¡»å£°æ˜å‡½æ•°çš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°ä¸æŒ‡æ˜ç±»å‹ -&gt; æ¨æ–­ç±»å‹</span></span><br><span class="line"><span class="keyword">let</span> foo = <span class="keyword">function</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;<span class="keyword">return</span> x + y;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°æŒ‡æ˜ç±»å‹</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">foo</span>: <span class="function">(<span class="params"><span class="attr">base</span>: <span class="built_in">number</span>, <span class="attr">increment</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">number</span> = <span class="keyword">function</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span>&#123;<span class="keyword">return</span> x + y;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯é€‰å‚æ•°</span></span><br><span class="line"><span class="keyword">let</span> foo = (<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>, <span class="attr">z</span>?: <span class="built_in">number</span>): <span class="function"><span class="params">number</span> =&gt;</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="keyword">let</span> foo = (<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>, <span class="attr">z</span>: <span class="built_in">number</span> = <span class="number">0</span>): <span class="function"><span class="params">number</span> =&gt;</span> x + y + z</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‰©ä½™å‚æ•°</span></span><br><span class="line"><span class="keyword">let</span> foo = (<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="attr">number</span>: ...<span class="attr">z</span>: <span class="built_in">number</span>[]): <span class="function"><span class="params">number</span> =&gt;</span> x + y</span><br></pre></td></tr></table></figure><ol><li><p>å‡½æ•°æŒ‡æ˜ç±»å‹çš„å®šä¹‰ä¸­, å˜é‡åä¹‹å, <code>=</code>ä¹‹å‰å°±æ˜¯ç±»å‹å®šä¹‰, <code>=&gt;</code>ä¹‹å‰æ˜¯å‚æ•°åˆ—è¡¨å®šä¹‰, ä¹‹åæ˜¯è¿”å›å€¼ç±»å‹å®šä¹‰; æ­¤å‡½æ•°ç±»å‹çš„å®šä¹‰åƒæ˜¯ä¸€ä¸ªåŒ¿åç±»å‹, åªè¦å‡½æ•°å®šä¹‰çš„å‚æ•°åˆ—è¡¨ç±»å‹å’Œè¿”å›å€¼ç±»å‹ç¬¦åˆç±»å‹å®šä¹‰çš„å‚æ•°åˆ—è¡¨ç±»å‹å’Œè¿”å›å€¼ç±»å‹æ¥å£, ä¸åœ¨ä¹å‚æ•°åç§°</p><p>æŒ‡æ˜ç±»å‹çš„å®šä¹‰åœ¨ä½¿ç”¨æ—¶, ä½¿ç”¨ç®­å¤´å‡½æ•°çš„æ–¹å¼å®šä¹‰å‡½æ•°æ›´ç›´è§‚ä¸€äº›</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">foo</span>: <span class="function">(<span class="params"><span class="attr">base</span>: <span class="built_in">number</span>, <span class="attr">increment</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">number</span> = (<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="function"><span class="params">number</span> =&gt;</span> x + y</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥çœ‹å‡º, å‡½æ•°æ˜¯ä¸€ç§ç±»å‹, ä½†å‡½æ•°çš„ç±»å‹åªæ˜¯ç”±å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç»„æˆå’Œå†³å®š</p></li><li><p>æ¨æ–­ç±»å‹æœ‰ä¸¤ä¸ªå«ä¹‰: ä¸€. åœ¨å‡½æ•°å˜é‡ä¸æŒ‡æ˜å‡½æ•°ç±»å‹æ—¶, é€šè¿‡å‡½æ•°å®šä¹‰æ¨æ–­å‡½æ•°ç±»å‹; äºŒ. åœ¨å‡½æ•°å˜é‡æŒ‡æ˜å‡½æ•°ç±»å‹æ—¶, å‡½æ•°å®šä¹‰çš„å‚æ•°åˆ—è¡¨ä¸­å‚æ•°ç±»å‹å’Œè¿”å›å€¼ç±»å‹é€šè¿‡å‡½æ•°ç±»å‹æ¨æ–­å¾—å‡º</p></li><li><p>å¯é€‰å‚æ•°, <code>typescript</code>çš„å‡½æ•°å®šä¹‰ä¸­, å¯ä»¥é€šè¿‡<code>?</code>æ¥æŒ‡æ˜æŸä¸ªå‚æ•°å¯ä¼ å¯ä¸ä¼ , æ²¡ä¼ çš„æ—¶å€™å°±æ˜¯<code>undefined</code>. å¯é€‰å‚æ•°å¿…é¡»å®šä¹‰åœ¨å‡½æ•°çš„å¿…ä¼ å‚æ•°çš„åé¢</p></li><li><p>é»˜è®¤å‚æ•°, ä¸ºå‡½æ•°çš„å‚æ•°è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼, å½“ç”¨æˆ·æ²¡æœ‰ä¼ é€’è¯¥å‚æ•°æ—¶, å¯ä»¥ä½¿ç”¨é»˜è®¤å€¼</p><p>é»˜è®¤å‚æ•°å¦‚æœæ”¾åœ¨æ‰€æœ‰å¿…ä¼ å‚æ•°çš„åé¢, åˆ™ä¸å¯é€‰å‚æ•°ç±»ä¼¼, å¹¶ä¸å¯é€‰å‚æ•°å…±äº«å‚æ•°ç±»å‹; é»˜è®¤å‚æ•°å¦‚æœæ²¡æœ‰æ”¾åœ¨æ‰€æœ‰å¿…é¡»å‚æ•°çš„åé¢, åˆ™å¿…é¡»æ˜ç¡®çš„ä¼ å…¥<code>undefined</code>æ¥è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼</p></li><li><p>å‰©ä½™å‚æ•°ä¼šè¢«å½“åšä¸ªæ•°ä¸é™çš„å¯é€‰å‚æ•°, å…¶æ•°é‡å¯ä»¥æ˜¯<code>0</code>æˆ–è€…ä»»æ„ä¸ª, å‰©ä½™å‚æ•°å¿…é¡»æ”¾åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨çš„æœ€å</p></li><li><p>å‡½æ•°é‡è½½, éœ€è¦æ³¨æ„çš„æ˜¯, <code>typescript</code>ä¸­å•ç‹¬å®šä¹‰çš„å‡½æ•°é‡è½½æ—¶, æ˜¯åªæœ‰ä¸€ä¸ªå‡½æ•°å®šä¹‰, å¤šä¸ªå‡½æ•°å£°æ˜, å‡½æ•°å£°æ˜çš„å‚æ•°ä¸ªæ•°ä¸èƒ½å°‘äºå‡½æ•°å®šä¹‰å‚æ•°ä¸ªæ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pickCard</span>(<span class="params"><span class="attr">x</span>: &#123;suit: <span class="built_in">string</span>; card: <span class="built_in">number</span>; &#125;[]</span>): <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pickCard</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span></span>): &#123;<span class="attr">suit</span>: <span class="built_in">string</span>; <span class="attr">card</span>: <span class="built_in">number</span>; &#125; </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pickCard</span>(<span class="params">x</span>): <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="comment">// Check to see if we&#x27;re working with an object/array</span></span><br><span class="line">    <span class="comment">// if so, they gave us the deck and we&#x27;ll pick the card</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pickedCard = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * x.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">return</span> pickedCard;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise just let them pick the card</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">&quot;number&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pickedSuit = <span class="title class_">Math</span>.<span class="title function_">floor</span>(x / <span class="number">13</span>);</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">suit</span>: suits[pickedSuit], <span class="attr">card</span>: x % <span class="number">13</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myDeck = [&#123; <span class="attr">suit</span>: <span class="string">&quot;diamonds&quot;</span>, <span class="attr">card</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">&quot;spades&quot;</span>, <span class="attr">card</span>: <span class="number">10</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">&quot;hearts&quot;</span>, <span class="attr">card</span>: <span class="number">4</span> &#125;];</span><br><span class="line"><span class="keyword">let</span> pickedCard1 = myDeck[<span class="title function_">pickCard</span>(myDeck)];</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;card: &quot;</span> + pickedCard1.<span class="property">card</span> + <span class="string">&quot; of &quot;</span> + pickedCard1.<span class="property">suit</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pickedCard2 = <span class="title function_">pickCard</span>(<span class="number">15</span>);</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;card: &quot;</span> + pickedCard2.<span class="property">card</span> + <span class="string">&quot; of &quot;</span> + pickedCard2.<span class="property">suit</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸­åªæœ‰ä¸€ä¸ªå‡½æ•°å®šä¹‰, å®ƒå¤„ç†äº†ä¸åŒçš„å‚æ•°ç±»å‹çš„æƒ…å†µ, ä½†æ˜¯å‡½æ•°å£°æ˜æœ‰ä¸¤ä¸ª, åˆ†åˆ«æ˜¯<code>&#123;suit: string; card: number; &#125;</code>ç±»å‹å‚æ•°çš„å£°æ˜å’Œ<code>number</code>ç±»å‹å‚æ•°çš„å£°æ˜, è¿™ä¸¤ä¸ªå£°æ˜å³æ˜¯å‡½æ•°çš„é‡è½½, è€Œ<code>any</code>ç±»å‹å‚æ•°çš„å‡½æ•°å¹¶ä¸æ˜¯é‡è½½åˆ—è¡¨ä¸­çš„ä¸€éƒ¨åˆ†, è€Œæ˜¯å®é™…çš„å‡½æ•°å®šä¹‰, åœ¨è°ƒç”¨æ—¶ç¼–è¯‘å™¨åªä¼šæ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦ç¬¦åˆå‡½æ•°å£°æ˜, è€Œä¸å»æ£€æŸ¥æ˜¯å¦ç¬¦åˆå‡½æ•°å®šä¹‰</p><p>å¦‚æœåœ¨æŸä¸ªå‡½æ•°å£°æ˜ä¸Šæ·»åŠ äº†é¢å¤–çš„å‚æ•°, ç¼–è¯‘ä¸ä¼šå‡ºç°é—®é¢˜, ä½†æ˜¯åœ¨è°ƒç”¨æ—¶, å¦‚æœå‰é¢çš„å‚æ•°ç¬¦åˆè¯¥å‡½æ•°å£°æ˜, åˆ™éœ€è¦å°†é¢å¤–çš„å‚æ•°æ·»åŠ ä¸Š, ä½†æ˜¯åœ¨å‡½æ•°å®šä¹‰ä¸­è¯¥é¢å¤–çš„å‚æ•°å¹¶ä¸ä¼šè¢«ä½¿ç”¨</p></li><li><p>å‡½æ•°ä¸­æœ‰ä¸ªéå¸¸éš¾ä»¥ç†è§£çš„åœ°æ–¹: <code>this</code>çš„æŒ‡å‘é—®é¢˜</p><p>åœ¨<code>java</code>ä¸­, æ— è®ºæ˜¯å±æ€§è¿˜æ˜¯æ–¹æ³•, éƒ½æ˜¯åœ¨å¯¹è±¡ä¸­å®šä¹‰çš„, æ‰€ä»¥<code>this</code>æ°¸è¿œæŒ‡å‘å½“å‰å±æ€§æˆ–è€…æ–¹æ³•å®šä¹‰çš„ç±»çš„å®ä¾‹å¯¹è±¡</p><p>ä½†æ˜¯åœ¨<code>javascript</code>å’Œ<code>typescript</code>, å¯ä»¥è®¤ä¸ºæ‰€æœ‰çš„å†…å®¹å…¨éƒ¨æ˜¯åœ¨<code>window</code>å¯¹è±¡ä¸­å®šä¹‰æ‰§è¡Œçš„, ç”±äºæˆ‘ä»¬å¯¹æ­¤æ— æ„Ÿ, è®¤ä¸ºå‡½æ•°å¯ä»¥ç‹¬ç«‹äºå¯¹è±¡ä¹‹å¤–å®šä¹‰, è€Œç‹¬ç«‹äºå¯¹è±¡ä¹‹å¤–å®šä¹‰çš„å‡½æ•°çš„<code>this</code>å®é™…æ˜¯å®šä¹‰åœ¨<code>window</code>å¯¹è±¡ä¸­çš„, æ‰€ä»¥å…¶<code>this</code>æŒ‡å‘æ˜¯<code>window</code>å¯¹è±¡</p><p>åœ¨<code>js</code>å’Œ<code>ts</code>çš„å‡½æ•°ä¸­, ä¼ ç»Ÿå‡½æ•°å®šä¹‰çš„<code>this</code>æ˜¯æŒ‡å‘è°ƒç”¨æ–¹çš„, è€Œç®­å¤´å‡½æ•°å®šä¹‰çš„<code>this</code>æ˜¯æŒ‡å‘åˆ›å»ºæ–¹çš„, æ‰€ä»¥åœ¨å‡½æ•°çš„åˆ›å»ºè°ƒç”¨æ—¶, éœ€è¦ä»”ç»†åˆ†æ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> deck = &#123;</span><br><span class="line">    <span class="attr">suits</span>: [<span class="string">&quot;hearts&quot;</span>, <span class="string">&quot;spades&quot;</span>, <span class="string">&quot;clubs&quot;</span>, <span class="string">&quot;diamonds&quot;</span>],</span><br><span class="line">    <span class="comment">// deck å¯¹è±¡çš„å†…éƒ¨å‡½æ•°</span></span><br><span class="line">    <span class="attr">returnHearts</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›ä¸€ä¸ªä¼ ç»Ÿå®šä¹‰æ–¹å¼çš„å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">suits</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// deck å¯¹è±¡å†…éƒ¨å‡½æ•°</span></span><br><span class="line">    <span class="attr">returnSpades</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// è¿”å›ä¸€ä¸ªç®­å¤´å‡½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">suits</span>[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hearts = deck.<span class="title function_">returnHearts</span>();<span class="comment">// æœ¬è´¨æ˜¯ let hearts = function() &#123;return this.suits[0];&#125;</span></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼å®šä¹‰çš„å‡½æ•°, æ‰€ä»¥thisæŒ‡å‘è°ƒç”¨æ–¹, å³window, æ‰€ä»¥æ‰¾ä¸åˆ°suits</span></span><br><span class="line"><span class="keyword">let</span> spades = deck.<span class="title function_">returnSpades</span>();<span class="comment">// æœ¬è´¨æ˜¯ let spades = () =&gt; &#123;return this.suits[1];&#125;</span></span><br><span class="line"><span class="comment">// ç®­å¤´å‡½æ•°æ–¹å¼å®šä¹‰çš„å‡½æ•°, æ‰€ä»¥thisæŒ‡å‘åˆ›å»ºæ–¹, å³deck</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hearts</span>());<span class="comment">// è¿è¡Œæ—¶æŠ¥é”™, æ‰¾ä¸åˆ°suits</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">spades</span>());<span class="comment">// æ­£å¸¸, è¿”å›spades</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="ç±»"><a class="markdownIt-Anchor" href="#ç±»"></a> ç±»</h3><h4 id="åŸºæœ¬å®šä¹‰"><a class="markdownIt-Anchor" href="#åŸºæœ¬å®šä¹‰"></a> åŸºæœ¬å®šä¹‰</h4><p>ç±»é€šå¸¸ç”¨æ¥æè¿°ä¸€ä¸ªå¯¹è±¡, å…¶ä¸­å¯ä»¥å®šä¹‰å±æ€§å’Œæ–¹æ³•, è¿˜éœ€è¦æœ‰æ„é€ å‡½æ•°. åœ¨ç±»ä¸­, å¼•ç”¨ä»»ä½•ä¸€ä¸ªç±»æˆå‘˜çš„æ—¶å€™éƒ½éœ€è¦ä½¿ç”¨<code>this</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="attr">greeting</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">message</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">greeting</span> = message;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + <span class="variable language_">this</span>.<span class="property">greeting</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç»§æ‰¿"><a class="markdownIt-Anchor" href="#ç»§æ‰¿"></a> ç»§æ‰¿</h4><p>ç±»å¯ä»¥ç»§æ‰¿ç±», ä½†åªèƒ½å•ç»§æ‰¿</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">move</span>(<span class="params"><span class="attr">distanceInMeters</span>: <span class="built_in">number</span> = <span class="number">0</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Animal moved <span class="subst">$&#123;distanceInMeters&#125;</span>m.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">bark</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Woof! Woof!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­ç±»å¯ä»¥ç»§æ‰¿è¶…ç±»ä¸­çš„å±æ€§å’Œæ–¹æ³•</p><p>å­ç±»çš„æ„é€ å‡½æ•°çš„é¦–è¡Œå¿…é¡»è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</p><h4 id="è®¿é—®æƒé™"><a class="markdownIt-Anchor" href="#è®¿é—®æƒé™"></a> è®¿é—®æƒé™</h4><p>ç±»ä¸­å†…å®¹çš„è®¿é—®æƒé™å—è®¿é—®ä¿®é¥°ç¬¦æ§åˆ¶, é»˜è®¤ä¸º<code>public</code>, å³å…¬å…±çš„, ä»»æ„ä½ç½®å¯ä½¿ç”¨; <code>private</code>è¡¨ç¤ºç§æœ‰çš„, å³åªæœ‰æœ¬ç±»ä¸­å¯ä»¥è®¿é—®; <code>protected</code>ä¸ºå—ä¿æŠ¤çš„, åœ¨æœ¬ç±»å’Œå­ç±»ä¸­å¯ä»¥è®¿é—®</p><p>ä¸¤ä¸ªç±»çš„å…¼å®¹æ€§ä¸­, ä¸¤ä¸ªç±»çš„<code>public</code>çš„å±æ€§åªåˆ¤æ–­ç±»å‹æ˜¯å¦å…¼å®¹, <code>private</code>å’Œ<code>protected</code>çš„å±æ€§å¿…é¡»ä¿è¯è®¿é—®ä¿®é¥°ç¬¦ç›¸åŒä¸”æ¥è‡ªäºåŒä¸€å¤„å£°æ˜; åœ¨<code>java</code>ä¸­ç§°ä¸ºå‘ä¸Šè½¬å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">theName</span>: <span class="built_in">string</span></span>) &#123; <span class="variable language_">this</span>.<span class="property">name</span> = theName; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Rhino</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Animal</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123; <span class="variable language_">super</span>(<span class="string">&quot;Rhino&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Employee</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">theName</span>: <span class="built_in">string</span></span>) &#123; <span class="variable language_">this</span>.<span class="property">name</span> = theName; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> animal = <span class="keyword">new</span> <span class="title class_">Animal</span>(<span class="string">&quot;Goat&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> rhino = <span class="keyword">new</span> <span class="title class_">Rhino</span>();</span><br><span class="line"><span class="keyword">let</span> employee = <span class="keyword">new</span> <span class="title class_">Employee</span>(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line"></span><br><span class="line">animal = rhino;</span><br><span class="line">animal = employee; <span class="comment">// é”™è¯¯: Animal ä¸ Employee ä¸å…¼å®¹.</span></span><br></pre></td></tr></table></figure><h4 id="é™æ€"><a class="markdownIt-Anchor" href="#é™æ€"></a> é™æ€</h4><p>ç±»ä¸­ä½¿ç”¨<code>static</code>ä¿®é¥°çš„å±æ€§å’Œæ–¹æ³•, ä¸éœ€è¦åˆ›å»ºç±»å³å¯ä½¿ç”¨, å…¶æ‰€å±æ˜¯å±äºç±»è€Œä¸æ˜¯ç±»å®ä¾‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Grid</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> origin = &#123;<span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="title function_">calculateDistanceFromOrigin</span>(<span class="params"><span class="attr">point</span>: &#123;x: <span class="built_in">number</span>; y: <span class="built_in">number</span>;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> xDist = (point.<span class="property">x</span> - <span class="title class_">Grid</span>.<span class="property">origin</span>.<span class="property">x</span>);</span><br><span class="line">        <span class="keyword">let</span> yDist = (point.<span class="property">y</span> - <span class="title class_">Grid</span>.<span class="property">origin</span>.<span class="property">y</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(xDist * xDist + yDist * yDist) / <span class="variable language_">this</span>.<span class="property">scale</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">constructor</span> (<span class="params"><span class="keyword">public</span> <span class="attr">scale</span>: <span class="built_in">number</span></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> grid1 = <span class="keyword">new</span> <span class="title class_">Grid</span>(<span class="number">1.0</span>);  <span class="comment">// 1x scale</span></span><br><span class="line"><span class="keyword">let</span> grid2 = <span class="keyword">new</span> <span class="title class_">Grid</span>(<span class="number">5.0</span>);  <span class="comment">// 5x scale</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(grid1.<span class="title function_">calculateDistanceFromOrigin</span>(&#123;<span class="attr">x</span>: <span class="number">10</span>, <span class="attr">y</span>: <span class="number">10</span>&#125;));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(grid2.<span class="title function_">calculateDistanceFromOrigin</span>(&#123;<span class="attr">x</span>: <span class="number">10</span>, <span class="attr">y</span>: <span class="number">10</span>&#125;));</span><br></pre></td></tr></table></figure><h4 id="æŠ½è±¡ç±»"><a class="markdownIt-Anchor" href="#æŠ½è±¡ç±»"></a> æŠ½è±¡ç±»</h4><p>æŠ½è±¡ç±»ä½œä¸ºåŸºç±»ä½¿ç”¨, ä¸ä¼šç›´æ¥è¢«å®ä¾‹åŒ–</p><p>æŠ½è±¡ç±»ç”¨<code>abstract</code>å…³é”®å­—å®šä¹‰, æŠ½è±¡ç±»å†…éƒ¨å¯ä»¥æœ‰<code>abstract</code>å®šä¹‰çš„æŠ½è±¡æ–¹æ³•, ä¸éœ€è¦å…·ä½“çš„æ–¹æ³•å®ç°, åœ¨æ´¾ç”Ÿç±»ä¸­å®ç°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="title function_">makeSound</span>(): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">move</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;roaming the earch...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ„é€ å‡½æ•°"><a class="markdownIt-Anchor" href="#æ„é€ å‡½æ•°"></a> æ„é€ å‡½æ•°</h4><p>åœ¨å®šä¹‰ä¸€ä¸ªéæŠ½è±¡ç±»æ—¶, å¦‚æœç±»ä¸­å®šä¹‰æœ‰å¿…é¡»å­˜åœ¨çš„å±æ€§, åˆ™å¿…é¡»æ˜¾å¼çš„å£°æ˜æ„é€ å‡½æ•°, å¹¶ä¼ å…¥å¯¹åº”çš„å‚æ•°æ•°é‡åŠç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="attr">greeting</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">message</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">greeting</span> = message;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + <span class="variable language_">this</span>.<span class="property">greeting</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¥å£"><a class="markdownIt-Anchor" href="#æ¥å£"></a> æ¥å£</h3><h4 id="æ¥å£åŸºæœ¬å®šä¹‰"><a class="markdownIt-Anchor" href="#æ¥å£åŸºæœ¬å®šä¹‰"></a> æ¥å£åŸºæœ¬å®šä¹‰</h4><p>æœ€åè®²æ¥å£æœ‰ä¸¤ä¸ªåŸå› : ä¸€æ˜¯åœ¨<code>typescript</code>ä¸­, æ¥å£çš„åº”ç”¨æœ€å¹¿è€Œå¤š, ç±»åè€Œå°‘; äºŒæ˜¯<code>typescript</code>ä¸­çš„æ¥å£æœ‰æ¯”è¾ƒå¤šçš„ç‰¹æ€§</p><p>ä½¿ç”¨<code>interface</code>å®šä¹‰æ¥å£</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="built_in">string</span>;<span class="comment">// å¿…è¦å±æ€§</span></span><br><span class="line">    <span class="attr">age</span>: <span class="built_in">number</span>;<span class="comment">// å¿…è¦å±æ€§</span></span><br><span class="line">    <span class="attr">sex</span>?: <span class="built_in">string</span>;<span class="comment">// å¯é€‰å±æ€§</span></span><br><span class="line">    <span class="keyword">readonly</span> <span class="attr">desc</span>: <span class="built_in">string</span>;<span class="comment">// åªè¯»å±æ€§</span></span><br><span class="line">    [<span class="attr">propName</span>: <span class="built_in">string</span>]: <span class="built_in">any</span>;<span class="comment">// å­—ç¬¦ä¸²ç´¢å¼•ç­¾å</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>å¯é€‰å±æ€§æœ‰ä¸¤ä¸ªå¥½å¤„: ä¸€. å¯ä»¥å¯¹å¯èƒ½å­˜åœ¨çš„å±æ€§è¿›è¡Œé¢„å®šä¹‰; äºŒ. å¯ä»¥æ•è·å¼•ç”¨äº†ä¸å­˜åœ¨çš„å±æ€§é”™è¯¯.</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">SquareConfig</span> &#123;</span><br><span class="line">    <span class="attr">color</span>?: <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">width</span>?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createSquare</span>(<span class="params"><span class="attr">config</span>: <span class="title class_">SquareConfig</span></span>): &#123; <span class="attr">color</span>: <span class="built_in">string</span>; <span class="attr">area</span>: <span class="built_in">number</span> &#125; &#123;</span><br><span class="line">    <span class="keyword">let</span> newSquare = &#123;<span class="attr">color</span>: <span class="string">&quot;white&quot;</span>, <span class="attr">area</span>: <span class="number">100</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">color</span>) &#123;</span><br><span class="line">        <span class="comment">// æç¤ºé”™è¯¯</span></span><br><span class="line">        <span class="comment">// Error: Property &#x27;clor&#x27; does not exist on type &#x27;SquareConfig&#x27;</span></span><br><span class="line">        <span class="comment">// è¯¥æ¥å£ä¸­æ‰¾ä¸åˆ°clorå±æ€§</span></span><br><span class="line">        newSquare.<span class="property">color</span> = config.<span class="property">clor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">width</span>) &#123;</span><br><span class="line">        newSquare.<span class="property">area</span> = config.<span class="property">width</span> * config.<span class="property">width</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newSquare;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mySquare = <span class="title function_">createSquare</span>(&#123;<span class="attr">color</span>: <span class="string">&quot;black&quot;</span>&#125;);</span><br></pre></td></tr></table></figure></li><li><p>åªè¯»å±æ€§åªèƒ½åœ¨å¯¹è±¡åˆšåˆšåˆ›å»ºçš„æ—¶å€™ä¿®æ”¹å…¶å€¼, ä½¿ç”¨<code>readonly</code>æ¥æŒ‡å®š</p><p>æ¥å£æˆ–ç±»ä¸­éƒ½å¯å®šä¹‰åªè¯»å±æ€§, åªè¯»æ•°ç»„åˆ™éœ€è¦ä½¿ç”¨æ•°ç»„æ³›å‹å¾—åˆ°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">arr</span>: <span class="title class_">ReadonlyArray</span>&lt;T&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure><p>åªè¯»æ•°ç»„çš„æ‰€æœ‰å¯å˜æ–¹æ³•éƒ½è¢«å»æ‰äº†, å…¶å±æ€§ä¸å¯ä¿®æ”¹, å†…å®¹ä¸å¯ä¿®æ”¹, ç”šè‡³ä¸èƒ½é‡æ–°èµ‹å€¼ç»™æ™®é€šæ•°ç»„</p><p>åªè¯»æ•°ç»„å¦‚æœæƒ³è¦èµ‹å€¼ç±»æ™®é€šæ•°ç»„å˜é‡, åªèƒ½é€šè¿‡ç±»å‹æ–­è¨€å®ç°</p></li><li><p>å­—ç¬¦ä¸²ç´¢å¼•ç­¾åè¡¨ç¤ºè¯¥æ¥å£å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„åç§°åœ¨è¯¥æ¥å£ä¸­æœªå®šä¹‰çš„å…¶ä»–å±æ€§. è¿™ç§æ–¹å¼åœ¨ç¼–è¯‘æ—¶ä¼šç»•è¿‡å±æ€§åçš„æ£€æŸ¥, å¯èƒ½ä¼šå¼•èµ·é”™è¯¯.</p><p>ç»•è¿‡å±æ€§åæ£€æŸ¥çš„æ–¹å¼æœ‰:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mySquare = <span class="title function_">createSquare</span>(&#123;<span class="attr">colour</span>: <span class="string">&quot;black&quot;</span>, <span class="attr">width</span>: <span class="number">100</span>&#125;);<span class="comment">// ERROR: &#x27;colour&#x27; not expected in type &#x27;SquareConfig&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><p>ç±»å‹æ–­è¨€</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mySquare = <span class="title function_">createSquare</span>(&#123;<span class="attr">colour</span>: <span class="string">&quot;black&quot;</span>, <span class="attr">width</span>: <span class="number">100</span>&#125; <span class="keyword">as</span> <span class="title class_">SquareConfig</span>);</span><br></pre></td></tr></table></figure></li><li><p>æ¥å£ä¸­æ·»åŠ ç´¢å¼•ç­¾å</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">interface SquareConfig &#123;</span><br><span class="line">    <span class="attribute">color</span>?: string;</span><br><span class="line">    <span class="attribute">width</span>?: number;</span><br><span class="line">    <span class="selector-attr">[propName: string]</span>: any;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å°†å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> squareOptions = &#123; <span class="attr">colour</span>: <span class="string">&quot;red&quot;</span>, <span class="attr">width</span>: <span class="number">100</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> mySquare = <span class="title function_">createSquare</span>(squareOptions);</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="ç»§æ‰¿ä¸å®ç°"><a class="markdownIt-Anchor" href="#ç»§æ‰¿ä¸å®ç°"></a> ç»§æ‰¿ä¸å®ç°</h4><p>æ¥å£å¯ä»¥ç»§æ‰¿æ¥å£, ä¸”æ”¯æŒå¤šç»§æ‰¿</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="attr">sideLength</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»å¯ä»¥å®ç°æ¥å£, ä¸”æ”¯æŒå¤šå®ç°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ClockConstructor</span> &#123;</span><br><span class="line">    <span class="title function_">new</span> (<span class="attr">hour</span>: <span class="built_in">number</span>, <span class="attr">minute</span>: <span class="built_in">number</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clock</span> <span class="keyword">implements</span> <span class="title class_">ClockConstructor</span> &#123;</span><br><span class="line">    <span class="attr">currentTime</span>: <span class="title class_">Date</span>;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"><span class="attr">h</span>: <span class="built_in">number</span>, <span class="attr">m</span>: <span class="built_in">number</span></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‰¹æ®Šçš„, æ¥å£ä¹Ÿå¯ä»¥ç»§æ‰¿ç±», ä»è€ŒæŠŠç±»å½“åšæ¥å£ä½¿ç”¨, æ­¤ç»§æ‰¿ä¹Ÿæ˜¯å•ç»§æ‰¿</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Control</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">state</span>: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SelectableControl</span> <span class="keyword">extends</span> <span class="title class_">Control</span> &#123;</span><br><span class="line">    <span class="title function_">select</span>(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Button</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Control</span> <span class="keyword">implements</span> <span class="title class_">SelectableControl</span> &#123;</span><br><span class="line">    <span class="title function_">select</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–ç”¨æ³•"><a class="markdownIt-Anchor" href="#å…¶ä»–ç”¨æ³•"></a> å…¶ä»–ç”¨æ³•</h4><ol><li><p>å‡½æ•°ç±»å‹</p><p>é™¤äº†æè¿°å¸¦æœ‰å±æ€§çš„æ™®é€šå¯¹è±¡å¤–ï¼Œæ¥å£ä¹Ÿå¯ä»¥æè¿°å‡½æ•°ç±»å‹</p><p>ç»™æ¥å£å®šä¹‰ä¸€ä¸ªè°ƒç”¨ç­¾å, å°±åƒæ˜¯ä¸€ä¸ªåªæœ‰å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼ç±»å‹çš„å‡½æ•°å®šä¹‰, å‚æ•°åˆ—è¡¨é‡Œçš„æ¯ä¸ªå‚æ•°éƒ½éœ€è¦åå­—å’Œç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">SearchFunc</span> &#123;</span><br><span class="line">  (<span class="attr">source</span>: <span class="built_in">string</span>, <span class="attr">subString</span>: <span class="built_in">string</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ç±»å‹å®šä¹‰çš„æ¥å£ä¸<code>java</code>ä¸­çš„å‡½æ•°å¼æ¥å£ç›¸ä¼¼, ä½†æ˜¯<code>typescript</code>ä¸­çš„å‡½æ•°ç±»å‹æ¥å£æ˜¯æ²¡æœ‰æ–¹æ³•åçš„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">mySearch</span>: <span class="title class_">SearchFunc</span>;</span><br><span class="line">mySearch = <span class="keyword">function</span>(<span class="params"><span class="attr">source</span>: <span class="built_in">string</span>, <span class="attr">subString</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> result = source.<span class="title function_">search</span>(subString);</span><br><span class="line">  <span class="keyword">return</span> result &gt; -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ç±»å‹çš„æ¥å£å¯ä»¥å®šä¹‰å¤šä¸ªå‡½æ•°, ä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªåŒ¿åå‡½æ•°, å¹¶éè¯­æ³•ä¸Šä¸å…è®¸, è€Œæ˜¯åœ¨åˆ›å»ºä½¿ç”¨æ—¶, æ— æ³•è§£æåˆ°å¤šä¸ªåŒ¿åå‡½æ•°, å…·ä½“æ˜¯å“ªä¸ªä½œä¸ºå‡½æ•°ç±»å‹çš„æ¥å£å®šä¹‰, æˆ‘è¿˜ä¸çŸ¥é“â€¦</p><p><img src="%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B%E6%8E%A5%E5%8F%A3%E4%B8%8D%E8%83%BD%E6%9C%89%E5%A4%9A%E4%B8%AA%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0.png" alt="å‡½æ•°ç±»å‹æ¥å£ä¸èƒ½æœ‰å¤šä¸ªåŒ¿åå‡½æ•°" /></p><p>å‡½æ•°çš„å‚æ•°ä¼šé€ä¸ªè¿›è¡Œæ£€æŸ¥ï¼Œè¦æ±‚å¯¹åº”ä½ç½®ä¸Šçš„å‚æ•°ç±»å‹æ˜¯å…¼å®¹çš„</p><p>å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯é€šè¿‡å…¶è¿”å›å€¼æ¨æ–­å‡ºæ¥çš„</p></li><li><p>å¯ç´¢å¼•ç±»å‹</p><p>æè¿°é‚£äº›èƒ½å¤Ÿâ€œé€šè¿‡ç´¢å¼•å¾—åˆ°â€çš„ç±»å‹</p><p>å¯ç´¢å¼•ç±»å‹å…·æœ‰ä¸€ä¸ª<em>ç´¢å¼•ç­¾å</em>ï¼Œå®ƒæè¿°äº†å¯¹è±¡ç´¢å¼•çš„ç±»å‹ï¼Œè¿˜æœ‰ç›¸åº”çš„ç´¢å¼•è¿”å›å€¼ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">StringArray</span> &#123;</span><br><span class="line">  [<span class="attr">index</span>: <span class="built_in">number</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">myArray</span>: <span class="title class_">StringArray</span>;</span><br><span class="line">myArray = [<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;Fred&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">myStr</span>: <span class="built_in">string</span> = myArray[<span class="number">0</span>];</span><br></pre></td></tr></table></figure><p>å…±æœ‰æ”¯æŒä¸¤ç§ç´¢å¼•ç­¾åï¼šå­—ç¬¦ä¸²å’Œæ•°å­—ã€‚ å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸¤ç§ç±»å‹çš„ç´¢å¼•ï¼Œä½†æ˜¯æ•°å­—ç´¢å¼•çš„è¿”å›å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç´¢å¼•è¿”å›å€¼ç±»å‹çš„å­ç±»å‹</p><p>å½“ä½¿ç”¨<code>number</code>æ¥ç´¢å¼•æ—¶ï¼Œ<code>JavaScript</code>ä¼šå°†å®ƒè½¬æ¢æˆ<code>string</code>ç„¶åå†å»ç´¢å¼•å¯¹è±¡, å³<code>myArray[0]</code>ä¸<code>myArray['0']</code>æ˜¯ä¸€è‡´çš„</p></li><li><p>æ··åˆç±»å‹</p><p>åœ¨æœ‰äº†æ™®é€šæ¥å£, å‡½æ•°ç±»å‹æ¥å£, å¯ç´¢å¼•ç±»å‹æ¥å£ç­‰å®šä¹‰å½¢å¼ä¹‹å, å°±å¯ä»¥å®ç°æ··åˆç±»å‹æ¥å£</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    (<span class="attr">start</span>: <span class="built_in">number</span>): <span class="built_in">string</span>;</span><br><span class="line">    <span class="attr">interval</span>: <span class="built_in">number</span>;</span><br><span class="line">    <span class="title function_">reset</span>(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCounter</span>(<span class="params"></span>): <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> counter = &lt;<span class="title class_">Counter</span>&gt;<span class="keyword">function</span> (<span class="params"><span class="attr">start</span>: <span class="built_in">number</span></span>) &#123; &#125;;</span><br><span class="line">    counter.<span class="property">interval</span> = <span class="number">123</span>;</span><br><span class="line">    counter.<span class="property">reset</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123; &#125;;</span><br><span class="line">    <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c = <span class="title function_">getCounter</span>();</span><br><span class="line"><span class="title function_">c</span>(<span class="number">10</span>);</span><br><span class="line">c.<span class="title function_">reset</span>();</span><br><span class="line">c.<span class="property">interval</span> = <span class="number">5.0</span>;</span><br></pre></td></tr></table></figure><p><code>getCounter()</code>å‡½æ•°ä¸­, åˆ›å»ºäº†ä¸€ä¸ª<code>Counter</code>çš„å‡½æ•°æ¥å£å®ä¾‹, ç„¶ååˆåœ¨è¿™ä¸ªå®ä¾‹ä¸­æ·»åŠ äº†<code>interval</code>å±æ€§å’Œ<code>reset</code>æ–¹æ³•å®šä¹‰</p><p>åœ¨ä½¿ç”¨æ—¶, ç›´æ¥ä½œä¸ºå‡½æ•°è°ƒç”¨(å¦‚:<code>c(10)</code>)åˆ™å®é™…è°ƒç”¨<code>Counter</code>ä¸­å®šä¹‰çš„åŒ¿åå‡½æ•°</p></li></ol><h3 id="æ³›å‹"><a class="markdownIt-Anchor" href="#æ³›å‹"></a> æ³›å‹</h3><p>åœ¨å®šä¹‰æ¥å£, ç±»å’Œå‡½æ•°æ—¶, å…¶ä¸­çš„æŸä¸ªå±æ€§æˆ–å‚æ•°åœ¨å®šä¹‰æ—¶ä¸ç¡®å®šå…·ä½“ç±»å‹, ä½†åœ¨ä½¿ç”¨æ—¶éœ€è¦ç¡®å®šæ˜¯å“ªç§ç±»å‹, æ­¤æ—¶å°±ç”¨åˆ°æ³›å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> identity&lt;T&gt;(<span class="attr">arg</span>: T): T &#123;</span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®šä¹‰æ—¶ä¸ç¡®å®šæ˜¯å“ªç§ç±»å‹, æ‰€ä»¥ä½¿ç”¨æ³›å‹, ä½†åœ¨è¿è¡Œæ—¶, æ ¹æ®ä¼ å…¥çš„å‚æ•°, æ¨æ–­å‡ºå…·ä½“ç±»å‹</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å½“å®šä¹‰æ¥å£, ç±»å’Œå‡½æ•°ä½¿ç”¨æ³›å‹æ—¶, æ¯ä¸ªæ³›å‹å®šä¹‰åœ¨è¿è¡Œæ—¶åªèƒ½è¯†åˆ«ä¸ºä¸€ç§å®é™…ç±»å‹</p><p>å®šä¹‰çš„æ³›å‹å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å£æˆ–è€…ç±»æ¥å®ç°çº¦æŸ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Lengthwise</span> &#123;</span><br><span class="line">    <span class="attr">length</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> loggingIdentity&lt;T <span class="keyword">extends</span> <span class="title class_">Lengthwise</span>&gt;(<span class="attr">arg</span>: T): T &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(arg.<span class="property">length</span>);  <span class="comment">// Now we know it has a .length property, so no more error</span></span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Typescript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typescript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(äº”)---Redisä½¿ç”¨</title>
      <link href="/2023/12/14/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%BA%94%E4%B9%8BRedis%E4%BD%BF%E7%94%A8/"/>
      <url>/2023/12/14/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%BA%94%E4%B9%8BRedis%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å½“å‰ç¯å¢ƒä¸­, <code>Redis</code>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡å æœ‰é‡è¦çš„ä½ç½®, å…¶ä½œç”¨åŒ…æ‹¬ä½†ä¸é™äºä½œç¼“å­˜, åˆ†å¸ƒå¼é”, åˆ†å¸ƒå¼ä¸»é”®ç­‰, æœ¬ç¯‡è®²è§£<code>Spring</code>é›†æˆ<code>Redis</code>, å°†<code>Redis</code>å¼•å…¥åˆ°é¡¹ç›®ä¸­ä½¿ç”¨.</p><h3 id="å¼•å…¥"><a class="markdownIt-Anchor" href="#å¼•å…¥"></a> å¼•å…¥</h3><h4 id="å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#å¼•å…¥ä¾èµ–"></a> å¼•å…¥ä¾èµ–</h4><p>å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">172.29</span><span class="number">.241</span><span class="number">.128</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è‡ªå·±æ³¨å†Œåç§°ä¸º<code>redisTemplate</code>çš„<code>Bean</code>, æ¡†æ¶ä¼šåœ¨è‡ªåŠ¨å¯¼å…¥é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œä¸€ä¸ª<code>redisTemplate</code>çš„<code>Bean</code>å’Œä¸€ä¸ª<code>stringRedisTemplate</code>çš„<code>Bean</code></p><p><img src="Redis%E7%9A%84%E9%BB%98%E8%AE%A4Bean%E6%B3%A8%E5%86%8C.png" alt="Redisçš„é»˜è®¤Beanæ³¨å†Œ" /></p><p>è‡ªå·±æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>RedisTemplate</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">keySerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        template.setKeySerializer(keySerializer);</span><br><span class="line">        template.setHashKeySerializer(keySerializer);</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; valueSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">        template.setValueSerializer(valueSerializer);</span><br><span class="line">        template.setHashValueSerializer(valueSerializer);</span><br><span class="line"></span><br><span class="line">        template.setDefaultSerializer(valueSerializer);</span><br><span class="line"></span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>Redis</code>å°è£…å·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(String key, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.expire(key, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis expire error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">getExpire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE.equals(redisTemplate.hasKey(key));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis has key error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">del</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(redisTemplate.delete(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">del</span><span class="params">(String... key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> del(Arrays.asList(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">del</span><span class="params">(List&lt;String&gt; keys)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(keys)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.delete(keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key == <span class="literal">null</span> ? <span class="literal">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setNx</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE.equals(redisTemplate.opsForValue().setIfAbsent(key, value));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis setnx error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setNx</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE.equals(redisTemplate.opsForValue().setIfAbsent(key, value, time, TimeUnit.SECONDS));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis setnx error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">incr</span><span class="params">(String key, <span class="type">long</span> delta)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;é€’å¢å› å­å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">decr</span><span class="params">(String key, <span class="type">long</span> delta)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;é€’å‡å› å­å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, -delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">hGet</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title function_">hGet</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hSet</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis hash set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hSet</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hSet(key, map) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis hash set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hSet</span><span class="params">(String key, String item, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis hash set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hSet</span><span class="params">(String key, String item, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> hSet(key, item, value) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis hash set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hDel</span><span class="params">(String key, Object... item)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hHasKey</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hIncr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hDecr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Object&gt; <span class="title function_">sGet</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set get error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sHasKey</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE.equals(redisTemplate.opsForSet().isMember(key, value));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set has key error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sSet</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sSet</span><span class="params">(String key, <span class="type">long</span> time, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">            expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis set size error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sDel</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis expire error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">lGet</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().range(key, start, end);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis expire error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">lSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list size error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">lIndex</span><span class="params">(String key, <span class="type">long</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().index(key, index);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list index error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lPushAll</span><span class="params">(String key, List&lt;Object&gt; value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().leftPushAll(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list left push all error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().leftPushIfPresent(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list left set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> lSet(key, value) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list left set error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lPushAll</span><span class="params">(String key, List&lt;Object&gt; value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> lPushAll(key, value) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list left push all error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rSet</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list right push error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rSet</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> rSet(key, value) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list right push error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rPushAll</span><span class="params">(String key, List&lt;Object&gt; value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list right push all error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">rPushAll</span><span class="params">(String key, List&lt;Object&gt; value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> rPushAll(key, value) &amp;&amp; expire(key, time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list right push all error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSetIndex</span><span class="params">(String key, <span class="type">long</span> index, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list set index element error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">lDel</span><span class="params">(String key, <span class="type">long</span> count, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().remove(key, count, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list delete error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rangeDel</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().trim(key, start, end);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;redis list range delete error:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç®€å•åº”ç”¨"><a class="markdownIt-Anchor" href="#ç®€å•åº”ç”¨"></a> ç®€å•åº”ç”¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;DictTypeMapper, DictTypeEntity&gt; <span class="keyword">implements</span> <span class="title class_">IDictTypeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SentinelResource(&quot;dict-type-list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;DictTypeEntity&gt; <span class="title function_">list</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        redisUtil.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;xiao lin&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;name: &#123;&#125;&quot;</span>, redisUtil.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="Redis%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.png" alt="Redisç®€å•ä½¿ç”¨" /></p><p><img src="Redis%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E4%BF%9D%E5%AD%98.png" alt="Redisç®€å•ä½¿ç”¨ä¿å­˜" /></p><h3 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h3><h4 id="ç¼“å­˜"><a class="markdownIt-Anchor" href="#ç¼“å­˜"></a> ç¼“å­˜</h4><p>åœ¨å¼•å…¥<code>Redis</code>ä¹‹å‰, é€šå¸¸ä½¿ç”¨<code>Map</code>æ¥åšç¼“å­˜, å¼•å…¥<code>Redis</code>ä¹‹å, å°±å¯ä»¥ä½¿ç”¨<code>Redis</code>åšç¼“å­˜äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Objects.isNull(redisUtil.hGet(<span class="string">&quot;key&quot;</span>))) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(redisUtil.hGet(<span class="string">&quot;key&quot;</span>))) &#123;</span><br><span class="line">            redisUtil.hSet(<span class="string">&quot;key&quot;</span>, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(), <span class="number">10</span> * <span class="number">60</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­, å†™å…¥æ—¶éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”, å¤§å¤šæ•°ç¼“å­˜å†…å®¹çš„ä¿®æ”¹æ“ä½œæ¬¡æ•°æ˜¯è¿œå°äºæŸ¥è¯¢æ“ä½œæ¬¡æ•°çš„</p><h4 id="çƒ­ç‚¹æ•°æ®"><a class="markdownIt-Anchor" href="#çƒ­ç‚¹æ•°æ®"></a> çƒ­ç‚¹æ•°æ®</h4><p>çƒ­ç‚¹æ•°æ®ä¸ç¼“å­˜ç›¸ä¼¼, ä¸åŒçš„æ˜¯, çƒ­ç‚¹æ•°æ®å¯èƒ½å­˜åœ¨é¢‘ç¹åœ°ä¿®æ”¹æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    redisUtil.hSet(<span class="string">&quot;good&quot;</span>, <span class="string">&quot;count&quot;</span>, (Integer) redisUtil.hGet(<span class="string">&quot;good&quot;</span>, <span class="string">&quot;count&quot;</span>) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ç¼“å­˜ä¸€æ ·, çƒ­ç‚¹æ•°æ®åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¹Ÿéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</p><h4 id="åˆ†å¸ƒå¼é”"><a class="markdownIt-Anchor" href="#åˆ†å¸ƒå¼é”"></a> åˆ†å¸ƒå¼é”</h4><p>é”å’Œåˆ†å¸ƒå¼é”æ˜¯ä¸€ä¸ªå¤§è¯¾é¢˜, æ­¤å¤„ä»…ä»…æ˜¯æ¼”ç¤ºä¸€ä¸ªæ¡ˆä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="comment">// å­˜åœ¨åˆ™ä¸å¤„ç†, å¹¶è¿”å›false, ä¸å­˜åœ¨åˆ™æ·»åŠ , å¹¶è¿”å›true</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">key</span> <span class="operator">=</span> redisUtil.setNx(<span class="string">&quot;dict_type_add&quot;</span>, value, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (!key) &#123;</span><br><span class="line">    <span class="comment">// dosomething</span></span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// æˆ–è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">r</span> <span class="operator">=</span> (String) redisUtil.get(<span class="string">&quot;dict_type_add&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (value.equalsIgnoreCase(r)) &#123;</span><br><span class="line">        redisUtil.del(<span class="string">&quot;dict_type_add&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºäºä»¥ä¸Šä¼šå‘ç°, åˆ†å¸ƒå¼é”çš„æµç¨‹å¤§è‡´ç›¸ä¼¼, æ‰€ä»¥å¯ä»¥åšä¸€ä¸ªå°è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„çš„Componentæ˜¯ä¸ºäº†æ³¨å…¥RedisUtilä½¿ç”¨, æ­¤å·¥å…·ç±»æœ¬èº«å¹¶ä¸éœ€è¦æ³¨å†Œä¸ºbean</span></span><br><span class="line"><span class="comment">// æˆ–è€…å¯ä»¥åœ¨RedisUtilä¸­ä½¿ç”¨åˆ›å»ºå®Œæˆåç½®æ“ä½œ</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(name = &quot;redisUtil&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RedisUtil REDIS_UTIL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRedisUtil</span><span class="params">(RedisUtil redisUtil)</span> &#123;</span><br><span class="line">        REDIS_UTIL = redisUtil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, Object value, <span class="type">long</span> time,<span class="meta">@NotNull</span> VoidSyncExecutor executor)</span> &#123;</span><br><span class="line">        lock(key, value, time);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executor.exec();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;redis lock error: &quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, <span class="type">long</span> time,<span class="meta">@NotNull</span> VoidSyncExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        lock(key, value, time, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key,<span class="meta">@NotNull</span> VoidSyncExecutor executor)</span> &#123;</span><br><span class="line">        lock(key,<span class="number">10</span>, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; R <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, Object value, <span class="type">long</span> time,<span class="meta">@NotNull</span> TypeSyncExecutor&lt;R&gt; executor)</span> &#123;</span><br><span class="line">        lock(key, value, time);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> executor.exec();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;redis lock error: &quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; R <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, <span class="type">long</span> time,<span class="meta">@NotNull</span> TypeSyncExecutor&lt;R&gt; executor)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">return</span> lock(key, value, time, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;R&gt; R <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key,<span class="meta">@NotNull</span> TypeSyncExecutor&lt;R&gt; executor)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, <span class="number">10</span>, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, Object value, <span class="type">long</span> time,<span class="meta">@NotNull</span> BooleanTypeSyncExecutor executor)</span> &#123;</span><br><span class="line">        lock(key, value, time);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Boolean.TRUE.equals(executor.exec());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;redis lock error: &quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, <span class="type">long</span> time,<span class="meta">@NotNull</span> BooleanTypeSyncExecutor executor)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">return</span> lock(key, value, time, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key,<span class="meta">@NotNull</span> BooleanTypeSyncExecutor executor)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> lock(key, <span class="number">10</span>, executor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NotNull</span> String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦æœ‰é‡è¯•æœºåˆ¶</span></span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™ä¸å¤„ç†, å¹¶è¿”å›false, ä¸å­˜åœ¨åˆ™æ·»åŠ , å¹¶è¿”å›true</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">nx</span> <span class="operator">=</span> REDIS_UTIL.setNx(key, value, time);</span><br><span class="line">        <span class="keyword">if</span> (!nx) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªçº¿ç¨‹åŠ é”</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> REDIS_UTIL.get(key);</span><br><span class="line">            <span class="keyword">if</span> (!(Objects.equals(value, r))) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServiceException</span>(<span class="number">500</span>, <span class="string">&quot;ç³»ç»Ÿè·å–ä¸åˆ°é”&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(<span class="meta">@NotNull</span> String key, Object value)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">r</span> <span class="operator">=</span> REDIS_UTIL.get(key);</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(value, r)) &#123;</span><br><span class="line">            REDIS_UTIL.del(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BooleanTypeSyncExecutor</span> &#123;</span><br><span class="line">        Boolean <span class="title function_">exec</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TypeSyncExecutor</span>&lt;R&gt; &#123;</span><br><span class="line">        R <span class="title function_">exec</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VoidSyncExecutor</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;DictTypeEntity&gt; <span class="title function_">list</span><span class="params">(String type)</span> &#123;</span><br><span class="line"></span><br><span class="line">    DistributedLockUtil.lock(<span class="string">&quot;key&quot;</span>, () -&gt; &#123;</span><br><span class="line">        redisUtil.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;xiao lin&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;name: &#123;&#125;&quot;</span>, redisUtil.get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>Redis</code>è¯¦è§£</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisç³»åˆ—(ä¸€)---å®‰è£…</title>
      <link href="/2023/12/12/redis/Redis%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85/"/>
      <url>/2023/12/12/redis/Redis%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p><code>Redis</code>ä½œä¸ºæ¯”è¾ƒç«çš„<code>NoSQL</code>, å¹¿æ³›åº”ç”¨ä¸åˆ†å¸ƒå¼ç³»ç»Ÿä¸­, ç”±äº<code>Redis</code>æ˜¯åŸºäºå†…å­˜çš„, æè‡´çš„å“åº”é€Ÿåº¦ä½¿å…¶å¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‹…ä»»ä¼—å¤šè§’è‰², å¦‚ç¼“å­˜, åˆ†å¸ƒå¼å…±äº«æ•°æ®, åˆ†å¸ƒå¼é”, åˆ†å¸ƒå¼ä¸»é”®, æ¶ˆæ¯é˜Ÿåˆ—ç­‰</p><p>æœ¬ç¯‡å…ˆè®²å®‰è£…, åœ¨<code>Ubuntu</code>ç³»ç»Ÿä¸‹çš„å®‰è£…, åˆ†åˆ«ä»‹ç»ä¸¤ç§å®‰è£…æ–¹å¼çš„è¿‡ç¨‹</p><p>æœ¬äººæ˜¯åœ¨<code>Windows</code>ä¸‹çš„<code>Ubuntu</code>è¿›è¡Œçš„</p><ol><li><p>é…ç½®å¥½<code>wsl</code>ç¯å¢ƒ</p></li><li><p>æ‰§è¡Œ<code>wsl --install</code>å®‰è£…é»˜è®¤çš„<code>Ubuntu</code>ç³»ç»Ÿæˆ–è€…ä»<code>Store</code>ä¸­å®‰è£…</p></li><li><p>åˆ›å»º<code>Ubuntu</code>ç³»ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç </p></li><li><p>æ›´æ¢æº</p><p>æ¸…åé•œåƒæºé…ç½®è·å–: <a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/</a></p></li></ol><p>å‚è€ƒæ–‡ç« :</p><p><a href="https://zhuanlan.zhihu.com/p/423249278">https://zhuanlan.zhihu.com/p/423249278</a></p><p><a href="https://blog.csdn.net/chigenb/article/details/105641189">https://blog.csdn.net/chigenb/article/details/105641189</a></p><p><a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/</a></p><h3 id="aptå·¥å…·å®‰è£…"><a class="markdownIt-Anchor" href="#aptå·¥å…·å®‰è£…"></a> <code>apt</code>å·¥å…·å®‰è£…</h3><h4 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h4><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install redis-server</span><br></pre></td></tr></table></figure><p>å®‰è£…<code>redis</code>æœåŠ¡, é‡åˆ°è¾“å…¥[Y/n]çš„æç¤ºæ—¶è¾“å…¥<code>y</code>, æˆ–è€…åœ¨å‘½ä»¤ä¹‹åæ·»åŠ <code>-y</code></p><p><img src="Redis%E4%BD%BF%E7%94%A8apt%E5%AE%89%E8%A3%85.png" alt="Redisä½¿ç”¨aptå®‰è£…" /></p><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service redis status</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>redis</code>çš„è¿è¡ŒçŠ¶æ€, ä½¿ç”¨<code>apt</code>å®‰è£…æ—¶, å®‰è£…å®Œæˆåé»˜è®¤ä¼šå¯åŠ¨</p><p><img src="Redis%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81.png" alt="Redisè¿è¡ŒçŠ¶æ€" /></p><p>è¿›å…¥<code>/etc/redis</code>ç›®å½•, æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘<code>redis</code>é…ç½®æ–‡ä»¶, ä¿®æ”¹ä½ç½®</p><ol><li><code>bind 127.0.0.1 ::1</code>è¿™ä¸€è¡Œæ³¨é‡Šæ‰, ä½¿å…¶å¯ä»¥è¿œç¨‹è®¿é—®(æ³¨æ„è®©é˜²ç«å¢™å¼€æ”¾6379ç«¯å£)</li><li><a href="#é—®é¢˜ä¸€">å°†<code>protected-mode</code>çš„å€¼è®¾ç½®ä¸º<code>no</code>, å…³é—­ä¿æŠ¤æ¨¡å¼</a>, å¦åˆ™ä¹Ÿæ— æ³•æ­£å¸¸è¿›è¡Œè¿œç¨‹è®¿é—®</li></ol><p>ç„¶åæ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service redis restart</span><br></pre></td></tr></table></figure><p>é‡æ–°å¯åŠ¨æœåŠ¡</p><h4 id="è¿æ¥"><a class="markdownIt-Anchor" href="#è¿æ¥"></a> è¿æ¥</h4><p>æµ‹è¯•è¿œç¨‹è¿æ¥</p><p>å¯ä»¥ä½¿ç”¨å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h ip</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨å·¥å…·</p><p><img src="Redis%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5.png" alt="Redisè¿œç¨‹è¿æ¥" /></p><p><code>redis</code>é»˜è®¤ä¸æ˜¯ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œ, å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„<code>daemonize</code>é¡¹ä¸º<code>yes</code>æ¥å¯ç”¨å®ˆæŠ¤è¿›ç¨‹</p><h4 id="å¸è½½"><a class="markdownIt-Anchor" href="#å¸è½½"></a> å¸è½½</h4><p>ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove redis-server</span><br></pre></td></tr></table></figure><p>å¸è½½å®‰è£…çš„<code>redis</code>æœåŠ¡</p><h3 id="å‹ç¼©åŒ…å®‰è£…"><a class="markdownIt-Anchor" href="#å‹ç¼©åŒ…å®‰è£…"></a> å‹ç¼©åŒ…å®‰è£…</h3><h4 id="ä¸‹è½½"><a class="markdownIt-Anchor" href="#ä¸‹è½½"></a> ä¸‹è½½</h4><p>åˆ°å®˜ç½‘https://download.redis.ioä¸­å¯»æ‰¾æƒ³è¦çš„ç‰ˆæœ¬ä¸‹è½½, æ›´ç®€å•çš„æ–¹å¼æ˜¯ç›´æ¥ä½¿ç”¨https://download.redis.io/releases/redis-x.y.z.tar.gzä¸‹è½½, å°†<code>xyz</code>åˆ†åˆ«æ”¹ä¸ºç‰ˆæœ¬å¯¹åº”çš„æ•°å­—å³å¯</p><p>æ­¤å¤„ä½¿ç”¨çš„æ˜¯<code>7.2.3</code>ç‰ˆæœ¬</p><p>åœ¨<code>Ubuntu</code>ç³»ç»Ÿä¸­è¿›å…¥åˆ°æƒ³è¦æ”¾ç½®å®‰è£…åŒ…çš„ä½ç½®</p><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget url [-P path] [-o path/name]</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å‹ç¼©åŒ…, æˆ–è€…ç›´æ¥ä½¿ç”¨<code>-P</code>æŒ‡å®šä¸‹è½½åˆ°å“ªä¸ªç›®å½•ä¸‹, æˆ–è€…ä½¿ç”¨<code>-o</code>æŒ‡å®šä¸‹è½½åˆ°ç›®å½•å¹¶å°†æ–‡ä»¶å‘½å</p><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf redis-x.y.z.tar.gz</span><br></pre></td></tr></table></figure><p>å°†ä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹</p><h4 id="å®‰è£…-2"><a class="markdownIt-Anchor" href="#å®‰è£…-2"></a> å®‰è£…</h4><ol><li><p>ç¯å¢ƒ</p><p>æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install gcc &amp;&amp; apt-get install g++</span><br></pre></td></tr></table></figure><p>å®‰è£…<code>c/c++</code>ç¼–è¯‘å™¨</p><p><a href="#é—®é¢˜ä¸‰"><code>redis</code>æ˜¯ä½¿ç”¨<code>c</code>è¯­è¨€å¼€å‘çš„</a></p></li><li><p>ç¼–è¯‘</p><p><a href="#é—®é¢˜äºŒ">è¿›å…¥åˆ°è§£å‹åçš„ç›®å½•ä¸­, å¹¶æ‰§è¡Œ<code>make</code>å‘½ä»¤</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make PREFIX=/usr/local/redis install</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>PREFIX</code>æŒ‡å®šç¨‹åºå­˜æ”¾è·¯å¾„, å¦åˆ™å¯èƒ½ä¼šå°†å¯æ‰§è¡Œæ–‡ä»¶å­˜æ”¾åˆ°<code>/user/local/bin</code>ç›®å½•ä¸‹æˆ–è€…å…¶ä»–ä½ æ‰¾ä¸åˆ°çš„ä½ç½®, åˆ«é—®æˆ‘ä¸ºå•¥çŸ¥é“ğŸ˜‚</p><p><img src="Redis%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4.png" alt="Redisç¼–è¯‘å‘½ä»¤" /></p><p>ç¼–è¯‘æˆåŠŸ</p><p><img src="Redis%E7%BC%96%E8%AF%91%E6%88%90%E5%8A%9F.png" alt="Redisç¼–è¯‘æˆåŠŸ" /></p></li><li><p>å¯åŠ¨</p><p>è¿›å…¥<code>/usr/local/redis/bin</code>ç›®å½•æ‰§è¡Œ<code>redis-server</code>æ–‡ä»¶å¯åŠ¨æœåŠ¡</p><p><img src="Redis%E5%90%AF%E5%8A%A8.png" alt="Rediså¯åŠ¨" /></p></li><li><p>æ³¨å†ŒæœåŠ¡</p><ul><li><p>ä¿®æ”¹<code>/usr/local/redis-7.2.3/utils</code>ç›®å½•ä¸‹çš„<code>install-server.sh</code></p><p><img src="Redis%E8%84%9A%E6%9C%AC%E4%BF%AE%E6%94%B9.png" alt="Redisè„šæœ¬ä¿®æ”¹" /></p><p>å‚è€ƒæ–‡æ¡£: <a href="https://blog.csdn.net/w1014074794/article/details/129367170">https://blog.csdn.net/w1014074794/article/details/129367170</a></p></li><li><p>å°†<code>redis</code>ä¸­çš„é…ç½®æ–‡ä»¶<code>redis.conf</code>å¤åˆ¶åˆ°è„šæœ¬ä¸­çš„ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp redis.conf /etc/redis/redis.conf</span><br></pre></td></tr></table></figure></li><li><p>å°†å¯åŠ¨æœåŠ¡æ–‡ä»¶æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> sudo export PATH=/usr/local/redis/bin:$PATH</span><br><span class="line">sudo source /etc/profile</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $PATH</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç¯å¢ƒå˜é‡æƒ…å†µ</p></li><li><p>æœåŠ¡æ³¨å†Œ</p><p>è¿è¡Œè„šæœ¬<code>install-server.sh</code></p><p><img src="Redis%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C.png" alt="RedisæœåŠ¡æ³¨å†Œè„šæœ¬æ‰§è¡Œ" /></p><p>æ¯”å¦‚æˆ‘å®‰è£…åœ¨äº†<code>/usr/local/redis/bin</code>ä¸‹, åˆ™éœ€è¦å°†è·¯å¾„ä¿®æ”¹</p><p>é»˜è®¤çš„æœåŠ¡åç§°æ˜¯<code>redis_$&#123;port&#125;</code>, è‹¥æ²¡æœ‰ä¿®æ”¹ç«¯å£å·å°±æ˜¯<code>redis_6379</code>, æœåŠ¡æ³¨å†ŒæˆåŠŸåä¼šé»˜è®¤å¯åŠ¨</p></li><li><p>æœåŠ¡å¯åŠ¨å’Œåœæ­¢</p><p>æœåŠ¡æ³¨å†Œåå³å¯ä½¿ç”¨<code>service</code>ç›¸å…³å‘½ä»¤å¯åŠ¨æˆ–åœæ­¢æœåŠ¡, ä¹Ÿå¯æŸ¥çœ‹æœåŠ¡çŠ¶æ€, ä½†æ˜¯æœåŠ¡åç§°ä¸<code>apt-get</code>çš„æ–¹å¼ä¸å¤ªä¸€æ ·, å³æ­¤æ–¹å¼çš„åç§°æ˜¯<code>redis_$&#123;port&#125;</code></p></li></ul></li><li><p>é…ç½®è¿œç¨‹è®¿é—®</p><p>å‚è€ƒ<code>apt</code>å·¥å…·å®‰è£…ä¸­çš„è¿œç¨‹è®¿é—®é…ç½®</p></li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(error) DENIED Redis is running in protected mode ...</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : æœåŠ¡ä½¿ç”¨ä¿æŠ¤æ¨¡å¼å¯åŠ¨, æ— æ³•è¿›è¡Œè¿œç¨‹è®¿é—®</p><p>è§£å†³æ–¹æ¡ˆ: ä¿®æ”¹<code>redis.conf</code>ä¸­çš„<code>protected-mode</code>çš„å€¼ä¸º<code>no</code></p><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><p>é—®é¢˜: æ‰¾ä¸åˆ°<code>make</code>å‘½ä»¤</p><p>é—®é¢˜åŸå› : æ²¡æœ‰å®‰è£…ç¼–è¯‘å·¥å…·</p><p>è§£å†³æ–¹æ¡ˆ: <code>sudo apt-get install make</code>å®‰è£…ç¼–è¯‘å·¥å…·</p><p><i id="é—®é¢˜ä¸‰">é—®é¢˜ä¸‰</i></p><p>é—®é¢˜: ä½¿ç”¨<code>make</code>ç¼–è¯‘æ—¶æŠ¥é”™</p><p>é—®é¢˜åŸå› : å¯èƒ½æ˜¯æ²¡æœ‰å®‰è£…<code>gcc-c++</code></p><p>è§£å†³æ–¹æ¡ˆ: <code>CentOS</code>ä½¿ç”¨<code>yum install gcc-c++</code>å®‰è£…, <code>Ubuntu</code>ä½¿ç”¨<code>apt-get install gcc &amp;&amp; apt-get install g++</code>å®‰è£…, åœ¨å®‰è£…åä½¿ç”¨<code>make clean &amp;&amp; make</code>é‡æ–°ç¼–è¯‘, å¦‚æœä»ä¸æˆåŠŸ, å¯ä»¥å°†è§£å‹çš„ç›®å½•åˆ é™¤é‡æ–°è§£å‹å†ç¼–è¯‘</p><p><i id="é—®é¢˜å››">é—®é¢˜å››</i></p><p>é—®é¢˜: æœåŠ¡æ³¨å†Œåå¯åŠ¨æ—¶å¯èƒ½å¤±è´¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to start redis.service: Unit redis.service failed to load properly, please adjust/correct and reload service manager: File exists See system logs and &#x27;systemctl status redis.service&#x27; for details.</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : å¯èƒ½æ˜¯è¢«ç®¡æ§</p><p>è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨<code>systemctl enable $&#123;service_name&#125;</code>å…è®¸æœåŠ¡è¿è¡Œ, ä½†æ­¤æ–¹å¼åªé€‚ç”¨äºè¢«ç®¡æ§çš„æƒ…å†µ, å¦‚æœæ˜¯å…¶ä»–æƒ…å†µå¯¼è‡´çš„åˆ™æ— æ³•å¤„ç†</p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>Redis</code>çš„ä½¿ç”¨è¯¦æƒ…</p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(å…­)---åˆ†å¸ƒå¼ä¸»é”®</title>
      <link href="/2023/12/11/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%85%AD%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE/"/>
      <url>/2023/12/11/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%85%AD%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%BB%E9%94%AE/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰é¢æ­å»º<code>SpringCloud</code>é¡¹ç›®, ä¸»è¦æ˜¯æ¡†æ¶çš„ä½¿ç”¨, å…¶å®å¯¹äºæ¡†æ¶è€Œè¨€, ä¸€èˆ¬çš„æ¡†æ¶å­¦ä¼šä½¿ç”¨, èƒ½è§£å†³ç”Ÿäº§å’Œå¼€å‘è¿‡ç¨‹ä¸­çš„é—®é¢˜å³å¯, å°‘æ•°ä¼˜ç§€çš„æ¡†æ¶å¯ä»¥å»æ·±å…¥å­¦ä¹ ä¸€ä¸‹æºç , å…¶ä¸­å­¦ä¹ çš„ä¸»è¦ç›®çš„æ˜¯å…¶åŸç†å’Œæ€æƒ³, è€Œä¸æ˜¯å…¶å®ç°, å…¶è®¾è®¡ç†å¿µæœ‰æ²¡æœ‰å¯ä»¥å€Ÿé‰´çš„åœ°æ–¹.</p><p>æœ¬ç¯‡è¦è§£å†³çš„é—®é¢˜æ˜¯åˆ†å¸ƒå¼åº”ç”¨ä¸­çš„ä¸»é”®é—®é¢˜, åˆ†å¸ƒå¼ä¸»é”®æœ€å¥½å¯ä»¥æ»¡è¶³ä¸€ä¸‹è¦æ±‚</p><ul><li>å…¨å±€å”¯ä¸€: è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬è¦æ±‚, å…¶å®åœ¨ä¸åŒçš„å®ä½“è¡¨ä¸­, ä¸»é”®ç›¸åŒæ˜¯ä¸å­˜åœ¨å¼‚å¸¸çš„, å¦‚ç”¨æˆ·è¡¨ä¸­çš„ä¸»é”®ä¸º<code>1</code>ä¸ä¼šå½±å“å­—å…¸ä¸»é”®æ˜¯å¦ä¸º<code>1</code>, ä½†æ­¤ç§æ–¹å¼è¯†åˆ«æ€§å·®, æ‰€ä»¥è¦æ±‚ç”Ÿæˆçš„ä¸»é”®å…¨å±€å”¯ä¸€</li><li>é«˜æ€§èƒ½: ç”Ÿæˆå“åº”è¦å¿«, ä¸èƒ½æˆä¸ºä¸šåŠ¡å“åº”é€Ÿåº¦çš„ç“¶é¢ˆ</li><li>è¶‹åŠ¿é€’å¢: è¶‹åŠ¿é€’å¢åœ¨æ·»åŠ æ•°æ®å’ŒæŸ¥è¯¢æ—¶å¯ä»¥æé«˜æ•ˆç‡</li></ul><p>æ­¤ç³»åˆ—åœ¨æœ¬ç¯‡åæš‚åœä¸€æ®µæ—¶é—´, æ¥ä¸‹æ¥è¿˜æœ‰ç™»å½•æˆæƒ, åˆ†å¸ƒå¼äº‹åŠ¡, é”, æ¶ˆæ¯é˜Ÿåˆ—ç­‰å†…å®¹, ä½†ç”±äºè®¸å¤šå†…å®¹ä¸ä¸šåŠ¡ç›¸å…³, æœ¬äººèƒ½åŠ›æœ‰é™, æ— æ³•æƒ³è±¡å„ç§åœºæ™¯, æ‰€ä»¥å‡†å¤‡ç€æ‰‹åˆ›å»ºä¸€ä¸ªç›¸é…çš„å‰ç«¯é¡¹ç›®, ä¹Ÿå­¦ä¹ å‰ç«¯å†…å®¹, <code>VUE</code>ç³»åˆ—, åœ¨è¯¥ç³»åˆ—ä¸­ä¼šå­¦ä¹ ä½¿ç”¨æ€»ç»“å‰ç«¯å†…å®¹, å¹¶ä¸”ä¼šé…åˆæœ¬é¡¹ç›®å¼€å‘åŸºç¡€åŠŸèƒ½.</p><p>å‰ç«¯é¡¹ç›®æš‚å®šä½¿ç”¨çš„å†…å®¹æœ‰: <code>TypeScript</code>, <code>node</code>, <code>pnpm</code>, <code>vue</code>ç­‰, é©å‘½å°šæœªæˆåŠŸå•Š!</p><h3 id="å®šä¹‰"><a class="markdownIt-Anchor" href="#å®šä¹‰"></a> å®šä¹‰</h3><p>å®šä¹‰ä¸€ä¸ªåˆ†å¸ƒå¼ä¸»é”®æ¥å£, ç„¶åå®šä¹‰å…¶ä¸åŒå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    Serializable <span class="title function_">id</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®ç°"><a class="markdownIt-Anchor" href="#å®ç°"></a> å®ç°</h3><h4 id="uuid"><a class="markdownIt-Anchor" href="#uuid"></a> <code>UUID</code></h4><p><code>UUID</code>çš„æ–¹å¼æ˜¯æœ€å®¹æ˜“å®ç°çš„æ–¹å¼, ä½†ç”±äºç”Ÿæˆçš„å­—ç¬¦ä¸²æ— åº, æ‰€ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UUIDIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é›ªèŠ±ç®—æ³•"><a class="markdownIt-Anchor" href="#é›ªèŠ±ç®—æ³•"></a> é›ªèŠ±ç®—æ³•</h4><p>é›ªèŠ±ç®—æ³•æ˜¯å¸¸ç”¨çš„ä¸»é”®ç”Ÿæˆç­–ç•¥, å…¶ç”Ÿæˆçš„æ•°å­—æ˜¯æœ‰åºçš„, ç»“æ„å°†ä¸€ä¸ªé•¿æ•´å‹æ•°å€¼åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†:</p><ul><li>ç¬¦å·ä½: å ç”¨ä¸€ä¸ª<code>bit</code>ä½, å®šä¹‰ä¸º0, å³æ°¸è¿œä¸ºæ­£æ•°, ä¸å˜</li><li>æ—¶é—´ä½: å ç”¨41ä¸ª<code>bit</code>ä½, æ—¶é—´åç§»é‡</li><li>å·¥ä½œæœºå™¨ä½: å ç”¨10ä¸ª<code>bit</code>ä½, æŒ‡æ˜ç”Ÿæˆä¸»é”®çš„æœºå™¨</li><li>åºåˆ—å·ä½: å ç”¨12ä¸ª<code>bit</code>ä½, è½®è¯¢ç”Ÿæˆåºåˆ—å·</li></ul><blockquote><p>æ³¨æ„:</p><ol><li>å¦‚æœæœºå™¨å‘ç”Ÿäº†æ—¶é—´å›é€€, åˆ™æœ‰å¯èƒ½äº§ç”Ÿé‡å¤å€¼, ä½†æ¦‚ç‡å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡</li><li>é›ªèŠ±ç®—æ³•åœ¨åˆ†å¸ƒå¼ä¸­ä¹Ÿæ— æ³•ä¿è¯å…ˆç”Ÿæˆçš„æ•°æ®ä¸€å®šå°äºåç”Ÿæˆçš„æ•°æ®, è¿™ä¸æ¯å°æœºå™¨çš„æœºå™¨æ—¶é—´å’Œå®šä¹‰çš„æœºå™¨å·æœ‰å…³</li></ol></blockquote><p>å®ç°æ­¥éª¤:</p><ol><li><p>å®šä¹‰å¸¸é‡: æ—¶é—´æˆ³åç§»åŸç‚¹, åºåˆ—å·ä½æ•°, åºåˆ—å·æœ€å¤§å€¼, æœºå™¨å·ä½æ•°, æœºå™¨å·æœ€å¤§å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·å ç”¨ä½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_BIT</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœºå™¨å ç”¨ä½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MACHINE_BIT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ—¶é—´åç§»çš„åæ ‡åŸç‚¹</span></span><br><span class="line"><span class="comment"> * æ­¤å¤„ä½¿ç”¨2020å¹´1æœˆ1æ—¥0æ—¶0åˆ†0ç§’000æ¯«ç§’</span></span><br><span class="line"><span class="comment"> * å¯è‡ªå®šä¹‰æ—¶é—´åæ ‡åŸç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">START_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1577808000000L</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_MAX</span> <span class="operator">=</span> ~ (-<span class="number">1</span> &lt;&lt; SEQUENCE_BIT); <span class="comment">// 1 &lt;&lt; SEQUENCE_BIT - 1 æŒ‰ä½å–åå°±æ˜¯ -1 &lt;&lt; SEQUENCE_BIT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœºå™¨å·æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MACHINE_MAX</span> <span class="operator">=</span> ~ (-<span class="number">1</span> &lt;&lt; MACHINE_BIT);</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰å˜é‡: æœºå™¨å·(åˆå§‹åŒ–ä¸€æ¬¡å³å¯), æœºå™¨ä½(åˆå§‹åŒ–ä¸€æ¬¡å³å¯), åºåˆ—å·(åˆå§‹æ˜¯ä¸ºé»˜è®¤å€¼)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“å‰åºåˆ—å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“å‰æœºå™¨å·</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–åä¸åœ¨æ”¹å˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> machineId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> machine;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å™¨, åˆ›å»ºæ—¶æ·»åŠ æœºå™¨å·å‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> machineId æœºå™¨å·</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalAccessException   å‚æ•°å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SnowflakeIdGenerator</span><span class="params">(<span class="type">long</span> machineId)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">    <span class="keyword">if</span> (machineId &gt; MACHINE_MAX) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalAccessException</span>(<span class="string">&quot;æœºå™¨å·å¤§äºè¦æ±‚çš„æœ€å¤§å€¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.machineId = machineId;</span><br><span class="line">    <span class="comment">// æœºå™¨å·æ‰€å ä½ä¸º æœºå™¨å·å‘å·¦åç§»SEQUENCE_BIT</span></span><br><span class="line">    machine = machineId &lt;&lt; SEQUENCE_BIT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰å„ä¸ªéƒ¨åˆ†çš„å®ç°</p><p>æ—¶é—´æˆ³ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ—¶é—´æˆ³ä½çš„å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  æ—¶é—´æˆ³ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timestamp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ—¶é—´æˆ³åç§»é‡æŒ‰ä½å·¦ç§» æœºå™¨å·ä½æ•°+åºåˆ—å·ä½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> timestampOffset() &lt;&lt; (MACHINE_BIT + SEQUENCE_BIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å½“å‰æ—¶é—´æˆ³åç§»é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  æ—¶é—´æˆ³åç§»é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timestampOffset</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">return</span> l - START_TIMESTAMP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœºå™¨ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœºå™¨ä½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  æœºå™¨ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">machine</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> machine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åºåˆ—å·ä½</p><p>æ–¹æ¡ˆä¸€: æ‰€æœ‰æ—¶é—´æˆ³ä½¿ç”¨å…±åŒçš„åºåˆ—å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™é‡ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">        seq = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    seq ++;</span><br><span class="line">    <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ—¶é—´æˆ³ä½¿ç”¨å•ç‹¬çš„åºåˆ—å·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">(<span class="type">long</span> timestamp)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ—¶é—´æˆ³å°äºæœ€åä¸€æ¬¡çš„æ—¶é—´æˆ³æ—¶, è¿”å›-1</span></span><br><span class="line">    <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ—¶é—´æˆ³å¤§äºä¸Šæ¬¡çš„æ—¶é—´æˆ³, åˆ™é‡ç½®åºåˆ—å·</span></span><br><span class="line">    <span class="keyword">if</span> (timestamp &gt; lastTimestamp) &#123;</span><br><span class="line">        sequence = -<span class="number">1</span>;</span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™è¿”å› -1, è¿™æ˜¯ç”±äºåŒä¸€ä¸ªæ—¶é—´æˆ³ä¸­ç”Ÿæˆäº†å¤§äºåºåˆ—å·æœ€å¤§æ•°çš„ä¸»é”®</span></span><br><span class="line">    <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    seq ++;</span><br><span class="line">    <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ä¸»é”®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">id</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Long.MAX_VALUE &amp; timestamp() | machine() | sequence();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¼˜åŒ–</p><ul><li><p>åˆ†å¸ƒå¼æœåŠ¡ä¸­ä¿è¯å”¯ä¸€æ€§</p><p>è¿™ä¸ªæ˜¯é€šè¿‡å·¥ä½œæœºå™¨å·å®ç°çš„, ä¸åŒçš„æœåŠ¡ä½¿ç”¨ä¸åŒçš„æœºå™¨å·, è¿˜å¯ä»¥æ›´ç»†åˆ†, å°†æœºå™¨å·åˆ†ä¸ºæ•°æ®ä¸­å¿ƒ+æœºå™¨å·, å…±å ç”¨10ä½å³å¯</p></li><li><p>å¤šçº¿ç¨‹ä¸‹çš„åºåˆ—å·å˜é‡çš„å®‰å…¨é—®é¢˜</p><p>ä½¿ç”¨åŒæ­¥å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™é‡ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">        seq = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    seq ++;</span><br><span class="line">    <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">(<span class="type">long</span> timestamp)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ—¶é—´æˆ³å°äºæœ€åä¸€æ¬¡çš„æ—¶é—´æˆ³æ—¶, è¿”å›-1</span></span><br><span class="line">    <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ—¶é—´æˆ³å¤§äºä¸Šæ¬¡çš„æ—¶é—´æˆ³, åˆ™é‡ç½®åºåˆ—å·</span></span><br><span class="line">    <span class="keyword">if</span> (timestamp &gt; lastTimestamp) &#123;</span><br><span class="line">        sequence = -<span class="number">1</span>;</span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™è¿”å› -1, è¿™æ˜¯ç”±äºåŒä¸€ä¸ªæ—¶é—´æˆ³ä¸­ç”Ÿæˆäº†å¤§äºåºåˆ—å·æœ€å¤§æ•°çš„ä¸»é”®</span></span><br><span class="line">    <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    seq ++;</span><br><span class="line">    <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>ç–‘é—®</p><ul><li><p>åºåˆ—å·ä¸ºä»€ä¹ˆå¯ä»¥ä¸åœ¨æ¯ä¸ªæ—¶é—´æˆ³ä¸­éƒ½é‡ç½®</p><p>ä¸€: åºåˆ—å·åœ¨ä¸»é”®ç”Ÿæˆçš„å½±å“åº¦æ˜¯è¿œå°äºæ—¶é—´æˆ³çš„å½±å“åº¦çš„, æ‰€ä»¥å³ä½¿åœ¨ä¸åŒçš„æ—¶é—´æˆ³ä½¿ç”¨ç›¸åŒçš„åºåˆ—å·ç¼“å­˜ä¹Ÿæ˜¯ä¸å½±å“æ•´ä½“ä¸»é”®é¡ºåºçš„, å…¶å½±å“æ€§æ˜¯åœ¨è¾¾åˆ°æœ€å¤§å€¼æ—¶, åœ¨åŒä¸€ä¸ªæ—¶é—´æˆ³ä¸­ç”Ÿæˆä¸»é”®æ—¶ä¼šäº§ç”Ÿåç”Ÿæˆçš„ä¸»é”®å°äºå…ˆç”Ÿæˆçš„ä¸»é”®çš„æƒ…å†µ, ä½†æ˜¯è¿™ç§æƒ…å†µæ˜¯å¯ä»¥æ¥å—çš„, æ‰€ä»¥æ²¡æœ‰å¿…è¦åœ¨æ¯æ¬¡ç”Ÿæˆæ—¶éƒ½åˆ¤æ–­æ˜¯å¦æ˜¯ä¸åŒçš„æ—¶é—´æˆ³ç„¶åé€‰æ‹©æ˜¯å¦é‡ç½®åºåˆ—å·çš„æ“ä½œ</p><p>äºŒ: å½“åºåˆ—å·åœ¨åŒä¸€ä¸ªæ—¶é—´æˆ³ä¸­è¾¾åˆ°æœ€å¤§å€¼åè¿›è¡Œé‡ç½®æ“ä½œ, ç„¶ååˆåœ¨è¯¥æ—¶é—´æˆ³è¾¾åˆ°äº†æœ€å¤§å€¼, è¿™ä¸ªé—®é¢˜æœ¬èº«ä¸æ˜¯æ­¤ç§åºåˆ—å·æ–¹å¼çš„é—®é¢˜, è€Œæ˜¯ç”Ÿæˆçš„æ•°æ®é‡çš„é—®é¢˜. åºåˆ—å·å¯ä»¥äº§ç”Ÿ~(-1 &lt;&lt; 12)ä¸ªæ•°å€¼, äº§ç”Ÿäº†è¿™ä¸ªé—®é¢˜è¯´æ˜è¦æ±‚åœ¨1æ¯«ç§’ä¹‹å†…ç”Ÿæˆå¤§äºè¯¥æ•°é‡çš„å€¼, æ— è®ºæ˜¯å“ªç§åºåˆ—å·ç”Ÿæˆæ–¹å¼éƒ½ä¸å¯èƒ½åœ¨1æ¯«ç§’å†…ç”Ÿæˆå¤§äºæœ€å¤§æ•°é‡çš„ä¸é‡å¤å€¼</p></li></ul></li><li><p>å…¨éƒ¨å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowflakeIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·å ç”¨ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_BIT</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨å ç”¨ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MACHINE_BIT</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´åç§»çš„åæ ‡åŸç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">START_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1577808000000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_MAX</span> <span class="operator">=</span> ~ (-<span class="number">1</span> &lt;&lt; SEQUENCE_BIT); <span class="comment">// 1 &lt;&lt; SEQUENCE_BIT - 1 æŒ‰ä½å–åå°±æ˜¯ -1 &lt;&lt; SEQUENCE_BIT</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨å·æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MACHINE_MAX</span> <span class="operator">=</span> ~ (-<span class="number">1</span> &lt;&lt; MACHINE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰åºåˆ—å·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½“å‰æœºå™¨å·</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–åä¸åœ¨æ”¹å˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> machineId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> machine;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> lastTimestamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ å™¨, åˆ›å»ºæ—¶æ·»åŠ æœºå™¨å·å‚æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> machineId æœºå™¨å·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException   å‚æ•°å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SnowflakeIdGenerator</span><span class="params">(<span class="type">long</span> machineId)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">if</span> (machineId &gt; MACHINE_MAX) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalAccessException</span>(<span class="string">&quot;æœºå™¨å·å¤§äºè¦æ±‚çš„æœ€å¤§å€¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.machineId = machineId;</span><br><span class="line">        <span class="comment">// æœºå™¨å·æ‰€å ä½ä¸º æœºå™¨å·å‘å·¦åç§»SEQUENCE_BIT</span></span><br><span class="line">        machine = machineId &lt;&lt; SEQUENCE_BIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆä¸»é”®ç”±æ—¶é—´æˆ³å’Œåºåˆ—å·çš„ä¸¤ç§æ–¹æ¡ˆ, æ–¹æ¡ˆäºŒæ›´å®Œå–„äº›, æ–¹æ¡ˆä¸€ä¹Ÿå¯ç”¨</span></span><br><span class="line">    <span class="comment">// æ–¹æ¡ˆä¸€</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.MAX_VALUE &amp; timestamp() | machine() | sequence();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ–¹æ¡ˆäºŒ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> sequence;</span><br><span class="line">        <span class="type">long</span> timestamp;</span><br><span class="line">        <span class="comment">// å¾ªç¯, è¿”å›çš„åºåˆ—å€¼å°äº0æ—¶, åˆ™é‡æ–°è®¡ç®—</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            timestamp = timestamp();</span><br><span class="line">            sequence = sequence(timestamp);</span><br><span class="line">        &#125; <span class="keyword">while</span> (sequence &lt; <span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;time: &quot;</span> + timestamp + <span class="string">&quot;; sequence: &quot;</span> + sequence);</span><br><span class="line">        <span class="keyword">return</span> Long.MAX_VALUE &amp; timestamp | machine() | sequence;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™é‡ç½®</span></span><br><span class="line">        <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">            seq = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        seq ++;</span><br><span class="line">        <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">        <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timestamp æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  åºåˆ—å·ä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">sequence</span><span class="params">(<span class="type">long</span> timestamp)</span> &#123;</span><br><span class="line">        <span class="comment">// å½“å‰æ—¶é—´æˆ³å°äºæœ€åä¸€æ¬¡çš„æ—¶é—´æˆ³æ—¶, è¿”å›-1</span></span><br><span class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ—¶é—´æˆ³å¤§äºä¸Šæ¬¡çš„æ—¶é—´æˆ³, åˆ™é‡ç½®åºåˆ—å·</span></span><br><span class="line">        <span class="keyword">if</span> (timestamp &gt; lastTimestamp) &#123;</span><br><span class="line">            sequence = -<span class="number">1</span>;</span><br><span class="line">            lastTimestamp = timestamp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰åºåˆ—å·çš„å€¼</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">seq</span> <span class="operator">=</span> sequence;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦è¾¾åˆ°æœ€å¤§åºåˆ—å€¼, è¾¾åˆ°åˆ™è¿”å› -1, è¿™æ˜¯ç”±äºåŒä¸€ä¸ªæ—¶é—´æˆ³ä¸­ç”Ÿæˆäº†å¤§äºåºåˆ—å·æœ€å¤§æ•°çš„ä¸»é”®</span></span><br><span class="line">        <span class="keyword">if</span> (seq == SEQUENCE_MAX) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        seq ++;</span><br><span class="line">        <span class="comment">// å°†æ–°çš„åºåˆ—å€¼èµ‹ç»™å˜é‡å¹¶è¿”å›</span></span><br><span class="line">        <span class="type">return</span> <span class="variable">sequence</span> <span class="operator">=</span> seq;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœºå™¨ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æœºå™¨ä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">machine</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> machine;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ—¶é—´æˆ³ä½çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ—¶é—´æˆ³ä½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timestamp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ—¶é—´æˆ³åç§»é‡æŒ‰ä½å·¦ç§» æœºå™¨å·ä½æ•°+åºåˆ—å·ä½æ•°</span></span><br><span class="line">        <span class="keyword">return</span> timestampOffset() &lt;&lt; (MACHINE_BIT + SEQUENCE_BIT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰æ—¶é—´æˆ³åç§»é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  æ—¶é—´æˆ³åç§»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timestampOffset</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() - START_TIMESTAMP;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> <code>Redis</code></h4><p><code>Redis</code>ä¸»é”®ç­–ç•¥ä¹Ÿæ˜¯å¸¸ç”¨çš„åˆ†å¸ƒå¼ä¸»é”®ç­–ç•¥ä¹‹ä¸€</p><p><code>Redis</code>ä¸»é”®ç­–ç•¥éœ€è¦æ³¨æ„çš„ç‚¹æœ‰:</p><ul><li>æŒä¹…åŒ–, é¿å…<code>Redis</code>é‡å¯å¯¼è‡´çš„ä¸»é”®é‡ç½®</li><li>è®¾ç½®èµ·å§‹å€¼å’Œæ­¥é•¿, é¿å…å¤šä¸ª<code>Redis</code>æœåŠ¡(é›†ç¾¤)çš„å¯¼è‡´çš„ä¸»é”®é‡å¤é—®é¢˜(<code>MySql</code>æ•°æ®åº“ä¹Ÿå¯é€šè¿‡è¿™ç§æ–¹å¼è·å¾—ä¸é‡å¤çš„ä¸»é”®)</li><li>å¯èƒ½è¿˜æœ‰å…¶ä»–é—®é¢˜, æˆ‘æš‚æ—¶æ²¡æƒ³åˆ°</li></ul><p>å®ç°æ­¥éª¤</p><ol><li><p>ç¯å¢ƒ</p><p>æœ¬æ¬¡çš„<code>Redis</code>ä¸»é”®ç­–ç•¥æ˜¯åŸºäºä¸Šä¸€ç¯‡ä¸­å¼•å…¥çš„<code>Redis</code>å’Œåˆ†å¸ƒå¼é”</p></li><li><p>å®ç°</p><p><code>Redis</code>ä¸»é”®ç­–ç•¥å¯ä»¥æœ‰ä¸¤ç§æ¨¡å¼, ä¸€ç§æ˜¯å•ä¸ªä¸»é”®æ¨¡å¼, ä¸€ç§æ˜¯ç¼“å­˜ä¸»é”®æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RedisUtil redisUtil;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å¯ç”¨ç¼“å­˜æ¨¡å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> startValue;</span><br></pre></td></tr></table></figure></li><li><p>å•ä¸ªä¸»é”®æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment"> * æ­¥é•¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> step;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Long <span class="title function_">singletonId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> DistributedLockUtil.lock(<span class="string">&quot;distributed_redis_id_generator_lock&quot;</span>, () -&gt; &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">id</span> <span class="operator">=</span> redisUtil.get(<span class="string">&quot;distributed_redis_id&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!Objects.isNull(id)) &#123;</span><br><span class="line">            result = Long.parseLong(id.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        redisUtil.set(<span class="string">&quot;distributed_redis_id&quot;</span>, result + step);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¼“å­˜ä¸»é”®æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜ä¸»é”®æ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ªä¸»é”®å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> next;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment"> * å‰©ä½™ä¸»é”®æ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> rest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Long <span class="title function_">cacheId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> DistributedLockUtil.lock(<span class="string">&quot;distributed_redis_id_generator_lock&quot;</span>, () -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (rest &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            rest --;</span><br><span class="line">            <span class="keyword">return</span> next ++;</span><br><span class="line">        &#125;</span><br><span class="line">        next = <span class="number">0L</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">id</span> <span class="operator">=</span> redisUtil.get(<span class="string">&quot;distributed_redis_id&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!Objects.isNull(id)) &#123;</span><br><span class="line">            next = Long.parseLong(id.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        rest = size;</span><br><span class="line">        redisUtil.set(<span class="string">&quot;distributed_redis_id&quot;</span>, next + size);</span><br><span class="line">        rest --;</span><br><span class="line">        <span class="keyword">return</span> next ++;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç–‘é—®</p><p>å…³äºä¸»é”®æŒä¹…åŒ–, è¯·äº¤ç»™<code>Redis</code>çš„æŒä¹…åŒ–å¤„ç†, åœ¨<code>Redis</code>æœåŠ¡åœæ­¢æˆ–è€…å®•æœºé‡å¯æ—¶, éœ€è¦å°†<code>Redis</code>æŒä¹…åŒ–å†…å®¹é‡æ–°å†™å…¥å†…å­˜, æ­¤æ—¶<code>Redis</code>ä¸­ç”¨äºä¸»é”®ç”Ÿæˆçš„å†…å®¹å€¼, æœ€å¥½åœ¨åŸå€¼çš„åŸºç¡€ä¸Šå¢åŠ ä¸€å®šæ•°é‡çš„å€¼, é¿å…æŒä¹…åŒ–æ»åå¸¦æ¥çš„ä¸»é”®é‡å¤é—®é¢˜</p></li><li><p>å…¨éƒ¨å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦å¯ç”¨ç¼“å­˜æ¨¡å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> startValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜ä¸»é”®æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment">     * ä¸‹ä¸€ä¸ªä¸»é”®å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment">     * å‰©ä½™ä¸»é”®æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rest;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éç¼“å­˜æ¨¡å¼ä¸‹å¯ç”¨</span></span><br><span class="line"><span class="comment">     * æ­¥é•¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> step;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdGenerator</span><span class="params">(RedisUtil redisUtil, <span class="type">boolean</span> cache, <span class="type">long</span> startValue, <span class="type">int</span> size, <span class="type">int</span> step)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisUtil = redisUtil;</span><br><span class="line">        <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        <span class="comment">// ç¼“å­˜æ¨¡å¼ä½¿ç”¨é•¿åº¦</span></span><br><span class="line">        <span class="keyword">if</span> (cache &amp;&amp; size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalAccessException</span>(<span class="string">&quot;ç¼“å­˜æ¨¡å¼ä¸‹ç¼“å­˜é•¿åº¦å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        <span class="built_in">this</span>.next = <span class="number">0L</span>;</span><br><span class="line">        <span class="built_in">this</span>.rest = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// ç¼“å­˜æ¨¡å¼ä¸ä½¿ç”¨æ­¥é•¿</span></span><br><span class="line">        <span class="keyword">if</span> (!cache &amp;&amp; step &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalAccessException</span>(<span class="string">&quot;éç¼“å­˜æ¨¡å¼ä¸‹æ­¥é•¿å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.step = step;</span><br><span class="line">        <span class="built_in">this</span>.startValue = startValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdGenerator</span><span class="params">(RedisUtil redisUtil, <span class="type">boolean</span> cache, <span class="type">long</span> startValue, <span class="type">int</span> size)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="built_in">this</span>(redisUtil, cache, startValue, size, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdGenerator</span><span class="params">(RedisUtil redisUtil, <span class="type">boolean</span> cache, <span class="type">long</span> startValue)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="built_in">this</span>(redisUtil, cache, startValue, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">id</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache ? cacheId() : singletonId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long <span class="title function_">singletonId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DistributedLockUtil.lock(<span class="string">&quot;distributed_redis_id_generator_lock&quot;</span>, () -&gt; &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> startValue;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">id</span> <span class="operator">=</span> redisUtil.get(<span class="string">&quot;distributed_redis_id&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(id)) &#123;</span><br><span class="line">                result = Long.parseLong(id.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            redisUtil.set(<span class="string">&quot;distributed_redis_id&quot;</span>, result + step);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long <span class="title function_">cacheId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DistributedLockUtil.lock(<span class="string">&quot;distributed_redis_id_generator_lock&quot;</span>, () -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (rest &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                rest --;</span><br><span class="line">                <span class="keyword">return</span> next ++;</span><br><span class="line">            &#125;</span><br><span class="line">            next = startValue;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">id</span> <span class="operator">=</span> redisUtil.get(<span class="string">&quot;distributed_redis_id&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!Objects.isNull(id)) &#123;</span><br><span class="line">                next = Long.parseLong(id.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            rest = size;</span><br><span class="line">            redisUtil.set(<span class="string">&quot;distributed_redis_id&quot;</span>, next + size);</span><br><span class="line">            rest --;</span><br><span class="line">            <span class="keyword">return</span> next ++;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç­–ç•¥é€‰æ‹©é…ç½®"><a class="markdownIt-Anchor" href="#ç­–ç•¥é€‰æ‹©é…ç½®"></a> ç­–ç•¥é€‰æ‹©é…ç½®</h3><h4 id="é…ç½®æ–‡ä»¶"><a class="markdownIt-Anchor" href="#é…ç½®æ–‡ä»¶"></a> é…ç½®æ–‡ä»¶</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">project:</span></span><br><span class="line">  <span class="attr">id:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">cache:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">size:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">step:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">start-value:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">snowflake:</span></span><br><span class="line">      <span class="attr">machine-id:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="é…ç½®è¯»å–"><a class="markdownIt-Anchor" href="#é…ç½®è¯»å–"></a> é…ç½®è¯»å–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;project.id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IdGeneratorConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">IdType</span> <span class="variable">type</span> <span class="operator">=</span> IdType.UUID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RedisGeneratorConfig</span> <span class="variable">redis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisGeneratorConfig</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">SnowflakeGeneratorConfig</span> <span class="variable">snowflake</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorConfig</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;idGenerator&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> IdGenerator <span class="title function_">idGenerator</span><span class="params">(RedisUtil redisUtil)</span> <span class="keyword">throws</span> IllegalAccessException &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> SNOWFLAKE: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SnowflakeIdGenerator</span>(snowflake.getMachineId());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> REDIS: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisIdGenerator</span>(redisUtil, redis.getCache(), redis.getStartValue(), redis.getSize());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> UUID: &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UUIDIdGenerator</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RedisGeneratorConfig</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">cache</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="variable">startValue</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCache</span><span class="params">(<span class="type">boolean</span> cache)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.cache = cache;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.size = size &gt; <span class="number">0</span> ? size : <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStep</span><span class="params">(<span class="type">int</span> step)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.step = step &gt; <span class="number">0</span> ? step : <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStartValue</span><span class="params">(<span class="type">int</span> startValue)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.startValue = startValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SnowflakeGeneratorConfig</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="variable">machineId</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">IdType</span> &#123;</span><br><span class="line">    UUID,</span><br><span class="line">    SNOWFLAKE,</span><br><span class="line">    REDIS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>é—®é¢˜: ç”Ÿæˆçš„ä¸»é”®é•¿äºæ•°æ®åº“ä¸»é”®å­—æ®µé•¿åº¦</p><p>é—®é¢˜åŸå› : å»ºè¡¨æ—¶, æ•°æ®åº“ä¸»é”®ä½¿ç”¨çš„æ˜¯<code>int</code>ç±»å‹, ä¸»é”®ç”Ÿæˆä¸­ä½¿ç”¨çš„æ˜¯å­—ç¬¦ä¸²æˆ–è€…<code>long</code>å‹, å¯¼è‡´æ•°æ®åº“ä¸»é”®å­—æ®µæ— æ³•å­˜å‚¨</p><p>è§£å†³åŠæ³•: ä¿®æ”¹æ•°æ®åº“å­—æ®µç±»å‹, å»ºè®®ä¸º<code>bigint</code>, ç”Ÿæˆä¸»é”®ä½¿ç”¨<code>long</code>å‹</p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> åˆ†å¸ƒå¼ä¸»é”® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(å››)---ç½‘å…³</title>
      <link href="/2023/12/10/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%9B%9B%E4%B9%8B%E7%BD%91%E5%85%B3/"/>
      <url>/2023/12/10/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E5%9B%9B%E4%B9%8B%E7%BD%91%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>ä¸ºäº†ä¸æš´éœ²æœåŠ¡å™¨æƒ…å†µ, ä¹Ÿä¸ºäº†å®ç°è¯·æ±‚çš„<code>host</code>ç»Ÿä¸€, æ·»åŠ ç½‘å…³ä½œä¸ºè¯·æ±‚çš„ä¸­è½¬ç«™, å®ç°è¯·æ±‚è·¯ç”±.</p><p>æœ¬æ¬¡é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯<code>SpringCloud</code>å®˜æ–¹æ¨èçš„<code>Gateway</code>ç½‘å…³, ä¾ç„¶å»¶ç»­æŒ–å‘çš„æ€æƒ³, æœ¬ç¯‡åªä»‹ç»åœ¨é¡¹ç›®ä¸­ä½¿ç”¨<code>Gateway</code>, å¯¹äº<code>Gateway</code>çš„è¯¦ç»†ä½¿ç”¨å’Œé…ç½®, æŒ–å‘ğŸ˜…</p><h3 id="å¼•å…¥ç½‘å…³"><a class="markdownIt-Anchor" href="#å¼•å…¥ç½‘å…³"></a> å¼•å…¥ç½‘å…³</h3><h4 id="åˆ›å»ºç½‘å…³é¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºç½‘å…³é¡¹ç›®"></a> åˆ›å»ºç½‘å…³é¡¹ç›®</h4><p>å‚è€ƒåˆ›å»ºæœåŠ¡çš„æ–‡ç« , åˆ›å»ºä¸€ä¸ªç½‘å…³çš„<code>SpringBoot</code>å­é¡¹ç›®</p><h4 id="æ·»åŠ ä¾èµ–"><a class="markdownIt-Anchor" href="#æ·»åŠ ä¾èµ–"></a> æ·»åŠ ä¾èµ–</h4><p>ç½‘å…³å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ³¨å†Œä¸­å¿ƒ, å¯»æ‰¾æœåŠ¡ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ç½‘å…³ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4><ol><li><p>å¯ç”¨æ³¨å†Œä¸­å¿ƒ</p><p><code>@EnableDiscoveryClient</code>å¯ç”¨<code>Zookeeper</code>æ³¨å†Œä¸­å¿ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayServiceApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®è·¯ç”±</p><p>æ–¹å¼ä¸€:</p><p>ä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">root:</span> <span class="string">/services/dev</span></span><br><span class="line">        <span class="attr">instance-port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">instance-host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">instance-id:</span> <span class="string">gateway-service-01</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">structure-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://structure-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">patterns:</span> <span class="string">/structure/**</span></span><br><span class="line"><span class="comment">#          filters:</span></span><br><span class="line"><span class="comment">#            - args:</span></span><br><span class="line"><span class="comment">#              name:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">dict-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://dict-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/dict/**</span></span><br></pre></td></tr></table></figure><p>é…ç½®è·¯ç”±çš„<code>predicates</code>å’Œ<code>filters</code>æœ‰ä¸¤ç§æ–¹å¼</p><ol><li>ä½¿ç”¨<code>key=value</code>çš„æ ¼å¼: è¿™ç§æ ¼å¼æœ‰ä¸¤ç§ç±»å‹, ä¸€ç§æ˜¯<code>type=key,value</code>å¦‚<code>- Query=param,name</code>; ä¸€ç§æ˜¯<code>type=value</code>, å¦‚<code>- Path=/xxx/**</code>, <code>type</code>å³ç­–ç•¥ç±»å‹, <code>key</code>è¡¨ç¤º<code>args</code>ä¸­çš„<code>key</code>, <code>value</code>è¡¨ç¤ºè¯¥<code>key</code>å¯¹åº”çš„å€¼</li><li>ä½¿ç”¨<code>map</code>çš„æ ¼å¼: è¿™ç§æ ¼å¼è¦æ±‚æ¯ä¸€ä¸ªé…ç½®é¡¹éƒ½æœ‰ä¸€ä¸ªåç§°å’Œä¸€ä¸ªå‚æ•°åˆ—è¡¨, åç§°å³æ˜¯æ¯ä¸€ä¸ªé…ç½®é¡¹çš„<code>type</code>, å¦‚<code>Path</code>, <code>Query</code>, <code>Header</code>ç­‰, å‚æ•°æ˜¯ä¸€ä¸ª<code>map</code>, <code>map</code>å¯¹åº”çš„<code>key</code>å€¼æ˜¯ç”±è¦æ±‚çš„, å¯ä»¥é€šè¿‡<code>XxxRoutePredicateFactory</code>ç±»ä¸­<code>shortcutFieldOrder</code>æ–¹æ³•ä¸­å®šä¹‰äº†å“ªäº›<code>key</code>æ¥è¿›è¡ŒæŸ¥çœ‹, å¦‚<code>PathRoutePredicateFactory</code>ä¸­çš„<code>shortcutFieldOrder</code>æ–¹æ³•å®šä¹‰äº†<code>patterns</code>å’Œ<code>matchTrailingSlash</code>ä¸¤ä¸ª<code>key</code></li></ol><p><a href="#é—®é¢˜äºŒ">æ¯ç§æ ¼å¼çš„æ¯ä¸€é¡¹éƒ½éœ€è¦ä½¿ç”¨<code>-</code>ä½œä¸ºä¸€é¡¹çš„å¼€å§‹</a></p><p>æ–¹å¼äºŒ:</p><p>ä½¿ç”¨<code>RouteLocator</code>é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouteLocator <span class="title function_">routeLocator</span><span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">        .route(<span class="string">&quot;path_route&quot;</span>, r -&gt; r.path(<span class="string">&quot;/dict/**&quot;</span>).uri(<span class="string">&quot;lb://dict-service&quot;</span>))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œä¸€ä¸ª<code>RouteLocator</code>, åœ¨å…¶ä¸­æ·»åŠ è·¯ç”±ä¿¡æ¯, æ­¤æ–¹å¼é…ç½®çš„è·¯ç”±ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„ç›¸åŒè·¯ç”±, æ¯”å¦‚ä¸Šé¢å®šä¹‰çš„è·¯ç”±ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„<code>Path</code>ç±»å‹<code>/dict/**</code>çš„<code>pattern</code>è·¯ç”±</p></li></ol><h3 id="ä½¿ç”¨ç½‘å…³"><a class="markdownIt-Anchor" href="#ä½¿ç”¨ç½‘å…³"></a> ä½¿ç”¨ç½‘å…³</h3><p>è®¿é—®æœåŠ¡èµ„æºæ—¶, ä¸å†ç›´æ¥è®¿é—®è¯¥èµ„æº, è€Œæ˜¯è®¿é—®ç½‘å…³åœ°å€, é€šè¿‡ç½‘å…³è¿›è¡Œè·¯ç”±</p><p><img src="Gateway%E7%BD%91%E5%85%B3%E6%98%AF%E7%94%B1.png" alt="Gatewayç½‘å…³æ˜¯ç”±" /></p><h3 id="å…³äºé¡¹ç›®çš„å…¶ä»–å†…å®¹"><a class="markdownIt-Anchor" href="#å…³äºé¡¹ç›®çš„å…¶ä»–å†…å®¹"></a> å…³äºé¡¹ç›®çš„å…¶ä»–å†…å®¹</h3><p>æ­¤å¤„è°ƒæ•´äº†ä¸€ä¸‹é¡¹ç›®çš„å†…å®¹, ä¸»è¦æ˜¯å°†ç”¨æˆ·éƒ¨é—¨åˆå¹¶ä¸ºäº†ä¸€ä¸ªç»“æ„é¡¹ç›®</p><p><img src="%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95.png" alt="é¡¹ç›®ç›®å½•" /></p><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to find RoutePredicateFactory with name -Path</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : é…ç½®<code>predicates</code>çš„æ ¼å¼ä¸å¯¹, <code>predicates</code>çš„æ ¼å¼æ˜¯ç”±è¦æ±‚çš„, é¦–å­—æ¯è¦å¤§å†™, <code>-</code>å’Œ<code>Path</code>ä¹‹é—´è¦æœ‰ç©ºæ ¼(<code>Query</code>, <code>Header</code>ç­‰åŒç†)</p><p>è§£å†³æ–¹æ¡ˆ: ä¿®æ”¹ä¸ºæ­£ç¡®æ ¼å¼</p><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Property: spring.cloud.gateway.routes[0].xxx</span><br><span class="line">Value: &quot;[]&quot;</span><br><span class="line">Reason: ä¸èƒ½ä¸ºç©º</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : ä¸€. é…ç½®çš„<code>route</code>çš„å‚æ•°åå†™é”™äº†, æ¯”å¦‚<code>uri</code>å†™æˆäº†<code>url</code>; äºŒ, é…ç½®çš„å†…å®¹çš„é¡¹æ ¼å¼é”™è¯¯, æ¯”å¦‚<code>predicates</code>æˆ–è€…<code>filters</code>çš„é¡¹æ²¡æœ‰ä»¥<code>-</code>å¼€å§‹</p><p>è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥åç§°å’Œæ ¼å¼</p><p><i id="é—®é¢˜ä¸‰">é—®é¢˜ä¸‰</i></p><p>è®¿é—®é¡¹ç›®æ—¶è·¯å¾„æ­£ç¡®ä½†æ˜¯å‡ºç°<code>404</code>çš„é—®é¢˜</p><p>é—®é¢˜åŸå› : 1. è·¯ç”±é…ç½®é—®é¢˜, æŸ¥çœ‹è·¯ç”±çš„è·¯å¾„è½¬å‘æ˜¯å¦åŒ¹é…; 2.æœåŠ¡æ³¨å†Œé—®é¢˜, å¯ä»¥å®ç°è½¬å‘, è¦æ±‚æœåŠ¡éƒ½åœ¨æ³¨å†Œåœ¨åŒä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„åŒä¸€ä¸ªç›®å½•ä¸‹, å¹¶ä¸”æœåŠ¡æ³¨å†Œçš„<code>address</code>å’Œ<code>port</code>éƒ½å¯¹åº”è¯¥æœåŠ¡çš„è®¿é—®<code>host</code>å’Œ<code>port</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">root:</span> <span class="string">/services/dev</span></span><br><span class="line">        <span class="attr">instance-port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">instance-host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">instance-id:</span> <span class="string">gateway-service-01</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Š, è¯¥ç½‘å…³åªèƒ½æ‰¾åˆ°æ³¨å†Œåœ¨<code>/services/dev</code>ä¸‹çš„æœåŠ¡, åªæœ‰åŒåœ¨è¯¥ç›®å½•çš„æœåŠ¡æ‰èƒ½è¢«è¯¥ç½‘å…³å‘ç°, è¿›è€Œå®ç°è½¬å‘, è¯¥ç½‘å…³å¯¹å¤–å±•ç¤ºçš„<code>address</code>æ˜¯å®šä¹‰çš„<code>instance-host</code>å¯¹åº”çš„å€¼, å¯¹å¤–å±•ç¤ºçš„ç«¯å£æ˜¯å®šä¹‰çš„<code>instance-port</code>å¯¹åº”çš„å€¼</p><p><i id="é—®é¢˜å››">é—®é¢˜å››</i></p><p>é—®é¢˜: é…ç½®æ–‡ä»¶ä¸­é…ç½®è·¯ç”±æ­£ç¡®, ä½†æ˜¯è®¿é—®æ—¶å´è®¿é—®ä¸åˆ°, æ—¢æ²¡æœ‰ä»»ä½•è¿”å›, ä¹Ÿæ²¡æœ‰æŠ¥é”™ä¿¡æ¯</p><p>é—®é¢˜åŸå› : å¯èƒ½æ˜¯é…ç½®<code>uri</code>æ—¶åè®®æ–¹å¼å†™é”™äº†, æ¯”å¦‚<code>lb</code>å†™æˆäº†<code>bl</code></p><p>è§£å†³æ–¹æ¡ˆ: æ”¹, è¿™ç§é—®é¢˜éœ€è¦ä»”ç»†æ£€æŸ¥è·¯ç”±é…ç½®, åœ¨æ²¡æœ‰æŠ¥é”™ä¿¡æ¯çš„æƒ…å†µä¸‹è¿½æº¯å¯èƒ½å‡ºé”™çš„ä½ç½®</p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>Gateway</code>è¯¦è§£</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Gateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(ä¸‰)---æœåŠ¡ç†”æ–­ä¸é™çº§</title>
      <link href="/2023/12/02/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%8D%E7%BA%A7/"/>
      <url>/2023/12/02/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%89%E4%B9%8B%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%8D%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<!-- top --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>ä¸Šç¯‡åŸºæœ¬å®Œæˆäº†æœåŠ¡çš„æ³¨å†Œä¸å‘ç°, æœåŠ¡é—´çš„<code>API</code>è°ƒç”¨å’Œé…ç½®ä¸­å¿ƒ, å¯¹äºæœåŠ¡é—´çš„è°ƒç”¨, éœ€è¦è§£å†³æœåŠ¡è°ƒç”¨å¤±è´¥çš„æƒ…å†µä»¥åŠå¯èƒ½å¸¦æ¥çš„æœåŠ¡é›ªå´©çš„é—®é¢˜.</p><p>ç”±äº<code>Hystrix</code>ä¸å†ç»´æŠ¤, æ‰€ä»¥æ­¤å¤„ä½¿ç”¨<code>SpringCloudAlibaba</code>çš„<code>Sentinel</code>ä½œä¸ºæœåŠ¡ç†”æ–­ä¸é™çº§çš„ç»„ä»¶. <code>SpringCloudAlibaba</code>çš„<code>Sentinel</code>ä½œä¸ºå¾®æœåŠ¡çš„å®¹é”™ç»„ä»¶, ä»¥æµé‡ä¸ºä¸€åˆ‡å…¥ç‚¹, ä»æµé‡æ§åˆ¶, ç†”æ–­é™çº§, ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šç»´åº¦ä¿æŠ¤æœåŠ¡ç¨³å®šæ€§, æ˜¯çœŸæ­£çš„æµé‡é˜²å«å…µ</p><h3 id="å®‰è£…éƒ¨ç½²sentinelæ§åˆ¶ç«¯"><a class="markdownIt-Anchor" href="#å®‰è£…éƒ¨ç½²sentinelæ§åˆ¶ç«¯"></a> å®‰è£…éƒ¨ç½²<code>Sentinel</code>æ§åˆ¶ç«¯</h3><h4 id="ä¸‹è½½"><a class="markdownIt-Anchor" href="#ä¸‹è½½"></a> ä¸‹è½½</h4><p>ä»https://github.com/alibaba/Sentinel/releasesä¸‹è½½<code>jar</code>åŒ…</p><p>æ­¤å¤„ä¸‹è½½æ‰€ä½¿ç”¨çš„æ˜¯<code>v1.8.6</code></p><h4 id="å¯åŠ¨"><a class="markdownIt-Anchor" href="#å¯åŠ¨"></a> å¯åŠ¨</h4><p><code>Sentinel</code>é»˜è®¤ç«¯å£æ˜¯<code>8080</code>, å¦‚æœ<code>8080</code>ç«¯å£è¢«å ç”¨äº†éœ€è¦ä½¿ç”¨å…¶ä»–ç«¯å£</p><p>ä¿®æ”¹æ–¹å¼ä½¿ç”¨æ™®é€šçš„<code>SpringBoot</code>é¡¹ç›®çš„ä¿®æ”¹æ–¹å¼å³å¯</p><p>æ­¤å¤„ä½¿ç”¨é¡¹ç›®åŒç›®å½•ä¸‹åˆ›å»º<code>application.yml</code>æ–‡ä»¶çš„æ–¹å¼</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure><h4 id="è®¿é—®æµ‹è¯•"><a class="markdownIt-Anchor" href="#è®¿é—®æµ‹è¯•"></a> è®¿é—®æµ‹è¯•</h4><p>æµè§ˆå™¨ä¸­è®¿é—®<code>Sentinel</code>æ§åˆ¶ç«¯, ç”¨æˆ·å’Œå¯†ç éƒ½æ˜¯<code>sentinel</code></p><p><img src="Sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0%E9%A6%96%E9%A1%B5.png" alt="Sentinelæ§åˆ¶å°é¦–é¡µ" /></p><h3 id="é¡¹ç›®ä¸­å¼•å…¥sentinel"><a class="markdownIt-Anchor" href="#é¡¹ç›®ä¸­å¼•å…¥sentinel"></a> é¡¹ç›®ä¸­å¼•å…¥<code>Sentinel</code></h3><h4 id="å¼•å…¥ä¾èµ–"><a class="markdownIt-Anchor" href="#å¼•å…¥ä¾èµ–"></a> å¼•å…¥ä¾èµ–</h4><ol><li><p>çˆ¶é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2022.0.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>IDEA</code>ä¸­æç¤º<code>sentinel</code>ä¸­å¼•ç”¨çš„<code>fastjson</code>ç‰ˆæœ¬å­˜åœ¨æ¼æ´, æ‰€ä»¥åœ¨æ­¤å¤„æ’é™¤æ‰å¹¶å¼•å…¥ç¨³å®šç‰ˆæœ¬</p></li></ol><h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4><p>é…ç½®æ–‡ä»¶æ·»åŠ ç›‘æ§é¡¹ç›®é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:10000</span></span><br></pre></td></tr></table></figure><h4 id="sentinelä½¿ç”¨"><a class="markdownIt-Anchor" href="#sentinelä½¿ç”¨"></a> <code>Sentinel</code>ä½¿ç”¨</h4><p>ä½¿ç”¨<code>@SentinelResource</code>æ³¨è§£, å°†èµ„æºæ³¨å†Œä¸º<code>Sentinel</code>ç›‘æ§èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;DictTypeMapper, DictTypeEntity&gt; <span class="keyword">implements</span> <span class="title class_">IDictTypeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceClient userServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// Sentinelèµ„æºé…ç½®</span></span><br><span class="line">    <span class="meta">@SentinelResource(&quot;dict-type-get-id&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">get</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">DictTypeEntity</span> <span class="variable">type</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        result.put(<span class="string">&quot;dictType&quot;</span>, type);</span><br><span class="line">        ApiResult&lt;UserEntity&gt; re = userServiceClient.getById(type.getCreator());</span><br><span class="line">        <span class="keyword">if</span> (!Objects.isNull(re)) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;user&quot;</span>, re.getData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="Sentinel%E4%B8%AD%E8%B5%84%E6%BA%90%E7%9A%84%E7%9B%91%E6%8E%A7.png" alt="Sentinelä¸­èµ„æºçš„ç›‘æ§" /></p><p>æ³¨æ„äº‹é¡¹:</p><ol><li><code>@SentinelResource</code>æ³¨è§£å¯ä»¥ä½¿ç”¨åœ¨ç±»å’Œæ–¹æ³•ä¸Š</li><li>é¡¹ç›®å¯åŠ¨åå¹¶ä¸ä¼šç«‹å³æ³¨å†Œåˆ°<code>Sentinel</code>ä¸­, åªæœ‰é¦–æ¬¡è°ƒç”¨äº†èµ„æºå, æ‰ä¼šå°†è¯¥èµ„æºæ³¨å†Œåˆ°<code>Sentinel</code>ä¸­</li><li>é€šå¸¸ä½¿ç”¨åœ¨æ–¹æ³•ä¸Šæ˜¯ä¸ºäº†è¿›è¡Œæ›´ç»†ç²’åº¦çš„æµé‡æ§åˆ¶</li></ol><h3 id="sentinelçš„æµæ§è§„åˆ™"><a class="markdownIt-Anchor" href="#sentinelçš„æµæ§è§„åˆ™"></a> <code>Sentinel</code>çš„æµæ§è§„åˆ™</h3><h4 id="æµæ§ç­–ç•¥"><a class="markdownIt-Anchor" href="#æµæ§ç­–ç•¥"></a> æµæ§ç­–ç•¥</h4><ol><li><p>å¿«é€Ÿå¤±è´¥: ç›´æ¥æ‹’ç»</p></li><li><p>é¢„çƒ­: ç¼“æ…¢å°†é˜ˆå€¼æé«˜åˆ°æŒ‡å®šé˜ˆå€¼, å½¢æˆç¼“å†²ä¿æŠ¤</p><p><img src="Sentinel%E9%A2%84%E7%83%AD%E7%AD%96%E7%95%A5.png" alt="Sentinelé¢„çƒ­ç­–ç•¥" /></p></li><li><p>æ’é˜Ÿç­‰å€™: å…ˆè¿›å…¥é˜Ÿåˆ—ç­‰å¾…, å¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰æ‰§è¡Œåˆ™æ”¾å¼ƒæ‰§è¡Œ</p><p><img src="Sentinel%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85%E7%AD%96%E7%95%A5.png" alt="Sentinelæ’é˜Ÿç­‰å¾…ç­–ç•¥" /></p></li></ol><h4 id="æµæ§æ¨¡å¼"><a class="markdownIt-Anchor" href="#æµæ§æ¨¡å¼"></a> æµæ§æ¨¡å¼</h4><ol><li><p>ç›´æ¥: èµ„æºçš„ç›´æ¥æ§åˆ¶, å½“å‰èµ„æºè¾¾åˆ°æµæ§é˜ˆå€¼, å½“å‰èµ„æºé™æµ</p></li><li><p>å…³è”: èµ„æºçš„é—´æ¥æ§åˆ¶, å…³è”èµ„æºè¾¾åˆ°æµæ§é˜ˆå€¼, å½“å‰èµ„æºé™æµ</p><p><img src="Sentinel%E7%9A%84%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F.png" alt="Sentinelçš„å…³è”æ¨¡å¼" /></p></li><li><p>é“¾è·¯: æ›´ç»†ç²’åº¦çš„ç›‘æ§; åªæœ‰æŒ‡å®šèµ„æºé“¾è·¯çš„è¯·æ±‚è¾¾åˆ°é˜ˆå€¼æ—¶, æ‰æ‰§è¡Œé™æµ</p><p>é¦–å…ˆè¦å…³é—­<code>context</code>æ”¶æ•›, ä½¿èµ„æºè¿›è¡Œé“¾è·¯éš”ç¦», å®ç°ä¸åŒé“¾è·¯çš„å•ç‹¬æ§åˆ¶</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="comment"># å…³é—­contextæ”¶æ•›, è¿™æ ·è¢«ç›‘æ§æ–¹æ³•å¯ä»¥è¿›è¡Œä¸åŒé“¾è·¯çš„å•ç‹¬æ§åˆ¶</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><img src="Sentinel%E7%9A%84%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F.png" alt="Sentinelçš„é“¾è·¯æ¨¡å¼" /></p></li></ol><h3 id="sentinelçš„å¼‚å¸¸å¤„ç†"><a class="markdownIt-Anchor" href="#sentinelçš„å¼‚å¸¸å¤„ç†"></a> <code>Sentinel</code>çš„å¼‚å¸¸å¤„ç†</h3><h4 id="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚"></a> è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚</h4><p>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚æ˜¯å®šä¹‰ä¸€ä¸ªå¼‚å¸¸å¤„ç†çš„è¯·æ±‚, å½“ç›‘æ§çš„èµ„æºé™æµæ—¶, ä¼šç›´æ¥è°ƒç”¨è¯¥è¯·æ±‚è¿”å›ç»“æœ, è¿™ç§æ–¹å¼å¯ä»¥æ”¾åˆ°å…¬å…±é¡¹ç›®ä¸­å®šä¹‰, åœ¨å¼•å…¥é¡¹ç›®ä¸­é…ç½®</p><ol><li><p>å®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/sentinel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelErrorController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/block&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; block() &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.failure(<span class="number">500</span>, <span class="string">&quot;èµ„æºè¢«é™æµ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ å¼‚å¸¸å¤„ç†è¯·æ±‚è·¯å¾„</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:10000</span></span><br><span class="line">      <span class="comment"># å¼‚å¸¸è¯·æ±‚çš„å¤„ç†è·¯å¾„</span></span><br><span class="line">      <span class="attr">block-page:</span> <span class="string">/dict/sentinel/block</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ æµæ§é…ç½®</p><p><img src="Sentinel%E6%B5%81%E6%8E%A7%E9%85%8D%E7%BD%AE.png" alt="Sentinelæµæ§é…ç½®" /></p></li><li><p>é™æµå¼‚å¸¸ç»“æœ</p><p><img src="Sentinel%E9%99%90%E6%B5%81%E6%8E%A7%E5%88%B6%E8%AF%B7%E6%B1%82%E7%BB%93%E6%9E%9C.png" alt="Sentinelé™æµæ§åˆ¶è¯·æ±‚ç»“æœ" /></p><p>å½“<code>QPS</code>å¤§äºå•æœºé˜ˆå€¼(æ¯ç§’è¯·æ±‚æ•°å¤§äºå•æœºé˜ˆå€¼)æ—¶, åˆ™ä¼šå‡ºç°ä»¥ä¸Šç»“æœ, è¯·æ±‚è¢«è½¬å‘åˆ°é…ç½®çš„å¼‚å¸¸è¯·æ±‚å¤„</p></li></ol><h4 id="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨"></a> è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨</h4><p>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†è¯·æ±‚æ˜¯å®šä¹‰ä¸€ä¸ªå¼‚å¸¸å¤„ç†å™¨, å½“ç›‘æ§çš„èµ„æºé™æµæ—¶, ä¼šè°ƒç”¨è¯¥å¤„ç†å™¨çš„è¿”å›ç»“æœ, æ­¤ç§æ–¹å¼æ˜¯ä»¥ä¸­ç»†ç²’åº¦çš„å¤„ç†æ–¹å¼</p><ol><li><p>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelBlockHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸èµ„æºçš„è¿”å›å€¼ç›¸åŒ, å‚æ•°åˆ—è¡¨è¦ä¸€ç›´, å¹¶åœ¨æœ€åæ·»åŠ ä¸€ä¸ª BlockException ç±»å‹çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">get</span><span class="params">(Integer id, BlockException ex)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;: èµ„æºé™æµ&quot;</span>, LocalDateTime.now());</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¸ºèµ„æºé…ç½®å¼‚å¸¸å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;DictTypeMapper, DictTypeEntity&gt; <span class="keyword">implements</span> <span class="title class_">IDictTypeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceClient userServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;dict-type-get-id&quot;, blockHandlerClass = &#123;SentinelBlockHandler.class&#125;, blockHandler = &quot;get&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">get</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">DictTypeEntity</span> <span class="variable">type</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        result.put(<span class="string">&quot;dictType&quot;</span>, type);</span><br><span class="line">        ApiResult&lt;UserEntity&gt; re = userServiceClient.getById(type.getCreator());</span><br><span class="line">        <span class="keyword">if</span> (!Objects.isNull(re)) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;user&quot;</span>, re.getData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="Sentinel%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8.png" alt="Sentinelè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨" /></p></li><li><p>æ·»åŠ æµæ§é…ç½®</p><p><img src="Sentinel%E6%B5%81%E6%8E%A7%E9%85%8D%E7%BD%AE.png" alt="Sentinelæµæ§é…ç½®" /></p></li><li><p>é™æµå¼‚å¸¸ç»“æœ</p><p><img src="Sentinel%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8%E7%BB%93%E6%9E%9C.png" alt="Sentinelè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ç»“æœ" /></p><p><img src="Sentinel%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8%E6%97%A5%E5%BF%97.png" alt="Sentinelè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨æ—¥å¿—" /></p></li></ol><h3 id="æœåŠ¡ç†”æ–­å’Œé™çº§"><a class="markdownIt-Anchor" href="#æœåŠ¡ç†”æ–­å’Œé™çº§"></a> æœåŠ¡ç†”æ–­å’Œé™çº§</h3><h4 id="æœåŠ¡ç†”æ–­å’Œé™çº§æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#æœåŠ¡ç†”æ–­å’Œé™çº§æ˜¯ä»€ä¹ˆ"></a> æœåŠ¡ç†”æ–­å’Œé™çº§æ˜¯ä»€ä¹ˆ</h4><p>ç½‘ç»œä¸Šè®²è¿°è¿™ä¸¤è€…çš„åŒºåˆ«çš„æ—¶å€™éƒ½éå¸¸ä¸“ä¸šåŒ–, æˆ‘çœ‹çš„æ˜¯äº‘é‡Œé›¾é‡Œ, ä¸ªäººæµ…è–„çš„ç†è§£å°±æ˜¯ç†”æ–­æ˜¯åŸºäºæœåŠ¡é«˜å¯ç”¨çš„, è€Œé™çº§æ˜¯åŸºäºæ•´ä½“è´Ÿè½½çš„, ä¿è¯ç³»ç»Ÿæ­£å¸¸å¯ç”¨çš„; ç†”æ–­ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨æ€§, åœ¨ç›®æ ‡èµ„æºå‹åŠ›è¿‡å¤§æ—¶é‡‡å–çš„é¿é™©æ–¹æ¡ˆ; é™çº§çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ ¸å¿ƒä¸šåŠ¡çš„å¯ç”¨æ€§, ä¸åŒæ—¶é—´æ®µçš„æ ¸å¿ƒä¸šåŠ¡å¯èƒ½ä¸ä¸€è‡´, ä¸€æ–¹é¢é€šè¿‡ç®¡æ§éæ ¸å¿ƒä¸šåŠ¡èµ„æº, ä½¿å¾—æ ¸å¿ƒä¸šåŠ¡å¯ä»¥è·å¾—æ›´å¤šçš„ç³»ç»Ÿèµ„æº, å¦ä¸€æ–¹é¢é€šè¿‡ç†”æ–­æ–¹å¼ä¿è¯æ ¸å¿ƒä¸šåŠ¡çš„å¯ç”¨</p><h4 id="èµ„æºç†”æ–­å¤„ç†"><a class="markdownIt-Anchor" href="#èµ„æºç†”æ–­å¤„ç†"></a> èµ„æºç†”æ–­å¤„ç†</h4><p>åœ¨<code>Sentinel</code>ä¸­, ç†”æ–­çš„å¤„ç†å…¶å®ä¸æµæ§ä¸€è‡´, å³é€šè¿‡å¼‚å¸¸è¯·æ±‚æˆ–è€…å¼‚å¸¸å¤„ç†å™¨æ¥å®ç°, å¯ä»¥å‚è€ƒæµæ§ä¸­çš„å¼‚å¸¸å¤„ç†</p><p>ç†”æ–­ç­–ç•¥</p><ol><li><p>æ…¢è°ƒç”¨è§„åˆ™</p><p><img src="Sentinel%E7%9A%84%E6%85%A2%E8%B0%83%E7%94%A8%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5.png" alt="Sentinelçš„æ…¢è°ƒç”¨ç†”æ–­ç­–ç•¥" /></p><p><strong>æœ€å¤§è¯·æ±‚æ—¶é•¿</strong>: ä¸€æ¬¡è¯·æ±‚çš„æœ€å¤§æ—¶é•¿, è¶…è¿‡è¯¥æ—¶é•¿è§†ä¸ºä¸€æ¬¡æ…¢è°ƒç”¨</p><p><strong>ç†”æ–­æ—¶é•¿</strong>: ç†”æ–­å™¨çš„å‘¨æœŸæ—¶é•¿, æ¯ä¸ªå‘¨æœŸå³ä¸ºç†”æ–­æ—¶é•¿, å‘¨æœŸä¸å‘¨æœŸä¹‹é—´ä¼šå°è¯•è¯·æ±‚ä»¥å¯»æ±‚å…³é—­ç†”æ–­å™¨; æ¯ç»è¿‡ä¸€ä¸ªç†”æ–­æ—¶é•¿, ç†”æ–­å™¨å°±ä¼šè¿›å…¥åŠå¼€çŠ¶æ€, é‡Šæ”¾éƒ¨åˆ†è¯·æ±‚å»å°è¯•è°ƒç”¨, å¦‚æœæœåŠ¡ä»ç„¶ä¸å¯ç”¨, åˆ™ç»§ç»­ä¿æŒå¼€å¯, è¿›å…¥ä¸‹ä¸€ä¸ªç†”æ–­å‘¨æœŸ, å¦‚æœå¯ç”¨åˆ™ç†”æ–­å™¨å…³é—­</p><p><strong>æœ€å°è¯·æ±‚æ•°</strong>: ç»Ÿè®¡æ—¶é•¿å†…æœ€å°çš„è¯·æ±‚æ¬¡æ•°</p><p><strong>ç»Ÿè®¡æ—¶é•¿</strong>: æ¯ä¸ªç»Ÿè®¡æ—¶é—´çª—çš„æ—¶é•¿, ç»Ÿè®¡è¯¥æ—¶é•¿å†…çš„è¯·æ±‚æ¬¡æ•°å’ŒçŠ¶æ€, åˆ¤æ–­æ˜¯å¦éœ€è¦ç†”æ–­</p><p><strong>æ¯”ä¾‹é˜ˆå€¼</strong>: ç”¨æ¥åˆ¤æ–­ç»Ÿè®¡æ—¶é•¿å†…æ‰€æœ‰è¯·æ±‚ä¸­æ…¢è°ƒç”¨è¯·æ±‚æ‰€å çš„æ¯”ä¾‹çš„æœ€å¤§å€¼</p><p><strong>æ³¨æ„</strong>:</p><blockquote><p>æ…¢è°ƒç”¨æ¯”ä¾‹ç­–ç•¥è¦æƒ³å¼€å¯ç†”æ–­å™¨éœ€è¦è¾¾åˆ°ä¸¤ä¸ªæ¡ä»¶:</p><ol><li>ç»Ÿè®¡æ—¶é•¿å†…, è¯·æ±‚æ•°é‡å¤§äºæœ€å°è¯·æ±‚æ•°</li><li>ç»Ÿè®¡æ—¶é•¿å†…, æ…¢è°ƒç”¨æ‰€å æ¯”ä¾‹å¤§äºé˜ˆå€¼</li></ol></blockquote></li><li><p>å¼‚å¸¸æ¯”ä¾‹</p><p><img src="Sentinel%E7%9A%84%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5.png" alt="Sentinelçš„å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ç­–ç•¥" /></p><p><strong>ç†”æ–­æ—¶é•¿</strong>: ç†”æ–­å™¨çš„å‘¨æœŸæ—¶é•¿, æ¯ä¸ªå‘¨æœŸå³ä¸ºç†”æ–­æ—¶é•¿, å‘¨æœŸä¸å‘¨æœŸä¹‹é—´ä¼šå°è¯•è¯·æ±‚ä»¥å¯»æ±‚å…³é—­ç†”æ–­å™¨; æ¯ç»è¿‡ä¸€ä¸ªç†”æ–­æ—¶é•¿, ç†”æ–­å™¨å°±ä¼šè¿›å…¥åŠå¼€çŠ¶æ€, é‡Šæ”¾éƒ¨åˆ†è¯·æ±‚å»å°è¯•è°ƒç”¨, å¦‚æœæœåŠ¡ä»ç„¶ä¸å¯ç”¨, åˆ™ç»§ç»­ä¿æŒå¼€å¯, è¿›å…¥ä¸‹ä¸€ä¸ªç†”æ–­å‘¨æœŸ, å¦‚æœå¯ç”¨åˆ™ç†”æ–­å™¨å…³é—­</p><p><strong>æœ€å°è¯·æ±‚æ•°</strong>: ç»Ÿè®¡æ—¶é•¿å†…æœ€å°çš„è¯·æ±‚æ¬¡æ•°</p><p><strong>ç»Ÿè®¡æ—¶é•¿</strong>: æ¯ä¸ªç»Ÿè®¡æ—¶é—´çª—çš„æ—¶é•¿, ç»Ÿè®¡è¯¥æ—¶é•¿å†…çš„è¯·æ±‚æ¬¡æ•°å’ŒçŠ¶æ€, åˆ¤æ–­æ˜¯å¦éœ€è¦ç†”æ–­</p><p><strong>æ¯”ä¾‹é˜ˆå€¼</strong>: ç”¨æ¥åˆ¤æ–­ç»Ÿè®¡æ—¶é•¿å†…æ‰€æœ‰è¯·æ±‚ä¸­å¼‚å¸¸è¯·æ±‚æ‰€å çš„æ¯”ä¾‹çš„æœ€å¤§å€¼</p><p><strong>æ³¨æ„</strong>:</p><blockquote><p>å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥è¦æƒ³å¼€å¯ç†”æ–­å™¨éœ€è¦è¾¾åˆ°ä¸¤ä¸ªæ¡ä»¶:</p><ol><li>ç»Ÿè®¡æ—¶é•¿å†…, è¯·æ±‚æ•°é‡å¤§äºæœ€å°è¯·æ±‚æ•°</li><li>ç»Ÿè®¡æ—¶é•¿å†…, å¼‚å¸¸è¯·æ±‚æ‰€å æ¯”ä¾‹å¤§äºé˜ˆå€¼</li></ol></blockquote></li><li><p>å¼‚å¸¸æ•°</p><p><img src="Sentinel%E7%9A%84%E5%BC%82%E5%B8%B8%E6%95%B0%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5.png" alt="Sentinelçš„å¼‚å¸¸æ•°ç†”æ–­ç­–ç•¥" /></p><p><strong>ç†”æ–­æ—¶é•¿</strong>: ç†”æ–­å™¨çš„å‘¨æœŸæ—¶é•¿, æ¯ä¸ªå‘¨æœŸå³ä¸ºç†”æ–­æ—¶é•¿, å‘¨æœŸä¸å‘¨æœŸä¹‹é—´ä¼šå°è¯•è¯·æ±‚ä»¥å¯»æ±‚å…³é—­ç†”æ–­å™¨; æ¯ç»è¿‡ä¸€ä¸ªç†”æ–­æ—¶é•¿, ç†”æ–­å™¨å°±ä¼šè¿›å…¥åŠå¼€çŠ¶æ€, é‡Šæ”¾éƒ¨åˆ†è¯·æ±‚å»å°è¯•è°ƒç”¨, å¦‚æœæœåŠ¡ä»ç„¶ä¸å¯ç”¨, åˆ™ç»§ç»­ä¿æŒå¼€å¯, è¿›å…¥ä¸‹ä¸€ä¸ªç†”æ–­å‘¨æœŸ, å¦‚æœå¯ç”¨åˆ™ç†”æ–­å™¨å…³é—­</p><p><strong>æœ€å°è¯·æ±‚æ•°</strong>: ç»Ÿè®¡æ—¶é•¿å†…æœ€å°çš„è¯·æ±‚æ¬¡æ•°</p><p><strong>ç»Ÿè®¡æ—¶é•¿</strong>: æ¯ä¸ªç»Ÿè®¡æ—¶é—´çª—çš„æ—¶é•¿, ç»Ÿè®¡è¯¥æ—¶é•¿å†…çš„è¯·æ±‚æ¬¡æ•°å’ŒçŠ¶æ€, åˆ¤æ–­æ˜¯å¦éœ€è¦ç†”æ–­</p><p><strong>å¼‚å¸¸æ•°</strong>: ç”¨æ¥åˆ¤æ–­ç»Ÿè®¡æ—¶é•¿å†…å¼‚å¸¸è¯·æ±‚çš„æ•°é‡</p><p><strong>æ³¨æ„</strong>:</p><blockquote><p>å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥è¦æƒ³å¼€å¯ç†”æ–­å™¨éœ€è¦è¾¾åˆ°ä¸¤ä¸ªæ¡ä»¶:</p><ol><li>ç»Ÿè®¡æ—¶é•¿å†…, è¯·æ±‚æ•°é‡å¤§äºæœ€å°è¯·æ±‚æ•°</li><li>ç»Ÿè®¡æ—¶é•¿å†…, å¼‚å¸¸è¯·æ±‚è¾¾åˆ°é˜ˆå€¼</li></ol></blockquote></li></ol><h4 id="æœåŠ¡è°ƒç”¨ç†”æ–­å¤„ç†"><a class="markdownIt-Anchor" href="#æœåŠ¡è°ƒç”¨ç†”æ–­å¤„ç†"></a> æœåŠ¡è°ƒç”¨ç†”æ–­å¤„ç†</h4><p>æœ¬æ¬¡é¡¹ç›®ä¸­çš„æœåŠ¡è°ƒç”¨ä½¿ç”¨çš„æ˜¯<code>OpenFeign</code>, <code>Sentinel</code>æ•´ä¸ª<code>OpenFeign</code>è¿›è¡Œç†”æ–­å¤„ç†çš„æ–¹å¼ä¸<code>Hystrix</code>ä¸€è‡´</p><ol><li><p>é…ç½®å¼€å¯<code>OpenFeign</code>æ”¯æŒ<code>Sentinel</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ æœåŠ¡è°ƒç”¨çš„ç†”æ–­å¤„ç†</p><ul><li><p>æœåŠ¡è°ƒç”¨æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    ApiResult&lt;UserEntity&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæœåŠ¡è°ƒç”¨æ¥å£çš„å®ç°ç±», é‡å†™æ–¹æ³•çš„è¿”å›å€¼å³ä¸ºç†”æ–­çš„é»˜è®¤è°ƒç”¨ç»“æœ, å¹¶å°†å…¶æ³¨å†Œä¸º<code>Bean</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceClientFallback</span> <span class="keyword">implements</span> <span class="title class_">UserServiceClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;UserEntity&gt; <span class="title function_">getById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.failure();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="#é—®é¢˜ä¸€">å¦‚æœæ²¡æœ‰æ³¨å†Œä¸º<code>Bean</code>, é¡¹ç›®å¯åŠ¨æ—¶ä¼šæŠ¥å¼‚å¸¸</a></p></li><li><p>å°†è¯¥å®ç°ç±»åœ¨æœåŠ¡è°ƒç”¨æ¥å£ä¸Šæ·»åŠ ä¸º<code>fallback</code>å‚æ•°çš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;, fallback = UserServiceClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    ApiResult&lt;UserEntity&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>å‡ºç°é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalStateException: No fallback instance of type class com.xiaolin.commons.clients.fallback.UserServiceClientFallback found for feign client user-service</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : åœ¨åšæœåŠ¡ç†”æ–­æ—¶, æœåŠ¡è°ƒç”¨æ¥å£çš„å®ç°æ²¡æœ‰æ³¨å†Œä¸º<code>Bean</code></p><p>è§£å†³æ–¹æ¡ˆ: å°†æœåŠ¡è°ƒç”¨æ¥å£çš„å®ç°æ³¨å†Œä¸º<code>Bean</code></p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>Sentinel</code>çš„é«˜çº§ä½¿ç”¨(ç³»ç»Ÿè§„åˆ™, é›†ç¾¤ç­‰)</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> Sentinel </tag>
            
            <tag> SpringCloudAlibaba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(äºŒ)---æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ</title>
      <link href="/2023/11/30/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/"/>
      <url>/2023/11/30/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%BA%8C%E4%B9%8B%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>å‰ä¸€ç¯‡æ­å»ºäº†åˆ†å¸ƒå¼é¡¹ç›®åŸºæœ¬æœåŠ¡å†…å®¹, æ­¤ç¯‡å¼€å§‹è¿›è¡Œåˆ†å¸ƒå¼çš„æ¶æ„è®¾è®¡. é¦–å…ˆä»æ³¨å†Œä¸­å¿ƒå¼€å§‹, åŸæœ¬æ˜¯æƒ³ä½¿ç”¨<code>Eureka</code>çš„, ä½†ç”±äº<code>Eureka</code>ä»2.xå¼€å§‹ä¸å†å¼€æº, æ‹…å¿ƒä¼šå‘ç”Ÿé£å‘åç§», æ‰€ä»¥æ­¤å¤„é€‰ç”¨<code>Zookeeper</code>. æœ€è¿‘çœ‹çš„æ‹›è˜ä¿¡æ¯é‡Œ, <code>Zookeeper</code>å‡ºç°çš„é¢‘ç‡ä¹ŸæŒºé«˜çš„, å½“ç„¶, è‡ªå·±ä¹Ÿæƒ³å­¦ä¹ ä½¿ç”¨æ–°ä¸œè¥¿.</p><p>ç”±äºæœ¬ç³»åˆ—æ˜¯å­¦ä¹ æ­å»º<code>SpringCloud</code>çš„ç³»åˆ—æ–‡ç« , æ‰€ä»¥ä¸ä¼šæ¢è®¨<code>Zookeeper</code>çš„æ·±åº¦å­¦ä¹ å’Œä½¿ç”¨, æœ¬ç¯‡çš„ç›®çš„æ˜¯åœ¨é¡¹ç›®ä¸­å¼•å…¥<code>Zookeeper</code>ä½œä¸ºæ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ</p><h3 id="å¯åŠ¨zookeeper"><a class="markdownIt-Anchor" href="#å¯åŠ¨zookeeper"></a> å¯åŠ¨<code>Zookeeper</code></h3><h4 id="ä¸‹è½½"><a class="markdownIt-Anchor" href="#ä¸‹è½½"></a> ä¸‹è½½</h4><p>ä»https://zookeeper.apache.org/releases.htmlä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„<code>Zookeeper</code>, è§£å‹ç¼©</p><h4 id="ä¿®æ”¹é…ç½®"><a class="markdownIt-Anchor" href="#ä¿®æ”¹é…ç½®"></a> ä¿®æ”¹é…ç½®</h4><p>æ ¹æ®<code>conf</code>ç›®å½•ä¸­çš„<code>zoo_sample.cfg</code>æ–‡ä»¶, åœ¨<code>conf</code>ç›®å½•ä¸‹åˆ›å»º<code>zoo.cfg</code>æ–‡ä»¶, ä¿®æ”¹å…¶ä¸­çš„é…ç½®</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The number of milliseconds of each tick</span></span><br><span class="line"><span class="comment"># å¿ƒè·³é—´éš”</span></span><br><span class="line"><span class="attr">tickTime</span>=<span class="string">2000</span></span><br><span class="line"><span class="comment"># The number of ticks that the initial </span></span><br><span class="line"><span class="comment"># synchronization phase can take</span></span><br><span class="line"><span class="attr">initLimit</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># The number of ticks that can pass between </span></span><br><span class="line"><span class="comment"># sending a request and getting an acknowledgement</span></span><br><span class="line"><span class="attr">syncLimit</span>=<span class="string">5</span></span><br><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line"><span class="comment"># do not use /tmp for storage, /tmp here is just </span></span><br><span class="line"><span class="comment"># example sakes.</span></span><br><span class="line"><span class="comment"># æ•°æ®åº“ç»</span></span><br><span class="line"><span class="attr">dataDir</span>=<span class="string">D:\\software\\apache-zookeeper-3.9.1\\data</span></span><br><span class="line"><span class="comment"># æ—¥å¿—è·¯å¾„</span></span><br><span class="line"><span class="attr">dataLogDir</span>=<span class="string">D:\\software\\apache-zookeeper-3.9.1\\logs</span></span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ç«¯å£å·</span></span><br><span class="line"><span class="attr">clientPort</span>=<span class="string">2181</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹å ç”¨çš„8080ç«¯å£å·</span></span><br><span class="line"><span class="attr">admin.serverPort</span>=<span class="string">8079</span></span><br><span class="line"><span class="comment"># the maximum number of client connections.</span></span><br><span class="line"><span class="comment"># increase this if you need to handle more clients</span></span><br><span class="line"><span class="comment">#maxClientCnxns=60</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Be sure to read the maintenance section of the </span></span><br><span class="line"><span class="comment"># administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The number of snapshots to retain in dataDir</span></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="comment"># Purge task interval in hours</span></span><br><span class="line"><span class="comment"># Set to &quot;0&quot; to disable auto purge feature</span></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">## Metrics Providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://prometheus.io Metrics Exporter</span></span><br><span class="line"><span class="comment">#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span></span><br><span class="line"><span class="comment">#metricsProvider.httpHost=0.0.0.0</span></span><br><span class="line"><span class="comment">#metricsProvider.httpPort=7000</span></span><br><span class="line"><span class="comment">#metricsProvider.exportJvmInfo=true</span></span><br></pre></td></tr></table></figure><blockquote><ul><li>tickTimeï¼šè¿™ä¸ªæ—¶é—´æ˜¯ä½œä¸º Zookeeper æœåŠ¡å™¨ä¹‹é—´æˆ–å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ª tickTime æ—¶é—´å°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³ã€‚</li><li>initLimitï¼šLFåˆå§‹é€šä¿¡æ—¶é™ï¼Œé›†ç¾¤ä¸­çš„followeræœåŠ¡å™¨ï¼ˆFï¼‰ä¸leaderæœåŠ¡å™¨ï¼ˆLï¼‰ä¹‹é—´åˆå§‹è¿æ¥æ—¶èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ•°ï¼ˆtickTimeçš„æ•°é‡ï¼‰ã€‚</li><li>syncLimitï¼šLFåŒæ­¥é€šä¿¡æ—¶é™ï¼Œé›†ç¾¤ä¸­çš„followeræœåŠ¡å™¨ä¸leaderæœåŠ¡å™¨ä¹‹é—´è¯·æ±‚å’Œåº”ç­”ä¹‹é—´èƒ½å®¹å¿çš„æœ€å¤šå¿ƒè·³æ•°ï¼ˆtickTimeçš„æ•°é‡ï¼‰ã€‚</li><li>dataDirï¼šé¡¾åæ€ä¹‰å°±æ˜¯ Zookeeper ä¿å­˜æ•°æ®çš„ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒZookeeper å°†å†™æ•°æ®çš„æ—¥å¿—æ–‡ä»¶ä¹Ÿä¿å­˜åœ¨è¿™ä¸ªç›®å½•é‡Œã€‚</li><li>clientPortï¼šå®¢æˆ·ç«¯è¿æ¥ç«¯å£ï¼Œè¿™ä¸ªç«¯å£å°±æ˜¯å®¢æˆ·ç«¯è¿æ¥ Zookeeper æœåŠ¡å™¨çš„ç«¯å£ï¼ŒZookeeper ä¼šç›‘å¬è¿™ä¸ªç«¯å£ï¼Œæ¥å—å®¢æˆ·ç«¯çš„è®¿é—®è¯·æ±‚</li><li>autopurge.snapRetainCountï¼šä¿ç•™æ•°é‡ã€‚</li><li>autopurge.purgeIntervalï¼šæ¸…ç†æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šå°æ—¶ã€‚</li><li>server.N = YYY:A:Bï¼Œå…¶ä¸­Nè¡¨ç¤ºæœåŠ¡å™¨ç¼–å·ï¼ŒYYYè¡¨ç¤ºæœåŠ¡å™¨çš„IPåœ°å€ï¼ŒAä¸ºLFé€šä¿¡ç«¯å£ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡å™¨ä¸é›†ç¾¤ä¸­çš„leaderäº¤æ¢çš„ä¿¡æ¯çš„ç«¯å£ã€‚Bä¸ºé€‰ä¸¾ç«¯å£ï¼Œè¡¨ç¤ºé€‰ä¸¾æ–°leaderæ—¶æœåŠ¡å™¨é—´ç›¸äº’é€šä¿¡çš„ç«¯å£ï¼ˆå½“leaderæŒ‚æ‰æ—¶ï¼Œå…¶ä½™æœåŠ¡å™¨ä¼šç›¸äº’é€šä¿¡ï¼Œé€‰æ‹©å‡ºæ–°çš„leaderï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé›†ç¾¤ä¸­æ¯ä¸ªæœåŠ¡å™¨çš„Aç«¯å£éƒ½æ˜¯ä¸€æ ·ï¼Œæ¯ä¸ªæœåŠ¡å™¨çš„Bç«¯å£ä¹Ÿæ˜¯ä¸€æ ·ã€‚ä½†æ˜¯å½“æ‰€é‡‡ç”¨çš„ä¸ºä¼ªé›†ç¾¤æ—¶ï¼ŒIPåœ°å€éƒ½ä¸€æ ·ï¼Œåªèƒ½æ—¶Aç«¯å£å’ŒBç«¯å£ä¸ä¸€æ ·ã€‚</li></ul></blockquote><p>è¯¦ç»†ä»‹ç»å¯å‚è€ƒ: <a href="https://blog.csdn.net/zlbdmm/article/details/109669049">https://blog.csdn.net/zlbdmm/article/details/109669049</a></p><p>éœ€è¦æ³¨æ„çš„æ˜¯, <code>Zookeeper</code>åœ¨<code>3.5</code>ç‰ˆæœ¬åä¼šå ç”¨<code>8080</code>ç«¯å£, æ‰€ä»¥éœ€è¦ä½¿ç”¨<code>8080</code>ç«¯å£çš„è¦ä¿®æ”¹ç«¯å£å·</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹å ç”¨çš„8080ç«¯å£å·ä¸ºè‡ªå·±æƒ³è¦ä½¿ç”¨çš„ç«¯å£å·</span></span><br><span class="line"><span class="attr">admin.serverPort</span>=<span class="string">8079 </span></span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨"><a class="markdownIt-Anchor" href="#å¯åŠ¨"></a> å¯åŠ¨</h4><p>è¿›å…¥<code>bin</code>ç›®å½•, <code>Windows</code>ä½¿ç”¨<code>zkServer.cmd</code>æ–‡ä»¶å¯åŠ¨, <code>Linux</code>ä½¿ç”¨<code>zkServer.sh</code>æ–‡ä»¶å¯åŠ¨</p><h3 id="å¼•å…¥zookeeper"><a class="markdownIt-Anchor" href="#å¼•å…¥zookeeper"></a> å¼•å…¥<code>Zookeeper</code></h3><h4 id="æ·»åŠ ä¾èµ–"><a class="markdownIt-Anchor" href="#æ·»åŠ ä¾èµ–"></a> æ·»åŠ ä¾èµ–</h4><ol><li><p>çˆ¶çº§é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2022.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äºä¸‹è½½ä½¿ç”¨çš„<code>Zookeeper</code>æ˜¯æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬, æ‰€ä»¥æ­¤å¤„å¼•å…¥çš„<code>spring-cloud-dependencies</code>ä¹Ÿä½¿ç”¨äº†æœ€æ–°ç‰ˆæœ¬, å°½é‡é¿å…ç‰ˆæœ¬é—®é¢˜</p><p>ä¸Šç¯‡ä¸­ä»‹ç»åˆ°, åœ¨<code>&lt;dependencyManagement&gt;</code>æ ‡ç­¾ä¸­å¼•å…¥é¢„å®šä¹‰ç»„ä¾èµ–æ—¶, éœ€è¦ä½¿ç”¨<code>&lt;scope&gt;import&lt;/scope&gt;</code>æ¥è¡¨ç¤ºå¯¼å…¥è¯¥ä¾èµ–ä¸­ç®¡ç†çš„ä¾èµ–. <code>spring-cloud-dependencies</code>å°±æ˜¯é¢„å®šä¹‰ä¾èµ–ç»„, å®ƒçš„<code>pom</code>æ–‡ä»¶ä¸­åªæ˜¯åœ¨<code>&lt;dependencyManagement&gt;</code>ä¸­å®šä¹‰äº†å¼•å…¥ä¾èµ–åŠå…¶ç‰ˆæœ¬, æœ¬èº«å¹¶æ²¡æœ‰è¿™äº›ä¾èµ–, æ‰€ä»¥é¡¹ç›®åœ¨å¼•å…¥æ—¶, éœ€è¦ä½¿ç”¨<code>&lt;scope&gt;import&lt;/scope&gt;</code>æ¥å°†å…¶ç®¡ç†çš„ä¾èµ–å¯¼å…¥, ä½†å…·ä½“å¯¼å…¥ä½¿ç”¨å“ªäº›ä¾èµ–, éœ€è¦åœ¨å­é¡¹ç›®ä¸­çš„<code>&lt;dependencies&gt;</code>ä¸­å®šä¹‰</p></li><li><p>å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4><ol><li><p>é…ç½®æ–‡ä»¶</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dict-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># å®ä¾‹ host å¯¹åº” zookeeper æ•°æ®çš„ address</span></span><br><span class="line">        <span class="attr">instance-host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="comment"># å®ä¾‹ port å¯¹åº” zookeeper æ•°æ®çš„ port</span></span><br><span class="line">        <span class="attr">instance-port:</span> <span class="number">8060</span></span><br><span class="line">        <span class="comment"># å®ä¾‹ id å¯¹åº” zookeeper æ•°æ®çš„ id</span></span><br><span class="line">        <span class="attr">instance-id:</span> <span class="string">dict-services-01</span></span><br><span class="line">      <span class="comment"># é…ç½®zookeeperçš„æœåŠ¡åœ°å€, å¤šä¸ªä½¿ç”¨ , éš”å¼€</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @EnableDiscoveryClient æ³¨è§£å¼€å¯æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ä½¿ç”¨zookeeper"><a class="markdownIt-Anchor" href="#ä½¿ç”¨zookeeper"></a> ä½¿ç”¨<code>Zookeeper</code></h3><ol><li><p>å¯åŠ¨æœåŠ¡</p><ul><li><p>å¯åŠ¨<code>Zookeeper</code></p></li><li><p>å¯åŠ¨é¡¹ç›®</p><p><a href="#é—®é¢˜ä¸€">ä½ çœ‹, æˆ‘è¯´çš„ä¼šå‡ºç°ç‰ˆæœ¬é—®é¢˜å§, å®ƒæç¤ºæˆ‘ä½¿ç”¨<code>3.0.x</code>æˆ–è€…<code>3.1.x</code>çš„<code>SpringBoot</code></a></p></li></ul></li><li><p>æŸ¥çœ‹<code>Zookeeper</code></p><p>ä½¿ç”¨<code>ZooInspector</code>æˆ–è€…<code>PrettyZoo</code>å·¥å…·, æŸ¥çœ‹<code>Zookeeper</code>ä¸­çš„å†…å®¹</p><p><img src="Zookeeper%E6%B3%A8%E5%86%8C%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA.png" alt="Zookeeperæ³¨å†Œç»“æœå±•ç¤º" /></p><p><img src="Zookeeper%E4%B8%AD%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C%E4%BF%A1%E6%81%AF%E6%A0%BC%E5%BC%8F%E5%8C%96.png" alt="Zookeeperä¸­æœåŠ¡çš„æ³¨å†Œä¿¡æ¯æ ¼å¼åŒ–" /></p></li><li><p>ä¿®æ”¹æ ¹èŠ‚ç‚¹</p><p>ä¸Šè¿°å›¾ç‰‡ä¸­, æœåŠ¡æ³¨å†Œåˆ°<code>Zookeeper</code>ä¸­çš„çš„<code>services</code>æ ¹èŠ‚ç‚¹ä¸­, è¿™æ˜¯é»˜è®¤çš„æ ¹èŠ‚ç‚¹, å¦‚æœæƒ³è¦è‡ªå®šä¹‰æ ¹èŠ‚ç‚¹æˆ–è€…å¤šçº§èŠ‚ç‚¹, å¯ä»¥ä½¿ç”¨<code>root</code>é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># é…ç½®æ ¹èŠ‚ç‚¹ä¸º/dev, å…¶ä¸‹æœ‰å­èŠ‚ç‚¹/services, å°†æœåŠ¡æ³¨å†Œåˆ° /dev/services èŠ‚ç‚¹ä¸‹</span></span><br><span class="line">        <span class="attr">root:</span> <span class="string">/dev/services</span></span><br><span class="line">      <span class="comment"># é…ç½®zookeeperçš„æœåŠ¡åœ°å€, å¤šä¸ªä½¿ç”¨ , éš”å¼€</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="æœåŠ¡è°ƒç”¨"><a class="markdownIt-Anchor" href="#æœåŠ¡è°ƒç”¨"></a> æœåŠ¡è°ƒç”¨</h3><p>ä½¿ç”¨<code>OpenFeign</code>è¿›è¡ŒæœåŠ¡é—´çš„è°ƒç”¨</p><ol><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &#123;&quot;com.xiaolin.*.clients&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenFeignConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¡®è®¤è¢«è°ƒç”¨æœåŠ¡çš„<code>API</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„, æ­¤é¡¹ç›®çš„context-pathé…ç½®æ˜¯æ·»åŠ äº† /user çš„, æ‰€ä»¥æ­¤è®¿é—®è·¯å¾„ä¸º ip:port/user/get/&#123;id&#125;</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; getById(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(userService.getById(id));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º<code>OpenFeign</code>çš„æœåŠ¡è°ƒç”¨å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(&quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserServiceClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    ApiResult&lt;UserEntity&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæµ‹è¯•ç”¨ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDictTypeService dictTypeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; get(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(dictTypeService.get(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;DictTypeMapper, DictTypeEntity&gt; <span class="keyword">implements</span> <span class="title class_">IDictTypeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceClient userServiceClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">get</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">DictTypeEntity</span> <span class="variable">type</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(id);</span><br><span class="line">        result.put(<span class="string">&quot;dictType&quot;</span>, type);</span><br><span class="line">        ApiResult&lt;UserEntity&gt; re = userServiceClient.getById(type.getCreator());</span><br><span class="line">        <span class="keyword">if</span> (!Objects.isNull(re)) &#123;</span><br><span class="line">            result.put(<span class="string">&quot;user&quot;</span>, re.getData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æµ‹è¯•ç»“æœ</p><p><img src="Zookeeper%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="Zookeeperæ³¨å†Œä¸­å¿ƒæœåŠ¡è°ƒç”¨æµ‹è¯•ç»“æœ" /></p></li></ol><h3 id="é…ç½®ä¸­å¿ƒ"><a class="markdownIt-Anchor" href="#é…ç½®ä¸­å¿ƒ"></a> é…ç½®ä¸­å¿ƒ</h3><ol><li><p>æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä½¿ç”¨Zookeeperé…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å…è®¸ä½¿ç”¨bootstrap --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="#é—®é¢˜äºŒ"><code>bootstrap.yml</code>çš„å¯¼å…¥é—®é¢˜</a></p></li><li><p>ä¿®æ”¹é…ç½®</p><p>åœ¨æœåŠ¡é¡¹ç›®çš„<code>resources</code>ç›®å½•ä¸‹æ·»åŠ <code>bootstrap.yml</code>æ–‡ä»¶, å°†é¡¹ç›®é…ç½®å’Œ<code>Zookeeper</code>é…ç½®æ·»åŠ åˆ°<code>bootstrap.yml</code>ä¸­</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8680</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/dict</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dict-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># é…ç½®zookeeperçš„æœåŠ¡åœ°å€, å¤šä¸ªä½¿ç”¨ , éš”å¼€</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># é…ç½®æ‰€åœ¨èŠ‚ç‚¹</span></span><br><span class="line">        <span class="attr">root:</span> <span class="string">/config/dev</span></span><br><span class="line">        <span class="comment"># application.nameä¸profileçš„åˆ†å‰²ç¬¦, æ¯”å¦‚è¦ç»™dict-serviceçš„devç¯å¢ƒé…ç½®ä¸€ä¸ªproject.version, åˆ™é…ç½®çš„èŠ‚ç‚¹åç§°ä¸º/config/dev/dict-service,dev/project.version</span></span><br><span class="line">        <span class="attr">profile-separator:</span> <span class="string">&quot;,&quot;</span></span><br></pre></td></tr></table></figure><p><code>application.yml</code>æ–‡ä»¶ä¸­å¯ä»¥æ·»åŠ å…¶ä»–é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨application.ymlæ–‡ä»¶ä¸­æ·»åŠ é…ç½®, æ­¤å¤„æ˜¯ä¸ºäº†è®©ç¨‹åºå¯åŠ¨æ—¶, å¯ä»¥è¯»å–åˆ°é…ç½®è€Œä¸æŠ¥é”™</span></span><br><span class="line"><span class="attr">project:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p><a href="#é—®é¢˜å››">é…ç½®æ–‡ä»¶é…ç½®</a></p></li><li><p>æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/type&quot;)</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//å¼€å¯å±æ€§æ›´æ–°åŠŸèƒ½ï¼Œè®©è¿™ä¸ªbeané‡Œé¢çš„å±æ€§ä¼šæ ¹æ®é…ç½®ä¸­å¿ƒçš„ä¿®æ”¹è€ŒåŒæ­¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.version&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String projectVersion;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/version&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; version() &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(projectVersion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>Zookeeper</code>ä¸­æ·»åŠ é…ç½®</p><p><img src="Zookeeper%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9%E6%A0%BC%E5%BC%8F.png" alt="Zookeeperé¡¹ç›®é…ç½®å†…å®¹æ ¼å¼" /><br />æ­¤å¤„ä½¿ç”¨<code>Zookeeper</code>å¯è§†åŒ–å·¥å…·<code>PrettyZoo</code></p></li><li><p>ç»“æœ</p><p><img src="Zookeeper%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="Zookeeperé…ç½®ä¸­å¿ƒæµ‹è¯•ç»“æœ" /></p></li></ol><h3 id="å»ºè®®"><a class="markdownIt-Anchor" href="#å»ºè®®"></a> å»ºè®®</h3><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Your project setup is incompatible with our requirements due to following reasons:</span><br><span class="line"></span><br><span class="line">- Spring Boot [3.2.0] is not compatible with this Spring Cloud release train</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Consider applying the following actions:</span><br><span class="line"></span><br><span class="line">- Change Spring Boot version to one of the following versions [3.0.x, 3.1.x] .</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : <code>SpringCloud</code>ç‰ˆæœ¬æ›´æ–°è·Ÿä¸ä¸Š<code>SpringBoot</code>ç‰ˆæœ¬æ›´æ–°é€Ÿåº¦</p><p>è§£å†³æ–¹æ¡ˆ: å°†<code>SpringBoot</code>ç‰ˆæœ¬é™ä½åˆ°<code>3.1.5</code></p><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><p>é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line"></span><br><span class="line">No spring.config.import property has been defined</span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Add a spring.config.import=zookeeper: property to your configuration.</span><br><span class="line">If configuration is not required add spring.config.import=optional:zookeeper: instead.</span><br><span class="line">To disable this check, set spring.cloud.zookeeper.config.enabled=false or </span><br><span class="line">spring.cloud.zookeeper.config.import-check.enabled=false.</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : ç”±äº<code>bootstrap.yml</code>æ˜¯ç³»ç»Ÿçº§çš„èµ„æºé…ç½®æ–‡ä»¶ï¼Œæ˜¯ç”¨åœ¨ç¨‹åºå¼•å¯¼æ‰§è¡Œæ—¶æ›´åŠ æ—©æœŸé…ç½®ä¿¡æ¯è¯»å–ï¼›è€Œ<code>application.yml</code>æ˜¯ç”¨æˆ·çº§çš„èµ„æºé…ç½®æ–‡ä»¶ï¼Œæ˜¯ç”¨æ¥åç»­çš„ä¸€äº›é…ç½®æ‰€éœ€è¦çš„å…¬å…±å‚æ•°ã€‚ <code>bootstrap.yml</code>æ¯”<code>application.yml</code>çš„ä¼˜å…ˆçº§è¦é«˜. <code>SpringCloud</code> ç‰ˆæœ¬æŠŠ<code>bootstrap</code>ç¦ç”¨äº†ï¼Œå¯¼è‡´åœ¨è¯»å–æ–‡ä»¶çš„æ—¶å€™è¯»å–ä¸åˆ°è€ŒæŠ¥é”™.</p><p>è§£å†³æ–¹æ¡ˆ: æ·»åŠ <code>spring-cloud-starter-bootstrap</code>ä¾èµ–, <code>bootstrap</code>ä»æ–°å¯¼å…¥è¿›æ¥</p><p><i id="é—®é¢˜ä¸‰">é—®é¢˜ä¸‰</i></p><p>é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.yaml.snakeyaml.parser.ParserException: while parsing a block node</span><br><span class="line"> in &#x27;reader&#x27;, line 22, column 28:</span><br><span class="line">            profile-separator: ,</span><br><span class="line">                               ^</span><br><span class="line">expected the node content, but found &#x27;,&#x27;</span><br><span class="line"> in &#x27;reader&#x27;, line 22, column 28:</span><br><span class="line">            profile-separator: ,</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : è¯»å–é…ç½®æ—¶ä¸ç¬¦åˆè¦æ±‚</p><p>è§£å†³æ–¹æ¡ˆ: <code>profile-separator</code>é…ç½®çš„å€¼ä¸€å®šè¦ç”¨<code>&quot;&quot;</code>æ‹¬èµ·æ¥</p><p><i id="é—®é¢˜å››">é—®é¢˜å››</i></p><p>é—®é¢˜:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not resolve placeholder &#x27;project.version&#x27; in value &quot;$&#123;project.version&#125;&quot;</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰æ·»åŠ <code>project.version</code></p><p>è§£å†³æ–¹æ¡ˆ: åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®</p><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><p><code>Zookeeper</code>è¯¦è§£</p>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
            <tag> æ³¨å†Œä¸­å¿ƒ </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQLç³»åˆ—(ä¸€)---å®‰è£…</title>
      <link href="/2023/11/27/mysql/MySQL%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85/"/>
      <url>/2023/11/27/mysql/MySQL%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>æ•°æ®åº“æ˜¯åç«¯å¿…é¡»è¦æŒæ¡çš„ä¸€é¡¹å†…å®¹, <code>MySQL</code>æ˜¯æ•°æ®åº“ä¸­å­¦ä¹ å’Œä½¿ç”¨æ¯”è¾ƒæ–¹ä¾¿çš„, æ‰€ä»¥æœ¬æ¬¡å°±æ¥å­¦ä¹ ä¸€ä¸‹<code>MySQL</code>æ•°æ®åº“</p><p>æ­¤å¤„å­¦ä¹ ä½¿ç”¨çš„æ˜¯<code>MySQL8</code>, æ–°ç‰ˆæœ¬çš„å®‰è£…å’Œä½¿ç”¨æ€»æ˜¯é‚£ä¹ˆçš„å¸å¼•äºº.</p><p>æœ¬æ¬¡å°†<code>Windows</code>å’Œ<code>Linux</code>ç³»ç»Ÿä¸­å®‰è£…<code>MySQL8</code>ç»Ÿä¸€ä»‹ç», <code>Windows</code>ä½¿ç”¨<code>zip</code>åŒ…çš„æ ¼å¼, <code>Linux</code>ä½¿ç”¨å‘½ä»¤ä¸‹è½½</p><p>å½“å‰é˜¶æ®µ<code>Docker</code>ç››è¡Œ, è®©å¼€å‘è€…ä¸å†éœ€è¦å»èŠ±è´¹æ—¶é—´å…³æ³¨ç¯å¢ƒ, ä½†æ˜¯å·¥å…·çš„ç›®çš„æ˜¯æé«˜æ•ˆç‡èŠ‚çœæ—¶é—´è€Œä¸æ˜¯ä½¿äººé€€åŒ–, æ‰€ä»¥ä¾ç„¶è¦å­¦ä¼šå®‰è£…</p><h3 id="windows"><a class="markdownIt-Anchor" href="#windows"></a> Windows</h3><h4 id="ä¸‹è½½"><a class="markdownIt-Anchor" href="#ä¸‹è½½"></a> ä¸‹è½½</h4><ol><li><p>ä¸‹è½½åœ°å€: <a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></p></li><li><p>ä½¿ç”¨<code>bing</code>æœç´¢<code>mysql8 windows zip</code>.  <font color="red">ä¸è¦ä½¿ç”¨ç™¾åº¦!ä¸è¦ä½¿ç”¨ç™¾åº¦!ä¸è¦ä½¿ç”¨ç™¾åº¦!</font> æœç´¢ç»“æœä¸­æ‰¾<code>MySQL Community Server</code></p><p><img src="MySQL%E7%9A%84Windows%E5%8E%8B%E7%BC%A9%E5%8C%85%E6%90%9C%E7%B4%A2.png" alt="MySQLçš„Windowså‹ç¼©åŒ…æœç´¢" /></p></li><li><p>æœ¬æ¬¡ä½¿ç”¨çš„æ˜¯<code>mysql-8.0.35-winx64.zip</code></p></li></ol><h4 id="å®‰è£…"><a class="markdownIt-Anchor" href="#å®‰è£…"></a> å®‰è£…</h4><h5 id="è§£å‹ç¼©"><a class="markdownIt-Anchor" href="#è§£å‹ç¼©"></a> è§£å‹ç¼©</h5><p>è§£å‹ç¼©åˆ°æƒ³è¦çš„æ–‡ä»¶å¤¹ä¸‹, ä¿®æ”¹ä¸‹æ–‡ä»¶å¤¹çš„åå­—, ä¸»è¦æ˜¯ä¸è¦è®©å®ƒé‚£ä¹ˆé•¿: <code>mysql-8.0.35</code></p><p><mark>æ³¨æ„ä»¥ä¸‹çš„<code>D:/software/mysql-8.0.35</code>æ˜¯æˆ‘<code>mysql8</code>çš„å®‰è£…ç›®å½•, åº”æ ¹æ®ä¸ªäººå®‰è£…ä½ç½®æŸ¥æ‰¾ç›¸å…³å†…å®¹</mark></p><h5 id="é…ç½®ç¯å¢ƒå˜é‡"><a class="markdownIt-Anchor" href="#é…ç½®ç¯å¢ƒå˜é‡"></a> é…ç½®ç¯å¢ƒå˜é‡</h5><p><img src="MySQL%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.png" alt="MySQLé…ç½®ç¯å¢ƒå˜é‡" /></p><h5 id="åˆå§‹åŒ–æ•°æ®åº“"><a class="markdownIt-Anchor" href="#åˆå§‹åŒ–æ•°æ®åº“"></a> åˆå§‹åŒ–æ•°æ®åº“</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize-insecure</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šè¿°å‘½ä»¤åˆå§‹åŒ–æ•°æ®åº“, å¹¶è®¾ç½®é»˜è®¤<code>root</code>å¯†ç ä¸ºç©º, è¿™æ ·åˆæ¬¡ç™»å½•æ—¶å°±ä¸éœ€è¦è¾“å…¥å¯†ç äº†</p><p><img src="MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt="MySQLæ•°æ®åº“åˆå§‹åŒ–" /></p><p><mark>å»ºè®®: åœ¨æ•´ä¸ªå®‰è£…è¿‡ç¨‹ä¸­, ä½¿ç”¨<code>cmd</code>æ‰§è¡Œå‘½ä»¤æ—¶å»ºè®®å…¨éƒ¨ä½¿ç”¨ç®¡ç†å‘˜æ–¹å¼æ‰“å¼€, é¿å…å› ç®¡ç†å‘˜æƒé™å¯¼è‡´å¤±è´¥æˆ–è€…æ‰§è¡ŒæˆåŠŸä½†æ²¡æœ‰æ•ˆæœçš„æƒ…å†µ</mark></p><p>å¦‚æœä½¿ç”¨äº†<code>--initialize</code>, å¯ä»¥é…åˆ<code>--console</code>æŸ¥çœ‹å¯†ç , æˆ–è€…åˆ°<code>D:/software/mysql-8.0.35/data/è®¡ç®—æœºç”¨æˆ·å.err</code>æ–‡ä»¶ä¸­æŸ¥çœ‹å¯†ç </p><h5 id="å®‰è£…æœåŠ¡"><a class="markdownIt-Anchor" href="#å®‰è£…æœåŠ¡"></a> å®‰è£…æœåŠ¡</h5><p>åœ¨<code>mysql</code>çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>my.ini</code>æ–‡ä»¶å¹¶æ·»åŠ é…ç½®</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#å…å¯†ç™»å½•</span></span><br><span class="line"><span class="comment">#æ³¨æ„, ä½¿ç”¨ä¸Šé¢çš„åˆå§‹åŒ–å‘½ä»¤å, ä¸‹é¢çš„è¿™è¡Œé…ç½®ä¸€å®šè¦æ³¨é‡Šæ‰, å¦åˆ™ä¼šå‡ºç°æœåŠ¡å¯åŠ¨æˆåŠŸäº†åˆè‡ªå·±å…³é—­äº†çš„æƒ…å†µ</span></span><br><span class="line"><span class="comment">#skip-grant-tables</span></span><br><span class="line"><span class="comment"># è®¾ç½®3306ç«¯å£</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlçš„å®‰è£…ç›®å½•</span></span><br><span class="line"><span class="attr">basedir</span>=D:/software/mysql-<span class="number">8.0</span>.<span class="number">35</span></span><br><span class="line"><span class="comment"># è®¾ç½® mysqlæ•°æ®åº“çš„æ•°æ®çš„å­˜æ”¾ç›®å½•</span></span><br><span class="line"><span class="attr">datadir</span>=D:/software/mysql-<span class="number">8.0</span>.<span class="number">35</span>/data</span><br><span class="line"><span class="comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">200</span></span><br><span class="line"><span class="comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸º8æ¯”ç‰¹ç¼–ç çš„latin1å­—ç¬¦é›†</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br><span class="line"><span class="attr">sql_mode</span>=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line"><span class="comment"># ä¿®æ”¹é»˜è®¤çš„åŠ å¯†æ–¹å¼ä¸ºmysql_native_password, åœ¨mysql8ä¸­, é»˜è®¤çš„åŠ å¯†æ–¹å¼æ”¹ä¸ºäº†caching_sha2_password</span></span><br><span class="line"><span class="attr">default-authentication-plugin</span>=mysql_native_password </span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br></pre></td></tr></table></figure><p>ç”¨<mark>ç®¡ç†å‘˜èº«ä»½</mark>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld install service_name(é»˜è®¤MySQL) --defaults-file=&quot;xxx\my.ini&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚ mysqld install MySQL8 --defaults-file=<span class="string">&quot;D:\software\mysql-8.0.35\my.ini&quot;</span></span></span><br></pre></td></tr></table></figure><p>æ³¨æ„: æŒ‡å®šé…ç½®æ–‡ä»¶æ—¶, æŒ‡ä»¤æ˜¯<code>--defaults-file</code>, æ³¨æ„<code>default</code>åé¢æœ‰ä¸ª<code>s</code>, å¦åˆ™å¯åŠ¨æ—¶ä¼šå‡ºé”™, åœ¨<code>D:/software/mysql-8.0.35/data/è®¡ç®—æœºç”¨æˆ·å.err</code>æ–‡ä»¶ä¸­ä¼šæœ‰ç±»ä¼¼ä¸€ä¸‹çš„æŠ¥é”™ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2023-11-26T15:45:38.283085Z 0 [ERROR] [MY-000067] [Server] unknown variable &#x27;default-file=D:\software\mysql-8.0.35\my.ini&#x27;.</span><br></pre></td></tr></table></figure><p><img src="MySQL%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E6%88%90%E5%8A%9F.png" alt="MySQLæ³¨å†ŒæœåŠ¡æˆåŠŸ" /></p><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨ç®¡ç†å‘˜æƒé™ä¼šå‡ºç°ä¸€ä¸‹é”™è¯¯</p><p><img src="MySQL%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E6%97%B6%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%83%E9%99%90.png" alt="MySQLæ³¨å†ŒæœåŠ¡æ—¶æ²¡æœ‰ä½¿ç”¨ç®¡ç†å‘˜æƒé™" /></p><p>å¦‚æœæƒ³åˆ é™¤æœåŠ¡, å¯ä»¥ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤åˆ é™¤</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sc</span> delete service_name</span><br></pre></td></tr></table></figure><p><img src="MySQL%E5%88%A0%E9%99%A4%E6%9C%8D%E5%8A%A1.png" alt="MySQLåˆ é™¤æœåŠ¡" /></p><p>æˆ–è€…ä½¿ç”¨<code>mysql</code>çš„å‘½ä»¤åˆ é™¤<code>MySQL</code>æœåŠ¡</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld <span class="literal">--remove</span> service_name</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨æœåŠ¡"><a class="markdownIt-Anchor" href="#å¯åŠ¨æœåŠ¡"></a> å¯åŠ¨æœåŠ¡</h5><ul><li><p>ä½¿ç”¨å‘½ä»¤å¯åŠ¨</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net <span class="built_in">start</span> service_name </span><br><span class="line"><span class="comment"># å¦‚ net start MySQL8</span></span><br></pre></td></tr></table></figure><p><img src="MySQL%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.png" alt="MySQLæœåŠ¡å¯åŠ¨æˆåŠŸ" /></p><p>å¦‚æœå‡ºç°æ— æ³•æ­£å¸¸å¯åŠ¨çš„æç¤º, å¯ä»¥å»æŸ¥çœ‹è‡ªå·±ä¸Šä¸€æ­¥ä¸­<code>defaults</code>æ˜¯ä¸æ˜¯å°‘äº†<code>s</code>æˆ–è€…æŒ‡å‘çš„æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®</p><p>å¦‚æœå‡ºç°æœåŠ¡å¯åŠ¨æˆåŠŸ, ä½†æ˜¯è¿æ¥æ—¶è¿æ¥ä¸ä¸Š, æŸ¥çœ‹æœåŠ¡å‘ç°è‡ªåŠ¨å…³é—­äº†çš„æƒ…å†µ</p><ul><li><p>æŸ¥çœ‹<code>ini</code>æ–‡ä»¶ä¸­<code>skip-grant-tables</code>æ˜¯å¦æ³¨é‡Šæ‰, è¿™ç§æƒ…å†µåœ¨<code>D:/software/mysql-8.0.35/data/è®¡ç®—æœºç”¨æˆ·å.err</code>æœ‰ä»¥ä¸‹ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2023-11-26T15:45:38.283085Z 0 [ERROR] [MY-000067] [Server] TCP/IP, --shared-memory, or --named-pipe should be configured on NT OS.</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¯åŠ¨å°è¯•</p></li><li><p>å…¶ä»–åŸå› å¯ä»¥é€šè¿‡<code>D:/software/mysql-8.0.35/data/è®¡ç®—æœºç”¨æˆ·å.err</code>æŸ¥çœ‹é”™è¯¯æ—¥å¿—</p></li></ul></li><li><p>æ‰‹åŠ¨å¯åŠ¨</p><p><img src="MySQL%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1.png" alt="MySQLæ‰‹åŠ¨å¯åŠ¨æœåŠ¡" /></p><p>å¤±è´¥æƒ…å†µ</p><p><img src="MySQL%E6%89%8B%E5%8A%A8%E5%90%AF%E5%8A%A8%E5%90%8E%E5%81%9C%E6%AD%A2.png" alt="MySQLæ‰‹åŠ¨å¯åŠ¨ååœæ­¢" /></p><p>ä¸Šè¿°é—®é¢˜å¤šåŠæ˜¯<code>my.ini</code>æ–‡ä»¶ä¸­çš„é…ç½®å¯¼è‡´çš„, å¯ä»¥å»<code>D:/software/mysql-8.0.35/data/è®¡ç®—æœºç”¨æˆ·å.err</code>æŸ¥çœ‹é”™è¯¯æ—¥å¿—, ä¸è¡Œçš„è¯ä»å¤´æ¥è¿‡</p></li></ul><h5 id="ç™»å½•"><a class="markdownIt-Anchor" href="#ç™»å½•"></a> ç™»å½•</h5><p>ä½¿ç”¨æ•°æ®åº“è¿æ¥å‘½ä»¤è¿æ¥æ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure><p><img src="MySQL%E7%99%BB%E5%BD%95.png" alt="MySQLç™»å½•" /></p><p>å¦‚æœè¿æ¥å¤±è´¥, åº”è¯¥æ˜¯æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–è€…å¯åŠ¨åè‡ªåŠ¨åœæ­¢äº†</p><h5 id="ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®"><a class="markdownIt-Anchor" href="#ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®"></a> ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line"># ä¿®æ”¹å¯†ç </span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;å¯†ç &#x27;;</span><br><span class="line"># å…è®¸rootç”¨æˆ·è¿œç¨‹ç™»å½•è®¿é—®</span><br><span class="line">UPDATE user SET host=&#x27;%&#x27; WHERE user=&#x27;root&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åœ¨é˜²ç«å¢™ä¸­å¼€æ”¾<code>MySQL</code>æœåŠ¡çš„ç«¯å£</p><p>æ³¨æ„ä¿®æ”¹å¯†ç çš„æ–¹å¼, è¦æ›¿æ¢ä¸€ä¸‹å¯†ç åŠ å¯†æ–¹å¼, å¦åˆ™å¯èƒ½å¯¼è‡´<code>Navicat</code>è¿æ¥ä¸ä¸Šæˆ–è€…è¿œç¨‹è¿æ¥å¤±è´¥</p><p>å¦‚æœå¾ˆä¸å¹¸çš„å¤åˆ¶<code>SQL</code>æ²¡æœ‰æ”¹åŠ¨æ‰§è¡Œåé€€å‡ºäº†, å»ºè®®æ˜¯ä½¿ç”¨<code>Navicat</code>å»è¿æ¥ç™»å½•ä¿®æ”¹å¯†ç , æ¯•ç«Ÿä½¿ç”¨<code>CMD</code>ä¸å¤ªæ–¹ä¾¿</p><h5 id="å‚è€ƒæ–‡ç« "><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« :</h5><p><a href="https://blog.csdn.net/qq_43674360/article/details/121809469">https://blog.csdn.net/qq_43674360/article/details/121809469</a></p><p><a href="https://zhuanlan.zhihu.com/p/442759047">https://zhuanlan.zhihu.com/p/442759047</a></p><p><a href="https://blog.csdn.net/u014672466/article/details/86093534">https://blog.csdn.net/u014672466/article/details/86093534</a></p><h3 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> Linux</h3><p><code>Linux</code>ç³»ç»Ÿæœ¬äººæ˜¯åœ¨<code>Windows</code>ä¸‹çš„<code>Ubuntu</code>è¿›è¡Œçš„</p><ol><li><p>é…ç½®å¥½<code>wsl</code>ç¯å¢ƒ</p></li><li><p>æ‰§è¡Œ<code>wsl --install</code>å®‰è£…é»˜è®¤çš„<code>Ubuntu</code>ç³»ç»Ÿæˆ–è€…ä»<code>Store</code>ä¸­å®‰è£…</p></li><li><p>åˆ›å»º<code>Ubuntu</code>ç³»ç»Ÿçš„ç”¨æˆ·å’Œå¯†ç </p></li><li><p>æ›´æ¢æº</p><p>æ¸…åé•œåƒæºé…ç½®è·å–: <a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/</a></p></li></ol><p>å‚è€ƒæ–‡ç« :</p><p><a href="https://zhuanlan.zhihu.com/p/423249278">https://zhuanlan.zhihu.com/p/423249278</a></p><p><a href="https://blog.csdn.net/chigenb/article/details/105641189">https://blog.csdn.net/chigenb/article/details/105641189</a></p><p><a href="https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/">https://mirror.tuna.tsinghua.edu.cn/help/ubuntu/</a></p><h4 id="ä¸‹è½½å®‰è£…"><a class="markdownIt-Anchor" href="#ä¸‹è½½å®‰è£…"></a> ä¸‹è½½å®‰è£…</h4><p>æ‰§è¡Œå‘½ä»¤ä¸‹è½½å®‰è£…<code>MySQL</code>æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install mysql-server -y</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å®‰è£…å, ç³»ç»Ÿå·²ç»è¿›è¡Œäº†æ•°æ®åº“åˆå§‹åŒ–, æœåŠ¡æ³¨å†Œç­‰æ“ä½œ, ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ</p><p>æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹<code>MySQL</code>æœåŠ¡çŠ¶æ€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql status</span><br></pre></td></tr></table></figure><p><img src="MySQL%E5%AE%89%E8%A3%85%E5%90%8E%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81.png" alt="MySQLå®‰è£…åçš„è¿è¡ŒçŠ¶æ€" /></p><p><code>MySQL</code>å®‰è£…åé»˜è®¤ä¼šè‡ªåŠ¨å¯åŠ¨</p><h4 id="ç™»å½•-2"><a class="markdownIt-Anchor" href="#ç™»å½•-2"></a> ç™»å½•</h4><p>ä½¿ç”¨æ•°æ®åº“è¿æ¥å‘½ä»¤è¿æ¥æ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®-2"><a class="markdownIt-Anchor" href="#ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®-2"></a> ä¿®æ”¹å¯†ç å’Œå…è®¸è¿œç¨‹è®¿é—®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line"># ä¿®æ”¹å¯†ç </span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;å¯†ç &#x27;;</span><br><span class="line"># å…è®¸rootç”¨æˆ·è¿œç¨‹ç™»å½•è®¿é—®</span><br><span class="line">UPDATE user SET host=&#x27;%&#x27; WHERE user=&#x27;root&#x27;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¿®æ”¹å¯†ç çš„æ–¹å¼, è¦æ›¿æ¢ä¸€ä¸‹å¯†ç åŠ å¯†æ–¹å¼, å¦åˆ™å¯èƒ½å¯¼è‡´<code>Navicat</code>è¿æ¥ä¸ä¸Šæˆ–è€…è¿œç¨‹è¿æ¥å¤±è´¥</p><p>ä½¿ç”¨<code>ufw</code>çš„<code>ufw allow 3306</code>ä½¿é˜²ç«å¢™å¼€æ”¾3306ç«¯å£</p><p>ä½¿ç”¨<code>vim /etc/mysql/mysql.conf.d/mysqld.cnf</code>å‘½ä»¤, å°†é…ç½®æ–‡ä»¶ä¸­çš„<code>bind-address = 127.0.0.1</code>æ³¨é‡Šæˆ–è€…æ”¹ä¸º<code>0.0.0.0</code>å¹¶é‡å¯æœåŠ¡</p><p>å®‰è£…<code>net-tools</code>, ä½¿ç”¨<code>ifconfig</code>å‘½ä»¤æŸ¥çœ‹<code>ip</code></p>]]></content>
      
      
      <categories>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloudç³»åˆ—(ä¸€)---é¡¹ç›®åˆ›å»º</title>
      <link href="/2023/11/25/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/"/>
      <url>/2023/11/25/springcloud/SpringCloud%E7%B3%BB%E5%88%97%E4%B8%80%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3><p>æœ€è¿‘æ‰¾å·¥ä½œæœ‰ç‚¹éš¾å—å•Š, å·¥ä½œä¸‰å¹´, åšäº†ä¸‰å¹´çš„<code>cruder</code>, å†å›å¤´å‘ç°, ç°åœ¨æŠ€æœ¯è¦æ±‚éƒ½è¿™ä¹ˆé«˜, è¿™ä¹ˆå¹¿äº†å—? ä¸‰å¹´ä¸‹æ¥, æ‚ä¸ƒæ‚å…«å­¦çš„ä¸å°‘, ä½†æ˜¯ä¸ç³»ç»Ÿä¹Ÿä¸æ·±å…¥, ç°åœ¨æ‰¾ä¸ªæœºä¼šç³»ç»Ÿæ•´ç†ä¸€ä¸‹. åŒæ—¶ä¹Ÿç»™è‡ªå·±ä¸€ç‚¹ç›®æ ‡, çœ‹çœ‹è‡ªå·±èƒ½ä¸èƒ½åšæŒä¸‹æ¥, èƒ½åšæŒå¤šä¹….</p><p>ä¸ºä»€ä¹ˆä¼šé€‰æ‹©ä»<code>SpringCloud</code>å¼€å§‹?</p><ol><li>å¸‚é¢ä¸Šæœ‰è‡ªå·±äº§å“çš„å…¬å¸(å¤§å®¶éƒ½æƒ³å»çš„è‡ªç ”å…¬å¸), å¤§éƒ½åœ¨æ€è€ƒå‘åˆ†å¸ƒå¼è½¬å‹æˆ–è€…å·²ç»å¼€å§‹è½¬å‘åˆ†å¸ƒå¼. è€Œåˆ†å¸ƒå¼ä¸­åº”ç”¨æœ€å¤šæœ€å¹¿çš„å°±æ˜¯<code>SpringCloud</code>äº†, å½“ç„¶ä¹Ÿä¼šä½¿ç”¨<code>SpringCloudAlibaba</code></li><li><code>SpringCloud</code>æ˜¯ä¸€ç§åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ, å…¶ä¸­ç³…åˆäº†å¤šç§æŠ€æœ¯, ä¾¿äºæ•´ç†å­¦ä¹ </li></ol><p>æœ¬ç³»åˆ—å¦‚ä½•å¼€å±•?</p><ol><li>ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ª<code>SpringCloud</code>é¡¹ç›®, ä»å»ºè¡¨å¼€å§‹, ä¸€æ­¥æ­¥æ­å»º, äº‰å–åšåˆ°äºŒæ¬¡å›é¦–æ—¶, æ ¹æ®åšå®¢å³å¯é‡æ–°æ­å»ºå‡ºä¸€æ ·çš„é¡¹ç›®, å½“ç„¶æœ‰å¯èƒ½ä¼šéå¸¸å•°å—¦</li><li>å…³äºé¡¹ç›®æ­å»ºè¿‡ç¨‹ä¸­å‡ºç°çš„é—®é¢˜, æ¯”å¦‚æŠ¥é”™æˆ–è€…æ— æ•ˆæœä¹‹ç±»çš„æƒ…å†µ, ä¼šåœ¨æ¯ç¯‡åšå®¢çš„æœ€åå†™æ˜</li><li>å…³äºæ­å»ºè¿‡ç¨‹ä¸­ä¼šå‡ºç°æ²¡æœ‰å­¦ä¹ è¿‡çš„æŠ€æœ¯, ä¼šå…ˆå»å­¦ä¹ , å±Šæ—¶æœ¬ç³»åˆ—å¯èƒ½ä¼šæ–­æ›´ä¸€æ®µæ—¶é—´</li><li>ç”±äºæ­å»ºè¿‡ç¨‹å¯èƒ½åªæ˜¯å­¦ä¹ ä½¿ç”¨, æ‰€ä»¥å…³äºä½¿ç”¨æŠ€æœ¯çš„æ·±å…¥å­¦ä¹ , ä¼šåœ¨æ¯ä¸€ç¯‡åšæ–‡çš„ç»“å°¾æŒ–å‘æ ‡æ³¨, ç­‰å¾…åç»­å­¦ä¹ </li><li>æ­å»ºè¿‡ç¨‹ä¸­åœ¨ä½¿ç”¨æŠ€æœ¯æ—¶å¯èƒ½ä¼šæƒ³åˆ°ä¸€äº›é¢è¯•é¢˜, æˆ–è€…é¢è¯•é¢˜çš„é«˜å‘åŒº, å¯èƒ½ä¼šæ•´ç†ä¸€ç¯‡ç›¸å…³çš„é¢è¯•é¢˜åˆé›†</li><li>æ­å»ºè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°åç»­ä½¿ç”¨æ—¶é‡åˆ°å‰é¢å†…å®¹çš„é—®é¢˜, åˆ™ä¼šå›åˆ°å‰ç¯‡åšå®¢ä¸­ä¿®æ”¹, å³ä¸ä¿è¯çœ‹åˆ°çš„åšå®¢æ˜¯æœ€ç»ˆç‰ˆ</li><li>ç”±äºæ­¤ç³»åˆ—ç±»ä¼¼ä¸€ä¸ªæµç¨‹ç³»åˆ—, æ‰€ä»¥åœ¨å†™åšå®¢æ—¶å¯¹äºä½¿ç”¨æˆ–è€…å­¦ä¹ çš„å†…å®¹æ²¡æœ‰æ·±å…¥æ€è€ƒ, å¯¼è‡´åšå®¢è´¨é‡ä½, ç”šè‡³ç±»ä¼¼äºè®°æµæ°´è´¦, è¿™ç§æƒ…å†µä¹Ÿä¼šåŒä¸Š, åœ¨åç»­çš„ä½¿ç”¨ä¸­ç»´æŒå‰æœŸåšå®¢çš„æ€è€ƒå’Œæ›´æ–°</li></ol><p>æœ¬ç³»åˆ—ç›®æ ‡?</p><ol><li>ç³»ç»Ÿå­¦ä¹ ç›¸å…³æŠ€æœ¯, å­¦ä¼šæ­å»º<code>SpringCloud</code>é¡¹ç›®æµç¨‹</li><li>æ­å»ºå‡ºä¸€ä¸ªåŸºç¡€é¡¹ç›®, åç»­éœ€è¦æ­å»ºé¡¹ç›®æ—¶å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨, æ¯”å¦‚æ­å»ºå®Œåæ‰“æˆå‹ç¼©åŒ…æˆ–è€…ä¸Šä¼ åˆ°<code>gitee</code>, ä¾¿äºåç»­ä½¿ç”¨</li><li>åç»­å¯èƒ½ä¼šåˆ†ç±»æ­å»º, å°†<code>SpringCloud</code>ç‰ˆæœ¬å’Œ<code>SpringCloudAlibaba</code>ç‰ˆæœ¬åˆ†å¼€, ä½†ä¸ä¿è¯å®Œå…¨éš”ç¦», æ¯”å¦‚äº‹åŠ¡ä¸­å¯èƒ½éƒ½æ˜¯ç”¨<code>Seata</code></li></ol><h3 id="åˆ›å»ºçˆ¶é¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºçˆ¶é¡¹ç›®"></a> åˆ›å»ºçˆ¶é¡¹ç›®</h3><p><code>Type</code>é¡¹é€‰æ‹©<code>Maven POM</code>, ä¸ç†Ÿæ‚‰<code>Gradle</code>, æ‰€ä»¥å…ˆä½¿ç”¨<code>Maven</code></p><p>åˆ›å»ºåå¯ä»¥çœ‹åˆ°<code>POM</code>æ–‡ä»¶ä¸­çš„<code>packaging</code>æ ‡ç­¾çš„å€¼çš„<code>pom</code></p><p>æ³¨: åˆ›å»ºæ—¶é€‰æ‹©åˆé€‚çš„<code>SpringBoot</code>ç‰ˆæœ¬, å¦åˆ™ä¼šæœ‰è®¸å¤šç‰ˆæœ¬é—®é¢˜, æ­¤å¤„ä½¿ç”¨å½“å‰çš„æœ€æ–°ç‰ˆæœ¬<code>3.2.0</code>; <code>JDK</code>çš„ç‰ˆæœ¬é€‰æ‹©ä¹Ÿéœ€è¦æ…é‡, æ­¤å¤„åˆ›å»ºæ—¶é»˜è®¤<code>JDK</code>ç‰ˆæœ¬åœ¨<code>IDEA</code>ä¸­å·²ç»ä¸æ˜¾ç¤º<code>jdk11</code>äº†; æœ¬æ¬¡æ˜¯æ­å»ºå’Œå­¦ä¹ , æ‰€ä»¥ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬, è¸©å‘.</p><p><img src="%E7%88%B6%E9%A1%B9%E7%9B%AE%E4%BF%A1%E6%81%AF.png" alt="çˆ¶é¡¹ç›®ä¿¡æ¯" /></p><h3 id="ç®¡ç†ä¾èµ–"><a class="markdownIt-Anchor" href="#ç®¡ç†ä¾èµ–"></a> ç®¡ç†ä¾èµ–</h3><p>åœ¨åˆ›å»ºçš„çˆ¶é¡¹ç›®ä¸­çš„<code>POM</code>æ–‡ä»¶ä¸­æ·»åŠ <code>dependencyManagement</code>æ ‡ç­¾ç®¡ç†é¡¹ç›®çš„ä¾èµ–ç‰ˆæœ¬</p><p>åœ¨<code>dependencyManagement</code>æ ‡ç­¾ä¸­ç®¡ç†çš„ä¾èµ–:</p><ul><li><p>å¦‚æœæ¥è‡ª<code>Spring</code>é¢„å®šä¹‰çš„ç‰ˆæœ¬, åˆ™éœ€è¦ä½¿ç”¨<code>&lt;type&gt;pom&lt;/type&gt;</code>æ ‡è®°</p></li><li><p>å¦‚æœæ˜¯é¢„å®šä¹‰ä¾èµ–ç»„(è‡ªå®šä¹‰åç§°), åˆ™éœ€è¦ä½¿ç”¨<code>&lt;scope&gt;import&lt;/scope&gt;</code>æ ‡è®°, æ„æ€æ˜¯å°†é¢„å®šä¹‰ä¾èµ–ç»„ä¸‹ç®¡ç†çš„æ‰€æœ‰ä¾èµ–å¯¼å…¥</p></li><li><p>å‚è€ƒæ–‡ç« :</p><p><a href="https://www.cnblogs.com/huahua035/p/7680607.html(%E6%96%87%E7%AB%A0%E4%B8%AD%E7%9A%84%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0)">https://www.cnblogs.com/huahua035/p/7680607.html(æ–‡ç« ä¸­çš„å‚è€ƒæ–‡ç« )</a></p><p><a href="https://www.cnblogs.com/xuzimian/p/10235164.html">https://www.cnblogs.com/xuzimian/p/10235164.html</a></p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºcommonså­é¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºcommonså­é¡¹ç›®"></a> åˆ›å»º<code>commons</code>å­é¡¹ç›®</h3><p><img src="%E5%88%9B%E5%BB%BA%E5%AD%90%E9%A1%B9%E7%9B%AE.png" alt="åˆ›å»ºå­é¡¹ç›®" /></p><p>æ³¨: æ­¤å¤„åˆ›å»ºæ™®é€šçš„<code>Maven</code>é¡¹ç›®å³å¯, éœ€è¦å°†<code>SDK</code>ç‰ˆæœ¬ä¸çˆ¶é¡¹ç›®ä¿æŒä¸€è‡´</p><p><img src="%E5%88%9B%E5%BB%BAcommons%E5%AD%90%E9%A1%B9%E7%9B%AE.png" alt="åˆ›å»ºcommonså­é¡¹ç›®" /></p><p>ä¿®æ”¹<code>POM</code>æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- å°†å…¬å…±ä¾èµ–ä¾èµ–æ·»åŠ åˆ°é¡¹ç›®ä¸­, åˆ™å¼•å…¥å…¬å…±é¡¹ç›®çš„å­é¡¹ç›®å°±ä¸éœ€è¦æŒ¨ä¸ªæ·»åŠ ä¾èµ–äº† --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºå…¬å…±åŒ…å¦‚: <code>com.xxx.util</code>, <code>com.xxx.config</code>, <code>com.xxx.entity</code></p><h3 id="åˆ›å»ºæœåŠ¡å­é¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºæœåŠ¡å­é¡¹ç›®"></a> åˆ›å»ºæœåŠ¡å­é¡¹ç›®</h3><p>ä¸<code>commons</code>é¡¹ç›®ä¸€æ ·, åˆ›å»ºä¸€ä¸ªæ™®é€š<code>Maven</code>é¡¹ç›®, é€šè¿‡æ­¤ç§æ–¹å¼åˆ™ä¸éœ€è¦å†æ“ä½œçˆ¶é¡¹ç›®çš„<code>POM</code>æ–‡ä»¶æ·»åŠ <code>module</code></p><p>ä¿®æ”¹<code>POM</code>æ–‡ä»¶, å¼•å…¥<code>commons</code>é¡¹ç›®ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xiaolin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¯åŠ¨ç±», æ³¨æ„ç±»çš„ä½ç½®, <code>com.xxx.XXXServiceApplication</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(UserServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨, ç¡®è®¤å¯ä»¥æ­£å¸¸ä½¿ç”¨</p><p><a href="#%E9%97%AE%E9%A2%98%E4%BA%8C">å¾ˆæ˜æ˜¾æˆ‘è¿™é‡Œå‡ºé”™äº†</a>ğŸ˜</p><h3 id="åœ¨commonsä¸­ä¾èµ–æ·»åŠ "><a class="markdownIt-Anchor" href="#åœ¨commonsä¸­ä¾èµ–æ·»åŠ "></a> åœ¨<code>commons</code>ä¸­ä¾èµ–æ·»åŠ </h3><p>çˆ¶é¡¹ç›®ä¸­æ·»åŠ <code>web</code>ä¾èµ–å’Œ<code>lombok</code>ä¾èµ–, åœ¨<code>commons</code>ä¸­å¼•å…¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åœ¨æœåŠ¡å­é¡¹ç›®ä¸­è¯·æ±‚æµ‹è¯•"><a class="markdownIt-Anchor" href="#åœ¨æœåŠ¡å­é¡¹ç›®ä¸­è¯·æ±‚æµ‹è¯•"></a> åœ¨æœåŠ¡å­é¡¹ç›®ä¸­è¯·æ±‚æµ‹è¯•</h3><p>åœ¨æœåŠ¡å­é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ªè¯·æ±‚æµ‹è¯•</p><ol><li><p>åœ¨æœåŠ¡å­é¡¹ç›®ä¸­æ·»åŠ é…ç½®æ–‡ä»¶</p></li><li><p>æ·»åŠ æœåŠ¡ç«¯å£é…ç½®å’Œåº”ç”¨åç§°ç­‰é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8180</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/user</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-service</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ è¯·æ±‚æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="åˆ›å»ºè¡¨"><a class="markdownIt-Anchor" href="#åˆ›å»ºè¡¨"></a> åˆ›å»ºè¡¨</h3><p>åˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `sys_user` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT COMMENT &#x27;ä¸»é”®&#x27;,</span><br><span class="line">  `username` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#x27;ç”¨æˆ·å&#x27;,</span><br><span class="line">  `account` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#x27;è´¦æˆ·&#x27;,</span><br><span class="line">  `password` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT &#x27;å¯†ç &#x27;,</span><br><span class="line">  `dept_id` int DEFAULT NULL COMMENT &#x27;éƒ¨é—¨ä¸»é”®&#x27;,</span><br><span class="line">  `stru_id` int DEFAULT NULL COMMENT &#x27;ç»“æ„ä¸»é”®&#x27;,</span><br><span class="line">  `staff_id` int DEFAULT NULL COMMENT &#x27;äººå‘˜ä¸»é”®&#x27;,</span><br><span class="line">  `status` int NOT NULL DEFAULT &#x27;1&#x27; COMMENT &#x27;è´¦æˆ·çŠ¶æ€(0: æ­£å¸¸; 1: é”å®š; 2: åœç”¨;)&#x27;,</span><br><span class="line">  `type` int NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;ç”¨æˆ·ç±»å‹(0: æ™®é€šè‡ªæ³¨å†Œç”¨æˆ·; 1: äººå‘˜ç”¨æˆ·; 2: ç³»ç»Ÿç®¡ç†ç”¨æˆ·)&#x27;,</span><br><span class="line">  `login_time` datetime DEFAULT NULL COMMENT &#x27;ä¸Šæ¬¡ç™»å½•æ—¶é—´&#x27;,</span><br><span class="line">  `expired_time` datetime DEFAULT NULL COMMENT &#x27;è´¦æˆ·è¿‡æœŸæ—¶é—´&#x27;,</span><br><span class="line">  `locked_time` datetime DEFAULT NULL COMMENT &#x27;é”å®šæ—¶é—´, è®°å½•è´¦æˆ·è§£é”æ—¶é—´&#x27;,</span><br><span class="line">  `failure_times` int DEFAULT NULL COMMENT &#x27;å¤±è´¥æ¬¡æ•°,è®°å½•å•æ¬¡ç™»å½•æ—¶çš„è¯·æ±‚æ¬¡æ•°&#x27;,</span><br><span class="line">  `max_session` int DEFAULT NULL COMMENT &#x27;æœ€å¤§ä¼šè¯æ•°(&lt;1ä¸ºæ— é™åˆ¶)&#x27;,</span><br><span class="line">  `deleted` int NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;åˆ é™¤(0: å¦; 1: æ˜¯)&#x27;,</span><br><span class="line">  `create_time` datetime DEFAULT NULL,</span><br><span class="line">  `creator` int DEFAULT NULL,</span><br><span class="line">  `update_time` datetime DEFAULT NULL,</span><br><span class="line">  `update_user` int DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci ROW_FORMAT=DYNAMIC COMMENT=&#x27;ç”¨æˆ·è¡¨(ç³»ç»Ÿç”¨æˆ·å¯ç›´æ¥åˆ›å»º; æ™®é€šç”¨æˆ·éœ€è¦å…ˆåˆ›å»ºäººå‘˜)&#x27;;</span><br></pre></td></tr></table></figure><p><a href="spring_cloud.sql" download>SQLæ–‡ä»¶</a></p><h3 id="åœ¨é¡¹ç›®ä¸­å¼•å…¥æ•°æ®åº“"><a class="markdownIt-Anchor" href="#åœ¨é¡¹ç›®ä¸­å¼•å…¥æ•°æ®åº“"></a> åœ¨é¡¹ç›®ä¸­å¼•å…¥æ•°æ®åº“</h3><ol><li><p>æ·»åŠ æ•°æ®åº“è¿æ¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mysqlæ•°æ®è¿æ¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ä½¿ç”¨é˜¿é‡Œå·´å·´çš„é©±åŠ¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis-plus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ æ•°æ®åº“è¿æ¥é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># æœ€åŸºæœ¬çš„é…ç½®</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/spring_cloud</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºä¸€ä¸ª<code>Mapper</code>è¿›è¡Œæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;SELECT COUNT(*) FROM sys_user&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">count</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserMapperTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">count</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(userMapper.count());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="#%E9%97%AE%E9%A2%98%E4%B8%80">å¾ˆæ˜¾ç„¶æˆ‘åˆå‡ºé”™äº†</a>ğŸ˜‚</p></li></ol><h3 id="åˆ›å»ºä»£ç ç”Ÿæˆé¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºä»£ç ç”Ÿæˆé¡¹ç›®"></a> åˆ›å»ºä»£ç ç”Ÿæˆé¡¹ç›®</h3><p>ä½¿ç”¨<code>MyBatis-Plus</code>çš„ç”Ÿæˆå™¨</p><ol><li><p>åˆ›å»ºä¸€ä¸ªæ™®é€šçš„<code>Maven</code>é¡¹ç›®</p></li><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ•°æ®åº“è¿æ¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ç”Ÿæˆå™¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- æ¨¡æ¿å¼•æ“ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.freemarker<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombokæ”¯æŒ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- éœ€è¦ä½¿ç”¨å…¶ä¸­çš„annotation --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- éœ€è¦ä½¿ç”¨å…¶ä¸­çš„è½¬æ¢å™¨ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeneratorApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/spring_cloud?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;rewriteBatchedStatements=true&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SCHEMA</span> <span class="operator">=</span> <span class="string">&quot;public&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHOR</span> <span class="operator">=</span> <span class="string">&quot;xiaolin&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARENT_PATH</span> <span class="operator">=</span> <span class="string">&quot;com.xiaolin&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROOT</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OUT_PUT_PATH</span> <span class="operator">=</span> <span class="string">&quot;/generator/src/main/java&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DataSourceConfig.<span class="type">Builder</span> <span class="variable">DATA_SOURCE_CONFIG</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataSourceConfig</span></span><br><span class="line">.Builder(URL, USERNAME, PASSWORD);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">manual();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ run</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">manual</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">model</span> <span class="operator">=</span> scanner(<span class="string">&quot;æ¨¡å—åï¼Œå¤šå±‚ç›®å½•ç”¨è‹±æ–‡ç‚¹å·åˆ†éš”&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> ROOT + OUT_PUT_PATH + <span class="string">&quot;/&quot;</span> + PARENT_PATH.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;/&quot;</span> + model.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;/mapper/mapping&quot;</span>;</span><br><span class="line">FastAutoGenerator.create(DATA_SOURCE_CONFIG)</span><br><span class="line"><span class="comment">// æ•°æ®åº“é…ç½®</span></span><br><span class="line">.dataSourceConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">builder.schema(SCHEMA)<span class="comment">//.schema(scanner.apply(&quot;å±äºæ¨¡å¼å&quot;))</span></span><br><span class="line">.dbQuery(<span class="keyword">new</span> <span class="title class_">MySqlQuery</span>())</span><br><span class="line">.typeConvert(<span class="keyword">new</span> <span class="title class_">MySqlTypeConvert</span>())</span><br><span class="line">.keyWordsHandler(<span class="keyword">new</span> <span class="title class_">MySqlKeyWordsHandler</span>());</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// å…¨å±€é…ç½®</span></span><br><span class="line">.globalConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">builder.author(AUTHOR)<span class="comment">//.author(scanner.apply(&quot;è¾“å…¥ä½œè€…å&quot;))</span></span><br><span class="line">.outputDir(ROOT + OUT_PUT_PATH)</span><br><span class="line">.dateType(DateType.TIME_PACK)</span><br><span class="line">.commentDate(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// åŒ…é…ç½®</span></span><br><span class="line">.packageConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">builder.moduleName(model)</span><br><span class="line">.mapper(<span class="string">&quot;mapper&quot;</span>)</span><br><span class="line">.entity(<span class="string">&quot;model.entity&quot;</span>)</span><br><span class="line">.service(<span class="string">&quot;service&quot;</span>)</span><br><span class="line">.serviceImpl(<span class="string">&quot;service.impl&quot;</span>)</span><br><span class="line">.controller(<span class="string">&quot;controller&quot;</span>)</span><br><span class="line">.pathInfo(Collections.singletonMap(OutputFile.xml, path))</span><br><span class="line">.parent(PARENT_PATH);<span class="comment">//.parent(scanner.apply(&quot;è¾“å…¥ç”ŸæˆåŒ…è·¯å¾„&quot;));</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ç­–ç•¥é…ç½®</span></span><br><span class="line">.strategyConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">                    <span class="comment">// builder.addInclude(scanner.apply(&quot;è¾“å…¥éœ€è¦ç”Ÿæˆçš„è¡¨å&quot;));</span></span><br><span class="line">builder.addTablePrefix(<span class="string">&quot;sys_&quot;</span>, <span class="string">&quot;tb_&quot;</span>, <span class="string">&quot;biz_&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">tables</span> <span class="operator">=</span> scanner(<span class="string">&quot;è¡¨åï¼Œå¤šä¸ªè‹±æ–‡é€—å·åˆ†å‰²&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="string">&quot;all&quot;</span>.equalsIgnoreCase(tables)) &#123;</span><br><span class="line">builder.addInclude(tables);</span><br><span class="line">&#125;</span><br><span class="line">builder.entityBuilder()</span><br><span class="line">.naming(NamingStrategy.underline_to_camel)</span><br><span class="line">.superClass(BaseEntity.class)</span><br><span class="line">.enableChainModel()</span><br><span class="line">.enableLombok()</span><br><span class="line">.enableTableFieldAnnotation()</span><br><span class="line">.addSuperEntityColumns(<span class="string">&quot;deleted&quot;</span>, <span class="string">&quot;creator&quot;</span>, <span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;update_time&quot;</span>, <span class="string">&quot;update_user&quot;</span>)</span><br><span class="line">.formatFileName(<span class="string">&quot;%sEntity&quot;</span>)</span><br><span class="line">.idType(IdType.AUTO)</span><br><span class="line">.logicDeleteColumnName(<span class="string">&quot;deleted&quot;</span>)</span><br><span class="line">.build()</span><br><span class="line">.controllerBuilder()</span><br><span class="line">.enableHyphenStyle()</span><br><span class="line">.enableRestStyle()</span><br><span class="line">.formatFileName(<span class="string">&quot;%sController&quot;</span>)</span><br><span class="line">.build()</span><br><span class="line">.serviceBuilder()</span><br><span class="line">.formatServiceFileName(<span class="string">&quot;I%sService&quot;</span>)</span><br><span class="line">.formatServiceImplFileName(<span class="string">&quot;%sServiceImpl&quot;</span>)</span><br><span class="line">.build()</span><br><span class="line">.mapperBuilder()</span><br><span class="line">.enableBaseResultMap()</span><br><span class="line">.enableBaseColumnList()</span><br><span class="line">.formatMapperFileName(<span class="string">&quot;%sMapper&quot;</span>)</span><br><span class="line">.formatXmlFileName(<span class="string">&quot;%sMapper&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// æ¨¡æ¿é…ç½®</span></span><br><span class="line">.templateConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">builder.entity(<span class="string">&quot;/templates/entity.java&quot;</span>)</span><br><span class="line">.service(<span class="string">&quot;/templates/service.java&quot;</span>)</span><br><span class="line">.serviceImpl(<span class="string">&quot;/templates/serviceImpl.java&quot;</span>)</span><br><span class="line">.mapper(<span class="string">&quot;/templates/mapper.java&quot;</span>)</span><br><span class="line">.xml(<span class="string">&quot;/templates/mapper.xml&quot;</span>)</span><br><span class="line">.controller(<span class="string">&quot;/templates/controller.java&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.injectionConfig((scanner, builder) -&gt; &#123;</span><br><span class="line">builder.beforeOutputFile((tableInfo, objectMap) -&gt; &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;tableInfo: &quot;</span> + tableInfo.getEntityName() + <span class="string">&quot; objectMap: &quot;</span> + objectMap.size());</span><br><span class="line">&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// æ¨¡æ¿å¼•æ“é…ç½®</span></span><br><span class="line">.templateEngine(<span class="keyword">new</span> <span class="title class_">FreemarkerTemplateEngine</span>())</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">                    æ¨¡æ¿å¼•æ“é…ç½®ï¼Œé»˜è®¤ Velocity å¯é€‰æ¨¡æ¿å¼•æ“ Beetl æˆ– Freemarker æˆ– Enjoy</span></span><br><span class="line"><span class="comment">                   .templateEngine(new BeetlTemplateEngine())</span></span><br><span class="line"><span class="comment">                   .templateEngine(new FreemarkerTemplateEngine())</span></span><br><span class="line"><span class="comment">                   .templateEngine(new EnjoyTemplateEngine())</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">.execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">scanner</span><span class="params">(String tip)</span> &#123;</span><br><span class="line"><span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">System.out.println(<span class="string">&quot;è¯·è¾“å…¥&quot;</span> + tip + <span class="string">&quot;ï¼š&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (scanner.hasNext()) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">ipt</span> <span class="operator">=</span> scanner.next();</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isNullOrEmpty(ipt)) &#123;</span><br><span class="line"><span class="keyword">return</span> ipt;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è¯·è¾“å…¥æ­£ç¡®çš„&quot;</span> + tip + <span class="string">&quot;ï¼&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å°†ç”Ÿæˆçš„ä»£ç ç§»åŠ¨åˆ°å¯¹åº”é¡¹ç›®ä¸­</p></li></ol><p><code>XxxMapper.xml</code>æ–‡ä»¶ç”Ÿæˆä½ç½®åœ¨<code>java</code>ç›®å½•çš„<code>xxx.xxx.mapper.mapping</code>ç›®å½•ä¸­, éœ€è¦å°†å…¶ç§»åŠ¨åˆ°<code>resource</code>ç›®å½•ä¸‹</p><ol start="5"><li><p>é…ç½®<code>xml</code>æ–‡ä»¶è·¯å¾„</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">classpath*:/mapping/**/*.xml</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®<code>Mapper</code>çš„æ‰«æè·¯å¾„, å»ºè®®åœ¨<code>commons</code>ä¸­é…ç½®, è¿™æ ·æ‰€æœ‰å¼•å…¥<code>commons</code>é¡¹ç›®çš„æœåŠ¡é¡¹ç›®éƒ½ä¸éœ€è¦å†é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(value = &quot;com.xiaolin.**.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å‚è€ƒæ–‡ç« </p><p><a href="https://baomidou.com/pages/779a6e/#%E4%BD%BF%E7%94%A8">https://baomidou.com/pages/779a6e/#ä½¿ç”¨</a></p><p><a href="https://github.com/baomidou/generator/blob/develop/mybatis-plus-generator/src/test/java/com/baomidou/mybatisplus/generator/samples/FastAutoGeneratorTest.java">https://github.com/baomidou/generator/blob/develop/mybatis-plus-generator/src/test/java/com/baomidou/mybatisplus/generator/samples/FastAutoGeneratorTest.java</a></p></li></ol><h3 id="åˆ›å»ºæ–°çš„æœåŠ¡å­é¡¹ç›®"><a class="markdownIt-Anchor" href="#åˆ›å»ºæ–°çš„æœåŠ¡å­é¡¹ç›®"></a> åˆ›å»ºæ–°çš„æœåŠ¡å­é¡¹ç›®</h3><p>ç›´æ¥ä½¿ç”¨<code>Maven</code>æ–¹å¼åˆ›å»º, å¹¶é€šè¿‡ä»£ç ç”Ÿæˆçš„æ–¹å¼ç”Ÿæˆç›¸å…³æ–‡ä»¶</p><p>æ·»åŠ é¡¹ç›®é…ç½®, åˆ›å»ºå¯åŠ¨ç±»</p><h3 id="åˆ›å»ºå…¬å…±çš„è¿”å›ç±»å‹"><a class="markdownIt-Anchor" href="#åˆ›å»ºå…¬å…±çš„è¿”å›ç±»å‹"></a> åˆ›å»ºå…¬å…±çš„è¿”å›ç±»å‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApiState</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getMessage</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResult</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">ApiState</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»Ÿä¸€å¼‚å¸¸å¤„ç†"><a class="markdownIt-Anchor" href="#ç»Ÿä¸€å¼‚å¸¸å¤„ç†"></a> ç»Ÿä¸€å¼‚å¸¸å¤„ç†</h3><ol><li><p>åˆ›å»ºç»Ÿä¸€çš„æœåŠ¡å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> <span class="keyword">implements</span> <span class="title class_">ApiState</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(<span class="type">int</span> state)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(state, (String) <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(<span class="type">int</span> state, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(state, message, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(<span class="type">int</span> state, String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">        <span class="built_in">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceException</span><span class="params">(<span class="type">int</span> state, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(state, <span class="literal">null</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = ServiceException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; handler(ServiceException ex) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[&#123;&#125;] request failure: &#123;&#125;&quot;</span>, LocalDateTime.now(), ex);</span><br><span class="line">        <span class="keyword">return</span> ApiResult.failure(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ·»åŠ éªŒè¯æ¡†æ¶"><a class="markdownIt-Anchor" href="#æ·»åŠ éªŒè¯æ¡†æ¶"></a> æ·»åŠ éªŒè¯æ¡†æ¶</h3><ol><li><p>æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å…¨å±€å¼‚å¸¸å¤„ç†æ·»åŠ å¤„ç†<code>BindException</code>ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler(value = BindException.class)</span></span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;?&gt; handler(BindException ex) &#123;</span><br><span class="line">    log(ex);</span><br><span class="line">    List&lt;String&gt; messages = ex.getAllErrors().stream().map(ObjectError::getDefaultMessage).toList();</span><br><span class="line">    <span class="keyword">return</span> ApiResult.failure(<span class="number">500</span>, messages.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="æ·»åŠ springdocæ¡†æ¶"><a class="markdownIt-Anchor" href="#æ·»åŠ springdocæ¡†æ¶"></a> æ·»åŠ <code>SpringDoc</code>æ¡†æ¶</h3><ol><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">springdoc:</span></span><br><span class="line">  <span class="attr">swagger-ui:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/swagger-ui.html</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDocConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.application.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OpenAPI <span class="title function_">springShopOpenAPI</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OpenAPI</span>()</span><br><span class="line">                .components(<span class="keyword">new</span> <span class="title class_">Components</span>()</span><br><span class="line">                        .addParameters(<span class="string">&quot;token&quot;</span>, <span class="keyword">new</span> <span class="title class_">HeaderParameter</span>().description(<span class="string">&quot;è¯·å¡«å†™token&quot;</span>).schema(<span class="keyword">new</span> <span class="title class_">StringSchema</span>())))</span><br><span class="line">                .info(<span class="keyword">new</span> <span class="title class_">Info</span>().title(applicationName)</span><br><span class="line">                        .description(<span class="string">&quot;spring doc&quot;</span>)</span><br><span class="line">                        .version(<span class="string">&quot;v2.0&quot;</span>)</span><br><span class="line">                        .license(<span class="keyword">new</span> <span class="title class_">License</span>().name(<span class="string">&quot;Apache 2.0&quot;</span>).url(<span class="string">&quot;https://springdoc.org&quot;</span>)))</span><br><span class="line">                .externalDocs(<span class="keyword">new</span> <span class="title class_">ExternalDocumentation</span>().description(<span class="string">&quot;æ¡†æ¶&quot;</span>).url(<span class="string">&quot;https://gitee.com&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ·»åŠ æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Tag(name = &quot;DictTypeController&quot;, description = &quot;å­—å…¸ç±»å‹æ§åˆ¶å™¨&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DictTypeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IDictTypeService dictTypeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Operation(summary = &quot;å­—å…¸ç±»å‹æ–°å¢&quot;, description = &quot;æ–°å¢å­—å…¸ç±»å‹&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ApiResult&lt;?&gt; add(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> DictTypeDTO type) &#123;</span><br><span class="line">        <span class="keyword">return</span> ApiResult.success(dictTypeService.add(type));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç»“æœ</p><p><img src="SpringDoc%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C.png" alt="SpringDocæµ‹è¯•ç»“æœ" /></p></li></ol><h3 id="å»ºè®®"><a class="markdownIt-Anchor" href="#å»ºè®®"></a> å»ºè®®</h3><ol><li>ä¸åŒç±»å‹çš„æœåŠ¡å­é¡¹ç›®ä½¿ç”¨ç›¸ä¼¼çš„ç«¯å£è¡¨ç¤º, å¦‚<code>A</code>æœåŠ¡ä½¿ç”¨<code>818X</code>, <code>B</code>æœåŠ¡ä½¿ç”¨<code>828X</code>, ä¾¿äºè¯†åˆ«å’Œç®¡ç†</li><li>æ‰“ä¸ªå‹ç¼©åŒ…, åç»­ä½¿ç”¨<code>SpringCloudAlibaba</code>æ—¶å¯ä»¥ç›´æ¥ç”¨</li></ol><h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3><p><i id="é—®é¢˜ä¸€">é—®é¢˜ä¸€</i></p><p>é—®é¢˜: <code>Invalid value type for attribute 'factoryBeanObjectType': java.lang.String</code>:</p><p>é—®é¢˜åŸå› : æ·»åŠ æ•°æ®åº“æ—¶, æ²¡æœ‰æ˜¯ç”¨æœ€æ–°çš„<code>mybatis-spring-boot-starter</code>å¸¦æ¥çš„é—®é¢˜</p><p>è§£å†³åŠæ³•: å¼•å…¥åˆé€‚çš„<code>mybatis-spring-boot-starter</code>ç‰ˆæœ¬</p><p>å‚è€ƒæ–‡ç« : <a href="https://blog.csdn.net/weixin_46515691/article/details/134618642">https://blog.csdn.net/weixin_46515691/article/details/134618642</a></p><p><i id="é—®é¢˜äºŒ">é—®é¢˜äºŒ</i></p><p>é—®é¢˜: <code>Error:Cannot determine path to 'tools.jar' library for 17 (D:\Java\jdk17)</code>:</p><p>é—®é¢˜åŸå› : <code>IDEA</code>ç‰ˆæœ¬ä¸æ”¯æŒ<code>JDK</code>ç‰ˆæœ¬, <code>JDK</code>ç‰ˆæœ¬è¿‡é«˜</p><p>è§£å†³åŠæ³•: å‡çº§<code>IDEA</code>ç‰ˆæœ¬æˆ–è€…é™ä½<code>JDK</code>ç‰ˆæœ¬</p><p>å‚è€ƒæ–‡ç« : <a href="https://blog.csdn.net/wangpaiblog/article/details/120407810">https://blog.csdn.net/wangpaiblog/article/details/120407810</a></p><p><i id="é—®é¢˜ä¸‰">é—®é¢˜ä¸‰</i></p><p>é—®é¢˜: ä»£ç ç”Ÿæˆé—®é¢˜</p><ol><li>æ‰¾ä¸åˆ°ç±»<code>freemarker/template/Configuration</code> -&gt; æœªå¼•å…¥<code>freemarker</code>ä¾èµ–</li><li>ä¸ç¬¦åˆè¦æ±‚çš„å‚æ•°: <code>e != java.lang.String</code> -&gt; é…ç½®ç±»åæ—¶<code>%</code>åå°‘äº†<code>s</code>, å¦‚: <code>%sServiceImpl</code>å†™æˆäº†<code>%ServiceImpl</code></li></ol><p><i id="é—®é¢˜å››">é—®é¢˜å››</i></p><p>é—®é¢˜: æ•´åˆ<code>Swagger</code>é—®é¢˜</p><p>é¡¹ç›®åœ¨æ·»åŠ <code>@EnableOpenApi</code>æ³¨è§£ä¹‹å, åœ¨å¯åŠ¨æ—¶ä¼šå‡ºç°é”™è¯¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.TypeNotPresentException: Type javax.servlet.http.HttpServletRequest not present</span><br><span class="line">...</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: javax.servlet.http.HttpServletRequest</span><br></pre></td></tr></table></figure><p>é—®é¢˜åŸå› : <code>SpringBoot3.2.0</code>ç‰ˆæœ¬ä¾èµ–äº<code>jakarta</code>ä¾èµ–åŒ…ï¼Œä½†æ˜¯<code>Swagger</code>ä¾èµ–åº•å±‚åº”ç”¨çš„<code>javax</code>ä¾èµ–åŒ…ï¼Œæ‰€ä»¥åªè¦ä¸€å¯åŠ¨å°±ä¼šæŠ¥é”™ã€‚è¯´ç™½äº†å°±æ˜¯ç‰ˆæœ¬é—®é¢˜</p><p>è§£å†³åŠæ³•:</p><ol><li>é™ä½<code>SpringBoot</code>ç‰ˆæœ¬</li><li>ä½¿ç”¨<code>springdoc-openapi</code></li></ol><h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3><ol><li><code>Spring</code>æœºåˆ¶, æºç </li><li><code>Spring MVC</code>æœºåˆ¶</li><li><code>SpringBoot</code>æœºåˆ¶</li><li><code>SpringDoc</code>ä½¿ç”¨è¯¦æƒ…</li></ol>]]></content>
      
      
      <categories>
          
          <category> SpringCloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringCloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Promise</title>
      <link href="/2023/11/24/js/Promise/"/>
      <url>/2023/11/24/js/Promise/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h2><p>è¿™æ˜¯2021å¹´11æœˆä»½åœ¨<code>CSDN</code>ä¸Šå†™çš„åšå®¢, ç”±äºæœ¬äººä»¥åç«¯ä¸ºä¸», å‰ç«¯å¯¹è‡ªå·±çš„è¦æ±‚æ˜¯ä¼šç”¨å³å¯, æ²¡æœ‰æ·±å…¥å­¦ä¹ , å‰å‡ å¤©é¢è¯•æ—¶è¢«é—®åˆ°<code>js</code>çš„å¼‚æ­¥é—®é¢˜, æœ‰ç‚¹æ‡µ, æ‰€ä»¥ç¿»å‡ºæ¥å†çœ‹ä¸€çœ¼, ä¹Ÿè¡¥å……ç‚¹å†…å®¹</p><h2 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h2><p><code>Promise</code>å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ.å¯¹å¼‚æ­¥æ“ä½œè¿›è¡Œå°è£…,åšé“¾å¼ç¼–ç¨‹<br />é¿å…å¤šé‡å›è°ƒåµŒå¥—</p><h2 id="promiseçš„ä¸‰ç§çŠ¶æ€"><a class="markdownIt-Anchor" href="#promiseçš„ä¸‰ç§çŠ¶æ€"></a> <code>Promise</code>çš„ä¸‰ç§çŠ¶æ€</h2><h5 id="pending"><a class="markdownIt-Anchor" href="#pending"></a> <code>pending</code>:</h5><p>ç­‰å¾…çŠ¶æ€,å¼‚æ­¥æ“ä½œæ²¡æœ‰å®Œæˆ,å¦‚ç½‘ç»œè¯·æ±‚æ²¡æœ‰ç»“æŸ.</p><h5 id="fulfill"><a class="markdownIt-Anchor" href="#fulfill"></a> <code>fulfill</code>:</h5><p>æ»¡è¶³çŠ¶æ€,è¿è¡Œåˆ°äº†ä¸»åŠ¨å›è°ƒ<code>resolve</code>å‡½æ•°çš„ä½ç½®,æ­¤æ—¶ä¼šå›è°ƒ<code>then()</code>.</p><h5 id="reject"><a class="markdownIt-Anchor" href="#reject"></a> <code>reject</code>:</h5><p>æ‹’ç»çŠ¶æ€,è¿è¡Œåˆ°äº†ä¸»åŠ¨å›è°ƒ<code>reject</code>å‡½æ•°çš„ä½ç½®,æ­¤æ—¶ä¼šå›è°ƒ<code>catch()</code>.</p><h2 id="ä½¿ç”¨"><a class="markdownIt-Anchor" href="#ä½¿ç”¨"></a> ä½¿ç”¨</h2><h5 id="åŸºæœ¬ä½¿ç”¨"><a class="markdownIt-Anchor" href="#åŸºæœ¬ä½¿ç”¨"></a> åŸºæœ¬ä½¿ç”¨</h5><blockquote><ol><li>ä½¿ç”¨<code>new</code>å…³é”®å­—åˆ›å»ºä¸€ä¸ª<code>Promise</code></li><li><code>Promise</code>åˆ›å»ºæ—¶éœ€è¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°</li><li>å‚æ•°å‡½æ•°çš„å‚æ•°ä¸º<code>resolve</code>å‡½æ•°å’Œ<code>reject</code>å‡½æ•°</li></ol></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªPromise</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// å¼‚æ­¥å‡½æ•°</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line"><span class="comment">// å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œçš„æˆåŠŸå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°çš„æ“ä½œæ”¹ä¸ºè°ƒç”¨resolveå‡½æ•°</span></span><br><span class="line"><span class="comment">// è°ƒç”¨resolveå‡½æ•°å,Promiseå°±ä¼šåˆ°thenä¸­</span></span><br><span class="line"><span class="comment">// resolveå‡½æ•°ä¸­çš„å‚æ•°å¯ä»¥ä»thençš„å›è°ƒå‡½æ•°ä¸­å–å¾—</span></span><br><span class="line"><span class="title function_">resolve</span>(data)</span><br><span class="line"><span class="comment">// ä¸€æ­¥å‡½æ•°æ‰§è¡Œå®Œçš„å¤±è´¥å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="title function_">reject</span>(error)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line">).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// Promiseä¸­çš„å¼‚æ­¥å‡½æ•°çš„å›è°ƒå‡½æ•°ä¸­çš„æ“ä½œå°±å¯ä»¥å†™åˆ°thençš„å¯¹è°ƒå‡½æ•°ä¸­,å¯ä»¥è·å–resolveå‡½æ•°çš„å‚æ•°</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;then&quot;</span>);</span><br><span class="line"><span class="comment">// å¦‚æœè¿˜æœ‰å¼‚æ­¥æ“ä½œ,å¯ä»¥å†æ¬¡returnä¸€ä¸ªPromise</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="title function_">resolve</span>(res)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;).<span class="title function_">then</span>(res).<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// å¼‚å¸¸æƒ…å†µçš„å›è°ƒ</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h5 id="promiseçš„é“¾å¼è°ƒç”¨"><a class="markdownIt-Anchor" href="#promiseçš„é“¾å¼è°ƒç”¨"></a> <code>Promise</code>çš„é“¾å¼è°ƒç”¨</h5><ol><li></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ä¸€æ­¥æ“ä½œ...</span></span><br><span class="line"><span class="title function_">resolve</span>(data);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// ç»“æœå¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(data + <span class="string">&#x27;111&#x27;</span>);</span><br><span class="line"><span class="comment">// return Promise.reject(err) || throw &quot;err message&quot;</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// ç»“æœå¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(data + <span class="string">&#x27;222&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ol start="2"><li></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ä¸€æ­¥æ“ä½œ...</span></span><br><span class="line"><span class="title function_">resolve</span>(data);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// throw &quot;err message&quot;</span></span><br><span class="line"><span class="comment">// ç»“æœå¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> data + <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// ç»“æœå¤„ç†</span></span><br><span class="line"><span class="keyword">return</span> data + <span class="string">&#x27;222&#x27;</span>;</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span>&#123;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>1.<code>then</code>ä¸­æœŸæœ›ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°,å¦‚æœä¸æ˜¯å‡½æ•°,åˆ™ä¼šå‘ç”Ÿ<code>then</code>ç©¿é€,å³æœ¬æ¬¡<code>then</code>ä¸­çš„å›è°ƒçš„å‚æ•°ç›´æ¥ç»™åˆ°ä¸‹ä¸€ä¸ª<code>then</code>ä¸­,ä¸åšä»»ä½•å¤„ç†.ä½†æ˜¯ä¸ä¼šè¢«<code>catch</code>è·å–<br />2.ç®€å•è¯´,<code>then</code>ä¸­å¦‚æœæœ‰<code>return</code>,åˆ™è¿”å›çš„å†…å®¹æ˜¯ä¸€ä¸ª<code>Promise</code>,<code>return</code>çš„æ•°æ®å¯ä»¥ç›´æ¥ä»ä¸‹ä¸€ä¸ª<code>then</code>ä¸­ä½œä¸ºå‚æ•°è·å–.å¦‚æœæŠ›å‡ºå¼‚å¸¸,åˆ™æ˜¯è¿”å›ä¸€ä¸ª<code>reject</code>çš„<code>Promise</code>,æ•°æ®å¯ä»¥ç›´æ¥ä»<code>catch</code>ä¸­è·å–</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">resolve</span>(<span class="string">&#x27;123&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="string">&#x27;abc&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// æ­¤å¤„çš„dataçš„å€¼æ˜¯123</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="åŒæ—¶å¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œ"><a class="markdownIt-Anchor" href="#åŒæ—¶å¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œ"></a> åŒæ—¶å¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œ</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;<span class="title function_">resolve</span>(data)&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;<span class="title function_">resolve</span>(data)&#125;),</span><br><span class="line">...</span><br><span class="line">]).<span class="title function_">then</span>(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åªæœ‰å½“æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œéƒ½å®Œæˆæ—¶æ‰ä¼šæ‰§è¡Œ<code>then</code>å‡½æ•°,å…¶å›è°ƒçš„å‚æ•°<code>results</code>æ—¶æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„è¿”å›ç»“æœé›†,æ˜¯ä¸€ä¸ªæ•°ç»„</p><p><font color="#00FF00">æ—¥æœŸï¼š2021-11-18</font></p><h2 id="è¡¥å……"><a class="markdownIt-Anchor" href="#è¡¥å……"></a> è¡¥å……</h2><h5 id="promiseçš„ä»»åŠ¡ç±»å‹"><a class="markdownIt-Anchor" href="#promiseçš„ä»»åŠ¡ç±»å‹"></a> <code>Promise</code>çš„ä»»åŠ¡ç±»å‹</h5><ol><li><p>åœ¨æ­¤ä¹‹å‰æ˜¯ä¸äº†è§£<code>js</code>çš„, é€šè¿‡è¿™æ¬¡æ‰çŸ¥é“<code>js</code>æ˜¯å•çº¿ç¨‹çš„, è€Œæ‰€è°“çš„å¼‚æ­¥å®é™…æŒ‡çš„æ˜¯å¼‚æ­¥ä»»åŠ¡</p></li><li><p><code>Promise</code>é€šè¿‡<code>new</code>çš„æ–¹å¼æœ¬èº«å¹¶æ²¡æœ‰å˜ä¸ºå¼‚æ­¥ä»»åŠ¡, åœ¨æ‰§è¡Œåˆ°<code>resolve</code>æˆ–è€…<code>reject</code>ä¹‹åæ‰ä¼šæˆä¸ºå¼‚æ­¥ä»»åŠ¡ç­‰å¾…æ‰§è¡Œ<code>then</code>æˆ–è€…<code>catch</code>å›è°ƒ, æ‰€ä»¥<code>Promise</code>æœ¬èº«æ˜¯åŒæ­¥ä»£ç å—</p></li><li><p>å¼‚æ­¥ä»»åŠ¡ä¼šæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­, ç­‰å¾…æ¡ä»¶ç¬¦åˆåæ‰§è¡Œ(ä¸¤ä¸ªæ–¹é¢: ä¸€æ˜¯æœ¬èº«æ¡ä»¶ç¬¦åˆ, å³å·²ç»æ”¾å…¥äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­; äºŒæ˜¯çº¿ç¨‹æ¡ä»¶ç¬¦åˆ, å³åŒæ­¥å†…å®¹æ‰§è¡Œå®Œæˆå, è¢«äº‹ä»¶å¾ªç¯æœºåˆ¶ä»é˜Ÿåˆ—ä¸­å–å‡º)</p></li></ol><h2 id="æ¨è"><a class="markdownIt-Anchor" href="#æ¨è"></a> æ¨è</h2><p><a href="https://blog.csdn.net/qfc_128220/category_11294044.html">Promiseç³»åˆ—</a></p><p>è¿™ä½è€å“¥å…³äº<code>Promise</code>çš„åšæ–‡å†™çš„å¾ˆæ£’, è¿™ä¸¤å¤©æ¯”è¾ƒå¿™, åªçœ‹äº†(ä¸‰), åç»­è¡¥ä¸Š</p>]]></content>
      
      
      <categories>
          
          <category> js </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æŠ€æœ¯åˆ†äº« </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åšå®¢æ­å»º</title>
      <link href="/2023/11/22/other/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
      <url>/2023/11/22/other/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<!-- toc --><h3 id="ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#ç¯å¢ƒ"></a> ç¯å¢ƒ</h3><ol><li><code>node</code>ç¯å¢ƒ â€”&gt; å®‰è£…<code>node</code></li><li><code>git</code>ç¯å¢ƒ â€”&gt; è‹¥éœ€è¦äº¤ç»™æ‰˜ç®¡ä¸­å¿ƒ, åˆ™éœ€è¦å®‰è£…<code>git</code>ç¯å¢ƒ</li><li><code>hexo</code>ç¯å¢ƒ â€”&gt; åšå®¢æ­å»ºä½¿ç”¨ <code>npm install hexo-cli -g</code></li></ol><h3 id="åšå®¢æ­å»º"><a class="markdownIt-Anchor" href="#åšå®¢æ­å»º"></a> åšå®¢æ­å»º</h3><ol><li><p>åˆ›å»ºä¸€ä¸ªç©ºç›®å½•, ç©ºç›®å½•, ç©ºç›®å½•</p></li><li><p>è¿›å…¥ç©ºç›®å½•ä¸‹æ‰“å¼€å‘½ä»¤è¡Œ</p></li><li><p>æ‰§è¡Œ<code>hexo init</code>å‘½ä»¤, è¿›è¡Œåˆå§‹åŒ–</p><p><img src="init.png" alt="åˆå§‹åŒ–åšå®¢ç›®å½•" /></p><p><img src="init-result.png" alt="åˆå§‹åŒ–åç›®å½•ç»“æœ" /></p></li><li><p>æ‰§è¡Œ<code>hexo s</code>æˆ–è€…<code>hexo server</code>å‘½ä»¤, å³å¯å¯åŠ¨æ­å»ºçš„åšå®¢</p><p><img src="start.png" alt="å¯åŠ¨åšå®¢" /></p><p>è®¿é—®<code>http://localhost:4000/</code>å³å¯æŸ¥çœ‹å½“å‰çš„åšå®¢</p></li><li><p>æ‰§è¡Œ<code>hexo new [layout] &quot;title&quot;</code>å‘½ä»¤, æ–°å»ºä¸€ä¸ªé¡µé¢</p><p><code>layout</code>çš„é€‰é¡¹:</p><p>â€‹<code>post</code>: åšå®¢ â€”&gt; <code>source/_post</code></p><p>â€‹<code>page</code>: è·¯ç”± â€”&gt; <code>source</code></p><p>â€‹<code>draft</code>: ç¨¿ä»¶ â€”&gt; <code>source/_draft</code></p></li></ol><h3 id="ä½¿ç”¨giteeéƒ¨ç½²"><a class="markdownIt-Anchor" href="#ä½¿ç”¨giteeéƒ¨ç½²"></a> ä½¿ç”¨<code>gitee</code>éƒ¨ç½²</h3><ol><li><p>åœ¨<code>gitee</code>ä¸Šæ–°å»ºä»“åº“, å¹¶å°†ä»“åº“åœ°å€é…ç½®åˆ°åšå®¢æ ¹ç›®å½•çš„<code>_config.yml</code>ä¸­, å¦‚ä¸‹</p><p><img src="dploy-config.png" alt="éƒ¨ç½²é…ç½®" /></p></li><li><p>å®‰è£…<code>git</code>éƒ¨ç½²æ’ä»¶<code>npm install hexo-deployer-git --save</code>å’Œ<code>markdown</code>æ¸²æŸ“æ’ä»¶<code>npm install hexo-renderer-marked --save</code></p></li><li><p>æ‰§è¡Œ<code>hexo g</code>æˆ–è€…<code>hexo generate</code>å‘½ä»¤ç”Ÿæˆé™æ€æ–‡ä»¶</p><p>åœ¨<code>public</code>ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„é™æ€æ–‡ä»¶(å°†<code>public</code>ä¸­çš„å†…å®¹æ”¾åˆ°<code>nginx</code>ä¸‹, åšå¥½ç›¸å…³é…ç½®, ä¹Ÿå¯ä»¥å®ç°)</p></li><li><p>æ‰§è¡Œ<code>hexo d</code>æˆ–è€…<code>hexo deploy</code>æ¨é€åˆ°<code>gitee</code></p><p>æ­¤æ—¶å‘ç°<code>gitee</code>ä»“åº“ä¸­å·²ç»æ·»åŠ äº†å†…å®¹, è¿™äº›å†…å®¹æ˜¯<code>public</code>ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶</p><p><img src="gitee-deploy.png" alt="ç äº‘éƒ¨ç½²" /></p><p>æˆåŠŸä¹‹åä¼šç”Ÿæˆè®¿é—®åœ°å€</p></li></ol><blockquote><p><code>gitee</code>çš„<code>Gitee Pages</code>åŠŸèƒ½å·²å…³é—­ï¼Œå¯ä»¥è¿ç§»åˆ°<code>github</code>ä¸Š</p></blockquote><h3 id="ä½¿ç”¨githubéƒ¨ç½²"><a class="markdownIt-Anchor" href="#ä½¿ç”¨githubéƒ¨ç½²"></a> ä½¿ç”¨<code>github</code>éƒ¨ç½²</h3><ol><li><p>åœ¨<code>github</code>ä¸Šæ–°å»ºä»“åº“,ä»“åº“åç§°å¿…é¡»ä¸º<code>xxx.github.io</code>,</p></li><li><p>åœ¨<code>github</code>ä¸Šç”Ÿæˆä¸€ä¸ª<code>access_token</code>ï¼Œéœ€è¦æ³¨æ„æ·»åŠ å“ªäº›æƒé™</p></li><li><p>å°†ä»“åº“åœ°å€é…ç½®åˆ°åšå®¢æ ¹ç›®å½•çš„<code>_config.yml</code>ä¸­, å¦‚ä¸‹</p><p><img src="github-dploy-config.png" alt="éƒ¨ç½²é…ç½®" /></p><blockquote><p>æ³¨æ„ï¼š</p><p>ç½‘ç«™çš„è®¿é—®è·¯å¾„ä¸ä»“åº“åç§°å’Œç”¨æˆ·åç§°éƒ½æœ‰å…³ç³»</p><p>ä»¥<code>https://&#123;access_token&#125;@github.com/xiao-lin-unit/xiao-lin-unit.github.io.git</code>ä¸ºä¾‹</p><ol><li>è§£æè·¯å¾„ä¸º<code>https://&#123;access_token&#125;@github.com/&#123;username&#125;/&#123;repository_name&#125;.git</code>å…¶ä¸­<code>access_token</code>æ˜¯éªŒè¯<code>token</code>ï¼Œ<code>username</code>æ˜¯<code>github</code>ä¸­çš„ç”¨æˆ·åï¼Œ<code>repository_name</code>æ˜¯ä»“åº“å</li><li>ä»“åº“åä»¥<code>&#123;username&#125;.github.io</code>å‘½åï¼Œåˆ™è®¿é—®åœ°å€ä¸º<code>https://&#123;username&#125;.github.io</code></li><li>å¦‚æœæœªæŒ‰ç…§æç¤º2ä¸­çš„æ–¹å¼å‘½åï¼Œåˆ™è®¿é—®è·¯å¾„ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå…·ä½“è®¿é—®è·¯å¾„å¯ä»¥ä»ä»“åº“çš„<code>Settings -&gt; Page</code>sä¸­æŸ¥çœ‹ã€‚å¦‚ï¼Œæˆ‘ä»¥<code>example.github.io</code>å‘½åï¼Œåˆ™è®¿é—®è·¯å¾„å˜æˆäº†<code>https://&#123;username&#125;.github.io/example.github.io</code></li></ol></blockquote><p><img src="github-address.png" alt="githubè®¿é—®åœ°å€" /></p></li><li><p>å®‰è£…<code>git</code>éƒ¨ç½²æ’ä»¶<code>npm install hexo-deployer-git --save</code>å’Œ<code>markdown</code>æ¸²æŸ“æ’ä»¶<code>npm install hexo-renderer-marked --save</code></p></li><li><p>æ‰§è¡Œ<code>hexo g</code>æˆ–è€…<code>hexo generate</code>å‘½ä»¤ç”Ÿæˆé™æ€æ–‡ä»¶</p><p>åœ¨<code>public</code>ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„é™æ€æ–‡ä»¶(å°†<code>public</code>ä¸­çš„å†…å®¹æ”¾åˆ°<code>nginx</code>ä¸‹, åšå¥½ç›¸å…³é…ç½®, ä¹Ÿå¯ä»¥å®ç°)</p></li><li><p>æ‰§è¡Œ<code>hexo d</code>æˆ–è€…<code>hexo deploy</code>æ¨é€åˆ°<code>github</code></p><p>æ­¤æ—¶å‘ç°<code>github</code>ä»“åº“ä¸­å·²ç»æ·»åŠ äº†å†…å®¹, è¿™äº›å†…å®¹æ˜¯<code>public</code>ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶</p><p><img src="gitee-deploy.png" alt="ç äº‘éƒ¨ç½²" /></p><p>æˆåŠŸä¹‹åä¼šç”Ÿæˆè®¿é—®åœ°å€</p></li></ol><blockquote><p>éä¸€é”®éƒ¨ç½²æ–¹å¼å¯é€šè¿‡<a href="https://hexo.io/zh-cn/docs/github-pages">Hexo å®˜ç½‘</a>å­¦ä¹ </p></blockquote><h3 id="ä¿®æ”¹ä¸»é¢˜"><a class="markdownIt-Anchor" href="#ä¿®æ”¹ä¸»é¢˜"></a> ä¿®æ”¹ä¸»é¢˜</h3><ol><li><p>é€‰æ‹©ä¸»é¢˜</p><p>è®¿é—®https://hexo.io/themes/å¯ä»¥é€‰æ‹©è‡ªå·±å–œæ¬¢çš„ä¸»é¢˜</p><p>æœ¬äººé€‰æ‹©çš„æ˜¯<code>hexo-theme-cola</code>è¿™ä¸€æ¬¾, è¿™æ¬¾æ¯”è¾ƒç¬¦åˆæˆ‘çš„æœŸæœ›, è¿˜æœ‰è¯„è®ºåŠŸèƒ½; æœ€å¥½é€‰æ‹©å¸¦æœ‰è¯´æ˜çš„ä¸»é¢˜, æ–¹ä¾¿ä½¿ç”¨, å‰äººæ ½æ ‘åäººä¹˜å‡‰.</p></li><li><p>ä»<code>github</code>ä¸Šä¸‹è½½é€‰æ‹©çš„ä¸»é¢˜, å¹¶å°†æ•´ä¸ªä¸»é¢˜ç›®å½•æ·»åŠ åˆ°<code>themes</code>ç›®å½•ä¸‹</p><p><img src="%E4%B8%BB%E9%A2%98%E7%9B%AE%E5%BD%95%E5%AD%98%E6%94%BE%E4%BD%8D%E7%BD%AE.png" alt="ä¸»é¢˜ç›®å½•å­˜æ”¾ä½ç½®" /></p></li><li><p>æ ¹æ®ä¸»é¢˜ä¸­çš„è¯´æ˜, è¿›è¡Œä¸»é¢˜åˆå§‹åŒ–</p><p><code>hexo-theme-cola</code>ä¸»é¢˜çš„ç›¸å…³åˆå§‹åŒ–å’Œé…ç½®å¯ä»¥æŸ¥çœ‹åŸä½œè€…<code>https://yangxiang.cc/</code>çš„ã€Šå¦‚ä½•ä½¿ç”¨<code>hexo-theme-cola</code>ä¸»é¢˜ã€‹è¿™ä¸€ç¯‡åšå®¢</p><p><img src="%E4%B8%BB%E9%A2%98%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%8E%E7%BB%93%E6%9E%9C.png" alt="ä¸»é¢˜çš„åˆå§‹åŒ–åç»“æœ" /></p></li><li><p>æ ¹æ®éœ€è¦, ä¿®æ”¹é…ç½®æ–‡ä»¶<code>_config.yml</code>ä¸­çš„é…ç½®ä¿¡æ¯</p></li><li><p>è‡ªå®šä¹‰å’Œä¿®æ”¹é…ç½®å†…å®¹</p><ul><li><p>ä¿®æ”¹å†…å®¹: æ ¹æ®é…ç½®æœç´¢å®šä¹‰ä½ç½®, å¦‚: æˆ‘æƒ³åœ¨<code>github</code>çš„å›¾æ ‡å®šä¹‰ä¸ºåŠ¨æ€æ•°é‡çš„, åˆ™å»æŸ¥è¯¢é…ç½®æ–‡ä»¶ä¸­<code>github_url</code>çš„ä½¿ç”¨ä½ç½®(åœ¨<code>main-left.ejs</code>æ–‡ä»¶ä¸­), å¹¶ä¿®æ”¹é…ç½®</p><p><img src="%E4%B8%BB%E9%A2%98%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8.png" alt="ä¸»é¢˜ä¿®æ”¹é…ç½®å’Œä½¿ç”¨" /></p></li><li><p>ä¿®æ”¹<code>icon</code>:</p><ol><li><p>åœ¨https://www.iconfont.cn/manage/indexä¸­åˆ›å»ºè‡ªå·±çš„é¡¹ç›®, æ·»åŠ éœ€è¦çš„æ ‡ç­¾</p><p><img src="iconfont%E6%B7%BB%E5%8A%A0%E6%A0%87%E7%AD%BE%E5%88%B0%E9%A1%B9%E7%9B%AE.png" alt="iconfontæ·»åŠ æ ‡ç­¾åˆ°é¡¹ç›®" /></p></li><li><p>é¡¹ç›®è®¾ç½®</p><p><img src="iconfont%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE.png" alt="iconfonté¡¹ç›®é…ç½®" /></p></li><li><p>ç”Ÿæˆ<code>icon</code>å¼•å…¥æ ¼å¼</p><p><img src="%E7%94%9F%E6%88%90%E5%BC%95%E5%85%A5%E6%A0%BC%E5%BC%8F.png" alt="ç”Ÿæˆå¼•å…¥æ ¼å¼" /></p></li><li><p><code>iconfont</code>çš„å¼•å…¥å’Œä½¿ç”¨</p><p><img src="iconfont%E5%BC%95%E5%85%A5%E5%92%8C%E4%BD%BF%E7%94%A8.png" alt="iconfontå¼•å…¥å’Œä½¿ç”¨" /></p></li></ol></li></ul></li></ol><h3 id="å†™åšå®¢"><a class="markdownIt-Anchor" href="#å†™åšå®¢"></a> å†™åšå®¢</h3><ol><li><p>ä¿®æ”¹é…ç½®ä¸ºæ–‡ä»¶<code>_config.yml</code>ä¸­çš„<code>post_asset_folder</code>é…ç½®é¡¹ä¸º<code>true</code>, å…è®¸æ·»åŠ èµ„æºæ–‡ä»¶å¤¹</p></li><li><p>ä½¿ç”¨<code>hexo new post &quot;blog_name&quot;</code>å‘½ä»¤åˆ›å»ºä¸€ç¯‡åšå®¢, ä¼šåœ¨<code>_posts</code>ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>md</code>æ–‡ä»¶å’Œä¸€ä¸ªåŒåçš„æ–‡ä»¶å¤¹</p><p>å¦‚æœæƒ³è¦å°†åšå®¢ä½¿ç”¨æ–‡ä»¶å¤¹åˆ†å¼€å­˜æ”¾, å¯ä»¥ä½¿ç”¨<code>hexo new post -p xxx/yyy.md</code>å‘½ä»¤åˆ›å»ºåšå®¢, <code>hexo</code>ä¼šåœ¨<code>_post</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ª<code>xxx</code>çš„å­æ–‡ä»¶å¤¹, ç„¶ååœ¨å­æ–‡ä»¶å¤¹ä¸‹åˆ›å»º<code>yyy.md</code>, å¦‚æœæ–‡ä»¶è·¯å¾„ä¸­å«æœ‰ç©ºæ ¼, åˆ™å¿…é¡»ä½¿ç”¨<code>&quot;&quot;</code>æ‹¬èµ·æ¥</p></li><li><p>ç¼–è¾‘<code>md</code>æ–‡ä»¶, ä¹¦å†™åšå®¢<code>title</code>å’Œå†…å®¹</p></li><li><p>æ·»åŠ <code>hexo-asset-img</code>ç»„ä»¶, å¯ä»¥ä½¿ç”¨<code>markdown</code>ä¸­çš„<code>![]()</code>æ ¼å¼æ·»åŠ å›¾ç‰‡</p><p>2023-11-28æ›´æ–°</p><p>æ·»åŠ å›¾ç‰‡çš„æ ¼å¼è¦æ±‚<code>![](filename/example.png)</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> regExp = <span class="title class_">RegExp</span>(<span class="string">&quot;!\\[(.*?)\\]\\(&quot;</span> + fileName + <span class="string">&#x27;/(.+?)\\)&#x27;</span>, <span class="string">&quot;g&quot;</span>);</span><br><span class="line"><span class="comment">// hexo g</span></span><br><span class="line">data.<span class="property">content</span> = data.<span class="property">content</span>.<span class="title function_">replace</span>(regExp, <span class="string">&quot;&#123;% asset_img $2 $1 %&#125;&quot;</span>,<span class="string">&quot;g&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸º<code>hexo-asset-img</code>å¤„ç†å›¾ç‰‡çš„æ ¸å¿ƒä»£ç , å®ƒæ˜¯å°†<code>markdown</code>æ ¼å¼çš„å›¾ç‰‡ä¿¡æ¯æ›¿æ¢ä¸ºç¼–è¯‘æ ¼å¼, ä½¿ç”¨çš„å›¾ç‰‡çš„æ‰€åœ¨ç›®å½•æ˜¯ä¸æ–‡ä»¶ååŒåçš„, æ‰€ä»¥æœ‰å›¾ç‰‡æ ¼å¼è¦æ±‚</p><ol><li><p>å›¾ç‰‡è·¯å¾„å¿…é¡»ä»¥æ–‡ç« çš„æ–‡ä»¶åå¼€å¤´, ä¸èƒ½æ˜¯<code>./</code>, å¦åˆ™æ— æ³•åŒ¹é…, æ³¨æ„æ˜¯æ–‡ä»¶å, è·Ÿæ–‡ç« çš„<code>title</code>æ— å…³</p></li><li><p>æ–‡ä»¶åä¸­ä¸èƒ½å¸¦æœ‰æ­£åˆ™è¡¨è¾¾å¼çš„å…ƒå­—ç¬¦, å¦‚<code>.</code>, <code>()</code>, <code>*</code>, <code>?</code>, <code>+</code>, <code>\</code>ç­‰, å› ä¸ºå¤„ç†ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼æ˜¯å°†æ–‡ä»¶åç›´æ¥æ‹¼æ¥çš„, æ‰€ä»¥å…¶ä¸­çš„åŒ…å«çš„æ­£åˆ™å…ƒå­—ç¬¦æ˜¯æ²¡æœ‰å¤„ç†çš„</p><p>åˆ«é—®æˆ‘ä¸ºå•¥çŸ¥é“çš„, æˆ‘èŠ±äº†ä¸¤ä¸ªå¤šå°æ—¶å‘ç°çš„ğŸ˜­</p><p>æœ€è¿‘å†™çš„ä¸¤ç¯‡åšå®¢çš„æ–‡ä»¶åä¸­ä½¿ç”¨äº†<code>()</code>å…ƒå­—ç¬¦, å‘ç°å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥, ä¹‹å‰çš„æ–‡ç« éƒ½æ˜¯å¯ä»¥çš„, ç„¶åå·´æ‹‰äº†ä¸€å †æ–‡ç« çœ‹æ²¡å•¥ç”¨, å†³å®šè‡ªå·±å»ç¿»æºç çœ‹çœ‹, åˆ«çš„ä¸è¯´<code>hexo-asset-img</code>çš„<code>README.md</code>å†™çš„è¿˜æ˜¯ä¸é”™çš„:</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># hexo-asset-img</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸º<code>README.md</code>çš„å…¨éƒ¨å†…å®¹, å¾ˆç®€æ´å§ğŸ˜‚</p><p>æ²¡åŠæ³•, å»ç¿»çœ‹æºç , è¿˜å¥½æºç æ¯”è¾ƒå°‘, å¥½æ‡‚, ç„¶åæœ€å…³é”®çš„å°±æ˜¯ä¸Šé¢ä¸¤è¡Œ, æˆ‘åœ¨å†…å®¹æ›¿æ¢ä¹‹å‰å’Œæ›¿æ¢ä¹‹ååˆ†åˆ«æ‰“å°äº†ä¸€ä¸‹, å‘ç°äº†é—®é¢˜</p></li></ol></li><li><p>å¦‚æœä¸æƒ³ç›´æ¥å‘å¸ƒåšå®¢ï¼Œå¯ä»¥åˆ›å»ºè‰ç¨¿</p><ol><li>ä½¿ç”¨<code>hexo new draft title -p xxx/yyy.md</code>ä¼šåœ¨<code>_drafts</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>xxx</code>ç›®å½•ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª<code>yyy.md</code>çš„åšå®¢æ–‡ä»¶</li><li><code>scaffolds</code>ç›®å½•ä¸‹æœ‰åšå®¢æ¨¡æ¿ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹æ¨¡æ¿å†…å®¹</li><li>ä½¿ç”¨<code>hexo publish title</code>æ¥å‘å¸ƒåšå®¢</li></ol></li></ol><h3 id="ä¼˜åŒ–åšå®¢å†…å®¹"><a class="markdownIt-Anchor" href="#ä¼˜åŒ–åšå®¢å†…å®¹"></a> ä¼˜åŒ–åšå®¢å†…å®¹</h3><h4 id="ä½¿ç”¨æ’ä»¶"><a class="markdownIt-Anchor" href="#ä½¿ç”¨æ’ä»¶"></a> ä½¿ç”¨æ’ä»¶</h4><ol><li><p>å°†<code>hexo-renderer-marked</code>æ›¿æ¢ä¸º<code>@upupming/hexo-renderer-markdown-it-plus</code></p></li><li><p><code>_config.yml</code>ä¸­æ·»åŠ é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Markdown config</span></span><br><span class="line"><span class="attr">markdown_it_plus:</span></span><br><span class="line">  <span class="attr">render:</span></span><br><span class="line">    <span class="attr">html:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">xhtmlOut:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">breaks:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">linkify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">typographer:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">quotes:</span> <span class="string">&#x27;â€œâ€â€˜â€™&#x27;</span></span><br><span class="line">  <span class="attr">plugins:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-emoji</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-sub</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-sup</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-footnote</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-ins</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-mark</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">plugin:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">markdown-it-katex</span></span><br><span class="line">        <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">anchors:</span></span><br><span class="line">    <span class="comment"># Minimum level for ID creation. (Ex. h2 to h6)</span></span><br><span class="line">    <span class="attr">level:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># A suffix that is prepended to the number given if the ID is repeated.</span></span><br><span class="line"><span class="comment">#    collisionSuffix: &#x27;&#x27;</span></span><br><span class="line">    <span class="attr">collisionSuffix:</span> <span class="string">&#x27;v&#x27;</span></span><br><span class="line">    <span class="comment"># If `true`, creates an anchor tag with a permalink besides the heading.</span></span><br><span class="line">    <span class="attr">permalink:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Class used for the permalink anchor tag.</span></span><br><span class="line">    <span class="attr">permalinkClass:</span> <span class="string">header-anchor</span></span><br><span class="line">    <span class="comment"># Set to &#x27;right&#x27; to add permalink after heading</span></span><br><span class="line">    <span class="attr">permalinkSide:</span> <span class="string">&#x27;left&#x27;</span></span><br><span class="line">    <span class="comment"># The symbol used to make the permalink</span></span><br><span class="line">    <span class="attr">permalinkSymbol:</span> <span class="string">Â¶</span></span><br><span class="line">    <span class="comment"># Transform anchor to (1) lower case; (2) upper case</span></span><br><span class="line">    <span class="attr">case:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># Replace space with a character</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">&#x27;-&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…å¯¹åº”çš„æ’ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install markdown-it-xxx</span><br></pre></td></tr></table></figure></li></ol><h4 id="æ·»åŠ ç›®å½•"><a class="markdownIt-Anchor" href="#æ·»åŠ ç›®å½•"></a> æ·»åŠ ç›®å½•</h4><p>åœ¨æ–‡ç« çš„å¼€å§‹éƒ¨åˆ†æ·»åŠ å¦‚ä¸‹å†…å®¹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- toc --&gt;</span></span><br></pre></td></tr></table></figure><p>è¯¥å†…å®¹ä¸ä¼šåœ¨æ–‡ç« ä¸­æ˜¾ç¤º, è€Œæ˜¯ä¼šç”Ÿæˆç›®å½•, ä½¿ç”¨<code>hexo</code>è‡ªå¸¦çš„<code>toc</code>å‡½æ•°å³å¯æ¸²æŸ“ç›®å½•</p><p>ç›®å½•æ ‡ç­¾ä½¿ç”¨:</p><p><img src="%E7%9B%AE%E5%BD%95%E6%A0%87%E7%AD%BE%E4%BD%BF%E7%94%A8.png" alt="ç›®å½•æ ‡ç­¾ä½¿ç”¨" /></p><p><code>hexo</code>è‡ªå¸¦<code>toc</code>å‡½æ•°æ¸²æŸ“</p><p><img src="Hexo%E8%87%AA%E5%B8%A6toc%E5%87%BD%E6%95%B0%E6%B8%B2%E6%9F%93.png" alt="Hexoè‡ªå¸¦tocå‡½æ•°æ¸²æŸ“" /></p><p><code>hexo</code>è‡ªå¸¦<code>toc</code>å‡½æ•°æ¸²æŸ“ç»“æœ</p><p><img src="Hexo%E8%87%AA%E5%B8%A6toc%E6%B8%B2%E6%9F%93%E7%BB%93%E6%9E%9C.png" alt="Hexoè‡ªå¸¦tocæ¸²æŸ“ç»“æœ" /></p><p>æ­¤å¤„çš„æ¸²æŸ“ç»“æœæŒ‡çš„æ˜¯:</p><ol><li><p>æ·»åŠ é”šç‚¹(å…¶å®ä¸ä½¿ç”¨<code>toc</code>ä¹Ÿæœ‰é”šç‚¹, æ ‡é¢˜æ ‡ç­¾ä¼šæœ‰<code>id</code>å±æ€§, å…¶å€¼å°±æ˜¯æ ‡é¢˜å†…å®¹)</p></li><li><p>æ¸²æŸ“ç›®å½•æ ‡ç­¾, å¤§è‡´å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ol</span> <span class="attr">class</span>=<span class="string">&quot;toc&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ä¸€çº§ç›®å½• --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;toc-item toc-level-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;toc-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#%E7%8E%AF%E5%A2%83&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-number&quot;</span>&gt;</span>1.<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-text&quot;</span>&gt;</span> ç¯å¢ƒ<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;toc-item toc-level-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;toc-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-number&quot;</span>&gt;</span>2.<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-text&quot;</span>&gt;</span> åšå®¢æ­å»º<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å¤šçº§ç›®å½• --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;toc-item toc-level-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;toc-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#%E4%BC%98%E5%8C%96%E5%8D%9A%E5%AE%A2%E5%86%85%E5%AE%B9&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-number&quot;</span>&gt;</span>6.<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-text&quot;</span>&gt;</span> ä¼˜åŒ–åšå®¢å†…å®¹<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ol</span> <span class="attr">class</span>=<span class="string">&quot;toc-child&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;toc-item toc-level-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;toc-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-number&quot;</span>&gt;</span>6.1.<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-text&quot;</span>&gt;</span> ä½¿ç”¨æ’ä»¶<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;toc-item toc-level-4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;toc-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#%E6%B7%BB%E5%8A%A0%E7%9B%AE%E5%BD%95&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-number&quot;</span>&gt;</span>6.2.<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;toc-text&quot;</span>&gt;</span> æ·»åŠ ç›®å½•<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> å…¶ä»– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æŠ€æœ¯åˆ†äº« </tag>
            
            <tag> åšå®¢æ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
