<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>å°ç³çš„æ˜Ÿç©º | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/imgs/shortcut-icon.ico?time=248" type="image/x-icon">
  <link rel="stylesheet" href="/css/public.css?time=248" />
  <link rel="stylesheet" href="/css/layout.css?time=248" />
  <link rel="stylesheet" href="/css/iconfont.css?time=248" />
  <link rel="stylesheet" href="/css/APlayer.min.css?time=248" />
  <script src="/js/APlayer.min.js?time=248"></script>
  <script src="/js/jquery.min.js?time=248"></script>
  <script src="/js/jquery.pjax.min.js?time=248"></script>

  <script src="/js/Valine.min.js?time=248"></script>
<!--  <script src='https://unpkg.com/valine/dist/Valine.min.js'></script>-->
  <script>
    document.title = `å°ç³çš„æ˜Ÿç©º`
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>

<style>
  .load {
    width: 100%;
    height: 100vh;
    background-color: rgb(37, 35, 40);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 9999;
  }
  .load-circle {
    width: 80px;
    height: 80px;
    border: 8px solid orange;
    border-bottom-color: transparent;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: rotate 1s linear infinite;
    filter: drop-shadow(0 0 3px orange);
  }
  .load-circle-inner {
    width: 40px;
    height: 40px;
    border: 8px solid orange;
    border-top-color: transparent;
    border-radius: 50%;
    animation: rotate-reverse .5s linear infinite;
  }
  .load-text {
    margin-top: 20px;
    font-size: 24px;
    color: orange;
    display: flex;
  }
  .load-text span {
    margin: 0 5px;
    text-shadow: 5px 5px 5px orange;
    animation: move 1s linear infinite;
  }
  .load-text span:nth-child(1) {
    animation-delay: -0.6s;
  }
  .load-text span:nth-child(2) {
    animation-delay: -0.5s;
  }
  .load-text span:nth-child(3) {
    animation-delay: -0.4s;
  }
  .load-text span:nth-child(4) {
    animation-delay: -0.3s;
  }
  .load-text span:nth-child(5) {
    animation-delay: -0.2s;
  }
  .load-text span:nth-child(6) {
    animation-delay: -0.1s;
  }
  @keyframes rotate {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }
  @keyframes rotate-reverse {
    0% { transform: rotate(0); }
    100% { transform: rotate(-360deg); }
  }
  @keyframes move {
    0% { transform: translateY(0%) rotate(0) scale(1); }
    20% { transform: translateY(20%) rotate(10deg) scale(1.2); }
    80% { transform: translateY(-10%) rotate(-20deg) scale(.8);}
    100% { transform: translateY(0) rotate(0) scale(1); }
  }

  .progress {
    position: fixed;
    left: 0; top: 0;
    width: 0;
    height: 3px;
    background-color: green;
    transition: all cubic-bezier(0.215, 0.610, 0.355, 1) .1s;
    z-index: 9999;
  }

  .to-up {
    animation: toUp .5s 1;
  }
  .gray {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 9999;
    display: none;
    pointer-events: none;
    background-color: #000;
    mix-blend-mode: color;
  }
  @keyframes toUp {
    from { transform: translateY(15px); opacity: 0; }
    to { transform: translateY(0) ; opacity: 1; }
  }
</style>
<body>
  <div id="load" class="load">
    <div class="load-circle">
      <div class="load-circle-inner"></div>
    </div>
    <p class="load-text">
      <span>L</span>
      <span>O</span>
      <span>A</span>
      <span>D</span>
      <span>I</span>
      <span>N</span>
      <span>G</span>
    </p>
  </div>
  <div id="container" class="container w-100 vh-100" style="display: none;">
    <header class="header">
  <div class="header-wrapper">
    <div class="header-left">
      <div class="header-search">
        <input id="search-input" type="text" class="header-search--input" placeholder="è¯·è¾“å…¥è¦æ£€ç´¢çš„æ–‡ç« æ ‡é¢˜" />
        <span id="search-btn" class="header-search--icon"><i class="iconfont icon-sousuo"></i></span>
      </div>
      <div id="search-layer" class="header-search--layer hidden">
        <p class="title">
          <span>ä»¥ä¸‹æ˜¯æœç´¢å†…å®¹ï¼š</span>
          <span id="close-layer-btn">å…³é—­</span>
        </p>
        <ul>
        </ul>
      </div>
    </div>
    <div class="header-right">
      <ul class="header-menu">
        <li>
          <a href="/?time=' + new Date().getMilliseconds()">
<!--          <a href="http://example.com/">-->
            <i class="header-menu--icon iconfont icon-shouye"></i>
            <span class="header-menu--span">é¦–é¡µ</span>
          </a>
        </li>
        <li>
          <a href="/log?time=' + new Date().getMilliseconds()">
<!--          <a href="http://example.com/log?time=245">-->
            <i class="header-menu--icon iconfont icon-rizhi"></i>
            <span class="header-menu--span">æ—¥å¿—</span>
          </a>
        </li>
        <li>
          <a href="/link?time=' + new Date().getMilliseconds()">
<!--          <a href="http://example.com/link?time=245">-->
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
            <span class="header-menu--span">å‹æƒ…é“¾æ¥</span>
          </a>
        </li>
        <li>
          <a href="/about?time=' + new Date().getMilliseconds()">
<!--          <a href="http://example.com/about?time=245">-->
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
            <span class="header-menu--span">å…³äºæˆ‘</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<script>
  const ipt = document.querySelector('#search-input')
  const btn = document.querySelector('#search-btn')
  const layer = document.querySelector('#search-layer')
  const posts = JSON.parse(`[{"title":"","cover":"/imgs/cover/default-cover.webp?time=208?time=210?time=217","path":"2025/07/09/gradle/Gradle/"},{"title":"MySQLç³»åˆ—(ä¸€)---å®‰è£…","cover":"/imgs/cover/default-cover.webp?time=194?time=196?time=199?time=212?time=221?time=222","path":"2023/11/27/mysql/MySQLç³»åˆ—ä¸€ä¹‹å®‰è£…/"},{"title":"MySQLç³»åˆ—(ä¸‰)---ç´¢å¼•","cover":"/imgs/cover/default-cover.webp?time=201?time=206?time=212?time=217?time=223","path":"2024/04/29/mysql/MySQLç³»åˆ—ä¸‰ä¹‹ç´¢å¼•/"},{"title":"MySQLç³»åˆ—(äºŒ)---SQL","cover":"/imgs/cover/default-cover.jpeg?time=201?time=205?time=212?time=217?time=223","path":"2024/02/26/mysql/MySQLç³»åˆ—äºŒä¹‹SQL/"},{"title":"Promise","cover":"/imgs/cover/default-cover.jpeg?time=194?time=198?time=199?time=213?time=222?time=223","path":"2023/11/24/js/Promise/"},{"title":"NPMå’ŒPNPMçš„å®‰è£…åŠé…ç½®","cover":"/imgs/cover/default-cover.webp?time=190?time=196?time=200?time=213?time=219?time=224?time=224?time=225","path":"2023/12/26/node/npmå’Œpnpmå®‰è£…åŠé…ç½®/"},{"title":"åšå®¢æ­å»º","cover":"/imgs/cover/default-cover.webp?time=194?time=198?time=199?time=214?time=222?time=223?time=225","path":"2023/11/22/other/åšå®¢æ­å»º/"},{"title":"é¡¹ç›®å¯¹æ¥æ‹›å•†é“¶è¡ŒCBS","cover":"/imgs/cover/default-cover.webp?time=201?time=205?time=214?time=217?time=226","path":"2024/02/21/other/é¡¹ç›®å¯¹æ¥æ‹›å•†é“¶è¡ŒCBS/"},{"title":"é¡¹ç›®å¯¹æ¥æµ·åº·SDK","cover":"/imgs/cover/default-cover.webp?time=201?time=205?time=214?time=217?time=226","path":"2024/02/21/other/é¡¹ç›®å¯¹æ¥æµ·åº·SDK/"},{"title":"Redisç³»åˆ—(ä¸€)---å®‰è£…","cover":"/imgs/cover/default-cover.webp?time=190?time=196?time=200?time=214?time=219?time=227","path":"2023/12/12/redis/Redisç³»åˆ—ä¸€ä¹‹å®‰è£…/"},{"title":"Typescriptç³»åˆ—(ä¸€)---åŸºç¡€","cover":"/imgs/cover/default-cover.webp?time=190?time=196?time=200?time=215?time=219?time=228","path":"2023/12/26/ts/TypeScriptç³»åˆ—ä¸€ä¹‹åŸºç¡€/"},{"title":"Typescriptç³»åˆ—(äºŒ)---é«˜çº§","cover":"/imgs/cover/default-cover.jpeg?time=190?time=203?time=204?time=215?time=219?time=228","path":"2024/01/04/ts/TypeScriptç³»åˆ—äºŒä¹‹é«˜çº§/"},{"title":"SpringCloudç³»åˆ—(ä¸€)---é¡¹ç›®åˆ›å»º","cover":"/imgs/cover/default-cover.webp?time=194?time=196?time=199?time=216?time=222?time=228","path":"2023/11/25/springcloud/SpringCloudç³»åˆ—ä¸€ä¹‹åŸºç¡€æœåŠ¡/"},{"title":"SpringCloudç³»åˆ—(ä¸ƒ)---è®¤è¯å’Œæˆæƒ","cover":"/imgs/cover/default-cover.jpeg?time=190?time=201?time=205?time=216?time=219?time=229","path":"2024/02/03/springcloud/SpringCloudç³»åˆ—ä¸ƒä¹‹è®¤è¯å’Œæˆæƒ/"},{"title":"SpringCloudç³»åˆ—(ä¸‰)---æœåŠ¡ç†”æ–­ä¸é™çº§","cover":"/imgs/cover/default-cover.webp?time=194?time=196?time=200?time=216?time=222?time=228?time=230?time=230","path":"2023/12/02/springcloud/SpringCloudç³»åˆ—ä¸‰ä¹‹æœåŠ¡ç†”æ–­ä¸é™çº§/"},{"title":"SpringCloudç³»åˆ—(ä¹)---é˜¶æ®µæ€»ç»“","cover":"/imgs/cover/default-cover.jpeg?time=201?time=207?time=216?time=217?time=228","path":"2024/05/11/springcloud/SpringCloudç³»åˆ—ä¹ä¹‹é˜¶æ®µæ€»ç»“/"},{"title":"SpringCloudç³»åˆ—(äºŒ)---æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ","cover":"/imgs/cover/default-cover.jpeg?time=194?time=196?time=199?time=216?time=222?time=228?time=231?time=231","path":"2023/11/30/springcloud/SpringCloudç³»åˆ—äºŒä¹‹æ³¨å†Œä¸­å¿ƒ/"},{"title":"SpringCloudç³»åˆ—(å…«)---æœåŠ¡åˆ’åˆ†","cover":"/imgs/cover/default-cover.webp?time=190?time=201?time=205?time=216?time=219?time=232","path":"2024/02/19/springcloud/SpringCloudç³»åˆ—å…«ä¹‹æœåŠ¡åˆ’åˆ†/"},{"title":"SpringCloudç³»åˆ—(äº”)---Redisä½¿ç”¨","cover":"/imgs/cover/default-cover.jpeg?time=190?time=196?time=200?time=216?time=219?time=227?time=228","path":"2023/12/14/springcloud/SpringCloudç³»åˆ—äº”ä¹‹Redisä½¿ç”¨/"},{"title":"SpringCloudç³»åˆ—(å…­)---åˆ†å¸ƒå¼ä¸»é”®","cover":"/imgs/cover/default-cover.webp?time=194?time=196?time=200?time=216?time=222?time=228?time=232","path":"2023/12/11/springcloud/SpringCloudç³»åˆ—å…­ä¹‹åˆ†å¸ƒå¼ä¸»é”®/"},{"title":"SpringCloudç³»åˆ—(å››)---ç½‘å…³","cover":"/imgs/cover/default-cover.jpeg?time=194?time=196?time=200?time=216?time=222?time=228?time=233","path":"2023/12/10/springcloud/SpringCloudç³»åˆ—å››ä¹‹ç½‘å…³/"},{"title":"Vueç³»åˆ—(ä¸€)---é¡¹ç›®åˆ›å»ºå’Œé…ç½®","cover":"/imgs/cover/default-cover.webp?time=208?time=209?time=217?time=218?time=225?time=233?time=234","path":"2025/06/19/web/Vueç³»åˆ—ä¸€ä¹‹é¡¹ç›®åˆ›å»ºå’Œé…ç½®/"},{"title":"Vueç³»åˆ—(äºŒ)---è·¯ç”±","cover":"/imgs/cover/default-cover.jpeg?time=190?time=203?time=204?time=218?time=219?time=234","path":"2024/01/07/web/Vueç³»åˆ—äºŒä¹‹è·¯ç”±/"},{"title":"Vueç³»åˆ—(ä¸‰)---çŠ¶æ€ç®¡ç†åº“","cover":"/imgs/cover/default-cover.webp?time=190?time=203?time=204?time=218?time=219?time=234","path":"2024/01/18/web/Vueç³»åˆ—ä¸‰ä¹‹çŠ¶æ€ç®¡ç†åº“/"},{"title":"Zookeeperç³»åˆ—(ä¸€)---åŸç†","cover":"/imgs/cover/default-cover.webp?time=201?time=207?time=217?time=219?time=231","path":"2024/05/28/zookeeper/Zookeeperç³»åˆ—ä¸€ä¹‹åŸç†/"},{"title":"Vueç³»åˆ—(å››)---è¯·æ±‚","cover":"/imgs/cover/default-cover.jpeg?time=190?time=201?time=205?time=218?time=219?time=235","path":"2024/02/01/web/Vueç³»åˆ—å››ä¹‹è¯·æ±‚/"},{"title":"Zookeeperç³»åˆ—(äºŒ)---å®‰è£…é…ç½®","cover":"/imgs/cover/default-cover.jpeg?time=201?time=207?time=217?time=219?time=231","path":"2024/05/10/zookeeper/Zookeeperç³»åˆ—äºŒä¹‹å®‰è£…é…ç½®/"},{"title":"","cover":"/imgs/cover/default-cover.webp?time=208?time=209?time=217","path":"2025/06/19/zookeeper/Zookeeperç³»åˆ—ä¸€ä¹‹åŸç†/The Part-Time Parliament CN/"}]`)
  ipt.addEventListener('keyup', e => {
    if (e.key === 'Enter') {
      handleSearch()
    }
  })
  btn.addEventListener('click', () => {
    handleSearch()
  })

  document.querySelector('#close-layer-btn').addEventListener('click', () => {
    layer.classList.toggle('hidden')
  })

  function handleSearch() {
    if (ipt.value.trim() === '') {
      return
    }
    let html = ''
    const targetPosts = posts.filter(post => post.title.includes(ipt.value))
    targetPosts.forEach(post => {
      html += `
        <li>
          <div>
            <a href="/${post.path}${'?time=' + new Date().getMilliseconds()}">${post.title.replace(new RegExp(ipt.value), `<span>${ipt.value}</span>`)}</a>
          </div>
          <img src="${post.cover || '/imgs/default-cover.webp'}${'?time=' + new Date().getMilliseconds()}" />
        </li>
      `
    })
    if (html.trim () === '') {
      html += '<p class="empty">æ²¡æœ‰æœç´¢åˆ°å†…å®¹</p>'
    }
    layer.querySelector('ul').innerHTML = html
    layer.classList.remove('hidden')
  }
</script> 
    <section id="main" class="main">
      <div class="main-left-wrapper">
<div class="main-left">
  <div class="main-left--block">
    <div class="main-left--info">
      <img src="/imgs/avatar.jpg?time=245" class="main-left--avatar" alt />
      <div class="main-left--intro">
        <p class="main-left--name">å°ç³</p>
        <div class="main-left--tags">
          
            <span class="main-left--tag">ä¸­äºŒ</span>
          
            <span class="main-left--tag">ä¹å¤©æ´¾</span>
          
            <span class="main-left--tag">æ‚²è§‚ä¸»ä¹‰</span>
          
        </div>
      </div>
    </div>
  
    <div>
      <div class="main-left--motto">
        <p>è·³å‡ºåœˆå­ä½ ä¼šå‘ç°</p>
        <p>å…¶å®ä½ ä¸€æ— æ˜¯å¤„</p>
      </div>
      <div class="main-left--github">
        <span class="line"></span>
        
          <a target="_blank" rel="noopener" href="https://github.com/?time=245" title="github">
            <i class="logo xiao-lin-blog xiao-lin-blog-github"></i>
          </a>
        
          <a target="_blank" rel="noopener" href="https://gitee.com/xiao-lin?time=245" title="ç äº‘">
            <i class="logo xiao-lin-blog xiao-lin-blog-gitee"></i>
          </a>
        
          <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43728193?type=blog?time=245" title="CSDN">
            <i class="logo xiao-lin-blog xiao-lin-blog-csdn"></i>
          </a>
        
          <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiao-lin-unit/?time=245" title="åšå®¢å›­">
            <i class="logo xiao-lin-blog xiao-lin-blog-cnblogs"></i>
          </a>
        
        <span class="line"></span>
      </div>
      <div class="main-left--statics">
        <a href="/categories?time=245">
          <div>
            <span>9</span>
            <span>åˆ†ç±»</span>
          </div>
        </a>
        <a href="/tags?time=245">
          <div>
            <span>25</span>
            <span>æ ‡ç­¾</span>
          </div>
        </a>
        <a href="/archives?time=245">
          <div>
            <span>8 </span>
            <span>å½’æ¡£</span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="main-left--block">
    <ul class="main-left--menu">
      
        <li>
          <a href="/?time=245">
            <span class="header-menu--span">å°ç«™é¦–é¡µ</span>
            <i class="header-menu--icon iconfont icon-shouye"></i>
          </a>
        </li>
      
        <li>
          <a href="/log?time=245">
            <span class="header-menu--span">ä¸ªäººæ—¥å¿—</span>
            <i class="header-menu--icon iconfont icon-rizhi"></i>
          </a>
        </li>
      
        <li>
          <a href="/link?time=245">
            <span class="header-menu--span">å‹æƒ…é“¾æ¥</span>
            <i class="header-menu--icon iconfont icon-youqinglianjie"></i>
          </a>
        </li>
      
        <li>
          <a href="/about?time=245">
            <span class="header-menu--span">å…³äºè‡ªå·±</span>
            <i class="header-menu--icon iconfont icon-guanyuwomen"></i>
          </a>
        </li>
      
        <li>
          <a href="/tags?time=245">
            <span class="header-menu--span">æ ‡ç­¾</span>
            <i class="header-menu--icon xiao-lin-blog xiao-lin-blog-tags-rectangle"></i>
          </a>
        </li>
      
        <li>
          <a href="/categories?time=245">
            <span class="header-menu--span">åˆ†ç±»</span>
            <i class="header-menu--icon xiao-lin-blog xiao-lin-blog-categories"></i>
          </a>
        </li>
      
        <li>
          <a href="/tools?time=245">
            <span class="header-menu--span">æˆ‘çš„å·¥å…·</span>
            <i class="header-menu--icon iconfont icon-gongju"></i>
          </a>
        </li>
      
    </ul>
  </div>

  <div class="main-left--block">
    <div class="main-left--site">
      <h5 class="main-left--title">
        <span>ç«™ç‚¹ä¿¡æ¯</span>
        <i class="iconfont icon-zhandian"></i>
      </h5>
      <p class="main-left--subtitle">
        <span>æ–‡ç« æ•°ç›®ï¼š</span>
        <span>28 ç¯‡</span>
      </p>
      <p class="main-left--subtitle">
        <span>æœ€è¿‘åŠ¨æ€ï¼š</span>
        <span>5å¤©å‰</span>
      </p>
      <p class="main-left--subtitle">
        <span>ä¸Šçº¿æ—¶é—´ï¼š</span>
        <span>602å¤©</span>
      </p>
      <p class="main-left--subtitle">
        <span>å½“å‰ç‰ˆæœ¬ï¼š</span>
        <span>v1.0.2</span>
      </p>
    </div>
  </div>
</div></div>
      <div id="main-container" class="main-container">


  

<link rel="stylesheet" href="/css/partial/article.css?time=139" />

<div class="article-container">
  <div class="article">
    <h1 class="article-title">SpringCloudç³»åˆ—(ä¸ƒ)---è®¤è¯å’Œæˆæƒ</h1>
    <div class="article-info">
      <div class="article-info--item">
        <div class="article-info--info">
          
          <div class="article-info--categories">
            <span class="xiao-lin-blog xiao-lin-blog-categories">åˆ†ç±»ï¼š</span>
            <a class="category-link" href="/categories/SpringCloud/">SpringCloud</a>
          </div>
          
          
          <div class="article-info--tags">
            <span class="xiao-lin-blog xiao-lin-blog-tags-fill">æ ‡ç­¾ï¼š</span>
            <a class="tag-link" href="/tags/SpringSecurity/" rel="tag">SpringSecurity</a>
          </div>
          
          <p class="article-info--date"><i class="xiao-lin-blog xiao-lin-blog-date-time">æ—¥æœŸï¼š2024-02-03 16:00:11</i></p>
        </div>
<!--        <img src="/1" alt="" class="article-cover">-->
        <img src="/imgs/cover/default-cover.jpeg" alt="" class="article-cover">
      </div>
    </div>
    <article class="article-content markdown-body">
      <!-- toc -->
<h3 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h3>
<p>é¡¹ç›®çš„å‰ç«¯æ¡†æ¶åŸºæœ¬æ­å»ºå®Œæˆå, æ¥åˆ°é¡¹ç›®æ¯”è¾ƒæŠ½è±¡çš„åœ°æ–¹, ç™»å½•å’Œæˆæƒ. è¯´å…¶æŠ½è±¡ä¸»è¦æ˜¯å› ä¸ºä½¿ç”¨<code>SpringSecurity</code>æ¡†æ¶çš„åŸå› , <code>SpringSecurity</code>æ¡†æ¶æœºåˆ¶å¥å…¨åˆ‡å¼ºå¤§, ä½†ç”±äºå…¶å°è£…çš„éå¸¸å¥½, æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶å¼€å‘äººå‘˜ä¼šè§‰å¾—éå¸¸æŠ½è±¡, åŠ¨ä¸åŠ¨çš„å°±è®¤è¯å¼‚å¸¸, ä¸€ä¸å°å¿ƒå°±å¼¹å‡ºé»˜è®¤çš„ç™»å½•é¡µé¢, ä¹Ÿä¼šå‡ºç°å„ç§ä¸ç†è§£çš„æƒ…å†µ, æ‰€ä»¥æ¥è¸©å‘å§</p>
<p>ç”±äºå¼€å§‹é¡¹ç›®æ—¶<code>springboot</code>ä½¿ç”¨çš„æ˜¯<code>3.1.5</code>ç‰ˆæœ¬, æ‰€ä»¥æ­¤å¤„ä¹Ÿä½¿ç”¨åŒç‰ˆæœ¬çš„<code>SpringSecurity</code></p>
<p>å½“å‰ç½‘ä¸Šä»‹ç»<code>SpringSecurity</code>çš„æ–‡ç« å¤§è‡´åˆ†ä¸ºä¸¤ç±», ä¸€ç±»æ˜¯è®²æºç , ä¸€ç±»æ˜¯è®²ä½¿ç”¨çš„. æœ¬ç¯‡æ˜¯è®²<code>SpringSecurity</code>çš„ä½¿ç”¨çš„æ–‡ç« , æ‰€ä»¥æš‚ä¸è¯„è®ºå°†æºç çš„æ–‡ç« å¦‚ä½•, ä½†å¯¹äºå°†ä½¿ç”¨çš„æ–‡ç« , æˆ‘åªèƒ½è¯´é™¤äº†éƒ¨åˆ†å¤§ä½¬çš„æ–‡ç« å¤–, å…¶ä»–éƒ½æ˜¯ğŸ‘</p>
<p>ä¸ªäººè®¤ä¸ºè®²ä½¿ç”¨çš„æ–‡ç« è¦åšåˆ°ä¸¤ç‚¹: 1.æ€æ ·ç”¨;2. æ¯ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯ä»€ä¹ˆ.ä½†ç»å¤§å¤šæ•°çš„æ–‡ç« å°±æ˜¯å‘Šè¯‰å±äºè€…ä½ è¦è¿™æ ·åš, ç„¶åå°±æˆåŠŸäº†, è¯»è€…çœ‹äº†ä¹‹åæˆåŠŸäº†, ä½†æ ¹æœ¬ä¸çŸ¥é“è‡ªå·±åšäº†ä»€ä¹ˆ,ç‰¹åˆ«æ˜¯åƒæˆ‘è¿™ç§ä¹‹å‰æ²¡æœ‰åšè¿‡è®¤è¯æˆæƒ(ç™»å½•)å†…å®¹çš„<code>loser</code>, æœ¬èº«å°±ä¸äº†è§£, æ–‡ç« ä¹Ÿè®²ä¸æ¸…æ¥š, ä¸ªäººå¾ˆè¿·èŒ«å•Š</p>
<p>ç”±äº<code>SpringSecurity</code>å†…å®¹å¾ˆå¤š, ä½†æœ€é‡è¦çš„æ˜¯é…ç½®å†…å®¹, æœ¬ç¯‡ä¼šä»‹ç»<code>SpringSecurity</code>ä¸­é‡è¦çš„å†…å®¹è®²è§£, å…¶ä»–å†…å®¹æˆ–è®¸ä¸€å¥è¯å¸¦è¿‡</p>
<p><mark>å¦‚æœæƒ³å¿«é€Ÿæ˜ç™½è¯¥å¦‚ä½•é…ç½®, å¯ä»¥ç›´æ¥çœ‹<a href="#è®¤è¯æµç¨‹" style="font-weight: blod">è®¤è¯æµç¨‹</a>éƒ¨åˆ†</mark></p>
<h3 id="å¼•å…¥springsecurity"><a class="markdownIt-Anchor" href="#å¼•å…¥springsecurity"></a> å¼•å…¥<code>SpringSecurity</code></h3>
<h4 id="æ·»åŠ ä¾èµ–"><a class="markdownIt-Anchor" href="#æ·»åŠ ä¾èµ–"></a> æ·»åŠ ä¾èµ–</h4>
<ol>
<li>
<p>çˆ¶çº§é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç”±äº<code>SpringSecurity</code>çš„ä¾èµ–åœ¨<code>SpringBoot</code>çš„<code>spring-boot-dependencies</code>ä¸­å¼•å…¥, æ‰€ä»¥åœ¨çˆ¶é¡¹ç›®ä¸­ä¸å¿…è¦æ˜¾å¼çš„å£°æ˜å¼•å…¥</p>
<p>æ‰ç”¨<code>starter</code>çš„æ–¹å¼æ—¶, é»˜è®¤å°±ä¼šæœ‰<code>@EnableWebSecurity</code>æ³¨è§£, æ‰€ä»¥ä¼šå‘ç°, å½“å¼•å…¥ä¾èµ–å, å°±éœ€è¦è¿›è¡Œç™»å½•æ“ä½œäº†. å¦‚æœåªæ˜¯å•çº¯çš„è¿›å…¥<code>security</code>çš„ä¾èµ–, éœ€è¦æ·»åŠ è¯¥æ³¨è§£å¼€å¯ç›¸å…³å†…å®¹</p>
</li>
<li>
<p>å­é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è¯´æ˜</p>
<ul>
<li>ç™»å½•æ“ä½œå…ˆåœ¨ä¸€ä¸ªå­é¡¹ç›®ä¸­å®ç°, ç„¶åæ·»åŠ åˆ°æ•´ä¸ªé¡¹ç›®ä¸­, åœ¨åˆ†å¸ƒå¼ä¸­å®ç°ä¸€å¤„ç™»å½•</li>
<li>åç»­åœ¨åˆ†å¸ƒåˆ°æ•´ä¸ªé¡¹ç›®ä¸­æ—¶, å¯èƒ½ä¼šå°†ç™»å½•æ“ä½œæ”¾ç½®åœ¨ç½‘å…³å­é¡¹ç›®ä¸­, æ‰€ä»¥ä¼šæœ‰æ™®é€šé¡¹ç›®åˆ°ç½‘å…³é¡¹ç›®çš„ç™»å½•æ”¹é€ </li>
</ul>
</li>
</ol>
<h4 id="æ·»åŠ é…ç½®"><a class="markdownIt-Anchor" href="#æ·»åŠ é…ç½®"></a> æ·»åŠ é…ç½®</h4>
<p>åœ¨ä½¿ç”¨<code>starter</code>æ—¶, ä¸éœ€è¦ä»»ä½•é…ç½®, æ—¢å¯ä»¥æ­£å¸¸ä½¿ç”¨<code>Security</code>, å¦‚æœå¼•å…¥çš„æ˜¯å•çº¯çš„<code>Security</code>, åˆ™éœ€è¦å†é…ç½®ç±»ä¸Šæ·»åŠ <code>@EnableWebSecurity</code>æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Security</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜"></a> è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜</h3>
<p>å½“éœ€è¦è‡ªå®šä¹‰é…ç½®æ—¶, ä¸»è¦æ˜¯è‡ªå®šä¹‰é…ç½®ä¸¤ä¸ªå†…å®¹:1. <code>HttpSecurity</code>; 2. <code>WebSecurity</code>. è¿™ä¸¤ä¸ªä¸œè¥¿è®²èµ·æ¥å°±å•°å—¦äº†</p>
<ol>
<li>
<p>é¦–å…ˆåŒºåˆ†è¯·æ±‚ä¸­çš„å®¹å™¨: <code>servlet</code>å®¹å™¨å’Œ<code>spring</code>å®¹å™¨, <code>servlet</code>å®¹å™¨ä¸»è¦æ˜¯ä¸ºè¯·æ±‚æœåŠ¡çš„, ä¸»è¦æœ‰ä¸¤ç±»: <code>Filter</code>å’Œ<code>Servlet</code>, <code>Servlet</code>æ˜¯å¯¹è¯·æ±‚è¿›è¡Œå…·æœ‰å®é™…æ„ä¹‰çš„å†…å®¹å¤„ç†, å¯ä»¥å‚ç…§<code>spring mvc</code>ä¸­çš„<code>controller+service+dao</code>, <code>Filter</code>æ˜¯å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†æˆ–è€…åç½®å¤„ç†; <code>spring</code>å®¹å™¨å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<code>spring</code>çš„<code>bean</code></p>
</li>
<li>
<p>å…¶æ¬¡åŒºåˆ†<code>Filter</code>: <code>Filter</code>æ ¹æ®å®¹å™¨ä¸åŒ, æœ‰<code>servlet</code>çš„<code>Filter</code>å’Œ<code>spring</code>çš„<code>Filter</code>, é€šå¸¸æˆ‘ä»¬ä½¿ç”¨<code>spring</code>çš„æ–¹å¼æ³¨å†Œçš„<code>Filter</code>éƒ½æ˜¯<code>spring</code>çš„<code>Filter</code>; <code>servlet</code>å¿…é¡»æ˜¯ç»§æ‰¿è‡ª<code>javax.serlvet.Filter</code>(<code>tomcat-embed-core</code>ä¾èµ–åŒ…åº”è¯¥æ˜¯<code>jakarta.servlet.Filter</code>)æ¥å£, å¹¶é€šè¿‡<code>web.xml</code>(<code>SpirngBoot</code>æ˜¯é€šè¿‡<code>@WebFilter</code>æ³¨è§£)æ³¨å†Œåˆ°<code>servlet</code>å®¹å™¨ä¸­(ä¸æ˜ç™½çš„å¯ä»¥å…ˆå­¦ä¹ ä¸€ä¸‹<code>servlet</code>å¼€å‘)</p>
</li>
<li>
<p>åœ¨äº†è§£ä¸Šè¿°ä¸¤ä¸ªå†…å®¹ä¹‹å, å°±å†è®¤è¯†ä¸‰ä¸ªåè¯:</p>
<ul>
<li><code>DelegatingFilterProxy</code>(å§”æ´¾è¿‡æ»¤å™¨ä»£ç†, <code>servlet</code>ä¸­çš„<code>Filter</code>ä¸<code>spring</code>ä¸­çš„<code>Filter</code>çš„æ¡¥æ¥å™¨, <code>spring web</code>ä¸­å®šä¹‰çš„, ä»»ä½•æ¡†æ¶éƒ½å¯ä»¥é€šè¿‡æ­¤æ–¹å¼æ·»åŠ <code>Filter</code>åˆ°<code>servlet</code>æ‰§è¡Œé“¾ä¸­);</li>
<li><code>FilterChainProxy</code> (<code>spring</code>å®¹å™¨ä¸­çš„è¿‡æ»¤å™¨é“¾ä»£ç†, å†…éƒ¨ç»´æŠ¤å¤šä¸ª<code>spring</code>è¿‡æ»¤å™¨é“¾, åœ¨<code>SpringSecurity</code>ä¸­å®šä¹‰çš„, å³ä¸“é—¨ä¸º<code>SpringSecurity</code>ä½¿ç”¨);</li>
<li><code>SecurityFilterChain</code>(å®‰å…¨æ¡†æ¶çš„è¿‡æ»¤å™¨é“¾, åœ¨<code>SpringSecurity</code>ä¸­å®šä¹‰çš„, è®¤è¯æµç¨‹çš„å¤„ç†è¿‡ç¨‹)</li>
</ul>
</li>
<li>
<p>ç›´æ¥ä¸Šå›¾</p>
<p><img src="Security%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE%E6%9E%B6%E6%9E%84.png" alt="Securityçš„è¿‡æ»¤å™¨é“¾æ¶æ„" /></p>
</li>
<li>
<p>ç°åœ¨è®²<code>WebSecurity</code>å’Œ<code>HttpSecurity</code>. <code>Security</code>çš„åŸç†å°±æ˜¯æ ¹æ®ä¸åŒçš„è·¯å¾„, åŒ¹é…ä¸åŒçš„<code>SecurityFilterChain</code></p>
<ul>
<li><code>HttpSecurity</code>æ˜¯ç”¨æ¥æ„å»º<code>SecurityFilterChain</code>çš„, <code>HttpSecurity</code>æ¯<code>build</code>ä¸€æ¬¡, å°±æ„å»ºå‡ºä¸€æ¡å®Œæ•´çš„<code>SecurityFilterChain</code>, æ¯ä¸ª<code>SecurityFilterChain</code>æ ¹æ®é…ç½®ä¸åŒ, æœ‰ä¸åŒæ•°é‡çš„è¿‡æ»¤å™¨, å½“é¡¹ç›®ä¸­æ²¡æœ‰æ„å»º<code>SecurityFilterChain</code>æ—¶, æ¡†æ¶ä¼šæ·»åŠ ä¸€æ¡é»˜è®¤çš„<code>SecurityFilterChain</code> ;</li>
<li><code>WebSecurity</code>æ˜¯ç”¨æ¥æ„å»º<code>FilterChainProxy</code>çš„æ„å»ºç±», å®ƒä¼šç»´æŠ¤é¡¹ç›®ä¸­æ·»åŠ çš„<code>SecurityFilterChain</code>, æ ¹æ®<code>SecurityFilterChain</code>ä¸­çš„è·¯å¾„åŒ¹é…è§„åˆ™, è°ƒç”¨ä¸åŒçš„<code>SecurityFilterChain</code></li>
<li><img src="Security%E4%B8%AD%E7%9A%84%E6%9E%84%E5%BB%BA%E5%85%B3%E7%B3%BB.png" alt="Securityä¸­çš„æ„å»ºå…³ç³»" /></li>
</ul>
</li>
<li>
<p>æ¼”ç¤º</p>
<p><img src="Security%E7%9A%84WebSecurity%E5%92%8CHttpSecurity%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F.png" alt="Securityçš„WebSecurityå’ŒHttpSecurityé…ç½®æ–¹å¼" /></p>
<p><img src="Security%E4%B8%ADWebSecurity%E5%92%8CHttpSecurity%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%9C%E6%BC%94%E7%A4%BA.png" alt="Securityä¸­WebSecurityå’ŒHttpSecurityé…ç½®ç»“æœæ¼”ç¤º" /></p>
</li>
<li>
<p>è¯´æ˜</p>
<ul>
<li>
<p>ä¸ªäººä¸å¤ªæ¨èä½¿ç”¨<code>addSecurityFilterChainBuilder</code>çš„æ–¹å¼æ·»åŠ <code>SecurityFilterChain</code>, è¿™ç§æ–¹å¼å®šä¹‰æ¯”è¾ƒéº»çƒ¦. ä¸åŒçš„<code>SecurityFilterChain</code>å¯ä»¥é€šè¿‡å®šä¹‰ä¸åŒçš„<code>SecurityFilterChain</code>çš„<code>Bean</code>å®ä¾‹, é€šè¿‡<code>SecurityFilterChain</code>çš„<code>securityMatcher</code>æ¥å®ç°ä¸åŒè¯·æ±‚çš„å¤„ç†</p>
</li>
<li>
<p>é¡¹ç›®ä¸­çš„é™æ€èµ„æºæ¨èä½¿ç”¨<code>ignoring</code>çš„æ–¹å¼å®ç°, å› ä¸ºå¤§å¤šæ•°é™æ€èµ„æºéƒ½æ˜¯å…è®¸ç›´æ¥è®¿é—®çš„</p>
</li>
<li>
<p>åŒä¸€ä¸ª<code>HttpSecurity</code>æ˜¯ä¸å…è®¸é‡å¤æ„å»ºçš„, é‡å¤æ„å»ºæ—¶ä¼šå‡ºç°å·²æ„å»ºçš„é”™è¯¯, æ‰€ä»¥è¯´ç¬¬ä¸€ç‚¹ä¸­çš„<code>addSecurityFilterChainBuilder</code>æ·»åŠ æ¯”è¾ƒéº»çƒ¦, åŒæ—¶ä¹Ÿæ‹’ç»äº†ç›´æ¥æ„å»º<code>List&lt;SecurityFilterChain&gt;</code>çš„é“è·¯. ä½†æ˜¯æ¯æ¬¡åˆ›å»ºæ–°çš„<code>SecurityFilterChain</code>æ—¶æ³¨å…¥çš„<code>HttpSecurity</code>éƒ½æ˜¯ä¸åŒçš„, æ‰€ä»¥æ¨èæ­¤æ–¹å¼æ·»åŠ <code>SecurityFilterChain</code>.</p>
<p><img src="Security%E4%B8%8D%E5%90%8C%E7%9A%84HttpSecurity.png" alt="Securityä¸åŒçš„HttpSecurity" /></p>
</li>
</ul>
</li>
</ol>
<h3 id="é…ç½®websecurity"><a class="markdownIt-Anchor" href="#é…ç½®websecurity"></a> é…ç½®<code>WebSecurity</code></h3>
<p><img src="Security%E7%9A%84WebSecurity%E7%9A%84%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9.png" alt="Securityçš„WebSecurityçš„é…ç½®å†…å®¹" /></p>
<p>ä¸Šè¿°æ˜¯<code>WebSecurity</code>ä¸­çš„å¯é…ç½®å†…å®¹</p>
<ul>
<li><code>ignoring</code>: å¿½ç•¥è·¯å¾„</li>
<li><code>httpFirewall</code>: é˜²ç«å¢™</li>
<li><code>debug</code>: æ˜¯å¦å¼€å¯<code>debug</code></li>
<li><code>addSecurityFilterChainBuilder</code>: æ·»åŠ ä¸€ä¸ª<code>SecurityFilterChain</code></li>
<li><code>privilegeEvaluator</code>: ç‰¹æƒ, è¿™ä¸ªæˆ‘ä¹Ÿæ²¡æœ‰æ˜ç™½å…·ä½“è¦æ€ä¹ˆåš, å¤§è‡´æ˜¯è¯´åˆ¤æ–­æŸä¸ªè¯·æ±‚æ˜¯å¦æœ‰æŸç§ç‰¹æƒ, è‡³äºæ˜¯ä»€ä¹ˆæ ·çš„ç‰¹æƒ, æ€æ ·å®šä¹‰, ä¸ç”šäº†è§£</li>
<li><code>expressionHandler</code>: è¡¨è¾¾å¼å¤„ç†å™¨. ä¸æ˜ç™½ä¸è¦ç´§, å»æŸ¥çœ‹å‚æ•°, å¯ä»¥æ‰¾åˆ°<code>SecurityExpressionHandler</code>æ¥å£, æœ‰ä¸‰ä¸ªæ–¹æ³•, æŸ¥çœ‹å…¶æŠ½è±¡å®ç°ç±»<code>AbstractSecurityExpressionHandler</code>, å…¶ä¸­æœ‰ä¸€ä¸ªè§£æå™¨<code>SpelExpressionParser</code>, è¿™æ˜¯<code>spring</code>çš„<code>spel</code>è¡¨è¾¾å¼è§£æå™¨, è¯¥ç±»ä¸­è¿˜èƒ½æ‰¾åˆ°<code>SecurityExpressionOperations</code>è¿™ä¸ªç±», çœ‹åˆ°å…¶ä¸­çš„æ–¹æ³•åå°±æ˜ç™½äº†, è§£ææ§åˆ¶å™¨ä¸­æ–¹æ³•çš„<code>@PreAuthorize</code>ç­‰æƒé™æ³¨è§£ä¸­å®šä¹‰çš„è¡¨è¾¾å¼å†…å®¹. è¯¥æ–¹æ³•æ˜¯ä¸ºäº†æ·»åŠ è‡ªå·±çš„è¡¨è¾¾å¼è§£æç±»</li>
<li><code>postBuildAction</code>: æ„å»ºåçš„å¤„ç†, å‚æ•°æ˜¯ä¸€ä¸ª<code>Runnable</code>ä»»åŠ¡</li>
<li><code>requestRejectedHandler</code>: è¯·æ±‚æ‹’ç»å¤„ç†å™¨, ç”¨æ¥å¤„ç†é˜²ç«å¢™çš„æ‹’ç»å¼‚å¸¸çš„å¤„ç†å™¨</li>
</ul>
<p>é…ç½®<code>WebSecurity</code>ä¸»è¦æ˜¯ä¸ºäº†å°†è·¯å¾„æ”¾è¡Œ, é¿å…æŸäº›èµ„æºå³ä½¿æ”¾è¡Œè¿˜è¦èµ°ä¸€ä¸ªå®Œæ•´çš„<code>SecurityFilterChain</code>, æ­¤æ–¹å¼æ·»åŠ çš„<code>SecurityFilterChain</code>ä¸­æ²¡æœ‰ä»»ä½•<code>Filter</code>, ç›´æ¥å‘ä¸‹è¿è¡Œ; <code>WebSecurity</code>ä¸­çš„å…¶ä»–é…ç½®å¯æŒ‰éœ€è‡ªè¡Œæ·»åŠ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebSecurityCustomizer <span class="title function_">webSecurityCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> web -&gt; web</span><br><span class="line">        .ignoring().requestMatchers(<span class="string">&quot;/static/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å³æ˜¯æ”¾è¡Œ<code>/static</code>è·¯å¾„ä¸‹çš„æ‰€æœ‰è¯·æ±‚</p>
<h3 id="é…ç½®httpsecurity"><a class="markdownIt-Anchor" href="#é…ç½®httpsecurity"></a> é…ç½®<code>HttpSecurity</code></h3>
<p><code>HttpSecurity</code>æ˜¯<code>security</code>é…ç½®çš„é‡ç‚¹</p>
<ol>
<li>
<p>å¯ä»¥é€šè¿‡<code>HttpSecurity</code>é…ç½®å¤šä¸ª<code>SecurityFilterChain</code>, è¿™äº›<code>SecurityFilterChain</code>ä¹‹é—´éœ€è¦æ³¨æ„ä¸€äº›å†…å®¹</p>
<ul>
<li>ç”±äºæ¯ä¸ªè¯·æ±‚åªèƒ½èµ°ä¸€ä¸ª<code>SecurityFilterChain</code>, æ‰€ä»¥åœ¨é…ç½®æ—¶, å°½å¯èƒ½ä¸è¦å‡ºç°è·¯å¾„é…ç½®é‡å çš„æƒ…å†µ, é¿å…å‡ºç°èµ°é”™äº†<code>SecurityFilterChain</code>è€Œå¯¼è‡´çš„é—®é¢˜</li>
<li>å¦‚æœæ¥æ”¶çš„è¯·æ±‚æ²¡æœ‰è¢«è¦†ç›–åœ¨é…ç½®çš„<code>SecurityFilterChain</code>çš„æ˜ å°„è·¯å¾„ä¸­, åˆ™è¯¥è¯·æ±‚ä¼šè¢«ç›´æ¥é€šè¿‡, æ‰€ä»¥åœ¨è¿›è¡Œé…ç½®æ—¶éœ€è¦ç¡®ä¿æœ‰ä¸€ä¸ª<code>SecurityFilterChain</code>æ˜¯è¦†ç›–å…¨éƒ¨è¯·æ±‚çš„, å³ä¸Šé¢çš„å›¾ç‰‡ä¸­çš„<code>anyRequest</code>çš„<code>SecurityFilterChain</code></li>
<li>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬åªä¼šé…ç½®ä¸€ä¸ª<code>SecurityFilterChain</code>, è¿™ä¸ª<code>SecurityFilterChain</code>ä¸è¦é…ç½®<code>securityMatcher</code>è¿™ä¸€é¡¹, é¿å…è¦†ç›–<code>anyRequest</code>çš„<code>SecurityFilterChain</code>å¯¼è‡´çš„æ˜ å°„è·¯å¾„æ²¡æœ‰å…¨è¦†ç›–çš„æƒ…å†µ</li>
</ul>
</li>
<li>
<p><code>HttpSecurity</code>å¯ä»¥é…ç½®çš„å†…å®¹</p>
<p><code>HttpSecurity</code>å¯ä»¥é…ç½®çš„å†…å®¹éå¸¸å¤š, ç›®å‰<code>3.1.5</code>ç‰ˆæœ¬ä¸­, ä¿å®ˆä¼°è®¡æœ‰ä¸€åŠå·²ç»æ ‡è®°ä¸ºè¿‡æ—¶çš„æ–¹æ³•äº†, æ‰€ä»¥å°±ä¸æˆªå›¾äº†, è¿™é‡Œåˆ†ç±»ä»‹ç»ä¸€ä¸‹å§</p>
<ul>
<li>é…ç½®å½“å‰<code>SecurityFilterChain</code> å¤„ç†çš„æ˜ å°„è·¯å¾„: <code>securityMatchers</code></li>
<li>åœ¨å½“å‰<code>SecurityFilterChain</code>ä¸­æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤å™¨: <code>addFilter</code></li>
<li><code>csrf</code>é…ç½®: é»˜è®¤æ˜¯å¼€å¯çš„, å½“è®¾ç½®ä¸º<code>disable</code>æ—¶ä¼šå°†<code>SecurityFilterChain</code>ä¸­çš„è¯¥è¿‡æ»¤å™¨åˆ é™¤</li>
<li><code>cors</code>é…ç½®: é»˜è®¤æ˜¯æ²¡æœ‰çš„, å½“æ·»åŠ é…ç½®å, ä¼šæ·»åŠ ä¸€ä¸ª<code>CorsFilter</code></li>
<li>è®¤è¯é…ç½®: é»˜è®¤æ˜¯ä½¿ç”¨ç”¨æˆ·å¯†ç çš„è®¤è¯æ–¹å¼; è®¤è¯çš„å®ç°æ˜¯é€šè¿‡æ·»åŠ æ¯ä¸€ç§çš„è®¤è¯è¿‡æ»¤å™¨æ¥é…ç½®çš„, å®˜æ–¹å®šä¹‰æ”¯æŒçš„è®¤è¯æ–¹å¼:
<ul>
<li><code>Basic</code>: <code>Basic</code>è¯·æ±‚å¤´çš„è®¤è¯æ–¹å¼, é€šè¿‡<code>httpBasic</code>é…ç½®, å¯ä»¥å‚è€ƒ<code>https://blog.csdn.net/ShiJunzhiCome/article/details/126064450</code></li>
<li>ç”¨æˆ·å¯†ç è®¤è¯: ç”¨æˆ·å, å¯†ç è®¤è¯, <code>username</code>, <code>password</code>, é€šè¿‡<code>formLogin</code>å¯é…ç½®</li>
<li><code>JAAS</code>: <code>jaas</code>è®¤è¯æ–¹å¼, å®˜æ–¹å¯èƒ½æ²¡æœ‰æä¾›è¯¥è®¤è¯æ–¹å¼çš„è¿‡æ»¤å™¨å®ç°. æœ‰ä¸€ä¸ªå¾ˆç›¸ä¼¼çš„<code>jee</code>æ–¹æ³•æ˜¯ç”¨æ¥é…ç½®<code>Java EE security</code>è¿‡æ»¤å™¨çš„</li>
<li><code>X509</code>: <code>X509</code>è®¤è¯å¯ä»¥é€šè¿‡<code>x509</code>é…ç½®</li>
<li><code>rememberMe</code>: è®°ä½ä¸€ä¸ªè¿‡äº†<code>session</code>æœ‰æ•ˆæœŸçš„ç”¨æˆ·, å¯ä»¥é€šè¿‡<code>rememberMe</code>é…ç½®</li>
<li><code>SAML 2.0 Login</code>: <code>SAML2.0</code>è®¤è¯å¯ä»¥é€šè¿‡<code>saml2Login</code>é…ç½®</li>
<li><code>OAuth 2.0 Login</code>: <code>OpenId Connect</code>å’Œéæ ‡å‡†çš„<code>OAuth 2.0</code>è®¤è¯, é€šè¿‡<code>oauth2Login</code>é…ç½®</li>
<li><code>CAS</code>: æ”¯æŒ, ä½†æ²¡æœ‰å®ç°è¿‡æ»¤å™¨</li>
<li><code>Pre-Authentication Scenatios</code>: ä½¿ç”¨å¤–éƒ¨æœºåˆ¶(å¦‚<code>SiteMinder</code>æˆ–<code>Java EE security</code>)è¿›è¡Œè®¤è¯, ä½†ä»ä½¿ç”¨<code>spring security</code>è¿›è¡Œæˆæƒä¿æŠ¤. é€šè¿‡<code>jee</code>å¯ä»¥é…ç½®<code>Java EE security</code></li>
<li>åŒ¿åè®¤è¯: é€šè¿‡<code>anonymous</code>å¯ä»¥é…ç½®åŒ¿åè®¤è¯</li>
</ul>
</li>
<li>è®¤è¯æ—¶å¯å…±ç”¨çš„é…ç½®:
<ul>
<li><code>authenticationManager</code>: è®¤è¯ç®¡ç†å™¨, ç»´æŠ¤ä¸€ç»„è®¤è¯å¤„ç†å™¨, é»˜è®¤çš„æ˜¯<code>ProviderManager</code></li>
<li><code>AuthenticationProvider</code>: è®¤è¯å¤„ç†å™¨, æ­¤æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªè®¤è¯å¤„ç†å™¨, è¿™äº›è®¤è¯å¤„ç†å™¨é€šè¿‡<code>AuthenticationManager</code>è¿›è¡Œç»´æŠ¤ç®¡ç†, è¿›è¡Œè®¤è¯æ“ä½œæ—¶, ä¼šéå†<code>AuthenticationManager</code>ä¸­ç»´æŠ¤çš„<code>AuthenticationProvider</code>, é€šè¿‡<code>AuthenticationProvider</code>çš„<code>supports</code>åˆ¤æ–­æ˜¯å¦ç¬¦åˆéªŒè¯è¦æ±‚, ç¬¦åˆåˆ™é€šè¿‡<code>authenticate</code>æ–¹æ³•éªŒè¯, ç„¶åè·³è¿‡åç»­è¿˜æœªæ‰§è¡Œçš„éªŒè¯å¤„ç†å™¨</li>
<li><code>userDetailsService</code>: ç”¨æˆ·è¯¦æƒ…æœåŠ¡, ç”¨äºåŠ è½½ç”¨æˆ·çš„è¯¦æƒ…ä¿¡æ¯, é€šå¸¸ä¼šé‡å†™è¯¥å†…å®¹(æ³¨å†Œä¸€ä¸ªè¯¥æ¥å£çš„<code>@Bean</code>å®ä¾‹å³å¯æ›¿æ¢é»˜è®¤<code>SecurityFilterChain</code>ä¸­çš„ç”¨æˆ·è¯¦æƒ…æœåŠ¡), ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</li>
<li><code>exceptionHandling</code>: å¼‚å¸¸å¤„ç†, æ­¤æ–¹æ³•æ˜¯æ·»åŠ å¯å…±ç”¨çš„è®¤è¯å¼‚å¸¸å¤„ç†æœºåˆ¶</li>
<li><code>sessionManagement</code>: <code>session</code>ç®¡ç†</li>
<li><code>passwordManagement</code>: åŠ å¯†ç®¡ç†</li>
<li><code>authorizeHttpRequests</code>: è®¤è¯è¯·æ±‚é…ç½®</li>
<li><code>securityContext</code>: å®‰å…¨ä¸Šä¸‹æ–‡</li>
<li><code>setSharedObject</code>: å…±äº«å¯¹è±¡</li>
</ul>
</li>
<li>æ³¨é”€è®¤è¯é…ç½®: <code>logout</code></li>
<li>å…¶å®ƒé…ç½®æˆ‘ä¸å¤ªæ˜ç™½, å°±ä¸è¯¯äººå­å¼Ÿäº†</li>
</ul>
</li>
</ol>
<h3 id="è¯·æ±‚æµç¨‹"><a class="markdownIt-Anchor" href="#è¯·æ±‚æµç¨‹"></a> è¯·æ±‚æµç¨‹</h3>
<p><img src="Security%E9%AA%8C%E8%AF%81%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B5%81%E7%A8%8B.png" alt="SecurityéªŒè¯è¯·æ±‚çš„æµç¨‹" /></p>
<p>åœ¨ä¸Šé¢æè¿°äº†åŸºæœ¬æ¦‚å¿µå’Œé…ç½®å†…å®¹ä¹‹å, å¯ä»¥ç®€å•çš„æè¿°è¯·æ±‚çš„æµç¨‹</p>
<ol>
<li>æ¥æ”¶è¯·æ±‚, æ‰§è¡Œåˆ°<code>security</code>æ·»åŠ çš„<code>DelegatingFilterProxy</code>, é€šè¿‡è¿™ä¸ªæ¡¥æ¥å™¨æ¥å…¥è®¤è¯æµç¨‹</li>
<li><code>FilterChainProxy</code>æ ¹æ®è¯·æ±‚æŸ¥è¯¢å¹¶è°ƒç”¨<code>SecurityFilterChain</code>, æ‰§è¡Œè®¤è¯æµç¨‹</li>
<li>è®¤è¯æµç¨‹æ‰§è¡Œç»“æŸå, æ‰§è¡Œåç»­çš„æ“ä½œ</li>
<li>è¿”å›è¯·æ±‚çš„å¤„ç†ç»“æœ</li>
</ol>
<p>å…¶ä¸­æˆ‘ä»¬åœ¨è®¤è¯ä¸­æœ€å…³å¿ƒçš„å°±æ˜¯è®¤è¯æµç¨‹, å³ä½¿ç”¨çš„<code>SecurityFilterChain</code></p>
<h3 id="è®¤è¯æµç¨‹"><a class="markdownIt-Anchor" href="#è®¤è¯æµç¨‹"></a> è®¤è¯æµç¨‹</h3>
<p>æ­¤å¤„å°±ä»¥ç”¨æˆ·åå’Œå¯†ç çš„ç™»å½•æ–¹å¼ä¸ºä¾‹, æ¼”ç¤ºè®¤è¯æµç¨‹, æ­¤æ¬¡æ¼”ç¤ºä¼šåå‘äºå‰åç«¯åˆ†ç¦»çš„é…ç½®, ä¸ä¼šæœ‰é¡µé¢å†…å®¹</p>
<p>åœ¨å¼€å§‹ä¹‹å‰å…ˆå¼€å¯æ—¥å¿—, æ–¹ä¾¿æŸ¥çœ‹å’Œå®šä½</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org:</span></span><br><span class="line">      <span class="attr">springframework:</span></span><br><span class="line">        <span class="attr">security:</span> <span class="string">trace</span></span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬ä¸åšé…ç½®, æŸ¥çœ‹ä¸€ä¸‹é»˜è®¤çš„<code>SecurityFilterChain</code></p>
<p><img src="Security%E7%9A%84%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E8%BF%87%E6%BB%A4%E5%99%A8.png" alt="Securityçš„è®¤è¯æµç¨‹è¿‡æ»¤å™¨" /></p>
<p>æˆ‘ä»¬è¿›è¡Œé…ç½®æ—¶, å¤šæ•°æ˜¯è¿›è¡Œæ­¥éª¤ä¸‰çš„é…ç½®å’Œæ­¥éª¤ä¸ƒçš„é…ç½®, å…¶ä»–çš„é…ç½®å†…å®¹æˆ–ç¦ç”¨,æˆ–ç”¨é»˜è®¤, æˆ–é…ç½®æ¯”è¾ƒç®€å•. æˆ‘ä»¬å…ˆå°†è¿™éƒ¨åˆ†ç®€å•é…ç½®ä¸€ä¸‹</p>
<ol>
<li>
<p>å…ˆç¦ç”¨<code>csrf</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.csrf(AbstractHttpConfigurer::disable);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¼‚å¸¸å¤„ç†è®¾ç½®ä¸ºè¿”å›<code>json</code>å†…å®¹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.exceptionHandling(config -&gt;</span><br><span class="line">                       config</span><br><span class="line">                       .authenticationEntryPoint(customerAuthenticationHandler())</span><br><span class="line">                      );</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerAuthenticationHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationEntryPoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomerAuthenticationHandler</span><span class="params">(AuthenticationSaveHandler authenticationSaveHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationSaveHandler = authenticationSaveHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSaveHandler authenticationSaveHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        authenticationSaveHandler.remove(request.getHeader(<span class="string">&quot;TOKEN&quot;</span>));</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, authException);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><mark><code>AuthenticationSaveHandler</code>æ˜¯æˆ‘ä¸ªäººå°è£…çš„ä¸€ä¸ªéªŒè¯ä¿¡æ¯çš„ä¿å­˜å¤„ç†å™¨,  <code>TOKEN</code>æ˜¯æˆ‘ä¸ªäººåœ¨è¯·æ±‚å¤´ä¸­å®šä¹‰çš„å†…å®¹, ä½œä¸ºä¿å­˜å¤„ç†å™¨çš„<code>KEY</code>, è‡³äºå…·ä½“å®ç°å¯ä»¥ä¸ªäººè‡ªå®šä¹‰, <code>JWT</code>, <code>Redis</code>ä¿å­˜éƒ½å¯ä»¥, å¦‚æœæ¼”ç¤ºæƒ³è¦ç®€å•ç‚¹å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€ä¸ª<code>Map</code>ä¿å­˜, é€šè¿‡<code>KEY</code>æ¥<code>get</code>å’Œ<code>put</code>å³å¯</mark></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯, å½“é…ç½®å®Œè¿™äº›å, è®¿é—®æœåŠ¡èµ„æºæ—¶ä¼šå‘ç°å¯ä»¥ç›´æ¥è®¿é—®, è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ·»åŠ é‰´æƒçš„é…ç½®, è¿™æ ·ç”Ÿæˆçš„<code>SecurityFilterChain</code>æ˜¯æ²¡æœ‰é‰´æƒè¿‡æ»¤å™¨çš„, å¦‚æœæƒ³è¦éªŒè¯ä¸€ä¸‹<code>exceptionHandling</code>æ•ˆæœå¯ä»¥å…ˆæ·»åŠ ç®€å•çš„é‰´æƒé…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeHttpRequests(</span><br><span class="line">    (auth) -&gt; auth</span><br><span class="line">    .requestMatchers(<span class="string">&quot;test/unauth&quot;</span>, <span class="string">&quot;login&quot;</span>)</span><br><span class="line">    .permitAll()</span><br><span class="line">    .anyRequest()</span><br><span class="line">    .authenticated()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•è®¿é—®é™¤äº†<code>/test/unauth</code>è·¯å¾„ä¹‹å¤–çš„èµ„æºæ—¶, å°±ä¼šå¼‚å¸¸, å¼‚å¸¸ä¿¡æ¯æ˜¯: <code>Full authentication is required to access this resource</code></p>
</li>
<li>
<p>æ³¨é”€è®¤è¯åçš„å¤„ç†å’ŒæˆåŠŸçš„å¤„ç†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http.logout(</span><br><span class="line">    (config) -&gt; config</span><br><span class="line">    .addLogoutHandler(userLogoutHandler())</span><br><span class="line">    .logoutSuccessHandler(userLogoutSuccessHandler())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLogoutHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserLogoutHandler</span><span class="params">(AuthenticationSaveHandler authenticationSaveHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationSaveHandler = authenticationSaveHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSaveHandler authenticationSaveHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">        authenticationSaveHandler.remove(request.getHeader(<span class="string">&quot;TOKEN&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="comment">/*public UserLogoutSuccessHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            response.getWriter().println(s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶å¯ä»¥å»è¯·æ±‚<code>logout</code>æ³¨é”€è®¤è¯, è¯·æ±‚æˆåŠŸæ—¶å°±ä¼šè¿”å›<code>UserLogoutSuccessHandler</code>ä¸­<code>onLogoutSuccess</code>è¿”å›çš„å†…å®¹</p>
<p><mark>é¡¹ç›®é»˜è®¤çš„æ³¨é”€ç™»å½•çš„åœ°å€æ˜¯<code>logout</code>, å¯ä»¥é€šè¿‡<code>logoutUrl</code>ä¿®æ”¹æ³¨é”€è¯·æ±‚çš„è·¯å¾„</mark></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http.logout(</span><br><span class="line">    (config) -&gt; config</span><br><span class="line">    .logoutUrl(<span class="string">&quot;/api/logout&quot;</span>)</span><br><span class="line">    .addLogoutHandler(userLogoutHandler())</span><br><span class="line">    .logoutSuccessHandler(userLogoutSuccessHandler())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è®¤è¯ä¹‹åçš„æ“ä½œå’Œæ¸¸å®¢æ¨¡å¼æš‚ä¸æ“ä½œ</p>
</li>
<li>
<p>é‰´æƒé…ç½®, é€šè¿‡<code>authorizeHttpRequests</code>é…ç½®èµ„æºçš„æƒé™ä¿¡æ¯</p>
<p>é€šè¿‡å‰é¢å›¾ç‰‡çš„è¿‡æ»¤å™¨ä»‹ç»åº”è¯¥æ¸…æ™°çš„äº†è§£åˆ°, é‰´æƒæ“ä½œå®é™…æ˜¯åœ¨è®¤è¯ç­‰è¿‡æ»¤å™¨æ‰§è¡Œå®Œä¹‹åæ“ä½œçš„, æ‰€ä»¥åœ¨æ­¤è¿‡æ»¤å™¨æ‰§è¡Œä¹‹å‰å°±è¢«æ‹¦æˆªå¤„ç†çš„è¯·æ±‚æ˜¯ä¸ä¼šèµ°åˆ°è¯¥è¿‡æ»¤å™¨çš„, æ¯”å¦‚ç™»å½•é…ç½®ä¸­é…ç½®çš„ç™»å½•è¯·æ±‚è·¯å¾„(é»˜è®¤<code>/login</code>)å’Œæ³¨é”€è¯·æ±‚è·¯å¾„(<code>logout</code>); éƒ¨åˆ†è¿‡æ»¤å™¨æ˜¯æœ‰æ‰§è¡Œé“¾ç»“æŸçš„åç½®å¤„ç†çš„, æ¯”å¦‚å¼‚å¸¸å¤„ç†å™¨æ˜¯éœ€è¦<code>catch</code>é‰´æƒå¼‚å¸¸(å³é‰´æƒè¿‡æ»¤å™¨ä¸­æŠ›å‡ºçš„å¼‚å¸¸)çš„, æ‰€ä»¥ä¼šå‡ºç°é‰´æƒè¿‡æ»¤å™¨æ‰§è¡Œå®ŒåæŠ›å‡ºäº†å¼‚å¸¸è¿”å›åˆ°å¼‚å¸¸è¿‡æ»¤å™¨ä¸­æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºåŒ¹é…å½“å‰çš„SecurityFilterChainé€‚ç”¨çš„è¯·æ±‚è·¯å¾„, ä¸é…ç½®é»˜è®¤ä¸ºanyRequest</span></span><br><span class="line">http.securityMatcher(<span class="string">&quot;/**&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„é…ç½®ä¸æ˜¯é‰´æƒé…ç½®, è€Œæ˜¯<code>SecurityFilterChain</code>å¤„ç†çš„è¯·æ±‚è·¯å¾„, ä¸ç¬¦åˆè¦æ±‚çš„ä¸ä¼šåŒ¹é…åˆ°è¯¥<code>SecurityFilterChain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯·æ±‚é‰´æƒé…ç½®</span></span><br><span class="line">http.authorizeHttpRequests(</span><br><span class="line">    (auth) -&gt; auth</span><br><span class="line">    .requestMatchers(<span class="string">&quot;test/unauth&quot;</span>) <span class="comment">// ç”¨äºåŒ¹é…è·¯å¾„</span></span><br><span class="line">    .permitAll()</span><br><span class="line">    .requestMatchers(<span class="string">&quot;/test/auth&quot;</span>)</span><br><span class="line">    .hasRole(<span class="string">&quot;USER_TEST&quot;</span>)   <span class="comment">// å…·æœ‰æŸç§è§’è‰²</span></span><br><span class="line">    .requestMatchers(<span class="string">&quot;/test/auth&quot;</span>)</span><br><span class="line">    .hasAuthority(<span class="string">&quot;AUTH&quot;</span>)   <span class="comment">// å…·æœ‰æŸç§æƒé™</span></span><br><span class="line">    .requestMatchers(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">    .access((authentication, object) -&gt; <span class="keyword">new</span> <span class="title class_">AuthorizationDecision</span>(<span class="literal">true</span>))    <span class="comment">// è‡ªå®šä¹‰ç¬¦åˆæŸç§è¦æ±‚</span></span><br><span class="line">    .anyRequest()   <span class="comment">// ç”¨äºåŒ¹é…ä»»ä½•è·¯å¾„</span></span><br><span class="line">    .authenticated()    <span class="comment">// è¡¨ç¤ºéœ€è¦è®¤è¯</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°é‰´æƒé…ç½®åªæ˜¯æ¼”ç¤ºäº†å‡ ä¸ªé…ç½®çš„ä¾‹å­, <code>requestMatchers</code>è¡¨ç¤ºåŒ¹é…è·¯å¾„, é‰´æƒå¤„ç†æ•´ä½“åˆ†ä¸º5ä¸ªç±»åˆ«: <code>permitAll</code>(æ”¾è¡Œ), <code>hasRole</code>(å…·æœ‰æŸç§è§’è‰²), <code>hasAuthority</code>(å…·æœ‰æŸç§æƒé™), <code>access</code>(è‡ªå®šä¹‰çš„è®¿é—®è¦æ±‚), <code>authenticated</code>(éœ€è®¤è¯)</p>
<p>é‰´æƒé…ç½®çš„æ¯ä¸€ä¸ªéƒ½ä¼šåœ¨é‰´æƒé…ç½®ç±»<code>AuthorizeHttpRequestsConfigurer</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>AuthorizationManager</code>(æ³¨æ„åˆ«è·Ÿ<code>AuthenticationManager</code>æ··äº†), åœ¨<code>AuthorizationFilter</code>ä¸­å®ç°å…¶ä½œç”¨</p>
</li>
<li>
<p>è®¤è¯é…ç½®</p>
<p>è¿™æ˜¯ç™»å½•æ“ä½œæœ€é‡è¦çš„é…ç½®äº†, æˆ‘ä»¬ä»¥ç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯æ–¹å¼ä¸ºä¾‹è¿›è¡Œæ¼”ç¤º</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http.formLogin((config) -&gt;</span><br><span class="line">               config</span><br><span class="line">               .usernameParameter(<span class="string">&quot;username&quot;</span>)	<span class="comment">// ç”¨æˆ·åå‚æ•°key</span></span><br><span class="line">               .passwordParameter(<span class="string">&quot;password&quot;</span>)	<span class="comment">// å¯†ç å‚æ•°key</span></span><br><span class="line">               .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)	<span class="comment">// ç™»å½•å¤„ç†çš„åŒ¹é…è·¯å¾„</span></span><br><span class="line">               .failureHandler(loginFailureHandler())	<span class="comment">// ç™»å½•å¤±è´¥å¤„ç†å™¨</span></span><br><span class="line">               .successHandler(loginSuccessHandler())	<span class="comment">// ç™»å½•æˆåŠŸå¤„ç†</span></span><br><span class="line">              );</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°é…ç½®æ˜¯å¸¸åšçš„é…ç½®, å½“å®¢æˆ·ç«¯å‘é€<code>/login</code>è¯·æ±‚æ—¶ä¼šè¢«è¯¥è¿‡æ»¤å™¨æ‹¦æˆªå¤„ç†, ä»è¯·æ±‚ä¸­è·å–<code>key</code>ä¸º<code>username</code>å’Œ<code>password</code>çš„å‚æ•°è·å–å…¶å€¼è¿›è¡Œè®¤è¯;  <code>failureHandler</code>é…ç½®ä¸€ä¸ªè®¤è¯å¤±è´¥çš„å¤„ç†å™¨; <code>successHandler</code>é…ç½®ä¸€ä¸ªè®¤è¯æˆåŠŸçš„å¤„ç†å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public LoginFailureHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•å¤±è´¥: &quot;</span>+exception.getMessage());</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*public LoginSuccessHandler(AuthenticationSaveHandler authenticationSaveHandler) &#123;</span></span><br><span class="line"><span class="comment">        this.authenticationSaveHandler = authenticationSaveHandler;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private AuthenticationSaveHandler authenticationSaveHandler;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">/*String token = StringUtils.isBlank(request.getHeader(&quot;TOKEN&quot;)) ? UUID.randomUUID().toString() : request.getHeader(&quot;TOKEN&quot;);</span></span><br><span class="line"><span class="comment">        authenticationSaveHandler.add(token, authentication);*/</span></span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        Map&lt;String, Object&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        data.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        data.put(<span class="string">&quot;userInfo&quot;</span>, authentication);</span><br><span class="line">        result.put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å½“é…ç½®åˆ°æ­¤å¤„æ—¶, ä¼šå‘ç°ç™»å½•åŠŸèƒ½éƒ½å·²ç»æˆåŠŸäº†, ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³, è¯·æ±‚çš„è®¤è¯å­˜å‚¨é—®é¢˜</p>
<p>å½“æˆ‘è¯´å‡ºè¿™ä¸ªé—®é¢˜æ—¶å¯èƒ½ä¼šæœ‰ç–‘é—®: è®¤è¯ä¿¡æ¯åœ¨ç™»å½•æˆåŠŸåå·²ç»ä¿å­˜, <code>token</code>ä¹Ÿå·²ç»è¿”å›, åªéœ€è¦åœ¨è¯·æ±‚æ—¶æ·»åŠ <code>token</code>åˆ°è¯·æ±‚å¤´é‡Œä¸å°±å¯ä»¥æˆåŠŸäº†. ç­”æ¡ˆæ˜¯å¦</p>
<p>å…ˆè®¤è¯†ä¸¤ä¸ªæ¦‚å¿µ: 1. è¯·æ±‚æ˜¯æ— çŠ¶æ€çš„, è¯·æ±‚ä¸è¯·æ±‚ä¹‹é—´æ˜¯ä¸å­˜åœ¨å…³è”çš„; 2. åœ¨è®¤è¯æ¡†æ¶ä¸­, è¯·æ±‚æ˜¯åˆ†ä¸ºä¸¤ç±»çš„: è®¤è¯ç±»(ç™»å½•å’Œæ³¨é”€); æ™®é€šç±»(èµ„æºè¯·æ±‚)</p>
<p>å½“æˆ‘ä»¬åœ¨ä¸Šè¿°é…ç½®çš„åŸºç¡€ä¸Šç™»å½•è¯·æ±‚ç™»å½•æˆåŠŸäº†, ä¼šå°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°è‡ªå®šä¹‰çš„å­˜å‚¨ä¸­å¹¶è¿”å›<code>token</code>, ä½†æ˜¯å½“èµ„æºè¯·æ±‚è¿›æ¥æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰è·å–å¯¹åº”çš„è®¤è¯ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­æ¥è¡¨ç¤ºå·²ç»é€šè¿‡éªŒè¯</p>
<p>å½“ç™»å½•åå¦‚æœè®¿é—®èµ„æºè¯·æ±‚æ—¶æˆåŠŸè¿™ä¸æ˜¯æˆ‘ä»¬çš„é€»è¾‘çš„æˆåŠŸ, è€Œæ˜¯æ¡†æ¶çš„ä¸€äº›é»˜è®¤é…ç½®å¸¦æ¥çš„æ•ˆæœ, é»˜è®¤é…ç½®ä¸­ä¼šå°†<code>sessionId</code>è¿”å›å¹¶å†™åˆ°<code>Cookie</code>ä¸­, æ‰€ä»¥è®¿é—®èµ„æºæ—¶å¯èƒ½å¸¦æœ‰äº†å·²é€šè¿‡è®¤è¯çš„<code>sessionId</code>å¯¼è‡´çš„</p>
<p>è§£å†³æ–¹æ¡ˆ:</p>
<ul>
<li>
<p>ç¬¬ä¸€ç§æ˜¯ç½‘ä¸Šå¤§å¤šçš„è§£å†³æ–¹æ¡ˆ: åœ¨èµ°åˆ°è®¤è¯æµç¨‹è¿‡æ»¤å™¨å‰æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨, åœ¨è¿™ä¸ªè¿‡æ»¤å™¨ä¸­æ·»åŠ éªŒè¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡ä¸­, è¿˜æœ‰çš„æœ‰ä¼šå†è·å–<code>AuthenticationManager</code>ç„¶åå†æ‰‹åŠ¨è°ƒç”¨è®¤è¯æ–¹æ³•</p>
</li>
<li>
<p>ç¬¬äºŒç§æ˜¯ä¿®æ”¹<code>session</code>çš„ä¿å­˜ç­–ç•¥: æˆ‘ä¸ªäººæ¯”è¾ƒæ‡’, æ‰€ä»¥æƒ³ç›´æ¥æ›¿æ¢<code>spring</code>ä¸­éªŒè¯ä¿¡æ¯çš„è·å–å’Œä¿å­˜æ–¹å¼. <code>spring</code>ä¸­æ— è®ºæ˜¯<code>mvc</code>è¿˜æ˜¯<code>security</code>éƒ½æ˜¯å°†è¯·æ±‚åŸºäº<code>ThreadLocal</code>çš„, æ‰€ä»¥æ­¤å¤„çš„<code>session</code>ç­–ç•¥ä¸è¦ä¿®æ”¹, ä¾ç„¶ä½¿ç”¨<code>ThreadLocalSecurityContextHolderStrategy</code>, æˆ‘ä»¬è¦ä¿®æ”¹çš„æ˜¯å…¶å­˜å‚¨åº“<code>SecurityContextRepository</code></p>
<p><code>SecurityContextHolderFilter</code>: è·å–éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨</p>
<p><code>AuthorizationFilter</code>: è·å–å¹¶ä½¿ç”¨éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨</p>
<p><code>AbstractAuthenticationProcessingFilter</code>: ä¿å­˜éªŒè¯ä¿¡æ¯çš„è¿‡æ»¤å™¨(ä»…ä»…æ˜¯ç”¨æˆ·åå¯†ç æ¨¡å¼ä¸‹çš„ä¿å­˜è¿‡æ»¤å™¨)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationSaveHandler</span> <span class="keyword">extends</span> <span class="title class_">SecurityContextRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object account, SecurityContext authentication)</span>;</span><br><span class="line"></span><br><span class="line">    SecurityContext <span class="title function_">get</span><span class="params">(Object account)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object account)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryAuthenticationSaveHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSaveHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Object, SecurityContext&gt; USER = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Object account, SecurityContext authentication)</span> &#123;</span><br><span class="line">        USER.put(account, authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SecurityContext <span class="title function_">get</span><span class="params">(Object account)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> USER.get(account);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object account)</span> &#123;</span><br><span class="line">        USER.remove(account);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SecurityContext <span class="title function_">loadContext</span><span class="params">(HttpRequestResponseHolder requestResponseHolder)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestResponseHolder.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> get(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveContext</span><span class="params">(SecurityContext context, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        response.addHeader(<span class="string">&quot;TOKEN&quot;</span>, token);</span><br><span class="line"><span class="comment">//        Authentication authentication = context.getAuthentication();</span></span><br><span class="line">        add(token, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsContext</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;TOKEN&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> USER.containsKey(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.setSharedObject(SecurityContextRepository.class, authenticationSaveHandler());</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h3 id="è‡ªå®šä¹‰ç™»å½•"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰ç™»å½•"></a> è‡ªå®šä¹‰ç™»å½•</h3>
<p>é€šè¿‡å‰é¢çš„é…ç½®, æˆ‘ä»¬å¯ä»¥å®ç°é…ç½®å®˜æ–¹çš„ç™»å½•å¤„ç†, æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›ä½¿ç”¨å®˜æ–¹çš„ç™»å½•æµç¨‹, è€Œæ˜¯å¸Œæœ›è‡ªå®šä¹‰ç™»å½•æµç¨‹å’Œé€»è¾‘, æ­¤å¤„æœ‰ä¸¤ç§æ–¹å¼:</p>
<ol>
<li>
<p>è¯·æ±‚å¤„ç†å™¨çš„æ–¹å¼</p>
<p>è¿™ç§æ–¹å¼å°±æ˜¯å‰é¢æåˆ°çš„, å°†ç™»å½•è¯·æ±‚æ”¾è¡Œ, ç„¶ååœ¨<code>controller</code>ä¸­å®ç°è‡ªå®šä¹‰çš„ç™»å½•é€»è¾‘, å¹¶è¿›è¡Œç›¸å…³å¤„ç†</p>
</li>
<li>
<p>ç™»å½•è¿‡æ»¤å™¨æ–¹å¼</p>
<p>è¿™ç§æ–¹å¼ä¸ä¸Šè¿°æ–¹å¼ç±»ä¼¼, åªæ˜¯é€»è¾‘å¤„ç†é€šè¿‡è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å®ç°</p>
<p>é¦–å…ˆæ ¹æ®è‡ªå·±çš„éœ€æ±‚, å°†å®˜æ–¹å®ç°çš„ç™»å½•è¿‡æ»¤å™¨é…ç½®å¥½, ç„¶ååˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨, å¹¶æ·»åŠ åˆ°<code>SecurityFilterChain</code>ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(<span class="keyword">new</span> <span class="title class_">MyLoginFilter</span>(passwordEncoder, userDetailsService, authenticationSaveHandler), RequestCacheAwareFilter.class);</span><br></pre></td></tr></table></figure>
<p>ç„¶åè‡ªå®šä¹‰å®ç°ä¸€ä¸ªè¿‡æ»¤å™¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RequestMatcher</span> <span class="variable">requiresAuthenticationRequestMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/login&quot;</span>,</span><br><span class="line">            <span class="string">&quot;POST&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SecurityContextRepository securityContextRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyLoginFilter</span><span class="params">(PasswordEncoder passwordEncoder, UserDetailsService userDetailsService, SecurityContextRepository securityContextRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.securityContextRepository = securityContextRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (passwordEncoder.matches(password, user.getPassword())) &#123;</span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> UsernamePasswordAuthenticationToken.authenticated(user, user, Collections.emptyList());</span><br><span class="line">            <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">            context.setAuthentication(authentication);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                securityContextRepository.saveContext(context, request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">requiresAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.requiresAuthenticationRequestMatcher.matches(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨<code>OncePerRequestFilter</code>è¿™ä¸ªè¿‡æ»¤å™¨ç±»çš„åŸºç¡€ä¸Šè¿›è¡Œæ„å»º, æ­¤å¤„åªæ˜¯ç®€å•çš„åšäº†ä¸€ä¸ªç®€å•çš„é€»è¾‘å¤„ç†å’Œä¸Šä¸‹æ–‡ä¿å­˜æ ·ä¾‹, å…·ä½“å®ç°å¯æ ¹æ®ä¸ªäººéœ€è¦è¿›è¡Œå…·ä½“ä¿®æ”¹</p>
</li>
</ol>
<h3 id="å‡ºç°é—®é¢˜"><a class="markdownIt-Anchor" href="#å‡ºç°é—®é¢˜"></a> å‡ºç°é—®é¢˜ğŸ˜­</h3>
<p>é—®é¢˜ä¸€</p>
<p>å‡ºç°é—®é¢˜:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Not injecting HSTS header since it did not match request to [Is Secure]</span><br></pre></td></tr></table></figure>
<p>é—®é¢˜æè¿°: è¿™ä¸ªé—®é¢˜åœ¨è‡ªå®šä¹‰ç™»å½•å, åœ¨è¯·æ±‚ç™»å½•æ—¶å¯èƒ½ä¼šå‡ºç°, å…·ä½“å†…å®¹ä¸Šä¸ä¼šæŠ¥é”™, ä½†æ˜¯åœ¨æ‰“å¼€æ—¥å¿—æ‰“å°æ—¶ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰çš„ç™»å½•è¿‡æ»¤å™¨å‡ºç°äº†è¯¥æè¿°</p>
<p>è§£å†³æ–¹æ¡ˆ: é…ç½®è¯·æ±‚å¤´<code>https</code>é…ç½®, å…·ä½“å¯å‚è€ƒ: <a target="_blank" rel="noopener" href="https://blog.csdn.net/w_monster/article/details/119936215">https://blog.csdn.net/w_monster/article/details/119936215</a></p>
<h3 id="æŒ–å‘"><a class="markdownIt-Anchor" href="#æŒ–å‘"></a> æŒ–å‘</h3>
<p><code>SpringSecurity</code>æºç </p>

    </article>
    
    <div class="read-nums">
      <!-- id å°†ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ -->
      <span id="2024/02/03/springcloud/SpringCloudç³»åˆ—ä¸ƒä¹‹è®¤è¯å’Œæˆæƒ/" class="leancloud_visitors" data-flag-title="Your Article Title">
        <em class="post-meta-item-text">æµè§ˆé‡</em>
        <i class="leancloud-visitors-count"></i>
      </span>
    </div>
    <div class="comments-intro">
      <h2>è¯„è®ºåŒº</h2>
      <p>æ¬¢è¿ä½ ç•™ä¸‹å®è´µçš„æ„è§ï¼Œæ˜µç§°è¾“å…¥QQå·ä¼šæ˜¾ç¤ºQQå¤´åƒå“¦~</p>
    </div>
    <div id="vcomments" class="vcomments"></div>
    
  </div>
  <div class="article-catelogue">
    <div class="article-catelogue--wrapper">
      <div class="catelogue catelogue-1">
        <h3>ç›®å½•</h3>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5springsecurity"><span class="toc-number">2.</span> <span class="toc-text"> å¼•å…¥SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">2.1.</span> <span class="toc-text"> æ·»åŠ ä¾èµ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.</span> <span class="toc-text"> æ·»åŠ é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E5%89%8D%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="toc-number">3.</span> <span class="toc-text"> è‡ªå®šä¹‰é…ç½®å‰çš„è¯´æ˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEwebsecurity"><span class="toc-number">4.</span> <span class="toc-text"> é…ç½®WebSecurity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEhttpsecurity"><span class="toc-number">5.</span> <span class="toc-text"> é…ç½®HttpSecurity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text"> è¯·æ±‚æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="toc-number">7.</span> <span class="toc-text"> è®¤è¯æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95"><span class="toc-number">8.</span> <span class="toc-text"> è‡ªå®šä¹‰ç™»å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text"> å‡ºç°é—®é¢˜ğŸ˜­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%96%E5%9D%91"><span class="toc-number">10.</span> <span class="toc-text"> æŒ–å‘</span></a></li></ol>
      </div>
      
        <div class="catelogue catelogue-2">
          
            <p>
              <span>ä¸Šä¸€ç¯‡ï¼š</span>
              <a href="/2024/02/19/springcloud/SpringCloudç³»åˆ—å…«ä¹‹æœåŠ¡åˆ’åˆ†/">SpringCloudç³»åˆ—(å…«)---æœåŠ¡åˆ’åˆ†</a>
            </p>
           
          
            <p>
              <span>ä¸‹ä¸€ç¯‡</span>
              <a href="/2024/02/01/web/Vueç³»åˆ—å››ä¹‹è¯·æ±‚/">Vueç³»åˆ—(å››)---è¯·æ±‚</a>
            </p>
          
        </div>
      
    </div>
  </div>
</div>


<script>
  // varå®šä¹‰ï¼Œé¿å…pjaxé‡æ–°è¿›æ¥é€ æˆçš„é‡å¤å£°æ˜é”™è¯¯
  var config = JSON.parse('{"enable":true,"appId":"Pf8zCXGEH1qsprnWfikVVujL-gzGzoHsz","appKey":"qOqoiUHhH1TGtLRUYURkLRQX","placeholder":"è¯·ç•™ä¸‹ä½ å®è´µçš„æ„è§å§~","meta":["nick"],"recordIP":true,"visitor":true,"enableQQ":true}')
  new Valine({
    el: '#vcomments',
    appId: config.appId,
    appKey: config.appKey,
    placeholder: config.placeholder,
    meta: config.meta,
    recordIP: config.recordIP,
    visitor: config.visitor,
    enableQQ: config.enableQQ,
    path: '2024/02/03/springcloud/SpringCloudç³»åˆ—ä¸ƒä¹‹è®¤è¯å’Œæˆæƒ/'
  })
</script>


<script>
    const tocs = document.querySelector('.toc')
    const links = tocs ? tocs.querySelectorAll('a') : []
    links.forEach(link => {
      link.addEventListener('click', e => {
        let href = decodeURIComponent(link.href);
        href = href.substring(href.indexOf('#'));
        const target = $(href)[0];
        const top = target.offsetTop;
        document.documentElement.scrollTo({
          top: top - 100,
          behavior: 'smooth'
        })
        e.preventDefault()
      })
    })
</script> 

</div>
      <div class="main-right-wrapper"><div class="main-right">
  <div class="main-right--board">
    <div class="main-right--title">
      <h5>å…¬å‘Šæ </h5>
      <i class="iconfont icon-gonggao"></i>
    </div>
    <div class="main-right--content">
      æˆ‘ä»¬åœ¨ç»µå»¶çš„æµ·æ»©ä¸Šæ¡è´å£³ï¼Œä»Šå¤©æ¡åˆ°äº†ä¸å¿…æ¬£å–œï¼Œå› ä¸ºæµ·å¾ˆå¤§ï¼Œä»Šå¤©æ²¡æ¡åˆ°ï¼Œä¹Ÿä¸å¿…å¤±è½ï¼Œå› ä¸ºæµ·å¾ˆå¤§ã€‚ 
    </div>
  </div>

  <div id="aplayer" class="main-right--music"></div>

  <div class="operate-items">
    <div class="operate-item backtop">
      <i class="iconfont icon-huidaodingbu"></i>
      <span>å›åˆ°é¡¶éƒ¨</span>
    </div>
    
    <div class="operate-item turn-comment hidden">
      <i class="iconfont icon-pinglun"></i>
      <span>æŸ¥çœ‹è¯„è®º</span>
    </div>
    
  </div>

  <div class="main-right--site">
    <div class="main-right--power">
      <p>Power By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a>.</p>
      <p>Themeï¼š<a target="_blank" rel="noopener" href="https://github.com/Aizener/hexo-theme-cola">Cola.</a></p>
    </div>
    <p class="main-right--refer"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index">æˆ‘å¥½åƒæ²¡æœ‰ç½‘ç»œå¤‡æ¡ˆ</a> </p>
  </div>
</div>

<script>
  function setOperateItem () {
    const reg = /\d{4}\/\d{2}\/\d{2}\/.+/
    const path = location.pathname
    const operateDom = document.querySelector('.main-right .operate-items')
    const commentDom = document.querySelector('.turn-comment')
    const cateloguDom = document.querySelector('.article-catelogue > .article-catelogue--wrapper');

    if (commentDom) {
      if (reg.test(path) || path.match(/\/log\/.+/)) {
        commentDom.classList.remove('hidden')
        const newDom = operateDom.cloneNode(true);
        const _backtopDom = newDom.querySelector('.backtop');
        const _commentDom = newDom.querySelector('.turn-comment');
        _backtopDom.addEventListener('click', () => backTopEvent());
        _commentDom.addEventListener('click', () => commentDomEvent());
        cateloguDom.appendChild(newDom);
      } else {
        commentDom.classList.add('hidden')
      }
    }
  }

  setOperateItem()
  const musics = JSON.parse(`[{"name":"è‡ªè»¢è½¦","artist":"ã‚ªãƒ¬ã‚¹ã‚«ãƒãƒ³ãƒ‰","url":"/music/è‡ªè»¢è½¦-ã‚ªãƒ¬ã‚¹ã‚«ãƒãƒ³ãƒ‰.mp3","cover":"/imgs/music-bg1.jpg"},{"name":"æ’åœ°çƒ","artist":"é±¼å„¿ä¸ƒ","url":"/music/æ’åœ°çƒ-é±¼å„¿ä¸ƒ.mp3","cover":"/imgs/music-bg1.jpg"},{"name":"æ™´å¤©","artist":"å‘¨æ°ä¼¦","url":"/music/æ™´å¤©-å‘¨æ°ä¼¦.mp3","cover":"/imgs/music-bg1.jpg"},{"name":"å‘Šç™½æ°”çƒ","artist":"å‘¨æ°ä¼¦","url":"/music/å‘Šç™½æ°”çƒ-å‘¨æ°ä¼¦.mp3","cover":"/imgs/music-bg1.jpg"}]`)
  const ap = new APlayer({
    container: document.querySelector('#aplayer'),
    audio: musics,
  })

  $(document).on('pjax:complete', function() {
    setOperateItem()
  })

  document.querySelector('.backtop').addEventListener('click', () => {
    backTopEvent();
  })
  const dom = document.querySelector('.turn-comment')
  dom && dom.addEventListener('click', () => {
    commentDomEvent();
  })

  function backTopEvent() {
    document.documentElement.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  function commentDomEvent() {
    const commentDom = document.querySelector('.comments-intro')
    if (!commentDom) return
    const top = commentDom.offsetTop, height = commentDom.offsetHeight
    document.documentElement.scrollTo({
      top: top - 2 * height,
      behavior: 'smooth'
    })
  }
</script></div>
    </section>
  </div>
  <div id="progress" class="progress"></div>
  <div id="gray" class="gray"></div>

  <script>
    function initScroll () {
      document.addEventListener('scroll', () => {
        const doc = document.documentElement
        const scrollTop = doc.scrollTop
        const pageHeight = doc.offsetHeight
        const clientHeight = doc.clientHeight
        const ratio = scrollTop / (pageHeight - clientHeight)
        const progress = document.querySelector('#progress')
        const avatarImg = document.querySelector('.main-left--avatar')
        progress.style.width = (100 * ratio) + '%'
        avatarImg.style.transform = `rotate(${360 * ratio}deg)`
      })
    }

    const rootPath = "/"

    const checkAndSetArticlePageLayout = () => {
      const path = location.pathname.replace(rootPath, '');
      if (
        /^\/?\d{4}\/\d{2}\/\d{2}\/.*/.test(path) ||
        /^log\/.+/.test(path)
      ) {
        $('.main-container, .main-right, .main-right-wrapper').addClass('is-article')
      } else {
        $('.main-container, .main-right, .main-right-wrapper').removeClass('is-article')
      }
    }

    const gray = "none"
    const setGrayStyle = () => {
      if (gray === 'none') {
        return
      } else if (gray === 'index') {
        location.pathname === '/' ? $('#gray').show() : $('#gray').hide()
      } else if (gray === 'all') {
        $('#gray').show()
      }
    }
    setGrayStyle()


    window.onload = function () {
      checkAndSetArticlePageLayout()
      setTimeout(() => {
        $('#load').slideUp()
        $('#container').slideToggle()
        setTimeout(() => {
          initScroll();
        }, 500)
      }, 500)
    }
    
    let status = 0
    // å¯¹æ‰€æœ‰é“¾æ¥è·³è½¬äº‹ä»¶ç»‘å®špjaxå®¹å™¨container
    $(document).pjax('a[target!=_blank]', '#main-container', {
      container: '#main-container',
      fragment: '#main-container',
      timeout: 8000
    })

    $(document).on('pjax:start', function() {
    })
    $(document).on('pjax:complete', function() {
      status = 0
      $('.main-container').addClass('to-up').on('animationend', function() {
        $(this).removeClass('to-up')
      })
      setGrayStyle()
      checkAndSetArticlePageLayout()
    })
    $(document).on('pjax:popstate', function() {
      status = -1
      checkAndSetArticlePageLayout()
    });
  </script>
</body>
</html>